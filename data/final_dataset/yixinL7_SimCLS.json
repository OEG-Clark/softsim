{"home.repos.pwc.inspect_result.yixinL7_SimCLS.None.main.base_setting": [[30, 51], ["getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr", "getattr"], "function", ["None"], ["def", "base_setting", "(", "args", ")", ":", "\n", "    ", "args", ".", "batch_size", "=", "getattr", "(", "args", ",", "'batch_size'", ",", "1", ")", "\n", "args", ".", "epoch", "=", "getattr", "(", "args", ",", "'epoch'", ",", "5", ")", "\n", "args", ".", "report_freq", "=", "getattr", "(", "args", ",", "\"report_freq\"", ",", "100", ")", "\n", "args", ".", "accumulate_step", "=", "getattr", "(", "args", ",", "\"accumulate_step\"", ",", "12", ")", "\n", "args", ".", "margin", "=", "getattr", "(", "args", ",", "\"margin\"", ",", "0.01", ")", "\n", "args", ".", "gold_margin", "=", "getattr", "(", "args", ",", "\"gold_margin\"", ",", "0", ")", "\n", "args", ".", "model_type", "=", "getattr", "(", "args", ",", "\"model_type\"", ",", "'roberta-base'", ")", "\n", "args", ".", "warmup_steps", "=", "getattr", "(", "args", ",", "\"warmup_steps\"", ",", "10000", ")", "\n", "args", ".", "grad_norm", "=", "getattr", "(", "args", ",", "\"grad_norm\"", ",", "0", ")", "\n", "args", ".", "seed", "=", "getattr", "(", "args", ",", "\"seed\"", ",", "970903", ")", "\n", "args", ".", "no_gold", "=", "getattr", "(", "args", ",", "\"no_gold\"", ",", "False", ")", "\n", "args", ".", "pretrained", "=", "getattr", "(", "args", ",", "\"pretrained\"", ",", "None", ")", "\n", "args", ".", "max_lr", "=", "getattr", "(", "args", ",", "\"max_lr\"", ",", "2e-3", ")", "\n", "args", ".", "scale", "=", "getattr", "(", "args", ",", "\"scale\"", ",", "1", ")", "\n", "args", ".", "datatype", "=", "getattr", "(", "args", ",", "\"datatype\"", ",", "\"diverse\"", ")", "\n", "args", ".", "dataset", "=", "getattr", "(", "args", ",", "\"dataset\"", ",", "\"xsum\"", ")", "\n", "args", ".", "max_len", "=", "getattr", "(", "args", ",", "\"max_len\"", ",", "120", ")", "# 120 for cnndm and 80 for xsum", "\n", "args", ".", "max_num", "=", "getattr", "(", "args", ",", "\"max_num\"", ",", "16", ")", "\n", "args", ".", "cand_weight", "=", "getattr", "(", "args", ",", "\"cand_weight\"", ",", "1", ")", "\n", "args", ".", "gold_weight", "=", "getattr", "(", "args", ",", "\"gold_weight\"", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.main.evaluation": [[53, 114], ["main.base_setting", "transformers.RobertaTokenizer.from_pretrained", "functools.partial", "data_utils.ReRankingDataset", "torch.utils.data.DataLoader", "model.ReRanker", "scorer.cuda.load_state_dict", "scorer.cuda.eval", "print", "main.evaluation.mkdir"], "function", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.main.base_setting", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print"], ["", "def", "evaluation", "(", "args", ")", ":", "\n", "# load data", "\n", "    ", "base_setting", "(", "args", ")", "\n", "tok", "=", "RobertaTokenizer", ".", "from_pretrained", "(", "args", ".", "model_type", ")", "\n", "collate_fn", "=", "partial", "(", "collate_mp", ",", "pad_token_id", "=", "tok", ".", "pad_token_id", ",", "is_test", "=", "True", ")", "\n", "test_set", "=", "ReRankingDataset", "(", "f\"./{args.dataset}/{args.datatype}/test\"", ",", "args", ".", "model_type", ",", "is_test", "=", "True", ",", "maxlen", "=", "512", ",", "is_sorted", "=", "False", ",", "maxnum", "=", "args", ".", "max_num", ",", "is_untok", "=", "True", ")", "\n", "dataloader", "=", "DataLoader", "(", "test_set", ",", "batch_size", "=", "8", ",", "shuffle", "=", "False", ",", "num_workers", "=", "4", ",", "collate_fn", "=", "collate_fn", ")", "\n", "# build models", "\n", "model_path", "=", "args", ".", "pretrained", "if", "args", ".", "pretrained", "is", "not", "None", "else", "args", ".", "model_type", "\n", "scorer", "=", "model", ".", "ReRanker", "(", "model_path", ",", "tok", ".", "pad_token_id", ")", "\n", "if", "args", ".", "cuda", ":", "\n", "        ", "scorer", "=", "scorer", ".", "cuda", "(", ")", "\n", "", "scorer", ".", "load_state_dict", "(", "torch", ".", "load", "(", "os", ".", "path", ".", "join", "(", "\"./cache\"", ",", "args", ".", "model_pt", ")", ",", "map_location", "=", "f'cuda:{args.gpuid[0]}'", ")", ")", "\n", "scorer", ".", "eval", "(", ")", "\n", "model_name", "=", "args", ".", "model_pt", ".", "split", "(", "\"/\"", ")", "[", "0", "]", "\n", "\n", "def", "mkdir", "(", "path", ")", ":", "\n", "        ", "if", "not", "os", ".", "path", ".", "exists", "(", "path", ")", ":", "\n", "            ", "os", ".", "mkdir", "(", "path", ")", "\n", "\n", "", "", "print", "(", "model_name", ")", "\n", "mkdir", "(", "\"./result/%s\"", "%", "model_name", ")", "\n", "mkdir", "(", "\"./result/%s/reference\"", "%", "model_name", ")", "\n", "mkdir", "(", "\"./result/%s/candidate\"", "%", "model_name", ")", "\n", "rouge_scorer", "=", "RougeScorer", "(", "[", "'rouge1'", ",", "'rouge2'", ",", "'rougeLsum'", "]", ",", "use_stemmer", "=", "True", ")", "\n", "rouge1", ",", "rouge2", ",", "rougeLsum", "=", "0", ",", "0", ",", "0", "\n", "cnt", "=", "0", "\n", "acc", "=", "0", "\n", "scores", "=", "[", "]", "\n", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "        ", "for", "(", "i", ",", "batch", ")", "in", "enumerate", "(", "dataloader", ")", ":", "\n", "            ", "if", "args", ".", "cuda", ":", "\n", "                ", "to_cuda", "(", "batch", ",", "args", ".", "gpuid", "[", "0", "]", ")", "\n", "", "samples", "=", "batch", "[", "\"data\"", "]", "\n", "output", "=", "scorer", "(", "batch", "[", "\"src_input_ids\"", "]", ",", "batch", "[", "\"candidate_ids\"", "]", ",", "batch", "[", "\"tgt_input_ids\"", "]", ")", "\n", "similarity", ",", "gold_similarity", "=", "output", "[", "'score'", "]", ",", "output", "[", "'summary_score'", "]", "\n", "similarity", "=", "similarity", ".", "cpu", "(", ")", ".", "numpy", "(", ")", "\n", "if", "i", "%", "100", "==", "0", ":", "\n", "                ", "print", "(", "f\"test similarity: {similarity[0]}\"", ")", "\n", "", "max_ids", "=", "similarity", ".", "argmax", "(", "1", ")", "\n", "scores", ".", "extend", "(", "similarity", ".", "tolist", "(", ")", ")", "\n", "acc", "+=", "(", "max_ids", "==", "batch", "[", "\"scores\"", "]", ".", "cpu", "(", ")", ".", "numpy", "(", ")", ".", "argmax", "(", "1", ")", ")", ".", "sum", "(", ")", "\n", "for", "j", "in", "range", "(", "similarity", ".", "shape", "[", "0", "]", ")", ":", "\n", "                ", "sample", "=", "samples", "[", "j", "]", "\n", "sents", "=", "sample", "[", "\"candidates\"", "]", "[", "max_ids", "[", "j", "]", "]", "[", "0", "]", "\n", "score", "=", "rouge_scorer", ".", "score", "(", "\"\\n\"", ".", "join", "(", "sample", "[", "\"abstract\"", "]", ")", ",", "\"\\n\"", ".", "join", "(", "sents", ")", ")", "\n", "rouge1", "+=", "score", "[", "\"rouge1\"", "]", ".", "fmeasure", "\n", "rouge2", "+=", "score", "[", "\"rouge2\"", "]", ".", "fmeasure", "\n", "rougeLsum", "+=", "score", "[", "\"rougeLsum\"", "]", ".", "fmeasure", "\n", "with", "open", "(", "\"./result/%s/candidate/%d.dec\"", "%", "(", "model_name", ",", "cnt", ")", ",", "\"w\"", ")", "as", "f", ":", "\n", "                    ", "for", "s", "in", "sents", ":", "\n", "                        ", "print", "(", "s", ",", "file", "=", "f", ")", "\n", "", "", "with", "open", "(", "\"./result/%s/reference/%d.ref\"", "%", "(", "model_name", ",", "cnt", ")", ",", "\"w\"", ")", "as", "f", ":", "\n", "                    ", "for", "s", "in", "sample", "[", "\"abstract\"", "]", ":", "\n", "                        ", "print", "(", "s", ",", "file", "=", "f", ")", "\n", "", "", "cnt", "+=", "1", "\n", "", "", "", "rouge1", "=", "rouge1", "/", "cnt", "\n", "rouge2", "=", "rouge2", "/", "cnt", "\n", "rougeLsum", "=", "rougeLsum", "/", "cnt", "\n", "print", "(", "f\"accuracy: {acc / cnt}\"", ")", "\n", "print", "(", "\"rouge1: %.6f, rouge2: %.6f, rougeL: %.6f\"", "%", "(", "rouge1", ",", "rouge2", ",", "rougeLsum", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.main.test": [[116, 153], ["scorer.eval", "compare_mt.rouge.rouge_scorer.RougeScorer", "scorer.train", "print", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "enumerate", "len", "torch.FloatTensor().to", "torch.FloatTensor().to", "torch.FloatTensor().to", "torch.FloatTensor().to", "torch.FloatTensor().to", "torch.FloatTensor().to", "torch.all_reduce", "scorer", "similarity.cpu().numpy.cpu().numpy", "similarity.cpu().numpy.argmax", "range", "torch.FloatTensor().to.item", "len", "data_utils.to_cuda", "print", "compare_mt.rouge.rouge_scorer.RougeScorer.score", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "similarity.cpu().numpy.cpu"], "function", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.to_cuda", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print"], ["", "def", "test", "(", "dataloader", ",", "scorer", ",", "args", ",", "gpuid", ")", ":", "\n", "    ", "scorer", ".", "eval", "(", ")", "\n", "loss", "=", "0", "\n", "cnt", "=", "0", "\n", "rouge_scorer", "=", "RougeScorer", "(", "[", "'rouge1'", ",", "'rouge2'", ",", "'rougeLsum'", "]", ",", "use_stemmer", "=", "True", ")", "\n", "rouge1", ",", "rouge2", ",", "rougeLsum", "=", "0", ",", "0", ",", "0", "\n", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "        ", "for", "(", "i", ",", "batch", ")", "in", "enumerate", "(", "dataloader", ")", ":", "\n", "            ", "if", "args", ".", "cuda", ":", "\n", "                ", "to_cuda", "(", "batch", ",", "gpuid", ")", "\n", "", "samples", "=", "batch", "[", "\"data\"", "]", "\n", "output", "=", "scorer", "(", "batch", "[", "\"src_input_ids\"", "]", ",", "batch", "[", "\"candidate_ids\"", "]", ",", "batch", "[", "\"tgt_input_ids\"", "]", ")", "\n", "similarity", ",", "gold_similarity", "=", "output", "[", "'score'", "]", ",", "output", "[", "'summary_score'", "]", "\n", "similarity", "=", "similarity", ".", "cpu", "(", ")", ".", "numpy", "(", ")", "\n", "if", "i", "%", "1000", "==", "0", ":", "\n", "                ", "print", "(", "f\"test similarity: {similarity[0]}\"", ")", "\n", "", "max_ids", "=", "similarity", ".", "argmax", "(", "1", ")", "\n", "for", "j", "in", "range", "(", "similarity", ".", "shape", "[", "0", "]", ")", ":", "\n", "                ", "cnt", "+=", "1", "\n", "sample", "=", "samples", "[", "j", "]", "\n", "sents", "=", "sample", "[", "\"candidates\"", "]", "[", "max_ids", "[", "j", "]", "]", "[", "0", "]", "\n", "score", "=", "rouge_scorer", ".", "score", "(", "\"\\n\"", ".", "join", "(", "sample", "[", "\"abstract\"", "]", ")", ",", "\"\\n\"", ".", "join", "(", "sents", ")", ")", "\n", "rouge1", "+=", "score", "[", "\"rouge1\"", "]", ".", "fmeasure", "\n", "rouge2", "+=", "score", "[", "\"rouge2\"", "]", ".", "fmeasure", "\n", "rougeLsum", "+=", "score", "[", "\"rougeLsum\"", "]", ".", "fmeasure", "\n", "", "", "", "rouge1", "=", "rouge1", "/", "cnt", "\n", "rouge2", "=", "rouge2", "/", "cnt", "\n", "rougeLsum", "=", "rougeLsum", "/", "cnt", "\n", "scorer", ".", "train", "(", ")", "\n", "loss", "=", "1", "-", "(", "(", "rouge1", "+", "rouge2", "+", "rougeLsum", ")", "/", "3", ")", "\n", "print", "(", "f\"rouge-1: {rouge1}, rouge-2: {rouge2}, rouge-L: {rougeLsum}\"", ")", "\n", "\n", "if", "len", "(", "args", ".", "gpuid", ")", ">", "1", ":", "\n", "        ", "loss", "=", "torch", ".", "FloatTensor", "(", "[", "loss", "]", ")", ".", "to", "(", "gpuid", ")", "\n", "dist", ".", "all_reduce", "(", "loss", ",", "op", "=", "dist", ".", "reduce_op", ".", "SUM", ")", "\n", "loss", "=", "loss", ".", "item", "(", ")", "/", "len", "(", "args", ".", "gpuid", ")", "\n", "", "return", "loss", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.main.run": [[155, 254], ["main.base_setting", "torch.manual_seed", "torch.manual_seed", "torch.manual_seed", "torch.manual_seed", "torch.manual_seed", "torch.manual_seed", "torch.cuda.manual_seed_all", "torch.cuda.manual_seed_all", "torch.cuda.manual_seed_all", "torch.cuda.manual_seed_all", "torch.cuda.manual_seed_all", "torch.cuda.manual_seed_all", "numpy.random.seed", "random.seed", "len", "transformers.RobertaTokenizer.from_pretrained", "functools.partial", "functools.partial", "data_utils.ReRankingDataset", "data_utils.ReRankingDataset", "model.ReRanker", "nn.parallel.DistributedDataParallel.train", "torch.Adam", "range", "len", "len", "utils.Recorder", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.DataLoader", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.distributed.DistributedSampler", "torch.utils.data.DataLoader", "torch.utils.data.DataLoader", "torch.utils.data.DataLoader", "len", "nn.parallel.DistributedDataParallel.load_state_dict", "nn.parallel.DistributedDataParallel.parameters", "utils.Recorder.write_config", "optim.Adam.zero_grad", "enumerate", "os.listdir", "torch.load", "torch.load", "torch.load", "torch.load", "torch.load", "torch.load", "len", "nn.parallel.DistributedDataParallel.cuda", "torch.init_process_group", "torch.parallel.DistributedDataParallel", "nn.parallel.DistributedDataParallel.", "test.item", "test.backward", "os.path.join", "nn.parallel.DistributedDataParallel.to", "data_utils.to_cuda", "model.RankingLoss", "optim.Adam.step", "optim.Adam.zero_grad", "print", "print", "utils.Recorder.print", "utils.Recorder.print", "utils.Recorder.plot", "utils.Recorder.print", "main.test", "torch.utils.clip_grad_norm_", "min", "print", "utils.Recorder.save", "utils.Recorder.print", "utils.Recorder.print", "nn.parallel.DistributedDataParallel.parameters", "utils.Recorder.save", "utils.Recorder.save"], "function", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.main.base_setting", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.write_config", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.to_cuda", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.model.RankingLoss", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.plot", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.main.test", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.save", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.save", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.save"], ["", "def", "run", "(", "rank", ",", "args", ")", ":", "\n", "    ", "base_setting", "(", "args", ")", "\n", "torch", ".", "manual_seed", "(", "args", ".", "seed", ")", "\n", "torch", ".", "cuda", ".", "manual_seed_all", "(", "args", ".", "seed", ")", "\n", "np", ".", "random", ".", "seed", "(", "args", ".", "seed", ")", "\n", "random", ".", "seed", "(", "args", ".", "seed", ")", "\n", "gpuid", "=", "args", ".", "gpuid", "[", "rank", "]", "\n", "is_master", "=", "rank", "==", "0", "\n", "is_mp", "=", "len", "(", "args", ".", "gpuid", ")", ">", "1", "\n", "world_size", "=", "len", "(", "args", ".", "gpuid", ")", "\n", "if", "is_master", ":", "\n", "        ", "id", "=", "len", "(", "os", ".", "listdir", "(", "\"./cache\"", ")", ")", "\n", "recorder", "=", "Recorder", "(", "id", ",", "args", ".", "log", ")", "\n", "", "tok", "=", "RobertaTokenizer", ".", "from_pretrained", "(", "args", ".", "model_type", ")", "\n", "collate_fn", "=", "partial", "(", "collate_mp", ",", "pad_token_id", "=", "tok", ".", "pad_token_id", ",", "is_test", "=", "False", ")", "\n", "collate_fn_val", "=", "partial", "(", "collate_mp", ",", "pad_token_id", "=", "tok", ".", "pad_token_id", ",", "is_test", "=", "True", ")", "\n", "train_set", "=", "ReRankingDataset", "(", "f\"./{args.dataset}/{args.datatype}/train\"", ",", "args", ".", "model_type", ",", "maxlen", "=", "args", ".", "max_len", ",", "maxnum", "=", "args", ".", "max_num", ")", "\n", "val_set", "=", "ReRankingDataset", "(", "f\"./{args.dataset}/{args.datatype}/val\"", ",", "args", ".", "model_type", ",", "is_test", "=", "True", ",", "maxlen", "=", "512", ",", "is_sorted", "=", "False", ",", "maxnum", "=", "args", ".", "max_num", ")", "\n", "if", "is_mp", ":", "\n", "        ", "train_sampler", "=", "torch", ".", "utils", ".", "data", ".", "distributed", ".", "DistributedSampler", "(", "\n", "train_set", ",", "num_replicas", "=", "world_size", ",", "rank", "=", "rank", ",", "shuffle", "=", "True", ")", "\n", "dataloader", "=", "DataLoader", "(", "train_set", ",", "batch_size", "=", "args", ".", "batch_size", ",", "shuffle", "=", "False", ",", "num_workers", "=", "4", ",", "collate_fn", "=", "collate_fn", ",", "sampler", "=", "train_sampler", ")", "\n", "val_sampler", "=", "torch", ".", "utils", ".", "data", ".", "distributed", ".", "DistributedSampler", "(", "\n", "val_set", ",", "num_replicas", "=", "world_size", ",", "rank", "=", "rank", ")", "\n", "val_dataloader", "=", "DataLoader", "(", "val_set", ",", "batch_size", "=", "8", ",", "shuffle", "=", "False", ",", "num_workers", "=", "4", ",", "collate_fn", "=", "collate_fn_val", ",", "sampler", "=", "val_sampler", ")", "\n", "", "else", ":", "\n", "        ", "dataloader", "=", "DataLoader", "(", "train_set", ",", "batch_size", "=", "args", ".", "batch_size", ",", "shuffle", "=", "True", ",", "num_workers", "=", "4", ",", "collate_fn", "=", "collate_fn", ")", "\n", "val_dataloader", "=", "DataLoader", "(", "val_set", ",", "batch_size", "=", "8", ",", "shuffle", "=", "False", ",", "num_workers", "=", "4", ",", "collate_fn", "=", "collate_fn_val", ")", "\n", "# build models", "\n", "", "model_path", "=", "args", ".", "pretrained", "if", "args", ".", "pretrained", "is", "not", "None", "else", "args", ".", "model_type", "\n", "scorer", "=", "model", ".", "ReRanker", "(", "model_path", ",", "tok", ".", "pad_token_id", ")", "\n", "if", "len", "(", "args", ".", "model_pt", ")", ">", "0", ":", "\n", "        ", "scorer", ".", "load_state_dict", "(", "torch", ".", "load", "(", "os", ".", "path", ".", "join", "(", "\"./cache\"", ",", "args", ".", "model_pt", ")", ",", "map_location", "=", "f'cuda:{gpuid}'", ")", ")", "\n", "", "if", "args", ".", "cuda", ":", "\n", "        ", "if", "len", "(", "args", ".", "gpuid", ")", "==", "1", ":", "\n", "            ", "scorer", "=", "scorer", ".", "cuda", "(", ")", "\n", "", "else", ":", "\n", "            ", "dist", ".", "init_process_group", "(", "\"nccl\"", ",", "rank", "=", "rank", ",", "world_size", "=", "world_size", ")", "\n", "scorer", "=", "nn", ".", "parallel", ".", "DistributedDataParallel", "(", "scorer", ".", "to", "(", "gpuid", ")", ",", "[", "gpuid", "]", ",", "find_unused_parameters", "=", "True", ")", "\n", "", "", "scorer", ".", "train", "(", ")", "\n", "init_lr", "=", "args", ".", "max_lr", "/", "args", ".", "warmup_steps", "\n", "s_optimizer", "=", "optim", ".", "Adam", "(", "scorer", ".", "parameters", "(", ")", ",", "lr", "=", "init_lr", ")", "\n", "if", "is_master", ":", "\n", "        ", "recorder", ".", "write_config", "(", "args", ",", "[", "scorer", "]", ",", "__file__", ")", "\n", "", "minimum_loss", "=", "100", "\n", "all_step_cnt", "=", "0", "\n", "# start training", "\n", "for", "epoch", "in", "range", "(", "args", ".", "epoch", ")", ":", "\n", "        ", "s_optimizer", ".", "zero_grad", "(", ")", "\n", "step_cnt", "=", "0", "\n", "sim_step", "=", "0", "\n", "avg_loss", "=", "0", "\n", "for", "(", "i", ",", "batch", ")", "in", "enumerate", "(", "dataloader", ")", ":", "\n", "            ", "if", "args", ".", "cuda", ":", "\n", "                ", "to_cuda", "(", "batch", ",", "gpuid", ")", "\n", "", "step_cnt", "+=", "1", "\n", "output", "=", "scorer", "(", "batch", "[", "\"src_input_ids\"", "]", ",", "batch", "[", "\"candidate_ids\"", "]", ",", "batch", "[", "\"tgt_input_ids\"", "]", ")", "\n", "similarity", ",", "gold_similarity", "=", "output", "[", "'score'", "]", ",", "output", "[", "'summary_score'", "]", "\n", "loss", "=", "args", ".", "scale", "*", "RankingLoss", "(", "similarity", ",", "gold_similarity", ",", "args", ".", "margin", ",", "args", ".", "gold_margin", ",", "args", ".", "gold_weight", ")", "\n", "loss", "=", "loss", "/", "args", ".", "accumulate_step", "\n", "avg_loss", "+=", "loss", ".", "item", "(", ")", "\n", "loss", ".", "backward", "(", ")", "\n", "if", "step_cnt", "==", "args", ".", "accumulate_step", ":", "\n", "# optimize step      ", "\n", "                ", "if", "args", ".", "grad_norm", ">", "0", ":", "\n", "                    ", "nn", ".", "utils", ".", "clip_grad_norm_", "(", "scorer", ".", "parameters", "(", ")", ",", "args", ".", "grad_norm", ")", "\n", "", "step_cnt", "=", "0", "\n", "sim_step", "+=", "1", "\n", "all_step_cnt", "+=", "1", "\n", "lr", "=", "args", ".", "max_lr", "*", "min", "(", "all_step_cnt", "**", "(", "-", "0.5", ")", ",", "all_step_cnt", "*", "(", "args", ".", "warmup_steps", "**", "(", "-", "1.5", ")", ")", ")", "\n", "for", "param_group", "in", "s_optimizer", ".", "param_groups", ":", "\n", "                    ", "param_group", "[", "'lr'", "]", "=", "lr", "\n", "", "s_optimizer", ".", "step", "(", ")", "\n", "s_optimizer", ".", "zero_grad", "(", ")", "\n", "", "if", "sim_step", "%", "args", ".", "report_freq", "==", "0", "and", "step_cnt", "==", "0", "and", "is_master", ":", "\n", "                ", "print", "(", "\"id: %d\"", "%", "id", ")", "\n", "print", "(", "f\"similarity: {similarity[:, :10]}\"", ")", "\n", "if", "not", "args", ".", "no_gold", ":", "\n", "                    ", "print", "(", "f\"gold similarity: {gold_similarity}\"", ")", "\n", "", "recorder", ".", "print", "(", "\"epoch: %d, batch: %d, avg loss: %.6f\"", "%", "(", "epoch", "+", "1", ",", "sim_step", ",", "\n", "avg_loss", "/", "args", ".", "report_freq", ")", ")", "\n", "recorder", ".", "print", "(", "f\"learning rate: {lr:.6f}\"", ")", "\n", "recorder", ".", "plot", "(", "\"loss\"", ",", "{", "\"loss\"", ":", "avg_loss", "/", "args", ".", "report_freq", "}", ",", "all_step_cnt", ")", "\n", "recorder", ".", "print", "(", ")", "\n", "avg_loss", "=", "0", "\n", "", "del", "similarity", ",", "gold_similarity", ",", "loss", "\n", "\n", "if", "all_step_cnt", "%", "1000", "==", "0", "and", "all_step_cnt", "!=", "0", "and", "step_cnt", "==", "0", ":", "\n", "                ", "loss", "=", "test", "(", "val_dataloader", ",", "scorer", ",", "args", ",", "gpuid", ")", "\n", "if", "loss", "<", "minimum_loss", "and", "is_master", ":", "\n", "                    ", "minimum_loss", "=", "loss", "\n", "if", "is_mp", ":", "\n", "                        ", "recorder", ".", "save", "(", "scorer", ".", "module", ",", "\"scorer.bin\"", ")", "\n", "", "else", ":", "\n", "                        ", "recorder", ".", "save", "(", "scorer", ",", "\"scorer.bin\"", ")", "\n", "", "recorder", ".", "save", "(", "s_optimizer", ",", "\"optimizer.bin\"", ")", "\n", "recorder", ".", "print", "(", "\"best - epoch: %d, batch: %d\"", "%", "(", "epoch", ",", "i", "/", "args", ".", "accumulate_step", ")", ")", "\n", "", "if", "is_master", ":", "\n", "                    ", "recorder", ".", "print", "(", "\"val rouge: %.6f\"", "%", "(", "1", "-", "loss", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.main.main": [[256, 264], ["len", "torch.spawn", "main.run", "len"], "function", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.main.run"], ["", "", "", "", "", "def", "main", "(", "args", ")", ":", "\n", "# set env", "\n", "    ", "if", "len", "(", "args", ".", "gpuid", ")", ">", "1", ":", "\n", "        ", "os", ".", "environ", "[", "'MASTER_ADDR'", "]", "=", "'localhost'", "\n", "os", ".", "environ", "[", "'MASTER_PORT'", "]", "=", "f'{args.port}'", "\n", "mp", ".", "spawn", "(", "run", ",", "args", "=", "(", "args", ",", ")", ",", "nprocs", "=", "len", "(", "args", ".", "gpuid", ")", ",", "join", "=", "True", ")", "\n", "", "else", ":", "\n", "        ", "run", "(", "0", ",", "args", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.ReRankingDataset.__init__": [[53, 73], ["os.path.isdir", "transformers.RobertaTokenizer.from_pretrained", "len", "len", "os.listdir", "open", "x.strip"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "fdir", ",", "model_type", ",", "maxlen", "=", "-", "1", ",", "is_test", "=", "False", ",", "total_len", "=", "512", ",", "is_sorted", "=", "True", ",", "maxnum", "=", "-", "1", ",", "is_untok", "=", "True", ")", ":", "\n", "        ", "\"\"\" data format: article, abstract, [(candidiate_i, score_i)] \"\"\"", "\n", "self", ".", "isdir", "=", "os", ".", "path", ".", "isdir", "(", "fdir", ")", "\n", "if", "self", ".", "isdir", ":", "\n", "            ", "self", ".", "fdir", "=", "fdir", "\n", "self", ".", "num", "=", "len", "(", "os", ".", "listdir", "(", "fdir", ")", ")", "\n", "", "else", ":", "\n", "            ", "with", "open", "(", "fdir", ")", "as", "f", ":", "\n", "                ", "self", ".", "files", "=", "[", "x", ".", "strip", "(", ")", "for", "x", "in", "f", "]", "\n", "", "self", ".", "num", "=", "len", "(", "self", ".", "files", ")", "\n", "", "self", ".", "tok", "=", "RobertaTokenizer", ".", "from_pretrained", "(", "model_type", ",", "verbose", "=", "False", ")", "\n", "self", ".", "maxlen", "=", "maxlen", "\n", "self", ".", "is_test", "=", "is_test", "\n", "self", ".", "pad_token_id", "=", "self", ".", "tok", ".", "pad_token_id", "\n", "self", ".", "total_len", "=", "total_len", "\n", "self", ".", "cls_token_id", "=", "self", ".", "tok", ".", "cls_token_id", "\n", "self", ".", "sep_token_id", "=", "self", ".", "tok", ".", "sep_token_id", "\n", "self", ".", "sorted", "=", "is_sorted", "\n", "self", ".", "maxnum", "=", "maxnum", "\n", "self", ".", "is_untok", "=", "is_untok", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.ReRankingDataset.__len__": [[74, 76], ["None"], "methods", ["None"], ["", "def", "__len__", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "num", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.ReRankingDataset.bert_encode": [[77, 86], ["data_utils.ReRankingDataset.tok.encode", "ids.append", "ids.extend", "ids.extend"], "methods", ["None"], ["", "def", "bert_encode", "(", "self", ",", "x", ",", "max_len", "=", "-", "1", ")", ":", "\n", "        ", "_ids", "=", "self", ".", "tok", ".", "encode", "(", "x", ",", "add_special_tokens", "=", "False", ")", "\n", "ids", "=", "[", "self", ".", "cls_token_id", "]", "\n", "if", "max_len", ">", "0", ":", "\n", "            ", "ids", ".", "extend", "(", "_ids", "[", ":", "max_len", "-", "2", "]", ")", "\n", "", "else", ":", "\n", "            ", "ids", ".", "extend", "(", "_ids", "[", ":", "self", ".", "total_len", "-", "2", "]", ")", "\n", "", "ids", ".", "append", "(", "self", ".", "sep_token_id", ")", "\n", "return", "ids", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.ReRankingDataset.__getitem__": [[87, 127], ["data_utils.ReRankingDataset.bert_encode", "data_utils.ReRankingDataset.bert_encode", "sorted", "sorted", "data_utils.ReRankingDataset.bert_encode", "open", "json.load", "open", "json.load", "os.path.join"], "methods", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.ReRankingDataset.bert_encode", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.ReRankingDataset.bert_encode", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.ReRankingDataset.bert_encode"], ["", "def", "__getitem__", "(", "self", ",", "idx", ")", ":", "\n", "        ", "if", "self", ".", "isdir", ":", "\n", "            ", "with", "open", "(", "os", ".", "path", ".", "join", "(", "self", ".", "fdir", ",", "\"%d.json\"", "%", "idx", ")", ",", "\"r\"", ")", "as", "f", ":", "\n", "                ", "data", "=", "json", ".", "load", "(", "f", ")", "\n", "", "", "else", ":", "\n", "            ", "with", "open", "(", "self", ".", "files", "[", "idx", "]", ")", "as", "f", ":", "\n", "                ", "data", "=", "json", ".", "load", "(", "f", ")", "\n", "", "", "if", "self", ".", "is_untok", ":", "\n", "            ", "article", "=", "data", "[", "\"article_untok\"", "]", "\n", "", "else", ":", "\n", "            ", "article", "=", "data", "[", "\"article\"", "]", "\n", "", "src_txt", "=", "\" \"", ".", "join", "(", "article", ")", "\n", "src_input_ids", "=", "self", ".", "bert_encode", "(", "src_txt", ")", "\n", "if", "self", ".", "is_untok", ":", "\n", "            ", "abstract", "=", "data", "[", "\"abstract_untok\"", "]", "\n", "", "else", ":", "\n", "            ", "abstract", "=", "data", "[", "\"abstract\"", "]", "\n", "", "tgt_input_ids", "=", "self", ".", "bert_encode", "(", "\" \"", ".", "join", "(", "abstract", ")", ")", "\n", "if", "self", ".", "maxnum", ">", "0", ":", "\n", "            ", "candidates", "=", "data", "[", "\"candidates_untok\"", "]", "[", ":", "self", ".", "maxnum", "]", "\n", "_candidates", "=", "data", "[", "\"candidates\"", "]", "[", ":", "self", ".", "maxnum", "]", "\n", "data", "[", "\"candidates\"", "]", "=", "_candidates", "\n", "", "if", "self", ".", "sorted", ":", "\n", "            ", "candidates", "=", "sorted", "(", "candidates", ",", "key", "=", "lambda", "x", ":", "x", "[", "1", "]", ",", "reverse", "=", "True", ")", "\n", "_candidates", "=", "sorted", "(", "_candidates", ",", "key", "=", "lambda", "x", ":", "x", "[", "1", "]", ",", "reverse", "=", "True", ")", "\n", "data", "[", "\"candidates\"", "]", "=", "_candidates", "\n", "", "if", "not", "self", ".", "is_untok", ":", "\n", "            ", "candidates", "=", "_candidates", "\n", "", "cand_txt", "=", "[", "\" \"", ".", "join", "(", "x", "[", "0", "]", ")", "for", "x", "in", "candidates", "]", "\n", "candidate_ids", "=", "[", "self", ".", "bert_encode", "(", "x", ",", "self", ".", "maxlen", ")", "for", "x", "in", "cand_txt", "]", "\n", "scores", "=", "[", "x", "[", "1", "]", "for", "x", "in", "candidates", "]", "\n", "result", "=", "{", "\n", "\"src_input_ids\"", ":", "src_input_ids", ",", "\n", "\"tgt_input_ids\"", ":", "tgt_input_ids", ",", "\n", "\"candidate_ids\"", ":", "candidate_ids", ",", "\n", "\"scores\"", ":", "scores", "\n", "}", "\n", "if", "self", ".", "is_test", ":", "\n", "            ", "result", "[", "\"data\"", "]", "=", "data", "\n", "", "return", "result", "", "", "", ""]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.to_cuda": [[15, 19], ["batch[].to"], "function", ["None"], ["def", "to_cuda", "(", "batch", ",", "gpuid", ")", ":", "\n", "    ", "for", "n", "in", "batch", ":", "\n", "        ", "if", "n", "!=", "\"data\"", ":", "\n", "            ", "batch", "[", "n", "]", "=", "batch", "[", "n", "]", ".", "to", "(", "gpuid", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.data_utils.collate_mp": [[21, 50], ["data_utils.collate_mp.bert_pad"], "function", ["None"], ["", "", "", "def", "collate_mp", "(", "batch", ",", "pad_token_id", ",", "is_test", "=", "False", ")", ":", "\n", "    ", "def", "bert_pad", "(", "X", ",", "max_len", "=", "-", "1", ")", ":", "\n", "        ", "if", "max_len", "<", "0", ":", "\n", "            ", "max_len", "=", "max", "(", "len", "(", "x", ")", "for", "x", "in", "X", ")", "\n", "", "result", "=", "[", "]", "\n", "for", "x", "in", "X", ":", "\n", "            ", "if", "len", "(", "x", ")", "<", "max_len", ":", "\n", "                ", "x", ".", "extend", "(", "[", "pad_token_id", "]", "*", "(", "max_len", "-", "len", "(", "x", ")", ")", ")", "\n", "", "result", ".", "append", "(", "x", ")", "\n", "", "return", "torch", ".", "LongTensor", "(", "result", ")", "\n", "\n", "", "src_input_ids", "=", "bert_pad", "(", "[", "x", "[", "\"src_input_ids\"", "]", "for", "x", "in", "batch", "]", ")", "\n", "tgt_input_ids", "=", "bert_pad", "(", "[", "x", "[", "\"tgt_input_ids\"", "]", "for", "x", "in", "batch", "]", ")", "\n", "candidate_ids", "=", "[", "x", "[", "\"candidate_ids\"", "]", "for", "x", "in", "batch", "]", "\n", "max_len", "=", "max", "(", "[", "max", "(", "[", "len", "(", "c", ")", "for", "c", "in", "x", "]", ")", "for", "x", "in", "candidate_ids", "]", ")", "\n", "candidate_ids", "=", "[", "bert_pad", "(", "x", ",", "max_len", ")", "for", "x", "in", "candidate_ids", "]", "\n", "candidate_ids", "=", "torch", ".", "stack", "(", "candidate_ids", ")", "\n", "scores", "=", "torch", ".", "FloatTensor", "(", "[", "x", "[", "\"scores\"", "]", "for", "x", "in", "batch", "]", ")", "\n", "if", "is_test", ":", "\n", "        ", "data", "=", "[", "x", "[", "\"data\"", "]", "for", "x", "in", "batch", "]", "\n", "", "result", "=", "{", "\n", "\"src_input_ids\"", ":", "src_input_ids", ",", "\n", "\"tgt_input_ids\"", ":", "tgt_input_ids", ",", "\n", "\"candidate_ids\"", ":", "candidate_ids", ",", "\n", "\"scores\"", ":", "scores", "\n", "}", "\n", "if", "is_test", ":", "\n", "        ", "result", "[", "\"data\"", "]", "=", "data", "\n", "", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.preprocess.collect_diverse_beam_data": [[17, 44], ["os.path.join", "os.path.join", "os.path.join", "open", "open", "open", "open", "os.path.join", "os.path.join", "os.path.join", "os.path.join", "open", "open", "zip", "os.path.join", "os.path.join", "x.strip().lower.strip().lower", "cands.append", "y.strip().lower.strip().lower", "cands_untok.append", "len", "src.readline", "src_line.strip().lower.strip().lower", "tgt.readline", "tgt_line.strip().lower.strip().lower", "src_untok.readline", "src_line_untok.strip().lower.strip().lower", "tgt_untok.readline", "tgt_line_untok.strip().lower.strip().lower", "x.strip().lower.strip", "y.strip().lower.strip", "src_line.strip().lower.strip", "tgt_line.strip().lower.strip", "src_line_untok.strip().lower.strip", "tgt_line_untok.strip().lower.strip", "os.path.join"], "function", ["None"], ["def", "collect_diverse_beam_data", "(", "args", ")", ":", "\n", "    ", "split", "=", "os", ".", "path", ".", "join", "(", "args", ".", "split", ")", "\n", "src_dir", "=", "os", ".", "path", ".", "join", "(", "args", ".", "src_dir", ")", "\n", "tgt_dir", "=", "os", ".", "path", ".", "join", "(", "args", ".", "tgt_dir", ")", "\n", "cands", "=", "[", "]", "\n", "cands_untok", "=", "[", "]", "\n", "cnt", "=", "0", "\n", "with", "open", "(", "os", ".", "path", ".", "join", "(", "src_dir", ",", "f\"{split}.source.tokenized\"", ")", ")", "as", "src", ",", "open", "(", "os", ".", "path", ".", "join", "(", "src_dir", ",", "f\"{split}.target.tokenized\"", ")", ")", "as", "tgt", ",", "open", "(", "os", ".", "path", ".", "join", "(", "src_dir", ",", "f\"{split}.source\"", ")", ")", "as", "src_untok", ",", "open", "(", "os", ".", "path", ".", "join", "(", "src_dir", ",", "f\"{split}.target\"", ")", ")", "as", "tgt_untok", ":", "\n", "        ", "with", "open", "(", "os", ".", "path", ".", "join", "(", "src_dir", ",", "f\"{split}.out.tokenized\"", ")", ")", "as", "f_1", ",", "open", "(", "os", ".", "path", ".", "join", "(", "src_dir", ",", "f\"{split}.out\"", ")", ")", "as", "f_2", ":", "\n", "            ", "for", "(", "x", ",", "y", ")", "in", "zip", "(", "f_1", ",", "f_2", ")", ":", "\n", "                ", "x", "=", "x", ".", "strip", "(", ")", ".", "lower", "(", ")", "\n", "cands", ".", "append", "(", "x", ")", "\n", "y", "=", "y", ".", "strip", "(", ")", ".", "lower", "(", ")", "\n", "cands_untok", ".", "append", "(", "y", ")", "\n", "if", "len", "(", "cands", ")", "==", "args", ".", "cand_num", ":", "\n", "                    ", "src_line", "=", "src", ".", "readline", "(", ")", "\n", "src_line", "=", "src_line", ".", "strip", "(", ")", ".", "lower", "(", ")", "\n", "tgt_line", "=", "tgt", ".", "readline", "(", ")", "\n", "tgt_line", "=", "tgt_line", ".", "strip", "(", ")", ".", "lower", "(", ")", "\n", "src_line_untok", "=", "src_untok", ".", "readline", "(", ")", "\n", "src_line_untok", "=", "src_line_untok", ".", "strip", "(", ")", ".", "lower", "(", ")", "\n", "tgt_line_untok", "=", "tgt_untok", ".", "readline", "(", ")", "\n", "tgt_line_untok", "=", "tgt_line_untok", ".", "strip", "(", ")", ".", "lower", "(", ")", "\n", "yield", "(", "src_line", ",", "tgt_line", ",", "cands", ",", "src_line_untok", ",", "tgt_line_untok", ",", "cands_untok", ",", "os", ".", "path", ".", "join", "(", "tgt_dir", ",", "f\"{cnt}.json\"", ")", ")", "\n", "cands", "=", "[", "]", "\n", "cands_untok", "=", "[", "]", "\n", "cnt", "+=", "1", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.preprocess.build_diverse_beam": [[46, 70], ["sent_detector.tokenize", "sent_detector.tokenize", "sent_detector.tokenize", "sent_detector.tokenize", "sent_detector.tokenize", "all_scorer.score", "sent_detector.tokenize", "open", "json.dump", "preprocess.build_diverse_beam.compute_rouge"], "function", ["None"], ["", "", "", "", "", "def", "build_diverse_beam", "(", "input", ")", ":", "\n", "    ", "src_line", ",", "tgt_line", ",", "cands", ",", "src_line_untok", ",", "tgt_line_untok", ",", "cands_untok", ",", "tgt_dir", "=", "input", "\n", "cands", "=", "[", "sent_detector", ".", "tokenize", "(", "x", ")", "for", "x", "in", "cands", "]", "\n", "abstract", "=", "sent_detector", ".", "tokenize", "(", "tgt_line", ")", "\n", "_abstract", "=", "\"\\n\"", ".", "join", "(", "abstract", ")", "\n", "article", "=", "sent_detector", ".", "tokenize", "(", "src_line", ")", "\n", "def", "compute_rouge", "(", "hyp", ")", ":", "\n", "        ", "score", "=", "all_scorer", ".", "score", "(", "_abstract", ",", "\"\\n\"", ".", "join", "(", "hyp", ")", ")", "\n", "return", "(", "score", "[", "\"rouge1\"", "]", ".", "fmeasure", "+", "score", "[", "\"rouge2\"", "]", ".", "fmeasure", "+", "score", "[", "\"rougeLsum\"", "]", ".", "fmeasure", ")", "/", "3", "\n", "", "candidates", "=", "[", "(", "x", ",", "compute_rouge", "(", "x", ")", ")", "for", "x", "in", "cands", "]", "\n", "cands_untok", "=", "[", "sent_detector", ".", "tokenize", "(", "x", ")", "for", "x", "in", "cands_untok", "]", "\n", "abstract_untok", "=", "sent_detector", ".", "tokenize", "(", "tgt_line_untok", ")", "\n", "article_untok", "=", "sent_detector", ".", "tokenize", "(", "src_line_untok", ")", "\n", "candidates_untok", "=", "[", "(", "cands_untok", "[", "i", "]", ",", "candidates", "[", "i", "]", "[", "1", "]", ")", "for", "i", "in", "range", "(", "len", "(", "candidates", ")", ")", "]", "\n", "output", "=", "{", "\n", "\"article\"", ":", "article", ",", "\n", "\"abstract\"", ":", "abstract", ",", "\n", "\"candidates\"", ":", "candidates", ",", "\n", "\"article_untok\"", ":", "article_untok", ",", "\n", "\"abstract_untok\"", ":", "abstract_untok", ",", "\n", "\"candidates_untok\"", ":", "candidates_untok", ",", "\n", "}", "\n", "with", "open", "(", "tgt_dir", ",", "\"w\"", ")", "as", "f", ":", "\n", "        ", "json", ".", "dump", "(", "output", ",", "f", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.preprocess.make_diverse_beam_data": [[72, 77], ["preprocess.collect_diverse_beam_data", "print", "multiprocessing.Pool", "list", "pool.imap_unordered"], "function", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.preprocess.collect_diverse_beam_data", "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print"], ["", "", "def", "make_diverse_beam_data", "(", "args", ")", ":", "\n", "    ", "data", "=", "collect_diverse_beam_data", "(", "args", ")", "\n", "with", "Pool", "(", "processes", "=", "8", ")", "as", "pool", ":", "\n", "        ", "list", "(", "pool", ".", "imap_unordered", "(", "build_diverse_beam", ",", "data", ",", "chunksize", "=", "64", ")", ")", "\n", "", "print", "(", "\"finish\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.model.ReRanker.__init__": [[37, 41], ["torch.nn.Module.__init__", "transformers.RobertaModel.from_pretrained"], "methods", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.__init__"], ["    ", "def", "__init__", "(", "self", ",", "encoder", ",", "pad_token_id", ")", ":", "\n", "        ", "super", "(", "ReRanker", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "encoder", "=", "RobertaModel", ".", "from_pretrained", "(", "encoder", ")", "\n", "self", ".", "pad_token_id", "=", "pad_token_id", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.model.ReRanker.forward": [[42, 71], ["text_id.size", "candidate_id.view.view.size", "candidate_id.view.view.view", "out[].view", "doc_emb.unsqueeze().expand_as.unsqueeze().expand_as.unsqueeze().expand_as", "torch.cosine_similarity", "model.ReRanker.encoder", "torch.cosine_similarity", "candidate_id.view.view.size", "model.ReRanker.encoder", "model.ReRanker.encoder", "doc_emb.unsqueeze().expand_as.unsqueeze().expand_as.unsqueeze"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "text_id", ",", "candidate_id", ",", "summary_id", "=", "None", ",", "require_gold", "=", "True", ")", ":", "\n", "\n", "        ", "batch_size", "=", "text_id", ".", "size", "(", "0", ")", "\n", "\n", "input_mask", "=", "text_id", "!=", "self", ".", "pad_token_id", "\n", "out", "=", "self", ".", "encoder", "(", "text_id", ",", "attention_mask", "=", "input_mask", ")", "[", "0", "]", "\n", "doc_emb", "=", "out", "[", ":", ",", "0", ",", ":", "]", "\n", "\n", "if", "require_gold", ":", "\n", "# get reference score", "\n", "            ", "input_mask", "=", "summary_id", "!=", "self", ".", "pad_token_id", "\n", "out", "=", "self", ".", "encoder", "(", "summary_id", ",", "attention_mask", "=", "input_mask", ")", "[", "0", "]", "\n", "summary_emb", "=", "out", "[", ":", ",", "0", ",", ":", "]", "\n", "summary_score", "=", "torch", ".", "cosine_similarity", "(", "summary_emb", ",", "doc_emb", ",", "dim", "=", "-", "1", ")", "\n", "\n", "", "candidate_num", "=", "candidate_id", ".", "size", "(", "1", ")", "\n", "candidate_id", "=", "candidate_id", ".", "view", "(", "-", "1", ",", "candidate_id", ".", "size", "(", "-", "1", ")", ")", "\n", "input_mask", "=", "candidate_id", "!=", "self", ".", "pad_token_id", "\n", "out", "=", "self", ".", "encoder", "(", "candidate_id", ",", "attention_mask", "=", "input_mask", ")", "[", "0", "]", "\n", "candidate_emb", "=", "out", "[", ":", ",", "0", ",", ":", "]", ".", "view", "(", "batch_size", ",", "candidate_num", ",", "-", "1", ")", "\n", "\n", "# get candidate score", "\n", "doc_emb", "=", "doc_emb", ".", "unsqueeze", "(", "1", ")", ".", "expand_as", "(", "candidate_emb", ")", "\n", "score", "=", "torch", ".", "cosine_similarity", "(", "candidate_emb", ",", "doc_emb", ",", "dim", "=", "-", "1", ")", "\n", "\n", "output", "=", "{", "'score'", ":", "score", "}", "\n", "if", "require_gold", ":", "\n", "            ", "output", "[", "'summary_score'", "]", "=", "summary_score", "\n", "", "return", "output", "", "", "", ""]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.model.RankingLoss": [[7, 34], ["torch.ones_like", "torch.nn.MarginRankingLoss", "torch.nn.MarginRankingLoss.", "score.size", "summary_score.unsqueeze().expand_as", "pos_score.contiguous().view.contiguous().view", "neg_score.contiguous().view.contiguous().view", "torch.ones_like", "torch.nn.MarginRankingLoss", "range", "torch.nn.MarginRankingLoss.", "pos_score.contiguous().view.contiguous().view", "neg_score.contiguous().view.contiguous().view", "torch.ones_like", "torch.nn.MarginRankingLoss", "torch.nn.MarginRankingLoss.", "summary_score.unsqueeze", "pos_score.contiguous().view.contiguous", "neg_score.contiguous().view.contiguous", "pos_score.contiguous().view.contiguous", "neg_score.contiguous().view.contiguous"], "function", ["None"], ["def", "RankingLoss", "(", "score", ",", "summary_score", "=", "None", ",", "margin", "=", "0", ",", "gold_margin", "=", "0", ",", "gold_weight", "=", "1", ",", "no_gold", "=", "False", ",", "no_cand", "=", "False", ")", ":", "\n", "    ", "ones", "=", "torch", ".", "ones_like", "(", "score", ")", "\n", "loss_func", "=", "torch", ".", "nn", ".", "MarginRankingLoss", "(", "0.0", ")", "\n", "TotalLoss", "=", "loss_func", "(", "score", ",", "score", ",", "ones", ")", "\n", "# candidate loss", "\n", "n", "=", "score", ".", "size", "(", "1", ")", "\n", "if", "not", "no_cand", ":", "\n", "        ", "for", "i", "in", "range", "(", "1", ",", "n", ")", ":", "\n", "            ", "pos_score", "=", "score", "[", ":", ",", ":", "-", "i", "]", "\n", "neg_score", "=", "score", "[", ":", ",", "i", ":", "]", "\n", "pos_score", "=", "pos_score", ".", "contiguous", "(", ")", ".", "view", "(", "-", "1", ")", "\n", "neg_score", "=", "neg_score", ".", "contiguous", "(", ")", ".", "view", "(", "-", "1", ")", "\n", "ones", "=", "torch", ".", "ones_like", "(", "pos_score", ")", "\n", "loss_func", "=", "torch", ".", "nn", ".", "MarginRankingLoss", "(", "margin", "*", "i", ")", "\n", "loss", "=", "loss_func", "(", "pos_score", ",", "neg_score", ",", "ones", ")", "\n", "TotalLoss", "+=", "loss", "\n", "", "", "if", "no_gold", ":", "\n", "        ", "return", "TotalLoss", "\n", "# gold summary loss", "\n", "", "pos_score", "=", "summary_score", ".", "unsqueeze", "(", "-", "1", ")", ".", "expand_as", "(", "score", ")", "\n", "neg_score", "=", "score", "\n", "pos_score", "=", "pos_score", ".", "contiguous", "(", ")", ".", "view", "(", "-", "1", ")", "\n", "neg_score", "=", "neg_score", ".", "contiguous", "(", ")", ".", "view", "(", "-", "1", ")", "\n", "ones", "=", "torch", ".", "ones_like", "(", "pos_score", ")", "\n", "loss_func", "=", "torch", ".", "nn", ".", "MarginRankingLoss", "(", "gold_margin", ")", "\n", "TotalLoss", "+=", "gold_weight", "*", "loss_func", "(", "pos_score", ",", "neg_score", ",", "ones", ")", "\n", "return", "TotalLoss", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.__init__": [[9, 18], ["datetime.datetime.datetime.now", "datetime.datetime.now.strftime", "os.mkdir", "open", "torch.utils.tensorboard.SummaryWriter", "os.path.join", "os.path.join"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "id", ",", "log", "=", "True", ")", ":", "\n", "        ", "self", ".", "log", "=", "log", "\n", "now", "=", "datetime", ".", "now", "(", ")", "\n", "date", "=", "now", ".", "strftime", "(", "\"%y-%m-%d\"", ")", "\n", "self", ".", "dir", "=", "f\"./cache/{date}-{id}\"", "\n", "if", "self", ".", "log", ":", "\n", "            ", "os", ".", "mkdir", "(", "self", ".", "dir", ")", "\n", "self", ".", "f", "=", "open", "(", "os", ".", "path", ".", "join", "(", "self", ".", "dir", ",", "\"log.txt\"", ")", ",", "\"w\"", ")", "\n", "self", ".", "writer", "=", "SummaryWriter", "(", "os", ".", "path", ".", "join", "(", "self", ".", "dir", ",", "\"log\"", ")", ",", "flush_secs", "=", "60", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.write_config": [[19, 33], ["utils.Recorder.print"], "methods", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print"], ["", "", "def", "write_config", "(", "self", ",", "args", ",", "models", ",", "name", ")", ":", "\n", "        ", "if", "self", ".", "log", ":", "\n", "            ", "with", "open", "(", "os", ".", "path", ".", "join", "(", "self", ".", "dir", ",", "\"config.txt\"", ")", ",", "\"w\"", ")", "as", "f", ":", "\n", "                ", "print", "(", "name", ",", "file", "=", "f", ")", "\n", "print", "(", "args", ",", "file", "=", "f", ")", "\n", "print", "(", "file", "=", "f", ")", "\n", "for", "(", "i", ",", "x", ")", "in", "enumerate", "(", "models", ")", ":", "\n", "                    ", "print", "(", "x", ",", "file", "=", "f", ")", "\n", "print", "(", "file", "=", "f", ")", "\n", "", "", "", "print", "(", "args", ")", "\n", "print", "(", ")", "\n", "for", "(", "i", ",", "x", ")", "in", "enumerate", "(", "models", ")", ":", "\n", "            ", "print", "(", "x", ")", "\n", "print", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print": [[34, 44], ["utils.Recorder.print"], "methods", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.print"], ["", "", "def", "print", "(", "self", ",", "x", "=", "None", ")", ":", "\n", "        ", "if", "x", "is", "not", "None", ":", "\n", "            ", "print", "(", "x", ")", "\n", "", "else", ":", "\n", "            ", "print", "(", ")", "\n", "", "if", "self", ".", "log", ":", "\n", "            ", "if", "x", "is", "not", "None", ":", "\n", "                ", "print", "(", "x", ",", "file", "=", "self", ".", "f", ")", "\n", "", "else", ":", "\n", "                ", "print", "(", "file", "=", "self", ".", "f", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.plot": [[45, 48], ["utils.Recorder.writer.add_scalars"], "methods", ["None"], ["", "", "", "def", "plot", "(", "self", ",", "tag", ",", "values", ",", "step", ")", ":", "\n", "        ", "if", "self", ".", "log", ":", "\n", "            ", "self", ".", "writer", ".", "add_scalars", "(", "tag", ",", "values", ",", "step", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.__del__": [[50, 54], ["utils.Recorder.f.close", "utils.Recorder.writer.close"], "methods", ["None"], ["", "", "def", "__del__", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "log", ":", "\n", "            ", "self", ".", "f", ".", "close", "(", ")", "\n", "self", ".", "writer", ".", "close", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.save": [[55, 58], ["torch.save", "model.state_dict", "os.path.join"], "methods", ["home.repos.pwc.inspect_result.yixinL7_SimCLS.None.utils.Recorder.save"], ["", "", "def", "save", "(", "self", ",", "model", ",", "name", ")", ":", "\n", "        ", "if", "self", ".", "log", ":", "\n", "            ", "torch", ".", "save", "(", "model", ".", "state_dict", "(", ")", ",", "os", ".", "path", ".", "join", "(", "self", ".", "dir", ",", "name", ")", ")", "", "", "", "", ""]]}