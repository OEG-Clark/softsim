{"home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_model_graph_func": [[15, 20], ["tensorflow.python.platform.tf_logging.fatal", "globals", "globals"], "function", ["None"], ["def", "get_model_graph_func", "(", "graph_type", ")", ":", "\n", "    ", "\"\"\"Get Model Graph Function\"\"\"", "\n", "if", "graph_type", "in", "globals", "(", ")", ":", "\n", "        ", "return", "globals", "(", ")", "[", "graph_type", "]", "\n", "", "tf_logging", ".", "fatal", "(", "\"model_name=%s is not valid\"", "%", "graph_type", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_labels": [[22, 38], ["features_config.items", "features_config.items", "tensorflow.cast", "tensorflow.reshape", "tensorflow.cast", "tensorflow.reshape"], "function", ["None"], ["", "def", "get_labels", "(", "features_config", ",", "features", ",", "multi_task_labels", "=", "False", ")", ":", "\n", "    ", "\"\"\"Get Label Vector From Data\"\"\"", "\n", "if", "multi_task_labels", ":", "\n", "        ", "labels", "=", "{", "}", "\n", "for", "feature_name", ",", "feature_config", "in", "features_config", ".", "items", "(", ")", ":", "\n", "            ", "if", "feature_config", ".", "is_label_feature", ":", "\n", "                ", "label", "=", "tf", ".", "cast", "(", "tf", ".", "reshape", "(", "features", "[", "feature_name", "]", ",", "[", "-", "1", ",", "1", "]", ")", ",", "tf", ".", "float32", ")", "\n", "labels", "[", "feature_name", "]", "=", "label", "\n", "", "", "", "else", ":", "\n", "        ", "labels", "=", "None", "\n", "for", "feature_name", ",", "feature_config", "in", "features_config", ".", "items", "(", ")", ":", "\n", "            ", "if", "feature_config", ".", "is_label_feature", ":", "\n", "                ", "labels", "=", "features", "[", "feature_name", "]", "\n", "break", "\n", "", "", "labels", "=", "tf", ".", "cast", "(", "tf", ".", "reshape", "(", "labels", ",", "[", "-", "1", ",", "1", "]", ")", ",", "tf", ".", "float32", ")", "\n", "", "return", "labels", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_by_name": [[39, 45], ["features_config.items", "tensorflow.cast", "tensorflow.reshape"], "function", ["None"], ["", "def", "get_by_name", "(", "features_config", ",", "features", ",", "name", ")", ":", "\n", "    ", "ret", "=", "{", "}", "\n", "for", "feature_name", ",", "feature_config", "in", "features_config", ".", "items", "(", ")", ":", "\n", "        ", "if", "name", "==", "feature_config", ".", "field", ":", "\n", "            ", "ret", "[", "feature_name", "]", "=", "tf", ".", "cast", "(", "tf", ".", "reshape", "(", "features", "[", "feature_name", "]", ",", "[", "-", "1", ",", "1", "]", ")", ",", "tf", ".", "float32", ")", "\n", "", "", "return", "ret", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_field_by_name": [[46, 52], ["features_config.items", "tensorflow.cast", "tensorflow.reshape"], "function", ["None"], ["", "def", "get_field_by_name", "(", "features_config", ",", "features", ",", "name", ")", ":", "\n", "    ", "ret", "=", "None", "\n", "for", "feature_name", ",", "feature_config", "in", "features_config", ".", "items", "(", ")", ":", "\n", "        ", "if", "name", "==", "feature_name", ":", "\n", "            ", "return", "tf", ".", "cast", "(", "tf", ".", "reshape", "(", "features", "[", "feature_name", "]", ",", "[", "-", "1", ",", "1", "]", ")", ",", "tf", ".", "float32", ")", "\n", "", "", "return", "ret", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_field_logits": [[53, 59], ["core.model_ops.build_field", "tensorflow.reshape"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.build_field"], ["", "def", "get_field_logits", "(", "impl_config", ",", "features", ",", "field_name", ",", "is_training", ")", ":", "\n", "    ", "\"\"\"Build Field Logtis\"\"\"", "\n", "logits", "=", "model_ops", ".", "build_field", "(", "\n", "impl_config", ",", "features", ",", "is_training", ",", "field_name", ")", "\n", "logits", "=", "tf", ".", "reshape", "(", "logits", ",", "[", "-", "1", ",", "1", "]", ")", "\n", "return", "logits", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.user_MVKE_and_tag_HS": [[61, 111], ["tensorflow.python.platform.tf_logging.info", "list", "model_graph_type.get_labels", "core.mvke_ops.build_mmoe", "core.mvke_ops.build_mvke", "fields_config.keys", "len", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.reduce_sum", "tensorflow.nn.sigmoid_cross_entropy_with_logits", "tensorflow.reduce_mean", "tensorflow.sigmoid", "tensorflow.concat", "str", "tensorflow.multiply"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_labels", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mvke"], ["", "def", "user_MVKE_and_tag_HS", "(", "impl_config", ",", "features", ",", "is_training", ")", ":", "\n", "    ", "\"\"\"Dot model: user equipped MVKE & tag equipped Hard-Shared\"\"\"", "\n", "tf_logging", ".", "info", "(", "\"build_graph:%s\"", "%", "str", "(", "features", ")", ")", "\n", "\n", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "field_name_list", "=", "list", "(", "fields_config", ".", "keys", "(", ")", ")", "\n", "if", "len", "(", "field_name_list", ")", "!=", "2", ":", "\n", "        ", "tf_logging", ".", "fatal", "(", "\"field count should equal to 2\"", ")", "\n", "\n", "", "field_name0", "=", "\"user\"", "\n", "field_name1", "=", "\"tag\"", "\n", "\n", "raw_labels", "=", "get_labels", "(", "features_config", ",", "features", ",", "multi_task_labels", "=", "True", ")", "\n", "labels", "=", "{", "'pctr'", ":", "raw_labels", "[", "'litectr_label'", "]", ",", "'pcvr'", ":", "raw_labels", "[", "'cvr_label'", "]", "}", "\n", "\n", "tag_outs", "=", "mvke_ops", ".", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name1", ",", "is_training", ",", "\n", "expert_num", "=", "2", ",", "\n", "obj_config", "=", "{", "'pctr'", ":", "[", "0", ",", "0", "]", ",", "'pcvr'", ":", "[", "1", ",", "1", "]", "}", ")", "# 2 tasks have no shared expert", "\n", "\n", "user_outs", ",", "tag_vke_weights", ",", "user_vke_outputs", "=", "mvke_ops", ".", "build_mvke", "(", "impl_config", ",", "features", ",", "field_name0", ",", "is_training", ",", "\n", "tag_key", "=", "tag_outs", ",", "\n", "shared_model", "=", "False", ",", "#FLAGS.shared_model, ", "\n", "vke_num", "=", "5", ",", "\n", "obj_config", "=", "{", "'pctr'", ":", "[", "0", ",", "2", "]", ",", "'pcvr'", ":", "[", "1", ",", "4", "]", "}", ")", "\n", "\n", "losses", "=", "{", "}", "\n", "scores", "=", "{", "}", "\n", "pred_out_tag", "=", "{", "}", "\n", "for", "task", "in", "[", "'pctr'", ",", "'pcvr'", "]", ":", "\n", "        ", "user_emb", "=", "user_outs", "[", "task", "]", "\n", "tag_emb", "=", "tag_outs", "[", "task", "]", "\n", "label", "=", "labels", "[", "task", "]", "\n", "\n", "dot", "=", "tf", ".", "reduce_sum", "(", "tf", ".", "multiply", "(", "user_emb", ",", "tag_emb", ")", ",", "axis", "=", "1", ",", "keepdims", "=", "True", ")", "\n", "cross_entropy", "=", "tf", ".", "nn", ".", "sigmoid_cross_entropy_with_logits", "(", "labels", "=", "label", ",", "logits", "=", "dot", ")", "\n", "loss", "=", "tf", ".", "reduce_mean", "(", "cross_entropy", ")", "\n", "\n", "losses", "[", "task", "]", "=", "loss", "\n", "scores", "[", "task", "]", "=", "tf", ".", "sigmoid", "(", "dot", ")", "\n", "pred_out_tag", "[", "task", "]", "=", "tf", ".", "concat", "(", "[", "tag_emb", ",", "tag_vke_weights", "[", "task", "]", "]", ",", "axis", "=", "1", ")", "\n", "\n", "", "loss_all", "=", "losses", "[", "'pctr'", "]", "+", "losses", "[", "'pcvr'", "]", "# can try more param here", "\n", "\n", "return", "{", "\n", "\"loss\"", ":", "loss_all", ",", "\n", "\"scores\"", ":", "scores", ",", "\n", "\"labels\"", ":", "labels", ",", "\n", "# for predict", "\n", "field_name0", ":", "user_vke_outputs", ",", "\n", "field_name1", ":", "pred_out_tag", ",", "\n", "}", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.user_MMoE_and_tag_HS": [[114, 160], ["tensorflow.python.platform.tf_logging.info", "list", "model_graph_type.get_labels", "core.mvke_ops.build_mmoe", "core.mvke_ops.build_mmoe", "fields_config.keys", "len", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.reduce_sum", "tensorflow.nn.sigmoid_cross_entropy_with_logits", "tensorflow.reduce_mean", "tensorflow.sigmoid", "str", "tensorflow.multiply"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_labels", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe"], ["", "def", "user_MMoE_and_tag_HS", "(", "impl_config", ",", "features", ",", "is_training", ")", ":", "\n", "    ", "\"\"\"Dot model: user equipped MMoE & tag equipped Hard-Shared\"\"\"", "\n", "tf_logging", ".", "info", "(", "\"build_graph:%s\"", "%", "str", "(", "features", ")", ")", "\n", "\n", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "field_name_list", "=", "list", "(", "fields_config", ".", "keys", "(", ")", ")", "\n", "if", "len", "(", "field_name_list", ")", "!=", "2", ":", "\n", "        ", "tf_logging", ".", "fatal", "(", "\"field count should equal to 2\"", ")", "\n", "\n", "", "field_name0", "=", "\"user\"", "\n", "field_name1", "=", "\"tag\"", "\n", "\n", "raw_labels", "=", "get_labels", "(", "features_config", ",", "features", ",", "multi_task_labels", "=", "True", ")", "\n", "labels", "=", "{", "'pctr'", ":", "raw_labels", "[", "'litectr_label'", "]", ",", "'pcvr'", ":", "raw_labels", "[", "'cvr_label'", "]", "}", "\n", "\n", "tag_outs", "=", "mvke_ops", ".", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name1", ",", "is_training", ",", "\n", "expert_num", "=", "2", ",", "\n", "obj_config", "=", "{", "'pctr'", ":", "[", "0", ",", "0", "]", ",", "'pcvr'", ":", "[", "1", ",", "1", "]", "}", ")", "# two tasks have no shared expert", "\n", "\n", "user_outs", "=", "mvke_ops", ".", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name0", ",", "is_training", ",", "\n", "expert_num", "=", "10", ",", "\n", "obj_config", "=", "{", "'pctr'", ":", "[", "0", ",", "5", "]", ",", "'pcvr'", ":", "[", "2", ",", "9", "]", "}", ")", "\n", "\n", "losses", "=", "{", "}", "\n", "scores", "=", "{", "}", "\n", "for", "task", "in", "[", "'pctr'", ",", "'pcvr'", "]", ":", "\n", "        ", "user_emb", "=", "user_outs", "[", "task", "]", "\n", "tag_emb", "=", "tag_outs", "[", "task", "]", "\n", "label", "=", "labels", "[", "task", "]", "\n", "\n", "dot", "=", "tf", ".", "reduce_sum", "(", "tf", ".", "multiply", "(", "user_emb", ",", "tag_emb", ")", ",", "axis", "=", "1", ",", "keepdims", "=", "True", ")", "\n", "cross_entropy", "=", "tf", ".", "nn", ".", "sigmoid_cross_entropy_with_logits", "(", "labels", "=", "label", ",", "logits", "=", "dot", ")", "\n", "loss", "=", "tf", ".", "reduce_mean", "(", "cross_entropy", ")", "\n", "\n", "losses", "[", "task", "]", "=", "loss", "\n", "scores", "[", "task", "]", "=", "tf", ".", "sigmoid", "(", "dot", ")", "\n", "\n", "", "loss_all", "=", "losses", "[", "'pctr'", "]", "+", "losses", "[", "'pcvr'", "]", "\n", "\n", "return", "{", "\n", "\"loss\"", ":", "loss_all", ",", "\n", "\"scores\"", ":", "scores", ",", "\n", "\"labels\"", ":", "labels", ",", "\n", "# for predict", "\n", "field_name0", ":", "user_outs", ",", "\n", "field_name1", ":", "tag_outs", ",", "\n", "}", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.user_HS_and_tag_HS": [[163, 209], ["tensorflow.python.platform.tf_logging.info", "list", "model_graph_type.get_labels", "core.mvke_ops.build_mmoe", "core.mvke_ops.build_mmoe", "fields_config.keys", "len", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.reduce_sum", "tensorflow.nn.sigmoid_cross_entropy_with_logits", "tensorflow.reduce_mean", "tensorflow.sigmoid", "str", "tensorflow.multiply"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_labels", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe"], ["", "def", "user_HS_and_tag_HS", "(", "impl_config", ",", "features", ",", "is_training", ")", ":", "\n", "    ", "\"\"\"Dot model: user equipped HS & tag equipped Hard-Shared\"\"\"", "\n", "tf_logging", ".", "info", "(", "\"build_graph:%s\"", "%", "str", "(", "features", ")", ")", "\n", "\n", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "field_name_list", "=", "list", "(", "fields_config", ".", "keys", "(", ")", ")", "\n", "if", "len", "(", "field_name_list", ")", "!=", "2", ":", "\n", "        ", "tf_logging", ".", "fatal", "(", "\"field count should equal to 2\"", ")", "\n", "\n", "", "field_name0", "=", "\"user\"", "\n", "field_name1", "=", "\"tag\"", "\n", "\n", "raw_labels", "=", "get_labels", "(", "features_config", ",", "features", ",", "multi_task_labels", "=", "True", ")", "\n", "labels", "=", "{", "'pctr'", ":", "raw_labels", "[", "'litectr_label'", "]", ",", "'pcvr'", ":", "raw_labels", "[", "'cvr_label'", "]", "}", "\n", "\n", "tag_outs", "=", "mvke_ops", ".", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name1", ",", "is_training", ",", "\n", "expert_num", "=", "2", ",", "\n", "obj_config", "=", "{", "'pctr'", ":", "[", "0", ",", "0", "]", ",", "'pcvr'", ":", "[", "1", ",", "1", "]", "}", ")", "# two tasks have no shared expert", "\n", "\n", "user_outs", "=", "mvke_ops", ".", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name0", ",", "is_training", ",", "\n", "expert_num", "=", "2", ",", "\n", "obj_config", "=", "{", "'pctr'", ":", "[", "0", ",", "0", "]", ",", "'pcvr'", ":", "[", "1", ",", "1", "]", "}", ")", "\n", "\n", "losses", "=", "{", "}", "\n", "scores", "=", "{", "}", "\n", "for", "task", "in", "[", "'pctr'", ",", "'pcvr'", "]", ":", "\n", "        ", "user_emb", "=", "user_outs", "[", "task", "]", "\n", "tag_emb", "=", "tag_outs", "[", "task", "]", "\n", "label", "=", "labels", "[", "task", "]", "\n", "\n", "dot", "=", "tf", ".", "reduce_sum", "(", "tf", ".", "multiply", "(", "user_emb", ",", "tag_emb", ")", ",", "axis", "=", "1", ",", "keepdims", "=", "True", ")", "\n", "cross_entropy", "=", "tf", ".", "nn", ".", "sigmoid_cross_entropy_with_logits", "(", "labels", "=", "label", ",", "logits", "=", "dot", ")", "\n", "loss", "=", "tf", ".", "reduce_mean", "(", "cross_entropy", ")", "\n", "\n", "losses", "[", "task", "]", "=", "loss", "\n", "scores", "[", "task", "]", "=", "tf", ".", "sigmoid", "(", "dot", ")", "\n", "\n", "", "loss_all", "=", "losses", "[", "'pctr'", "]", "+", "losses", "[", "'pcvr'", "]", "\n", "\n", "return", "{", "\n", "\"loss\"", ":", "loss_all", ",", "\n", "\"scores\"", ":", "scores", ",", "\n", "\"labels\"", ":", "labels", ",", "\n", "# for predict", "\n", "field_name0", ":", "user_outs", ",", "\n", "field_name1", ":", "tag_outs", ",", "\n", "}", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.user_and_tag_single_pctr": [[211, 252], ["tensorflow.python.platform.tf_logging.info", "list", "model_graph_type.get_labels", "core.mvke_ops.build_mmoe", "core.mvke_ops.build_mmoe", "tensorflow.reduce_sum", "tensorflow.nn.sigmoid_cross_entropy_with_logits", "tensorflow.reduce_mean", "fields_config.keys", "len", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.multiply", "tensorflow.sigmoid", "str"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_labels", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe"], ["", "def", "user_and_tag_single_pctr", "(", "impl_config", ",", "features", ",", "is_training", ")", ":", "\n", "    ", "\"\"\"Dot model: user & tag both equipped single model\"\"\"", "\n", "tf_logging", ".", "info", "(", "\"build_graph:%s\"", "%", "str", "(", "features", ")", ")", "\n", "\n", "task", "=", "'pctr'", "\n", "\n", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "field_name_list", "=", "list", "(", "fields_config", ".", "keys", "(", ")", ")", "\n", "if", "len", "(", "field_name_list", ")", "!=", "2", ":", "\n", "        ", "tf_logging", ".", "fatal", "(", "\"field count should equal to 2\"", ")", "\n", "\n", "", "field_name0", "=", "\"user\"", "\n", "field_name1", "=", "\"tag\"", "\n", "\n", "raw_labels", "=", "get_labels", "(", "features_config", ",", "features", ",", "multi_task_labels", "=", "True", ")", "\n", "labels", "=", "{", "'pctr'", ":", "raw_labels", "[", "'litectr_label'", "]", ",", "'pcvr'", ":", "raw_labels", "[", "'cvr_label'", "]", "}", "\n", "\n", "tag_outs", "=", "mvke_ops", ".", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name1", ",", "is_training", ",", "\n", "expert_num", "=", "1", ",", "\n", "obj_config", "=", "{", "task", ":", "[", "0", ",", "0", "]", "}", ")", "\n", "\n", "user_outs", "=", "mvke_ops", ".", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name0", ",", "is_training", ",", "\n", "expert_num", "=", "1", ",", "\n", "obj_config", "=", "{", "task", ":", "[", "0", ",", "0", "]", "}", ")", "\n", "\n", "user_emb", "=", "user_outs", "[", "task", "]", "\n", "tag_emb", "=", "tag_outs", "[", "task", "]", "\n", "label", "=", "labels", "[", "task", "]", "\n", "\n", "dot", "=", "tf", ".", "reduce_sum", "(", "tf", ".", "multiply", "(", "user_emb", ",", "tag_emb", ")", ",", "axis", "=", "1", ",", "keepdims", "=", "True", ")", "\n", "cross_entropy", "=", "tf", ".", "nn", ".", "sigmoid_cross_entropy_with_logits", "(", "labels", "=", "label", ",", "logits", "=", "dot", ")", "\n", "loss", "=", "tf", ".", "reduce_mean", "(", "cross_entropy", ")", "\n", "scores", "=", "{", "task", ":", "tf", ".", "sigmoid", "(", "dot", ")", "}", "\n", "\n", "return", "{", "\n", "\"loss\"", ":", "loss", ",", "\n", "\"scores\"", ":", "scores", ",", "\n", "\"labels\"", ":", "labels", ",", "\n", "# for predict", "\n", "field_name0", ":", "user_outs", ",", "\n", "field_name1", ":", "tag_outs", ",", "\n", "}", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.user_and_tag_single_pcvr": [[254, 295], ["tensorflow.python.platform.tf_logging.info", "list", "model_graph_type.get_labels", "core.mvke_ops.build_mmoe", "core.mvke_ops.build_mmoe", "tensorflow.reduce_sum", "tensorflow.nn.sigmoid_cross_entropy_with_logits", "tensorflow.reduce_mean", "fields_config.keys", "len", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.multiply", "tensorflow.sigmoid", "str"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.None.model_graph_type.get_labels", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe"], ["", "def", "user_and_tag_single_pcvr", "(", "impl_config", ",", "features", ",", "is_training", ")", ":", "\n", "    ", "\"\"\"Dot model: user & tag both equipped single model\"\"\"", "\n", "tf_logging", ".", "info", "(", "\"build_graph:%s\"", "%", "str", "(", "features", ")", ")", "\n", "\n", "task", "=", "'pcvr'", "\n", "\n", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "field_name_list", "=", "list", "(", "fields_config", ".", "keys", "(", ")", ")", "\n", "if", "len", "(", "field_name_list", ")", "!=", "2", ":", "\n", "        ", "tf_logging", ".", "fatal", "(", "\"field count should equal to 2\"", ")", "\n", "\n", "", "field_name0", "=", "\"user\"", "\n", "field_name1", "=", "\"tag\"", "\n", "\n", "raw_labels", "=", "get_labels", "(", "features_config", ",", "features", ",", "multi_task_labels", "=", "True", ")", "\n", "labels", "=", "{", "'pctr'", ":", "raw_labels", "[", "'litectr_label'", "]", ",", "'pcvr'", ":", "raw_labels", "[", "'cvr_label'", "]", "}", "\n", "\n", "tag_outs", "=", "mvke_ops", ".", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name1", ",", "is_training", ",", "\n", "expert_num", "=", "1", ",", "\n", "obj_config", "=", "{", "task", ":", "[", "0", ",", "0", "]", "}", ")", "\n", "\n", "user_outs", "=", "mvke_ops", ".", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name0", ",", "is_training", ",", "\n", "expert_num", "=", "1", ",", "\n", "obj_config", "=", "{", "task", ":", "[", "0", ",", "0", "]", "}", ")", "\n", "\n", "user_emb", "=", "user_outs", "[", "task", "]", "\n", "tag_emb", "=", "tag_outs", "[", "task", "]", "\n", "label", "=", "labels", "[", "task", "]", "\n", "\n", "dot", "=", "tf", ".", "reduce_sum", "(", "tf", ".", "multiply", "(", "user_emb", ",", "tag_emb", ")", ",", "axis", "=", "1", ",", "keepdims", "=", "True", ")", "\n", "cross_entropy", "=", "tf", ".", "nn", ".", "sigmoid_cross_entropy_with_logits", "(", "labels", "=", "label", ",", "logits", "=", "dot", ")", "\n", "loss", "=", "tf", ".", "reduce_mean", "(", "cross_entropy", ")", "\n", "scores", "=", "{", "task", ":", "tf", ".", "sigmoid", "(", "dot", ")", "}", "\n", "\n", "return", "{", "\n", "\"loss\"", ":", "loss", ",", "\n", "\"scores\"", ":", "scores", ",", "\n", "\"labels\"", ":", "labels", ",", "\n", "# for predict", "\n", "field_name0", ":", "user_outs", ",", "\n", "field_name1", ":", "tag_outs", ",", "\n", "}", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._variable_on_cpu": [[19, 32], ["tensorflow.device", "tensorflow.get_variable"], "function", ["None"], ["def", "_variable_on_cpu", "(", "name", ",", "shape", ",", "initializer", ")", ":", "\n", "    ", "\"\"\"Helper to create a Variable stored on CPU memory.\n      Args:\n        name: name of the variable\n        shape: list of ints\n        initializer: initializer for Variable\n      Returns:\n        Variable Tensor\n    \"\"\"", "\n", "with", "tf", ".", "device", "(", "'/cpu:0'", ")", ":", "\n", "        ", "var", "=", "tf", ".", "get_variable", "(", "\n", "name", ",", "shape", ",", "initializer", "=", "initializer", ")", "\n", "", "return", "var", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._variable_on_cpu_var": [[33, 46], ["tensorflow.device", "tensorflow.get_variable"], "function", ["None"], ["", "def", "_variable_on_cpu_var", "(", "name", ",", "shape", ",", "initializer", ")", ":", "\n", "    ", "\"\"\"Helper to create a Variable stored on CPU memory.\n      Args:\n        name: name of the variable\n        shape: list of ints\n        initializer: initializer for Variable\n      Returns:\n        Variable Tensor\n    \"\"\"", "\n", "with", "tf", ".", "device", "(", "'/cpu:0'", ")", ":", "\n", "        ", "var", "=", "tf", ".", "get_variable", "(", "\n", "name", ",", "shape", ",", "initializer", "=", "initializer", ",", "validate_shape", "=", "False", ")", "\n", "", "return", "var", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.create_impl_config_variable": [[48, 54], ["tensorflow.get_variable", "tensorflow.constant_initializer", "core.dataset_ops.GetImplConfigContent"], "function", ["None"], ["", "def", "create_impl_config_variable", "(", ")", ":", "\n", "    ", "impl_config_variable", "=", "tf", ".", "get_variable", "(", "\n", "FLAGS", ".", "impl_config_variable_name", ",", "[", "]", ",", "dtype", "=", "tf", ".", "string", ",", "trainable", "=", "False", ",", "\n", "initializer", "=", "tf", ".", "constant_initializer", "(", "\n", "dataset_ops", ".", "GetImplConfigContent", "(", ")", ",", "dtype", "=", "tf", ".", "string", ")", ")", "\n", "return", "impl_config_variable", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.add_embedding_layer": [[56, 83], ["tensorflow.variable_scope", "mvke_ops._variable_on_cpu", "core.embedding_ops.embedding", "tensorflow.random_normal_initializer", "core.embedding_ops.embedding_impl", "Exception", "seed.decode", "seed.decode"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._variable_on_cpu"], ["", "def", "add_embedding_layer", "(", "features", ",", "feature_key", ",", "feature_config", ",", "seed", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "'embedding'", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "        ", "if", "FLAGS", ".", "use_impl_hash", ":", "\n", "            ", "if", "seed", "is", "None", ":", "\n", "                ", "raise", "Exception", "(", "\"seed is None in add_embedding_layer impl\"", ")", "\n", "", "feature_key_hash_name", "=", "\"%s/%s\"", "%", "(", "feature_key", ",", "seed", ".", "decode", "(", ")", ")", "\n", "", "else", ":", "\n", "            ", "feature_key_hash_name", "=", "feature_key", "\n", "", "bucket_size", "=", "feature_config", ".", "embedding", ".", "vocabulary_size", "\n", "output_size", "=", "feature_config", ".", "embedding", ".", "embedding_size", "\n", "w", "=", "_variable_on_cpu", "(", "\n", "feature_key_hash_name", ",", "[", "bucket_size", ",", "output_size", "]", ",", "\n", "tf", ".", "random_normal_initializer", "(", "stddev", "=", "0.01", ")", ")", "\n", "is_padding", "=", "feature_config", ".", "is_multi_value", "\n", "\n", "feature_weight_name", "=", "\"%s:weights\"", "%", "(", "feature_config", ".", "feature_name", ")", "\n", "feature_weight", "=", "None", "\n", "if", "feature_weight_name", "in", "features", ":", "\n", "            ", "feature_weight", "=", "features", "[", "feature_weight_name", "]", "\n", "\n", "", "if", "FLAGS", ".", "use_impl_hash", ":", "\n", "            ", "return", "embedding_ops", ".", "embedding_impl", "(", "\n", "w", ",", "features", "[", "feature_key", "]", ",", "feature_weight", ",", "\n", "padding", "=", "is_padding", ",", "seed", "=", "seed", ".", "decode", "(", ")", ")", "\n", "", "return", "embedding_ops", ".", "embedding", "(", "\n", "w", ",", "features", "[", "feature_key", "]", ",", "feature_weight", ",", "\n", "padding", "=", "is_padding", ",", "name", "=", "feature_key", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.process_impl_combiner": [[85, 101], ["core.impl_combiner_impl.Context", "combiner.ListFields", "tensorflow.python.platform.tf_logging.info", "str", "tensorflow.variable_scope", "getattr", "getattr.", "tensorflow.python.platform.tf_logging.warning", "str", "str"], "function", ["None"], ["", "", "def", "process_impl_combiner", "(", "feature_output", ",", "combiner", ",", "is_training", ")", ":", "\n", "    ", "context", "=", "impl_combiner_impl", ".", "Context", "(", ")", ";", "\n", "context", ".", "feature_output", "=", "feature_output", "\n", "context", ".", "is_training", "=", "is_training", "\n", "for", "m", "in", "combiner", ".", "ListFields", "(", ")", ":", "\n", "        ", "tf_logging", ".", "info", "(", "'impl_combiner, member:%s'", "%", "(", "str", "(", "m", "[", "0", "]", ".", "name", ")", ")", ")", "\n", "method", "=", "None", "\n", "try", ":", "\n", "            ", "with", "tf", ".", "variable_scope", "(", "m", "[", "0", "]", ".", "name", ")", ":", "\n", "                ", "method", "=", "getattr", "(", "impl_combiner_impl", ",", "m", "[", "0", "]", ".", "name", ")", "\n", "context", ".", "param", "=", "m", "[", "1", "]", "\n", "return", "method", "(", "context", ")", "\n", "", "", "except", "AttributeError", "as", "e", ":", "\n", "            ", "tf_logging", ".", "warning", "(", "'impl_combiner method:%s error:%s'", "%", "\n", "(", "str", "(", "m", "[", "0", "]", ".", "name", ")", ",", "str", "(", "e", ")", ")", ")", "\n", "", "", "return", "None", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.process_impl_layer": [[103, 123], ["core.impl_layer_impl.Context", "layer.ListFields", "tensorflow.python.platform.tf_logging.info", "tensorflow.variable_scope", "getattr", "getattr.", "tensorflow.python.platform.tf_logging.warning", "str", "str", "str", "str"], "function", ["None"], ["", "def", "process_impl_layer", "(", "input", ",", "layout", ",", "layer_name", ",", "layer", ",", "is_training", ",", "features", "=", "None", ")", ":", "\n", "    ", "context", "=", "impl_layer_impl", ".", "Context", "(", ")", "\n", "context", ".", "input", "=", "input", "\n", "context", ".", "layout", "=", "layout", "\n", "context", ".", "is_training", "=", "is_training", "\n", "context", ".", "features", "=", "features", "\n", "context", ".", "layer_name", "=", "layer_name", "\n", "for", "m", "in", "layer", ".", "ListFields", "(", ")", ":", "\n", "        ", "tf_logging", ".", "info", "(", "'feature_name:%s, member:%s, layout:%s'", "%", "\n", "(", "layer_name", ",", "str", "(", "m", "[", "0", "]", ".", "name", ")", ",", "str", "(", "layout", ")", ")", ")", "\n", "method", "=", "None", "\n", "try", ":", "\n", "            ", "with", "tf", ".", "variable_scope", "(", "m", "[", "0", "]", ".", "name", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "                ", "method", "=", "getattr", "(", "impl_layer_impl", ",", "m", "[", "0", "]", ".", "name", ")", "\n", "context", ".", "param", "=", "m", "[", "1", "]", "\n", "return", "method", "(", "context", ")", "\n", "", "", "except", "AttributeError", "as", "e", ":", "\n", "            ", "tf_logging", ".", "warning", "(", "'feature:%s, method:%s error:%s'", "%", "\n", "(", "layer_name", ",", "str", "(", "m", "[", "0", "]", ".", "name", ")", ",", "str", "(", "e", ")", ")", ")", "\n", "", "", "return", "layout", ",", "input", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.process_feature_input": [[125, 156], ["features.items", "tensorflow.python.platform.tf_logging.info", "feature_config.HasField", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.python.platform.tf_logging.fatal", "feature_inputs.setdefault", "feature_inputs.setdefault", "feature_inputs[].append", "feature_config.HasField", "feature_inputs[].append", "feature_inputs[].append", "mvke_ops.add_embedding_layer", "mvke_ops.add_embedding_layer"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.add_embedding_layer", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.add_embedding_layer"], ["", "def", "process_feature_input", "(", "features_config", ",", "features", ",", "field_name", ")", ":", "\n", "    ", "feature_inputs", "=", "{", "}", "\n", "local_feature_config", "=", "{", "}", "\n", "for", "feature_key", ",", "feature_value", "in", "features", ".", "items", "(", ")", ":", "\n", "        ", "if", "feature_value", "is", "None", ":", "\n", "            ", "tf_logging", ".", "fatal", "(", "\"feature_value %s is None. Quit\"", "%", "feature_key", ")", "\n", "\n", "", "feature_config", "=", "features_config", "[", "feature_key", "]", "\n", "if", "field_name", "not", "in", "feature_config", ".", "field", ":", "\n", "            ", "continue", "\n", "", "if", "feature_config", ".", "is_weight_feature", ":", "\n", "            ", "continue", "\n", "", "tf_logging", ".", "info", "(", "'process feature: %s'", "%", "feature_key", ")", "\n", "if", "feature_config", ".", "type", "==", "ImplConfig", ".", "Feature", ".", "BYTES", ":", "\n", "            ", "tf_logging", ".", "fatal", "(", "\"bytes feature %s is not support\"", "%", "feature_key", ")", "\n", "", "feature_name", "=", "feature_config", ".", "feature_name", "\n", "if", "feature_config", ".", "HasField", "(", "'embedding'", ")", ":", "\n", "            ", "feature_inputs", ".", "setdefault", "(", "feature_name", ",", "[", "]", ")", "\n", "if", "FLAGS", ".", "use_impl_hash", "and", "feature_config", ".", "HasField", "(", "'bucketing'", ")", ":", "\n", "                ", "for", "seed", "in", "feature_config", ".", "bucketing", ".", "seeds", ":", "\n", "                    ", "feature_inputs", "[", "feature_name", "]", ".", "append", "(", "\n", "add_embedding_layer", "(", "features", ",", "feature_key", ",", "feature_config", ",", "seed", "=", "seed", ")", ")", "\n", "", "", "else", ":", "\n", "                ", "feature_inputs", "[", "feature_name", "]", ".", "append", "(", "\n", "add_embedding_layer", "(", "features", ",", "feature_key", ",", "feature_config", ")", ")", "\n", "", "local_feature_config", "[", "feature_name", "]", "=", "feature_config", "\n", "", "else", ":", "\n", "            ", "feature_inputs", ".", "setdefault", "(", "feature_name", ",", "[", "]", ")", "\n", "feature_inputs", "[", "feature_name", "]", ".", "append", "(", "features", "[", "feature_key", "]", ")", "\n", "local_feature_config", "[", "feature_name", "]", "=", "feature_config", "\n", "", "", "return", "feature_inputs", ",", "local_feature_config", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.process_feature_layers": [[157, 201], ["feature_inputs.items", "feature_config.HasField", "len", "tensorflow.stack", "tensorflow.reshape", "feature_config.HasField", "feature_output.setdefault", "tensorflow.python.platform.tf_logging.info", "tensorflow.shape", "enumerate", "FeatureOutputItem", "tensorflow.variable_scope", "mvke_ops.process_impl_layer", "str"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_layer"], ["", "def", "process_feature_layers", "(", "feature_inputs", ",", "features", ",", "\n", "local_feature_config", ",", "is_training", ",", "custom_scope", "=", "None", ")", ":", "\n", "    ", "class", "FeatureOutputItem", ":", "\n", "        ", "pass", "\n", "", "feature_output", "=", "{", "}", "\n", "for", "feature_name", ",", "input_values", "in", "feature_inputs", ".", "items", "(", ")", ":", "\n", "        ", "feature_config", "=", "local_feature_config", "[", "feature_name", "]", "\n", "feature_dimension", "=", "None", "\n", "if", "not", "feature_config", ".", "is_multi_value", ":", "\n", "            ", "if", "feature_config", ".", "feature_dimension", "!=", "0", ":", "\n", "                ", "feature_dimension", "=", "feature_config", ".", "feature_dimension", "\n", "", "else", ":", "\n", "                ", "feature_dimension", "=", "1", "\n", "", "", "embed_size", "=", "1", "\n", "if", "feature_config", ".", "HasField", "(", "'embedding'", ")", ":", "\n", "            ", "embed_size", "=", "feature_config", ".", "embedding", ".", "embedding_size", "\n", "", "seed_num", "=", "len", "(", "input_values", ")", "\n", "# Construct feature tensor, Reshape to", "\n", "# [BatchSize, FeatureDimension, EmbeddingSize, SeedNum]", "\n", "feature_tensor", "=", "tf", ".", "stack", "(", "input_values", ",", "-", "1", ")", "\n", "batch_size", "=", "tf", ".", "shape", "(", "feature_tensor", ")", "[", "0", "]", "\n", "shape", "=", "[", "batch_size", ",", "-", "1", ",", "embed_size", ",", "seed_num", "]", "\n", "feature_tensor", "=", "tf", ".", "reshape", "(", "feature_tensor", ",", "shape", ")", "\n", "# Process Feature Layers", "\n", "layer_output", "=", "feature_tensor", "\n", "layout", "=", "[", "None", ",", "feature_dimension", ",", "embed_size", ",", "seed_num", "]", "\n", "if", "feature_config", ".", "HasField", "(", "'feature_layer'", ")", ":", "\n", "            ", "for", "i", ",", "layer", "in", "enumerate", "(", "feature_config", ".", "feature_layer", ".", "layer", ")", ":", "\n", "                ", "scope_name", "=", "feature_config", ".", "feature_name", "\n", "if", "custom_scope", "is", "not", "None", ":", "\n", "                    ", "scope_name", "==", "custom_scope", "+", "\"_\"", "+", "scope_name", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"%s/feature_layer_%d\"", "%", "\n", "(", "scope_name", ",", "i", ")", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "                    ", "layout", ",", "layer_output", "=", "process_impl_layer", "(", "\n", "layer_output", ",", "layout", ",", "feature_config", ".", "feature_name", ",", "\n", "layer", ",", "is_training", ",", "features", ")", "\n", "", "", "", "feature_output", ".", "setdefault", "(", "feature_name", ",", "FeatureOutputItem", "(", ")", ")", "\n", "feature_output", "[", "feature_name", "]", ".", "output", "=", "layer_output", "\n", "# feature_output[feature_name].input = feature_tensor", "\n", "feature_output", "[", "feature_name", "]", ".", "layout", "=", "layout", "\n", "feature_output", "[", "feature_name", "]", ".", "name", "=", "feature_name", "\n", "tf_logging", ".", "info", "(", "\"feature_name: %s, layout: %s\"", "%", "\n", "(", "feature_name", ",", "str", "(", "layout", ")", ")", ")", "\n", "", "return", "feature_output", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.vkg_layer": [[202, 218], ["tensorflow.variable_scope", "tensorflow.transpose", "tensorflow.matmul", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.nn.softmax", "tensorflow.matmul"], "function", ["None"], ["", "def", "vkg_layer", "(", "tag_emb", ",", "vk_emb", ",", "vke_outputs", ")", ":", "\n", "# tag_emb: [bz, emb_size] # vk_emb: [vk_num, emb_size] # vke_outputs: [bz, vk_num, emb_size]", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "\"vkg\"", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "        ", "vk_num", "=", "vk_emb", ".", "shape", "[", "0", "]", "\n", "emb_size", "=", "vk_emb", ".", "shape", "[", "1", "]", "\n", "\n", "# vk_emb = tf.layers.dense(vk_emb, emb_size, name=\"vk_emb_proj\", ", "\n", "#     kernel_initializer=tf.random_normal_initializer(stddev=0.01))", "\n", "\n", "vk_emb_trans", "=", "tf", ".", "transpose", "(", "vk_emb", ",", "[", "1", ",", "0", "]", ")", "# [emb_size, vk_num]", "\n", "dot_out", "=", "tf", ".", "matmul", "(", "tag_emb", ",", "vk_emb_trans", ")", "# [bz, vk_num]", "\n", "weights", "=", "tf", ".", "reshape", "(", "tf", ".", "nn", ".", "softmax", "(", "dot_out", ",", "1", ")", ",", "[", "-", "1", ",", "1", ",", "vk_num", "]", ")", "# [bz, 1, vk_num]", "\n", "\n", "layer_output", "=", "tf", ".", "reshape", "(", "tf", ".", "matmul", "(", "weights", ",", "vke_outputs", ")", ",", "[", "-", "1", ",", "emb_size", "]", ")", "# [bz, emb_size]", "\n", "\n", "", "return", "layer_output", ",", "tf", ".", "reshape", "(", "weights", ",", "[", "-", "1", ",", "vk_num", "]", ")", "# [bz, emb_size]", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.mvke_bottom_layer": [[219, 250], ["tensorflow.variable_scope", "tensorflow.layers.dense", "tensorflow.reshape", "tensorflow.layers.dense", "tensorflow.layers.dense", "tensorflow.transpose", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.tile", "tensorflow.contrib.layers.layer_norm", "tensorflow.nn.softmax", "tensorflow.random_normal_initializer", "tensorflow.random_normal_initializer", "tensorflow.random_normal_initializer", "tensorflow.matmul", "math.sqrt", "tensorflow.tile", "tensorflow.reshape", "int"], "function", ["None"], ["", "def", "mvke_bottom_layer", "(", "vk_emb", ",", "shared_field_embs", ")", ":", "\n", "# vk_emb: [vk_num, emb_size] # shared_field_embs: [bz, feature_num, emb_size] ", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "\"mvke_bottom\"", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "        ", "vk_num", "=", "vk_emb", ".", "shape", "[", "0", "]", "\n", "emb_size", "=", "vk_emb", ".", "shape", "[", "1", "]", "\n", "feature_num", "=", "shared_field_embs", ".", "shape", "[", "1", "]", "\n", "\n", "query", "=", "tf", ".", "layers", ".", "dense", "(", "vk_emb", ",", "emb_size", ",", "name", "=", "\"query_proj\"", ",", "\n", "kernel_initializer", "=", "tf", ".", "random_normal_initializer", "(", "stddev", "=", "0.01", ")", ")", "\n", "\n", "reshaped_shared_field_embs", "=", "tf", ".", "reshape", "(", "shared_field_embs", ",", "[", "-", "1", ",", "emb_size", "]", ")", "\n", "\n", "key", "=", "tf", ".", "layers", ".", "dense", "(", "reshaped_shared_field_embs", ",", "emb_size", ",", "name", "=", "\"key_proj\"", ",", "\n", "kernel_initializer", "=", "tf", ".", "random_normal_initializer", "(", "stddev", "=", "0.01", ")", ")", "\n", "\n", "value", "=", "tf", ".", "layers", ".", "dense", "(", "reshaped_shared_field_embs", ",", "emb_size", ",", "name", "=", "\"value_proj\"", ",", "\n", "kernel_initializer", "=", "tf", ".", "random_normal_initializer", "(", "stddev", "=", "0.01", ")", ")", "\n", "\n", "query_trans", "=", "tf", ".", "transpose", "(", "query", ",", "[", "1", ",", "0", "]", ")", "# [emb_size, vk_num]", "\n", "dot_out", "=", "tf", ".", "reshape", "(", "tf", ".", "matmul", "(", "key", ",", "query_trans", ")", "/", "math", ".", "sqrt", "(", "1.0", "*", "int", "(", "emb_size", ")", ")", ",", "[", "-", "1", ",", "feature_num", ",", "vk_num", "]", ")", "# [bz, feature_num, vk_num]", "\n", "weights", "=", "tf", ".", "reshape", "(", "tf", ".", "nn", ".", "softmax", "(", "dot_out", ",", "1", ")", ",", "[", "-", "1", ",", "feature_num", ",", "vk_num", ",", "1", "]", ")", "# [bz, feature_num, vk_num, 1]", "\n", "\n", "value", "=", "tf", ".", "reshape", "(", "value", ",", "[", "-", "1", ",", "feature_num", ",", "1", ",", "emb_size", "]", ")", "# [-1, feature_num, 1, emb_size]", "\n", "value_expand", "=", "tf", ".", "tile", "(", "value", ",", "[", "1", ",", "1", ",", "vk_num", ",", "1", "]", ")", "# [bz, feature_num, vk_num, emb_size]", "\n", "layer_output", "=", "weights", "*", "value_expand", "\n", "\n", "layer_output", "=", "tf", ".", "contrib", ".", "layers", ".", "layer_norm", "(", "\n", "layer_output", "+", "tf", ".", "tile", "(", "tf", ".", "reshape", "(", "shared_field_embs", ",", "[", "-", "1", ",", "feature_num", ",", "1", ",", "emb_size", "]", ")", ",", "[", "1", ",", "1", ",", "vk_num", ",", "1", "]", ")", ",", "\n", "begin_norm_axis", "=", "-", "1", ",", "begin_params_axis", "=", "-", "1", ")", "\n", "\n", "", "return", "layer_output", "# [bz, feature_num, vk_num, emb_size]", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._build_mvke_layers": [[251, 307], ["mvke_ops.process_impl_combiner", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.variable_scope", "mvke_ops._variable_on_cpu", "mvke_ops.mvke_bottom_layer", "tensorflow.reshape", "tensorflow.random_normal_initializer", "tensorflow.reshape", "enumerate", "range", "tensorflow.stack", "tensorflow.gather", "tensorflow.gather", "mvke_ops.vkg_layer", "tensorflow.reshape", "tensorflow.transpose", "tensorflow.reshape", "enumerate", "layer_output_all.append", "tensorflow.variable_scope", "mvke_ops.process_impl_layer", "tensorflow.gather", "tensorflow.expand_dims", "range", "tensorflow.variable_scope", "mvke_ops.process_impl_layer"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_combiner", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._variable_on_cpu", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.mvke_bottom_layer", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.vkg_layer", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_layer", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_layer"], ["", "def", "_build_mvke_layers", "(", "fields_config", ",", "field_name", ",", "features", ",", "feature_output", ",", "is_training", ",", "\n", "tag_key", ",", "shared_model", "=", "False", ",", "vke_num", "=", "10", ",", "obj_config", "=", "{", "'pctr'", ":", "[", "0", ",", "5", "]", ",", "'pcvr'", ":", "[", "2", ",", "9", "]", "}", ")", ":", "\n", "\n", "    ", "if", "not", "field_name", "in", "fields_config", ":", "\n", "        ", "tf_logging", ".", "fatal", "(", "\"field_name: %s can not find config\"", "%", "field_name", ")", "\n", "", "field_config", "=", "fields_config", "[", "field_name", "]", "\n", "\n", "layer_output", ",", "layout", "=", "process_impl_combiner", "(", "\n", "feature_output", ",", "field_config", ".", "combiner", ",", "is_training", ")", "\n", "feature_num", "=", "layout", "[", "1", "]", "\n", "emb_size", "=", "layout", "[", "2", "]", "\n", "with", "tf", ".", "variable_scope", "(", "\"mvke_\"", "+", "field_name", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "# [vke_num, emb_size]", "\n", "        ", "vk", "=", "_variable_on_cpu", "(", "\n", "\"virtual_cluster\"", ",", "[", "vke_num", ",", "emb_size", "]", ",", "\n", "tf", ".", "random_normal_initializer", "(", "stddev", "=", "0.01", ")", ")", "\n", "mvke_bottom_out", "=", "mvke_bottom_layer", "(", "vk", ",", "layer_output", ")", "# [bz, feature_num, vk_num, emb_size]", "\n", "\n", "# share the same model in mvke", "\n", "if", "shared_model", ":", "\n", "            ", "layer_output", "=", "tf", ".", "reshape", "(", "tf", ".", "transpose", "(", "mvke_bottom_out", ",", "[", "0", ",", "2", ",", "1", ",", "3", "]", ")", ",", "[", "-", "1", ",", "feature_num", ",", "emb_size", "]", ")", "# [bz*vke_num, feature_num, emb_size]", "\n", "for", "i", ",", "layer", "in", "enumerate", "(", "field_config", ".", "field_layer", ".", "layer", ")", ":", "\n", "                ", "with", "tf", ".", "variable_scope", "(", "\"field_layer_%d\"", "%", "i", ")", ":", "\n", "                    ", "layout", ",", "layer_output", "=", "process_impl_layer", "(", "\n", "layer_output", ",", "layout", ",", "field_name", ",", "layer", ",", "\n", "is_training", ",", "features", ")", "# [bz*vke_num, emb_size]", "\n", "", "", "", "else", ":", "\n", "            ", "layer_output_all", "=", "[", "]", "\n", "for", "vke_idx", "in", "range", "(", "vke_num", ")", ":", "\n", "                ", "layer_output", "=", "tf", ".", "reshape", "(", "tf", ".", "gather", "(", "mvke_bottom_out", ",", "vke_idx", ",", "axis", "=", "2", ")", ",", "[", "-", "1", ",", "feature_num", ",", "emb_size", "]", ")", "# [bz, feature_num, emb_size]", "\n", "in_layout", "=", "layout", "\n", "for", "i", ",", "layer", "in", "enumerate", "(", "field_config", ".", "field_layer", ".", "layer", ")", ":", "\n", "                    ", "with", "tf", ".", "variable_scope", "(", "\"vke_{}_field_layer_{}\"", ".", "format", "(", "vke_idx", ",", "i", ")", ")", ":", "\n", "                        ", "in_layout", ",", "layer_output", "=", "process_impl_layer", "(", "\n", "layer_output", ",", "in_layout", ",", "field_name", ",", "layer", ",", "\n", "is_training", ",", "features", ")", "\n", "", "", "layer_output_all", ".", "append", "(", "tf", ".", "expand_dims", "(", "layer_output", ",", "1", ")", ")", "\n", "", "layer_output", "=", "tf", ".", "stack", "(", "layer_output_all", ",", "1", ")", "# [bz, vke_num, emb_size]", "\n", "\n", "", "layer_output", "=", "tf", ".", "reshape", "(", "layer_output", ",", "[", "-", "1", ",", "vke_num", ",", "emb_size", "]", ")", "\n", "final_layer", "=", "{", "}", "\n", "vke_weights", "=", "{", "}", "\n", "vke_outputs", "=", "{", "}", "\n", "for", "key", "in", "tag_key", ":", "\n", "            ", "tag_emb", "=", "tag_key", "[", "key", "]", "\n", "select_begin", ",", "select_end", "=", "obj_config", "[", "key", "]", "\n", "select_index", "=", "[", "i", "for", "i", "in", "range", "(", "select_begin", ",", "select_end", "+", "1", ")", "]", "\n", "select_vk_emb", "=", "tf", ".", "gather", "(", "vk", ",", "select_index", ",", "axis", "=", "0", ")", "# to-check", "\n", "select_layer_output", "=", "tf", ".", "gather", "(", "layer_output", ",", "select_index", ",", "axis", "=", "1", ")", "# to-check", "\n", "layer_out", ",", "vke_weight", "=", "vkg_layer", "(", "tag_emb", ",", "select_vk_emb", ",", "select_layer_output", ")", "# [bz, emb_size]", "\n", "\n", "final_layer", "[", "key", "]", "=", "layer_out", "\n", "vke_weights", "[", "key", "]", "=", "vke_weight", "\n", "vke_outputs", "[", "key", "]", "=", "tf", ".", "reshape", "(", "select_layer_output", ",", "[", "-", "1", ",", "(", "select_end", "-", "select_begin", "+", "1", ")", "*", "emb_size", "]", ")", "\n", "\n", "", "", "return", "final_layer", ",", "vke_weights", ",", "vke_outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._build_mvke": [[308, 319], ["mvke_ops.process_feature_input", "mvke_ops.process_feature_layers", "mvke_ops._build_mvke_layers"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_input", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_layers", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._build_mvke_layers"], ["", "def", "_build_mvke", "(", "impl_config", ",", "features", ",", "field_name", ",", "is_training", ",", "tag_key", ",", "shared_model", ",", "vke_num", ",", "obj_config", ")", ":", "\n", "    ", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "feature_inputs", ",", "local_feature_config", "=", "process_feature_input", "(", "\n", "features_config", ",", "features", ",", "field_name", ")", "\n", "feature_output", "=", "process_feature_layers", "(", "\n", "feature_inputs", ",", "features", ",", "local_feature_config", ",", "is_training", ")", "\n", "layer_output", "=", "_build_mvke_layers", "(", "\n", "fields_config", ",", "field_name", ",", "features", ",", "feature_output", ",", "\n", "is_training", ",", "tag_key", ",", "shared_model", ",", "vke_num", ",", "obj_config", ")", "\n", "\n", "return", "layer_output", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mvke": [[320, 330], ["features.keys", "mvke_ops._build_mvke"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._build_mvke"], ["", "def", "build_mvke", "(", "impl_config", ",", "features", ",", "field_name", ",", "is_training", ",", "tag_key", ",", "shared_model", ",", "vke_num", ",", "obj_config", ")", ":", "\n", "    ", "\"\"\"Build mvke for user\"\"\"", "\n", "feature_config", ",", "_", ",", "_", "=", "impl_config", "\n", "field_features", "=", "{", "}", "\n", "for", "feature_name", "in", "features", ".", "keys", "(", ")", ":", "\n", "        ", "if", "field_name", "in", "feature_config", "[", "feature_name", "]", ".", "field", ":", "\n", "            ", "field_features", "[", "feature_name", "]", "=", "features", "[", "feature_name", "]", "\n", "\n", "", "", "return", "_build_mvke", "(", "impl_config", ",", "field_features", ",", "field_name", ",", "\n", "is_training", ",", "tag_key", ",", "shared_model", ",", "vke_num", ",", "obj_config", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.mmoe_gate_layer": [[332, 346], ["tensorflow.reshape", "tensorflow.variable_scope", "tensorflow.layers.dense", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.nn.softmax", "tensorflow.matmul", "tensorflow.random_normal_initializer"], "function", ["None"], ["", "def", "mmoe_gate_layer", "(", "inputs", ",", "expert_num", ",", "expert_outputs", ",", "task_name", ")", ":", "\n", "# inputs: [bz, feature_num, emb_size] expert_outputs: [bz, expert_num, out_size]", "\n", "    ", "feature_num", "=", "inputs", ".", "shape", "[", "1", "]", "\n", "emb_size", "=", "inputs", ".", "shape", "[", "2", "]", "\n", "out_size", "=", "expert_outputs", ".", "shape", "[", "2", "]", "\n", "if", "expert_num", "==", "1", ":", "\n", "        ", "return", "tf", ".", "reshape", "(", "expert_outputs", ",", "[", "-", "1", ",", "out_size", "]", ")", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"mmoe_gates_\"", "+", "task_name", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "        ", "weights", "=", "tf", ".", "layers", ".", "dense", "(", "tf", ".", "reshape", "(", "inputs", ",", "[", "-", "1", ",", "feature_num", "*", "emb_size", "]", ")", ",", "expert_num", ",", "name", "=", "\"input_gate_dense\"", ",", "\n", "kernel_initializer", "=", "tf", ".", "random_normal_initializer", "(", "stddev", "=", "0.01", ")", ")", "# [bz, expert_num]", "\n", "weights", "=", "tf", ".", "reshape", "(", "tf", ".", "nn", ".", "softmax", "(", "weights", ",", "1", ")", ",", "[", "-", "1", ",", "1", ",", "expert_num", "]", ")", "# [bz, 1, expert_num]", "\n", "\n", "layer_output", "=", "tf", ".", "reshape", "(", "tf", ".", "matmul", "(", "weights", ",", "expert_outputs", ")", ",", "[", "-", "1", ",", "out_size", "]", ")", "# [bz, out_size]", "\n", "", "return", "layer_output", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._build_mmoe_layers": [[347, 381], ["mvke_ops.process_impl_combiner", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.variable_scope", "range", "tensorflow.stack", "enumerate", "expert_output_all.append", "tensorflow.gather", "mvke_ops.mmoe_gate_layer", "tensorflow.variable_scope", "mvke_ops.process_impl_layer", "range"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_combiner", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.mmoe_gate_layer", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_layer"], ["", "def", "_build_mmoe_layers", "(", "fields_config", ",", "field_name", ",", "features", ",", "feature_output", ",", "is_training", ",", "\n", "expert_num", "=", "10", ",", "obj_config", "=", "{", "'pctr'", ":", "[", "0", ",", "0", "]", ",", "'pcvr'", ":", "[", "1", ",", "1", "]", "}", ")", ":", "\n", "\n", "    ", "if", "not", "field_name", "in", "fields_config", ":", "\n", "        ", "tf_logging", ".", "fatal", "(", "\"field_name: %s can not find config\"", "%", "field_name", ")", "\n", "", "field_config", "=", "fields_config", "[", "field_name", "]", "\n", "\n", "layer_output", ",", "layout", "=", "process_impl_combiner", "(", "\n", "feature_output", ",", "field_config", ".", "combiner", ",", "is_training", ")", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "\"mmoe_\"", "+", "field_name", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "# experts", "\n", "        ", "expert_output_all", "=", "[", "]", "\n", "for", "vke_idx", "in", "range", "(", "expert_num", ")", ":", "\n", "            ", "expert_output", "=", "layer_output", "\n", "expert_layout", "=", "layout", "\n", "for", "i", ",", "layer", "in", "enumerate", "(", "field_config", ".", "field_layer", ".", "layer", ")", ":", "\n", "                ", "with", "tf", ".", "variable_scope", "(", "\"expert_{}_field_layer_{}\"", ".", "format", "(", "vke_idx", ",", "i", ")", ")", ":", "\n", "                    ", "expert_layout", ",", "expert_output", "=", "process_impl_layer", "(", "\n", "expert_output", ",", "expert_layout", ",", "field_name", ",", "layer", ",", "\n", "is_training", ",", "features", ")", "\n", "", "", "expert_output_all", ".", "append", "(", "expert_output", ")", "# [bz, emb_size]", "\n", "", "expert_output", "=", "tf", ".", "stack", "(", "expert_output_all", ",", "1", ")", "# [bz, vke_num, emb_size]", "\n", "\n", "# task gates", "\n", "final_layer", "=", "{", "}", "\n", "for", "key", "in", "obj_config", ":", "\n", "            ", "select_begin", ",", "select_end", "=", "obj_config", "[", "key", "]", "\n", "select_index", "=", "[", "i", "for", "i", "in", "range", "(", "select_begin", ",", "select_end", "+", "1", ")", "]", "\n", "select_expert_output", "=", "tf", ".", "gather", "(", "expert_output", ",", "select_index", ",", "axis", "=", "1", ")", "# to-check", "\n", "final_layer", "[", "key", "]", "=", "mmoe_gate_layer", "(", "layer_output", ",", "select_end", "-", "select_begin", "+", "1", ",", "\n", "select_expert_output", ",", "key", ")", "# [bz, emb_size]", "\n", "\n", "", "", "return", "final_layer", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._build_mmoe": [[382, 393], ["mvke_ops.process_feature_input", "mvke_ops.process_feature_layers", "mvke_ops._build_mmoe_layers"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_input", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_layers", "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._build_mmoe_layers"], ["", "def", "_build_mmoe", "(", "impl_config", ",", "features", ",", "field_name", ",", "is_training", ",", "expert_num", ",", "obj_config", ")", ":", "\n", "    ", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "feature_inputs", ",", "local_feature_config", "=", "process_feature_input", "(", "\n", "features_config", ",", "features", ",", "field_name", ")", "\n", "feature_output", "=", "process_feature_layers", "(", "\n", "feature_inputs", ",", "features", ",", "local_feature_config", ",", "is_training", ")", "\n", "layer_output", "=", "_build_mmoe_layers", "(", "\n", "fields_config", ",", "field_name", ",", "features", ",", "feature_output", ",", "\n", "is_training", ",", "expert_num", ",", "obj_config", ")", "\n", "\n", "return", "layer_output", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops.build_mmoe": [[395, 404], ["features.keys", "mvke_ops._build_mmoe"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.mvke_ops._build_mmoe"], ["", "def", "build_mmoe", "(", "impl_config", ",", "features", ",", "field_name", ",", "is_training", ",", "expert_num", ",", "obj_config", ")", ":", "\n", "    ", "\"\"\"Build mmoe module\"\"\"", "\n", "feature_config", ",", "_", ",", "_", "=", "impl_config", "\n", "field_features", "=", "{", "}", "\n", "for", "feature_name", "in", "features", ".", "keys", "(", ")", ":", "\n", "        ", "if", "field_name", "in", "feature_config", "[", "feature_name", "]", ".", "field", ":", "\n", "            ", "field_features", "[", "feature_name", "]", "=", "features", "[", "feature_name", "]", "\n", "\n", "", "", "return", "_build_mmoe", "(", "impl_config", ",", "features", ",", "field_name", ",", "is_training", ",", "expert_num", ",", "obj_config", ")", "\n", "", ""]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._variable_on_cpu": [[21, 34], ["tensorflow.device", "tensorflow.get_variable"], "function", ["None"], ["def", "_variable_on_cpu", "(", "name", ",", "shape", ",", "initializer", ")", ":", "\n", "    ", "\"\"\"Helper to create a Variable stored on CPU memory.\n      Args:\n        name: name of the variable\n        shape: list of ints\n        initializer: initializer for Variable\n      Returns:\n        Variable Tensor\n    \"\"\"", "\n", "with", "tf", ".", "device", "(", "'/gpu:0'", ")", ":", "\n", "        ", "var", "=", "tf", ".", "get_variable", "(", "\n", "name", ",", "shape", ",", "initializer", "=", "initializer", ")", "\n", "", "return", "var", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._variable_on_cpu_var": [[35, 48], ["tensorflow.device", "tensorflow.get_variable"], "function", ["None"], ["", "def", "_variable_on_cpu_var", "(", "name", ",", "shape", ",", "initializer", ")", ":", "\n", "    ", "\"\"\"Helper to create a Variable stored on CPU memory.\n      Args:\n        name: name of the variable\n        shape: list of ints\n        initializer: initializer for Variable\n      Returns:\n        Variable Tensor\n    \"\"\"", "\n", "with", "tf", ".", "device", "(", "'/gpu:0'", ")", ":", "\n", "        ", "var", "=", "tf", ".", "get_variable", "(", "\n", "name", ",", "shape", ",", "initializer", "=", "initializer", ",", "validate_shape", "=", "False", ")", "\n", "", "return", "var", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.create_impl_config_variable": [[50, 56], ["tensorflow.get_variable", "tensorflow.constant_initializer", "core.dataset_ops.GetImplConfigContent"], "function", ["None"], ["", "def", "create_impl_config_variable", "(", ")", ":", "\n", "    ", "impl_config_variable", "=", "tf", ".", "get_variable", "(", "\n", "FLAGS", ".", "impl_config_variable_name", ",", "[", "]", ",", "dtype", "=", "tf", ".", "string", ",", "trainable", "=", "False", ",", "\n", "initializer", "=", "tf", ".", "constant_initializer", "(", "\n", "dataset_ops", ".", "GetImplConfigContent", "(", ")", ",", "dtype", "=", "tf", ".", "string", ")", ")", "\n", "return", "impl_config_variable", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.add_embedding_layer": [[58, 86], ["tensorflow.variable_scope", "model_ops._variable_on_cpu", "core.embedding_ops.embedding", "tensorflow.random_normal_initializer", "core.embedding_ops.embedding_impl", "Exception", "seed.decode", "seed.decode"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._variable_on_cpu"], ["", "def", "add_embedding_layer", "(", "features", ",", "feature_key", ",", "feature_config", ",", "seed", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "'embedding'", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "        ", "if", "FLAGS", ".", "use_impl_hash", ":", "\n", "            ", "if", "seed", "is", "None", ":", "\n", "                ", "raise", "Exception", "(", "\"seed is None in add_embedding_layer impl\"", ")", "\n", "", "feature_key_hash_name", "=", "\"%s/%s\"", "%", "(", "feature_key", ",", "seed", ".", "decode", "(", ")", ")", "\n", "", "else", ":", "\n", "            ", "feature_key_hash_name", "=", "feature_key", "\n", "", "bucket_size", "=", "feature_config", ".", "embedding", ".", "vocabulary_size", "\n", "output_size", "=", "feature_config", ".", "embedding", ".", "embedding_size", "\n", "w", "=", "_variable_on_cpu", "(", "\n", "feature_key_hash_name", ",", "[", "bucket_size", ",", "output_size", "]", ",", "\n", "tf", ".", "random_normal_initializer", "(", "stddev", "=", "0.01", ")", ")", "\n", "is_padding", "=", "feature_config", ".", "is_multi_value", "\n", "\n", "feature_weight_name", "=", "\"%s:weights\"", "%", "(", "feature_config", ".", "feature_name", ")", "\n", "feature_weight", "=", "None", "\n", "if", "feature_weight_name", "in", "features", ":", "\n", "            ", "feature_weight", "=", "features", "[", "feature_weight_name", "]", "\n", "\n", "", "if", "FLAGS", ".", "use_impl_hash", ":", "\n", "            ", "return", "embedding_ops", ".", "embedding_impl", "(", "\n", "w", ",", "features", "[", "feature_key", "]", ",", "feature_weight", ",", "\n", "padding", "=", "is_padding", ",", "seed", "=", "seed", ".", "decode", "(", ")", ")", "\n", "\n", "", "return", "embedding_ops", ".", "embedding", "(", "\n", "w", ",", "features", "[", "feature_key", "]", ",", "feature_weight", ",", "\n", "padding", "=", "is_padding", ",", "name", "=", "feature_key", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_combiner": [[88, 104], ["core.impl_combiner_impl.Context", "combiner.ListFields", "tensorflow.python.platform.tf_logging.info", "str", "tensorflow.variable_scope", "getattr", "getattr.", "tensorflow.python.platform.tf_logging.warning", "str", "str"], "function", ["None"], ["", "", "def", "process_impl_combiner", "(", "feature_output", ",", "combiner", ",", "is_training", ")", ":", "\n", "    ", "context", "=", "impl_combiner_impl", ".", "Context", "(", ")", "\n", "context", ".", "feature_output", "=", "feature_output", "\n", "context", ".", "is_training", "=", "is_training", "\n", "for", "m", "in", "combiner", ".", "ListFields", "(", ")", ":", "\n", "        ", "tf_logging", ".", "info", "(", "'impl_combiner, member:%s'", "%", "(", "str", "(", "m", "[", "0", "]", ".", "name", ")", ")", ")", "\n", "method", "=", "None", "\n", "try", ":", "\n", "            ", "with", "tf", ".", "variable_scope", "(", "m", "[", "0", "]", ".", "name", ")", ":", "\n", "                ", "method", "=", "getattr", "(", "impl_combiner_impl", ",", "m", "[", "0", "]", ".", "name", ")", "\n", "context", ".", "param", "=", "m", "[", "1", "]", "\n", "return", "method", "(", "context", ")", "\n", "", "", "except", "AttributeError", "as", "e", ":", "\n", "            ", "tf_logging", ".", "warning", "(", "'impl_combiner method:%s error:%s'", "%", "\n", "(", "str", "(", "m", "[", "0", "]", ".", "name", ")", ",", "str", "(", "e", ")", ")", ")", "\n", "", "", "return", "None", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_layer": [[106, 126], ["core.impl_layer_impl.Context", "layer.ListFields", "tensorflow.python.platform.tf_logging.info", "tensorflow.variable_scope", "getattr", "getattr.", "tensorflow.python.platform.tf_logging.warning", "str", "str", "str", "str"], "function", ["None"], ["", "def", "process_impl_layer", "(", "input", ",", "layout", ",", "layer_name", ",", "layer", ",", "is_training", ",", "features", "=", "None", ")", ":", "\n", "    ", "context", "=", "impl_layer_impl", ".", "Context", "(", ")", "\n", "context", ".", "input", "=", "input", "\n", "context", ".", "layout", "=", "layout", "\n", "context", ".", "is_training", "=", "is_training", "\n", "context", ".", "features", "=", "features", "\n", "context", ".", "layer_name", "=", "layer_name", "\n", "for", "m", "in", "layer", ".", "ListFields", "(", ")", ":", "\n", "        ", "tf_logging", ".", "info", "(", "'feature_name:%s, member:%s, layout:%s'", "%", "\n", "(", "layer_name", ",", "str", "(", "m", "[", "0", "]", ".", "name", ")", ",", "str", "(", "layout", ")", ")", ")", "\n", "method", "=", "None", "\n", "try", ":", "\n", "            ", "with", "tf", ".", "variable_scope", "(", "m", "[", "0", "]", ".", "name", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "                ", "method", "=", "getattr", "(", "impl_layer_impl", ",", "m", "[", "0", "]", ".", "name", ")", "\n", "context", ".", "param", "=", "m", "[", "1", "]", "\n", "return", "method", "(", "context", ")", "\n", "", "", "except", "AttributeError", "as", "e", ":", "\n", "            ", "tf_logging", ".", "warning", "(", "'feature:%s, method:%s error:%s'", "%", "\n", "(", "layer_name", ",", "str", "(", "m", "[", "0", "]", ".", "name", ")", ",", "str", "(", "e", ")", ")", ")", "\n", "", "", "return", "layout", ",", "input", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_input": [[128, 159], ["features.items", "tensorflow.python.platform.tf_logging.info", "feature_config.HasField", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.python.platform.tf_logging.fatal", "feature_inputs.setdefault", "feature_inputs.setdefault", "feature_inputs[].append", "feature_config.HasField", "feature_inputs[].append", "feature_inputs[].append", "model_ops.add_embedding_layer", "model_ops.add_embedding_layer"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.add_embedding_layer", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.add_embedding_layer"], ["", "def", "process_feature_input", "(", "features_config", ",", "features", ",", "field_name", ")", ":", "\n", "    ", "feature_inputs", "=", "{", "}", "\n", "local_feature_config", "=", "{", "}", "\n", "for", "feature_key", ",", "feature_value", "in", "features", ".", "items", "(", ")", ":", "\n", "        ", "if", "feature_value", "is", "None", ":", "\n", "            ", "tf_logging", ".", "fatal", "(", "\"feature_value %s is None. Quit\"", "%", "feature_key", ")", "\n", "\n", "", "feature_config", "=", "features_config", "[", "feature_key", "]", "\n", "if", "field_name", "not", "in", "feature_config", ".", "field", ":", "\n", "            ", "continue", "\n", "", "if", "feature_config", ".", "is_weight_feature", ":", "\n", "            ", "continue", "\n", "", "tf_logging", ".", "info", "(", "'process feature: %s'", "%", "feature_key", ")", "\n", "if", "feature_config", ".", "type", "==", "ImplConfig", ".", "Feature", ".", "BYTES", ":", "\n", "            ", "tf_logging", ".", "fatal", "(", "\"bytes feature %s is not support\"", "%", "feature_key", ")", "\n", "", "feature_name", "=", "feature_config", ".", "feature_name", "\n", "if", "feature_config", ".", "HasField", "(", "'embedding'", ")", ":", "\n", "            ", "feature_inputs", ".", "setdefault", "(", "feature_name", ",", "[", "]", ")", "\n", "if", "FLAGS", ".", "use_impl_hash", "and", "feature_config", ".", "HasField", "(", "'bucketing'", ")", ":", "\n", "                ", "for", "seed", "in", "feature_config", ".", "bucketing", ".", "seeds", ":", "\n", "                    ", "feature_inputs", "[", "feature_name", "]", ".", "append", "(", "\n", "add_embedding_layer", "(", "features", ",", "feature_key", ",", "feature_config", ",", "seed", "=", "seed", ")", ")", "\n", "", "", "else", ":", "\n", "                ", "feature_inputs", "[", "feature_name", "]", ".", "append", "(", "\n", "add_embedding_layer", "(", "features", ",", "feature_key", ",", "feature_config", ")", ")", "\n", "", "local_feature_config", "[", "feature_name", "]", "=", "feature_config", "\n", "", "else", ":", "\n", "            ", "feature_inputs", ".", "setdefault", "(", "feature_name", ",", "[", "]", ")", "\n", "feature_inputs", "[", "feature_name", "]", ".", "append", "(", "features", "[", "feature_key", "]", ")", "\n", "local_feature_config", "[", "feature_name", "]", "=", "feature_config", "\n", "", "", "return", "feature_inputs", ",", "local_feature_config", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_layers": [[160, 204], ["feature_inputs.items", "feature_config.HasField", "len", "tensorflow.stack", "tensorflow.reshape", "feature_config.HasField", "feature_output.setdefault", "tensorflow.python.platform.tf_logging.info", "tensorflow.shape", "enumerate", "FeatureOutputItem", "tensorflow.variable_scope", "model_ops.process_impl_layer", "str"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_layer"], ["", "def", "process_feature_layers", "(", "feature_inputs", ",", "features", ",", "\n", "local_feature_config", ",", "is_training", ",", "custom_scope", "=", "None", ")", ":", "\n", "    ", "class", "FeatureOutputItem", ":", "\n", "        ", "pass", "\n", "", "feature_output", "=", "{", "}", "\n", "for", "feature_name", ",", "input_values", "in", "feature_inputs", ".", "items", "(", ")", ":", "\n", "        ", "feature_config", "=", "local_feature_config", "[", "feature_name", "]", "\n", "feature_dimension", "=", "None", "\n", "if", "not", "feature_config", ".", "is_multi_value", ":", "\n", "            ", "if", "feature_config", ".", "feature_dimension", "!=", "0", ":", "\n", "                ", "feature_dimension", "=", "feature_config", ".", "feature_dimension", "\n", "", "else", ":", "\n", "                ", "feature_dimension", "=", "1", "\n", "", "", "embed_size", "=", "1", "\n", "if", "feature_config", ".", "HasField", "(", "'embedding'", ")", ":", "\n", "            ", "embed_size", "=", "feature_config", ".", "embedding", ".", "embedding_size", "\n", "", "seed_num", "=", "len", "(", "input_values", ")", "\n", "# Construct feature tensor, Reshape to", "\n", "# [BatchSize, FeatureDimension, EmbeddingSize, SeedNum]", "\n", "feature_tensor", "=", "tf", ".", "stack", "(", "input_values", ",", "-", "1", ")", "\n", "batch_size", "=", "tf", ".", "shape", "(", "feature_tensor", ")", "[", "0", "]", "\n", "shape", "=", "[", "batch_size", ",", "-", "1", ",", "embed_size", ",", "seed_num", "]", "\n", "feature_tensor", "=", "tf", ".", "reshape", "(", "feature_tensor", ",", "shape", ")", "\n", "# Process Feature Layers", "\n", "layer_output", "=", "feature_tensor", "\n", "layout", "=", "[", "None", ",", "feature_dimension", ",", "embed_size", ",", "seed_num", "]", "\n", "if", "feature_config", ".", "HasField", "(", "'feature_layer'", ")", ":", "\n", "            ", "for", "i", ",", "layer", "in", "enumerate", "(", "feature_config", ".", "feature_layer", ".", "layer", ")", ":", "\n", "                ", "scope_name", "=", "feature_config", ".", "feature_name", "\n", "if", "custom_scope", "is", "not", "None", ":", "\n", "                    ", "scope_name", "==", "custom_scope", "+", "\"_\"", "+", "scope_name", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"%s/feature_layer_%d\"", "%", "\n", "(", "scope_name", ",", "i", ")", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "                    ", "layout", ",", "layer_output", "=", "process_impl_layer", "(", "\n", "layer_output", ",", "layout", ",", "feature_config", ".", "feature_name", ",", "\n", "layer", ",", "is_training", ",", "features", ")", "\n", "", "", "", "feature_output", ".", "setdefault", "(", "feature_name", ",", "FeatureOutputItem", "(", ")", ")", "\n", "feature_output", "[", "feature_name", "]", ".", "output", "=", "layer_output", "\n", "# feature_output[feature_name].input = feature_tensor", "\n", "feature_output", "[", "feature_name", "]", ".", "layout", "=", "layout", "\n", "feature_output", "[", "feature_name", "]", ".", "name", "=", "feature_name", "\n", "tf_logging", ".", "info", "(", "\"feature_name: %s, layout: %s\"", "%", "\n", "(", "feature_name", ",", "str", "(", "layout", ")", ")", ")", "\n", "", "return", "feature_output", ";", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.build_field_layer": [[206, 228], ["model_ops.process_impl_combiner", "tensorflow.python.platform.tf_logging.fatal", "tensorflow.variable_scope", "enumerate", "tensorflow.variable_scope", "model_ops.process_impl_layer"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_combiner", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_impl_layer"], ["", "def", "build_field_layer", "(", "fields_config", ",", "field_name", ",", "features", ",", "\n", "feature_output", ",", "is_training", ",", "custom_scope", "=", "None", ")", ":", "\n", "    ", "if", "not", "field_name", "in", "fields_config", ":", "\n", "        ", "tf_logging", ".", "fatal", "(", "\"field_name: %s can not find config\"", "%", "field_name", ")", "\n", "", "field_config", "=", "fields_config", "[", "field_name", "]", "\n", "\n", "layer_output", ",", "layout", "=", "process_impl_combiner", "(", "\n", "feature_output", ",", "field_config", ".", "combiner", ",", "is_training", ")", "\n", "bug_output", "=", "layer_output", "\n", "\n", "scope_name", "=", "field_name", "\n", "if", "custom_scope", "is", "not", "None", ":", "\n", "        ", "scope_name", "=", "custom_scope", "+", "\"_\"", "+", "field_name", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"field_%s\"", "%", "scope_name", ")", ":", "\n", "        ", "for", "i", ",", "layer", "in", "enumerate", "(", "field_config", ".", "field_layer", ".", "layer", ")", ":", "\n", "            ", "with", "tf", ".", "variable_scope", "(", "\"field_layer_%d\"", "%", "i", ")", ":", "\n", "                ", "layout", ",", "layer_output", "=", "process_impl_layer", "(", "\n", "layer_output", ",", "layout", ",", "field_name", ",", "layer", ",", "\n", "is_training", ",", "features", ")", "\n", "\n", "", "", "", "return", "layer_output", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._build_field": [[230, 247], ["model_ops.process_feature_input", "model_ops.process_feature_layers", "model_ops.build_field_layer"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_input", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_layers", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.build_field_layer"], ["", "def", "_build_field", "(", "impl_config", ",", "features", ",", "field_name", ",", "is_training", ")", ":", "\n", "    ", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "feature_inputs", ",", "local_feature_config", "=", "process_feature_input", "(", "\n", "features_config", ",", "features", ",", "field_name", ")", "\n", "feature_output", "=", "process_feature_layers", "(", "\n", "feature_inputs", ",", "features", ",", "local_feature_config", ",", "is_training", ")", "\n", "layer_output", "=", "build_field_layer", "(", "\n", "fields_config", ",", "field_name", ",", "\n", "features", ",", "feature_output", ",", "is_training", ")", "\n", "\n", "# vals = [(k, feature_output[k].input) for k in feature_output.keys()]", "\n", "# new_vals = []", "\n", "# for k, v in vals:", "\n", "#     bv = tf.reduce_sum(tf.cast(tf.is_nan(v), tf.int64))", "\n", "#     print(k, bv)", "\n", "#     new_vals.append((k, bv))", "\n", "return", "layer_output", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.build_field": [[249, 261], ["features.keys", "model_ops._build_field"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._build_field"], ["", "def", "build_field", "(", "impl_config", ",", "features", ",", "is_training", ",", "field_name", ")", ":", "\n", "    ", "\"\"\"Build network of field_name\"\"\"", "\n", "feature_config", ",", "_", ",", "_", "=", "impl_config", "\n", "field_features", "=", "{", "}", "\n", "for", "feature_name", "in", "features", ".", "keys", "(", ")", ":", "\n", "# beatlesyang", "\n", "# if feature_name == \"user_id_real\":", "\n", "#     continue", "\n", "        ", "if", "field_name", "in", "feature_config", "[", "feature_name", "]", ".", "field", ":", "\n", "            ", "field_features", "[", "feature_name", "]", "=", "features", "[", "feature_name", "]", "\n", "\n", "", "", "return", "_build_field", "(", "impl_config", ",", "field_features", ",", "field_name", ",", "is_training", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.build_context_field": [[262, 272], ["features.keys", "model_ops._build_field", "tensorflow.expand_dims"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._build_field"], ["", "def", "build_context_field", "(", "impl_config", ",", "features", ",", "is_training", ",", "field_name", ")", ":", "\n", "    ", "\"\"\"Build Context network of field_name\"\"\"", "\n", "feature_config", ",", "_", ",", "_", "=", "impl_config", "\n", "field_features", "=", "{", "}", "\n", "for", "feature_name", "in", "features", ".", "keys", "(", ")", ":", "\n", "        ", "if", "field_name", "in", "feature_config", "[", "feature_name", "]", ".", "field", ":", "\n", "            ", "field_features", "[", "feature_name", "]", "=", "features", "[", "feature_name", "]", "\n", "field_features", "[", "feature_name", "]", "=", "tf", ".", "expand_dims", "(", "field_features", "[", "feature_name", "]", ",", "0", ")", "\n", "\n", "", "", "return", "_build_field", "(", "impl_config", ",", "field_features", ",", "field_name", ",", "is_training", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._build_mtl_shared_field": [[273, 286], ["model_ops.process_feature_input", "model_ops.process_feature_layers", "model_ops.build_field_layer"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_input", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_layers", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.build_field_layer"], ["", "def", "_build_mtl_shared_field", "(", "impl_config", ",", "features", ",", "field_name", ",", "is_training", ",", "task_names", ")", ":", "\n", "    ", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "feature_inputs", ",", "local_feature_config", "=", "process_feature_input", "(", "\n", "features_config", ",", "features", ",", "field_name", ")", "\n", "layer_outputs", "=", "{", "}", "\n", "for", "task", "in", "task_names", ":", "\n", "        ", "feature_output", "=", "process_feature_layers", "(", "\n", "feature_inputs", ",", "features", ",", "local_feature_config", ",", "is_training", ",", "custom_scope", "=", "task", ")", "\n", "layer_output", "=", "build_field_layer", "(", "\n", "fields_config", ",", "field_name", ",", "\n", "features", ",", "feature_output", ",", "is_training", ",", "custom_scope", "=", "task", ")", "\n", "layer_outputs", "[", "task", "]", "=", "layer_output", "\n", "", "return", "layer_outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.build_mtl_shared_field": [[287, 296], ["features.keys", "model_ops._build_mtl_shared_field"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._build_mtl_shared_field"], ["", "def", "build_mtl_shared_field", "(", "impl_config", ",", "features", ",", "is_training", ",", "field_name", ",", "task_names", ")", ":", "\n", "    ", "\"\"\"Build network of field_name\"\"\"", "\n", "feature_config", ",", "_", ",", "_", "=", "impl_config", "\n", "field_features", "=", "{", "}", "\n", "for", "feature_name", "in", "features", ".", "keys", "(", ")", ":", "\n", "        ", "if", "field_name", "in", "feature_config", "[", "feature_name", "]", ".", "field", ":", "\n", "            ", "field_features", "[", "feature_name", "]", "=", "features", "[", "feature_name", "]", "\n", "\n", "", "", "return", "_build_mtl_shared_field", "(", "impl_config", ",", "field_features", ",", "field_name", ",", "is_training", ",", "task_names", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._build_mtl_user_field": [[297, 310], ["model_ops.process_feature_input", "model_ops.process_feature_layers", "build_user_field_layer"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_input", "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.process_feature_layers"], ["", "def", "_build_mtl_user_field", "(", "impl_config", ",", "features", ",", "field_name", ",", "is_training", ",", "tag_key", ",", "task_names", ")", ":", "\n", "    ", "features_config", ",", "fields_config", ",", "_", "=", "impl_config", "\n", "feature_inputs", ",", "local_feature_config", "=", "process_feature_input", "(", "\n", "features_config", ",", "features", ",", "field_name", ")", "\n", "layer_outputs", "=", "{", "}", "\n", "for", "task", "in", "task_names", ":", "\n", "        ", "feature_output", "=", "process_feature_layers", "(", "\n", "feature_inputs", ",", "features", ",", "local_feature_config", ",", "is_training", ",", "custom_scope", "=", "task", ")", "\n", "layer_output", "=", "build_user_field_layer", "(", "\n", "fields_config", ",", "field_name", ",", "\n", "features", ",", "feature_output", ",", "is_training", ",", "tag_key", ",", "custom_scope", "=", "task", ")", "\n", "layer_outputs", "[", "task", "]", "=", "layer_output", "\n", "", "return", "layer_outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops.build_mtl_user_field": [[311, 320], ["features.keys", "model_ops._build_mtl_user_field"], "function", ["home.repos.pwc.inspect_result.mvke2021_mvke.core.model_ops._build_mtl_user_field"], ["", "def", "build_mtl_user_field", "(", "impl_config", ",", "features", ",", "is_training", ",", "field_name", ",", "tag_key", ",", "task_names", ")", ":", "\n", "    ", "\"\"\"Build network of field_name\"\"\"", "\n", "feature_config", ",", "_", ",", "_", "=", "impl_config", "\n", "field_features", "=", "{", "}", "\n", "for", "feature_name", "in", "features", ".", "keys", "(", ")", ":", "\n", "        ", "if", "field_name", "in", "feature_config", "[", "feature_name", "]", ".", "field", ":", "\n", "            ", "field_features", "[", "feature_name", "]", "=", "features", "[", "feature_name", "]", "\n", "\n", "", "", "return", "_build_mtl_user_field", "(", "impl_config", ",", "field_features", ",", "field_name", ",", "is_training", ",", "tag_key", ",", "task_names", ")", "\n", "", ""]]}