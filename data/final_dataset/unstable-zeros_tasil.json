{"home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.bc.bc": [[7, 25], ["util.rng.PRNGSequence", "loguru.logger.info", "dataset_builder", "loguru.logger.info", "trainer.train", "loguru.logger.info", "util.trainer.Trainer.eval", "functools.partial", "policy_loss", "next", "next", "next", "bc.bc.loss"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.train", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.eval", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["def", "bc", "(", "config", ",", "rng_key", ",", "expert", ",", "dataset_builder", ",", "trainer", ",", "\n", "policy_loss", ",", "policy_fn", ",", "init_params", ")", ":", "\n", "    ", "def", "loss", "(", "keys", ",", "params", ",", "x", ",", "iteration", ",", "update_batch_stats", "=", "True", ")", ":", "\n", "# Make the policy with the params", "\n", "        ", "policy", "=", "functools", ".", "partial", "(", "policy_fn", ",", "params", ")", "\n", "return", "policy_loss", "(", "keys", ",", "policy", ",", "params", ",", "x", ",", "iteration", ",", "update_batch_stats", "=", "update_batch_stats", ")", "\n", "\n", "", "rng", "=", "PRNGSequence", "(", "rng_key", ")", "\n", "# Make a dataset rolled out under the expert with all of the parameters", "\n", "logger", ".", "info", "(", "\"Generating dataset\"", ")", "\n", "dataset", "=", "dataset_builder", "(", "next", "(", "rng", ")", ",", "expert", ",", "config", ".", "train_trajs", ")", "\n", "\n", "logger", ".", "info", "(", "\"Training\"", ")", "\n", "_", ",", "final_params", "=", "trainer", ".", "train", "(", "next", "(", "rng", ")", ",", "dataset", ",", "loss", ",", "init_params", ")", "\n", "\n", "logger", ".", "info", "(", "\"Computing final training dataset statistics..\"", ")", "\n", "train_stats", "=", "Trainer", ".", "eval", "(", "next", "(", "rng", ")", ",", "dataset", ",", "lambda", "k", ",", "x", ":", "loss", "(", "k", ",", "final_params", ",", "x", ",", "1e10", ",", "False", ")", "[", "1", "]", ",", "config", ".", "batch_size", ")", "\n", "return", "train_stats", ",", "final_params", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryGenerator.__init__": [[12, 20], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "rng_key", ",", "traj_length", ",", "\n", "init_gen", ",", "dynamics", ",", "policy", ")", ":", "\n", "        ", "assert", "traj_length", ">", "0", "\n", "self", ".", "_rng_key", "=", "rng_key", "\n", "self", ".", "_traj_length", "=", "traj_length", "\n", "self", ".", "_init_gen", "=", "init_gen", "\n", "self", ".", "_dynamics", "=", "dynamics", "\n", "self", ".", "_policy", "=", "policy", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryGenerator.length": [[21, 24], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "length", "(", "self", ")", ":", "\n", "        ", "return", "INFINITE", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryGenerator.__config__": [[25, 32], ["rollout.TrajectoryGenerator._init_gen.__config__", "rollout.TrajectoryGenerator._dynamics.__config__", "rollout.TrajectoryGenerator._policy.__config__"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "# TODO: Make init_gen, dynamics, and policy have config", "\n", "        ", "return", "{", "'rng_key'", ":", "self", ".", "_rng_key", ",", "\n", "'traj_length'", ":", "self", ".", "_traj_length", ",", "\n", "'init_gen'", ":", "self", ".", "_init_gen", ".", "__config__", "(", ")", ",", "\n", "'dynamics'", ":", "self", ".", "_dynamics", ".", "__config__", "(", ")", ",", "\n", "'policy'", ":", "self", ".", "_policy", ".", "__config__", "(", ")", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryGenerator.with_length": [[33, 36], ["rollout.TrajectoryGenerator"], "methods", ["None"], ["", "def", "with_length", "(", "self", ",", "length", ")", ":", "\n", "        ", "return", "TrajectoryGenerator", "(", "self", ".", "_rng_key", ",", "length", ",", "\n", "self", ".", "_init_gen", ",", "self", ".", "_dynamics", ",", "self", ".", "_policy", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryGenerator.with_key": [[37, 40], ["rollout.TrajectoryGenerator"], "methods", ["None"], ["", "def", "with_key", "(", "self", ",", "rng_key", ")", ":", "\n", "        ", "return", "TrajectoryGenerator", "(", "rng_key", ",", "self", ".", "_traj_length", ",", "\n", "self", ".", "_init_gen", ",", "self", ".", "_dynamics", ",", "self", ".", "_policy", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryGenerator.with_policy": [[41, 44], ["rollout.TrajectoryGenerator"], "methods", ["None"], ["", "def", "with_policy", "(", "self", ",", "policy", ")", ":", "\n", "        ", "return", "TrajectoryGenerator", "(", "self", ".", "_rng_key", ",", "self", ".", "_traj_length", ",", "\n", "self", ".", "_init_gen", ",", "self", ".", "_dynamics", ",", "policy", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryGenerator.with_visualize": [[45, 47], ["None"], "methods", ["None"], ["", "def", "with_visualize", "(", "self", ",", "vis", ")", ":", "\n", "        ", "return", "self", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryGenerator._generate": [[48, 63], ["jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "rollout.TrajectoryGenerator._init_gen", "jax.lax.scan", "jax.lax.scan", "jax.lax.scan", "jax.lax.scan", "jax.lax.scan", "jax.lax.scan", "jax.lax.scan", "jax.lax.scan", "jax.lax.scan", "jax.concatenate", "jax.concatenate", "jax.concatenate", "rollout.TrajectoryGenerator._policy", "jax.concatenate", "jax.concatenate", "jax.concatenate", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "rollout.TrajectoryGenerator._policy", "rollout.TrajectoryGenerator._dynamics", "jax.expand_dims", "jax.expand_dims", "jax.expand_dims", "jax.expand_dims", "jax.expand_dims", "jax.expand_dims"], "methods", ["None"], ["", "def", "_generate", "(", "self", ",", "rng_key", ")", ":", "\n", "        ", "rng_keys", "=", "jax", ".", "random", ".", "split", "(", "rng_key", ",", "self", ".", "_traj_length", ")", "\n", "def", "scan_fn", "(", "state", ",", "rng_key", ")", ":", "\n", "            ", "p_rng", ",", "d_rng", "=", "jax", ".", "random", ".", "split", "(", "rng_key", ")", "\n", "inp", "=", "self", ".", "_policy", "(", "state", ",", "p_rng", ")", "\n", "next_state", "=", "self", ".", "_dynamics", "(", "d_rng", ",", "state", ",", "inp", ")", "\n", "return", "next_state", ",", "(", "next_state", ",", "inp", ")", "\n", "\n", "", "init_key", ",", "final_inp_key", "=", "jax", ".", "random", ".", "split", "(", "rng_keys", "[", "0", "]", ")", "\n", "x0", "=", "self", ".", "_init_gen", "(", "init_key", ")", "\n", "_", ",", "(", "xs", ",", "us", ")", "=", "jax", ".", "lax", ".", "scan", "(", "scan_fn", ",", "x0", ",", "rng_keys", "[", "1", ":", "]", ")", "\n", "xs", "=", "jnp", ".", "concatenate", "(", "(", "jnp", ".", "expand_dims", "(", "x0", ",", "0", ")", ",", "xs", ")", ")", "\n", "uf", "=", "self", ".", "_policy", "(", "xs", "[", "-", "1", "]", ",", "final_inp_key", ")", "\n", "us", "=", "jnp", ".", "concatenate", "(", "(", "us", ",", "jnp", ".", "expand_dims", "(", "uf", ",", "0", ")", ")", ")", "\n", "return", "{", "'x'", ":", "xs", ",", "'u'", ":", "us", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryGenerator.iter": [[64, 66], ["rollout.TrajectoryIterator"], "methods", ["None"], ["", "def", "iter", "(", "self", ")", ":", "\n", "        ", "return", "TrajectoryIterator", "(", "self", ",", "self", ".", "_rng_key", ")", "\n", "", "", "from", "util", ".", "timer", "import", "timed", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryIterator.__init__": [[69, 74], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "generator", ",", "key", ",", "allocated", "=", "None", ",", "allocated_idx", "=", "0", ")", ":", "\n", "        ", "self", ".", "generator", "=", "generator", "\n", "self", ".", "key", "=", "key", "\n", "self", ".", "allocated", "=", "allocated", "\n", "self", ".", "allocated_idx", "=", "allocated_idx", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryIterator.has_next": [[75, 78], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "has_next", "(", "self", ")", ":", "\n", "        ", "return", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryIterator.next": [[79, 91], ["jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "rollout.TrajectoryIterator", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap"], "methods", ["None"], ["", "def", "next", "(", "self", ")", ":", "\n", "        ", "key", ",", "sk", "=", "jax", ".", "random", ".", "split", "(", "self", ".", "key", ")", "\n", "if", "self", ".", "allocated", "is", "None", "or", "self", ".", "allocated_idx", ">=", "64", ":", "\n", "            ", "keys", "=", "jax", ".", "random", ".", "split", "(", "sk", ",", "64", ")", "\n", "trajs", "=", "jax", ".", "vmap", "(", "self", ".", "generator", ".", "_generate", ")", "(", "keys", ")", "\n", "allocated", "=", "trajs", "\n", "allocated_idx", "=", "0", "\n", "", "else", ":", "\n", "            ", "allocated", "=", "self", ".", "allocated", "\n", "allocated_idx", "=", "self", ".", "allocated_idx", "\n", "", "x", "=", "jax", ".", "tree_util", ".", "tree_map", "(", "lambda", "x", ":", "x", "[", "allocated_idx", "]", ",", "allocated", ")", "\n", "return", "TrajectoryIterator", "(", "self", ".", "generator", ",", "key", ",", "allocated", ",", "allocated_idx", "+", "1", ")", ",", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.TrajectoryIterator.skip": [[92, 96], ["jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "rollout.TrajectoryIterator"], "methods", ["None"], ["", "def", "skip", "(", "self", ",", "n", ")", ":", "\n", "# TODO: This doesn't actually skip n, just muddles the key a bit", "\n", "        ", "_", ",", "sk", "=", "jax", ".", "random", ".", "split", "(", "self", ".", "key", ")", "\n", "return", "TrajectoryIterator", "(", "self", ".", "generator", ",", "sk", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.NormalGenerator.__init__": [[98, 100], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "state_dim", ")", ":", "\n", "        ", "self", ".", "_state_dim", "=", "state_dim", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.NormalGenerator.__config__": [[101, 103], ["None"], "methods", ["None"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "        ", "return", "{", "'state_dim'", ":", "self", ".", "_state_dim", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.NormalGenerator.__call__": [[104, 106], ["jax.random.normal", "jax.random.normal", "jax.random.normal", "jax.random.normal", "jax.random.normal", "jax.random.normal", "jax.random.normal", "jax.random.normal", "jax.random.normal"], "methods", ["None"], ["", "def", "__call__", "(", "self", ",", "rng", ")", ":", "\n", "        ", "return", "jax", ".", "random", ".", "normal", "(", "rng", ",", "shape", "=", "(", "self", ".", "_state_dim", ",", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.ModelPolicy.__init__": [[108, 111], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "model", ",", "params", ")", ":", "\n", "        ", "self", ".", "_model", "=", "model", "\n", "self", ".", "_params", "=", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.ModelPolicy.__config__": [[112, 116], ["jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "hashlib.sha256().hexdigest", "hashlib.sha256().hexdigest", "hashlib.sha256", "hashlib.sha256", "repr().encode", "numpy.array", "repr"], "methods", ["None"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "        ", "params_hash", "=", "jax", ".", "tree_util", ".", "tree_map", "(", "lambda", "x", ":", "hashlib", ".", "sha256", "(", "np", ".", "array", "(", "x", ")", ")", ".", "hexdigest", "(", ")", ",", "self", ".", "_params", ")", "\n", "return", "{", "'model'", ":", "hashlib", ".", "sha256", "(", "repr", "(", "self", ".", "_model", ")", ".", "encode", "(", "'utf-8'", ")", ")", ".", "hexdigest", "(", ")", ",", "\n", "'params'", ":", "params_hash", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.ModelPolicy.__call__": [[117, 122], ["rollout.ModelPolicy._model.apply", "rollout.ModelPolicy._model.apply"], "methods", ["None"], ["", "def", "__call__", "(", "self", ",", "state", ",", "rng", "=", "None", ",", "update_batch_stats", "=", "False", ")", ":", "\n", "        ", "if", "update_batch_stats", ":", "\n", "            ", "return", "self", ".", "_model", ".", "apply", "(", "self", ".", "_params", ",", "state", ",", "mutable", "=", "[", "'batch_stats'", "]", ",", "use_running_average", "=", "False", ")", "\n", "", "else", ":", "\n", "            ", "return", "self", ".", "_model", ".", "apply", "(", "self", ".", "_params", ",", "state", ",", "use_running_average", "=", "True", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.ArtificialSystem.__init__": [[124, 130], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "p", ",", "eta", ",", "gamma_power", ",", "expert", ")", ":", "\n", "        ", "assert", "eta", "<", "4", "/", "(", "5", "+", "p", ")", "# needed for IGS stability", "\n", "self", ".", "p", "=", "p", "\n", "self", ".", "eta", "=", "eta", "\n", "self", ".", "gamma_power", "=", "gamma_power", "\n", "self", ".", "expert", "=", "expert", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.ArtificialSystem.__config__": [[131, 133], ["rollout.ArtificialSystem.expert.__config__"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "        ", "return", "{", "'p'", ":", "self", ".", "p", ",", "'eta'", ":", "self", ".", "eta", ",", "'gamma_power'", ":", "self", ".", "gamma_power", ",", "'expert'", ":", "self", ".", "expert", ".", "__config__", "(", ")", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.ArtificialSystem.__call__": [[134, 144], ["jax.linalg.norm", "jax.linalg.norm", "jax.linalg.norm", "rollout.ArtificialSystem.expert", "jax.abs", "jax.abs", "jax.abs", "jax.abs", "jax.abs", "jax.abs", "jax.abs", "jax.abs", "jax.abs"], "methods", ["None"], ["", "def", "__call__", "(", "self", ",", "rng", ",", "x", ",", "u", ")", ":", "\n", "        ", "p", "=", "self", ".", "p", "\n", "eta", "=", "self", ".", "eta", "\n", "diff", "=", "u", "-", "self", ".", "expert", "(", "x", ")", "\n", "diff_norm", "=", "jnp", ".", "linalg", ".", "norm", "(", "diff", ")", "\n", "scale", "=", "(", "diff_norm", "+", "0.000001", ")", "**", "(", "self", ".", "gamma_power", "-", "1", ")", "\n", "\n", "f", "=", "x", "-", "eta", "*", "x", "*", "(", "jnp", ".", "abs", "(", "x", ")", "**", "p", ")", "/", "(", "1", "+", "(", "jnp", ".", "abs", "(", "x", ")", "**", "p", ")", ")", "\n", "g", "=", "eta", "/", "(", "1", "+", "(", "jnp", ".", "abs", "(", "x", ")", "**", "p", ")", ")", "*", "scale", "*", "diff", "\n", "return", "f", "+", "g", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.ExponentialSystem.__init__": [[146, 152], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "decay", ",", "c", ",", "gamma_power", ",", "expert", ")", ":", "\n", "        ", "assert", "decay", "<", "1", "\n", "self", ".", "decay", "=", "decay", "\n", "self", ".", "c", "=", "c", "\n", "self", ".", "gamma_power", "=", "gamma_power", "\n", "self", ".", "expert", "=", "expert", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.ExponentialSystem.__config__": [[153, 155], ["rollout.ExponentialSystem.expert.__config__"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "        ", "return", "{", "'p'", ":", "self", ".", "p", ",", "'eta'", ":", "self", ".", "eta", ",", "'gamma_power'", ":", "self", ".", "gamma_power", ",", "'expert'", ":", "self", ".", "expert", ".", "__config__", "(", ")", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.ExponentialSystem.__call__": [[156, 166], ["util.models.safe_norm", "rollout.ExponentialSystem.expert"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm"], ["", "def", "__call__", "(", "self", ",", "rng", ",", "x", ",", "u", ")", ":", "\n", "        ", "diff", "=", "(", "u", "-", "self", ".", "expert", "(", "x", ")", ")", "\n", "diff_norm", "=", "safe_norm", "(", "diff", ",", "1e-6", ")", "\n", "# Do a minimum to prevent blowup. This will not affect the", "\n", "# decay behavior and so is safe to do", "\n", "scale", "=", "diff_norm", "**", "(", "self", ".", "gamma_power", "-", "1", ")", "\n", "\n", "f", "=", "self", ".", "decay", "*", "x", "\n", "g", "=", "self", ".", "c", "*", "(", "1", "-", "self", ".", "decay", ")", "*", "scale", "*", "diff", "\n", "return", "f", "+", "g", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.PendulumSystem.__init__": [[168, 172], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "m", ",", "g", ",", "l", ")", ":", "\n", "        ", "self", ".", "m", "=", "m", "\n", "self", ".", "g", "=", "g", "\n", "self", ".", "l", "=", "l", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.PendulumSystem.__config__": [[173, 175], ["None"], "methods", ["None"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "        ", "return", "{", "'m'", ":", "self", ".", "m", ",", "'g'", ":", "self", ".", "g", ",", "'l'", ":", "self", ".", "l", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.PendulumSystem.__call__": [[176, 180], ["None"], "methods", ["None"], ["", "def", "__call__", "(", "self", ",", "rng", ",", "x", ",", "u", ")", ":", "\n", "        ", "m", "=", "self", ".", "m", "\n", "g", "=", "self", ".", "g", "\n", "l", "=", "self", ".", "l", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.rollout.flatten_trajectory": [[181, 185], ["range", "traj.items"], "function", ["None"], ["", "", "@", "jax", ".", "jit", "\n", "def", "flatten_trajectory", "(", "traj", ")", ":", "\n", "    ", "T", "=", "traj", "[", "'x'", "]", ".", "shape", "[", "0", "]", "\n", "return", "[", "{", "k", ":", "v", "[", "i", "]", "for", "k", ",", "v", "in", "traj", ".", "items", "(", ")", "}", "for", "i", "in", "range", "(", "T", ")", "]", "\n", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.__init__": [[16, 24], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "rng_key", ",", "traj_length", ",", "env", ",", "policy", ",", "\n", "scale_dynamics", ",", "vis", ")", ":", "\n", "        ", "self", ".", "_rng_key", "=", "rng_key", "\n", "self", ".", "_traj_length", "=", "traj_length", "\n", "self", ".", "_env", "=", "env", "\n", "self", ".", "_policy", "=", "policy", "\n", "self", ".", "_scale_dynamics", "=", "scale_dynamics", "\n", "self", ".", "_vis", "=", "vis", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.length": [[25, 28], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "length", "(", "self", ")", ":", "\n", "        ", "return", "INFINITE", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_key": [[29, 32], ["gym.GymGenerator"], "methods", ["None"], ["", "def", "with_key", "(", "self", ",", "rng_key", ")", ":", "\n", "        ", "return", "GymGenerator", "(", "rng_key", ",", "self", ".", "_traj_length", ",", "\n", "self", ".", "_env", ",", "self", ".", "_policy", ",", "self", ".", "_scale_dynamics", ",", "self", ".", "_vis", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_length": [[33, 36], ["gym.GymGenerator"], "methods", ["None"], ["", "def", "with_length", "(", "self", ",", "length", ")", ":", "\n", "        ", "return", "GymGenerator", "(", "self", ".", "_rng_key", ",", "length", ",", "self", ".", "_env", ",", "self", ".", "_policy", ",", "\n", "self", ".", "_scale_dynamics", ",", "self", ".", "_vis", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_policy": [[37, 40], ["gym.GymGenerator"], "methods", ["None"], ["", "def", "with_policy", "(", "self", ",", "policy", ")", ":", "\n", "        ", "return", "GymGenerator", "(", "self", ".", "_rng_key", ",", "self", ".", "_traj_length", ",", "self", ".", "_env", ",", "policy", ",", "\n", "self", ".", "_scale_dynamics", ",", "self", ".", "_vis", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_visualize": [[41, 44], ["gym.GymGenerator"], "methods", ["None"], ["", "def", "with_visualize", "(", "self", ",", "vis", ")", ":", "\n", "        ", "return", "GymGenerator", "(", "self", ".", "_rng_key", ",", "self", ".", "_traj_length", ",", "self", ".", "_env", ",", "self", ".", "_policy", ",", "\n", "self", ".", "_scale_dynamics", ",", "vis", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.iter": [[45, 47], ["gym.GymIterator"], "methods", ["None"], ["", "def", "iter", "(", "self", ")", ":", "\n", "        ", "return", "GymIterator", "(", "self", ",", "self", ".", "_rng_key", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymIterator.__init__": [[49, 52], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "gen", ",", "key", ")", ":", "\n", "        ", "self", ".", "key", "=", "key", "\n", "self", ".", "gen", "=", "gen", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymIterator.has_next": [[53, 56], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "has_next", "(", "self", ")", ":", "\n", "        ", "return", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymIterator.next": [[57, 85], ["jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "env.seed", "gym.GymIterator.gen._env.reset", "range", "jax.random.randint().item", "jax.random.randint().item", "jax.random.randint().item", "jax.random.randint().item", "xs.append", "gym.GymIterator.gen._policy", "jax.clip", "jax.clip", "env.step", "rs.append", "us.append", "jax.stack", "jax.stack", "jax.stack", "jax.stack", "jax.stack", "jax.stack", "jax.stack", "jax.stack", "gym.GymIterator", "imgs.append", "jax.nn.tanh", "jax.nn.tanh", "jax.nn.tanh", "jax.nn.tanh", "numpy.array", "jax.random.randint", "jax.random.randint", "jax.random.randint", "jax.random.randint", "env.render"], "methods", ["None"], ["", "def", "next", "(", "self", ")", ":", "\n", "        ", "env", "=", "self", ".", "gen", ".", "_env", "\n", "reset_key", ",", "traj_key", ",", "next_key", "=", "jax", ".", "random", ".", "split", "(", "self", ".", "key", ",", "3", ")", "\n", "traj_keys", "=", "jax", ".", "random", ".", "split", "(", "traj_key", ",", "self", ".", "gen", ".", "_traj_length", ")", "\n", "env", ".", "seed", "(", "jax", ".", "random", ".", "randint", "(", "reset_key", ",", "(", ")", ",", "0", ",", "100000000", ")", ".", "item", "(", ")", ")", "\n", "x", "=", "self", ".", "gen", ".", "_env", ".", "reset", "(", ")", "\n", "xs", "=", "[", "]", "\n", "us", "=", "[", "]", "\n", "rs", "=", "[", "]", "\n", "imgs", "=", "[", "]", "\n", "low", ",", "high", "=", "env", ".", "action_space", ".", "low", ",", "env", ".", "action_space", ".", "high", "\n", "for", "i", "in", "range", "(", "self", ".", "gen", ".", "_traj_length", ")", ":", "\n", "            ", "xs", ".", "append", "(", "x", ")", "\n", "if", "self", ".", "gen", ".", "_vis", ":", "\n", "                ", "imgs", ".", "append", "(", "env", ".", "render", "(", "mode", "=", "'rgb_array'", ")", ")", "\n", "", "u", "=", "self", ".", "gen", ".", "_policy", "(", "x", ",", "traj_keys", "[", "i", "]", ")", "\n", "if", "self", ".", "gen", ".", "_scale_dynamics", ":", "\n", "                ", "u", "=", "jax", ".", "nn", ".", "tanh", "(", "u", ")", "\n", "u", "=", "low", "+", "(", "0.5", "*", "(", "u", "+", "1.0", ")", "*", "(", "high", "-", "low", ")", ")", "\n", "", "u", "=", "jnp", ".", "clip", "(", "u", ",", "low", ",", "high", ")", "\n", "x", ",", "r", ",", "_", ",", "_", "=", "env", ".", "step", "(", "np", ".", "array", "(", "u", ")", ")", "\n", "rs", ".", "append", "(", "r", ")", "\n", "us", ".", "append", "(", "u", ")", "\n", "", "xs", ",", "us", ",", "rs", "=", "jnp", ".", "stack", "(", "xs", ")", ",", "jnp", ".", "stack", "(", "us", ")", ",", "jnp", ".", "stack", "(", "rs", ")", "\n", "traj", "=", "{", "\"x\"", ":", "xs", ",", "\"u\"", ":", "us", ",", "\"r\"", ":", "rs", "}", "\n", "if", "self", ".", "gen", ".", "_vis", ":", "\n", "            ", "traj", "[", "\"img\"", "]", "=", "jnp", ".", "stack", "(", "imgs", ")", "\n", "", "return", "GymIterator", "(", "self", ".", "gen", ",", "next_key", ")", ",", "traj", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.load_gym_expert_from_path": [[87, 120], ["pickle.load", "flax.core.frozen_dict.freeze", "jax.device_put", "jax.device_put", "util.models.MLP", "flax.core.frozen_dict.freeze", "open", "util.models.MLP.apply", "jax.clip", "jax.nn.tanh", "jax.nn.tanh", "jax.sqrt"], "function", ["None"], ["", "", "def", "load_gym_expert_from_path", "(", "path", ",", "env", ",", "scale_output", ")", ":", "\n", "    ", "expert_data", "=", "pickle", ".", "load", "(", "open", "(", "path", ",", "\"rb\"", ")", ")", "\n", "expert_data", "=", "flax", ".", "core", ".", "frozen_dict", ".", "freeze", "(", "expert_data", ")", "\n", "\n", "expert_params", "=", "jax", ".", "device_put", "(", "expert_data", "[", "'params'", "]", ")", "\n", "\n", "model", "=", "MLP", "(", "(", "expert_params", "[", "'layer_0'", "]", "[", "'bias'", "]", ".", "shape", "[", "0", "]", ",", "\n", "expert_params", "[", "'layer_1'", "]", "[", "'bias'", "]", ".", "shape", "[", "0", "]", ",", "\n", "expert_params", "[", "'layer_2'", "]", "[", "'bias'", "]", ".", "shape", "[", "0", "]", ")", ",", "expert_data", "[", "'activation'", "]", ")", "\n", "expert_params", "=", "flax", ".", "core", ".", "frozen_dict", ".", "freeze", "(", "{", "\n", "'params'", ":", "expert_params", "\n", "}", ")", "\n", "\n", "\n", "use_norm", "=", "expert_data", "[", "'norm'", "]", "is", "not", "None", "\n", "if", "expert_data", "[", "'norm'", "]", "is", "not", "None", ":", "\n", "        ", "norm_mean", "=", "expert_data", "[", "'norm'", "]", "[", "'mean'", "]", "\n", "norm_var", "=", "expert_data", "[", "'norm'", "]", "[", "'var'", "]", "\n", "norm_epsilon", "=", "expert_data", "[", "'norm'", "]", "[", "'epsilon'", "]", "\n", "norm_clip", "=", "expert_data", "[", "'norm'", "]", "[", "'clip'", "]", "\n", "\n", "", "low", ",", "high", "=", "env", ".", "action_space", ".", "low", ",", "env", ".", "action_space", ".", "high", "\n", "@", "jax", ".", "jit", "\n", "def", "expert", "(", "x", ",", "rng", "=", "None", ")", ":", "\n", "        ", "if", "use_norm", ":", "\n", "            ", "normed", "=", "(", "x", "-", "norm_mean", ")", "/", "jnp", ".", "sqrt", "(", "norm_var", "+", "norm_epsilon", ")", "\n", "x", "=", "jnp", ".", "clip", "(", "normed", ",", "-", "norm_clip", ",", "norm_clip", ")", "\n", "", "u", "=", "model", ".", "apply", "(", "expert_params", ",", "x", ")", "\n", "if", "scale_output", ":", "\n", "            ", "u", "=", "jax", ".", "nn", ".", "tanh", "(", "u", ")", "\n", "u", "=", "low", "+", "(", "0.5", "*", "(", "u", "+", "1.0", ")", "*", "(", "high", "-", "low", ")", ")", "\n", "", "return", "u", "\n", "", "return", "expert", ",", "expert_params", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.make_gym_expert_with_params": [[121, 125], ["os.path.join", "os.path.join", "gym.load_gym_expert_from_path", "pathlib.Path().parent.parent.resolve", "pathlib.Path"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.load_gym_expert_from_path"], ["", "def", "make_gym_expert_with_params", "(", "expert_name", ",", "env", ",", "scale_output", ")", ":", "\n", "    ", "experts_dir", "=", "os", ".", "path", ".", "join", "(", "pathlib", ".", "Path", "(", "__file__", ")", ".", "parent", ".", "parent", ".", "resolve", "(", ")", ",", "\"experts\"", ")", "\n", "path", "=", "os", ".", "path", ".", "join", "(", "experts_dir", ",", "f\"{expert_name}.pk\"", ")", "\n", "return", "load_gym_expert_from_path", "(", "path", ",", "env", ",", "scale_output", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.make_gym_expert": [[126, 128], ["gym.make_gym_expert_with_params"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.make_gym_expert_with_params"], ["", "def", "make_gym_expert", "(", "expert_name", ",", "env", ",", "scale_output", ")", ":", "\n", "    ", "return", "make_gym_expert_with_params", "(", "expert_name", ",", "env", ",", "scale_output", ")", "[", "0", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.make_gym_policy": [[129, 147], ["util.models.MLP", "util.models.MLP.init", "functools.partial", "jax.zeros", "util.models.MLP.apply", "util.models.MLP.apply", "jax.nn.tanh", "jax.nn.tanh"], "function", ["None"], ["", "def", "make_gym_policy", "(", "rng_key", ",", "env_name", ",", "env", ",", "scale_output", ")", ":", "\n", "    ", "u_dim", "=", "env", ".", "action_space", ".", "shape", "[", "0", "]", "\n", "x_dim", "=", "env", ".", "observation_space", ".", "shape", "[", "0", "]", "\n", "model", "=", "MLP", "(", "(", "512", ",", "512", ",", "u_dim", ")", ",", "'gelu'", ",", "batch_norm", "=", "False", ")", "\n", "init_params", "=", "model", ".", "init", "(", "rng_key", ",", "jnp", ".", "zeros", "(", "x_dim", ")", ",", "use_running_average", "=", "False", ")", "\n", "\n", "low", ",", "high", "=", "env", ".", "action_space", ".", "low", ",", "env", ".", "action_space", ".", "high", "\n", "@", "functools", ".", "partial", "(", "jax", ".", "jit", ",", "static_argnums", "=", "3", ")", "\n", "def", "policy", "(", "vars", ",", "x", ",", "rng", "=", "None", ",", "update_batch_stats", "=", "False", ")", ":", "\n", "        ", "if", "update_batch_stats", ":", "\n", "            ", "u", ",", "new_batch_stats", "=", "model", ".", "apply", "(", "vars", ",", "x", ",", "mutable", "=", "[", "'batch_stats'", "]", ",", "use_running_average", "=", "False", ")", "\n", "", "else", ":", "\n", "            ", "u", "=", "model", ".", "apply", "(", "vars", ",", "x", ",", "use_running_average", "=", "True", ")", "\n", "", "if", "scale_output", ":", "\n", "            ", "u", "=", "jax", ".", "nn", ".", "tanh", "(", "u", ")", "\n", "u", "=", "low", "+", "(", "0.5", "*", "(", "u", "+", "1.0", ")", "*", "(", "high", "-", "low", ")", ")", "\n", "", "return", "(", "u", ",", "new_batch_stats", ")", "if", "update_batch_stats", "else", "u", "\n", "", "return", "policy", ",", "init_params", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.envs.make_system": [[10, 60], ["jax.random.split", "jax.random.split", "util.models.MLP", "util.models.MLP.init", "imitation_learning.rollout.TrajectoryGenerator", "util.models.MLP", "util.models.MLP.init", "config.environment.startswith", "jax.zeros", "util.models.MLP.apply", "jax.nn.tanh", "jax.nn.tanh", "jax.zeros", "jax.nn.tanh", "jax.nn.tanh", "jax.random.split", "jax.random.split", "gym.make", "imitation_learning.gym.make_gym_expert", "imitation_learning.gym.make_gym_policy", "imitation_learning.gym.GymGenerator", "ValueError", "jax.nn.initializers.variance_scaling", "jax.nn.initializers.variance_scaling", "jax.nn.initializers.normal", "jax.nn.initializers.normal", "imitation_learning.rollout.NormalGenerator", "util.models.MLP.apply", "util.models.MLP.apply", "config.environment.split", "imitation_learning.rollout.ArtificialSystem", "imitation_learning.rollout.ExponentialSystem"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoaderHost.make", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.make_gym_expert", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.make_gym_policy"], ["def", "make_system", "(", "config", ",", "rng_key", ")", ":", "\n", "    ", "if", "config", ".", "environment", "==", "'dummy'", "or", "config", ".", "environment", "==", "'dummy2'", ":", "\n", "        ", "expert_rng", ",", "policy_rng", ",", "gen_rng", "=", "jax", ".", "random", ".", "split", "(", "rng_key", ",", "3", ")", "\n", "expert_model", "=", "MLP", "(", "(", "32", ",", "32", ",", "config", ".", "state_dim", ")", ",", "config", ".", "activation", ",", "\n", "kernel_init", "=", "jax", ".", "nn", ".", "initializers", ".", "variance_scaling", "(", "1.0", ",", "\"fan_in\"", ",", "\"truncated_normal\"", ")", ",", "\n", "bias_init", "=", "jax", ".", "nn", ".", "initializers", ".", "normal", "(", "0.1", ")", ")", "\n", "expert_params", "=", "expert_model", ".", "init", "(", "expert_rng", ",", "jnp", ".", "zeros", "(", "config", ".", "state_dim", ")", ")", "\n", "def", "expert", "(", "x", ",", "rng", "=", "None", ")", ":", "\n", "            ", "mu", "=", "expert_model", ".", "apply", "(", "expert_params", ",", "x", ")", "\n", "# return mu", "\n", "return", "jax", ".", "nn", ".", "tanh", "(", "mu", ")", "\n", "", "generator", "=", "TrajectoryGenerator", "(", "\n", "traj_length", "=", "config", ".", "traj_length", ",", "\n", "init_gen", "=", "NormalGenerator", "(", "config", ".", "state_dim", ")", ",", "\n", "dynamics", "=", "ArtificialSystem", "(", "5", ",", "0.3", ",", "config", ".", "gamma", ",", "expert", ")", "if", "config", ".", "environment", "==", "'dummy'", "else", "ExponentialSystem", "(", "0.95", ",", "5", ",", "config", ".", "gamma", ",", "expert", ")", ",", "\n", "policy", "=", "expert", ",", "\n", "rng_key", "=", "gen_rng", "\n", ")", "\n", "model", "=", "MLP", "(", "(", "64", ",", "64", ",", "64", ",", "config", ".", "state_dim", ")", ",", "config", ".", "activation", ")", "\n", "init_params", "=", "model", ".", "init", "(", "policy_rng", ",", "jnp", ".", "zeros", "(", "config", ".", "state_dim", ")", ",", "use_running_average", "=", "False", ")", "\n", "def", "policy", "(", "vars", ",", "x", ",", "rng", "=", "None", ",", "update_batch_stats", "=", "False", ")", ":", "\n", "            ", "if", "update_batch_stats", ":", "\n", "                ", "mu", ",", "bs", "=", "model", ".", "apply", "(", "vars", ",", "x", ",", "mutable", "=", "[", "'batch_stats'", "]", ",", "use_running_average", "=", "False", ")", "\n", "", "else", ":", "\n", "                ", "mu", "=", "model", ".", "apply", "(", "vars", ",", "x", ",", "use_running_average", "=", "True", ")", "\n", "# return (mu, bs) if update_batch_stats else mu", "\n", "", "mu", "=", "jax", ".", "nn", ".", "tanh", "(", "mu", ")", "\n", "return", "(", "mu", ",", "bs", ")", "if", "update_batch_stats", "else", "mu", "\n", "\n", "", "return", "generator", ",", "expert", ",", "policy", ",", "init_params", "\n", "", "elif", "config", ".", "environment", ".", "startswith", "(", "\"gym\"", ")", ":", "\n", "        ", "policy_rng", ",", "gen_rng", "=", "jax", ".", "random", ".", "split", "(", "rng_key", ",", "2", ")", "\n", "\n", "env_name", "=", "config", ".", "environment", ".", "split", "(", "\"/\"", ")", "[", "1", "]", "\n", "env", "=", "gym", ".", "make", "(", "env_name", ")", "\n", "expert_name", "=", "config", ".", "gym_alternate_expert", "or", "env_name", "\n", "expert", "=", "make_gym_expert", "(", "expert_name", ",", "env", ",", "not", "config", ".", "gym_scale_dynamics", ")", "\n", "policy", ",", "init_params", "=", "make_gym_policy", "(", "policy_rng", ",", "env_name", ",", "env", ",", "config", ".", "gym_scale_policy", ")", "\n", "generator", "=", "GymGenerator", "(", "\n", "traj_length", "=", "config", ".", "traj_length", ",", "\n", "policy", "=", "expert", ",", "\n", "rng_key", "=", "rng_key", ",", "\n", "env", "=", "env", ",", "\n", "scale_dynamics", "=", "config", ".", "gym_scale_dynamics", ",", "\n", "vis", "=", "False", "\n", ")", "\n", "return", "generator", ",", "expert", ",", "policy", ",", "init_params", "\n", "", "else", ":", "\n", "        ", "raise", "ValueError", "(", "\"Unrecognized environment\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.envs.make_dataset": [[61, 72], ["generator.flat_map.with_key", "generator.flat_map.with_policy", "preprocess_pipeline", "generator.flat_map.until", "generator.flat_map.preload", "generator.flat_map.flat_map"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_key", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_policy", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.until", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.preload", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.flat_map"], ["", "", "def", "make_dataset", "(", "generator", ",", "preprocess_pipeline", ",", "\n", "rng_key", ",", "policy", ",", "num_trajectories", ",", "flatten", "=", "True", ")", ":", "\n", "# Switch the generator to the requested policy, rng_key", "\n", "    ", "generator", "=", "generator", ".", "with_key", "(", "rng_key", ")", "\n", "generator", "=", "generator", ".", "with_policy", "(", "policy", ")", "\n", "generator", "=", "preprocess_pipeline", "(", "generator", ")", "\n", "generator", "=", "generator", ".", "until", "(", "num_trajectories", ")", "\n", "if", "flatten", ":", "\n", "        ", "generator", "=", "generator", ".", "flat_map", "(", "flatten_trajectory", ")", "\n", "", "dataset", "=", "generator", ".", "preload", "(", ")", "\n", "return", "dataset", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.dagger.dagger": [[8, 40], ["util.rng.PRNGSequence", "list", "list.append", "loguru.logger.info", "util.trainer.Trainer.eval", "functools.partial", "policy_loss", "filter", "functools.partial", "loguru.logger.info", "dataset_builder", "trainer.train", "next", "next", "util.dataset.Dataset.join", "next", "dagger.dagger.loss"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.eval", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.train", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["def", "dagger", "(", "config", ",", "rng_key", ",", "expert", ",", "dataset_builder", ",", "trainer", ",", "\n", "policy_loss", ",", "policy_fn", ",", "init_params", ")", ":", "\n", "    ", "def", "loss", "(", "key", ",", "params", ",", "x", ",", "iteration", ",", "update_batch_stats", "=", "True", ")", ":", "\n", "# Make the policy with the params", "\n", "        ", "policy", "=", "functools", ".", "partial", "(", "policy_fn", ",", "params", ")", "\n", "return", "policy_loss", "(", "key", ",", "policy", ",", "params", ",", "x", ",", "iteration", ",", "update_batch_stats", "=", "update_batch_stats", ")", "\n", "\n", "", "decay", "=", "config", ".", "beta", "\n", "rng", "=", "PRNGSequence", "(", "rng_key", ")", "\n", "\n", "trajs", "=", "config", ".", "train_trajs", "\n", "iters", "=", "list", "(", "filter", "(", "lambda", "x", ":", "x", "<", "trajs", ",", "config", ".", "shift_iters", ")", ")", "\n", "iters", ".", "append", "(", "trajs", ")", "\n", "\n", "dataset", "=", "None", "\n", "trained_params", "=", "init_params", "\n", "prev_iter", "=", "0", "\n", "beta", "=", "1", "\n", "for", "i", "in", "iters", ":", "\n", "        ", "num_trajs", "=", "i", "-", "prev_iter", "\n", "prev_iter", "=", "i", "\n", "prev_policy", "=", "functools", ".", "partial", "(", "policy_fn", ",", "trained_params", ")", "\n", "mixed_policy", "=", "lambda", "x", ",", "r", "=", "None", ":", "beta", "*", "expert", "(", "x", ")", "+", "(", "1", "-", "beta", ")", "*", "prev_policy", "(", "x", ")", "\n", "logger", ".", "info", "(", "f\"Generating additional {num_trajs} trajectories\"", ")", "\n", "new_data", "=", "dataset_builder", "(", "next", "(", "rng", ")", ",", "mixed_policy", ",", "num_trajs", ")", "\n", "# aggregate the data!", "\n", "dataset", "=", "Dataset", ".", "join", "(", "dataset", ",", "new_data", ")", "if", "dataset", "is", "not", "None", "else", "new_data", "\n", "_", ",", "trained_params", "=", "trainer", ".", "train", "(", "next", "(", "rng", ")", ",", "dataset", ",", "loss", ",", "trained_params", ")", "\n", "beta", "=", "beta", "*", "decay", "# Decay the beta", "\n", "", "logger", ".", "info", "(", "\"Computing final training dataset statistics...\"", ")", "\n", "train_stats", "=", "Trainer", ".", "eval", "(", "next", "(", "rng", ")", ",", "dataset", ",", "lambda", "k", ",", "x", ":", "loss", "(", "k", ",", "trained_params", ",", "x", ",", "1e10", ",", "False", ")", "[", "1", "]", ",", "config", ".", "batch_size", ")", "\n", "return", "train_stats", ",", "trained_params", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.dart.dart": [[10, 64], ["util.rng.PRNGSequence", "list", "list.append", "loguru.logger.info", "util.trainer.Trainer.eval", "functools.partial", "policy_loss", "filter", "expert", "loguru.logger.info", "dataset_builder", "trainer.train", "functools.partial", "dataset_builder", "jax.expand_dims", "jax.transpose", "jax.mean", "next", "jax.random.multivariate_normal", "jax.random.multivariate_normal", "functools.partial", "next", "util.dataset.Dataset.join", "next", "next", "jax.zeros_like", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "dart.dart.loss"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.eval", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.train", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["def", "dart", "(", "config", ",", "rng_key", ",", "expert", ",", "dataset_builder", ",", "trainer", ",", "\n", "policy_loss", ",", "policy_fn", ",", "init_params", ")", ":", "\n", "    ", "def", "loss", "(", "key", ",", "params", ",", "x", ",", "iteration", ",", "update_batch_stats", "=", "True", ")", ":", "\n", "# Make the policy with the params", "\n", "        ", "policy", "=", "functools", ".", "partial", "(", "policy_fn", ",", "params", ")", "\n", "return", "policy_loss", "(", "key", ",", "policy", ",", "params", ",", "x", ",", "iteration", ",", "update_batch_stats", "=", "update_batch_stats", ")", "\n", "\n", "", "alpha", "=", "config", ".", "alpha", "\n", "rng", "=", "PRNGSequence", "(", "rng_key", ")", "\n", "\n", "trajs", "=", "config", ".", "train_trajs", "\n", "iters", "=", "list", "(", "filter", "(", "lambda", "x", ":", "x", "<", "trajs", ",", "config", ".", "shift_iters", ")", ")", "\n", "iters", ".", "append", "(", "trajs", ")", "\n", "\n", "def", "noisy_policy", "(", "noise_cov", ",", "x", ",", "rng", ")", ":", "\n", "        ", "expert_u", "=", "expert", "(", "x", ")", "\n", "# Inject gaussian noise according to the noise covariance", "\n", "return", "expert_u", "+", "jax", ".", "random", ".", "multivariate_normal", "(", "rng", ",", "\n", "jnp", ".", "zeros_like", "(", "expert_u", ")", ",", "noise_cov", ")", "\n", "\n", "", "dataset", "=", "None", "\n", "alpha_cov", "=", "None", "\n", "trained_params", "=", "init_params", "\n", "prev_iter", "=", "0", "\n", "for", "i", "in", "iters", ":", "\n", "        ", "num_trajs", "=", "i", "-", "prev_iter", "\n", "prev_iter", "=", "i", "\n", "# if we have a covariance, inject noise (first interaction just use the expert)", "\n", "# This is what the berkeley-provided DART implementation does (not mentioned in paper)", "\n", "injected_policy", "=", "functools", ".", "partial", "(", "noisy_policy", ",", "alpha_cov", ")", "if", "alpha_cov", "is", "not", "None", "else", "expert", "\n", "# Rollout data using the inected policy", "\n", "logger", ".", "info", "(", "f\"Generating additional {num_trajs} trajectories\"", ")", "\n", "new_data", "=", "dataset_builder", "(", "next", "(", "rng", ")", ",", "injected_policy", ",", "num_trajs", ")", "\n", "# aggregate the data!", "\n", "dataset", "=", "Dataset", ".", "join", "(", "dataset", ",", "new_data", ")", "if", "dataset", "is", "not", "None", "else", "new_data", "\n", "_", ",", "trained_params", "=", "trainer", ".", "train", "(", "next", "(", "rng", ")", ",", "dataset", ",", "loss", ",", "trained_params", ")", "\n", "# Update the cov, alpha_cov parameters on the new_data", "\n", "# Since new_data is just a pytree dataset we can directly access the data", "\n", "learned_policy", "=", "functools", ".", "partial", "(", "policy_fn", ",", "trained_params", ")", "\n", "\n", "# We could theoretically just do this before the trainer.train but just to be consistent", "\n", "# with the original DART implementation (which seems to roll out more trajectories than expected?)", "\n", "stats_data", "=", "dataset_builder", "(", "next", "(", "rng", ")", ",", "injected_policy", ",", "5", ")", "\n", "diff", "=", "jax", ".", "vmap", "(", "learned_policy", ")", "(", "stats_data", ".", "data", "[", "'x'", "]", ")", "-", "jax", ".", "vmap", "(", "expert", ")", "(", "stats_data", ".", "data", "[", "'x'", "]", ")", "\n", "diff", "=", "jnp", ".", "expand_dims", "(", "diff", ",", "-", "1", ")", "\n", "diff_T", "=", "jnp", ".", "transpose", "(", "diff", ",", "(", "0", ",", "2", ",", "1", ")", ")", "\n", "cov", "=", "jnp", ".", "mean", "(", "diff", "@", "diff_T", ",", "0", ")", "\n", "if", "alpha", ">", "0", ":", "\n", "            ", "alpha_cov", "=", "alpha", "*", "cov", "/", "(", "config", ".", "traj_length", "*", "jnp", ".", "trace", "(", "cov", ")", ")", "\n", "", "else", ":", "\n", "            ", "alpha_cov", "=", "cov", "\n", "", "", "logger", ".", "info", "(", "\"Computing final training dataset statistics...\"", ")", "\n", "train_stats", "=", "Trainer", ".", "eval", "(", "next", "(", "rng", ")", ",", "dataset", ",", "lambda", "k", ",", "x", ":", "loss", "(", "k", ",", "trained_params", ",", "x", ",", "1e10", ",", "False", ")", "[", "1", "]", ",", "config", ".", "batch_size", ")", "\n", "return", "train_stats", ",", "trained_params", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.__init__.make_algorithm": [[26, 33], ["None"], "function", ["None"], ["def", "make_algorithm", "(", "algorithm", ")", ":", "\n", "    ", "if", "algorithm", "==", "'bc'", ":", "\n", "        ", "return", "bc", "\n", "", "elif", "algorithm", "==", "'dagger'", ":", "\n", "        ", "return", "dagger", "\n", "", "elif", "algorithm", "==", "'dart'", ":", "\n", "        ", "return", "dart", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.__init__.train": [[34, 203], ["util.rng.PRNGSequence", "next", "imitation_learning.envs.make_system", "functools.partial", "optax.chain", "util.trainer.Trainer", "__init__.make_algorithm", "loguru.logger.info", "make_algorithm.", "loguru.logger.info", "generator.with_key().with_visualize().with_length.with_key", "generator.with_key().with_visualize().with_length.until", "generator.with_key().with_visualize().with_length.with_policy().until", "util.dataset.Dataset.zip().preload", "loguru.logger.info", "util.sweep.log_info", "loguru.logger.info", "util.trainer.Trainer.eval", "util.sweep.log_info", "jax.random.PRNGKey", "generator.with_key().with_visualize().with_length.map", "util.models.safe_norm", "next", "optax.scale_by_adam", "optax.additive_weight_decay", "optax.scale_by_schedule", "optax.scale", "next", "next", "jax.max", "jax.mean", "next", "loguru.logger.info", "generator.with_key().with_visualize().with_length.with_key().with_visualize().with_length", "generator.with_key().with_visualize().with_length.iter().next", "generator.with_key().with_visualize().with_length.with_policy().iter().next", "dict", "jax.random.split", "jax.random.split", "policy", "policy", "util.models.safe_norm", "util.models.safe_norm", "util.models.safe_norm", "util.models.safe_norm", "optax.cosine_decay_schedule", "generator.with_key().with_visualize().with_length.with_policy", "util.dataset.Dataset.zip", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.sum", "jax.sum", "numpy.array", "numpy.array", "fn.replace.replace", "fn.replace.replace", "imageio.mimwrite", "imageio.mimwrite", "loguru.logger.info", "jax.vmap", "jax.vmap", "jax.jacrev", "jax.jacrev", "util.models.scale_clip_bp", "jax.random.normal", "jax.random.normal", "jax.linalg.qr", "jax.lax.broadcast_to_rank", "jax.lax.broadcast_to_rank", "jax.expand_dims", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.sum", "util.models.safe_norm", "util.models.safe_norm", "util.models.safe_norm", "jax.jacfwd", "jax.jacfwd", "jax.vmap", "jax.vmap", "generator.with_key().with_visualize().with_length.with_key().with_visualize", "generator.with_key().with_visualize().with_length.iter", "generator.with_key().with_visualize().with_length.with_policy().iter", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.sign", "jax.random.normal", "jax.random.normal", "jax.concatenate", "jax.square", "jax.jacrev", "jax.jacrev", "policy", "util.models.safe_norm", "jax.jacrev", "jax.jacrev", "jax.jacfwd", "jax.jacfwd", "min", "jax.diag", "jax.vmap", "jax.vmap", "jax.expand_dims", "jax.expand_dims", "jax.expand_dims", "util.models.safe_norm", "generator.with_key().with_visualize().with_length.with_key", "generator.with_key().with_visualize().with_length.with_policy", "jax.jacrev", "jax.jacrev", "jax.eye", "next", "jax.eye", "policy"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.envs.make_system", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.__init__.make_algorithm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_key", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.until", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.until", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.preload", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.log_info", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.eval", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.log_info", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.map", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_length", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_policy", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.zip", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.scale_clip_bp", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_visualize", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_key", "home.repos.pwc.inspect_result.unstable-zeros_tasil.imitation_learning.gym.GymGenerator.with_policy", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["", "", "def", "train", "(", "config", ")", ":", "\n", "    ", "rng", "=", "PRNGSequence", "(", "PRNGKey", "(", "config", ".", "seed", ")", ")", "\n", "d_aux_rng", "=", "next", "(", "rng", ")", "\n", "\n", "# A function to modify the data generator", "\n", "# with what we expect", "\n", "def", "data_preprocess", "(", "generator", ")", ":", "\n", "# Make sure we have annotated the data with the expert", "\n", "        ", "@", "jax", ".", "jit", "\n", "def", "add_data", "(", "traj", ",", "rng", ")", ":", "\n", "            ", "traj", "=", "dict", "(", "traj", ")", "\n", "traj", "[", "'expert_u'", "]", "=", "jax", ".", "vmap", "(", "expert", ")", "(", "traj", "[", "'x'", "]", ")", "\n", "if", "config", ".", "jac_lambda", "or", "config", ".", "report_jac_error", ":", "\n", "                ", "traj", "[", "'expert_jac'", "]", "=", "jax", ".", "vmap", "(", "jax", ".", "jacrev", "(", "expert", ")", ")", "(", "traj", "[", "'x'", "]", ")", "\n", "", "if", "config", ".", "hess_lambda", "or", "config", ".", "report_hess_error", ":", "\n", "                ", "traj", "[", "'expert_hess'", "]", "=", "jax", ".", "vmap", "(", "jax", ".", "jacfwd", "(", "jax", ".", "jacrev", "(", "expert", ")", ")", ")", "(", "traj", "[", "'x'", "]", ")", "\n", "", "traj", "[", "'rng'", "]", "=", "jax", ".", "random", ".", "split", "(", "rng", ",", "traj", "[", "'x'", "]", ".", "shape", "[", "0", "]", ")", "\n", "return", "traj", "\n", "", "generator", "=", "generator", ".", "map", "(", "add_data", ",", "d_aux_rng", ")", "\n", "return", "generator", "\n", "\n", "# The base loss function", "\n", "", "def", "loss_fn", "(", "key", ",", "policy", ",", "params", ",", "sample", ",", "iteration", ",", "update_batch_stats", "=", "True", ")", ":", "\n", "        ", "x", "=", "sample", "[", "'x'", "]", "\n", "expert_u", "=", "sample", "[", "'expert_u'", "]", "\n", "\n", "if", "update_batch_stats", ":", "\n", "            ", "train_u", ",", "new_batch_stats", "=", "policy", "(", "x", ",", "update_batch_stats", "=", "True", ")", "\n", "", "else", ":", "\n", "            ", "train_u", "=", "policy", "(", "x", ")", "\n", "new_batch_stats", "=", "None", "\n", "\n", "# pi_error = jnp.sum(jnp.square(train_u - expert_u))", "\n", "", "pi_error", "=", "safe_norm", "(", "train_u", "-", "expert_u", ",", "1e-8", ")", "\n", "\n", "loss", "=", "pi_error", "\n", "stats", "=", "{", "'pi_error'", ":", "pi_error", "}", "\n", "if", "config", ".", "jac_lambda", ">", "0", "or", "config", ".", "report_jac_error", ":", "\n", "            ", "expert_jac", "=", "sample", "[", "'expert_jac'", "]", "\n", "train_jac", "=", "jax", ".", "jacrev", "(", "policy", ")", "(", "x", ")", "\n", "if", "config", ".", "jac_clip", ">", "0", ":", "\n", "                ", "train_jac", "=", "scale_clip_bp", "(", "train_jac", ",", "config", ".", "jac_clip", ")", "\n", "# jac_error = jnp.sum(jnp.square(expert_jac - train_jac))", "\n", "", "jac_error", "=", "safe_norm", "(", "expert_jac", "-", "train_jac", ",", "1e-8", ")", "\n", "loss", "=", "loss", "+", "config", ".", "jac_lambda", "*", "jac_error", "\n", "stats", "[", "'jac_error'", "]", "=", "jac_error", "\n", "stats", "[", "'jac_t_norm'", "]", "=", "safe_norm", "(", "train_jac", ",", "1e-8", ")", "\n", "stats", "[", "'jac_e_norm'", "]", "=", "safe_norm", "(", "expert_jac", ",", "1e-8", ")", "\n", "\n", "", "if", "config", ".", "diff_lambda", ">", "0", "or", "config", ".", "report_diff_error", ":", "\n", "            ", "state_dim", "=", "x", ".", "shape", "[", "-", "1", "]", "\n", "if", "config", ".", "diff_orthogonal", ">", "0", ":", "\n", "                ", "A", "=", "jax", ".", "random", ".", "normal", "(", "key", "if", "config", ".", "diff_resample", "else", "sample", "[", "'rng'", "]", ",", "\n", "(", "min", "(", "config", ".", "diff_orthogonal", ",", "state_dim", ")", ",", "state_dim", ")", ")", "\n", "Q", ",", "R", "=", "jnp", ".", "linalg", ".", "qr", "(", "A", ".", "T", ")", "\n", "diag_sign", "=", "jax", ".", "lax", ".", "broadcast_to_rank", "(", "jnp", ".", "sign", "(", "jnp", ".", "diag", "(", "R", ")", ")", ",", "rank", "=", "Q", ".", "ndim", ")", "\n", "Q", "*=", "diag_sign", "# needed for +-", "\n", "deltas", "=", "Q", ".", "T", "\n", "", "elif", "config", ".", "diff_normal", ">", "0", ":", "\n", "                ", "A", "=", "jax", ".", "random", ".", "normal", "(", "key", "if", "config", ".", "diff_resample", "else", "sample", "[", "'rng'", "]", ",", "\n", "(", "config", ".", "diff_normal", ",", "state_dim", ")", ")", "\n", "A_norms", "=", "jax", ".", "vmap", "(", "jnp", ".", "linalg", ".", "norm", ")", "(", "A", ")", "\n", "deltas", "=", "A", "/", "jnp", ".", "expand_dims", "(", "A_norms", ",", "-", "1", ")", "\n", "", "else", ":", "\n", "                ", "deltas", "=", "jnp", ".", "concatenate", "(", "(", "jnp", ".", "eye", "(", "state_dim", ")", ",", "\n", "-", "jnp", ".", "eye", "(", "state_dim", ")", ")", ")", "\n", "", "deltas", "=", "jnp", ".", "expand_dims", "(", "x", ",", "-", "2", ")", "+", "config", ".", "diff_eps", "*", "deltas", "\n", "expert_deltas", "=", "jax", ".", "vmap", "(", "expert", ")", "(", "deltas", ")", "\n", "train_deltas", "=", "jax", ".", "vmap", "(", "policy", ")", "(", "deltas", ")", "\n", "if", "config", ".", "diff_augment", ":", "\n", "                ", "aug_error", "=", "jnp", ".", "sum", "(", "jnp", ".", "square", "(", "train_deltas", "-", "expert_deltas", ")", ")", "\n", "loss", "=", "loss", "+", "config", ".", "diff_lambda", "*", "aug_error", "\n", "stats", "[", "'aug_error'", "]", "=", "aug_error", "\n", "", "else", ":", "\n", "                ", "train_diff_jac", "=", "(", "train_deltas", "-", "jnp", ".", "expand_dims", "(", "train_u", ",", "-", "2", ")", ")", "/", "config", ".", "diff_eps", "\n", "expert_diff_jac", "=", "(", "expert_deltas", "-", "jnp", ".", "expand_dims", "(", "expert_u", ",", "-", "2", ")", ")", "/", "config", ".", "diff_eps", "\n", "diff_error", "=", "safe_norm", "(", "train_diff_jac", "-", "expert_diff_jac", ",", "1e-8", ")", "\n", "loss", "=", "loss", "+", "config", ".", "diff_lambda", "*", "diff_error", "\n", "stats", "[", "'diff_error'", "]", "=", "diff_error", "\n", "stats", "[", "'diff_t_norm'", "]", "=", "safe_norm", "(", "train_diff_jac", ",", "1e-8", ")", "\n", "stats", "[", "'diff_e_norm'", "]", "=", "safe_norm", "(", "expert_diff_jac", ",", "1e-8", ")", "\n", "\n", "\n", "", "", "if", "config", ".", "hess_lambda", ">", "0", "or", "config", ".", "report_hess_error", ":", "\n", "            ", "expert_hess", "=", "sample", "[", "'expert_hess'", "]", "\n", "train_hess", "=", "jax", ".", "jacfwd", "(", "jax", ".", "jacrev", "(", "policy", ")", ")", "(", "x", ")", "\n", "\n", "hess_error", "=", "safe_norm", "(", "expert_hess", "-", "train_hess", ",", "1e-8", ")", "\n", "loss", "=", "loss", "+", "config", ".", "hess_lambda", "*", "hess_error", "\n", "stats", "[", "'hess_error'", "]", "=", "hess_error", "\n", "", "stats", "[", "'loss'", "]", "=", "loss", "\n", "return", "loss", ",", "stats", ",", "new_batch_stats", "\n", "\n", "# Create the system from the config", "\n", "", "generator", ",", "expert", ",", "policy", ",", "init_params", "=", "make_system", "(", "config", ",", "next", "(", "rng", ")", ")", "\n", "dataset_builder", "=", "functools", ".", "partial", "(", "make_dataset", ",", "generator", ",", "data_preprocess", ")", "\n", "\n", "# Setup the trainer", "\n", "opt_init", ",", "opt_update", "=", "optax", ".", "chain", "(", "\n", "# Set the parameters of Adam. Note the learning_rate is not here.", "\n", "optax", ".", "scale_by_adam", "(", "b1", "=", "0.9", ",", "b2", "=", "0.999", ",", "eps", "=", "1e-8", ")", ",", "\n", "optax", ".", "additive_weight_decay", "(", "config", ".", "weight_decay", ")", ",", "\n", "optax", ".", "scale_by_schedule", "(", "optax", ".", "cosine_decay_schedule", "(", "1.0", ",", "\n", "config", ".", "epochs", "*", "config", ".", "train_trajs", "*", "\n", "config", ".", "traj_length", "/", "config", ".", "batch_size", ")", ")", ",", "\n", "# Put a minus sign to *minimise* the loss.", "\n", "optax", ".", "scale", "(", "-", "config", ".", "learning_rate", ")", ")", "\n", "trainer", "=", "Trainer", "(", "opt_init", ",", "opt_update", ",", "config", ".", "epochs", ",", "config", ".", "batch_size", ")", "\n", "\n", "# Get the algorithm", "\n", "algo", "=", "make_algorithm", "(", "config", ".", "algorithm", ")", "\n", "\n", "# Run the algorithm", "\n", "logger", ".", "info", "(", "f'Running {config.algorithm}...'", ")", "\n", "train_stats", ",", "final_params", "=", "algo", "(", "config", ",", "next", "(", "rng", ")", ",", "expert", ",", "dataset_builder", ",", "trainer", ",", "\n", "loss_fn", ",", "policy", ",", "init_params", ")", "\n", "\n", "# Rollout under the final policy", "\n", "logger", ".", "info", "(", "'Rolling out test data...'", ")", "\n", "generator", "=", "generator", ".", "with_key", "(", "next", "(", "rng", ")", ")", "\n", "# rollout for the same key under both the expert and trained policies", "\n", "expert_test_data", "=", "generator", ".", "until", "(", "config", ".", "test_trajs", ")", "\n", "trained_test_data", "=", "generator", ".", "with_policy", "(", "lambda", "x", ",", "r", ":", "policy", "(", "final_params", ",", "x", ")", ")", ".", "until", "(", "config", ".", "test_trajs", ")", "\n", "test_dataset", "=", "Dataset", ".", "zip", "(", "expert_test_data", ",", "trained_test_data", ")", ".", "preload", "(", ")", "\n", "def", "eval_fn", "(", "key", ",", "sample", ")", ":", "\n", "        ", "expert_traj", ",", "trained_traj", "=", "sample", "\n", "final_diff", "=", "jax", ".", "vmap", "(", "lambda", "x", ":", "safe_norm", "(", "x", ",", "1e-8", ")", ")", "(", "expert_traj", "[", "'x'", "]", "-", "trained_traj", "[", "'x'", "]", ")", "\n", "# Take the L2 norm of the diff", "\n", "delta_err", "=", "jnp", ".", "max", "(", "final_diff", ")", "\n", "# evaluate the expert on the trained-model rollout", "\n", "expert_us", "=", "jax", ".", "vmap", "(", "expert", ")", "(", "trained_traj", "[", "'x'", "]", ")", "\n", "# take the difference between the expert, training us", "\n", "imitation_diff", "=", "trained_traj", "[", "'u'", "]", "-", "expert_us", "\n", "# The mean l2 error across the trajectory", "\n", "imitation_err", "=", "jnp", ".", "mean", "(", "jax", ".", "vmap", "(", "lambda", "x", ":", "safe_norm", "(", "x", ",", "1e-8", ")", ")", "(", "imitation_diff", ")", ")", "\n", "stats", "=", "{", "'delta_err'", ":", "delta_err", ",", "'mean_imitation_err'", ":", "imitation_err", "}", "\n", "\n", "# If the environment supports rewards", "\n", "if", "'r'", "in", "expert_traj", "and", "'r'", "in", "trained_traj", ":", "\n", "            ", "stats", "[", "'policy_reward'", "]", "=", "jnp", ".", "sum", "(", "trained_traj", "[", "'r'", "]", ")", "\n", "stats", "[", "'expert_reward'", "]", "=", "jnp", ".", "sum", "(", "expert_traj", "[", "'r'", "]", ")", "\n", "", "return", "stats", "\n", "\n", "\n", "", "logger", ".", "info", "(", "'Final train statistics:'", ")", "\n", "log_info", "(", "train_stats", ")", "\n", "\n", "logger", ".", "info", "(", "'Final test statistics:'", ")", "\n", "test_stats", "=", "Trainer", ".", "eval", "(", "next", "(", "rng", ")", ",", "test_dataset", ",", "eval_fn", ",", "5", ")", "\n", "log_info", "(", "test_stats", ")", "\n", "\n", "if", "config", ".", "visualize", ":", "\n", "        ", "logger", ".", "info", "(", "'Visualizing trajectory'", ")", "\n", "generator", "=", "generator", ".", "with_key", "(", "next", "(", "rng", ")", ")", ".", "with_visualize", "(", "True", ")", ".", "with_length", "(", "config", ".", "visualize_length", ")", "\n", "_", ",", "expert_vis", "=", "generator", ".", "iter", "(", ")", ".", "next", "(", ")", "\n", "_", ",", "train_vis", "=", "generator", ".", "with_policy", "(", "lambda", "x", ",", "r", ":", "policy", "(", "final_params", ",", "x", ")", ")", ".", "iter", "(", ")", ".", "next", "(", ")", "\n", "if", "'img'", "in", "expert_vis", ":", "\n", "            ", "expert_imgs", "=", "np", ".", "array", "(", "expert_vis", "[", "'img'", "]", ")", "\n", "policy_imgs", "=", "np", ".", "array", "(", "train_vis", "[", "'img'", "]", ")", "\n", "fn", "=", "f'{config.environment}'", "if", "config", ".", "jac_lambda", "==", "0", "else", "f'{config.environment}_tasil'", ";", "\n", "fn", "=", "fn", ".", "replace", "(", "'gym/'", ",", "''", ")", "\n", "fn", "=", "fn", ".", "replace", "(", "'-v3'", ",", "''", ")", "\n", "imageio", ".", "mimwrite", "(", "f\"vis_expert_{fn}.mp4\"", ",", "expert_imgs", ",", "fps", "=", "10", ")", "\n", "imageio", ".", "mimwrite", "(", "f\"vis_policy_{fn}.mp4\"", ",", "policy_imgs", ",", "fps", "=", "10", ")", "\n", "", "else", ":", "\n", "            ", "logger", ".", "info", "(", "'No images to visualize'", ")", "\n", "\n", "", "", "return", "{", "'test'", ":", "test_stats", ",", "'train'", ":", "train_stats", "}", ",", "final_params", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.MLP.__call__": [[22, 44], ["flax.merge_param", "flax.merge_param", "flax.merge_param", "enumerate", "flax.Dense", "flax.Dense", "flax.Dense", "activation_fn", "ValueError", "len", "flax.BatchNorm", "flax.BatchNorm", "flax.BatchNorm"], "methods", ["None"], ["@", "nn", ".", "compact", "\n", "def", "__call__", "(", "self", ",", "x", ",", "use_running_average", "=", "None", ")", ":", "\n", "        ", "if", "not", "self", ".", "batch_norm", ":", "\n", "            ", "use_running_average", "=", "False", "\n", "", "use_runnning_average", "=", "nn", ".", "merge_param", "(", "'use_running_average'", ",", "self", ".", "use_running_average", ",", "use_running_average", ")", "\n", "if", "self", ".", "activation", "==", "'relu'", ":", "\n", "            ", "activation_fn", "=", "jax", ".", "nn", ".", "relu", "\n", "", "elif", "self", ".", "activation", "==", "'gelu'", ":", "\n", "            ", "activation_fn", "=", "jax", ".", "nn", ".", "gelu", "\n", "", "elif", "self", ".", "activation", "==", "'tanh'", ":", "\n", "            ", "activation_fn", "=", "jax", ".", "nn", ".", "tanh", "\n", "", "else", ":", "\n", "            ", "raise", "ValueError", "(", "f\"Expected relu, tanh, or gelu, got {self.activation}\"", ")", "\n", "", "for", "(", "i", ",", "feat", ")", "in", "enumerate", "(", "self", ".", "features", ")", ":", "\n", "            ", "x", "=", "nn", ".", "Dense", "(", "feat", ",", "name", "=", "f\"layer_{i}\"", ",", "kernel_init", "=", "self", ".", "kernel_init", ",", "bias_init", "=", "self", ".", "bias_init", ")", "(", "x", ")", "\n", "if", "i", "!=", "len", "(", "self", ".", "features", ")", "-", "1", ":", "\n", "                ", "if", "self", ".", "batch_norm", ":", "\n", "                    ", "x", "=", "nn", ".", "BatchNorm", "(", "use_running_average", "=", "use_running_average", ",", "\n", "momentum", "=", "0.9", ",", "\n", "epsilon", "=", "1e-5", ",", "axis_name", "=", "'batch'", ")", "(", "x", ")", "\n", "", "x", "=", "activation_fn", "(", "x", ")", "\n", "", "", "return", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm": [[45, 59], ["jax.linalg.norm", "jax.where", "jax.where", "jax.ones_like", "jax.linalg.norm"], "function", ["None"], ["", "", "def", "safe_norm", "(", "x", ",", "min_norm", ",", "*", "args", ",", "**", "kwargs", ")", ":", "\n", "  ", "\"\"\"Returns jnp.maximum(jnp.linalg.norm(x), min_norm) with correct gradients.\n    The gradients of jnp.maximum(jnp.linalg.norm(x), min_norm) at 0.0 is NaN,\n    because jax will evaluate both branches of the jnp.maximum.\n    The version in this function will return the correct gradient of 0.0 in this\n    situation.\n    Args:\n    x: jax array.\n    min_norm: lower bound for the returned norm.\n  \"\"\"", "\n", "norm", "=", "jnp", ".", "linalg", ".", "norm", "(", "x", ",", "*", "args", ",", "**", "kwargs", ")", "\n", "x", "=", "jnp", ".", "where", "(", "norm", "<", "min_norm", ",", "jnp", ".", "ones_like", "(", "x", ")", ",", "x", ")", "\n", "return", "jnp", ".", "where", "(", "norm", "<", "min_norm", ",", "min_norm", ",", "\n", "jnp", ".", "linalg", ".", "norm", "(", "x", ",", "*", "args", ",", "**", "kwargs", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.clip_gradient": [[63, 66], ["models.clip_gradient_fwd", "models.clip_gradient_bwd"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.clip_gradient_fwd", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.clip_gradient_bwd"], ["@", "custom_vjp", "\n", "def", "clip_gradient", "(", "x", ",", "lo", ",", "hi", ")", ":", "\n", "    ", "return", "x", "# identity function", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.clip_gradient_fwd": [[67, 69], ["None"], "function", ["None"], ["", "def", "clip_gradient_fwd", "(", "x", ",", "lo", ",", "hi", ")", ":", "\n", "    ", "return", "x", ",", "(", "lo", ",", "hi", ")", "# save bounds as residuals", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.clip_gradient_bwd": [[70, 73], ["jax.clip"], "function", ["None"], ["", "def", "clip_gradient_bwd", "(", "res", ",", "g", ")", ":", "\n", "  ", "lo", ",", "hi", "=", "res", "\n", "return", "(", "jnp", ".", "clip", "(", "g", ",", "lo", ",", "hi", ")", ",", "None", ",", "None", ")", "# use None to indicate zero cotangents for lo and hi", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.scale_clip_grads": [[78, 82], ["models.safe_norm", "jax.where"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.safe_norm"], ["def", "scale_clip_grads", "(", "g", ",", "max_norm", ")", ":", "\n", "  ", "\"\"\"Clip gradients stored as a pytree of arrays to maximum norm `max_norm`.\"\"\"", "\n", "norm", "=", "safe_norm", "(", "g", ",", "1e-9", ")", "\n", "return", "jnp", ".", "where", "(", "norm", "<", "max_norm", ",", "g", ",", "g", "*", "max_norm", "/", "(", "norm", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.scale_clip_bp": [[83, 86], ["models.scale_clip_bp_fwd", "models.scale_clip_bp_bwd"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.scale_clip_bp_fwd", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.scale_clip_bp_bwd"], ["", "@", "custom_vjp", "\n", "def", "scale_clip_bp", "(", "x", ",", "max_norm", ")", ":", "\n", "    ", "return", "x", "# identity function", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.scale_clip_bp_fwd": [[87, 89], ["None"], "function", ["None"], ["", "def", "scale_clip_bp_fwd", "(", "x", ",", "max_norm", ")", ":", "\n", "    ", "return", "x", ",", "max_norm", "# save bounds as residuals", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.scale_clip_bp_bwd": [[90, 92], ["models.scale_clip_grads"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.util.models.scale_clip_grads"], ["", "def", "scale_clip_bp_bwd", "(", "max_norm", ",", "g", ")", ":", "\n", "  ", "return", "(", "scale_clip_grads", "(", "g", ",", "max_norm", ")", ",", "None", ")", "# use None to indicate zero cotangents for lo and hi", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.logging.logging_redirect_tqdm": [[6, 11], ["loguru.logger.remove", "loguru.logger.add", "tqdm.tqdm.write"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter.write"], ["@", "contextmanager", "\n", "def", "logging_redirect_tqdm", "(", ")", ":", "\n", "    ", "logger", ".", "remove", "(", ")", "\n", "logger", ".", "add", "(", "lambda", "msg", ":", "tqdm", ".", "write", "(", "msg", ",", "end", "=", "\"\"", ")", ",", "colorize", "=", "True", ")", "\n", "yield", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.timer.timed": [[5, 12], ["time.time", "time.time", "loguru.logger.info"], "function", ["None"], ["@", "contextmanager", "\n", "def", "timed", "(", "name", ")", ":", "\n", "    ", "start", "=", "time", ".", "time", "(", ")", "\n", "yield", "\n", "end", "=", "time", ".", "time", "(", ")", "\n", "elapsed", "=", "end", "-", "start", "\n", "logger", ".", "info", "(", "f\"{name} took {elapsed} seconds\"", ")", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.__init__": [[16, 22], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "opt_init", ",", "opt_update", ",", "epochs", ",", "batch_size", ",", "shuffle_buf_size", "=", "None", ")", ":", "\n", "        ", "self", ".", "opt_init", "=", "opt_init", "\n", "self", ".", "opt_update", "=", "opt_update", "\n", "self", ".", "epochs", "=", "epochs", "\n", "self", ".", "batch_size", "=", "batch_size", "\n", "self", ".", "shuffle_buf_size", "=", "shuffle_buf_size", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.train": [[23, 93], ["dataset.preload.preload.preload", "trainer.Trainer.opt_init", "util.rng.PRNGSequence", "ibar.update", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "trainer.Trainer.opt_update", "optax.apply_updates", "dataset.shuffle().batch.iter.next", "trainer.Trainer.train.iter_fn"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.preload", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["", "def", "train", "(", "self", ",", "rng", ",", "dataset", ",", "loss_fn", ",", "initial_params", ")", ":", "\n", "        ", "stats", "=", "None", "\n", "ibar", "=", "None", "\n", "def", "host_callback", "(", "s", ",", "transforms", ")", ":", "\n", "            ", "nonlocal", "stats", "\n", "nonlocal", "ibar", "\n", "stats", "=", "s", "\n", "ibar", ".", "update", "(", "1", ")", "\n", "", "@", "jax", ".", "jit", "\n", "def", "iter_fn", "(", "key", ",", "opt_state", ",", "vars", ",", "batch", ",", "iteration", ")", ":", "\n", "# Extract the params, batch stats", "\n", "            ", "params", "=", "vars", "[", "'params'", "]", "\n", "batch_stats", "=", "vars", "[", "'batch_stats'", "]", "if", "'batch_stats'", "in", "vars", "else", "None", "\n", "def", "avg_loss", "(", "params", ",", "key", ")", ":", "\n", "                ", "arg_vars", "=", "frozen_dict", ".", "freeze", "(", "{", "'params'", ":", "params", ",", "'batch_stats'", ":", "batch_stats", "}", ")", "if", "'batch_stats'", "in", "vars", "else", "frozen_dict", ".", "freeze", "(", "{", "'params'", ":", "params", "}", ")", "\n", "keys", "=", "jax", ".", "random", ".", "split", "(", "key", ",", "self", ".", "batch_size", ")", "\n", "batch_loss", ",", "stats", ",", "new_batch_stats", "=", "jax", ".", "vmap", "(", "loss_fn", ",", "in_axes", "=", "(", "0", ",", "None", ",", "0", ",", "None", ")", ",", "out_axes", "=", "(", "0", ",", "0", ",", "None", ")", ",", "axis_name", "=", "'batch'", ")", "(", "keys", ",", "arg_vars", ",", "batch", ",", "iteration", ")", "\n", "output", "=", "jnp", ".", "mean", "(", "batch_loss", ")", ",", "(", "jax", ".", "tree_util", ".", "tree_map", "(", "jnp", ".", "mean", ",", "stats", ")", ",", "new_batch_stats", ")", "\n", "return", "output", "\n", "", "key", ",", "sk", "=", "jax", ".", "random", ".", "split", "(", "key", ")", "\n", "grads", ",", "(", "stats", ",", "new_batch_stats", ")", "=", "jax", ".", "grad", "(", "avg_loss", ",", "has_aux", "=", "True", ")", "(", "params", ",", "sk", ")", "\n", "\n", "updates", ",", "new_opt_state", "=", "self", ".", "opt_update", "(", "grads", ",", "opt_state", ",", "params", ")", "\n", "new_params", "=", "optax", ".", "apply_updates", "(", "params", ",", "updates", ")", "\n", "\n", "new_vars", "=", "frozen_dict", ".", "freeze", "(", "{", "'params'", ":", "new_params", ",", "'batch_stats'", ":", "new_batch_stats", "[", "'batch_stats'", "]", "}", ")", "if", "'batch_stats'", "in", "vars", "else", "frozen_dict", ".", "freeze", "(", "{", "'params'", ":", "new_params", "}", ")", "\n", "\n", "return", "key", ",", "new_opt_state", ",", "new_vars", ",", "stats", "\n", "", "@", "jax", ".", "jit", "\n", "def", "scan_fn", "(", "state", ")", ":", "\n", "            ", "key", ",", "iterator", ",", "opt_state", ",", "params", ",", "iteration", ",", "stats", "=", "state", "\n", "new_iterator", ",", "batch", "=", "iterator", ".", "next", "(", ")", "\n", "new_key", ",", "new_opt_state", ",", "new_params", ",", "new_stats", "=", "iter_fn", "(", "key", ",", "opt_state", ",", "params", ",", "batch", ",", "iteration", ")", "\n", "# Load the stats to the host", "\n", "if", "stats", "is", "not", "None", ":", "\n", "                ", "new_stats", "=", "jax", ".", "tree_util", ".", "tree_map", "(", "lambda", "x", ",", "y", ":", "0.2", "*", "x", "+", "0.8", "*", "y", ",", "new_stats", ",", "stats", ")", "\n", "", "new_iterator", "=", "jax", ".", "experimental", ".", "host_callback", ".", "id_tap", "(", "host_callback", ",", "new_stats", ",", "result", "=", "new_iterator", ")", "\n", "return", "new_key", ",", "new_iterator", ",", "new_opt_state", ",", "new_params", ",", "iteration", "+", "1", ",", "new_stats", "\n", "", "@", "jax", ".", "jit", "\n", "def", "train_epoch", "(", "key", ",", "iterator", ",", "opt_state", ",", "params", ",", "iteration", ")", ":", "\n", "            ", "logger", ".", "debug", "(", "\"Tracing train_epoch code\"", ")", "\n", "state", "=", "key", ",", "iterator", ",", "opt_state", ",", "params", ",", "iteration", ",", "None", "\n", "# Do the first iteration manually so we get the right stats dictionary for the while loop", "\n", "state", "=", "scan_fn", "(", "state", ")", "\n", "key", ",", "_", ",", "opt_state", ",", "params", ",", "iteration", ",", "_", "=", "jax", ".", "lax", ".", "while_loop", "(", "lambda", "s", ":", "s", "[", "1", "]", ".", "has_next", ",", "scan_fn", ",", "state", ")", "\n", "return", "key", ",", "opt_state", ",", "params", ",", "iteration", "\n", "\n", "", "dataset", "=", "dataset", ".", "preload", "(", ")", "\n", "opt_state", "=", "self", ".", "opt_init", "(", "initial_params", "[", "'params'", "]", ")", "\n", "params", "=", "initial_params", "\n", "rng_seq", "=", "PRNGSequence", "(", "rng", ")", "\n", "iteration", "=", "0", "\n", "with", "timed", "(", "\"train\"", ")", ":", "\n", "            ", "with", "logging_redirect_tqdm", "(", ")", ":", "\n", "                ", "with", "tqdm", ".", "tqdm", "(", "total", "=", "self", ".", "epochs", ")", "as", "pbar", ":", "\n", "                    ", "for", "epoch", "in", "range", "(", "self", ".", "epochs", ")", ":", "\n", "                        ", "data", "=", "dataset", ".", "shuffle", "(", "next", "(", "rng_seq", ")", ",", "self", ".", "shuffle_buf_size", ")", ".", "batch", "(", "self", ".", "batch_size", ")", "\n", "with", "tqdm", ".", "tqdm", "(", "total", "=", "len", "(", "data", ")", ",", "leave", "=", "False", ")", "as", "ibar", ":", "\n", "                            ", "iterator", "=", "data", ".", "iter", "(", ")", "\n", "_", ",", "data", "=", "iterator", ".", "next", "(", ")", "\n", "_", ",", "opt_state", ",", "params", ",", "iteration", "=", "train_epoch", "(", "next", "(", "rng_seq", ")", ",", "iterator", ",", "opt_state", ",", "params", ",", "iteration", ")", "\n", "", "stats_str", "=", "' '", ".", "join", "(", "[", "'{}: {: <12g}'", ".", "format", "(", "k", ",", "v", ")", "for", "(", "k", ",", "v", ")", "in", "stats", ".", "items", "(", ")", "]", ")", "if", "stats", "is", "not", "None", "else", "''", "\n", "pbar", ".", "set_postfix_str", "(", "stats_str", ")", "\n", "pbar", ".", "update", "(", "1", ")", "\n", "\n", "\n", "", "", "", "", "return", "opt_state", ",", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.trainer.Trainer.eval": [[94, 113], ["util.rng.PRNGSequence", "dataset.batch.batch.batch", "dataset.batch.batch.iter", "jax.jit", "jax.jit", "jax.jit", "jax.jit", "jax.jit", "jax.jit", "jax.jit", "jax.jit", "jax.jit", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "jax.vmap", "dataset.batch.iter.next", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split", "jax.jit.", "jax.jit.", "jax.jit.", "next", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.sum", "jax.sum", "jax.sum", "jax.sum", "jax.sum", "jax.sum"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.batch", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["", "@", "staticmethod", "\n", "def", "eval", "(", "key", ",", "dataset", ",", "eval_fn", ",", "batch_size", ")", ":", "\n", "# Turn the entire dataset into one batch", "\n", "        ", "rng_seq", "=", "PRNGSequence", "(", "key", ")", "\n", "samples", "=", "dataset", ".", "length", "\n", "dataset", "=", "dataset", ".", "batch", "(", "batch_size", ")", "\n", "it", "=", "dataset", ".", "iter", "(", ")", "\n", "batch_eval", "=", "jax", ".", "jit", "(", "jax", ".", "vmap", "(", "eval_fn", ",", "in_axes", "=", "(", "0", ",", "0", ")", ")", ")", "\n", "data_stats", "=", "None", "\n", "while", "it", ".", "has_next", ":", "\n", "            ", "it", ",", "data", "=", "it", ".", "next", "(", ")", "\n", "keys", "=", "jax", ".", "random", ".", "split", "(", "next", "(", "rng_seq", ")", ",", "batch_size", ")", "\n", "batch_stats", "=", "batch_eval", "(", "keys", ",", "data", ")", "\n", "if", "data_stats", "is", "None", ":", "\n", "                ", "data_stats", "=", "jax", ".", "tree_util", ".", "tree_map", "(", "lambda", "x", ":", "jnp", ".", "sum", "(", "x", ",", "axis", "=", "0", ")", ",", "batch_stats", ")", "\n", "", "else", ":", "\n", "                ", "data_stats", "=", "jax", ".", "tree_util", ".", "tree_map", "(", "lambda", "d", ",", "b", ":", "d", "+", "jnp", ".", "sum", "(", "b", ",", "axis", "=", "0", ")", ",", "data_stats", ",", "batch_stats", ")", "\n", "", "", "data_stats", "=", "jax", ".", "tree_util", ".", "tree_map", "(", "lambda", "x", ":", "(", "x", "/", "samples", ")", ".", "item", "(", ")", ",", "data_stats", ")", "\n", "return", "data_stats", "", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.common_config": [[8, 12], ["items[].intersection", "dict", "set", "c.items"], "function", ["None"], ["def", "common_config", "(", "configs", ")", ":", "\n", "    ", "items", "=", "[", "set", "(", "c", ".", "items", "(", ")", ")", "for", "c", "in", "configs", "]", "\n", "common_items", "=", "items", "[", "0", "]", ".", "intersection", "(", "*", "items", "[", "1", ":", "]", ")", "\n", "return", "dict", "(", "common_items", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.diff_config": [[13, 16], ["config.items", "base_config.get"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.get"], ["", "def", "diff_config", "(", "base_config", ",", "config", ")", ":", "\n", "    ", "diff", "=", "{", "k", ":", "v", "for", "(", "k", ",", "v", ")", "in", "config", ".", "items", "(", ")", "if", "v", "!=", "base_config", ".", "get", "(", "k", ",", "None", ")", "}", "\n", "return", "diff", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.make_name": [[17, 23], ["diff.items"], "function", ["None"], ["", "def", "make_name", "(", "diff", ")", ":", "\n", "    ", "items", "=", "[", "f'{k}_{v}'", "for", "(", "k", ",", "v", ")", "in", "diff", ".", "items", "(", ")", "]", "\n", "if", "not", "items", ":", "\n", "        ", "return", "'base'", "\n", "", "else", ":", "\n", "        ", "return", "'__'", ".", "join", "(", "items", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.log_info": [[24, 27], ["dict.items", "loguru.logger.opt().info", "loguru.logger.opt"], "function", ["None"], ["", "", "def", "log_info", "(", "dict", ")", ":", "\n", "    ", "for", "(", "k", ",", "v", ")", "in", "dict", ".", "items", "(", ")", ":", "\n", "        ", "logger", ".", "opt", "(", "colors", "=", "True", ")", ".", "info", "(", "f'    <blue>{k}</blue>: {v}'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.run_all": [[28, 68], ["sweep.common_config", "enumerate", "wandb.init", "itertools.count", "os.path.join", "loguru.logger.opt().info", "os.makedirs", "len", "sweep.diff_config", "train_fn", "len", "loguru.logger.opt().info", "sweep.log_info", "stats.items", "sweep.make_name", "os.path.join", "os.path.join", "loguru.logger.opt().info", "loguru.logger.opt().info", "os.path.exists", "loguru.logger.opt", "open", "json.dump", "open", "pickle.dump", "os.path.join", "loguru.logger.opt", "loguru.logger.opt", "loguru.logger.opt"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.common_config", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.diff_config", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.log_info", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.make_name", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join"], ["", "", "def", "run_all", "(", "train_fn", ",", "configs", ",", "name", "=", "None", ",", "output_base", "=", "None", ",", "use_wandb", "=", "False", ")", ":", "\n", "    ", "sweep_base", "=", "name", "or", "\"manual_run\"", "\n", "if", "use_wandb", ":", "\n", "        ", "assert", "len", "(", "configs", ")", "==", "1", "\n", "config", "=", "configs", "[", "0", "]", "\n", "wandb", ".", "init", "(", "project", "=", "\"safe_imitation_learning\"", ",", "config", "=", "config", ")", "\n", "sweep_base", "=", "f'{wandb.run.name}__{wandb.run.id}'", "\n", "", "if", "output_base", "and", "output_base", "!=", "\"None\"", ":", "\n", "        ", "for", "i", "in", "itertools", ".", "count", "(", ")", ":", "\n", "            ", "sweep_name", "=", "f'{sweep_base}_{i}'", "if", "i", ">", "0", "else", "sweep_base", "\n", "if", "not", "os", ".", "path", ".", "exists", "(", "os", ".", "path", ".", "join", "(", "output_base", ",", "sweep_name", ")", ")", ":", "\n", "                ", "break", "\n", "", "", "output_path", "=", "os", ".", "path", ".", "join", "(", "output_base", ",", "sweep_name", ")", "\n", "logger", ".", "opt", "(", "colors", "=", "True", ")", ".", "info", "(", "f\"Using output directory <blue>{output_path}</blue>\"", ")", "\n", "os", ".", "makedirs", "(", "output_path", ",", "exist_ok", "=", "True", ")", "\n", "sweeps", "=", "len", "(", "configs", ")", "\n", "\n", "", "base_config", "=", "common_config", "(", "configs", ")", "\n", "for", "(", "i", ",", "config", ")", "in", "enumerate", "(", "configs", ")", ":", "\n", "        ", "config_diff", "=", "diff_config", "(", "base_config", ",", "config", ")", "\n", "# Diff the config and log the sweep ", "\n", "if", "sweeps", ">", "1", ":", "\n", "            ", "logger", ".", "opt", "(", "colors", "=", "True", ")", ".", "info", "(", "f\"<red>Sweep run</red> <blue>{i+1}</blue>/<blue>{sweeps}</blue>\"", ")", "\n", "log_info", "(", "config_diff", ")", "\n", "", "stats", ",", "final_params", "=", "train_fn", "(", "config", ")", "\n", "if", "use_wandb", ":", "\n", "            ", "for", "k", ",", "v", "in", "stats", ".", "items", "(", ")", ":", "\n", "                ", "wandb", ".", "run", ".", "summary", "[", "k", "]", "=", "v", "\n", "# Save the output as JSON", "\n", "", "", "if", "output_path", ":", "\n", "            ", "run_name", "=", "make_name", "(", "config_diff", ")", "\n", "output", "=", "{", "'name'", ":", "run_name", ",", "'config'", ":", "config", ",", "'config_diff'", ":", "config_diff", ",", "'stats'", ":", "stats", "}", "\n", "output_json_file", "=", "os", ".", "path", ".", "join", "(", "output_path", ",", "f'{run_name}.json'", ")", "\n", "output_weight_file", "=", "os", ".", "path", ".", "join", "(", "output_path", ",", "f'{run_name}.pk'", ")", "\n", "logger", ".", "opt", "(", "colors", "=", "True", ")", ".", "info", "(", "f\"Saving stats to <blue>{output_json_file}</blue>\"", ")", "\n", "with", "open", "(", "output_json_file", ",", "'w'", ")", "as", "f", ":", "\n", "                ", "json", ".", "dump", "(", "output", ",", "f", ")", "\n", "", "logger", ".", "opt", "(", "colors", "=", "True", ")", ".", "info", "(", "f\"Saving weights to <blue>{output_weight_file}</blue>\"", ")", "\n", "with", "open", "(", "output_weight_file", ",", "\"wb\"", ")", "as", "f", ":", "\n", "                ", "pickle", ".", "dump", "(", "output", ",", "f", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.sweep.read_all": [[69, 74], ["os.path.join"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join"], ["", "", "", "", "def", "read_all", "(", "output_base", ",", "**", "sweep_names", ")", ":", "\n", "    ", "sweeps", "=", "[", "]", "\n", "for", "s", "in", "sweep_names", ":", "\n", "        ", "sweep_path", "=", "os", ".", "path", ".", "join", "(", "output_base", ")", "\n", "", "return", "sweeps", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.rng.PRNGSequence.__init__": [[5, 12], ["isinstance", "jax.random.PRNGKey", "jax.random.PRNGKey", "jax.random.PRNGKey", "jax.random.PRNGKey", "hasattr", "hasattr", "jax.random.PRNGKey", "jax.random.PRNGKey", "jax.random.PRNGKey", "jax.random.PRNGKey"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "key_or_seed", ")", ":", "\n", "        ", "if", "isinstance", "(", "key_or_seed", ",", "int", ")", ":", "\n", "            ", "key_or_seed", "=", "jax", ".", "random", ".", "PRNGKey", "(", "key_or_seed", ")", "\n", "", "elif", "(", "hasattr", "(", "key_or_seed", ",", "\"shape\"", ")", "and", "(", "not", "key_or_seed", ".", "shape", ")", "and", "\n", "hasattr", "(", "key_or_seed", ",", "\"dtype\"", ")", "and", "key_or_seed", ".", "dtype", "==", "jnp", ".", "int32", ")", ":", "\n", "            ", "key_or_seed", "=", "jax", ".", "random", ".", "PRNGKey", "(", "key_or_seed", ")", "\n", "", "self", ".", "_key", "=", "key_or_seed", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.rng.PRNGSequence.__next__": [[13, 17], ["jax.random.split", "jax.random.split", "jax.random.split", "jax.random.split"], "methods", ["None"], ["", "def", "__next__", "(", "self", ")", ":", "\n", "        ", "k", ",", "n", "=", "jax", ".", "random", ".", "split", "(", "self", ".", "_key", ")", "\n", "self", ".", "_key", "=", "k", "\n", "return", "n", "", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.MappedDataset.__init__": [[6, 10], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "dataset", ",", "func", ",", "rng", "=", "None", ")", ":", "\n", "        ", "self", ".", "_dataset", "=", "dataset", "\n", "self", ".", "_func", "=", "func", "\n", "self", ".", "_rng", "=", "rng", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.MappedDataset.__config__": [[11, 13], ["map.MappedDataset._func.__config__", "map.MappedDataset._dataset.__config__"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "        ", "return", "{", "'map'", ":", "self", ".", "_func", ".", "__config__", "(", ")", ",", "'data'", ":", "self", ".", "_dataset", ".", "__config__", "(", ")", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.MappedDataset.length": [[14, 17], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "length", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_dataset", ".", "length", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.MappedDataset.get": [[18, 24], ["map.MappedDataset._dataset.get", "map.MappedDataset._func"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.get"], ["", "def", "get", "(", "self", ",", "i", ")", ":", "\n", "        ", "item", "=", "self", ".", "_dataset", ".", "get", "(", "i", ")", "\n", "if", "item", "is", "not", "None", ":", "\n", "            ", "return", "self", ".", "_func", "(", "item", ")", "\n", "", "else", ":", "\n", "            ", "return", "None", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.MappedDataset.iter": [[25, 27], ["map.MappedIter", "map.MappedDataset._dataset.iter"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter"], ["", "", "def", "iter", "(", "self", ")", ":", "\n", "        ", "return", "MappedIter", "(", "self", ".", "_dataset", ".", "iter", "(", ")", ",", "self", ".", "_func", ",", "self", ".", "_rng", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.MappedIter.__init__": [[29, 33], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "iter", ",", "func", ",", "rng", ")", ":", "\n", "        ", "self", ".", "iter", "=", "iter", "\n", "self", ".", "func", "=", "func", "\n", "self", ".", "rng", "=", "rng", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.MappedIter.has_next": [[34, 37], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "has_next", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "iter", ".", "has_next", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.MappedIter.next": [[38, 47], ["map.MappedIter.iter.next", "map.MappedIter.func", "jax.random.split", "map.MappedIter.func", "map.MappedIter"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["", "def", "next", "(", "self", ")", ":", "\n", "        ", "it", ",", "x", "=", "self", ".", "iter", ".", "next", "(", ")", "\n", "if", "self", ".", "rng", "is", "None", ":", "\n", "            ", "x", "=", "self", ".", "func", "(", "x", ")", "\n", "rng", "=", "None", "\n", "", "else", ":", "\n", "            ", "rng", ",", "sk", "=", "jax", ".", "random", ".", "split", "(", "self", ".", "rng", ")", "\n", "x", "=", "self", ".", "func", "(", "x", ",", "rng", ")", "\n", "", "return", "MappedIter", "(", "it", ",", "self", ".", "func", ",", "rng", ")", ",", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.FlatMappedDataset.__init__": [[49, 54], ["map.FlatMappedDataset._dataset.iter().next", "len", "func", "map.FlatMappedDataset._dataset.iter"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter"], ["    ", "def", "__init__", "(", "self", ",", "dataset", ",", "func", ")", ":", "\n", "        ", "self", ".", "_dataset", "=", "dataset", "\n", "self", ".", "_func", "=", "func", "\n", "_", ",", "first", "=", "self", ".", "_dataset", ".", "iter", "(", ")", ".", "next", "(", ")", "\n", "self", ".", "_factor", "=", "len", "(", "func", "(", "first", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.FlatMappedDataset.__config__": [[55, 57], ["map.FlatMappedDataset._func.__config__", "map.FlatMappedDataset._dataset.__config__"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "        ", "return", "{", "'map'", ":", "self", ".", "_func", ".", "__config__", "(", ")", ",", "'data'", ":", "self", ".", "_dataset", ".", "__config__", "(", ")", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.FlatMappedDataset.length": [[58, 61], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "length", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_dataset", ".", "length", "*", "self", ".", "_factor", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.FlatMappedDataset.iter": [[62, 64], ["map.FlatMappedIter", "map.FlatMappedDataset._dataset.iter"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter"], ["", "def", "iter", "(", "self", ")", ":", "\n", "        ", "return", "FlatMappedIter", "(", "self", ".", "_factor", ",", "self", ".", "_dataset", ".", "iter", "(", ")", ",", "self", ".", "_func", ",", "[", "]", ",", "0", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.FlatMappedIter.__init__": [[66, 72], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "factor", ",", "iter", ",", "func", ",", "available", ",", "available_idx", ")", ":", "\n", "        ", "self", ".", "factor", "=", "factor", "\n", "self", ".", "iter", "=", "iter", "\n", "self", ".", "func", "=", "func", "\n", "self", ".", "available", "=", "available", "\n", "self", ".", "available_idx", "=", "available_idx", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.FlatMappedIter.__repr__": [[73, 75], ["None"], "methods", ["None"], ["", "def", "__repr__", "(", "self", ")", ":", "\n", "        ", "return", "f\"flat_map @ {self.iter}\"", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.FlatMappedIter.has_next": [[76, 79], ["len"], "methods", ["None"], ["", "@", "property", "\n", "def", "has_next", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "available_idx", "<", "len", "(", "self", ".", "available", ")", "or", "self", ".", "iter", ".", "has_next", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.FlatMappedIter.next": [[80, 92], ["len", "map.FlatMappedIter.iter.next", "map.FlatMappedIter.func", "map.FlatMappedIter"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["", "def", "next", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "available_idx", "<", "len", "(", "self", ".", "available", ")", ":", "\n", "            ", "available", "=", "self", ".", "available", "\n", "idx", "=", "self", ".", "available_idx", "\n", "it", "=", "self", ".", "iter", "\n", "", "else", ":", "\n", "            ", "it", ",", "v", "=", "self", ".", "iter", ".", "next", "(", ")", "\n", "# Do the flat mapping", "\n", "available", "=", "self", ".", "func", "(", "v", ")", "\n", "idx", "=", "0", "\n", "", "x", "=", "available", "[", "idx", "]", "\n", "return", "FlatMappedIter", "(", "self", ".", "factor", ",", "it", ",", "self", ".", "func", ",", "available", ",", "idx", "+", "1", ")", ",", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.ZippedDataset.__init__": [[96, 100], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "datasets", ")", ":", "\n", "        ", "self", ".", "_datasets", "=", "datasets", "\n", "lengths", "=", "[", "d", ".", "length", "for", "d", "in", "self", ".", "_datasets", "]", "\n", "self", ".", "_len", "=", "lengths", "[", "0", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.ZippedDataset.length": [[101, 104], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "length", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_len", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.ZippedDataset.iter": [[105, 107], ["map.ZippedIterator", "v.iter"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter"], ["", "def", "iter", "(", "self", ")", ":", "\n", "        ", "return", "ZippedIterator", "(", "[", "v", ".", "iter", "(", ")", "for", "v", "in", "self", ".", "_datasets", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.ZippedIterator.__init__": [[109, 111], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "iterators", ")", ":", "\n", "        ", "self", ".", "iterators", "=", "iterators", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.ZippedIterator.has_next": [[112, 115], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "has_next", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "iterators", "[", "0", "]", ".", "has_next", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.ZippedIterator.next": [[116, 119], ["zip", "map.ZippedIterator", "i.next"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.zip", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["", "def", "next", "(", "self", ")", ":", "\n", "        ", "iterators", ",", "values", "=", "zip", "(", "*", "[", "i", ".", "next", "(", ")", "for", "i", "in", "self", ".", "iterators", "]", ")", "\n", "return", "ZippedIterator", "(", "iterators", ")", ",", "values", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.map.ZippedIterator.skip": [[120, 123], ["map.ZippedIterator", "v.skip"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.skip"], ["", "def", "skip", "(", "self", ",", "n", ")", ":", "\n", "        ", "iterators", "=", "[", "v", ".", "skip", "(", "n", ")", "for", "v", "in", "self", ".", "iterators", "]", "\n", "return", "ZippedIterator", "(", "iterators", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.config.ConfigFun.__init__": [[2, 5], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "fun", ",", "config", ")", ":", "\n", "        ", "self", ".", "fun", "=", "fun", "\n", "self", ".", "config", "=", "config", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.config.ConfigFun.__config__": [[6, 8], ["None"], "methods", ["None"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "config", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.config.ConfigFun.__call__": [[9, 11], ["config.ConfigFun.fun"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.config.fun"], ["", "def", "__call__", "(", "self", ",", "*", "args", ",", "**", "kwargs", ")", ":", "\n", "        ", "return", "self", ".", "fun", "(", "*", "args", ",", "**", "kwargs", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.config.fun": [[12, 16], ["config.ConfigFun"], "function", ["None"], ["", "", "def", "fun", "(", "config", ")", ":", "\n", "    ", "def", "do_wrap", "(", "fun", ")", ":", "\n", "        ", "return", "ConfigFun", "(", "fun", ",", "config", ")", "\n", "", "return", "do_wrap", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.ShuffledDataset.__init__": [[5, 9], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "dataset", ",", "rng", ",", "buffer_size", "=", "None", ")", ":", "\n", "        ", "self", ".", "_dataset", "=", "dataset", "\n", "self", ".", "_buffer_size", "=", "buffer_size", "\n", "self", ".", "_rng", "=", "rng", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.ShuffledDataset.length": [[10, 13], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "length", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_dataset", ".", "length", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.ShuffledDataset.iter": [[14, 20], ["jax.random.permutation", "shuffle.PermutationIterator", "shuffle.ShuffledIterator", "len", "len", "shuffle.ShuffledDataset._dataset.iter"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter"], ["", "def", "iter", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "_buffer_size", "is", "None", ":", "\n", "            ", "indices", "=", "jax", ".", "random", ".", "permutation", "(", "self", ".", "_rng", ",", "len", "(", "self", ".", "_dataset", ")", ")", "\n", "return", "PermutationIterator", "(", "self", ".", "_dataset", ",", "indices", ",", "0", ",", "len", "(", "self", ".", "_dataset", ")", ")", "\n", "", "else", ":", "\n", "            ", "return", "ShuffledIterator", "(", "self", ".", "_dataset", ".", "iter", "(", ")", ",", "self", ".", "_rng", ",", "[", "]", ",", "self", ".", "_buffer_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.PermutationIterator.__init__": [[22, 27], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "dataset", ",", "indices", ",", "off", ",", "length", ")", ":", "\n", "        ", "self", ".", "dataset", "=", "dataset", "\n", "self", ".", "indices", "=", "indices", "\n", "self", ".", "off", "=", "off", "\n", "self", ".", "len", "=", "length", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.PermutationIterator.has_next": [[28, 31], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "has_next", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "off", "<", "self", ".", "len", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.PermutationIterator.next": [[32, 36], ["shuffle.PermutationIterator.dataset.get", "shuffle.PermutationIterator"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.get"], ["", "def", "next", "(", "self", ")", ":", "\n", "        ", "idx", "=", "self", ".", "indices", "[", "self", ".", "off", "]", "\n", "x", "=", "self", ".", "dataset", ".", "get", "(", "idx", ")", "\n", "return", "PermutationIterator", "(", "self", ",", "self", ".", "dataset", ",", "self", ".", "indices", ",", "self", ".", "off", "+", "1", ",", "self", ".", "len", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.ShuffledIterator.__init__": [[38, 43], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "it", ",", "key", ",", "buffer", ",", "buffer_size", ")", ":", "\n", "        ", "self", ".", "it", "=", "it", "\n", "self", ".", "key", "=", "key", "\n", "self", ".", "buffer", "=", "buffer", "\n", "self", ".", "buffer_size", "=", "buffer_size", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.ShuffledIterator.has_next": [[44, 47], ["len"], "methods", ["None"], ["", "@", "property", "\n", "def", "has_next", "(", "self", ")", ":", "\n", "        ", "return", "len", "(", "self", ".", "buffer", ")", ">", "0", "or", "self", ".", "it", ".", "has_next", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.ShuffledIterator.next": [[48, 64], ["list", "it.next", "list.append", "jax.random.split", "jax.random.randint", "list.pop", "shuffle.ShuffledIterator", "len", "len"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["", "def", "next", "(", "self", ")", ":", "\n", "        ", "buffer", "=", "list", "(", "self", ".", "buffer", ")", "\n", "it", "=", "self", ".", "it", "\n", "# Fill the buffer as much as possible. If buffer_size is None", "\n", "# we read in the whole dataset", "\n", "while", "(", "(", "len", "(", "buffer", ")", "<", "self", ".", "buffer_size", ")", "if", "self", ".", "buffer_size", "is", "not", "None", "else", "True", ")", "and", "it", ".", "has_next", ":", "\n", "            ", "it", ",", "x", "=", "it", ".", "next", "(", ")", "\n", "buffer", ".", "append", "(", "x", ")", "\n", "", "if", "buffer", ":", "\n", "            ", "key", ",", "sk", "=", "jax", ".", "random", ".", "split", "(", "self", ".", "key", ")", "\n", "idx", "=", "jax", ".", "random", ".", "randint", "(", "sk", ",", "(", ")", ",", "0", ",", "len", "(", "buffer", ")", ")", "\n", "x", "=", "buffer", ".", "pop", "(", "idx", ")", "\n", "", "else", ":", "\n", "            ", "key", "=", "self", ".", "key", "\n", "x", "=", "None", "\n", "", "return", "ShuffledIterator", "(", "it", ",", "key", ",", "buffer", ",", "self", ".", "buffer_size", ")", ",", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.shuffle.ShuffledIterator.skip": [[65, 67], ["NotImplementedError"], "methods", ["None"], ["", "def", "skip", "(", "self", ",", "n", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", "\"TODO: Cannot skip on a shuffled iterator\"", ")", "", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter.__init__": [[26, 32], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "path", ")", ":", "\n", "        ", "self", ".", "path", "=", "path", "\n", "self", ".", "count", "=", "0", "\n", "self", ".", "buffer", "=", "[", "]", "\n", "self", ".", "current_fn", "=", "None", "\n", "self", ".", "current_file", "=", "None", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter._open_tmp": [[33, 37], ["open", "os.path.join"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join"], ["", "def", "_open_tmp", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "current_fn", "is", "None", ":", "\n", "            ", "self", ".", "current_fn", "=", "'tmp'", "\n", "self", ".", "current_file", "=", "open", "(", "path", ".", "join", "(", "self", ".", "path", ",", "self", ".", "current_fn", ")", ",", "'wb'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter._close_tmp": [[38, 47], ["io.DatasetWriter.current_file.flush", "io.DatasetWriter.current_file.close", "os.path.join", "os.path.join", "os.rename"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter.close", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join"], ["", "", "def", "_close_tmp", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "current_fn", "is", "not", "None", ":", "\n", "            ", "self", ".", "current_file", ".", "flush", "(", ")", "\n", "self", ".", "current_file", ".", "close", "(", ")", "\n", "current_path", "=", "path", ".", "join", "(", "self", ".", "path", ",", "self", ".", "current_fn", ")", "\n", "new_path", "=", "path", ".", "join", "(", "self", ".", "path", ",", "f'{self.count}.pk'", ")", "\n", "os", ".", "rename", "(", "current_path", ",", "new_path", ")", "\n", "self", ".", "current_fn", "=", "None", "\n", "self", ".", "current_file", "=", "None", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter.write": [[48, 58], ["io.DatasetWriter._open_tmp", "io.DatasetWriter.buffer.append", "jax.tree_util.tree_map", "pickle.dump", "io.DatasetWriter._close_tmp", "jax.stack"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter._open_tmp", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter._close_tmp"], ["", "", "def", "write", "(", "self", ",", "item", ")", ":", "\n", "        ", "self", ".", "_open_tmp", "(", ")", "\n", "self", ".", "buffer", ".", "append", "(", "item", ")", "\n", "self", ".", "count", "=", "self", ".", "count", "+", "1", "\n", "if", "self", ".", "count", "%", "1000", "==", "0", ":", "\n", "# Write the buffer to disk", "\n", "            ", "buffer", "=", "tree_map", "(", "lambda", "*", "args", ":", "jnp", ".", "stack", "(", "args", ")", ",", "*", "self", ".", "buffer", ")", "\n", "pickle", ".", "dump", "(", "buffer", ",", "self", ".", "current_file", ")", "\n", "self", ".", "buffer", "=", "[", "]", "\n", "self", ".", "_close_tmp", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter.close": [[59, 64], ["io.DatasetWriter._close_tmp", "jax.tree_util.tree_map", "pickle.dump", "jax.stack"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter._close_tmp"], ["", "", "def", "close", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "buffer", ":", "\n", "            ", "buffer", "=", "tree_map", "(", "lambda", "*", "args", ":", "jnp", ".", "stack", "(", "args", ")", ",", "*", "self", ".", "buffer", ")", "\n", "pickle", ".", "dump", "(", "buffer", ",", "self", ".", "current_file", ")", "\n", "", "self", ".", "_close_tmp", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter.__enter__": [[65, 67], ["None"], "methods", ["None"], ["", "def", "__enter__", "(", "self", ")", ":", "\n", "        ", "return", "self", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter.__exit__": [[68, 70], ["io.DatasetWriter.close"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter.close"], ["", "def", "__exit__", "(", "self", ",", "type", ",", "value", ",", "tb", ")", ":", "\n", "        ", "self", ".", "close", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.SavedDataset.__init__": [[72, 81], ["max", "int", "os.path.join", "os.listdir", "f.endswith", "f.rsplit"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join"], ["    ", "def", "__init__", "(", "self", ",", "path", ")", ":", "\n", "        ", "files", "=", "[", "f", "for", "f", "in", "os", ".", "listdir", "(", "path", ")", "if", "f", ".", "endswith", "(", "\".pk\"", ")", "]", "\n", "offsets", "=", "[", "int", "(", "f", ".", "rsplit", "(", "\".\"", ",", "1", ")", "[", "0", "]", ")", "for", "f", "in", "files", "]", "\n", "self", ".", "_length", "=", "max", "(", "offsets", ")", "\n", "self", ".", "_interval", "=", "offsets", "[", "0", "]", "\n", "self", ".", "_paths", "=", "[", "os", ".", "path", ".", "join", "(", "path", ",", "f", ")", "for", "f", "in", "files", "]", "\n", "\n", "self", ".", "_tmp_idx", "=", "None", "\n", "self", ".", "_tmp_loaded", "=", "None", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.SavedDataset._load": [[82, 92], ["open", "pickle.load"], "methods", ["None"], ["", "def", "_load", "(", "self", ",", "idx", ")", ":", "\n", "        ", "if", "self", ".", "_tmp_idx", "==", "idx", ":", "\n", "            ", "return", "self", ".", "_tmp_loaded", "\n", "", "else", ":", "\n", "            ", "path", "=", "self", ".", "_paths", "[", "idx", "]", "\n", "with", "open", "(", "path", ",", "'rb'", ")", "as", "f", ":", "\n", "                ", "d", "=", "pickle", ".", "load", "(", "f", ")", "\n", "self", ".", "_tmp_idx", "=", "idx", "\n", "self", ".", "_tmp_loaded", "=", "d", "\n", "", "", "return", "self", ".", "_tmp_loaded", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.SavedDataset.length": [[93, 96], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "length", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_length", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.SavedDataset.get": [[97, 105], ["io.SavedDataset._load", "jax.tree_util.tree_map", "KeyError"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.SavedDataset._load"], ["", "def", "get", "(", "self", ",", "i", ")", ":", "\n", "        ", "if", "i", ">", "self", ".", "_length", ":", "\n", "            ", "raise", "KeyError", "(", "\"Out of range\"", ")", "\n", "", "idx", "=", "i", "//", "self", ".", "_interval", "\n", "offset", "=", "i", "%", "self", ".", "_interval", "\n", "data", "=", "self", ".", "_load", "(", "idx", ")", "\n", "sample", "=", "tree_map", "(", "lambda", "x", ":", "x", "[", "offset", "]", ",", "data", ")", "\n", "return", "sample", "", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.serialize_config": [[12, 24], ["json.dumps", "isinstance", "isinstance", "isinstance", "json.JSONEncoder.default", "obj.tolist", "obj.unfreeze", "numpy.array().tolist", "numpy.array"], "function", ["None"], ["def", "serialize_config", "(", "config", ")", ":", "\n", "    ", "class", "NumpyEncoder", "(", "json", ".", "JSONEncoder", ")", ":", "\n", "        ", "def", "default", "(", "self", ",", "obj", ")", ":", "\n", "            ", "if", "isinstance", "(", "obj", ",", "np", ".", "ndarray", ")", ":", "\n", "                ", "return", "obj", ".", "tolist", "(", ")", "\n", "", "if", "isinstance", "(", "obj", ",", "flax", ".", "core", ".", "frozen_dict", ".", "FrozenDict", ")", ":", "\n", "                ", "return", "obj", ".", "unfreeze", "(", ")", "\n", "", "if", "isinstance", "(", "obj", ",", "jnp", ".", "DeviceArray", ")", ":", "\n", "                ", "return", "np", ".", "array", "(", "obj", ")", ".", "tolist", "(", ")", "\n", "", "return", "json", ".", "JSONEncoder", ".", "default", "(", "self", ",", "obj", ")", "\n", "", "", "config", "=", "json", ".", "dumps", "(", "config", ",", "cls", "=", "NumpyEncoder", ")", "\n", "return", "config", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.batch.BatchedDataset.__init__": [[6, 13], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "dataset", ",", "batch_size", ")", ":", "\n", "        ", "self", ".", "_dataset", "=", "dataset", "\n", "self", ".", "_batch_size", "=", "batch_size", "\n", "d_len", "=", "self", ".", "_dataset", ".", "length", "\n", "# Number of batches", "\n", "self", ".", "_len", "=", "(", "d_len", "+", "batch_size", "-", "1", ")", "//", "batch_size", "if", "d_len", "is", "not", "None", "else", "None", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.batch.BatchedDataset.length": [[14, 17], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "length", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_len", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.batch.BatchedDataset.iter": [[18, 20], ["batch.BatchedIter", "batch.BatchedDataset._dataset.iter"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter"], ["", "def", "iter", "(", "self", ")", ":", "\n", "        ", "return", "BatchedIter", "(", "self", ".", "_dataset", ".", "iter", "(", ")", ",", "self", ".", "_batch_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.batch.BatchedIter.__init__": [[22, 25], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "it", ",", "batch_size", ")", ":", "\n", "        ", "self", ".", "it", "=", "it", "\n", "self", ".", "batch_size", "=", "batch_size", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.batch.BatchedIter.__repr__": [[26, 28], ["None"], "methods", ["None"], ["", "def", "__repr__", "(", "self", ")", ":", "\n", "        ", "return", "f\"batch {self.batch_size} @ {self.it}\"", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.batch.BatchedIter.has_next": [[29, 32], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "has_next", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "it", ".", "has_next", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.batch.BatchedIter.next": [[33, 43], ["jax.tree_map", "jax.tree_map", "it.next", "jax.tree_map.append", "KeyError", "tree_util.tree_map.BatchedIter", "len", "jax.stack", "jax.stack"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["", "def", "next", "(", "self", ")", ":", "\n", "        ", "batch", "=", "[", "]", "\n", "it", "=", "self", ".", "it", "\n", "while", "len", "(", "batch", ")", "<", "self", ".", "batch_size", "and", "it", ".", "has_next", ":", "\n", "            ", "it", ",", "x", "=", "it", ".", "next", "(", ")", "\n", "batch", ".", "append", "(", "x", ")", "\n", "", "if", "not", "batch", ":", "\n", "            ", "raise", "KeyError", "(", "\"No elements left!\"", ")", "\n", "", "batch", "=", "tree_util", ".", "tree_map", "(", "lambda", "*", "args", ":", "jnp", ".", "stack", "(", "args", ")", ",", "*", "batch", ")", "\n", "return", "BatchedIter", "(", "it", ",", "self", ".", "batch_size", ")", ",", "batch", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.batch.BatchedIter.skip": [[44, 46], ["batch.BatchedIter", "batch.BatchedIter.it.skip"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.skip"], ["", "def", "skip", "(", "self", ",", "n", ")", ":", "\n", "        ", "return", "BatchedIter", "(", "self", ".", "it", ".", "skip", "(", "n", "*", "self", ".", "batch_size", ")", ",", "self", ".", "batch_size", ")", "", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.length": [[24, 27], ["NotImplementedError"], "methods", ["None"], ["import", "functools", "\n", "\n", "def", "make_algorithm", "(", "algorithm", ")", ":", "\n", "    ", "if", "algorithm", "==", "'bc'", ":", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.schema": [[28, 31], ["NotImplementedError"], "methods", ["None"], ["        ", "return", "bc", "\n", "", "elif", "algorithm", "==", "'dagger'", ":", "\n", "        ", "return", "dagger", "\n", "", "elif", "algorithm", "==", "'dart'", ":", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.get": [[34, 36], ["NotImplementedError"], "methods", ["None"], ["", "", "def", "train", "(", "config", ")", ":", "\n", "    ", "rng", "=", "PRNGSequence", "(", "PRNGKey", "(", "config", ".", "seed", ")", ")", "\n", "d_aux_rng", "=", "next", "(", "rng", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.iter": [[37, 39], ["__init__.SimpleIterator"], "methods", ["None"], ["\n", "# A function to modify the data generator", "\n", "# with what we expect", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.__config__": [[40, 42], ["NotImplementedError"], "methods", ["None"], ["def", "data_preprocess", "(", "generator", ")", ":", "\n", "# Make sure we have annotated the data with the expert", "\n", "        ", "@", "jax", ".", "jit", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.__len__": [[44, 50], ["TypeError"], "methods", ["None"], ["            ", "traj", "=", "dict", "(", "traj", ")", "\n", "traj", "[", "'expert_u'", "]", "=", "jax", ".", "vmap", "(", "expert", ")", "(", "traj", "[", "'x'", "]", ")", "\n", "if", "config", ".", "jac_lambda", "or", "config", ".", "report_jac_error", ":", "\n", "                ", "traj", "[", "'expert_jac'", "]", "=", "jax", ".", "vmap", "(", "jax", ".", "jacrev", "(", "expert", ")", ")", "(", "traj", "[", "'x'", "]", ")", "\n", "", "if", "config", ".", "hess_lambda", "or", "config", ".", "report_hess_error", ":", "\n", "                ", "traj", "[", "'expert_hess'", "]", "=", "jax", ".", "vmap", "(", "jax", ".", "jacfwd", "(", "jax", ".", "jacrev", "(", "expert", ")", ")", ")", "(", "traj", "[", "'x'", "]", ")", "\n", "", "traj", "[", "'rng'", "]", "=", "jax", ".", "random", ".", "split", "(", "rng", ",", "traj", "[", "'x'", "]", ".", "shape", "[", "0", "]", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.__getitem__": [[51, 55], ["isinstance", "__init__.Dataset.get", "__init__.Dataset.slice"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.get", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.slice"], ["return", "traj", "\n", "", "generator", "=", "generator", ".", "map", "(", "add_data", ",", "d_aux_rng", ")", "\n", "return", "generator", "\n", "\n", "# The base loss function", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.slice": [[57, 60], ["SlicedDataset"], "methods", ["None"], ["        ", "x", "=", "sample", "[", "'x'", "]", "\n", "expert_u", "=", "sample", "[", "'expert_u'", "]", "\n", "\n", "if", "update_batch_stats", ":", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.until": [[61, 63], ["__init__.Dataset.slice"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.slice"], ["            ", "train_u", ",", "new_batch_stats", "=", "policy", "(", "x", ",", "update_batch_stats", "=", "True", ")", "\n", "", "else", ":", "\n", "            ", "train_u", "=", "policy", "(", "x", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.batch": [[64, 67], ["BatchedDataset"], "methods", ["None"], ["new_batch_stats", "=", "None", "\n", "\n", "# pi_error = jnp.sum(jnp.square(train_u - expert_u))", "\n", "", "pi_error", "=", "safe_norm", "(", "train_u", "-", "expert_u", ",", "1e-8", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.shuffle": [[68, 71], ["ShuffledDataset"], "methods", ["None"], ["\n", "loss", "=", "pi_error", "\n", "stats", "=", "{", "'pi_error'", ":", "pi_error", "}", "\n", "if", "config", ".", "jac_lambda", ">", "0", "or", "config", ".", "report_jac_error", ":", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.map": [[72, 77], ["MappedDataset"], "methods", ["None"], ["            ", "expert_jac", "=", "sample", "[", "'expert_jac'", "]", "\n", "train_jac", "=", "jax", ".", "jacrev", "(", "policy", ")", "(", "x", ")", "\n", "if", "config", ".", "jac_clip", ">", "0", ":", "\n", "                ", "train_jac", "=", "scale_clip_bp", "(", "train_jac", ",", "config", ".", "jac_clip", ")", "\n", "# jac_error = jnp.sum(jnp.square(expert_jac - train_jac))", "\n", "", "jac_error", "=", "safe_norm", "(", "expert_jac", "-", "train_jac", ",", "1e-8", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.flat_map": [[78, 83], ["FlatMappedDataset"], "methods", ["None"], ["loss", "=", "loss", "+", "config", ".", "jac_lambda", "*", "jac_error", "\n", "stats", "[", "'jac_error'", "]", "=", "jac_error", "\n", "stats", "[", "'jac_t_norm'", "]", "=", "safe_norm", "(", "train_jac", ",", "1e-8", ")", "\n", "stats", "[", "'jac_e_norm'", "]", "=", "safe_norm", "(", "expert_jac", ",", "1e-8", ")", "\n", "\n", "", "if", "config", ".", "diff_lambda", ">", "0", "or", "config", ".", "report_diff_error", ":", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.cache": [[84, 108], ["serialize_config", "hashlib.sha256().hexdigest", "os.path.join", "os.path.exists", "loguru.logger.info", "os.makedirs", "loguru.logger.info", "SavedDataset", "__init__.Dataset.__config__", "loguru.logger.info", "SavedDataset", "DatasetWriter", "hashlib.sha256", "tqdm.tqdm", "serialize_config.encode", "util.logging.logging_redirect_tqdm", "__init__.Dataset.iter", "len", "__init__.Dataset.next", "writer.write", "pbar.update"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.serialize_config", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.logging.logging_redirect_tqdm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.io.DatasetWriter.write"], ["            ", "state_dim", "=", "x", ".", "shape", "[", "-", "1", "]", "\n", "if", "config", ".", "diff_orthogonal", ">", "0", ":", "\n", "                ", "A", "=", "jax", ".", "random", ".", "normal", "(", "key", "if", "config", ".", "diff_resample", "else", "sample", "[", "'rng'", "]", ",", "\n", "(", "min", "(", "config", ".", "diff_orthogonal", ",", "state_dim", ")", ",", "state_dim", ")", ")", "\n", "Q", ",", "R", "=", "jnp", ".", "linalg", ".", "qr", "(", "A", ".", "T", ")", "\n", "diag_sign", "=", "jax", ".", "lax", ".", "broadcast_to_rank", "(", "jnp", ".", "sign", "(", "jnp", ".", "diag", "(", "R", ")", ")", ",", "rank", "=", "Q", ".", "ndim", ")", "\n", "Q", "*=", "diag_sign", "# needed for +-", "\n", "deltas", "=", "Q", ".", "T", "\n", "", "elif", "config", ".", "diff_normal", ">", "0", ":", "\n", "                ", "A", "=", "jax", ".", "random", ".", "normal", "(", "key", "if", "config", ".", "diff_resample", "else", "sample", "[", "'rng'", "]", ",", "\n", "(", "config", ".", "diff_normal", ",", "state_dim", ")", ")", "\n", "A_norms", "=", "jax", ".", "vmap", "(", "jnp", ".", "linalg", ".", "norm", ")", "(", "A", ")", "\n", "deltas", "=", "A", "/", "jnp", ".", "expand_dims", "(", "A_norms", ",", "-", "1", ")", "\n", "", "else", ":", "\n", "                ", "deltas", "=", "jnp", ".", "concatenate", "(", "(", "jnp", ".", "eye", "(", "state_dim", ")", ",", "\n", "-", "jnp", ".", "eye", "(", "state_dim", ")", ")", ")", "\n", "", "deltas", "=", "jnp", ".", "expand_dims", "(", "x", ",", "-", "2", ")", "+", "config", ".", "diff_eps", "*", "deltas", "\n", "expert_deltas", "=", "jax", ".", "vmap", "(", "expert", ")", "(", "deltas", ")", "\n", "train_deltas", "=", "jax", ".", "vmap", "(", "policy", ")", "(", "deltas", ")", "\n", "if", "config", ".", "diff_augment", ":", "\n", "                ", "aug_error", "=", "jnp", ".", "sum", "(", "jnp", ".", "square", "(", "train_deltas", "-", "expert_deltas", ")", ")", "\n", "loss", "=", "loss", "+", "config", ".", "diff_lambda", "*", "aug_error", "\n", "stats", "[", "'aug_error'", "]", "=", "aug_error", "\n", "", "else", ":", "\n", "                ", "train_diff_jac", "=", "(", "train_deltas", "-", "jnp", ".", "expand_dims", "(", "train_u", ",", "-", "2", ")", ")", "/", "config", ".", "diff_eps", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.preload": [[109, 120], ["__init__.Dataset.iter", "jax.tree_map", "jax.tree_map", "jax.tree_map", "__init__.Dataset.from_pytree", "tqdm.tqdm", "util.logging.logging_redirect_tqdm", "jax.stack", "jax.stack", "jax.stack", "len", "__init__.Dataset.next", "jax.tree_map.append", "pbar.update"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.from_pytree", "home.repos.pwc.inspect_result.unstable-zeros_tasil.util.logging.logging_redirect_tqdm", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["expert_diff_jac", "=", "(", "expert_deltas", "-", "jnp", ".", "expand_dims", "(", "expert_u", ",", "-", "2", ")", ")", "/", "config", ".", "diff_eps", "\n", "diff_error", "=", "safe_norm", "(", "train_diff_jac", "-", "expert_diff_jac", ",", "1e-8", ")", "\n", "loss", "=", "loss", "+", "config", ".", "diff_lambda", "*", "diff_error", "\n", "stats", "[", "'diff_error'", "]", "=", "diff_error", "\n", "stats", "[", "'diff_t_norm'", "]", "=", "safe_norm", "(", "train_diff_jac", ",", "1e-8", ")", "\n", "stats", "[", "'diff_e_norm'", "]", "=", "safe_norm", "(", "expert_diff_jac", ",", "1e-8", ")", "\n", "\n", "\n", "", "", "if", "config", ".", "hess_lambda", ">", "0", "or", "config", ".", "report_hess_error", ":", "\n", "            ", "expert_hess", "=", "sample", "[", "'expert_hess'", "]", "\n", "train_hess", "=", "jax", ".", "jacfwd", "(", "jax", ".", "jacrev", "(", "policy", ")", ")", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.zip": [[121, 125], ["ZippedDataset"], "methods", ["None"], ["hess_error", "=", "safe_norm", "(", "expert_hess", "-", "train_hess", ",", "1e-8", ")", "\n", "loss", "=", "loss", "+", "config", ".", "hess_lambda", "*", "hess_error", "\n", "stats", "[", "'hess_error'", "]", "=", "hess_error", "\n", "", "stats", "[", "'loss'", "]", "=", "loss", "\n", "return", "loss", ",", "stats", ",", "new_batch_stats", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.join": [[126, 130], ["jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "__init__.PyTreeDataset", "jax.concatenate", "jax.concatenate", "jax.concatenate"], "methods", ["None"], ["\n", "# Create the system from the config", "\n", "", "generator", ",", "expert", ",", "policy", ",", "init_params", "=", "make_system", "(", "config", ",", "next", "(", "rng", ")", ")", "\n", "dataset_builder", "=", "functools", ".", "partial", "(", "make_dataset", ",", "generator", ",", "data_preprocess", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.Dataset.from_pytree": [[131, 134], ["__init__.PyTreeDataset"], "methods", ["None"], ["# Setup the trainer", "\n", "opt_init", ",", "opt_update", "=", "optax", ".", "chain", "(", "\n", "# Set the parameters of Adam. Note the learning_rate is not here.", "\n", "optax", ".", "scale_by_adam", "(", "b1", "=", "0.9", ",", "b2", "=", "0.999", ",", "eps", "=", "1e-8", ")", ",", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.DatasetIterator.has_next": [[137, 140], ["NotImplementedError"], "methods", ["None"], ["config", ".", "epochs", "*", "config", ".", "train_trajs", "*", "\n", "config", ".", "traj_length", "/", "config", ".", "batch_size", ")", ")", ",", "\n", "# Put a minus sign to *minimise* the loss.", "\n", "optax", ".", "scale", "(", "-", "config", ".", "learning_rate", ")", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.DatasetIterator.next": [[141, 143], ["NotImplementedError"], "methods", ["None"], ["trainer", "=", "Trainer", "(", "opt_init", ",", "opt_update", ",", "config", ".", "epochs", ",", "config", ".", "batch_size", ")", "\n", "\n", "# Get the algorithm", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.DatasetIterator.skip": [[144, 149], ["range", "__init__.DatasetIterator.next"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], ["algo", "=", "make_algorithm", "(", "config", ".", "algorithm", ")", "\n", "\n", "# Run the algorithm", "\n", "logger", ".", "info", "(", "f'Running {config.algorithm}...'", ")", "\n", "train_stats", ",", "final_params", "=", "algo", "(", "config", ",", "next", "(", "rng", ")", ",", "expert", ",", "dataset_builder", ",", "trainer", ",", "\n", "loss_fn", ",", "policy", ",", "init_params", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.DatasetIterator.stream": [[151, 155], ["__init__.DatasetIterator.next", "__init__.JaxLoaderHost.make", "__init__.JaxLoader", "jax.array", "jax.array", "jax.array"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoaderHost.make"], ["# Rollout under the final policy", "\n", "logger", ".", "info", "(", "'Rolling out test data...'", ")", "\n", "generator", "=", "generator", ".", "with_key", "(", "next", "(", "rng", ")", ")", "\n", "# rollout for the same key under both the expert and trained policies", "\n", "expert_test_data", "=", "generator", ".", "until", "(", "config", ".", "test_trajs", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.SimpleIterator.__init__": [[160, 163], ["None"], "methods", ["None"], ["        ", "expert_traj", ",", "trained_traj", "=", "sample", "\n", "final_diff", "=", "jax", ".", "vmap", "(", "lambda", "x", ":", "safe_norm", "(", "x", ",", "1e-8", ")", ")", "(", "expert_traj", "[", "'x'", "]", "-", "trained_traj", "[", "'x'", "]", ")", "\n", "# Take the L2 norm of the diff", "\n", "delta_err", "=", "jnp", ".", "max", "(", "final_diff", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.SimpleIterator.has_next": [[164, 167], ["None"], "methods", ["None"], ["# evaluate the expert on the trained-model rollout", "\n", "expert_us", "=", "jax", ".", "vmap", "(", "expert", ")", "(", "trained_traj", "[", "'x'", "]", ")", "\n", "# take the difference between the expert, training us", "\n", "imitation_diff", "=", "trained_traj", "[", "'u'", "]", "-", "expert_us", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.SimpleIterator.next": [[168, 170], ["__init__.SimpleIterator", "__init__.SimpleIterator.dataset.get"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.get"], ["# The mean l2 error across the trajectory", "\n", "imitation_err", "=", "jnp", ".", "mean", "(", "jax", ".", "vmap", "(", "lambda", "x", ":", "safe_norm", "(", "x", ",", "1e-8", ")", ")", "(", "imitation_diff", ")", ")", "\n", "stats", "=", "{", "'delta_err'", ":", "delta_err", ",", "'mean_imitation_err'", ":", "imitation_err", "}", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.SimpleIterator.skip": [[171, 173], ["__init__.SimpleIterator"], "methods", ["None"], ["\n", "# If the environment supports rewards", "\n", "if", "'r'", "in", "expert_traj", "and", "'r'", "in", "trained_traj", ":", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.SimpleIterator.tree_flatten": [[174, 176], ["None"], "methods", ["None"], ["            ", "stats", "[", "'policy_reward'", "]", "=", "jnp", ".", "sum", "(", "trained_traj", "[", "'r'", "]", ")", "\n", "stats", "[", "'expert_reward'", "]", "=", "jnp", ".", "sum", "(", "expert_traj", "[", "'r'", "]", ")", "\n", "", "return", "stats", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.SimpleIterator.tree_unflatten": [[177, 180], ["cls"], "methods", ["None"], ["\n", "\n", "", "logger", ".", "info", "(", "'Final train statistics:'", ")", "\n", "log_info", "(", "train_stats", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.__init__": [[184, 193], ["jax.tree_map", "jax.tree_map", "jax.tree_map", "jax.tree_flatten", "jax.tree_flatten", "jax.tree_flatten", "jax.shape", "jax.shape", "jax.shape"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoader.tree_flatten", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoader.tree_flatten", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoader.tree_flatten"], ["log_info", "(", "test_stats", ")", "\n", "\n", "if", "config", ".", "visualize", ":", "\n", "        ", "logger", ".", "info", "(", "'Visualizing trajectory'", ")", "\n", "generator", "=", "generator", ".", "with_key", "(", "next", "(", "rng", ")", ")", ".", "with_visualize", "(", "True", ")", ".", "with_length", "(", "config", ".", "visualize_length", ")", "\n", "_", ",", "expert_vis", "=", "generator", ".", "iter", "(", ")", ".", "next", "(", ")", "\n", "_", ",", "train_vis", "=", "generator", ".", "with_policy", "(", "lambda", "x", ",", "r", ":", "policy", "(", "final_params", ",", "x", ")", ")", ".", "iter", "(", ")", ".", "next", "(", ")", "\n", "if", "'img'", "in", "expert_vis", ":", "\n", "            ", "expert_imgs", "=", "np", ".", "array", "(", "expert_vis", "[", "'img'", "]", ")", "\n", "policy_imgs", "=", "np", ".", "array", "(", "train_vis", "[", "'img'", "]", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.length": [[194, 197], ["None"], "methods", ["None"], ["fn", "=", "f'{config.environment}'", "if", "config", ".", "jac_lambda", "==", "0", "else", "f'{config.environment}_tasil'", ";", "\n", "fn", "=", "fn", ".", "replace", "(", "'gym/'", ",", "''", ")", "\n", "fn", "=", "fn", ".", "replace", "(", "'-v3'", ",", "''", ")", "\n", "imageio", ".", "mimwrite", "(", "f\"vis_expert_{fn}.mp4\"", ",", "expert_imgs", ",", "fps", "=", "10", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.get": [[198, 200], ["jax.tree_map", "jax.tree_map", "jax.tree_map"], "methods", ["None"], ["imageio", ".", "mimwrite", "(", "f\"vis_policy_{fn}.mp4\"", ",", "policy_imgs", ",", "fps", "=", "10", ")", "\n", "", "else", ":", "\n", "            ", "logger", ".", "info", "(", "'No images to visualize'", ")", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.shuffle": [[201, 205], ["jax.random.permutation", "jax.random.permutation", "jax.random.permutation", "jax.random.permutation", "jax.random.permutation", "jax.random.permutation", "jax.random.permutation", "jax.random.permutation", "jax.random.permutation", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "jax.tree_util.tree_map", "__init__.PyTreeDataset"], "methods", ["None"], ["\n", "", "", "return", "{", "'test'", ":", "test_stats", ",", "'train'", ":", "train_stats", "}", ",", "final_params", "", "", ""]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.batch": [[206, 215], ["jax.tree_map", "jax.tree_map", "jax.tree_map", "__init__.PyTreeDataset", "jax.swapaxes.reshape", "jax.swapaxes", "jax.swapaxes", "jax.swapaxes"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.preload": [[216, 218], ["None"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.tree_flatten": [[219, 221], ["None"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.PyTreeDataset.tree_unflatten": [[222, 225], ["__init__.PyTreeDataset"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoaderHost.__init__": [[227, 235], ["threading.Thread", "queue.Queue", "queue.Queue", "__init__.JaxLoaderHost._thread.start", "range", "__init__.JaxLoaderHost._take_requests.put"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoaderHost.fill": [[236, 253], ["__init__.JaxLoaderHost._take_requests.get", "range", "print", "traceback.print_exc", "sys.exit", "__init__.JaxLoaderHost._iterator.next", "__init__.JaxLoaderHost._take_queue.put"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.get", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoaderHost.take": [[254, 261], ["__init__.JaxLoaderHost._take_requests.put", "__init__.JaxLoaderHost._take_queue.get_nowait", "loguru.logger.debug", "__init__.JaxLoaderHost._take_queue.get"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.get"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoaderHost.make": [[262, 270], ["__init__.JaxLoaderHost"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoader.__init__": [[279, 284], ["None"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoader.has_next": [[285, 288], ["None"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoader.next": [[289, 294], ["jax.experimental.host_callback.call", "jax.experimental.host_callback.call", "jax.experimental.host_callback.call", "jax.experimental.host_callback.call", "jax.experimental.host_callback.call", "jax.experimental.host_callback.call", "jax.experimental.host_callback.call", "jax.experimental.host_callback.call", "jax.experimental.host_callback.call", "__init__.JaxLoader"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoader.tree_flatten": [[295, 298], ["None"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoader.tree_unflatten": [[299, 303], ["cls"], "methods", ["None"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__._loader_host_fn": [[271, 276], ["host.take", "host_id.item"], "function", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.__init__.JaxLoaderHost.take"], []], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__init__": [[4, 14], ["min"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "dataset", ",", "start", ",", "stop", ",", "step", ")", ":", "\n", "        ", "start", ",", "step", "=", "start", "or", "0", ",", "step", "or", "1", "\n", "d_len", "=", "dataset", ".", "length", "\n", "stop", "=", "min", "(", "d_len", ",", "stop", ")", "if", "stop", "is", "not", "None", "and", "d_len", "is", "not", "None", "else", "stop", "\n", "\n", "self", ".", "num", "=", "None", "if", "stop", "is", "None", "else", "(", "stop", "-", "start", ")", "//", "step", "\n", "self", ".", "dataset", "=", "dataset", "\n", "self", ".", "start", "=", "start", "\n", "self", ".", "stop", "=", "stop", "\n", "self", ".", "step", "=", "step", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__": [[15, 19], ["slice.SlicedDataset.dataset.__config__"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.__config__"], ["", "def", "__config__", "(", "self", ")", ":", "\n", "        ", "return", "{", "'sliced'", ":", "self", ".", "dataset", ".", "__config__", "(", ")", ",", "\n", "'start'", ":", "self", ".", "start", ",", "'stop'", ":", "self", ".", "stop", ",", "\n", "'step'", ":", "self", ".", "step", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.length": [[20, 23], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "length", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "num", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.get": [[24, 28], ["slice.SlicedDataset.dataset.get", "IndexError"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.get"], ["", "def", "get", "(", "self", ",", "i", ")", ":", "\n", "        ", "if", "i", ">", "self", ".", "num", ":", "\n", "            ", "raise", "IndexError", "(", "\"Out of dataset range\"", ")", "\n", "", "return", "self", ".", "dataset", ".", "get", "(", "self", ".", "start", "+", "self", ".", "step", "*", "i", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter": [[29, 35], ["slice.SlicedDataset.dataset.iter", "slice.SlicedIterator", "sub_iter.skip.skip.skip"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.iter", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.skip"], ["", "def", "iter", "(", "self", ")", ":", "\n", "        ", "sub_iter", "=", "self", ".", "dataset", ".", "iter", "(", ")", "\n", "if", "self", ".", "start", ">", "0", ":", "\n", "            ", "sub_iter", "=", "sub_iter", ".", "skip", "(", "self", ".", "start", ")", "\n", "", "remaining", "=", "None", "if", "self", ".", "stop", "is", "None", "else", "(", "self", ".", "stop", "-", "self", ".", "start", ")", "//", "self", ".", "step", "\n", "return", "SlicedIterator", "(", "sub_iter", ",", "self", ".", "step", ",", "remaining", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.slice": [[38, 46], ["slice.SlicedDataset.dataset.slice", "min"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedDataset.slice"], ["", "def", "slice", "(", "self", ",", "start", ",", "stop", ",", "step", ")", ":", "\n", "        ", "mapped_stop", "=", "stop", "*", "self", ".", "step", "if", "stop", "is", "not", "None", "else", "None", "\n", "new_stop", "=", "(", "mapped_stop", "if", "self", ".", "stop", "is", "None", "else", "\n", "self", ".", "stop", "if", "mapped_stop", "is", "None", "else", "min", "(", "mapped_stop", ",", "self", ".", "stop", ")", ")", "\n", "return", "self", ".", "dataset", ".", "slice", "(", "\n", "self", ".", "start", "+", "start", "*", "self", ".", "step", ",", "\n", "new_stop", ",", "\n", "step", "*", "self", ".", "step", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.__init__": [[48, 52], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "sub_iter", ",", "step", ",", "remaining", ")", ":", "\n", "        ", "self", ".", "sub_iter", "=", "sub_iter", "\n", "self", ".", "step", "=", "step", "\n", "self", ".", "remaining", "=", "remaining", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.has_next": [[53, 57], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "has_next", "(", "self", ")", ":", "\n", "        ", "return", "(", "self", ".", "remaining", ">", "0", "if", "self", ".", "remaining", "is", "not", "None", "else", "True", ")", "and", "self", ".", "sub_iter", ".", "has_next", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next": [[58, 70], ["slice.SlicedIterator.sub_iter.next", "sub_iter.skip.skip.skip", "slice.SlicedIterator", "StopIteration"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.next", "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.skip"], ["", "def", "next", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "remaining", "is", "not", "None", ":", "\n", "            ", "if", "self", ".", "remaining", "<=", "0", ":", "\n", "                ", "raise", "StopIteration", "(", ")", "\n", "", "remaining", "=", "self", ".", "remaining", "-", "1", "\n", "", "else", ":", "\n", "            ", "remaining", "=", "None", "\n", "\n", "", "sub_iter", ",", "x", "=", "self", ".", "sub_iter", ".", "next", "(", ")", "\n", "if", "self", ".", "step", ">", "1", ":", "\n", "            ", "sub_iter", "=", "sub_iter", ".", "skip", "(", "self", ".", "step", "-", "1", ")", "\n", "", "return", "SlicedIterator", "(", "sub_iter", ",", "self", ".", "step", ",", "remaining", ")", ",", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.skip": [[71, 74], ["slice.SlicedIterator.sub_iter.skip", "slice.SlicedIterator"], "methods", ["home.repos.pwc.inspect_result.unstable-zeros_tasil.dataset.slice.SlicedIterator.skip"], ["", "def", "skip", "(", "self", ",", "n", ")", ":", "\n", "        ", "sub_iter", "=", "self", ".", "sub_iter", ".", "skip", "(", "self", ".", "step", "*", "n", ")", "\n", "return", "SlicedIterator", "(", "sub_iter", ",", "self", ".", "step", ",", "self", ".", "remaining", "-", "n", "if", "self", ".", "remaining", "is", "not", "None", "else", "None", ")", "", "", "", ""]]}