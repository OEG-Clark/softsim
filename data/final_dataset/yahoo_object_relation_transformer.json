{"home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloaderraw.DataLoaderRaw.__init__": [[26, 84], ["opt.get", "opt.get", "opt.get", "opt.get", "opt.get", "dataloaderraw.DataLoaderRaw.my_resnet.load_state_dict", "misc.resnet_utils.myResnet", "dataloaderraw.DataLoaderRaw.my_resnet.cuda", "dataloaderraw.DataLoaderRaw.my_resnet.eval", "print", "print", "len", "print", "getattr", "torch.load", "len", "len", "print", "json.load", "enumerate", "print", "os.walk", "os.path.join", "open", "os.path.join", "dataloaderraw.DataLoaderRaw.files.append", "dataloaderraw.DataLoaderRaw.ids.append", "f.rfind", "os.path.join", "dataloaderraw.DataLoaderRaw.__init__.isImage"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "self", ".", "opt", "=", "opt", "\n", "self", ".", "coco_json", "=", "opt", ".", "get", "(", "'coco_json'", ",", "''", ")", "\n", "self", ".", "folder_path", "=", "opt", ".", "get", "(", "'folder_path'", ",", "''", ")", "\n", "self", ".", "cnn_weight_dir", "=", "opt", ".", "get", "(", "'cnn_weight_dir'", ",", "''", ")", "\n", "\n", "self", ".", "batch_size", "=", "opt", ".", "get", "(", "'batch_size'", ",", "1", ")", "\n", "self", ".", "seq_per_img", "=", "1", "\n", "\n", "# Load resnet", "\n", "self", ".", "cnn_model", "=", "opt", ".", "get", "(", "'cnn_model'", ",", "'resnet101'", ")", "\n", "self", ".", "my_resnet", "=", "getattr", "(", "misc", ".", "resnet", ",", "self", ".", "cnn_model", ")", "(", ")", "\n", "self", ".", "my_resnet", ".", "load_state_dict", "(", "torch", ".", "load", "(", "os", ".", "path", ".", "join", "(", "self", ".", "cnn_weight_dir", ",", "self", ".", "cnn_model", "+", "'.pth'", ")", ")", ")", "\n", "self", ".", "my_resnet", "=", "myResnet", "(", "self", ".", "my_resnet", ")", "\n", "self", ".", "my_resnet", ".", "cuda", "(", ")", "\n", "self", ".", "my_resnet", ".", "eval", "(", ")", "\n", "\n", "\n", "\n", "# load the json file which contains additional information about the dataset", "\n", "print", "(", "'DataLoaderRaw loading images from folder: '", ",", "self", ".", "folder_path", ")", "\n", "\n", "self", ".", "files", "=", "[", "]", "\n", "self", ".", "ids", "=", "[", "]", "\n", "\n", "print", "(", "len", "(", "self", ".", "coco_json", ")", ")", "\n", "if", "len", "(", "self", ".", "coco_json", ")", ">", "0", ":", "\n", "            ", "print", "(", "'reading from '", "+", "opt", ".", "coco_json", ")", "\n", "# read in filenames from the coco-style json file", "\n", "self", ".", "coco_annotation", "=", "json", ".", "load", "(", "open", "(", "self", ".", "coco_json", ")", ")", "\n", "for", "k", ",", "v", "in", "enumerate", "(", "self", ".", "coco_annotation", "[", "'images'", "]", ")", ":", "\n", "                ", "fullpath", "=", "os", ".", "path", ".", "join", "(", "self", ".", "folder_path", ",", "v", "[", "'file_name'", "]", ")", "\n", "self", ".", "files", ".", "append", "(", "fullpath", ")", "\n", "self", ".", "ids", ".", "append", "(", "v", "[", "'id'", "]", ")", "\n", "", "", "else", ":", "\n", "# read in all the filenames from the folder", "\n", "            ", "print", "(", "'listing all images in directory '", "+", "self", ".", "folder_path", ")", "\n", "def", "isImage", "(", "f", ")", ":", "\n", "                ", "supportedExt", "=", "[", "'.jpg'", ",", "'.JPG'", ",", "'.jpeg'", ",", "'.JPEG'", ",", "'.png'", ",", "'.PNG'", ",", "'.ppm'", ",", "'.PPM'", "]", "\n", "for", "ext", "in", "supportedExt", ":", "\n", "                    ", "start_idx", "=", "f", ".", "rfind", "(", "ext", ")", "\n", "if", "start_idx", ">=", "0", "and", "start_idx", "+", "len", "(", "ext", ")", "==", "len", "(", "f", ")", ":", "\n", "                        ", "return", "True", "\n", "", "", "return", "False", "\n", "\n", "", "n", "=", "1", "\n", "for", "root", ",", "dirs", ",", "files", "in", "os", ".", "walk", "(", "self", ".", "folder_path", ",", "topdown", "=", "False", ")", ":", "\n", "                ", "for", "file", "in", "files", ":", "\n", "                    ", "fullpath", "=", "os", ".", "path", ".", "join", "(", "self", ".", "folder_path", ",", "file", ")", "\n", "if", "isImage", "(", "fullpath", ")", ":", "\n", "                        ", "self", ".", "files", ".", "append", "(", "fullpath", ")", "\n", "self", ".", "ids", ".", "append", "(", "str", "(", "n", ")", ")", "# just order them sequentially", "\n", "n", "=", "n", "+", "1", "\n", "\n", "", "", "", "", "self", ".", "N", "=", "len", "(", "self", ".", "files", ")", "\n", "print", "(", "'DataLoaderRaw found '", ",", "self", ".", "N", ",", "' images'", ")", "\n", "\n", "self", ".", "iterator", "=", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloaderraw.DataLoaderRaw.get_batch": [[85, 131], ["numpy.ndarray", "numpy.ndarray", "range", "skimage.io.imread", "skimage.io.imread", "skimage.io.imread", "skimage.io.imread", "torch.from_numpy().cuda", "preprocess", "tmp_fc.data.cpu().float().numpy", "tmp_att.data.cpu().float().numpy", "infos.append", "len", "numpy.concatenate", "numpy.concatenate.astype", "torch.no_grad", "dataloaderraw.DataLoaderRaw.my_resnet", "torch.from_numpy", "tmp_fc.data.cpu().float", "tmp_att.data.cpu().float", "numpy.concatenate.transpose", "tmp_fc.data.cpu", "tmp_att.data.cpu"], "methods", ["None"], ["", "def", "get_batch", "(", "self", ",", "split", ",", "batch_size", "=", "None", ")", ":", "\n", "        ", "batch_size", "=", "batch_size", "or", "self", ".", "batch_size", "\n", "\n", "# pick an index of the datapoint to load next", "\n", "fc_batch", "=", "np", ".", "ndarray", "(", "(", "batch_size", ",", "2048", ")", ",", "dtype", "=", "'float32'", ")", "\n", "att_batch", "=", "np", ".", "ndarray", "(", "(", "batch_size", ",", "14", ",", "14", ",", "2048", ")", ",", "dtype", "=", "'float32'", ")", "\n", "max_index", "=", "self", ".", "N", "\n", "wrapped", "=", "False", "\n", "infos", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "batch_size", ")", ":", "\n", "            ", "ri", "=", "self", ".", "iterator", "\n", "ri_next", "=", "ri", "+", "1", "\n", "if", "ri_next", ">=", "max_index", ":", "\n", "                ", "ri_next", "=", "0", "\n", "wrapped", "=", "True", "\n", "# wrap back around", "\n", "", "self", ".", "iterator", "=", "ri_next", "\n", "\n", "img", "=", "skimage", ".", "io", ".", "imread", "(", "self", ".", "files", "[", "ri", "]", ")", "\n", "\n", "if", "len", "(", "img", ".", "shape", ")", "==", "2", ":", "\n", "                ", "img", "=", "img", "[", ":", ",", ":", ",", "np", ".", "newaxis", "]", "\n", "img", "=", "np", ".", "concatenate", "(", "(", "img", ",", "img", ",", "img", ")", ",", "axis", "=", "2", ")", "\n", "\n", "", "img", "=", "img", ".", "astype", "(", "'float32'", ")", "/", "255.0", "\n", "img", "=", "torch", ".", "from_numpy", "(", "img", ".", "transpose", "(", "[", "2", ",", "0", ",", "1", "]", ")", ")", ".", "cuda", "(", ")", "\n", "img", "=", "preprocess", "(", "img", ")", "\n", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "                ", "tmp_fc", ",", "tmp_att", "=", "self", ".", "my_resnet", "(", "img", ")", "\n", "\n", "", "fc_batch", "[", "i", "]", "=", "tmp_fc", ".", "data", ".", "cpu", "(", ")", ".", "float", "(", ")", ".", "numpy", "(", ")", "\n", "att_batch", "[", "i", "]", "=", "tmp_att", ".", "data", ".", "cpu", "(", ")", ".", "float", "(", ")", ".", "numpy", "(", ")", "\n", "\n", "info_struct", "=", "{", "}", "\n", "info_struct", "[", "'id'", "]", "=", "self", ".", "ids", "[", "ri", "]", "\n", "info_struct", "[", "'file_path'", "]", "=", "self", ".", "files", "[", "ri", "]", "\n", "infos", ".", "append", "(", "info_struct", ")", "\n", "\n", "", "data", "=", "{", "}", "\n", "data", "[", "'fc_feats'", "]", "=", "fc_batch", "\n", "data", "[", "'att_feats'", "]", "=", "att_batch", "\n", "data", "[", "'bounds'", "]", "=", "{", "'it_pos_now'", ":", "self", ".", "iterator", ",", "'it_max'", ":", "self", ".", "N", ",", "'wrapped'", ":", "wrapped", "}", "\n", "data", "[", "'infos'", "]", "=", "infos", "\n", "\n", "return", "data", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloaderraw.DataLoaderRaw.reset_iterator": [[132, 134], ["None"], "methods", ["None"], ["", "def", "reset_iterator", "(", "self", ",", "split", ")", ":", "\n", "        ", "self", ".", "iterator", "=", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloaderraw.DataLoaderRaw.get_vocab_size": [[135, 137], ["len"], "methods", ["None"], ["", "def", "get_vocab_size", "(", "self", ")", ":", "\n", "        ", "return", "len", "(", "self", ".", "ix_to_word", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloaderraw.DataLoaderRaw.get_vocab": [[138, 140], ["None"], "methods", ["None"], ["", "def", "get_vocab", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "ix_to_word", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.opts.parse_opt": [[3, 172], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["None"], ["def", "parse_opt", "(", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", ")", "\n", "\n", "# Data input settings", "\n", "parser", ".", "add_argument", "(", "'--input_json'", ",", "type", "=", "str", ",", "default", "=", "'/data/captioning_data/dataset_coco.json'", ",", "\n", "help", "=", "'path to the json file containing additional info and vocab'", ")", "\n", "parser", ".", "add_argument", "(", "'--input_fc_dir'", ",", "type", "=", "str", ",", "default", "=", "'data/cocotalk_fc'", ",", "\n", "help", "=", "'path to the directory containing the preprocessed fc feats'", ")", "\n", "parser", ".", "add_argument", "(", "'--input_att_dir'", ",", "type", "=", "str", ",", "default", "=", "'data/cocotalk_att'", ",", "\n", "help", "=", "'path to the directory containing the preprocessed att feats'", ")", "\n", "parser", ".", "add_argument", "(", "'--input_box_dir'", ",", "type", "=", "str", ",", "default", "=", "'data/cocotalk_box'", ",", "\n", "help", "=", "'path to the directory containing the boxes of att feats'", ")", "\n", "parser", ".", "add_argument", "(", "'--input_rel_box_dir'", ",", "type", "=", "str", ",", "default", "=", "'/data/captioning_data/cocobu_adaptive_box_relative/'", ",", "\n", "help", "=", "\"this directory contains the bboxes in relative coordinates for the corresponding image features in --input_att_dir\"", ")", "\n", "parser", ".", "add_argument", "(", "'--input_label_h5'", ",", "type", "=", "str", ",", "default", "=", "'data/coco_label.h5'", ",", "\n", "help", "=", "'path to the h5file containing the preprocessed dataset'", ")", "\n", "parser", ".", "add_argument", "(", "'--start_from'", ",", "type", "=", "str", ",", "default", "=", "None", ",", "\n", "help", "=", "\"\"\"continue training from saved model at this path. Path must contain files saved by previous training process:\n                        'infos.pkl'         : configuration;\n                        'checkpoint'        : paths to model file(s) (created by tf).\n                                              Note: this file contains absolute paths, be careful when moving files around;\n                        'model.ckpt-*'      : file(s) with model definition (created by tf)\n                    \"\"\"", ")", "\n", "parser", ".", "add_argument", "(", "'--cached_tokens'", ",", "type", "=", "str", ",", "default", "=", "'coco-train-idxs'", ",", "\n", "help", "=", "'Cached token file for calculating cider score during self critical training.'", ")", "\n", "\n", "# Model settings", "\n", "parser", ".", "add_argument", "(", "'--caption_model'", ",", "type", "=", "str", ",", "default", "=", "\"show_tell\"", ",", "\n", "help", "=", "'show_tell, show_attend_tell, all_img, fc, att2in, att2in2, att2all2, adaatt, adaattmo, topdown, stackatt, denseatt, transformer, relation_transformer'", ")", "\n", "parser", ".", "add_argument", "(", "'--rnn_size'", ",", "type", "=", "int", ",", "default", "=", "512", ",", "\n", "help", "=", "'size of the rnn in number of hidden nodes in each layer'", ")", "\n", "parser", ".", "add_argument", "(", "'--num_layers'", ",", "type", "=", "int", ",", "default", "=", "1", ",", "\n", "help", "=", "'number of layers in the RNN'", ")", "\n", "parser", ".", "add_argument", "(", "'--rnn_type'", ",", "type", "=", "str", ",", "default", "=", "'lstm'", ",", "\n", "help", "=", "'rnn, gru, or lstm'", ")", "\n", "parser", ".", "add_argument", "(", "'--input_encoding_size'", ",", "type", "=", "int", ",", "default", "=", "512", ",", "\n", "help", "=", "'the encoding size of each token in the vocabulary, and the image.'", ")", "\n", "parser", ".", "add_argument", "(", "'--att_hid_size'", ",", "type", "=", "int", ",", "default", "=", "512", ",", "\n", "help", "=", "'the hidden size of the attention MLP; only useful in show_attend_tell; 0 if not using hidden layer'", ")", "\n", "parser", ".", "add_argument", "(", "'--fc_feat_size'", ",", "type", "=", "int", ",", "default", "=", "2048", ",", "\n", "help", "=", "'2048 for resnet, 4096 for vgg'", ")", "\n", "parser", ".", "add_argument", "(", "'--att_feat_size'", ",", "type", "=", "int", ",", "default", "=", "2048", ",", "\n", "help", "=", "'2048 for resnet, 512 for vgg'", ")", "\n", "parser", ".", "add_argument", "(", "'--logit_layers'", ",", "type", "=", "int", ",", "default", "=", "1", ",", "\n", "help", "=", "'number of layers in the RNN'", ")", "\n", "\n", "\n", "parser", ".", "add_argument", "(", "'--use_bn'", ",", "type", "=", "int", ",", "default", "=", "0", ",", "\n", "help", "=", "'If 1, then do batch_normalization first in att_embed, if 2 then do bn both in the beginning and the end of att_embed'", ")", "\n", "\n", "# feature manipulation", "\n", "parser", ".", "add_argument", "(", "'--norm_att_feat'", ",", "type", "=", "int", ",", "default", "=", "0", ",", "\n", "help", "=", "'If normalize attention features'", ")", "\n", "parser", ".", "add_argument", "(", "'--use_box'", ",", "type", "=", "int", ",", "default", "=", "0", ",", "\n", "help", "=", "'If use box features'", ")", "\n", "parser", ".", "add_argument", "(", "'--norm_box_feat'", ",", "type", "=", "int", ",", "default", "=", "0", ",", "\n", "help", "=", "'If use box, do we normalize box feature'", ")", "\n", "\n", "# Optimization: General", "\n", "parser", ".", "add_argument", "(", "'--max_epochs'", ",", "type", "=", "int", ",", "default", "=", "-", "1", ",", "\n", "help", "=", "'number of epochs'", ")", "\n", "parser", ".", "add_argument", "(", "'--batch_size'", ",", "type", "=", "int", ",", "default", "=", "16", ",", "\n", "help", "=", "'minibatch size'", ")", "\n", "parser", ".", "add_argument", "(", "'--grad_clip'", ",", "type", "=", "float", ",", "default", "=", "0.1", ",", "#5.,", "\n", "help", "=", "'clip gradients at this value'", ")", "\n", "parser", ".", "add_argument", "(", "'--drop_prob_lm'", ",", "type", "=", "float", ",", "default", "=", "0.5", ",", "\n", "help", "=", "'strength of dropout in the Language Model RNN'", ")", "\n", "parser", ".", "add_argument", "(", "'--self_critical_after'", ",", "type", "=", "int", ",", "default", "=", "-", "1", ",", "\n", "help", "=", "'After what epoch do we start finetuning the CNN? (-1 = disable; never finetune, 0 = finetune from start)'", ")", "\n", "parser", ".", "add_argument", "(", "'--seq_per_img'", ",", "type", "=", "int", ",", "default", "=", "5", ",", "\n", "help", "=", "'number of captions to sample for each image during training. Done for efficiency since CNN forward pass is expensive. E.g. coco has 5 sents/image'", ")", "\n", "parser", ".", "add_argument", "(", "'--beam_size'", ",", "type", "=", "int", ",", "default", "=", "1", ",", "\n", "help", "=", "'used when sample_max = 1, indicates number of beams in beam search. Usually 2 or 3 works well. More is not better. Set this to 1 for faster runtime but a bit worse performance.'", ")", "\n", "\n", "#Optimization: for the Language Model", "\n", "parser", ".", "add_argument", "(", "'--optim'", ",", "type", "=", "str", ",", "default", "=", "'adam'", ",", "\n", "help", "=", "'what update to use? rmsprop|sgd|sgdmom|adagrad|adam'", ")", "\n", "parser", ".", "add_argument", "(", "'--learning_rate'", ",", "type", "=", "float", ",", "default", "=", "4e-4", ",", "\n", "help", "=", "'learning rate'", ")", "\n", "parser", ".", "add_argument", "(", "'--learning_rate_decay_start'", ",", "type", "=", "int", ",", "default", "=", "-", "1", ",", "\n", "help", "=", "'at what iteration to start decaying learning rate? (-1 = dont) (in epoch)'", ")", "\n", "parser", ".", "add_argument", "(", "'--learning_rate_decay_every'", ",", "type", "=", "int", ",", "default", "=", "3", ",", "\n", "help", "=", "'every how many iterations thereafter to drop LR?(in epoch)'", ")", "\n", "parser", ".", "add_argument", "(", "'--learning_rate_decay_rate'", ",", "type", "=", "float", ",", "default", "=", "0.8", ",", "\n", "help", "=", "'every how many iterations thereafter to drop LR?(in epoch)'", ")", "\n", "parser", ".", "add_argument", "(", "'--optim_alpha'", ",", "type", "=", "float", ",", "default", "=", "0.9", ",", "\n", "help", "=", "'alpha for adam'", ")", "\n", "parser", ".", "add_argument", "(", "'--optim_beta'", ",", "type", "=", "float", ",", "default", "=", "0.999", ",", "\n", "help", "=", "'beta used for adam'", ")", "\n", "parser", ".", "add_argument", "(", "'--optim_epsilon'", ",", "type", "=", "float", ",", "default", "=", "1e-8", ",", "\n", "help", "=", "'epsilon that goes into denominator for smoothing'", ")", "\n", "parser", ".", "add_argument", "(", "'--weight_decay'", ",", "type", "=", "float", ",", "default", "=", "0", ",", "\n", "help", "=", "'weight_decay'", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--scheduled_sampling_start'", ",", "type", "=", "int", ",", "default", "=", "-", "1", ",", "\n", "help", "=", "'at what iteration to start decay gt probability'", ")", "\n", "parser", ".", "add_argument", "(", "'--scheduled_sampling_increase_every'", ",", "type", "=", "int", ",", "default", "=", "5", ",", "\n", "help", "=", "'every how many iterations thereafter to gt probability'", ")", "\n", "parser", ".", "add_argument", "(", "'--scheduled_sampling_increase_prob'", ",", "type", "=", "float", ",", "default", "=", "0.05", ",", "\n", "help", "=", "'How much to update the prob'", ")", "\n", "parser", ".", "add_argument", "(", "'--scheduled_sampling_max_prob'", ",", "type", "=", "float", ",", "default", "=", "0.25", ",", "\n", "help", "=", "'Maximum scheduled sampling prob.'", ")", "\n", "\n", "\n", "# Evaluation/Checkpointing", "\n", "parser", ".", "add_argument", "(", "'--val_images_use'", ",", "type", "=", "int", ",", "default", "=", "3200", ",", "\n", "help", "=", "'how many images to use when periodically evaluating the validation loss? (-1 = all)'", ")", "\n", "parser", ".", "add_argument", "(", "'--save_checkpoint_every'", ",", "type", "=", "int", ",", "default", "=", "2500", ",", "\n", "help", "=", "'how often to save a model checkpoint (in iterations)?'", ")", "\n", "parser", ".", "add_argument", "(", "'--checkpoint_path'", ",", "type", "=", "str", ",", "default", "=", "'save'", ",", "\n", "help", "=", "'directory to store checkpointed models'", ")", "\n", "parser", ".", "add_argument", "(", "'--language_eval'", ",", "type", "=", "int", ",", "default", "=", "0", ",", "\n", "help", "=", "'Evaluate language as well (1 = yes, 0 = no)? BLEU/CIDEr/METEOR/ROUGE_L? requires coco-caption code from Github.'", ")", "\n", "parser", ".", "add_argument", "(", "'--losses_log_every'", ",", "type", "=", "int", ",", "default", "=", "25", ",", "\n", "help", "=", "'How often do we snapshot losses, for inclusion in the progress dump? (0 = disable)'", ")", "\n", "parser", ".", "add_argument", "(", "'--load_best_score'", ",", "type", "=", "int", ",", "default", "=", "1", ",", "\n", "help", "=", "'Do we load previous best score when resuming training.'", ")", "\n", "\n", "# misc", "\n", "parser", ".", "add_argument", "(", "'--id'", ",", "type", "=", "str", ",", "default", "=", "''", ",", "\n", "help", "=", "'an id identifying this run/job. used in cross-val and appended when writing progress files'", ")", "\n", "parser", ".", "add_argument", "(", "'--train_only'", ",", "type", "=", "int", ",", "default", "=", "0", ",", "\n", "help", "=", "'if true then use 80k, else use 110k'", ")", "\n", "\n", "# Reward", "\n", "parser", ".", "add_argument", "(", "'--cider_reward_weight'", ",", "type", "=", "float", ",", "default", "=", "1", ",", "\n", "help", "=", "'The reward weight from cider'", ")", "\n", "parser", ".", "add_argument", "(", "'--bleu_reward_weight'", ",", "type", "=", "float", ",", "default", "=", "0", ",", "\n", "help", "=", "'The reward weight from bleu4'", ")", "\n", "\n", "# Transformer", "\n", "parser", ".", "add_argument", "(", "'--label_smoothing'", ",", "type", "=", "float", ",", "default", "=", "0", ",", "\n", "help", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--noamopt'", ",", "action", "=", "'store_true'", ",", "\n", "help", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--noamopt_warmup'", ",", "type", "=", "int", ",", "default", "=", "2000", ",", "\n", "help", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--noamopt_factor'", ",", "type", "=", "float", ",", "default", "=", "1", ",", "\n", "help", "=", "''", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--reduce_on_plateau'", ",", "action", "=", "'store_true'", ",", "\n", "help", "=", "''", ")", "\n", "\n", "parser", ".", "add_argument", "(", "\"--legacy_extra_skip\"", ",", "type", "=", "str2bool", ",", "default", "=", "False", ",", "\n", "help", "=", "(", "\"true only for certain legacy models that have an \"", "\n", "\"extra skip connection\"", ")", ")", "\n", "#Relative geometry", "\n", "parser", ".", "add_argument", "(", "\"--box_trignometric_embedding\"", ",", "type", "=", "str2bool", ",", "\n", "default", "=", "True", ")", "\n", "#parser.add_argument('--input_rel_box_dir',type=str, default='/data/captioning_data/cocobu_adaptive_box_relative/',", "\n", "#                help=\"this directory contains the bboxes in relative coordinates for the corresponding image features in --input_att_dir\")", "\n", "\n", "args", "=", "parser", ".", "parse_args", "(", ")", "\n", "\n", "# Check if args are valid", "\n", "assert", "args", ".", "rnn_size", ">", "0", ",", "\"rnn_size should be greater than 0\"", "\n", "assert", "args", ".", "num_layers", ">", "0", ",", "\"num_layers should be greater than 0\"", "\n", "assert", "args", ".", "input_encoding_size", ">", "0", ",", "\"input_encoding_size should be greater than 0\"", "\n", "assert", "args", ".", "batch_size", ">", "0", ",", "\"batch_size should be greater than 0\"", "\n", "assert", "args", ".", "drop_prob_lm", ">=", "0", "and", "args", ".", "drop_prob_lm", "<", "1", ",", "\"drop_prob_lm should be between 0 and 1\"", "\n", "assert", "args", ".", "seq_per_img", ">", "0", ",", "\"seq_per_img should be greater than 0\"", "\n", "assert", "args", ".", "beam_size", ">", "0", ",", "\"beam_size should be greater than 0\"", "\n", "assert", "args", ".", "save_checkpoint_every", ">", "0", ",", "\"save_checkpoint_every should be greater than 0\"", "\n", "assert", "args", ".", "losses_log_every", ">", "0", ",", "\"losses_log_every should be greater than 0\"", "\n", "assert", "args", ".", "language_eval", "==", "0", "or", "args", ".", "language_eval", "==", "1", ",", "\"language_eval should be 0 or 1\"", "\n", "assert", "args", ".", "load_best_score", "==", "0", "or", "args", ".", "load_best_score", "==", "1", ",", "\"language_eval should be 0 or 1\"", "\n", "assert", "args", ".", "train_only", "==", "0", "or", "args", ".", "train_only", "==", "1", ",", "\"language_eval should be 0 or 1\"", "\n", "\n", "return", "args", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.opts.str2bool": [[174, 181], ["v.lower", "v.lower", "argparse.ArgumentTypeError"], "function", ["None"], ["", "def", "str2bool", "(", "v", ")", ":", "\n", "    ", "if", "v", ".", "lower", "(", ")", "in", "(", "'true'", ",", "'1'", ")", ":", "\n", "        ", "return", "True", "\n", "", "elif", "v", ".", "lower", "(", ")", "in", "(", "'false'", ",", "'0'", ")", ":", "\n", "        ", "return", "False", "\n", "", "else", ":", "\n", "        ", "raise", "argparse", ".", "ArgumentTypeError", "(", "'Boolean value expected.'", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.add_summary_value": [[28, 31], ["writer.add_scalar"], "function", ["None"], ["", "def", "add_summary_value", "(", "writer", ",", "key", ",", "value", ",", "iteration", ")", ":", "\n", "    ", "if", "writer", ":", "\n", "        ", "writer", ".", "add_scalar", "(", "key", ",", "value", ",", "iteration", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.train": [[32, 259], ["misc.if_use_att", "dataloader.DataLoader", "cPickle.load.get", "cPickle.load.get", "cPickle.load.get", "cPickle.load.get", "cPickle.load.get", "cPickle.load.get", "cPickle.load.get", "cPickle.load.get", "models.setup().cuda", "torch.nn.DataParallel", "torch.nn.DataParallel", "torch.nn.DataParallel", "torch.nn.DataParallel.train", "misc.RewardCriterion", "tb.SummaryWriter", "os.path.isfile", "cPickle.load.get", "misc.LabelSmoothing", "misc.LanguageModelCriterion", "misc.get_std_opt", "os.path.isfile", "utils.build_optimizer.load_state_dict", "time.time", "dataloader.DataLoader.get_batch", "print", "torch.cuda.synchronize", "torch.cuda.synchronize", "torch.cuda.synchronize", "time.time", "utils.build_optimizer.zero_grad", "crit.backward", "misc.clip_gradient", "utils.build_optimizer.step", "crit.item", "torch.cuda.synchronize", "torch.cuda.synchronize", "torch.cuda.synchronize", "time.time", "open", "six.moves.cPickle.load", "os.path.join", "models.setup", "misc.build_optimizer", "misc.ReduceLROnPlateau", "misc.build_optimizer", "vars().get", "os.path.join", "torch.load", "torch.load", "torch.load", "utils.RewardCriterion.", "print", "print", "train.add_summary_value", "train.add_summary_value", "train.add_summary_value", "eval_kwargs.update", "eval_utils.eval_split", "train.add_summary_value", "os.path.join", "open", "six.moves.cPickle.load", "models.setup().cuda.parameters", "models.setup().cuda.parameters", "os.path.join", "misc.set_lr", "min", "misc.rewards.init_scorer", "time.time", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "utils.LanguageModelCriterion.", "utils.LanguageModelCriterion.", "torch.nn.DataParallel.", "train..", "torch.nn.DataParallel.", "train..", "torch.from_numpy().float().cuda", "torch.from_numpy().float().cuda", "torch.from_numpy().float().cuda", "utils.build_optimizer.rate", "train.add_summary_value", "numpy.mean", "vars", "lang_stats.items", "os.path.join", "torch.save", "torch.save", "torch.save", "print", "os.path.join", "torch.save", "torch.save", "torch.save", "dataloader.DataLoader.get_vocab", "os.path.join", "vars", "torch.nn.DataParallel.", "torch.nn.DataParallel.", "numpy.mean", "numpy.mean", "utils.build_optimizer.scheduler_step", "utils.build_optimizer.scheduler_step", "train.add_summary_value", "os.path.isdir", "os.makedirs", "models.setup().cuda.state_dict", "utils.build_optimizer.state_dict", "open", "six.moves.cPickle.dump", "open", "six.moves.cPickle.dump", "os.path.join", "torch.save", "torch.save", "torch.save", "print", "vars", "vars", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy().float", "torch.from_numpy().float", "torch.from_numpy().float", "os.path.join", "os.path.join", "models.setup().cuda.state_dict", "open", "six.moves.cPickle.dump", "os.path.join", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.if_use_att", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.train", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.get_std_opt", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_batch", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.clip_gradient", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.step", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.__init__.setup", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.build_optimizer", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.build_optimizer", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.add_summary_value", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.add_summary_value", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.add_summary_value", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.eval_utils.eval_split", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.add_summary_value", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.set_lr", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.rewards.init_scorer", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.rate", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.add_summary_value", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_vocab", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.scheduler_step", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.scheduler_step", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.add_summary_value", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.state_dict", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.state_dict", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.state_dict", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["", "", "def", "train", "(", "opt", ")", ":", "\n", "# Deal with feature things before anything", "\n", "    ", "opt", ".", "use_att", "=", "utils", ".", "if_use_att", "(", "opt", ".", "caption_model", ")", "\n", "\n", "loader", "=", "DataLoader", "(", "opt", ")", "\n", "\n", "opt", ".", "vocab_size", "=", "loader", ".", "vocab_size", "\n", "opt", ".", "seq_length", "=", "loader", ".", "seq_length", "\n", "\n", "tb_summary_writer", "=", "tb", "and", "tb", ".", "SummaryWriter", "(", "opt", ".", "checkpoint_path", ")", "\n", "\n", "infos", "=", "{", "}", "\n", "histories", "=", "{", "}", "\n", "if", "opt", ".", "start_from", "is", "not", "None", ":", "\n", "# open old infos and check if models are compatible", "\n", "        ", "with", "open", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "start_from", ",", "'infos_'", "+", "opt", ".", "id", "+", "'.pkl'", ")", ")", "as", "f", ":", "\n", "            ", "infos", "=", "cPickle", ".", "load", "(", "f", ")", "\n", "saved_model_opt", "=", "infos", "[", "'opt'", "]", "\n", "need_be_same", "=", "[", "\"caption_model\"", ",", "\"rnn_type\"", ",", "\"rnn_size\"", ",", "\"num_layers\"", "]", "\n", "for", "checkme", "in", "need_be_same", ":", "\n", "                ", "assert", "vars", "(", "saved_model_opt", ")", "[", "checkme", "]", "==", "vars", "(", "opt", ")", "[", "checkme", "]", ",", "\"Command line argument and saved model disagree on '%s' \"", "%", "checkme", "\n", "\n", "", "", "if", "os", ".", "path", ".", "isfile", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "start_from", ",", "'histories_'", "+", "opt", ".", "id", "+", "'.pkl'", ")", ")", ":", "\n", "            ", "with", "open", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "start_from", ",", "'histories_'", "+", "opt", ".", "id", "+", "'.pkl'", ")", ")", "as", "f", ":", "\n", "                ", "histories", "=", "cPickle", ".", "load", "(", "f", ")", "\n", "\n", "", "", "", "iteration", "=", "infos", ".", "get", "(", "'iter'", ",", "0", ")", "\n", "epoch", "=", "infos", ".", "get", "(", "'epoch'", ",", "0", ")", "\n", "\n", "val_result_history", "=", "histories", ".", "get", "(", "'val_result_history'", ",", "{", "}", ")", "\n", "loss_history", "=", "histories", ".", "get", "(", "'loss_history'", ",", "{", "}", ")", "\n", "lr_history", "=", "histories", ".", "get", "(", "'lr_history'", ",", "{", "}", ")", "\n", "ss_prob_history", "=", "histories", ".", "get", "(", "'ss_prob_history'", ",", "{", "}", ")", "\n", "\n", "loader", ".", "iterators", "=", "infos", ".", "get", "(", "'iterators'", ",", "loader", ".", "iterators", ")", "\n", "loader", ".", "split_ix", "=", "infos", ".", "get", "(", "'split_ix'", ",", "loader", ".", "split_ix", ")", "\n", "if", "opt", ".", "load_best_score", "==", "1", ":", "\n", "        ", "best_val_score", "=", "infos", ".", "get", "(", "'best_val_score'", ",", "None", ")", "\n", "\n", "", "model", "=", "models", ".", "setup", "(", "opt", ")", ".", "cuda", "(", ")", "\n", "dp_model", "=", "torch", ".", "nn", ".", "DataParallel", "(", "model", ")", "\n", "\n", "epoch_done", "=", "True", "\n", "# Assure in training mode", "\n", "dp_model", ".", "train", "(", ")", "\n", "\n", "if", "opt", ".", "label_smoothing", ">", "0", ":", "\n", "        ", "crit", "=", "utils", ".", "LabelSmoothing", "(", "smoothing", "=", "opt", ".", "label_smoothing", ")", "\n", "", "else", ":", "\n", "        ", "crit", "=", "utils", ".", "LanguageModelCriterion", "(", ")", "\n", "", "rl_crit", "=", "utils", ".", "RewardCriterion", "(", ")", "\n", "\n", "if", "opt", ".", "noamopt", ":", "\n", "        ", "assert", "opt", ".", "caption_model", "==", "'transformer'", "or", "opt", ".", "caption_model", "==", "'relation_transformer'", ",", "'noamopt can only work with transformer'", "\n", "optimizer", "=", "utils", ".", "get_std_opt", "(", "model", ",", "factor", "=", "opt", ".", "noamopt_factor", ",", "warmup", "=", "opt", ".", "noamopt_warmup", ")", "\n", "optimizer", ".", "_step", "=", "iteration", "\n", "", "elif", "opt", ".", "reduce_on_plateau", ":", "\n", "        ", "optimizer", "=", "utils", ".", "build_optimizer", "(", "model", ".", "parameters", "(", ")", ",", "opt", ")", "\n", "optimizer", "=", "utils", ".", "ReduceLROnPlateau", "(", "optimizer", ",", "factor", "=", "0.5", ",", "patience", "=", "3", ")", "\n", "", "else", ":", "\n", "        ", "optimizer", "=", "utils", ".", "build_optimizer", "(", "model", ".", "parameters", "(", ")", ",", "opt", ")", "\n", "# Load the optimizer", "\n", "", "if", "vars", "(", "opt", ")", ".", "get", "(", "'start_from'", ",", "None", ")", "is", "not", "None", "and", "os", ".", "path", ".", "isfile", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "start_from", ",", "\"optimizer.pth\"", ")", ")", ":", "\n", "        ", "optimizer", ".", "load_state_dict", "(", "torch", ".", "load", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "start_from", ",", "'optimizer.pth'", ")", ")", ")", "\n", "\n", "", "while", "True", ":", "\n", "        ", "if", "epoch_done", ":", "\n", "            ", "if", "not", "opt", ".", "noamopt", "and", "not", "opt", ".", "reduce_on_plateau", ":", "\n", "# Assign the learning rate", "\n", "                ", "if", "epoch", ">", "opt", ".", "learning_rate_decay_start", "and", "opt", ".", "learning_rate_decay_start", ">=", "0", ":", "\n", "                    ", "frac", "=", "(", "epoch", "-", "opt", ".", "learning_rate_decay_start", ")", "//", "opt", ".", "learning_rate_decay_every", "\n", "decay_factor", "=", "opt", ".", "learning_rate_decay_rate", "**", "frac", "\n", "opt", ".", "current_lr", "=", "opt", ".", "learning_rate", "*", "decay_factor", "\n", "", "else", ":", "\n", "                    ", "opt", ".", "current_lr", "=", "opt", ".", "learning_rate", "\n", "", "utils", ".", "set_lr", "(", "optimizer", ",", "opt", ".", "current_lr", ")", "# set the decayed rate", "\n", "# Assign the scheduled sampling prob", "\n", "", "if", "epoch", ">", "opt", ".", "scheduled_sampling_start", "and", "opt", ".", "scheduled_sampling_start", ">=", "0", ":", "\n", "                ", "frac", "=", "(", "epoch", "-", "opt", ".", "scheduled_sampling_start", ")", "//", "opt", ".", "scheduled_sampling_increase_every", "\n", "opt", ".", "ss_prob", "=", "min", "(", "opt", ".", "scheduled_sampling_increase_prob", "*", "frac", ",", "opt", ".", "scheduled_sampling_max_prob", ")", "\n", "model", ".", "ss_prob", "=", "opt", ".", "ss_prob", "\n", "\n", "# If start self critical training", "\n", "", "if", "opt", ".", "self_critical_after", "!=", "-", "1", "and", "epoch", ">=", "opt", ".", "self_critical_after", ":", "\n", "                ", "sc_flag", "=", "True", "\n", "init_scorer", "(", "opt", ".", "cached_tokens", ")", "\n", "", "else", ":", "\n", "                ", "sc_flag", "=", "False", "\n", "\n", "", "epoch_done", "=", "False", "\n", "\n", "", "start", "=", "time", ".", "time", "(", ")", "\n", "# Load data from train split (0)", "\n", "data", "=", "loader", ".", "get_batch", "(", "'train'", ")", "\n", "print", "(", "'Read data:'", ",", "time", ".", "time", "(", ")", "-", "start", ")", "\n", "\n", "torch", ".", "cuda", ".", "synchronize", "(", ")", "\n", "start", "=", "time", ".", "time", "(", ")", "\n", "\n", "tmp", "=", "[", "data", "[", "'fc_feats'", "]", ",", "data", "[", "'att_feats'", "]", ",", "data", "[", "'labels'", "]", ",", "data", "[", "'masks'", "]", ",", "data", "[", "'att_masks'", "]", "]", "\n", "tmp", "=", "[", "_", "if", "_", "is", "None", "else", "torch", ".", "from_numpy", "(", "_", ")", ".", "cuda", "(", ")", "for", "_", "in", "tmp", "]", "\n", "fc_feats", ",", "att_feats", ",", "labels", ",", "masks", ",", "att_masks", "=", "tmp", "\n", "if", "opt", ".", "use_box", ":", "\n", "            ", "boxes", "=", "data", "[", "'boxes'", "]", "if", "data", "[", "'boxes'", "]", "is", "None", "else", "torch", ".", "from_numpy", "(", "data", "[", "'boxes'", "]", ")", ".", "cuda", "(", ")", "\n", "\n", "", "optimizer", ".", "zero_grad", "(", ")", "\n", "\n", "if", "not", "sc_flag", ":", "\n", "            ", "if", "opt", ".", "use_box", ":", "\n", "                ", "loss", "=", "crit", "(", "dp_model", "(", "fc_feats", ",", "att_feats", ",", "boxes", ",", "labels", ",", "att_masks", ")", ",", "labels", "[", ":", ",", "1", ":", "]", ",", "masks", "[", ":", ",", "1", ":", "]", ")", "\n", "", "else", ":", "\n", "                ", "loss", "=", "crit", "(", "dp_model", "(", "fc_feats", ",", "att_feats", ",", "labels", ",", "att_masks", ")", ",", "labels", "[", ":", ",", "1", ":", "]", ",", "masks", "[", ":", ",", "1", ":", "]", ")", "\n", "", "", "else", ":", "\n", "            ", "if", "opt", ".", "use_box", ":", "\n", "                ", "gen_result", ",", "sample_logprobs", "=", "dp_model", "(", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", ",", "opt", "=", "{", "'sample_max'", ":", "0", "}", ",", "mode", "=", "'sample'", ")", "\n", "reward", "=", "get_self_critical_reward", "(", "dp_model", ",", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", ",", "data", ",", "gen_result", ",", "opt", ")", "\n", "", "else", ":", "\n", "                ", "gen_result", ",", "sample_logprobs", "=", "dp_model", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ",", "opt", "=", "{", "'sample_max'", ":", "0", "}", ",", "mode", "=", "'sample'", ")", "\n", "reward", "=", "get_self_critical_reward", "(", "dp_model", ",", "fc_feats", ",", "att_feats", ",", "None", ",", "att_masks", ",", "data", ",", "gen_result", ",", "opt", ")", "\n", "\n", "", "loss", "=", "rl_crit", "(", "sample_logprobs", ",", "gen_result", ".", "data", ",", "torch", ".", "from_numpy", "(", "reward", ")", ".", "float", "(", ")", ".", "cuda", "(", ")", ")", "\n", "\n", "", "loss", ".", "backward", "(", ")", "\n", "utils", ".", "clip_gradient", "(", "optimizer", ",", "opt", ".", "grad_clip", ")", "\n", "optimizer", ".", "step", "(", ")", "\n", "train_loss", "=", "loss", ".", "item", "(", ")", "\n", "torch", ".", "cuda", ".", "synchronize", "(", ")", "\n", "end", "=", "time", ".", "time", "(", ")", "\n", "if", "not", "sc_flag", ":", "\n", "            ", "print", "(", "\"iter {} (epoch {}), train_loss = {:.3f}, time/batch = {:.3f}\"", ".", "format", "(", "iteration", ",", "epoch", ",", "train_loss", ",", "end", "-", "start", ")", ")", "\n", "", "else", ":", "\n", "            ", "print", "(", "\"iter {} (epoch {}), avg_reward = {:.3f}, time/batch = {:.3f}\"", ".", "format", "(", "iteration", ",", "epoch", ",", "np", ".", "mean", "(", "reward", "[", ":", ",", "0", "]", ")", ",", "end", "-", "start", ")", ")", "\n", "\n", "# Update the iteration and epoch", "\n", "", "iteration", "+=", "1", "\n", "if", "data", "[", "'bounds'", "]", "[", "'wrapped'", "]", ":", "\n", "            ", "epoch", "+=", "1", "\n", "epoch_done", "=", "True", "\n", "\n", "# Write the training loss summary", "\n", "", "if", "(", "iteration", "%", "opt", ".", "losses_log_every", "==", "0", ")", ":", "\n", "            ", "add_summary_value", "(", "tb_summary_writer", ",", "'train_loss'", ",", "train_loss", ",", "iteration", ")", "\n", "if", "opt", ".", "noamopt", ":", "\n", "                ", "opt", ".", "current_lr", "=", "optimizer", ".", "rate", "(", ")", "\n", "", "elif", "opt", ".", "reduce_on_plateau", ":", "\n", "                ", "opt", ".", "current_lr", "=", "optimizer", ".", "current_lr", "\n", "", "add_summary_value", "(", "tb_summary_writer", ",", "'learning_rate'", ",", "opt", ".", "current_lr", ",", "iteration", ")", "\n", "add_summary_value", "(", "tb_summary_writer", ",", "'scheduled_sampling_prob'", ",", "model", ".", "ss_prob", ",", "iteration", ")", "\n", "if", "sc_flag", ":", "\n", "                ", "add_summary_value", "(", "tb_summary_writer", ",", "'avg_reward'", ",", "np", ".", "mean", "(", "reward", "[", ":", ",", "0", "]", ")", ",", "iteration", ")", "\n", "\n", "", "loss_history", "[", "iteration", "]", "=", "train_loss", "if", "not", "sc_flag", "else", "np", ".", "mean", "(", "reward", "[", ":", ",", "0", "]", ")", "\n", "lr_history", "[", "iteration", "]", "=", "opt", ".", "current_lr", "\n", "ss_prob_history", "[", "iteration", "]", "=", "model", ".", "ss_prob", "\n", "\n", "# make evaluation on validation set, and save model", "\n", "", "if", "(", "iteration", "%", "opt", ".", "save_checkpoint_every", "==", "0", ")", ":", "\n", "# eval model", "\n", "            ", "eval_kwargs", "=", "{", "'split'", ":", "'val'", ",", "\n", "'dataset'", ":", "opt", ".", "input_json", ",", "\n", "'use_box'", ":", "opt", ".", "use_box", "}", "\n", "eval_kwargs", ".", "update", "(", "vars", "(", "opt", ")", ")", "\n", "val_loss", ",", "predictions", ",", "lang_stats", "=", "eval_utils", ".", "eval_split", "(", "dp_model", ",", "crit", ",", "loader", ",", "eval_kwargs", ")", "\n", "\n", "if", "opt", ".", "reduce_on_plateau", ":", "\n", "                ", "if", "'CIDEr'", "in", "lang_stats", ":", "\n", "                    ", "optimizer", ".", "scheduler_step", "(", "-", "lang_stats", "[", "'CIDEr'", "]", ")", "\n", "", "else", ":", "\n", "                    ", "optimizer", ".", "scheduler_step", "(", "val_loss", ")", "\n", "\n", "# Write validation result into summary", "\n", "", "", "add_summary_value", "(", "tb_summary_writer", ",", "'validation loss'", ",", "val_loss", ",", "iteration", ")", "\n", "if", "lang_stats", ":", "\n", "                ", "for", "k", ",", "v", "in", "lang_stats", ".", "items", "(", ")", ":", "\n", "                    ", "add_summary_value", "(", "tb_summary_writer", ",", "k", ",", "v", ",", "iteration", ")", "\n", "", "", "val_result_history", "[", "iteration", "]", "=", "{", "'loss'", ":", "val_loss", ",", "'lang_stats'", ":", "lang_stats", ",", "'predictions'", ":", "predictions", "}", "\n", "\n", "# Save model if is improving on validation result", "\n", "if", "opt", ".", "language_eval", "==", "1", ":", "\n", "                ", "current_score", "=", "lang_stats", "[", "'CIDEr'", "]", "\n", "", "else", ":", "\n", "                ", "current_score", "=", "-", "val_loss", "\n", "\n", "", "best_flag", "=", "False", "\n", "if", "True", ":", "# if true", "\n", "                ", "if", "best_val_score", "is", "None", "or", "current_score", ">", "best_val_score", ":", "\n", "                    ", "best_val_score", "=", "current_score", "\n", "best_flag", "=", "True", "\n", "\n", "", "if", "not", "os", ".", "path", ".", "isdir", "(", "opt", ".", "checkpoint_path", ")", ":", "\n", "                    ", "os", ".", "makedirs", "(", "opt", ".", "checkpoint_path", ")", "\n", "", "checkpoint_path", "=", "os", ".", "path", ".", "join", "(", "opt", ".", "checkpoint_path", ",", "'model.pth'", ")", "\n", "torch", ".", "save", "(", "model", ".", "state_dict", "(", ")", ",", "checkpoint_path", ")", "\n", "print", "(", "\"model saved to {}\"", ".", "format", "(", "checkpoint_path", ")", ")", "\n", "optimizer_path", "=", "os", ".", "path", ".", "join", "(", "opt", ".", "checkpoint_path", ",", "'optimizer.pth'", ")", "\n", "torch", ".", "save", "(", "optimizer", ".", "state_dict", "(", ")", ",", "optimizer_path", ")", "\n", "\n", "# Dump miscalleous informations", "\n", "infos", "[", "'iter'", "]", "=", "iteration", "\n", "infos", "[", "'epoch'", "]", "=", "epoch", "\n", "infos", "[", "'iterators'", "]", "=", "loader", ".", "iterators", "\n", "infos", "[", "'split_ix'", "]", "=", "loader", ".", "split_ix", "\n", "infos", "[", "'best_val_score'", "]", "=", "best_val_score", "\n", "infos", "[", "'opt'", "]", "=", "opt", "\n", "infos", "[", "'vocab'", "]", "=", "loader", ".", "get_vocab", "(", ")", "\n", "\n", "histories", "[", "'val_result_history'", "]", "=", "val_result_history", "\n", "histories", "[", "'loss_history'", "]", "=", "loss_history", "\n", "histories", "[", "'lr_history'", "]", "=", "lr_history", "\n", "histories", "[", "'ss_prob_history'", "]", "=", "ss_prob_history", "\n", "with", "open", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "checkpoint_path", ",", "'infos_'", "+", "opt", ".", "id", "+", "'.pkl'", ")", ",", "'wb'", ")", "as", "f", ":", "\n", "                    ", "cPickle", ".", "dump", "(", "infos", ",", "f", ")", "\n", "", "with", "open", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "checkpoint_path", ",", "'histories_'", "+", "opt", ".", "id", "+", "'.pkl'", ")", ",", "'wb'", ")", "as", "f", ":", "\n", "                    ", "cPickle", ".", "dump", "(", "histories", ",", "f", ")", "\n", "\n", "", "if", "best_flag", ":", "\n", "                    ", "checkpoint_path", "=", "os", ".", "path", ".", "join", "(", "opt", ".", "checkpoint_path", ",", "'model-best.pth'", ")", "\n", "torch", ".", "save", "(", "model", ".", "state_dict", "(", ")", ",", "checkpoint_path", ")", "\n", "print", "(", "\"model saved to {}\"", ".", "format", "(", "checkpoint_path", ")", ")", "\n", "with", "open", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "checkpoint_path", ",", "'infos_'", "+", "opt", ".", "id", "+", "'-best.pkl'", ")", ",", "'wb'", ")", "as", "f", ":", "\n", "                        ", "cPickle", ".", "dump", "(", "infos", ",", "f", ")", "\n", "\n", "# Stop if reaching max epochs", "\n", "", "", "", "", "if", "epoch", ">=", "opt", ".", "max_epochs", "and", "opt", ".", "max_epochs", "!=", "-", "1", ":", "\n", "            ", "break", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.create_report.main": [[38, 49], ["create_report._get_command_line_arguments", "create_report._get_out_dir", "misc.report.create_report", "misc.report.ReportData.read_from_pickle", "misc.report.ReportConfig", "zip"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.create_report._get_command_line_arguments", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.create_report._get_out_dir", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.create_report", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.ReportData.read_from_pickle"], ["", "def", "main", "(", ")", ":", "\n", "    ", "args", "=", "_get_command_line_arguments", "(", ")", "\n", "base_out_dir", "=", "args", "[", "Args", ".", "BASE_OUT_DIR", "]", "\n", "add_time", "=", "args", "[", "Args", ".", "ADD_TIME", "]", "\n", "out_dir", "=", "_get_out_dir", "(", "base_out_dir", ",", "add_time", ")", "\n", "pickle_paths", "=", "args", "[", "Args", ".", "REPORT_DATA_PICKLES", "]", "\n", "run_names", "=", "args", "[", "Args", ".", "RUN_NAMES", "]", "\n", "report_data_list", "=", "[", "\n", "ReportData", ".", "read_from_pickle", "(", "pickle_path", ",", "run_name", ")", "for", "\n", "pickle_path", ",", "run_name", "in", "zip", "(", "pickle_paths", ",", "run_names", ")", "]", "\n", "create_report", "(", "report_data_list", ",", "ReportConfig", "(", "out_dir", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.create_report._get_command_line_arguments": [[51, 71], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "vars", "argparse.ArgumentParser.parse_args"], "function", ["None"], ["", "def", "_get_command_line_arguments", "(", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", ")", "\n", "parser", ".", "add_argument", "(", "\n", "'--'", "+", "Args", ".", "REPORT_DATA_PICKLES", ",", "\n", "help", "=", "'Pickle files with the ReportData objects'", ",", "required", "=", "True", ",", "\n", "nargs", "=", "'+'", ")", "\n", "parser", ".", "add_argument", "(", "\n", "'--'", "+", "Args", ".", "RUN_NAMES", ",", "help", "=", "'A name for each run'", ",", "required", "=", "True", ",", "\n", "nargs", "=", "'+'", ")", "\n", "parser", ".", "add_argument", "(", "\n", "'--'", "+", "Args", ".", "BASE_OUT_DIR", ",", "help", "=", "'Output directory'", ",", "required", "=", "True", ")", "\n", "parser", ".", "add_argument", "(", "\n", "'--'", "+", "Args", ".", "ADD_TIME", ",", "help", "=", "'Add a timestamp to the output directory'", ",", "\n", "default", "=", "False", ",", "required", "=", "False", ",", "action", "=", "'store_true'", ",", "dest", "=", "Args", ".", "ADD_TIME", ")", "\n", "parser", ".", "add_argument", "(", "\n", "'--'", "+", "Args", ".", "NO_ADD_TIME", ",", "\n", "help", "=", "'Don\\'t add a timestamp to the output directory'", ",", "\n", "required", "=", "False", ",", "action", "=", "'store_false'", ",", "dest", "=", "Args", ".", "ADD_TIME", ")", "\n", "args_dict", "=", "vars", "(", "parser", ".", "parse_args", "(", ")", ")", "\n", "return", "args_dict", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.create_report._get_out_dir": [[73, 80], ["datetime.datetime.now().strftime", "datetime.datetime.now"], "function", ["None"], ["", "def", "_get_out_dir", "(", "base_out_dir", ",", "add_time", ")", ":", "\n", "    ", "if", "add_time", ":", "\n", "        ", "date_string", "=", "datetime", ".", "now", "(", ")", ".", "strftime", "(", "'%Y-%m-%d--%H_%M_%S'", ")", "\n", "out_dir", "=", "\"%s_%s\"", "%", "(", "base_out_dir", ",", "date_string", ")", "\n", "", "else", ":", "\n", "        ", "out_dir", "=", "base_out_dir", "\n", "", "return", "out_dir", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.eval_utils.language_eval": [[25, 73], ["sys.path.append", "os.path.join", "COCO", "COCO.getImgIds", "print", "json.dump", "COCO.loadRes", "CorrectCOCOEvalCap", "coco.loadRes.getImgIds", "CorrectCOCOEvalCap.evaluate", "CorrectCOCOEvalCap.eval.items", "os.path.isdir", "os.mkdir", "open", "misc.report.ReportData", "os.path.join", "misc.report.ReportData.save_to_pickle", "open", "json.dump", "len", "len"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.ReportData.save_to_pickle"], ["def", "language_eval", "(", "dataset", ",", "preds", ",", "model_id", ",", "image_root", ",", "split", ")", ":", "\n", "    ", "import", "sys", "\n", "sys", ".", "path", ".", "append", "(", "\"coco-caption\"", ")", "\n", "annFile", "=", "'coco-caption/annotations/captions_val2014.json'", "\n", "from", "pycocotools", ".", "coco", "import", "COCO", "\n", "from", "misc", ".", "correct_coco_eval_cap", "import", "CorrectCOCOEvalCap", "\n", "\n", "# encoder.FLOAT_REPR = lambda o: format(o, '.3f')", "\n", "\n", "results_dir", "=", "'eval_results'", "\n", "if", "not", "os", ".", "path", ".", "isdir", "(", "results_dir", ")", ":", "\n", "        ", "os", ".", "mkdir", "(", "results_dir", ")", "\n", "", "cache_path", "=", "os", ".", "path", ".", "join", "(", "results_dir", ",", "model_id", "+", "'_'", "+", "split", "+", "'.json'", ")", "\n", "\n", "coco", "=", "COCO", "(", "annFile", ")", "\n", "valids", "=", "coco", ".", "getImgIds", "(", ")", "\n", "\n", "# filter results to only those in MSCOCO validation set (will be about a third)", "\n", "preds_filt", "=", "[", "p", "for", "p", "in", "preds", "if", "p", "[", "'image_id'", "]", "in", "valids", "]", "\n", "print", "(", "'using %d/%d predictions'", "%", "(", "len", "(", "preds_filt", ")", ",", "len", "(", "preds", ")", ")", ")", "\n", "json", ".", "dump", "(", "preds_filt", ",", "open", "(", "cache_path", ",", "'w'", ")", ")", "# serialize to temporary json file. Sigh, COCO API...", "\n", "\n", "cocoRes", "=", "coco", ".", "loadRes", "(", "cache_path", ")", "\n", "cocoEval", "=", "CorrectCOCOEvalCap", "(", "coco", ",", "cocoRes", ")", "\n", "cocoEval", ".", "params", "[", "'image_id'", "]", "=", "cocoRes", ".", "getImgIds", "(", ")", "\n", "cocoEval", ".", "evaluate", "(", ")", "\n", "\n", "if", "image_root", ":", "\n", "# Save cocoEval and any other relevant information into a pickle to be used", "\n", "# later for generating a report and visualizing results.", "\n", "        ", "report_data", "=", "ReportData", "(", "cocoEval", ",", "preds", ",", "image_root", ",", "model_id", ",", "split", ")", "\n", "pickle_file_name", "=", "REPORT_DATA_PKL_FILE_TEMPLATE", "%", "(", "model_id", ",", "split", ")", "\n", "pickle_path", "=", "os", ".", "path", ".", "join", "(", "results_dir", ",", "pickle_file_name", ")", "\n", "report_data", ".", "save_to_pickle", "(", "pickle_path", ")", "\n", "\n", "# create output dictionary", "\n", "", "out", "=", "{", "}", "\n", "for", "metric", ",", "score", "in", "cocoEval", ".", "eval", ".", "items", "(", ")", ":", "\n", "        ", "out", "[", "metric", "]", "=", "score", "\n", "\n", "", "imgToEval", "=", "cocoEval", ".", "imgToEval", "\n", "for", "p", "in", "preds_filt", ":", "\n", "        ", "image_id", ",", "caption", "=", "p", "[", "'image_id'", "]", ",", "p", "[", "'caption'", "]", "\n", "imgToEval", "[", "image_id", "]", "[", "'caption'", "]", "=", "caption", "\n", "", "with", "open", "(", "cache_path", ",", "'w'", ")", "as", "outfile", ":", "\n", "        ", "json", ".", "dump", "(", "{", "'overall'", ":", "out", ",", "'imgToEval'", ":", "imgToEval", "}", ",", "outfile", ")", "\n", "\n", "", "return", "out", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.eval_utils.eval_split": [[74, 181], ["eval_kwargs.get", "eval_kwargs.get", "eval_kwargs.get", "eval_kwargs.get", "eval_kwargs.get", "eval_kwargs.get", "eval_kwargs.get", "eval_kwargs.get", "eval_kwargs.get", "model.eval", "loader.reset_iterator", "model.train", "eval_kwargs.get", "loader.get_batch", "misc.decode_sequence", "enumerate", "range", "eval_utils.language_eval", "torch.no_grad", "torch.no_grad", "range", "loader.get_vocab", "predictions.append", "min", "predictions.pop", "print", "eval_kwargs.get", "eval_kwargs.get", "loader.get_batch.get", "torch.no_grad", "torch.no_grad", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "print", "print", "eval_kwargs.get", "eval_kwargs.get", "print", "os.system", "print", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "crit().item", "crit().item", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "torch.from_numpy().cuda", "numpy.arange", "numpy.arange", "torch.from_numpy", "torch.from_numpy", "model", "model", "str", "torch.from_numpy", "torch.from_numpy", "crit", "crit", "numpy.arange", "numpy.arange", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy", "model", "model", "misc.decode_sequence", "os.path.join", "loader.get_vocab", "_[].unsqueeze"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.reset_iterator", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.train", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_batch", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.decode_sequence", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.eval_utils.language_eval", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_vocab", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.decode_sequence", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_vocab"], ["", "def", "eval_split", "(", "model", ",", "crit", ",", "loader", ",", "eval_kwargs", "=", "{", "}", ")", ":", "\n", "    ", "verbose", "=", "eval_kwargs", ".", "get", "(", "'verbose'", ",", "True", ")", "\n", "verbose_beam", "=", "eval_kwargs", ".", "get", "(", "'verbose_beam'", ",", "1", ")", "\n", "verbose_loss", "=", "eval_kwargs", ".", "get", "(", "'verbose_loss'", ",", "1", ")", "\n", "num_images", "=", "eval_kwargs", ".", "get", "(", "'num_images'", ",", "eval_kwargs", ".", "get", "(", "'val_images_use'", ",", "-", "1", ")", ")", "\n", "split", "=", "eval_kwargs", ".", "get", "(", "'split'", ",", "'val'", ")", "\n", "lang_eval", "=", "eval_kwargs", ".", "get", "(", "'language_eval'", ",", "0", ")", "\n", "dataset", "=", "eval_kwargs", ".", "get", "(", "'dataset'", ",", "'coco'", ")", "\n", "beam_size", "=", "eval_kwargs", ".", "get", "(", "'beam_size'", ",", "1", ")", "\n", "use_box", "=", "eval_kwargs", ".", "get", "(", "'use_box'", ",", "0", ")", "\n", "\n", "# Make sure in the evaluation mode", "\n", "model", ".", "eval", "(", ")", "\n", "\n", "loader", ".", "reset_iterator", "(", "split", ")", "\n", "\n", "n", "=", "0", "\n", "loss", "=", "0", "\n", "loss_sum", "=", "0", "\n", "loss_evals", "=", "1e-8", "\n", "predictions", "=", "[", "]", "\n", "while", "True", ":", "\n", "        ", "data", "=", "loader", ".", "get_batch", "(", "split", ")", "\n", "n", "=", "n", "+", "loader", ".", "batch_size", "\n", "\n", "if", "data", ".", "get", "(", "'labels'", ",", "None", ")", "is", "not", "None", "and", "verbose_loss", ":", "\n", "# forward the model to get loss", "\n", "            ", "tmp", "=", "[", "data", "[", "'fc_feats'", "]", ",", "data", "[", "'att_feats'", "]", ",", "data", "[", "'labels'", "]", ",", "data", "[", "'masks'", "]", ",", "data", "[", "'att_masks'", "]", "]", "\n", "tmp", "=", "[", "torch", ".", "from_numpy", "(", "_", ")", ".", "cuda", "(", ")", "if", "_", "is", "not", "None", "else", "_", "for", "_", "in", "tmp", "]", "\n", "fc_feats", ",", "att_feats", ",", "labels", ",", "masks", ",", "att_masks", "=", "tmp", "\n", "\n", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "#if model_opts.use_box:", "\n", "                ", "if", "use_box", "==", "True", ":", "\n", "                    ", "boxes_data", "=", "data", "[", "'boxes'", "]", "\n", "boxes", "=", "torch", ".", "from_numpy", "(", "boxes_data", ")", ".", "cuda", "(", ")", "if", "boxes_data", "is", "not", "None", "else", "boxes_data", "\n", "loss", "=", "crit", "(", "model", "(", "fc_feats", ",", "att_feats", ",", "boxes", ",", "labels", ",", "att_masks", ")", ",", "labels", "[", ":", ",", "1", ":", "]", ",", "masks", "[", ":", ",", "1", ":", "]", ")", ".", "item", "(", ")", "\n", "", "else", ":", "\n", "                    ", "loss", "=", "crit", "(", "model", "(", "fc_feats", ",", "att_feats", ",", "labels", ",", "att_masks", ")", ",", "labels", "[", ":", ",", "1", ":", "]", ",", "masks", "[", ":", ",", "1", ":", "]", ")", ".", "item", "(", ")", "\n", "", "", "loss_sum", "=", "loss_sum", "+", "loss", "\n", "loss_evals", "=", "loss_evals", "+", "1", "\n", "\n", "# forward the model to also get generated samples for each image", "\n", "# Only leave one feature for each image, in case duplicate sample", "\n", "", "tmp", "=", "[", "data", "[", "'fc_feats'", "]", "[", "np", ".", "arange", "(", "loader", ".", "batch_size", ")", "*", "loader", ".", "seq_per_img", "]", ",", "\n", "data", "[", "'att_feats'", "]", "[", "np", ".", "arange", "(", "loader", ".", "batch_size", ")", "*", "loader", ".", "seq_per_img", "]", ",", "\n", "data", "[", "'att_masks'", "]", "[", "np", ".", "arange", "(", "loader", ".", "batch_size", ")", "*", "loader", ".", "seq_per_img", "]", "if", "data", "[", "'att_masks'", "]", "is", "not", "None", "else", "None", "]", "\n", "tmp", "=", "[", "torch", ".", "from_numpy", "(", "_", ")", ".", "cuda", "(", ")", "if", "_", "is", "not", "None", "else", "_", "for", "_", "in", "tmp", "]", "\n", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "tmp", "\n", "\n", "# forward the model to also get generated samples for each image", "\n", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "#if model_opts.use_box:", "\n", "            ", "if", "use_box", "==", "True", ":", "\n", "                ", "boxes_data", "=", "data", "[", "'boxes'", "]", "[", "np", ".", "arange", "(", "loader", ".", "batch_size", ")", "*", "loader", ".", "seq_per_img", "]", "\n", "boxes", "=", "torch", ".", "from_numpy", "(", "boxes_data", ")", ".", "cuda", "(", ")", "if", "boxes_data", "is", "not", "None", "else", "boxes_data", "\n", "seq", "=", "model", "(", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", ",", "opt", "=", "eval_kwargs", ",", "mode", "=", "'sample'", ")", "[", "0", "]", ".", "data", "\n", "", "else", ":", "\n", "                ", "seq", "=", "model", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ",", "opt", "=", "eval_kwargs", ",", "mode", "=", "'sample'", ")", "[", "0", "]", ".", "data", "\n", "\n", "# Print beam search", "\n", "", "", "if", "beam_size", ">", "1", "and", "verbose_beam", ":", "\n", "            ", "for", "i", "in", "range", "(", "loader", ".", "batch_size", ")", ":", "\n", "                ", "print", "(", "'\\n'", ".", "join", "(", "[", "utils", ".", "decode_sequence", "(", "loader", ".", "get_vocab", "(", ")", ",", "_", "[", "'seq'", "]", ".", "unsqueeze", "(", "0", ")", ")", "[", "0", "]", "for", "_", "in", "model", ".", "done_beams", "[", "i", "]", "]", ")", ")", "\n", "print", "(", "'--'", "*", "10", ")", "\n", "", "", "sents", "=", "utils", ".", "decode_sequence", "(", "loader", ".", "get_vocab", "(", ")", ",", "seq", ")", "\n", "\n", "for", "k", ",", "sent", "in", "enumerate", "(", "sents", ")", ":", "\n", "            ", "image_id", "=", "data", "[", "'infos'", "]", "[", "k", "]", "[", "'id'", "]", "\n", "entry", "=", "{", "'image_id'", ":", "image_id", ",", "'caption'", ":", "sent", ",", "\n", "'file_path'", ":", "data", "[", "'infos'", "]", "[", "k", "]", "[", "'file_path'", "]", "}", "\n", "if", "eval_kwargs", ".", "get", "(", "'dump_path'", ",", "0", ")", "==", "1", ":", "\n", "                ", "entry", "[", "'file_name'", "]", "=", "data", "[", "'infos'", "]", "[", "k", "]", "[", "'file_path'", "]", "\n", "", "predictions", ".", "append", "(", "entry", ")", "\n", "if", "eval_kwargs", ".", "get", "(", "'dump_images'", ",", "0", ")", "==", "1", ":", "\n", "# dump the raw image to vis/ folder", "\n", "                ", "cmd", "=", "'cp \"'", "+", "os", ".", "path", ".", "join", "(", "eval_kwargs", "[", "'image_root'", "]", ",", "data", "[", "'infos'", "]", "[", "k", "]", "[", "'file_path'", "]", ")", "+", "'\" vis/imgs/'", "+", "str", "(", "image_id", ")", "+", "'.jpg'", "# still gross", "\n", "print", "(", "cmd", ")", "\n", "os", ".", "system", "(", "cmd", ")", "\n", "\n", "", "if", "verbose", ":", "\n", "                ", "print", "(", "'image %s: %s'", "%", "(", "entry", "[", "'image_id'", "]", ",", "entry", "[", "'caption'", "]", ")", ")", "\n", "\n", "# if we wrapped around the split or used up val imgs budget then bail", "\n", "", "", "ix0", "=", "data", "[", "'bounds'", "]", "[", "'it_pos_now'", "]", "\n", "ix1", "=", "data", "[", "'bounds'", "]", "[", "'it_max'", "]", "\n", "if", "num_images", "!=", "-", "1", ":", "\n", "            ", "ix1", "=", "min", "(", "ix1", ",", "num_images", ")", "\n", "", "for", "i", "in", "range", "(", "n", "-", "ix1", ")", ":", "\n", "            ", "predictions", ".", "pop", "(", ")", "\n", "\n", "", "if", "verbose", ":", "\n", "            ", "print", "(", "'evaluating validation preformance... %d/%d (%f)'", "%", "(", "ix0", "-", "1", ",", "ix1", ",", "loss", ")", ")", "\n", "\n", "", "if", "data", "[", "'bounds'", "]", "[", "'wrapped'", "]", ":", "\n", "            ", "break", "\n", "", "if", "num_images", ">=", "0", "and", "n", ">=", "num_images", ":", "\n", "            ", "break", "\n", "\n", "", "", "lang_stats", "=", "None", "\n", "if", "lang_eval", "==", "1", ":", "\n", "        ", "lang_stats", "=", "language_eval", "(", "dataset", ",", "predictions", ",", "eval_kwargs", ".", "get", "(", "'id'", ")", ",", "\n", "eval_kwargs", ".", "get", "(", "'image_root'", ")", ",", "split", ")", "\n", "\n", "# Switch back to training mode", "\n", "", "model", ".", "train", "(", ")", "\n", "return", "loss_sum", "/", "loss_evals", ",", "predictions", ",", "lang_stats", "\n", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.reset_iterator": [[20, 24], ["dataloader.BlobFetcher"], "methods", ["None"], ["    ", "def", "reset_iterator", "(", "self", ",", "split", ")", ":", "\n", "        ", "del", "self", ".", "_prefetch_process", "[", "split", "]", "\n", "self", ".", "_prefetch_process", "[", "split", "]", "=", "BlobFetcher", "(", "split", ",", "self", ",", "split", "==", "'train'", ")", "\n", "self", ".", "iterators", "[", "split", "]", "=", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_vocab_size": [[25, 27], ["None"], "methods", ["None"], ["", "def", "get_vocab_size", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "vocab_size", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_vocab": [[28, 30], ["None"], "methods", ["None"], ["", "def", "get_vocab", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "ix_to_word", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_seq_length": [[31, 33], ["None"], "methods", ["None"], ["", "def", "get_seq_length", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "seq_length", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.__init__": [[34, 101], ["getattr", "getattr", "getattr", "getattr", "print", "json.load", "len", "print", "print", "h5py.File", "print", "print", "range", "print", "print", "print", "dataloader.DataLoader.iterators.keys", "atexit.register", "open", "len", "dataloader.BlobFetcher", "print", "dataloader.DataLoader.iterators.keys", "dataloader.DataLoader.split_ix[].append", "len", "len", "len", "dataloader.DataLoader.split_ix[].append", "dataloader.DataLoader.split_ix[].append", "dataloader.DataLoader.split_ix[].append"], "methods", ["None"], ["", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "self", ".", "opt", "=", "opt", "\n", "self", ".", "batch_size", "=", "self", ".", "opt", ".", "batch_size", "\n", "self", ".", "seq_per_img", "=", "opt", ".", "seq_per_img", "\n", "\n", "# feature related options", "\n", "self", ".", "use_att", "=", "getattr", "(", "opt", ",", "'use_att'", ",", "True", ")", "\n", "self", ".", "use_box", "=", "getattr", "(", "opt", ",", "'use_box'", ",", "0", ")", "\n", "self", ".", "norm_att_feat", "=", "getattr", "(", "opt", ",", "'norm_att_feat'", ",", "0", ")", "\n", "self", ".", "norm_box_feat", "=", "getattr", "(", "opt", ",", "'norm_box_feat'", ",", "0", ")", "\n", "\n", "# load the json file which contains additional information about the dataset", "\n", "print", "(", "'DataLoader loading json file: '", ",", "opt", ".", "input_json", ")", "\n", "self", ".", "info", "=", "json", ".", "load", "(", "open", "(", "self", ".", "opt", ".", "input_json", ")", ")", "\n", "self", ".", "rel_bboxes_dir", "=", "self", ".", "opt", ".", "input_rel_box_dir", "\n", "self", ".", "ix_to_word", "=", "self", ".", "info", "[", "'ix_to_word'", "]", "\n", "self", ".", "vocab_size", "=", "len", "(", "self", ".", "ix_to_word", ")", "\n", "print", "(", "'vocab size is '", ",", "self", ".", "vocab_size", ")", "\n", "\n", "# open the hdf5 file", "\n", "print", "(", "'DataLoader loading h5 file: '", ",", "opt", ".", "input_fc_dir", ",", "opt", ".", "input_att_dir", ",", "opt", ".", "input_box_dir", ",", "opt", ".", "input_label_h5", ")", "\n", "self", ".", "h5_label_file", "=", "h5py", ".", "File", "(", "self", ".", "opt", ".", "input_label_h5", ",", "'r'", ",", "driver", "=", "'core'", ")", "\n", "\n", "self", ".", "input_fc_dir", "=", "self", ".", "opt", ".", "input_fc_dir", "\n", "self", ".", "input_att_dir", "=", "self", ".", "opt", ".", "input_att_dir", "\n", "self", ".", "input_box_dir", "=", "self", ".", "opt", ".", "input_box_dir", "\n", "\n", "# load in the sequence data", "\n", "seq_size", "=", "self", ".", "h5_label_file", "[", "'labels'", "]", ".", "shape", "\n", "self", ".", "seq_length", "=", "seq_size", "[", "1", "]", "\n", "print", "(", "'max sequence length in data is'", ",", "self", ".", "seq_length", ")", "\n", "# load the pointers in full to RAM (should be small enough)", "\n", "self", ".", "label_start_ix", "=", "self", ".", "h5_label_file", "[", "'label_start_ix'", "]", "[", ":", "]", "\n", "self", ".", "label_end_ix", "=", "self", ".", "h5_label_file", "[", "'label_end_ix'", "]", "[", ":", "]", "\n", "\n", "self", ".", "num_images", "=", "self", ".", "label_start_ix", ".", "shape", "[", "0", "]", "\n", "print", "(", "'read %d image features'", "%", "(", "self", ".", "num_images", ")", ")", "\n", "\n", "# separate out indexes for each of the provided splits", "\n", "self", ".", "split_ix", "=", "{", "'train'", ":", "[", "]", ",", "'val'", ":", "[", "]", ",", "'test'", ":", "[", "]", "}", "\n", "for", "ix", "in", "range", "(", "len", "(", "self", ".", "info", "[", "'images'", "]", ")", ")", ":", "\n", "            ", "img", "=", "self", ".", "info", "[", "'images'", "]", "[", "ix", "]", "\n", "if", "img", "[", "'split'", "]", "==", "'train'", ":", "\n", "                ", "self", ".", "split_ix", "[", "'train'", "]", ".", "append", "(", "ix", ")", "\n", "", "elif", "img", "[", "'split'", "]", "==", "'val'", ":", "\n", "                ", "self", ".", "split_ix", "[", "'val'", "]", ".", "append", "(", "ix", ")", "\n", "", "elif", "img", "[", "'split'", "]", "==", "'test'", ":", "\n", "                ", "self", ".", "split_ix", "[", "'test'", "]", ".", "append", "(", "ix", ")", "\n", "", "elif", "opt", ".", "train_only", "==", "0", ":", "# restval", "\n", "                ", "self", ".", "split_ix", "[", "'train'", "]", ".", "append", "(", "ix", ")", "\n", "\n", "", "", "print", "(", "'assigned %d images to split train'", "%", "len", "(", "self", ".", "split_ix", "[", "'train'", "]", ")", ")", "\n", "print", "(", "'assigned %d images to split val'", "%", "len", "(", "self", ".", "split_ix", "[", "'val'", "]", ")", ")", "\n", "print", "(", "'assigned %d images to split test'", "%", "len", "(", "self", ".", "split_ix", "[", "'test'", "]", ")", ")", "\n", "\n", "self", ".", "iterators", "=", "{", "'train'", ":", "0", ",", "'val'", ":", "0", ",", "'test'", ":", "0", "}", "\n", "\n", "self", ".", "_prefetch_process", "=", "{", "}", "# The three prefetch process", "\n", "for", "split", "in", "self", ".", "iterators", ".", "keys", "(", ")", ":", "\n", "            ", "self", ".", "_prefetch_process", "[", "split", "]", "=", "BlobFetcher", "(", "split", ",", "self", ",", "split", "==", "'train'", ")", "\n", "# Terminate the child process when the parent exists", "\n", "", "def", "cleanup", "(", ")", ":", "\n", "            ", "print", "(", "'Terminating BlobFetcher'", ")", "\n", "for", "split", "in", "self", ".", "iterators", ".", "keys", "(", ")", ":", "\n", "                ", "del", "self", ".", "_prefetch_process", "[", "split", "]", "\n", "", "", "import", "atexit", "\n", "atexit", ".", "register", "(", "cleanup", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_captions": [[102, 120], ["numpy.zeros", "range", "random.randint", "random.randint"], "methods", ["None"], ["", "def", "get_captions", "(", "self", ",", "ix", ",", "seq_per_img", ")", ":", "\n", "# fetch the sequence labels", "\n", "        ", "ix1", "=", "self", ".", "label_start_ix", "[", "ix", "]", "-", "1", "#label_start_ix starts from 1", "\n", "ix2", "=", "self", ".", "label_end_ix", "[", "ix", "]", "-", "1", "\n", "ncap", "=", "ix2", "-", "ix1", "+", "1", "# number of captions available for this image", "\n", "assert", "ncap", ">", "0", ",", "'an image does not have any label. this can be handled but right now isn\\'t'", "\n", "\n", "if", "ncap", "<", "seq_per_img", ":", "\n", "# we need to subsample (with replacement)", "\n", "            ", "seq", "=", "np", ".", "zeros", "(", "[", "seq_per_img", ",", "self", ".", "seq_length", "]", ",", "dtype", "=", "'int'", ")", "\n", "for", "q", "in", "range", "(", "seq_per_img", ")", ":", "\n", "                ", "ixl", "=", "random", ".", "randint", "(", "ix1", ",", "ix2", ")", "\n", "seq", "[", "q", ",", ":", "]", "=", "self", ".", "h5_label_file", "[", "'labels'", "]", "[", "ixl", ",", ":", "self", ".", "seq_length", "]", "\n", "", "", "else", ":", "\n", "            ", "ixl", "=", "random", ".", "randint", "(", "ix1", ",", "ix2", "-", "seq_per_img", "+", "1", ")", "\n", "seq", "=", "self", ".", "h5_label_file", "[", "'labels'", "]", "[", "ixl", ":", "ixl", "+", "seq_per_img", ",", ":", "self", ".", "seq_length", "]", "\n", "\n", "", "return", "seq", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_batch": [[121, 205], ["numpy.zeros", "numpy.zeros", "range", "numpy.stack", "max", "numpy.zeros", "range", "numpy.zeros", "range", "numpy.vstack", "numpy.array", "enumerate", "fc_batch.append", "att_batch.append", "dataloader.DataLoader.get_captions", "gts.append", "infos.append", "zip", "zip", "functools.reduce", "len", "len", "data[].sum", "list", "len", "numpy.zeros", "range", "dataloader.DataLoader._prefetch_process[].get", "boxes_batch.append", "dataloader.DataLoader._prefetch_process[].get", "map", "len", "sorted", "sorted", "len", "zip", "zip", "len", "numpy.vsplit", "numpy.vsplit"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.get_captions", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get"], ["", "def", "get_batch", "(", "self", ",", "split", ",", "batch_size", "=", "None", ",", "seq_per_img", "=", "None", ")", ":", "\n", "        ", "batch_size", "=", "batch_size", "or", "self", ".", "batch_size", "\n", "seq_per_img", "=", "seq_per_img", "or", "self", ".", "seq_per_img", "\n", "\n", "fc_batch", "=", "[", "]", "# np.ndarray((batch_size * seq_per_img, self.opt.fc_feat_size), dtype = 'float32')", "\n", "att_batch", "=", "[", "]", "# np.ndarray((batch_size * seq_per_img, 14, 14, self.opt.att_feat_size), dtype = 'float32')", "\n", "label_batch", "=", "np", ".", "zeros", "(", "[", "batch_size", "*", "seq_per_img", ",", "self", ".", "seq_length", "+", "2", "]", ",", "dtype", "=", "'int'", ")", "\n", "mask_batch", "=", "np", ".", "zeros", "(", "[", "batch_size", "*", "seq_per_img", ",", "self", ".", "seq_length", "+", "2", "]", ",", "dtype", "=", "'float32'", ")", "\n", "\n", "wrapped", "=", "False", "\n", "\n", "infos", "=", "[", "]", "\n", "gts", "=", "[", "]", "\n", "\n", "boxes_batch", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "batch_size", ")", ":", "\n", "# fetch image", "\n", "            ", "if", "self", ".", "use_box", ":", "\n", "                ", "tmp_fc", ",", "tmp_att", ",", "tmp_box_coords", ",", "ix", ",", "tmp_wrapped", "=", "self", ".", "_prefetch_process", "[", "split", "]", ".", "get", "(", ")", "\n", "boxes_batch", ".", "append", "(", "tmp_box_coords", ")", "\n", "", "else", ":", "\n", "                ", "tmp_fc", ",", "tmp_att", ",", "ix", ",", "tmp_wrapped", "=", "self", ".", "_prefetch_process", "[", "split", "]", ".", "get", "(", ")", "\n", "", "fc_batch", ".", "append", "(", "tmp_fc", ")", "\n", "att_batch", ".", "append", "(", "tmp_att", ")", "\n", "\n", "label_batch", "[", "i", "*", "seq_per_img", ":", "(", "i", "+", "1", ")", "*", "seq_per_img", ",", "1", ":", "self", ".", "seq_length", "+", "1", "]", "=", "self", ".", "get_captions", "(", "ix", ",", "seq_per_img", ")", "\n", "\n", "if", "tmp_wrapped", ":", "\n", "                ", "wrapped", "=", "True", "\n", "\n", "# Used for reward evaluation", "\n", "", "gts", ".", "append", "(", "self", ".", "h5_label_file", "[", "'labels'", "]", "[", "self", ".", "label_start_ix", "[", "ix", "]", "-", "1", ":", "self", ".", "label_end_ix", "[", "ix", "]", "]", ")", "\n", "\n", "# record associated info as well", "\n", "info_dict", "=", "{", "}", "\n", "info_dict", "[", "'ix'", "]", "=", "ix", "\n", "info_dict", "[", "'id'", "]", "=", "self", ".", "info", "[", "'images'", "]", "[", "ix", "]", "[", "'id'", "]", "\n", "info_dict", "[", "'file_path'", "]", "=", "self", ".", "info", "[", "'images'", "]", "[", "ix", "]", "[", "'file_path'", "]", "\n", "infos", ".", "append", "(", "info_dict", ")", "\n", "\n", "# #sort by att_feat length", "\n", "# fc_batch, att_batch, label_batch, gts, infos = \\", "\n", "#     zip(*sorted(zip(fc_batch, att_batch, np.vsplit(label_batch, batch_size), gts, infos), key=lambda x: len(x[1]), reverse=True))", "\n", "\n", "", "data", "=", "{", "}", "\n", "if", "self", ".", "use_box", ":", "\n", "            ", "boxes_batch", ",", "fc_batch", ",", "att_batch", ",", "label_batch", ",", "gts", ",", "infos", "=", "zip", "(", "*", "sorted", "(", "zip", "(", "boxes_batch", ",", "fc_batch", ",", "att_batch", ",", "np", ".", "vsplit", "(", "label_batch", ",", "batch_size", ")", ",", "gts", ",", "infos", ")", ",", "key", "=", "lambda", "x", ":", "0", ",", "reverse", "=", "True", ")", ")", "\n", "", "else", ":", "\n", "            ", "fc_batch", ",", "att_batch", ",", "label_batch", ",", "gts", ",", "infos", "=", "zip", "(", "*", "sorted", "(", "zip", "(", "fc_batch", ",", "att_batch", ",", "np", ".", "vsplit", "(", "label_batch", ",", "batch_size", ")", ",", "gts", ",", "infos", ")", ",", "key", "=", "lambda", "x", ":", "0", ",", "reverse", "=", "True", ")", ")", "\n", "\n", "", "data", "[", "'fc_feats'", "]", "=", "np", ".", "stack", "(", "reduce", "(", "lambda", "x", ",", "y", ":", "x", "+", "y", ",", "[", "[", "_", "]", "*", "seq_per_img", "for", "_", "in", "fc_batch", "]", ")", ")", "\n", "# merge att_feats", "\n", "max_att_len", "=", "max", "(", "[", "_", ".", "shape", "[", "0", "]", "for", "_", "in", "att_batch", "]", ")", "\n", "data", "[", "'att_feats'", "]", "=", "np", ".", "zeros", "(", "[", "len", "(", "att_batch", ")", "*", "seq_per_img", ",", "max_att_len", ",", "att_batch", "[", "0", "]", ".", "shape", "[", "1", "]", "]", ",", "dtype", "=", "'float32'", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "att_batch", ")", ")", ":", "\n", "            ", "data", "[", "'att_feats'", "]", "[", "i", "*", "seq_per_img", ":", "(", "i", "+", "1", ")", "*", "seq_per_img", ",", ":", "att_batch", "[", "i", "]", ".", "shape", "[", "0", "]", "]", "=", "att_batch", "[", "i", "]", "\n", "\n", "", "data", "[", "'att_masks'", "]", "=", "np", ".", "zeros", "(", "data", "[", "'att_feats'", "]", ".", "shape", "[", ":", "2", "]", ",", "dtype", "=", "'float32'", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "att_batch", ")", ")", ":", "\n", "            ", "data", "[", "'att_masks'", "]", "[", "i", "*", "seq_per_img", ":", "(", "i", "+", "1", ")", "*", "seq_per_img", ",", ":", "att_batch", "[", "i", "]", ".", "shape", "[", "0", "]", "]", "=", "1", "\n", "# set att_masks to None if attention features have same length", "\n", "", "if", "data", "[", "'att_masks'", "]", ".", "sum", "(", ")", "==", "data", "[", "'att_masks'", "]", ".", "size", ":", "\n", "            ", "data", "[", "'att_masks'", "]", "=", "None", "\n", "\n", "", "data", "[", "'labels'", "]", "=", "np", ".", "vstack", "(", "label_batch", ")", "\n", "# generate mask", "\n", "nonzeros", "=", "np", ".", "array", "(", "list", "(", "map", "(", "lambda", "x", ":", "(", "x", "!=", "0", ")", ".", "sum", "(", ")", "+", "2", ",", "data", "[", "'labels'", "]", ")", ")", ")", "\n", "for", "ix", ",", "row", "in", "enumerate", "(", "mask_batch", ")", ":", "\n", "            ", "row", "[", ":", "nonzeros", "[", "ix", "]", "]", "=", "1", "\n", "", "data", "[", "'masks'", "]", "=", "mask_batch", "\n", "\n", "data", "[", "'gts'", "]", "=", "gts", "# all ground truth captions of each images", "\n", "data", "[", "'bounds'", "]", "=", "{", "'it_pos_now'", ":", "self", ".", "iterators", "[", "split", "]", ",", "'it_max'", ":", "len", "(", "self", ".", "split_ix", "[", "split", "]", ")", ",", "'wrapped'", ":", "wrapped", "}", "\n", "data", "[", "'infos'", "]", "=", "infos", "\n", "\n", "if", "self", ".", "use_box", ":", "\n", "            ", "data", "[", "'boxes'", "]", "=", "np", ".", "zeros", "(", "[", "len", "(", "boxes_batch", ")", "*", "seq_per_img", ",", "max_att_len", ",", "boxes_batch", "[", "0", "]", ".", "shape", "[", "1", "]", "]", ",", "dtype", "=", "'float32'", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "boxes_batch", ")", ")", ":", "\n", "                ", "data", "[", "'boxes'", "]", "[", "i", "*", "seq_per_img", ":", "(", "i", "+", "1", ")", "*", "seq_per_img", ",", ":", "boxes_batch", "[", "i", "]", ".", "shape", "[", "0", "]", "]", "=", "boxes_batch", "[", "i", "]", "\n", "", "", "return", "data", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.__getitem__": [[209, 235], ["numpy.zeros.reshape", "numpy.zeros", "numpy.load", "numpy.load", "os.path.join", "numpy.load", "numpy.expand_dims", "numpy.concatenate", "os.path.join", "os.path.join", "numpy.linalg.norm", "misc.get_box_areas", "numpy.load", "str", "os.path.join", "str", "str", "str"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.get_box_areas", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["", "def", "__getitem__", "(", "self", ",", "index", ")", ":", "\n", "        ", "\"\"\"This function returns a tuple that is further passed to collate_fn\n        \"\"\"", "\n", "ix", "=", "index", "#self.split_ix[index]", "\n", "if", "self", ".", "use_att", ":", "\n", "            ", "att_feat", "=", "np", ".", "load", "(", "os", ".", "path", ".", "join", "(", "self", ".", "input_att_dir", ",", "str", "(", "self", ".", "info", "[", "'images'", "]", "[", "ix", "]", "[", "'id'", "]", ")", "+", "'.npz'", ")", ")", "[", "'feat'", "]", "\n", "# Reshape to K x C", "\n", "att_feat", "=", "att_feat", ".", "reshape", "(", "-", "1", ",", "att_feat", ".", "shape", "[", "-", "1", "]", ")", "\n", "if", "self", ".", "norm_att_feat", ":", "\n", "                ", "att_feat", "=", "att_feat", "/", "np", ".", "linalg", ".", "norm", "(", "att_feat", ",", "2", ",", "1", ",", "keepdims", "=", "True", ")", "\n", "", "if", "self", ".", "use_box", ":", "\n", "                ", "box_file", "=", "os", ".", "path", ".", "join", "(", "self", ".", "rel_bboxes_dir", ",", "str", "(", "self", ".", "info", "[", "'images'", "]", "[", "ix", "]", "[", "'id'", "]", ")", "+", "'.npy'", ")", "\n", "box_coords", "=", "np", ".", "load", "(", "box_file", ")", "\n", "areas", "=", "np", ".", "expand_dims", "(", "utils", ".", "get_box_areas", "(", "box_coords", ")", ",", "axis", "=", "1", ")", "\n", "\n", "box_coords_with_area", "=", "np", ".", "concatenate", "(", "[", "box_coords", ",", "areas", "]", ",", "axis", "=", "-", "1", ")", "\n", "return", "(", "np", ".", "load", "(", "os", ".", "path", ".", "join", "(", "self", ".", "input_fc_dir", ",", "str", "(", "self", ".", "info", "[", "'images'", "]", "[", "ix", "]", "[", "'id'", "]", ")", "+", "'.npy'", ")", ")", ",", "\n", "att_feat", ",", "\n", "box_coords", ",", "\n", "ix", ")", "\n", "\n", "", "", "else", ":", "\n", "            ", "att_feat", "=", "np", ".", "zeros", "(", "(", "1", ",", "1", ",", "1", ")", ")", "\n", "", "return", "(", "np", ".", "load", "(", "os", ".", "path", ".", "join", "(", "self", ".", "input_fc_dir", ",", "str", "(", "self", ".", "info", "[", "'images'", "]", "[", "ix", "]", "[", "'id'", "]", ")", "+", "'.npy'", ")", ")", ",", "\n", "att_feat", ",", "\n", "ix", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.DataLoader.__len__": [[236, 238], ["len"], "methods", ["None"], ["", "def", "__len__", "(", "self", ")", ":", "\n", "        ", "return", "len", "(", "self", ".", "info", "[", "'images'", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.SubsetSampler.__init__": [[245, 247], ["None"], "methods", ["None"], ["def", "__init__", "(", "self", ",", "indices", ")", ":", "\n", "        ", "self", ".", "indices", "=", "indices", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.SubsetSampler.__iter__": [[248, 250], ["range", "len"], "methods", ["None"], ["", "def", "__iter__", "(", "self", ")", ":", "\n", "        ", "return", "(", "self", ".", "indices", "[", "i", "]", "for", "i", "in", "range", "(", "len", "(", "self", ".", "indices", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.SubsetSampler.__len__": [[251, 253], ["len"], "methods", ["None"], ["", "def", "__len__", "(", "self", ")", ":", "\n", "        ", "return", "len", "(", "self", ".", "indices", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.__init__": [[256, 263], ["None"], "methods", ["None"], ["def", "__init__", "(", "self", ",", "split", ",", "dataloader", ",", "if_shuffle", "=", "False", ")", ":", "\n", "        ", "\"\"\"\n        db is a list of tuples containing: imcrop_name, caption, bbox_feat of gt box, imname\n        \"\"\"", "\n", "self", ".", "split", "=", "split", "\n", "self", ".", "dataloader", "=", "dataloader", "\n", "self", ".", "if_shuffle", "=", "if_shuffle", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.reset": [[265, 279], ["iter", "torch.DataLoader", "torch.DataLoader", "dataloader.SubsetSampler"], "methods", ["None"], ["", "def", "reset", "(", "self", ")", ":", "\n", "        ", "\"\"\"\n        Two cases for this function to be triggered:\n        1. not hasattr(self, 'split_loader'): Resume from previous training. Create the dataset given the saved split_ix and iterator\n        2. wrapped: a new epoch, the split_ix and iterator have been updated in the get_minibatch_inds already.\n        \"\"\"", "\n", "# batch_size is 1, the merge is done in DataLoader class", "\n", "self", ".", "split_loader", "=", "iter", "(", "data", ".", "DataLoader", "(", "dataset", "=", "self", ".", "dataloader", ",", "\n", "batch_size", "=", "1", ",", "\n", "sampler", "=", "SubsetSampler", "(", "self", ".", "dataloader", ".", "split_ix", "[", "self", ".", "split", "]", "[", "self", ".", "dataloader", ".", "iterators", "[", "self", ".", "split", "]", ":", "]", ")", ",", "\n", "shuffle", "=", "False", ",", "\n", "pin_memory", "=", "True", ",", "\n", "num_workers", "=", "4", ",", "# 4 is usually enough", "\n", "collate_fn", "=", "lambda", "x", ":", "x", "[", "0", "]", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher._get_next_minibatch_inds": [[280, 296], ["len", "random.shuffle"], "methods", ["None"], ["", "def", "_get_next_minibatch_inds", "(", "self", ")", ":", "\n", "        ", "max_index", "=", "len", "(", "self", ".", "dataloader", ".", "split_ix", "[", "self", ".", "split", "]", ")", "\n", "wrapped", "=", "False", "\n", "\n", "ri", "=", "self", ".", "dataloader", ".", "iterators", "[", "self", ".", "split", "]", "\n", "ix", "=", "self", ".", "dataloader", ".", "split_ix", "[", "self", ".", "split", "]", "[", "ri", "]", "\n", "\n", "ri_next", "=", "ri", "+", "1", "\n", "if", "ri_next", ">=", "max_index", ":", "\n", "            ", "ri_next", "=", "0", "\n", "if", "self", ".", "if_shuffle", ":", "\n", "                ", "random", ".", "shuffle", "(", "self", ".", "dataloader", ".", "split_ix", "[", "self", ".", "split", "]", ")", "\n", "", "wrapped", "=", "True", "\n", "", "self", ".", "dataloader", ".", "iterators", "[", "self", ".", "split", "]", "=", "ri_next", "\n", "\n", "return", "ix", ",", "wrapped", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get": [[297, 311], ["dataloader.BlobFetcher._get_next_minibatch_inds", "dataloader.BlobFetcher.split_loader.next", "hasattr", "dataloader.BlobFetcher.reset", "dataloader.BlobFetcher.reset"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher._get_next_minibatch_inds", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.reset", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.reset"], ["", "def", "get", "(", "self", ")", ":", "\n", "        ", "if", "not", "hasattr", "(", "self", ",", "'split_loader'", ")", ":", "\n", "            ", "self", ".", "reset", "(", ")", "\n", "\n", "", "ix", ",", "wrapped", "=", "self", ".", "_get_next_minibatch_inds", "(", ")", "\n", "tmp", "=", "self", ".", "split_loader", ".", "next", "(", ")", "\n", "if", "wrapped", ":", "\n", "            ", "self", ".", "reset", "(", ")", "\n", "\n", "#TODO: Double-Check this is correct", "\n", "", "assert", "tmp", "[", "-", "1", "]", "==", "ix", ",", "\"ix not equal\"", "\n", "#assert tmp[2] == ix, \"ix not equal\"", "\n", "\n", "return", "tmp", "+", "[", "wrapped", "]", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_bbox_relative_coords._pil_to_nparray": [[31, 35], ["pim.convert", "numpy.array"], "function", ["None"], ["def", "_pil_to_nparray", "(", "pim", ")", ":", "\n", "    ", "image", "=", "pim", ".", "convert", "(", "\"RGB\"", ")", "\n", "imageArray", "=", "np", ".", "array", "(", "image", ")", "\n", "return", "(", "imageArray", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_bbox_relative_coords.get_numpy_image": [[36, 57], ["prepro_bbox_relative_coords._pil_to_nparray", "requests.get", "PIL.Image.open", "PIL.Image.open", "io.BytesIO"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_bbox_relative_coords._pil_to_nparray", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get"], ["", "def", "get_numpy_image", "(", "url_or_filepath", ")", ":", "\n", "    ", "\"\"\"\n    Converts an image url or filepath to its numpy array.\n\n    :params str url_or_filepath:\n        the url or filepath of the image we want to convert\n    :returns np.array:\n        'RGB' np.array representing the image\n    \"\"\"", "\n", "#image_url", "\n", "if", "'http'", "in", "url_or_filepath", "or", "'www'", "in", "url_or_filepath", ":", "\n", "        ", "url", "=", "url_or_filepath", "\n", "response", "=", "requests", ".", "get", "(", "url", ")", "\n", "pim", "=", "PIL", ".", "Image", ".", "open", "(", "BytesIO", "(", "response", ".", "content", ")", ")", "\n", "#image_file", "\n", "", "else", ":", "\n", "        ", "filepath", "=", "url_or_filepath", "\n", "pim", "=", "PIL", ".", "Image", ".", "open", "(", "filepath", ")", "\n", "\n", "", "nim", "=", "_pil_to_nparray", "(", "pim", ")", "\n", "return", "nim", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_bbox_relative_coords.get_bbox_relative_coords": [[58, 88], ["print", "print", "sorted", "enumerate", "open", "json.load", "str", "os.path.join", "os.path.join", "os.path.exists", "os.path.exists", "os.makedirs", "os.makedirs", "glob.glob", "prepro_bbox_relative_coords.get_numpy_image", "numpy.load", "numpy.clip", "os.join", "numpy.save", "os.join", "print", "[].split", "numpy.array", "len", "box_file.split"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_bbox_relative_coords.get_numpy_image", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["", "def", "get_bbox_relative_coords", "(", "params", ")", ":", "\n", "    ", "input_box_dir", "=", "params", "[", "'input_box_dir'", "]", "\n", "info_filepath", "=", "params", "[", "'input_json'", "]", "\n", "img_dir", "=", "params", "[", "'image_root'", "]", "\n", "output_dir", "=", "params", "[", "'output_dir'", "]", "\n", "\n", "print", "(", "\"Reading coco dataset info\"", ")", "\n", "with", "open", "(", "info_filepath", ",", "\"rb\"", ")", "as", "infile", ":", "\n", "        ", "coco_dict", "=", "json", ".", "load", "(", "infile", ")", "\n", "", "coco_ids_to_paths", "=", "{", "str", "(", "img", "[", "'cocoid'", "]", ")", ":", "os", ".", "path", ".", "join", "(", "img_dir", ",", "img", "[", "'filepath'", "]", ",", "img", "[", "'filename'", "]", ")", "for", "img", "in", "coco_dict", "[", "'images'", "]", "}", "\n", "\n", "rel_box_dir", "=", "output_dir", "\n", "print", "(", "\"Output dir: %s\"", "%", "rel_box_dir", ")", "\n", "if", "not", "os", ".", "path", ".", "exists", "(", "rel_box_dir", ")", ":", "\n", "        ", "os", ".", "makedirs", "(", "rel_box_dir", ")", "\n", "\n", "\n", "", "box_files", "=", "sorted", "(", "glob", "(", "pth", ".", "join", "(", "input_box_dir", ",", "'*'", ")", ")", ")", "\n", "for", "ind", ",", "box_file", "in", "enumerate", "(", "box_files", ")", ":", "\n", "        ", "if", "ind", "%", "1000", "==", "0", ":", "\n", "            ", "print", "(", "'processed %d images (of %d)'", "%", "(", "ind", ",", "len", "(", "box_files", ")", ")", ")", "\n", "", "filenumber", "=", "box_file", ".", "split", "(", "\"/\"", ")", "[", "-", "1", "]", ".", "split", "(", "'.'", ")", "[", "0", "]", "\n", "img_path", "=", "coco_ids_to_paths", "[", "filenumber", "]", "\n", "img_array", "=", "get_numpy_image", "(", "img_path", ")", "\n", "height", ",", "width", "=", "img_array", ".", "shape", "[", ":", "2", "]", "\n", "box", "=", "np", ".", "load", "(", "box_file", ")", "\n", "relative_box", "=", "box", "/", "np", ".", "array", "(", "[", "width", ",", "height", ",", "width", ",", "height", "]", ")", "\n", "relative_box", "=", "np", ".", "clip", "(", "relative_box", ",", "0.0", ",", "1.0", ")", "\n", "new_filename", "=", "pth", ".", "join", "(", "output_dir", ",", "filenumber", "+", "'.npy'", ")", "\n", "np", ".", "save", "(", "new_filename", ",", "relative_box", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.precook": [[32, 48], ["s.split", "collections.defaultdict", "xrange", "xrange", "tuple", "len"], "function", ["None"], ["def", "precook", "(", "s", ",", "n", "=", "4", ",", "out", "=", "False", ")", ":", "\n", "  ", "\"\"\"\n  Takes a string as input and returns an object that can be given to\n  either cook_refs or cook_test. This is optional: cook_refs and cook_test\n  can take string arguments as well.\n  :param s: string : sentence to be converted into ngrams\n  :param n: int    : number of ngrams for which representation is calculated\n  :return: term frequency vector for occuring ngrams\n  \"\"\"", "\n", "words", "=", "s", ".", "split", "(", ")", "\n", "counts", "=", "defaultdict", "(", "int", ")", "\n", "for", "k", "in", "xrange", "(", "1", ",", "n", "+", "1", ")", ":", "\n", "    ", "for", "i", "in", "xrange", "(", "len", "(", "words", ")", "-", "k", "+", "1", ")", ":", "\n", "      ", "ngram", "=", "tuple", "(", "words", "[", "i", ":", "i", "+", "k", "]", ")", "\n", "counts", "[", "ngram", "]", "+=", "1", "\n", "", "", "return", "counts", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.cook_refs": [[49, 58], ["prepro_ngrams.precook"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.precook"], ["", "def", "cook_refs", "(", "refs", ",", "n", "=", "4", ")", ":", "## lhuang: oracle will call with \"average\"", "\n", "    ", "'''Takes a list of reference sentences for a single segment\n    and returns an object that encapsulates everything that BLEU\n    needs to know about them.\n    :param refs: list of string : reference sentences for some image\n    :param n: int : number of ngrams for which (ngram) representation is calculated\n    :return: result (list of dict)\n    '''", "\n", "return", "[", "precook", "(", "ref", ",", "n", ")", "for", "ref", "in", "refs", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.create_crefs": [[59, 65], ["crefs.append", "prepro_ngrams.cook_refs"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.cook_refs"], ["", "def", "create_crefs", "(", "refs", ")", ":", "\n", "  ", "crefs", "=", "[", "]", "\n", "for", "ref", "in", "refs", ":", "\n", "# ref is a list of 5 captions", "\n", "    ", "crefs", ".", "append", "(", "cook_refs", "(", "ref", ")", ")", "\n", "", "return", "crefs", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.compute_doc_freq": [[66, 80], ["collections.defaultdict", "set", "ref.iteritems"], "function", ["None"], ["", "def", "compute_doc_freq", "(", "crefs", ")", ":", "\n", "  ", "'''\n  Compute term frequency for reference data.\n  This will be used to compute idf (inverse document frequency later)\n  The term frequency is stored in the object\n  :return: None\n  '''", "\n", "document_frequency", "=", "defaultdict", "(", "float", ")", "\n", "for", "refs", "in", "crefs", ":", "\n", "# refs, k ref captions of one image", "\n", "    ", "for", "ngram", "in", "set", "(", "[", "ngram", "for", "ref", "in", "refs", "for", "(", "ngram", ",", "count", ")", "in", "ref", ".", "iteritems", "(", ")", "]", ")", ":", "\n", "      ", "document_frequency", "[", "ngram", "]", "+=", "1", "\n", "# maxcounts[ngram] = max(maxcounts.get(ngram,0), count)", "\n", "", "", "return", "document_frequency", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.build_dict": [[81, 108], ["print", "prepro_ngrams.compute_doc_freq", "prepro_ngrams.compute_doc_freq", "prepro_ngrams.create_crefs", "prepro_ngrams.create_crefs", "refs_words.append", "refs_idxs.append", "ref_words.append", "ref_idxs.append", "str"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.compute_doc_freq", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.compute_doc_freq", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.create_crefs", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.create_crefs"], ["", "def", "build_dict", "(", "imgs", ",", "wtoi", ",", "params", ")", ":", "\n", "  ", "wtoi", "[", "'<eos>'", "]", "=", "0", "\n", "\n", "count_imgs", "=", "0", "\n", "\n", "refs_words", "=", "[", "]", "\n", "refs_idxs", "=", "[", "]", "\n", "for", "img", "in", "imgs", ":", "\n", "    ", "if", "(", "params", "[", "'split'", "]", "==", "img", "[", "'split'", "]", ")", "or", "(", "params", "[", "'split'", "]", "==", "'train'", "and", "img", "[", "'split'", "]", "==", "'restval'", ")", "or", "(", "params", "[", "'split'", "]", "==", "'all'", ")", ":", "\n", "#(params['split'] == 'val' and img['split'] == 'restval') or \\", "\n", "      ", "ref_words", "=", "[", "]", "\n", "ref_idxs", "=", "[", "]", "\n", "for", "sent", "in", "img", "[", "'sentences'", "]", ":", "\n", "        ", "tmp_tokens", "=", "sent", "[", "'tokens'", "]", "+", "[", "'<eos>'", "]", "\n", "tmp_tokens", "=", "[", "_", "if", "_", "in", "wtoi", "else", "'UNK'", "for", "_", "in", "tmp_tokens", "]", "\n", "ref_words", ".", "append", "(", "' '", ".", "join", "(", "tmp_tokens", ")", ")", "\n", "ref_idxs", ".", "append", "(", "' '", ".", "join", "(", "[", "str", "(", "wtoi", "[", "_", "]", ")", "for", "_", "in", "tmp_tokens", "]", ")", ")", "\n", "", "refs_words", ".", "append", "(", "ref_words", ")", "\n", "refs_idxs", ".", "append", "(", "ref_idxs", ")", "\n", "count_imgs", "+=", "1", "\n", "", "", "print", "(", "'total imgs:'", ",", "count_imgs", ")", "\n", "\n", "ngram_words", "=", "compute_doc_freq", "(", "create_crefs", "(", "refs_words", ")", ")", "\n", "ngram_idxs", "=", "compute_doc_freq", "(", "create_crefs", "(", "refs_idxs", ")", ")", "\n", "return", "ngram_words", ",", "ngram_idxs", ",", "count_imgs", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.main": [[109, 121], ["json.load", "prepro_ngrams.build_dict", "six.moves.cPickle.dump", "six.moves.cPickle.dump", "open", "json.load", "open", "open", "open", "itow.items"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_ngrams.build_dict"], ["", "def", "main", "(", "params", ")", ":", "\n", "\n", "  ", "imgs", "=", "json", ".", "load", "(", "open", "(", "params", "[", "'input_json'", "]", ",", "'r'", ")", ")", "\n", "itow", "=", "json", ".", "load", "(", "open", "(", "params", "[", "'dict_json'", "]", ",", "'r'", ")", ")", "[", "'ix_to_word'", "]", "\n", "wtoi", "=", "{", "w", ":", "i", "for", "i", ",", "w", "in", "itow", ".", "items", "(", ")", "}", "\n", "\n", "imgs", "=", "imgs", "[", "'images'", "]", "\n", "\n", "ngram_words", ",", "ngram_idxs", ",", "ref_len", "=", "build_dict", "(", "imgs", ",", "wtoi", ",", "params", ")", "\n", "\n", "cPickle", ".", "dump", "(", "{", "'document_frequency'", ":", "ngram_words", ",", "'ref_len'", ":", "ref_len", "}", ",", "open", "(", "params", "[", "'output_pkl'", "]", "+", "'-words.p'", ",", "'w'", ")", ",", "protocol", "=", "cPickle", ".", "HIGHEST_PROTOCOL", ")", "\n", "cPickle", ".", "dump", "(", "{", "'document_frequency'", ":", "ngram_idxs", ",", "'ref_len'", ":", "ref_len", "}", ",", "open", "(", "params", "[", "'output_pkl'", "]", "+", "'-idxs.p'", ",", "'w'", ")", ",", "protocol", "=", "cPickle", ".", "HIGHEST_PROTOCOL", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_labels.build_vocab": [[43, 94], ["sorted", "print", "print", "sum", "print", "sum", "print", "print", "print", "max", "print", "print", "sum", "range", "counts.values", "sent_lengths.keys", "sent_lengths.values", "print", "print", "vocab.append", "map", "counts.items", "counts.items", "len", "img[].append", "counts.items", "len", "len", "len", "sent_lengths.get", "counts.get", "len", "sent_lengths.get", "len", "counts.get", "sent_lengths.get"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get"], ["def", "build_vocab", "(", "imgs", ",", "params", ")", ":", "\n", "  ", "count_thr", "=", "params", "[", "'word_count_threshold'", "]", "\n", "\n", "# count up the number of words", "\n", "counts", "=", "{", "}", "\n", "for", "img", "in", "imgs", ":", "\n", "    ", "for", "sent", "in", "img", "[", "'sentences'", "]", ":", "\n", "      ", "for", "w", "in", "sent", "[", "'tokens'", "]", ":", "\n", "        ", "counts", "[", "w", "]", "=", "counts", ".", "get", "(", "w", ",", "0", ")", "+", "1", "\n", "", "", "", "cw", "=", "sorted", "(", "[", "(", "count", ",", "w", ")", "for", "w", ",", "count", "in", "counts", ".", "items", "(", ")", "]", ",", "reverse", "=", "True", ")", "\n", "print", "(", "'top words and their counts:'", ")", "\n", "print", "(", "'\\n'", ".", "join", "(", "map", "(", "str", ",", "cw", "[", ":", "20", "]", ")", ")", ")", "\n", "\n", "# print some stats", "\n", "total_words", "=", "sum", "(", "counts", ".", "values", "(", ")", ")", "\n", "print", "(", "'total words:'", ",", "total_words", ")", "\n", "bad_words", "=", "[", "w", "for", "w", ",", "n", "in", "counts", ".", "items", "(", ")", "if", "n", "<=", "count_thr", "]", "\n", "vocab", "=", "[", "w", "for", "w", ",", "n", "in", "counts", ".", "items", "(", ")", "if", "n", ">", "count_thr", "]", "\n", "bad_count", "=", "sum", "(", "counts", "[", "w", "]", "for", "w", "in", "bad_words", ")", "\n", "print", "(", "'number of bad words: %d/%d = %.2f%%'", "%", "(", "len", "(", "bad_words", ")", ",", "len", "(", "counts", ")", ",", "len", "(", "bad_words", ")", "*", "100.0", "/", "len", "(", "counts", ")", ")", ")", "\n", "print", "(", "'number of words in vocab would be %d'", "%", "(", "len", "(", "vocab", ")", ",", ")", ")", "\n", "print", "(", "'number of UNKs: %d/%d = %.2f%%'", "%", "(", "bad_count", ",", "total_words", ",", "bad_count", "*", "100.0", "/", "total_words", ")", ")", "\n", "\n", "# lets look at the distribution of lengths as well", "\n", "sent_lengths", "=", "{", "}", "\n", "for", "img", "in", "imgs", ":", "\n", "    ", "for", "sent", "in", "img", "[", "'sentences'", "]", ":", "\n", "      ", "txt", "=", "sent", "[", "'tokens'", "]", "\n", "nw", "=", "len", "(", "txt", ")", "\n", "sent_lengths", "[", "nw", "]", "=", "sent_lengths", ".", "get", "(", "nw", ",", "0", ")", "+", "1", "\n", "", "", "max_len", "=", "max", "(", "sent_lengths", ".", "keys", "(", ")", ")", "\n", "print", "(", "'max length sentence in raw data: '", ",", "max_len", ")", "\n", "print", "(", "'sentence length distribution (count, number of words):'", ")", "\n", "sum_len", "=", "sum", "(", "sent_lengths", ".", "values", "(", ")", ")", "\n", "for", "i", "in", "range", "(", "max_len", "+", "1", ")", ":", "\n", "    ", "print", "(", "'%2d: %10d   %f%%'", "%", "(", "i", ",", "sent_lengths", ".", "get", "(", "i", ",", "0", ")", ",", "sent_lengths", ".", "get", "(", "i", ",", "0", ")", "*", "100.0", "/", "sum_len", ")", ")", "\n", "\n", "# lets now produce the final annotations", "\n", "", "if", "bad_count", ">", "0", ":", "\n", "# additional special UNK token we will use below to map infrequent words to", "\n", "    ", "print", "(", "'inserting the special UNK token'", ")", "\n", "vocab", ".", "append", "(", "'UNK'", ")", "\n", "\n", "", "for", "img", "in", "imgs", ":", "\n", "    ", "img", "[", "'final_captions'", "]", "=", "[", "]", "\n", "for", "sent", "in", "img", "[", "'sentences'", "]", ":", "\n", "      ", "txt", "=", "sent", "[", "'tokens'", "]", "\n", "caption", "=", "[", "w", "if", "counts", ".", "get", "(", "w", ",", "0", ")", ">", "count_thr", "else", "'UNK'", "for", "w", "in", "txt", "]", "\n", "img", "[", "'final_captions'", "]", ".", "append", "(", "caption", ")", "\n", "\n", "", "", "return", "vocab", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_labels.encode_captions": [[95, 138], ["len", "sum", "numpy.zeros", "numpy.zeros", "numpy.zeros", "enumerate", "numpy.concatenate", "numpy.all", "print", "len", "numpy.zeros", "enumerate", "label_arrays.append", "len", "min", "enumerate", "len"], "function", ["None"], ["", "def", "encode_captions", "(", "imgs", ",", "params", ",", "wtoi", ")", ":", "\n", "  ", "\"\"\" \n  encode all captions into one large array, which will be 1-indexed.\n  also produces label_start_ix and label_end_ix which store 1-indexed \n  and inclusive (Lua-style) pointers to the first and last caption for\n  each image in the dataset.\n  \"\"\"", "\n", "\n", "max_length", "=", "params", "[", "'max_length'", "]", "\n", "N", "=", "len", "(", "imgs", ")", "\n", "M", "=", "sum", "(", "len", "(", "img", "[", "'final_captions'", "]", ")", "for", "img", "in", "imgs", ")", "# total number of captions", "\n", "\n", "label_arrays", "=", "[", "]", "\n", "label_start_ix", "=", "np", ".", "zeros", "(", "N", ",", "dtype", "=", "'uint32'", ")", "# note: these will be one-indexed", "\n", "label_end_ix", "=", "np", ".", "zeros", "(", "N", ",", "dtype", "=", "'uint32'", ")", "\n", "label_length", "=", "np", ".", "zeros", "(", "M", ",", "dtype", "=", "'uint32'", ")", "\n", "caption_counter", "=", "0", "\n", "counter", "=", "1", "\n", "for", "i", ",", "img", "in", "enumerate", "(", "imgs", ")", ":", "\n", "    ", "n", "=", "len", "(", "img", "[", "'final_captions'", "]", ")", "\n", "assert", "n", ">", "0", ",", "'error: some image has no captions'", "\n", "\n", "Li", "=", "np", ".", "zeros", "(", "(", "n", ",", "max_length", ")", ",", "dtype", "=", "'uint32'", ")", "\n", "for", "j", ",", "s", "in", "enumerate", "(", "img", "[", "'final_captions'", "]", ")", ":", "\n", "      ", "label_length", "[", "caption_counter", "]", "=", "min", "(", "max_length", ",", "len", "(", "s", ")", ")", "# record the length of this sequence", "\n", "caption_counter", "+=", "1", "\n", "for", "k", ",", "w", "in", "enumerate", "(", "s", ")", ":", "\n", "        ", "if", "k", "<", "max_length", ":", "\n", "          ", "Li", "[", "j", ",", "k", "]", "=", "wtoi", "[", "w", "]", "\n", "\n", "# note: word indices are 1-indexed, and captions are padded with zeros", "\n", "", "", "", "label_arrays", ".", "append", "(", "Li", ")", "\n", "label_start_ix", "[", "i", "]", "=", "counter", "\n", "label_end_ix", "[", "i", "]", "=", "counter", "+", "n", "-", "1", "\n", "\n", "counter", "+=", "n", "\n", "\n", "", "L", "=", "np", ".", "concatenate", "(", "label_arrays", ",", "axis", "=", "0", ")", "# put all the labels together", "\n", "assert", "L", ".", "shape", "[", "0", "]", "==", "M", ",", "'lengths don\\'t match? that\\'s weird'", "\n", "assert", "np", ".", "all", "(", "label_length", ">", "0", ")", ",", "'error: some caption had no words?'", "\n", "\n", "print", "(", "'encoded captions to array of size '", ",", "L", ".", "shape", ")", "\n", "return", "L", ",", "label_start_ix", ",", "label_end_ix", ",", "label_length", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_labels.main": [[139, 182], ["json.load", "random.seed", "prepro_labels.build_vocab", "prepro_labels.encode_captions", "len", "h5py.File", "h5py.File.create_dataset", "h5py.File.create_dataset", "h5py.File.create_dataset", "h5py.File.create_dataset", "h5py.File.close", "enumerate", "json.dump", "print", "open", "out[].append", "open", "enumerate", "enumerate", "os.path.join", "PIL.Image.open", "os.path.join"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_labels.build_vocab", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_labels.encode_captions", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["", "def", "main", "(", "params", ")", ":", "\n", "\n", "  ", "imgs", "=", "json", ".", "load", "(", "open", "(", "params", "[", "'input_json'", "]", ",", "'r'", ")", ")", "\n", "imgs", "=", "imgs", "[", "'images'", "]", "\n", "\n", "seed", "(", "123", ")", "# make reproducible", "\n", "\n", "# create the vocab", "\n", "vocab", "=", "build_vocab", "(", "imgs", ",", "params", ")", "\n", "itow", "=", "{", "i", "+", "1", ":", "w", "for", "i", ",", "w", "in", "enumerate", "(", "vocab", ")", "}", "# a 1-indexed vocab translation table", "\n", "wtoi", "=", "{", "w", ":", "i", "+", "1", "for", "i", ",", "w", "in", "enumerate", "(", "vocab", ")", "}", "# inverse table", "\n", "\n", "# encode captions in large arrays, ready to ship to hdf5 file", "\n", "L", ",", "label_start_ix", ",", "label_end_ix", ",", "label_length", "=", "encode_captions", "(", "imgs", ",", "params", ",", "wtoi", ")", "\n", "\n", "# create output h5 file", "\n", "N", "=", "len", "(", "imgs", ")", "\n", "f_lb", "=", "h5py", ".", "File", "(", "params", "[", "'output_h5'", "]", "+", "'_label.h5'", ",", "\"w\"", ")", "\n", "f_lb", ".", "create_dataset", "(", "\"labels\"", ",", "dtype", "=", "'uint32'", ",", "data", "=", "L", ")", "\n", "f_lb", ".", "create_dataset", "(", "\"label_start_ix\"", ",", "dtype", "=", "'uint32'", ",", "data", "=", "label_start_ix", ")", "\n", "f_lb", ".", "create_dataset", "(", "\"label_end_ix\"", ",", "dtype", "=", "'uint32'", ",", "data", "=", "label_end_ix", ")", "\n", "f_lb", ".", "create_dataset", "(", "\"label_length\"", ",", "dtype", "=", "'uint32'", ",", "data", "=", "label_length", ")", "\n", "f_lb", ".", "close", "(", ")", "\n", "\n", "# create output json file", "\n", "out", "=", "{", "}", "\n", "out", "[", "'ix_to_word'", "]", "=", "itow", "# encode the (1-indexed) vocab", "\n", "out", "[", "'images'", "]", "=", "[", "]", "\n", "for", "i", ",", "img", "in", "enumerate", "(", "imgs", ")", ":", "\n", "\n", "    ", "jimg", "=", "{", "}", "\n", "jimg", "[", "'split'", "]", "=", "img", "[", "'split'", "]", "\n", "if", "'filename'", "in", "img", ":", "jimg", "[", "'file_path'", "]", "=", "os", ".", "path", ".", "join", "(", "img", "[", "'filepath'", "]", ",", "img", "[", "'filename'", "]", ")", "# copy it over, might need", "\n", "if", "'cocoid'", "in", "img", ":", "jimg", "[", "'id'", "]", "=", "img", "[", "'cocoid'", "]", "# copy over & mantain an id, if present (e.g. coco ids, useful)", "\n", "\n", "if", "params", "[", "'images_root'", "]", "!=", "''", ":", "\n", "      ", "with", "Image", ".", "open", "(", "os", ".", "path", ".", "join", "(", "params", "[", "'images_root'", "]", ",", "img", "[", "'filepath'", "]", ",", "img", "[", "'filename'", "]", ")", ")", "as", "_img", ":", "\n", "        ", "jimg", "[", "'width'", "]", ",", "jimg", "[", "'height'", "]", "=", "_img", ".", "size", "\n", "\n", "", "", "out", "[", "'images'", "]", ".", "append", "(", "jimg", ")", "\n", "\n", "", "json", ".", "dump", "(", "out", ",", "open", "(", "params", "[", "'output_json'", "]", ",", "'w'", ")", ")", "\n", "print", "(", "'wrote '", ",", "params", "[", "'output_json'", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.scripts.prepro_feats.main": [[52, 92], ["net.load_state_dict", "misc.resnet_utils.myResnet", "misc.resnet_utils.myResnet.cuda", "misc.resnet_utils.myResnet.eval", "json.load", "len", "random.seed", "enumerate", "print", "getattr", "torch.load", "open", "os.path.isdir", "os.mkdir", "os.path.isdir", "os.mkdir", "skimage.io.imread", "torch.from_numpy().cuda", "preprocess", "numpy.save", "numpy.savez_compressed", "os.path.join", "os.path.join", "len", "numpy.concatenate", "np.concatenate.astype", "torch.no_grad", "misc.resnet_utils.myResnet.", "os.path.join", "tmp_fc.data.cpu().float().numpy", "os.path.join", "print", "torch.from_numpy", "str", "str", "tmp_att.data.cpu().float().numpy", "np.concatenate.transpose", "tmp_fc.data.cpu().float", "tmp_att.data.cpu().float", "tmp_fc.data.cpu", "tmp_att.data.cpu"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["def", "main", "(", "params", ")", ":", "\n", "  ", "net", "=", "getattr", "(", "resnet", ",", "params", "[", "'model'", "]", ")", "(", ")", "\n", "net", ".", "load_state_dict", "(", "torch", ".", "load", "(", "os", ".", "path", ".", "join", "(", "params", "[", "'model_root'", "]", ",", "params", "[", "'model'", "]", "+", "'.pth'", ")", ")", ")", "\n", "my_resnet", "=", "myResnet", "(", "net", ")", "\n", "my_resnet", ".", "cuda", "(", ")", "\n", "my_resnet", ".", "eval", "(", ")", "\n", "\n", "imgs", "=", "json", ".", "load", "(", "open", "(", "params", "[", "'input_json'", "]", ",", "'r'", ")", ")", "\n", "imgs", "=", "imgs", "[", "'images'", "]", "\n", "N", "=", "len", "(", "imgs", ")", "\n", "\n", "seed", "(", "123", ")", "# make reproducible", "\n", "\n", "dir_fc", "=", "params", "[", "'output_dir'", "]", "+", "'_fc'", "\n", "dir_att", "=", "params", "[", "'output_dir'", "]", "+", "'_att'", "\n", "if", "not", "os", ".", "path", ".", "isdir", "(", "dir_fc", ")", ":", "\n", "    ", "os", ".", "mkdir", "(", "dir_fc", ")", "\n", "", "if", "not", "os", ".", "path", ".", "isdir", "(", "dir_att", ")", ":", "\n", "    ", "os", ".", "mkdir", "(", "dir_att", ")", "\n", "\n", "", "for", "i", ",", "img", "in", "enumerate", "(", "imgs", ")", ":", "\n", "# load the image", "\n", "    ", "I", "=", "skimage", ".", "io", ".", "imread", "(", "os", ".", "path", ".", "join", "(", "params", "[", "'images_root'", "]", ",", "img", "[", "'filepath'", "]", ",", "img", "[", "'filename'", "]", ")", ")", "\n", "# handle grayscale input images", "\n", "if", "len", "(", "I", ".", "shape", ")", "==", "2", ":", "\n", "      ", "I", "=", "I", "[", ":", ",", ":", ",", "np", ".", "newaxis", "]", "\n", "I", "=", "np", ".", "concatenate", "(", "(", "I", ",", "I", ",", "I", ")", ",", "axis", "=", "2", ")", "\n", "\n", "", "I", "=", "I", ".", "astype", "(", "'float32'", ")", "/", "255.0", "\n", "I", "=", "torch", ".", "from_numpy", "(", "I", ".", "transpose", "(", "[", "2", ",", "0", ",", "1", "]", ")", ")", ".", "cuda", "(", ")", "\n", "I", "=", "preprocess", "(", "I", ")", "\n", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "      ", "tmp_fc", ",", "tmp_att", "=", "my_resnet", "(", "I", ",", "params", "[", "'att_size'", "]", ")", "\n", "# write to pkl", "\n", "", "np", ".", "save", "(", "os", ".", "path", ".", "join", "(", "dir_fc", ",", "str", "(", "img", "[", "'cocoid'", "]", ")", ")", ",", "tmp_fc", ".", "data", ".", "cpu", "(", ")", ".", "float", "(", ")", ".", "numpy", "(", ")", ")", "\n", "np", ".", "savez_compressed", "(", "os", ".", "path", ".", "join", "(", "dir_att", ",", "str", "(", "img", "[", "'cocoid'", "]", ")", ")", ",", "feat", "=", "tmp_att", ".", "data", ".", "cpu", "(", ")", ".", "float", "(", ")", ".", "numpy", "(", ")", ")", "\n", "\n", "if", "i", "%", "1000", "==", "0", ":", "\n", "      ", "print", "(", "'processing %d/%d (%.2f%% done)'", "%", "(", "i", ",", "N", ",", "i", "*", "100.0", "/", "N", ")", ")", "\n", "", "", "print", "(", "'wrote '", ",", "params", "[", "'output_dir'", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AttModel.__init__": [[48, 85], ["CaptionModel.CaptionModel.__init__", "getattr", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Sequential", "getattr", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Embedding", "torch.Embedding", "torch.Embedding", "torch.ReLU", "torch.ReLU", "torch.ReLU", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.Linear", "torch.Linear", "torch.Linear", "torch.ReLU", "torch.ReLU", "torch.ReLU", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Linear", "torch.Linear", "torch.Linear", "torch.ReLU", "torch.ReLU", "torch.ReLU", "torch.Dropout", "torch.Dropout", "torch.Dropout", "range", "reduce", "torch.Linear", "torch.Linear", "torch.Linear", "torch.ReLU", "torch.ReLU", "torch.ReLU", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.Linear", "torch.Linear", "torch.Linear", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "AttModel", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "vocab_size", "=", "opt", ".", "vocab_size", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "#self.rnn_type = opt.rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "num_layers", "=", "opt", ".", "num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "seq_length", "=", "opt", ".", "seq_length", "\n", "self", ".", "fc_feat_size", "=", "opt", ".", "fc_feat_size", "\n", "self", ".", "att_feat_size", "=", "opt", ".", "att_feat_size", "\n", "self", ".", "att_hid_size", "=", "opt", ".", "att_hid_size", "\n", "\n", "self", ".", "use_bn", "=", "getattr", "(", "opt", ",", "'use_bn'", ",", "0", ")", "\n", "\n", "self", ".", "ss_prob", "=", "0.0", "# Schedule sampling probability", "\n", "\n", "self", ".", "embed", "=", "nn", ".", "Sequential", "(", "nn", ".", "Embedding", "(", "self", ".", "vocab_size", "+", "1", ",", "self", ".", "input_encoding_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", ")", "\n", "self", ".", "fc_embed", "=", "nn", ".", "Sequential", "(", "nn", ".", "Linear", "(", "self", ".", "fc_feat_size", ",", "self", ".", "rnn_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", ")", "\n", "self", ".", "att_embed", "=", "nn", ".", "Sequential", "(", "*", "(", "\n", "(", "(", "nn", ".", "BatchNorm1d", "(", "self", ".", "att_feat_size", ")", ",", ")", "if", "self", ".", "use_bn", "else", "(", ")", ")", "+", "\n", "(", "nn", ".", "Linear", "(", "self", ".", "att_feat_size", ",", "self", ".", "rnn_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", ")", "+", "\n", "(", "(", "nn", ".", "BatchNorm1d", "(", "self", ".", "rnn_size", ")", ",", ")", "if", "self", ".", "use_bn", "==", "2", "else", "(", ")", ")", ")", ")", "\n", "\n", "self", ".", "logit_layers", "=", "getattr", "(", "opt", ",", "'logit_layers'", ",", "1", ")", "\n", "if", "self", ".", "logit_layers", "==", "1", ":", "\n", "            ", "self", ".", "logit", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "vocab_size", "+", "1", ")", "\n", "", "else", ":", "\n", "            ", "self", ".", "logit", "=", "[", "[", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", ",", "nn", ".", "ReLU", "(", ")", ",", "nn", ".", "Dropout", "(", "0.5", ")", "]", "for", "_", "in", "range", "(", "opt", ".", "logit_layers", "-", "1", ")", "]", "\n", "self", ".", "logit", "=", "nn", ".", "Sequential", "(", "*", "(", "reduce", "(", "lambda", "x", ",", "y", ":", "x", "+", "y", ",", "self", ".", "logit", ")", "+", "[", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "vocab_size", "+", "1", ")", "]", ")", ")", "\n", "", "self", ".", "ctx2att", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "att_hid_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AttModel.init_hidden": [[86, 90], ["next", "AttModel.AttModel.parameters", "next.new_zeros", "next.new_zeros"], "methods", ["None"], ["", "def", "init_hidden", "(", "self", ",", "bsz", ")", ":", "\n", "        ", "weight", "=", "next", "(", "self", ".", "parameters", "(", ")", ")", "\n", "return", "(", "weight", ".", "new_zeros", "(", "self", ".", "num_layers", ",", "bsz", ",", "self", ".", "rnn_size", ")", ",", "\n", "weight", ".", "new_zeros", "(", "self", ".", "num_layers", ",", "bsz", ",", "self", ".", "rnn_size", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AttModel.clip_att": [[91, 98], ["att_masks[].contiguous.data.long().sum().max", "att_feats[].contiguous", "att_masks[].contiguous", "att_masks[].contiguous.data.long().sum", "att_masks[].contiguous.data.long"], "methods", ["None"], ["", "def", "clip_att", "(", "self", ",", "att_feats", ",", "att_masks", ")", ":", "\n", "# Clip the length of att_masks and att_feats to the maximum length", "\n", "        ", "if", "att_masks", "is", "not", "None", ":", "\n", "            ", "max_len", "=", "att_masks", ".", "data", ".", "long", "(", ")", ".", "sum", "(", "1", ")", ".", "max", "(", ")", "\n", "att_feats", "=", "att_feats", "[", ":", ",", ":", "max_len", "]", ".", "contiguous", "(", ")", "\n", "att_masks", "=", "att_masks", "[", ":", ",", ":", "max_len", "]", ".", "contiguous", "(", ")", "\n", "", "return", "att_feats", ",", "att_masks", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AttModel._prepare_feature": [[99, 110], ["AttModel.AttModel.clip_att", "AttModel.AttModel.fc_embed", "AttModel.pack_wrapper", "AttModel.AttModel.ctx2att"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.clip_att", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.pack_wrapper"], ["", "def", "_prepare_feature", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", ")", ":", "\n", "        ", "att_feats", ",", "att_masks", "=", "self", ".", "clip_att", "(", "att_feats", ",", "att_masks", ")", "\n", "\n", "# embed fc and att feats", "\n", "fc_feats", "=", "self", ".", "fc_embed", "(", "fc_feats", ")", "\n", "att_feats", "=", "pack_wrapper", "(", "self", ".", "att_embed", ",", "att_feats", ",", "att_masks", ")", "\n", "\n", "# Project the attention feats first to reduce memory and computation comsumptions.", "\n", "p_att_feats", "=", "self", ".", "ctx2att", "(", "att_feats", ")", "\n", "\n", "return", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AttModel._forward": [[111, 145], ["fc_feats.size", "AttModel.AttModel.init_hidden", "fc_feats.new_zeros", "AttModel.AttModel._prepare_feature", "range", "AttModel.AttModel.get_logprobs_state", "seq.size", "seq.size", "fc_feats.new().uniform_", "seq[].clone", "sample_mask.sum", "seq[].clone", "sample_mask.nonzero().view", "seq[].data.clone", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "seq[].data.clone.index_copy_", "seq[].sum", "fc_feats.new", "outputs[].detach", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "sample_mask.nonzero", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.get_logprobs_state"], ["", "def", "_forward", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "seq", ",", "att_masks", "=", "None", ")", ":", "\n", "        ", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "state", "=", "self", ".", "init_hidden", "(", "batch_size", ")", "\n", "\n", "outputs", "=", "fc_feats", ".", "new_zeros", "(", "batch_size", ",", "seq", ".", "size", "(", "1", ")", "-", "1", ",", "self", ".", "vocab_size", "+", "1", ")", "\n", "\n", "# Prepare the features", "\n", "p_fc_feats", ",", "p_att_feats", ",", "pp_att_feats", ",", "p_att_masks", "=", "self", ".", "_prepare_feature", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ")", "\n", "# pp_att_feats is used for attention, we cache it in advance to reduce computation cost", "\n", "\n", "for", "i", "in", "range", "(", "seq", ".", "size", "(", "1", ")", "-", "1", ")", ":", "\n", "            ", "if", "self", ".", "training", "and", "i", ">=", "1", "and", "self", ".", "ss_prob", ">", "0.0", ":", "# otherwiste no need to sample", "\n", "                ", "sample_prob", "=", "fc_feats", ".", "new", "(", "batch_size", ")", ".", "uniform_", "(", "0", ",", "1", ")", "\n", "sample_mask", "=", "sample_prob", "<", "self", ".", "ss_prob", "\n", "if", "sample_mask", ".", "sum", "(", ")", "==", "0", ":", "\n", "                    ", "it", "=", "seq", "[", ":", ",", "i", "]", ".", "clone", "(", ")", "\n", "", "else", ":", "\n", "                    ", "sample_ind", "=", "sample_mask", ".", "nonzero", "(", ")", ".", "view", "(", "-", "1", ")", "\n", "it", "=", "seq", "[", ":", ",", "i", "]", ".", "data", ".", "clone", "(", ")", "\n", "#prob_prev = torch.exp(outputs[-1].data.index_select(0, sample_ind)) # fetch prev distribution: shape Nx(M+1)", "\n", "#it.index_copy_(0, sample_ind, torch.multinomial(prob_prev, 1).view(-1))", "\n", "# prob_prev = torch.exp(outputs[-1].data) # fetch prev distribution: shape Nx(M+1)", "\n", "prob_prev", "=", "torch", ".", "exp", "(", "outputs", "[", ":", ",", "i", "-", "1", "]", ".", "detach", "(", ")", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "it", ".", "index_copy_", "(", "0", ",", "sample_ind", ",", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", ".", "view", "(", "-", "1", ")", ".", "index_select", "(", "0", ",", "sample_ind", ")", ")", "\n", "", "", "else", ":", "\n", "                ", "it", "=", "seq", "[", ":", ",", "i", "]", ".", "clone", "(", ")", "\n", "# break if all the sequences end", "\n", "", "if", "i", ">=", "1", "and", "seq", "[", ":", ",", "i", "]", ".", "sum", "(", ")", "==", "0", ":", "\n", "                ", "break", "\n", "\n", "", "output", ",", "state", "=", "self", ".", "get_logprobs_state", "(", "it", ",", "p_fc_feats", ",", "p_att_feats", ",", "pp_att_feats", ",", "p_att_masks", ",", "state", ")", "\n", "outputs", "[", ":", ",", "i", "]", "=", "output", "\n", "\n", "", "return", "outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AttModel.get_logprobs_state": [[146, 154], ["AttModel.AttModel.embed", "AttModel.AttModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "AttModel.AttModel.logit"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core"], ["", "def", "get_logprobs_state", "(", "self", ",", "it", ",", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", ",", "state", ")", ":", "\n", "# 'it' contains a word index", "\n", "        ", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "state", ",", "att_masks", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "output", ")", ",", "dim", "=", "1", ")", "\n", "\n", "return", "logprobs", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AttModel._sample_beam": [[155, 185], ["opt.get", "fc_feats.size", "AttModel.AttModel._prepare_feature", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "range", "AttModel.AttModel.init_hidden", "p_fc_feats[].expand", "p_att_feats[].expand().contiguous", "pp_att_feats[].expand().contiguous", "range", "AttModel.AttModel.beam_search", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "range", "p_fc_feats.size", "p_att_masks[].expand().contiguous", "AttModel.AttModel.get_logprobs_state", "p_att_feats[].expand", "pp_att_feats[].expand", "fc_feats.new_zeros", "p_att_masks[].expand", "p_att_feats.size", "pp_att_feats.size", "p_att_masks.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.beam_search", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.get_logprobs_state"], ["", "def", "_sample_beam", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "10", ")", "\n", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "\n", "p_fc_feats", ",", "p_att_feats", ",", "pp_att_feats", ",", "p_att_masks", "=", "self", ".", "_prepare_feature", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ")", "\n", "\n", "assert", "beam_size", "<=", "self", ".", "vocab_size", "+", "1", ",", "'lets assume this for now, otherwise this corner case causes a few headaches down the road. can be dealt with in future if needed'", "\n", "seq", "=", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", ".", "zero_", "(", ")", "\n", "seqLogprobs", "=", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", "\n", "# lets process every image independently for now, for simplicity", "\n", "\n", "self", ".", "done_beams", "=", "[", "[", "]", "for", "_", "in", "range", "(", "batch_size", ")", "]", "\n", "for", "k", "in", "range", "(", "batch_size", ")", ":", "\n", "            ", "state", "=", "self", ".", "init_hidden", "(", "beam_size", ")", "\n", "tmp_fc_feats", "=", "p_fc_feats", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "beam_size", ",", "p_fc_feats", ".", "size", "(", "1", ")", ")", "\n", "tmp_att_feats", "=", "p_att_feats", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "p_att_feats", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "\n", "tmp_p_att_feats", "=", "pp_att_feats", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "pp_att_feats", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "\n", "tmp_att_masks", "=", "p_att_masks", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "p_att_masks", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "if", "att_masks", "is", "not", "None", "else", "None", "\n", "\n", "for", "t", "in", "range", "(", "1", ")", ":", "\n", "                ", "if", "t", "==", "0", ":", "# input <bos>", "\n", "                    ", "it", "=", "fc_feats", ".", "new_zeros", "(", "[", "beam_size", "]", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "\n", "", "logprobs", ",", "state", "=", "self", ".", "get_logprobs_state", "(", "it", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "tmp_p_att_feats", ",", "tmp_att_masks", ",", "state", ")", "\n", "\n", "", "self", ".", "done_beams", "[", "k", "]", "=", "self", ".", "beam_search", "(", "state", ",", "logprobs", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "tmp_p_att_feats", ",", "tmp_att_masks", ",", "opt", "=", "opt", ")", "\n", "seq", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'seq'", "]", "# the first beam has highest cumulative score", "\n", "seqLogprobs", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'logps'", "]", "\n", "# return the samples and their log likelihoods", "\n", "", "return", "seq", ".", "transpose", "(", "0", ",", "1", ")", ",", "seqLogprobs", ".", "transpose", "(", "0", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AttModel._sample": [[186, 242], ["opt.get", "opt.get", "opt.get", "opt.get", "fc_feats.size", "AttModel.AttModel.init_hidden", "AttModel.AttModel._prepare_feature", "fc_feats.new_zeros", "fc_feats.new_zeros", "range", "AttModel.AttModel._sample_beam", "AttModel.AttModel.get_logprobs_state", "logprobs.gather.view", "fc_feats.new_zeros", "logprobs.new_zeros", "logprobs.new_zeros.scatter_", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "it.view().long.view().long.view().long", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "logprobs.gather", "it.view().long.view().long.view().long", "unfinished.type_as", "unfinished.sum", "logprobs.size", "seq[].data.unsqueeze", "float", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "it.view().long.view().long.view", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "it.view().long.view().long.view"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel._sample_beam", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.get_logprobs_state"], ["", "def", "_sample", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "\n", "        ", "sample_max", "=", "opt", ".", "get", "(", "'sample_max'", ",", "1", ")", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "1", ")", "\n", "temperature", "=", "opt", ".", "get", "(", "'temperature'", ",", "1.0", ")", "\n", "decoding_constraint", "=", "opt", ".", "get", "(", "'decoding_constraint'", ",", "0", ")", "\n", "if", "beam_size", ">", "1", ":", "\n", "            ", "return", "self", ".", "_sample_beam", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ",", "opt", ")", "\n", "\n", "", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "state", "=", "self", ".", "init_hidden", "(", "batch_size", ")", "\n", "\n", "p_fc_feats", ",", "p_att_feats", ",", "pp_att_feats", ",", "p_att_masks", "=", "self", ".", "_prepare_feature", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ")", "\n", "\n", "seq", "=", "fc_feats", ".", "new_zeros", "(", "(", "batch_size", ",", "self", ".", "seq_length", ")", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "seqLogprobs", "=", "fc_feats", ".", "new_zeros", "(", "batch_size", ",", "self", ".", "seq_length", ")", "\n", "for", "t", "in", "range", "(", "self", ".", "seq_length", "+", "1", ")", ":", "\n", "            ", "if", "t", "==", "0", ":", "# input <bos>", "\n", "                ", "it", "=", "fc_feats", ".", "new_zeros", "(", "batch_size", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "\n", "", "logprobs", ",", "state", "=", "self", ".", "get_logprobs_state", "(", "it", ",", "p_fc_feats", ",", "p_att_feats", ",", "pp_att_feats", ",", "p_att_masks", ",", "state", ")", "\n", "\n", "if", "decoding_constraint", "and", "t", ">", "0", ":", "\n", "                ", "tmp", "=", "logprobs", ".", "new_zeros", "(", "logprobs", ".", "size", "(", ")", ")", "\n", "tmp", ".", "scatter_", "(", "1", ",", "seq", "[", ":", ",", "t", "-", "1", "]", ".", "data", ".", "unsqueeze", "(", "1", ")", ",", "float", "(", "'-inf'", ")", ")", "\n", "logprobs", "=", "logprobs", "+", "tmp", "\n", "\n", "# sample the next word", "\n", "", "if", "t", "==", "self", ".", "seq_length", ":", "# skip if we achieve maximum length", "\n", "                ", "break", "\n", "", "if", "sample_max", ":", "\n", "                ", "sampleLogprobs", ",", "it", "=", "torch", ".", "max", "(", "logprobs", ".", "data", ",", "1", ")", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "\n", "", "else", ":", "\n", "                ", "if", "temperature", "==", "1.0", ":", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "logprobs", ".", "data", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "", "else", ":", "\n", "# scale logprobs by temperature", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "torch", ".", "div", "(", "logprobs", ".", "data", ",", "temperature", ")", ")", "\n", "", "it", "=", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", "\n", "sampleLogprobs", "=", "logprobs", ".", "gather", "(", "1", ",", "it", ")", "# gather the logprobs at sampled positions", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "# and flatten indices for downstream processing", "\n", "\n", "# stop when all finished", "\n", "", "if", "t", "==", "0", ":", "\n", "                ", "unfinished", "=", "it", ">", "0", "\n", "", "else", ":", "\n", "                ", "unfinished", "=", "unfinished", "*", "(", "it", ">", "0", ")", "\n", "", "it", "=", "it", "*", "unfinished", ".", "type_as", "(", "it", ")", "\n", "seq", "[", ":", ",", "t", "]", "=", "it", "\n", "seqLogprobs", "[", ":", ",", "t", "]", "=", "sampleLogprobs", ".", "view", "(", "-", "1", ")", "\n", "# quit loop if all sequences have finished", "\n", "if", "unfinished", ".", "sum", "(", ")", "==", "0", ":", "\n", "                ", "break", "\n", "\n", "", "", "return", "seq", ",", "seqLogprobs", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AdaAtt_lstm.__init__": [[244, 271], ["torch.Module.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.ModuleList", "torch.ModuleList", "torch.ModuleList", "torch.ModuleList", "torch.ModuleList", "torch.ModuleList", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "range", "range"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ",", "use_maxout", "=", "True", ")", ":", "\n", "        ", "super", "(", "AdaAtt_lstm", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "#self.rnn_type = opt.rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "num_layers", "=", "opt", ".", "num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "fc_feat_size", "=", "opt", ".", "fc_feat_size", "\n", "self", ".", "att_feat_size", "=", "opt", ".", "att_feat_size", "\n", "self", ".", "att_hid_size", "=", "opt", ".", "att_hid_size", "\n", "\n", "self", ".", "use_maxout", "=", "use_maxout", "\n", "\n", "# Build a LSTM", "\n", "self", ".", "w2h", "=", "nn", ".", "Linear", "(", "self", ".", "input_encoding_size", ",", "(", "4", "+", "(", "use_maxout", "==", "True", ")", ")", "*", "self", ".", "rnn_size", ")", "\n", "self", ".", "v2h", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "(", "4", "+", "(", "use_maxout", "==", "True", ")", ")", "*", "self", ".", "rnn_size", ")", "\n", "\n", "self", ".", "i2h", "=", "nn", ".", "ModuleList", "(", "[", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "(", "4", "+", "(", "use_maxout", "==", "True", ")", ")", "*", "self", ".", "rnn_size", ")", "for", "_", "in", "range", "(", "self", ".", "num_layers", "-", "1", ")", "]", ")", "\n", "self", ".", "h2h", "=", "nn", ".", "ModuleList", "(", "[", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "(", "4", "+", "(", "use_maxout", "==", "True", ")", ")", "*", "self", ".", "rnn_size", ")", "for", "_", "in", "range", "(", "self", ".", "num_layers", ")", "]", ")", "\n", "\n", "# Layers for getting the fake region", "\n", "if", "self", ".", "num_layers", "==", "1", ":", "\n", "            ", "self", ".", "r_w2h", "=", "nn", ".", "Linear", "(", "self", ".", "input_encoding_size", ",", "self", ".", "rnn_size", ")", "\n", "self", ".", "r_v2h", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", "\n", "", "else", ":", "\n", "            ", "self", ".", "r_i2h", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", "\n", "", "self", ".", "r_h2h", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AdaAtt_lstm.forward": [[273, 330], ["range", "torch.dropout", "torch.dropout", "torch.dropout", "torch.dropout", "torch.dropout", "torch.dropout", "all_input_sums.narrow", "torch.sigmoid", "torch.sigmoid", "torch.sigmoid", "torch.sigmoid.narrow", "torch.sigmoid.narrow", "torch.sigmoid.narrow", "torch.tanh", "torch.tanh", "torch.tanh", "cs.append", "hs.append", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.dropout", "torch.dropout", "torch.dropout", "torch.tanh", "torch.tanh", "torch.tanh", "all_input_sums.narrow", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "AttModel.AdaAtt_lstm.w2h", "AttModel.AdaAtt_lstm.v2h", "all_input_sums.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "AttModel.AdaAtt_lstm.r_i2h", "AttModel.AdaAtt_lstm.r_h2h", "torch.sigmoid", "torch.sigmoid", "torch.sigmoid", "_.unsqueeze", "_.unsqueeze", "AttModel.AdaAtt_lstm.r_w2h", "AttModel.AdaAtt_lstm.r_v2h"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "xt", ",", "img_fc", ",", "state", ")", ":", "\n", "\n", "        ", "hs", "=", "[", "]", "\n", "cs", "=", "[", "]", "\n", "for", "L", "in", "range", "(", "self", ".", "num_layers", ")", ":", "\n", "# c,h from previous timesteps", "\n", "            ", "prev_h", "=", "state", "[", "0", "]", "[", "L", "]", "\n", "prev_c", "=", "state", "[", "1", "]", "[", "L", "]", "\n", "# the input to this layer", "\n", "if", "L", "==", "0", ":", "\n", "                ", "x", "=", "xt", "\n", "i2h", "=", "self", ".", "w2h", "(", "x", ")", "+", "self", ".", "v2h", "(", "img_fc", ")", "\n", "", "else", ":", "\n", "                ", "x", "=", "hs", "[", "-", "1", "]", "\n", "x", "=", "F", ".", "dropout", "(", "x", ",", "self", ".", "drop_prob_lm", ",", "self", ".", "training", ")", "\n", "i2h", "=", "self", ".", "i2h", "[", "L", "-", "1", "]", "(", "x", ")", "\n", "\n", "", "all_input_sums", "=", "i2h", "+", "self", ".", "h2h", "[", "L", "]", "(", "prev_h", ")", "\n", "\n", "sigmoid_chunk", "=", "all_input_sums", ".", "narrow", "(", "1", ",", "0", ",", "3", "*", "self", ".", "rnn_size", ")", "\n", "sigmoid_chunk", "=", "F", ".", "sigmoid", "(", "sigmoid_chunk", ")", "\n", "# decode the gates", "\n", "in_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "0", ",", "self", ".", "rnn_size", ")", "\n", "forget_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", "\n", "out_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", "*", "2", ",", "self", ".", "rnn_size", ")", "\n", "# decode the write inputs", "\n", "if", "not", "self", ".", "use_maxout", ":", "\n", "                ", "in_transform", "=", "F", ".", "tanh", "(", "all_input_sums", ".", "narrow", "(", "1", ",", "3", "*", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", ")", "\n", "", "else", ":", "\n", "                ", "in_transform", "=", "all_input_sums", ".", "narrow", "(", "1", ",", "3", "*", "self", ".", "rnn_size", ",", "2", "*", "self", ".", "rnn_size", ")", "\n", "in_transform", "=", "torch", ".", "max", "(", "in_transform", ".", "narrow", "(", "1", ",", "0", ",", "self", ".", "rnn_size", ")", ",", "\n", "in_transform", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", ")", "\n", "# perform the LSTM update", "\n", "", "next_c", "=", "forget_gate", "*", "prev_c", "+", "in_gate", "*", "in_transform", "\n", "# gated cells form the output", "\n", "tanh_nex_c", "=", "F", ".", "tanh", "(", "next_c", ")", "\n", "next_h", "=", "out_gate", "*", "tanh_nex_c", "\n", "if", "L", "==", "self", ".", "num_layers", "-", "1", ":", "\n", "                ", "if", "L", "==", "0", ":", "\n", "                    ", "i2h", "=", "self", ".", "r_w2h", "(", "x", ")", "+", "self", ".", "r_v2h", "(", "img_fc", ")", "\n", "", "else", ":", "\n", "                    ", "i2h", "=", "self", ".", "r_i2h", "(", "x", ")", "\n", "", "n5", "=", "i2h", "+", "self", ".", "r_h2h", "(", "prev_h", ")", "\n", "fake_region", "=", "F", ".", "sigmoid", "(", "n5", ")", "*", "tanh_nex_c", "\n", "\n", "", "cs", ".", "append", "(", "next_c", ")", "\n", "hs", ".", "append", "(", "next_h", ")", "\n", "\n", "# set up the decoder", "\n", "", "top_h", "=", "hs", "[", "-", "1", "]", "\n", "top_h", "=", "F", ".", "dropout", "(", "top_h", ",", "self", ".", "drop_prob_lm", ",", "self", ".", "training", ")", "\n", "fake_region", "=", "F", ".", "dropout", "(", "fake_region", ",", "self", ".", "drop_prob_lm", ",", "self", ".", "training", ")", "\n", "\n", "state", "=", "(", "torch", ".", "cat", "(", "[", "_", ".", "unsqueeze", "(", "0", ")", "for", "_", "in", "hs", "]", ",", "0", ")", ",", "\n", "torch", ".", "cat", "(", "[", "_", ".", "unsqueeze", "(", "0", ")", "for", "_", "in", "cs", "]", ",", "0", ")", ")", "\n", "return", "top_h", ",", "fake_region", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AdaAtt_attention.__init__": [[332, 356], ["torch.Module.__init__", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.ReLU", "torch.ReLU", "torch.ReLU", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Tanh", "torch.Tanh", "torch.Tanh", "torch.Dropout", "torch.Dropout", "torch.Dropout"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "AdaAtt_attention", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "#self.rnn_type = opt.rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "att_hid_size", "=", "opt", ".", "att_hid_size", "\n", "\n", "# fake region embed", "\n", "self", ".", "fr_linear", "=", "nn", ".", "Sequential", "(", "\n", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "input_encoding_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", ")", "\n", "self", ".", "fr_embed", "=", "nn", ".", "Linear", "(", "self", ".", "input_encoding_size", ",", "self", ".", "att_hid_size", ")", "\n", "\n", "# h out embed", "\n", "self", ".", "ho_linear", "=", "nn", ".", "Sequential", "(", "\n", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "input_encoding_size", ")", ",", "\n", "nn", ".", "Tanh", "(", ")", ",", "\n", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", ")", "\n", "self", ".", "ho_embed", "=", "nn", ".", "Linear", "(", "self", ".", "input_encoding_size", ",", "self", ".", "att_hid_size", ")", "\n", "\n", "self", ".", "alpha_net", "=", "nn", ".", "Linear", "(", "self", ".", "att_hid_size", ",", "1", ")", "\n", "self", ".", "att2h", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AdaAtt_attention.forward": [[357, 395], ["conv_feat.view.view.view", "conv_feat_embed.view.view.view", "AttModel.AdaAtt_attention.fr_linear", "AttModel.AdaAtt_attention.fr_embed", "AttModel.AdaAtt_attention.ho_linear", "AttModel.AdaAtt_attention.ho_embed", "AttModel.AdaAtt_attention.unsqueeze().expand", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.tanh", "torch.tanh", "torch.tanh", "torch.dropout", "torch.dropout", "torch.dropout", "AttModel.AdaAtt_attention.alpha_net", "torch.softmax", "torch.softmax", "torch.softmax", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm.squeeze", "torch.bmm.squeeze", "torch.bmm.squeeze", "torch.tanh", "torch.tanh", "torch.tanh", "torch.dropout", "torch.dropout", "torch.dropout", "AttModel.AdaAtt_attention.size", "AttModel.AdaAtt_attention.size", "torch.dropout.view", "AttModel.AdaAtt_attention.view", "att_masks.view.view.view", "torch.softmax.unsqueeze", "AttModel.AdaAtt_attention.att2h", "conv_feat.view.view.numel", "conv_feat.view.view.size", "AttModel.AdaAtt_attention.unsqueeze", "AttModel.AdaAtt_attention.view", "AttModel.AdaAtt_attention.view", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.softmax.sum"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "h_out", ",", "fake_region", ",", "conv_feat", ",", "conv_feat_embed", ",", "att_masks", "=", "None", ")", ":", "\n", "\n", "# View into three dimensions", "\n", "        ", "att_size", "=", "conv_feat", ".", "numel", "(", ")", "//", "conv_feat", ".", "size", "(", "0", ")", "//", "self", ".", "rnn_size", "\n", "conv_feat", "=", "conv_feat", ".", "view", "(", "-", "1", ",", "att_size", ",", "self", ".", "rnn_size", ")", "\n", "conv_feat_embed", "=", "conv_feat_embed", ".", "view", "(", "-", "1", ",", "att_size", ",", "self", ".", "att_hid_size", ")", "\n", "\n", "# view neighbor from bach_size * neighbor_num x rnn_size to bach_size x rnn_size * neighbor_num", "\n", "fake_region", "=", "self", ".", "fr_linear", "(", "fake_region", ")", "\n", "fake_region_embed", "=", "self", ".", "fr_embed", "(", "fake_region", ")", "\n", "\n", "h_out_linear", "=", "self", ".", "ho_linear", "(", "h_out", ")", "\n", "h_out_embed", "=", "self", ".", "ho_embed", "(", "h_out_linear", ")", "\n", "\n", "txt_replicate", "=", "h_out_embed", ".", "unsqueeze", "(", "1", ")", ".", "expand", "(", "h_out_embed", ".", "size", "(", "0", ")", ",", "att_size", "+", "1", ",", "h_out_embed", ".", "size", "(", "1", ")", ")", "\n", "\n", "img_all", "=", "torch", ".", "cat", "(", "[", "fake_region", ".", "view", "(", "-", "1", ",", "1", ",", "self", ".", "input_encoding_size", ")", ",", "conv_feat", "]", ",", "1", ")", "\n", "img_all_embed", "=", "torch", ".", "cat", "(", "[", "fake_region_embed", ".", "view", "(", "-", "1", ",", "1", ",", "self", ".", "input_encoding_size", ")", ",", "conv_feat_embed", "]", ",", "1", ")", "\n", "\n", "hA", "=", "F", ".", "tanh", "(", "img_all_embed", "+", "txt_replicate", ")", "\n", "hA", "=", "F", ".", "dropout", "(", "hA", ",", "self", ".", "drop_prob_lm", ",", "self", ".", "training", ")", "\n", "\n", "hAflat", "=", "self", ".", "alpha_net", "(", "hA", ".", "view", "(", "-", "1", ",", "self", ".", "att_hid_size", ")", ")", "\n", "PI", "=", "F", ".", "softmax", "(", "hAflat", ".", "view", "(", "-", "1", ",", "att_size", "+", "1", ")", ",", "dim", "=", "1", ")", "\n", "\n", "if", "att_masks", "is", "not", "None", ":", "\n", "            ", "att_masks", "=", "att_masks", ".", "view", "(", "-", "1", ",", "att_size", ")", "\n", "PI", "=", "PI", "*", "torch", ".", "cat", "(", "[", "att_masks", "[", ":", ",", ":", "1", "]", ",", "att_masks", "]", ",", "1", ")", "# assume one one at the first time step.", "\n", "PI", "=", "PI", "/", "PI", ".", "sum", "(", "1", ",", "keepdim", "=", "True", ")", "\n", "\n", "", "visAtt", "=", "torch", ".", "bmm", "(", "PI", ".", "unsqueeze", "(", "1", ")", ",", "img_all", ")", "\n", "visAttdim", "=", "visAtt", ".", "squeeze", "(", "1", ")", "\n", "\n", "atten_out", "=", "visAttdim", "+", "h_out_linear", "\n", "\n", "h", "=", "F", ".", "tanh", "(", "self", ".", "att2h", "(", "atten_out", ")", ")", "\n", "h", "=", "F", ".", "dropout", "(", "h", ",", "self", ".", "drop_prob_lm", ",", "self", ".", "training", ")", "\n", "return", "h", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AdaAttCore.__init__": [[397, 401], ["torch.Module.__init__", "AttModel.AdaAtt_lstm", "AttModel.AdaAtt_attention"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ",", "use_maxout", "=", "False", ")", ":", "\n", "        ", "super", "(", "AdaAttCore", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "lstm", "=", "AdaAtt_lstm", "(", "opt", ",", "use_maxout", ")", "\n", "self", ".", "attention", "=", "AdaAtt_attention", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AdaAttCore.forward": [[402, 406], ["AttModel.AdaAttCore.lstm", "AttModel.AdaAttCore.attention"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.attention"], ["", "def", "forward", "(", "self", ",", "xt", ",", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "state", ",", "att_masks", "=", "None", ")", ":", "\n", "        ", "h_out", ",", "p_out", ",", "state", "=", "self", ".", "lstm", "(", "xt", ",", "fc_feats", ",", "state", ")", "\n", "atten_out", "=", "self", ".", "attention", "(", "h_out", ",", "p_out", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", ")", "\n", "return", "atten_out", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.TopDownCore.__init__": [[408, 415], ["torch.Module.__init__", "torch.LSTMCell", "torch.LSTMCell", "torch.LSTMCell", "torch.LSTMCell", "torch.LSTMCell", "torch.LSTMCell", "AttModel.Attention"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ",", "use_maxout", "=", "False", ")", ":", "\n", "        ", "super", "(", "TopDownCore", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "\n", "self", ".", "att_lstm", "=", "nn", ".", "LSTMCell", "(", "opt", ".", "input_encoding_size", "+", "opt", ".", "rnn_size", "*", "2", ",", "opt", ".", "rnn_size", ")", "# we, fc, h^2_t-1", "\n", "self", ".", "lang_lstm", "=", "nn", ".", "LSTMCell", "(", "opt", ".", "rnn_size", "*", "2", ",", "opt", ".", "rnn_size", ")", "# h^1_t, \\hat v", "\n", "self", ".", "attention", "=", "Attention", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.TopDownCore.forward": [[416, 433], ["torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "AttModel.TopDownCore.att_lstm", "AttModel.TopDownCore.attention", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "AttModel.TopDownCore.lang_lstm", "torch.dropout", "torch.dropout", "torch.dropout", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.attention"], ["", "def", "forward", "(", "self", ",", "xt", ",", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "state", ",", "att_masks", "=", "None", ")", ":", "\n", "        ", "prev_h", "=", "state", "[", "0", "]", "[", "-", "1", "]", "\n", "att_lstm_input", "=", "torch", ".", "cat", "(", "[", "prev_h", ",", "fc_feats", ",", "xt", "]", ",", "1", ")", "\n", "\n", "h_att", ",", "c_att", "=", "self", ".", "att_lstm", "(", "att_lstm_input", ",", "(", "state", "[", "0", "]", "[", "0", "]", ",", "state", "[", "1", "]", "[", "0", "]", ")", ")", "\n", "\n", "att", "=", "self", ".", "attention", "(", "h_att", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", ")", "\n", "\n", "lang_lstm_input", "=", "torch", ".", "cat", "(", "[", "att", ",", "h_att", "]", ",", "1", ")", "\n", "# lang_lstm_input = torch.cat([att, F.dropout(h_att, self.drop_prob_lm, self.training)], 1) ?????", "\n", "\n", "h_lang", ",", "c_lang", "=", "self", ".", "lang_lstm", "(", "lang_lstm_input", ",", "(", "state", "[", "0", "]", "[", "1", "]", ",", "state", "[", "1", "]", "[", "1", "]", ")", ")", "\n", "\n", "output", "=", "F", ".", "dropout", "(", "h_lang", ",", "self", ".", "drop_prob_lm", ",", "self", ".", "training", ")", "\n", "state", "=", "(", "torch", ".", "stack", "(", "[", "h_att", ",", "h_lang", "]", ")", ",", "torch", ".", "stack", "(", "[", "c_att", ",", "c_lang", "]", ")", ")", "\n", "\n", "return", "output", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.StackAttCore.__init__": [[443, 461], ["torch.Module.__init__", "AttModel.Attention", "AttModel.Attention", "FCModel.LSTMCore", "FCModel.LSTMCore", "FCModel.LSTMCore", "torch.Linear", "torch.Linear", "torch.Linear"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ",", "use_maxout", "=", "False", ")", ":", "\n", "        ", "super", "(", "StackAttCore", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "\n", "# self.att0 = Attention(opt)", "\n", "self", ".", "att1", "=", "Attention", "(", "opt", ")", "\n", "self", ".", "att2", "=", "Attention", "(", "opt", ")", "\n", "\n", "opt_input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "opt", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "+", "opt", ".", "rnn_size", "\n", "self", ".", "lstm0", "=", "LSTMCore", "(", "opt", ")", "# att_feat + word_embedding", "\n", "opt", ".", "input_encoding_size", "=", "opt", ".", "rnn_size", "*", "2", "\n", "self", ".", "lstm1", "=", "LSTMCore", "(", "opt", ")", "\n", "self", ".", "lstm2", "=", "LSTMCore", "(", "opt", ")", "\n", "opt", ".", "input_encoding_size", "=", "opt_input_encoding_size", "\n", "\n", "# self.emb1 = nn.Linear(opt.rnn_size, opt.rnn_size)", "\n", "self", ".", "emb2", "=", "nn", ".", "Linear", "(", "opt", ".", "rnn_size", ",", "opt", ".", "rnn_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.StackAttCore.forward": [[462, 471], ["AttModel.StackAttCore.lstm0", "AttModel.StackAttCore.att1", "AttModel.StackAttCore.lstm1", "AttModel.StackAttCore.att2", "AttModel.StackAttCore.lstm2", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "AttModel.StackAttCore.emb2", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "zip"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "xt", ",", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "state", ",", "att_masks", "=", "None", ")", ":", "\n", "# att_res_0 = self.att0(state[0][-1], att_feats, p_att_feats, att_masks)", "\n", "        ", "h_0", ",", "state_0", "=", "self", ".", "lstm0", "(", "torch", ".", "cat", "(", "[", "xt", ",", "fc_feats", "]", ",", "1", ")", ",", "[", "state", "[", "0", "]", "[", "0", ":", "1", "]", ",", "state", "[", "1", "]", "[", "0", ":", "1", "]", "]", ")", "\n", "att_res_1", "=", "self", ".", "att1", "(", "h_0", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", ")", "\n", "h_1", ",", "state_1", "=", "self", ".", "lstm1", "(", "torch", ".", "cat", "(", "[", "h_0", ",", "att_res_1", "]", ",", "1", ")", ",", "[", "state", "[", "0", "]", "[", "1", ":", "2", "]", ",", "state", "[", "1", "]", "[", "1", ":", "2", "]", "]", ")", "\n", "att_res_2", "=", "self", ".", "att2", "(", "h_1", "+", "self", ".", "emb2", "(", "att_res_1", ")", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", ")", "\n", "h_2", ",", "state_2", "=", "self", ".", "lstm2", "(", "torch", ".", "cat", "(", "[", "h_1", ",", "att_res_2", "]", ",", "1", ")", ",", "[", "state", "[", "0", "]", "[", "2", ":", "3", "]", ",", "state", "[", "1", "]", "[", "2", ":", "3", "]", "]", ")", "\n", "\n", "return", "h_2", ",", "[", "torch", ".", "cat", "(", "_", ",", "0", ")", "for", "_", "in", "zip", "(", "state_0", ",", "state_1", ",", "state_2", ")", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.DenseAttCore.__init__": [[473, 500], ["torch.Module.__init__", "AttModel.Attention", "AttModel.Attention", "FCModel.LSTMCore", "FCModel.LSTMCore", "FCModel.LSTMCore", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Sequential", "torch.Linear", "torch.Linear", "torch.Linear", "torch.ReLU", "torch.ReLU", "torch.ReLU", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.Linear", "torch.Linear", "torch.Linear", "torch.ReLU", "torch.ReLU", "torch.ReLU", "torch.Dropout", "torch.Dropout", "torch.Dropout"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ",", "use_maxout", "=", "False", ")", ":", "\n", "        ", "super", "(", "DenseAttCore", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "\n", "# self.att0 = Attention(opt)", "\n", "self", ".", "att1", "=", "Attention", "(", "opt", ")", "\n", "self", ".", "att2", "=", "Attention", "(", "opt", ")", "\n", "\n", "opt_input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "opt", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "+", "opt", ".", "rnn_size", "\n", "self", ".", "lstm0", "=", "LSTMCore", "(", "opt", ")", "# att_feat + word_embedding", "\n", "opt", ".", "input_encoding_size", "=", "opt", ".", "rnn_size", "*", "2", "\n", "self", ".", "lstm1", "=", "LSTMCore", "(", "opt", ")", "\n", "self", ".", "lstm2", "=", "LSTMCore", "(", "opt", ")", "\n", "opt", ".", "input_encoding_size", "=", "opt_input_encoding_size", "\n", "\n", "# self.emb1 = nn.Linear(opt.rnn_size, opt.rnn_size)", "\n", "self", ".", "emb2", "=", "nn", ".", "Linear", "(", "opt", ".", "rnn_size", ",", "opt", ".", "rnn_size", ")", "\n", "\n", "# fuse h_0 and h_1", "\n", "self", ".", "fusion1", "=", "nn", ".", "Sequential", "(", "nn", ".", "Linear", "(", "opt", ".", "rnn_size", "*", "2", ",", "opt", ".", "rnn_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", "nn", ".", "Dropout", "(", "opt", ".", "drop_prob_lm", ")", ")", "\n", "# fuse h_0, h_1 and h_2", "\n", "self", ".", "fusion2", "=", "nn", ".", "Sequential", "(", "nn", ".", "Linear", "(", "opt", ".", "rnn_size", "*", "3", ",", "opt", ".", "rnn_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", "nn", ".", "Dropout", "(", "opt", ".", "drop_prob_lm", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.DenseAttCore.forward": [[501, 510], ["AttModel.DenseAttCore.lstm0", "AttModel.DenseAttCore.att1", "AttModel.DenseAttCore.lstm1", "AttModel.DenseAttCore.att2", "AttModel.DenseAttCore.lstm2", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "AttModel.DenseAttCore.fusion2", "AttModel.DenseAttCore.emb2", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "AttModel.DenseAttCore.fusion1", "zip", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "xt", ",", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "state", ",", "att_masks", "=", "None", ")", ":", "\n", "# att_res_0 = self.att0(state[0][-1], att_feats, p_att_feats, att_masks)", "\n", "        ", "h_0", ",", "state_0", "=", "self", ".", "lstm0", "(", "torch", ".", "cat", "(", "[", "xt", ",", "fc_feats", "]", ",", "1", ")", ",", "[", "state", "[", "0", "]", "[", "0", ":", "1", "]", ",", "state", "[", "1", "]", "[", "0", ":", "1", "]", "]", ")", "\n", "att_res_1", "=", "self", ".", "att1", "(", "h_0", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", ")", "\n", "h_1", ",", "state_1", "=", "self", ".", "lstm1", "(", "torch", ".", "cat", "(", "[", "h_0", ",", "att_res_1", "]", ",", "1", ")", ",", "[", "state", "[", "0", "]", "[", "1", ":", "2", "]", ",", "state", "[", "1", "]", "[", "1", ":", "2", "]", "]", ")", "\n", "att_res_2", "=", "self", ".", "att2", "(", "h_1", "+", "self", ".", "emb2", "(", "att_res_1", ")", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", ")", "\n", "h_2", ",", "state_2", "=", "self", ".", "lstm2", "(", "torch", ".", "cat", "(", "[", "self", ".", "fusion1", "(", "torch", ".", "cat", "(", "[", "h_0", ",", "h_1", "]", ",", "1", ")", ")", ",", "att_res_2", "]", ",", "1", ")", ",", "[", "state", "[", "0", "]", "[", "2", ":", "3", "]", ",", "state", "[", "1", "]", "[", "2", ":", "3", "]", "]", ")", "\n", "\n", "return", "self", ".", "fusion2", "(", "torch", ".", "cat", "(", "[", "h_0", ",", "h_1", ",", "h_2", "]", ",", "1", ")", ")", ",", "[", "torch", ".", "cat", "(", "_", ",", "0", ")", "for", "_", "in", "zip", "(", "state_0", ",", "state_1", ",", "state_2", ")", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Attention.__init__": [[512, 519], ["torch.Module.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "Attention", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "att_hid_size", "=", "opt", ".", "att_hid_size", "\n", "\n", "self", ".", "h2att", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "att_hid_size", ")", "\n", "self", ".", "alpha_net", "=", "nn", ".", "Linear", "(", "self", ".", "att_hid_size", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Attention.forward": [[520, 541], ["p_att_feats.view", "AttModel.Attention.h2att", "att_h.unsqueeze().expand_as.unsqueeze().expand_as.unsqueeze().expand_as", "torch.tanh", "torch.tanh", "torch.tanh", "dot.view.view.view", "AttModel.Attention.alpha_net", "dot.view.view.view", "torch.softmax", "torch.softmax", "torch.softmax", "att_feats.view", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "att_feats.size", "att_feats.size", "att_feats.numel", "att_feats.size", "att_h.unsqueeze().expand_as.unsqueeze().expand_as.unsqueeze", "att_masks.view().float", "torch.softmax.sum", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.softmax.unsqueeze", "att_masks.view"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "h", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", "=", "None", ")", ":", "\n", "# The p_att_feats here is already projected", "\n", "        ", "att_size", "=", "att_feats", ".", "numel", "(", ")", "//", "att_feats", ".", "size", "(", "0", ")", "//", "att_feats", ".", "size", "(", "-", "1", ")", "\n", "att", "=", "p_att_feats", ".", "view", "(", "-", "1", ",", "att_size", ",", "self", ".", "att_hid_size", ")", "\n", "\n", "att_h", "=", "self", ".", "h2att", "(", "h", ")", "# batch * att_hid_size", "\n", "att_h", "=", "att_h", ".", "unsqueeze", "(", "1", ")", ".", "expand_as", "(", "att", ")", "# batch * att_size * att_hid_size", "\n", "dot", "=", "att", "+", "att_h", "# batch * att_size * att_hid_size", "\n", "dot", "=", "F", ".", "tanh", "(", "dot", ")", "# batch * att_size * att_hid_size", "\n", "dot", "=", "dot", ".", "view", "(", "-", "1", ",", "self", ".", "att_hid_size", ")", "# (batch * att_size) * att_hid_size", "\n", "dot", "=", "self", ".", "alpha_net", "(", "dot", ")", "# (batch * att_size) * 1", "\n", "dot", "=", "dot", ".", "view", "(", "-", "1", ",", "att_size", ")", "# batch * att_size", "\n", "\n", "weight", "=", "F", ".", "softmax", "(", "dot", ",", "dim", "=", "1", ")", "# batch * att_size", "\n", "if", "att_masks", "is", "not", "None", ":", "\n", "            ", "weight", "=", "weight", "*", "att_masks", ".", "view", "(", "-", "1", ",", "att_size", ")", ".", "float", "(", ")", "\n", "weight", "=", "weight", "/", "weight", ".", "sum", "(", "1", ",", "keepdim", "=", "True", ")", "# normalize to 1", "\n", "", "att_feats_", "=", "att_feats", ".", "view", "(", "-", "1", ",", "att_size", ",", "att_feats", ".", "size", "(", "-", "1", ")", ")", "# batch * att_size * att_feat_size", "\n", "att_res", "=", "torch", ".", "bmm", "(", "weight", ".", "unsqueeze", "(", "1", ")", ",", "att_feats_", ")", ".", "squeeze", "(", "1", ")", "# batch * att_feat_size", "\n", "\n", "return", "att_res", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Att2in2Core.__init__": [[543, 561], ["torch.Module.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Dropout", "torch.Dropout", "torch.Dropout", "AttModel.Attention"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "Att2in2Core", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "#self.rnn_type = opt.rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "#self.num_layers = opt.num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "fc_feat_size", "=", "opt", ".", "fc_feat_size", "\n", "self", ".", "att_feat_size", "=", "opt", ".", "att_feat_size", "\n", "self", ".", "att_hid_size", "=", "opt", ".", "att_hid_size", "\n", "\n", "# Build a LSTM", "\n", "self", ".", "a2c", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "2", "*", "self", ".", "rnn_size", ")", "\n", "self", ".", "i2h", "=", "nn", ".", "Linear", "(", "self", ".", "input_encoding_size", ",", "5", "*", "self", ".", "rnn_size", ")", "\n", "self", ".", "h2h", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "5", "*", "self", ".", "rnn_size", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", "\n", "\n", "self", ".", "attention", "=", "Attention", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Att2in2Core.forward": [[562, 583], ["AttModel.Att2in2Core.attention", "all_input_sums.narrow", "torch.sigmoid", "torch.sigmoid", "torch.sigmoid", "torch.sigmoid.narrow", "torch.sigmoid.narrow", "torch.sigmoid.narrow", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "AttModel.Att2in2Core.dropout", "AttModel.Att2in2Core.i2h", "AttModel.Att2in2Core.h2h", "all_input_sums.narrow", "AttModel.Att2in2Core.a2c", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.tanh", "torch.tanh", "torch.tanh", "next_h.unsqueeze", "next_c.unsqueeze"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.attention"], ["", "def", "forward", "(", "self", ",", "xt", ",", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "state", ",", "att_masks", "=", "None", ")", ":", "\n", "        ", "att_res", "=", "self", ".", "attention", "(", "state", "[", "0", "]", "[", "-", "1", "]", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", ")", "\n", "\n", "all_input_sums", "=", "self", ".", "i2h", "(", "xt", ")", "+", "self", ".", "h2h", "(", "state", "[", "0", "]", "[", "-", "1", "]", ")", "\n", "sigmoid_chunk", "=", "all_input_sums", ".", "narrow", "(", "1", ",", "0", ",", "3", "*", "self", ".", "rnn_size", ")", "\n", "sigmoid_chunk", "=", "F", ".", "sigmoid", "(", "sigmoid_chunk", ")", "\n", "in_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "0", ",", "self", ".", "rnn_size", ")", "\n", "forget_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", "\n", "out_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", "*", "2", ",", "self", ".", "rnn_size", ")", "\n", "\n", "in_transform", "=", "all_input_sums", ".", "narrow", "(", "1", ",", "3", "*", "self", ".", "rnn_size", ",", "2", "*", "self", ".", "rnn_size", ")", "+", "self", ".", "a2c", "(", "att_res", ")", "\n", "in_transform", "=", "torch", ".", "max", "(", "in_transform", ".", "narrow", "(", "1", ",", "0", ",", "self", ".", "rnn_size", ")", ",", "\n", "in_transform", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", ")", "\n", "next_c", "=", "forget_gate", "*", "state", "[", "1", "]", "[", "-", "1", "]", "+", "in_gate", "*", "in_transform", "\n", "next_h", "=", "out_gate", "*", "F", ".", "tanh", "(", "next_c", ")", "\n", "\n", "output", "=", "self", ".", "dropout", "(", "next_h", ")", "\n", "state", "=", "(", "next_h", ".", "unsqueeze", "(", "0", ")", ",", "next_c", ".", "unsqueeze", "(", "0", ")", ")", "\n", "return", "output", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Att2inCore.__init__": [[585, 589], ["AttModel.Att2in2Core.__init__", "torch.Linear", "torch.Linear", "torch.Linear"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "Att2inCore", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "del", "self", ".", "a2c", "\n", "self", ".", "a2c", "=", "nn", ".", "Linear", "(", "self", ".", "att_feat_size", ",", "2", "*", "self", ".", "rnn_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Att2all2Core.__init__": [[595, 613], ["torch.Module.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Dropout", "torch.Dropout", "torch.Dropout", "AttModel.Attention"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "Att2all2Core", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "#self.rnn_type = opt.rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "#self.num_layers = opt.num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "fc_feat_size", "=", "opt", ".", "fc_feat_size", "\n", "self", ".", "att_feat_size", "=", "opt", ".", "att_feat_size", "\n", "self", ".", "att_hid_size", "=", "opt", ".", "att_hid_size", "\n", "\n", "# Build a LSTM", "\n", "self", ".", "a2h", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "5", "*", "self", ".", "rnn_size", ")", "\n", "self", ".", "i2h", "=", "nn", ".", "Linear", "(", "self", ".", "input_encoding_size", ",", "5", "*", "self", ".", "rnn_size", ")", "\n", "self", ".", "h2h", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "5", "*", "self", ".", "rnn_size", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", "\n", "\n", "self", ".", "attention", "=", "Attention", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Att2all2Core.forward": [[614, 634], ["AttModel.Att2all2Core.attention", "all_input_sums.narrow", "torch.sigmoid", "torch.sigmoid", "torch.sigmoid", "torch.sigmoid.narrow", "torch.sigmoid.narrow", "torch.sigmoid.narrow", "all_input_sums.narrow", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "AttModel.Att2all2Core.dropout", "AttModel.Att2all2Core.a2h", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.max.narrow", "torch.tanh", "torch.tanh", "torch.tanh", "next_h.unsqueeze", "next_c.unsqueeze", "AttModel.Att2all2Core.i2h", "AttModel.Att2all2Core.h2h"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.attention"], ["", "def", "forward", "(", "self", ",", "xt", ",", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "state", ",", "att_masks", "=", "None", ")", ":", "\n", "        ", "att_res", "=", "self", ".", "attention", "(", "state", "[", "0", "]", "[", "-", "1", "]", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", ")", "\n", "\n", "all_input_sums", "=", "self", ".", "i2h", "(", "xt", ")", "+", "self", ".", "h2h", "(", "state", "[", "0", "]", "[", "-", "1", "]", ")", "+", "self", ".", "a2h", "(", "att_res", ")", "\n", "sigmoid_chunk", "=", "all_input_sums", ".", "narrow", "(", "1", ",", "0", ",", "3", "*", "self", ".", "rnn_size", ")", "\n", "sigmoid_chunk", "=", "F", ".", "sigmoid", "(", "sigmoid_chunk", ")", "\n", "in_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "0", ",", "self", ".", "rnn_size", ")", "\n", "forget_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", "\n", "out_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", "*", "2", ",", "self", ".", "rnn_size", ")", "\n", "\n", "in_transform", "=", "all_input_sums", ".", "narrow", "(", "1", ",", "3", "*", "self", ".", "rnn_size", ",", "2", "*", "self", ".", "rnn_size", ")", "\n", "in_transform", "=", "torch", ".", "max", "(", "in_transform", ".", "narrow", "(", "1", ",", "0", ",", "self", ".", "rnn_size", ")", ",", "\n", "in_transform", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", ")", "\n", "next_c", "=", "forget_gate", "*", "state", "[", "1", "]", "[", "-", "1", "]", "+", "in_gate", "*", "in_transform", "\n", "next_h", "=", "out_gate", "*", "F", ".", "tanh", "(", "next_c", ")", "\n", "\n", "output", "=", "self", ".", "dropout", "(", "next_h", ")", "\n", "state", "=", "(", "next_h", ".", "unsqueeze", "(", "0", ")", ",", "next_c", ".", "unsqueeze", "(", "0", ")", ")", "\n", "return", "output", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AdaAttModel.__init__": [[636, 639], ["AttModel.AttModel.__init__", "AttModel.AdaAttCore"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "AdaAttModel", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "self", ".", "core", "=", "AdaAttCore", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.AdaAttMOModel.__init__": [[642, 645], ["AttModel.AttModel.__init__", "AttModel.AdaAttCore"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "AdaAttMOModel", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "self", ".", "core", "=", "AdaAttCore", "(", "opt", ",", "True", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Att2in2Model.__init__": [[647, 652], ["AttModel.AttModel.__init__", "AttModel.Att2in2Core", "delattr"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "Att2in2Model", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "self", ".", "core", "=", "Att2in2Core", "(", "opt", ")", "\n", "delattr", "(", "self", ",", "'fc_embed'", ")", "\n", "self", ".", "fc_embed", "=", "lambda", "x", ":", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Att2all2Model.__init__": [[654, 659], ["AttModel.AttModel.__init__", "AttModel.Att2all2Core", "delattr"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "Att2all2Model", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "self", ".", "core", "=", "Att2all2Core", "(", "opt", ")", "\n", "delattr", "(", "self", ",", "'fc_embed'", ")", "\n", "self", ".", "fc_embed", "=", "lambda", "x", ":", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.TopDownModel.__init__": [[661, 665], ["AttModel.AttModel.__init__", "AttModel.TopDownCore"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "TopDownModel", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "self", ".", "num_layers", "=", "2", "\n", "self", ".", "core", "=", "TopDownCore", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.StackAttModel.__init__": [[667, 671], ["AttModel.AttModel.__init__", "AttModel.StackAttCore"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "StackAttModel", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "self", ".", "num_layers", "=", "3", "\n", "self", ".", "core", "=", "StackAttCore", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.DenseAttModel.__init__": [[673, 677], ["AttModel.AttModel.__init__", "AttModel.DenseAttCore"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "DenseAttModel", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "self", ".", "num_layers", "=", "3", "\n", "self", ".", "core", "=", "DenseAttCore", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Att2inModel.__init__": [[679, 688], ["AttModel.AttModel.__init__", "torch.Embedding", "torch.Embedding", "torch.Embedding", "torch.Linear", "torch.Linear", "torch.Linear", "AttModel.Att2inCore", "AttModel.Att2inModel.init_weights"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_weights"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "Att2inModel", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "del", "self", ".", "embed", ",", "self", ".", "fc_embed", ",", "self", ".", "att_embed", "\n", "self", ".", "embed", "=", "nn", ".", "Embedding", "(", "self", ".", "vocab_size", "+", "1", ",", "self", ".", "input_encoding_size", ")", "\n", "self", ".", "fc_embed", "=", "self", ".", "att_embed", "=", "lambda", "x", ":", "x", "\n", "del", "self", ".", "ctx2att", "\n", "self", ".", "ctx2att", "=", "nn", ".", "Linear", "(", "self", ".", "att_feat_size", ",", "self", ".", "att_hid_size", ")", "\n", "self", ".", "core", "=", "Att2inCore", "(", "opt", ")", "\n", "self", ".", "init_weights", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.Att2inModel.init_weights": [[689, 694], ["AttModel.Att2inModel.embed.weight.data.uniform_", "AttModel.Att2inModel.logit.bias.data.fill_", "AttModel.Att2inModel.logit.weight.data.uniform_"], "methods", ["None"], ["", "def", "init_weights", "(", "self", ")", ":", "\n", "        ", "initrange", "=", "0.1", "\n", "self", ".", "embed", ".", "weight", ".", "data", ".", "uniform_", "(", "-", "initrange", ",", "initrange", ")", "\n", "self", ".", "logit", ".", "bias", ".", "data", ".", "fill_", "(", "0", ")", "\n", "self", ".", "logit", ".", "weight", ".", "data", ".", "uniform_", "(", "-", "initrange", ",", "initrange", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.sort_pack_padded_sequence": [[28, 34], ["torch.sort", "torch.sort", "torch.sort", "torch.nn.utils.rnn.pack_padded_sequence", "indices.clone", "torch.arange().type_as", "torch.arange().type_as", "torch.arange().type_as", "torch.arange", "torch.arange", "torch.arange", "len"], "function", ["None"], ["def", "sort_pack_padded_sequence", "(", "input", ",", "lengths", ")", ":", "\n", "    ", "sorted_lengths", ",", "indices", "=", "torch", ".", "sort", "(", "lengths", ",", "descending", "=", "True", ")", "\n", "tmp", "=", "pack_padded_sequence", "(", "input", "[", "indices", "]", ",", "sorted_lengths", ",", "batch_first", "=", "True", ")", "\n", "inv_ix", "=", "indices", ".", "clone", "(", ")", "\n", "inv_ix", "[", "indices", "]", "=", "torch", ".", "arange", "(", "0", ",", "len", "(", "indices", ")", ")", ".", "type_as", "(", "inv_ix", ")", "\n", "return", "tmp", ",", "inv_ix", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.pad_unsort_packed_sequence": [[35, 39], ["torch.nn.utils.rnn.pad_packed_sequence"], "function", ["None"], ["", "def", "pad_unsort_packed_sequence", "(", "input", ",", "inv_ix", ")", ":", "\n", "    ", "tmp", ",", "_", "=", "pad_packed_sequence", "(", "input", ",", "batch_first", "=", "True", ")", "\n", "tmp", "=", "tmp", "[", "inv_ix", "]", "\n", "return", "tmp", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.pack_wrapper": [[40, 46], ["AttModel.sort_pack_padded_sequence", "AttModel.pad_unsort_packed_sequence", "module", "att_masks.data.long().sum", "torch.nn.utils.rnn.PackedSequence", "module", "att_masks.data.long"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.sort_pack_padded_sequence", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.pad_unsort_packed_sequence"], ["", "def", "pack_wrapper", "(", "module", ",", "att_feats", ",", "att_masks", ")", ":", "\n", "    ", "if", "att_masks", "is", "not", "None", ":", "\n", "        ", "packed", ",", "inv_ix", "=", "sort_pack_padded_sequence", "(", "att_feats", ",", "att_masks", ".", "data", ".", "long", "(", ")", ".", "sum", "(", "1", ")", ")", "\n", "return", "pad_unsort_packed_sequence", "(", "PackedSequence", "(", "module", "(", "packed", "[", "0", "]", ")", ",", "packed", "[", "1", "]", ")", ",", "inv_ix", ")", "\n", "", "else", ":", "\n", "        ", "return", "module", "(", "att_feats", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.CaptionModel.CaptionModel.__init__": [[20, 22], ["torch.Module.__init__"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ")", ":", "\n", "        ", "super", "(", "CaptionModel", ",", "self", ")", ".", "__init__", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.CaptionModel.CaptionModel.forward": [[27, 32], ["kwargs.get", "getattr"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get"], ["", "def", "forward", "(", "self", ",", "*", "args", ",", "**", "kwargs", ")", ":", "\n", "        ", "mode", "=", "kwargs", ".", "get", "(", "'mode'", ",", "'forward'", ")", "\n", "if", "'mode'", "in", "kwargs", ":", "\n", "            ", "del", "kwargs", "[", "'mode'", "]", "\n", "", "return", "getattr", "(", "self", ",", "'_'", "+", "mode", ")", "(", "*", "args", ",", "**", "kwargs", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.CaptionModel.CaptionModel.beam_search": [[33, 178], ["opt.get", "opt.get", "opt.get", "opt.get", "opt.get", "list", "list", "range", "reduce", "logprobs_table[].data.float.clone", "range", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "min", "range", "sorted", "range", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "list", "init_logprobs.chunk", "range", "range", "ys.size", "range", "_.clone", "beam_seq[].clone", "beam_seq_logprobs[].clone", "range", "range", "range", "range", "range", "torch.unbind", "torch.unbind", "torch.unbind", "torch.unbind", "torch.unbind", "torch.unbind", "torch.unbind", "torch.unbind", "torch.unbind", "torch.stack().chunk", "torch.stack().chunk", "torch.stack().chunk", "torch.stack().chunk", "torch.stack().chunk", "torch.stack().chunk", "torch.stack().chunk", "torch.stack().chunk", "torch.stack().chunk", "_.chunk", "range", "sorted", "range", "range", "ys[].item", "sorted.append", "len", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "range", "logprobs_table[].data.float", "CaptionModel.CaptionModel.beam_search.add_diversity"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get"], ["", "def", "beam_search", "(", "self", ",", "init_state", ",", "init_logprobs", ",", "*", "args", ",", "**", "kwargs", ")", ":", "\n", "\n", "# function computes the similarity score to be augmented", "\n", "        ", "def", "add_diversity", "(", "beam_seq_table", ",", "logprobsf", ",", "t", ",", "divm", ",", "diversity_lambda", ",", "bdash", ")", ":", "\n", "            ", "local_time", "=", "t", "-", "divm", "\n", "unaug_logprobsf", "=", "logprobsf", ".", "clone", "(", ")", "\n", "for", "prev_choice", "in", "range", "(", "divm", ")", ":", "\n", "                ", "prev_decisions", "=", "beam_seq_table", "[", "prev_choice", "]", "[", "local_time", "]", "\n", "for", "sub_beam", "in", "range", "(", "bdash", ")", ":", "\n", "                    ", "for", "prev_labels", "in", "range", "(", "bdash", ")", ":", "\n", "                        ", "logprobsf", "[", "sub_beam", "]", "[", "prev_decisions", "[", "prev_labels", "]", "]", "=", "logprobsf", "[", "sub_beam", "]", "[", "prev_decisions", "[", "prev_labels", "]", "]", "-", "diversity_lambda", "\n", "", "", "", "return", "unaug_logprobsf", "\n", "\n", "# does one step of classical beam search", "\n", "\n", "", "def", "beam_step", "(", "logprobsf", ",", "unaug_logprobsf", ",", "beam_size", ",", "t", ",", "beam_seq", ",", "beam_seq_logprobs", ",", "beam_logprobs_sum", ",", "state", ")", ":", "\n", "#INPUTS:", "\n", "#logprobsf: probabilities augmented after diversity", "\n", "#beam_size: obvious", "\n", "#t        : time instant", "\n", "#beam_seq : tensor contanining the beams", "\n", "#beam_seq_logprobs: tensor contanining the beam logprobs", "\n", "#beam_logprobs_sum: tensor contanining joint logprobs", "\n", "#OUPUTS:", "\n", "#beam_seq : tensor containing the word indices of the decoded captions", "\n", "#beam_seq_logprobs : log-probability of each decision made, same size as beam_seq", "\n", "#beam_logprobs_sum : joint log-probability of each beam", "\n", "\n", "            ", "ys", ",", "ix", "=", "torch", ".", "sort", "(", "logprobsf", ",", "1", ",", "True", ")", "\n", "candidates", "=", "[", "]", "\n", "cols", "=", "min", "(", "beam_size", ",", "ys", ".", "size", "(", "1", ")", ")", "\n", "rows", "=", "beam_size", "\n", "if", "t", "==", "0", ":", "\n", "                ", "rows", "=", "1", "\n", "", "for", "c", "in", "range", "(", "cols", ")", ":", "# for each column (word, essentially)", "\n", "                ", "for", "q", "in", "range", "(", "rows", ")", ":", "# for each beam expansion", "\n", "#compute logprob of expanding beam q with word in (sorted) position c", "\n", "                    ", "local_logprob", "=", "ys", "[", "q", ",", "c", "]", ".", "item", "(", ")", "\n", "candidate_logprob", "=", "beam_logprobs_sum", "[", "q", "]", "+", "local_logprob", "\n", "local_unaug_logprob", "=", "unaug_logprobsf", "[", "q", ",", "ix", "[", "q", ",", "c", "]", "]", "\n", "candidates", ".", "append", "(", "{", "'c'", ":", "ix", "[", "q", ",", "c", "]", ",", "'q'", ":", "q", ",", "'p'", ":", "candidate_logprob", ",", "'r'", ":", "local_unaug_logprob", "}", ")", "\n", "", "", "candidates", "=", "sorted", "(", "candidates", ",", "key", "=", "lambda", "x", ":", "-", "x", "[", "'p'", "]", ")", "\n", "\n", "new_state", "=", "[", "_", ".", "clone", "(", ")", "for", "_", "in", "state", "]", "\n", "#beam_seq_prev, beam_seq_logprobs_prev", "\n", "if", "t", ">=", "1", ":", "\n", "#we''ll need these as reference when we fork beams around", "\n", "                ", "beam_seq_prev", "=", "beam_seq", "[", ":", "t", "]", ".", "clone", "(", ")", "\n", "beam_seq_logprobs_prev", "=", "beam_seq_logprobs", "[", ":", "t", "]", ".", "clone", "(", ")", "\n", "", "for", "vix", "in", "range", "(", "beam_size", ")", ":", "\n", "                ", "v", "=", "candidates", "[", "vix", "]", "\n", "#fork beam index q into index vix", "\n", "if", "t", ">=", "1", ":", "\n", "                    ", "beam_seq", "[", ":", "t", ",", "vix", "]", "=", "beam_seq_prev", "[", ":", ",", "v", "[", "'q'", "]", "]", "\n", "beam_seq_logprobs", "[", ":", "t", ",", "vix", "]", "=", "beam_seq_logprobs_prev", "[", ":", ",", "v", "[", "'q'", "]", "]", "\n", "#rearrange recurrent states", "\n", "", "for", "state_ix", "in", "range", "(", "len", "(", "new_state", ")", ")", ":", "\n", "#  copy over state in previous beam q to new beam at vix", "\n", "                    ", "new_state", "[", "state_ix", "]", "[", ":", ",", "vix", "]", "=", "state", "[", "state_ix", "]", "[", ":", ",", "v", "[", "'q'", "]", "]", "# dimension one is time step", "\n", "#append new end terminal at the end of this beam", "\n", "", "beam_seq", "[", "t", ",", "vix", "]", "=", "v", "[", "'c'", "]", "# c'th word is the continuation", "\n", "beam_seq_logprobs", "[", "t", ",", "vix", "]", "=", "v", "[", "'r'", "]", "# the raw logprob here", "\n", "beam_logprobs_sum", "[", "vix", "]", "=", "v", "[", "'p'", "]", "# the new (sum) logprob along this beam", "\n", "", "state", "=", "new_state", "\n", "return", "beam_seq", ",", "beam_seq_logprobs", ",", "beam_logprobs_sum", ",", "state", ",", "candidates", "\n", "\n", "# Start diverse_beam_search", "\n", "", "opt", "=", "kwargs", "[", "'opt'", "]", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "10", ")", "\n", "group_size", "=", "opt", ".", "get", "(", "'group_size'", ",", "1", ")", "\n", "diversity_lambda", "=", "opt", ".", "get", "(", "'diversity_lambda'", ",", "0.5", ")", "\n", "decoding_constraint", "=", "opt", ".", "get", "(", "'decoding_constraint'", ",", "0", ")", "\n", "max_ppl", "=", "opt", ".", "get", "(", "'max_ppl'", ",", "0", ")", "\n", "bdash", "=", "beam_size", "//", "group_size", "# beam per group", "\n", "\n", "# INITIALIZATIONS", "\n", "beam_seq_table", "=", "[", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "bdash", ")", ".", "zero_", "(", ")", "for", "_", "in", "range", "(", "group_size", ")", "]", "\n", "beam_seq_logprobs_table", "=", "[", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "bdash", ")", ".", "zero_", "(", ")", "for", "_", "in", "range", "(", "group_size", ")", "]", "\n", "beam_logprobs_sum_table", "=", "[", "torch", ".", "zeros", "(", "bdash", ")", "for", "_", "in", "range", "(", "group_size", ")", "]", "\n", "\n", "# logprobs # logprobs predicted in last time step, shape (beam_size, vocab_size+1)", "\n", "done_beams_table", "=", "[", "[", "]", "for", "_", "in", "range", "(", "group_size", ")", "]", "\n", "state_table", "=", "[", "list", "(", "torch", ".", "unbind", "(", "_", ")", ")", "for", "_", "in", "torch", ".", "stack", "(", "init_state", ")", ".", "chunk", "(", "group_size", ",", "2", ")", "]", "\n", "logprobs_table", "=", "list", "(", "init_logprobs", ".", "chunk", "(", "group_size", ",", "0", ")", ")", "\n", "# END INIT", "\n", "\n", "# Chunk elements in the args", "\n", "args", "=", "list", "(", "args", ")", "\n", "args", "=", "[", "_", ".", "chunk", "(", "group_size", ")", "if", "_", "is", "not", "None", "else", "[", "None", "]", "*", "group_size", "for", "_", "in", "args", "]", "\n", "args", "=", "[", "[", "args", "[", "i", "]", "[", "j", "]", "for", "i", "in", "range", "(", "len", "(", "args", ")", ")", "]", "for", "j", "in", "range", "(", "group_size", ")", "]", "\n", "\n", "for", "t", "in", "range", "(", "self", ".", "seq_length", "+", "group_size", "-", "1", ")", ":", "\n", "            ", "for", "divm", "in", "range", "(", "group_size", ")", ":", "\n", "                ", "if", "t", ">=", "divm", "and", "t", "<=", "self", ".", "seq_length", "+", "divm", "-", "1", ":", "\n", "# add diversity", "\n", "                    ", "logprobsf", "=", "logprobs_table", "[", "divm", "]", ".", "data", ".", "float", "(", ")", "\n", "# suppress previous word", "\n", "if", "decoding_constraint", "and", "t", "-", "divm", ">", "0", ":", "\n", "                        ", "logprobsf", ".", "scatter_", "(", "1", ",", "beam_seq_table", "[", "divm", "]", "[", "t", "-", "divm", "-", "1", "]", ".", "unsqueeze", "(", "1", ")", ".", "cuda", "(", ")", ",", "float", "(", "'-inf'", ")", ")", "\n", "# suppress UNK tokens in the decoding", "\n", "", "logprobsf", "[", ":", ",", "logprobsf", ".", "size", "(", "1", ")", "-", "1", "]", "=", "logprobsf", "[", ":", ",", "logprobsf", ".", "size", "(", "1", ")", "-", "1", "]", "-", "1000", "\n", "# diversity is added here", "\n", "# the function directly modifies the logprobsf values and hence, we need to return", "\n", "# the unaugmented ones for sorting the candidates in the end. # for historical", "\n", "# reasons :-)", "\n", "unaug_logprobsf", "=", "add_diversity", "(", "beam_seq_table", ",", "logprobsf", ",", "t", ",", "divm", ",", "diversity_lambda", ",", "bdash", ")", "\n", "\n", "# infer new beams", "\n", "beam_seq_table", "[", "divm", "]", ",", "beam_seq_logprobs_table", "[", "divm", "]", ",", "beam_logprobs_sum_table", "[", "divm", "]", ",", "state_table", "[", "divm", "]", ",", "candidates_divm", "=", "beam_step", "(", "logprobsf", ",", "\n", "unaug_logprobsf", ",", "\n", "bdash", ",", "\n", "t", "-", "divm", ",", "\n", "beam_seq_table", "[", "divm", "]", ",", "\n", "beam_seq_logprobs_table", "[", "divm", "]", ",", "\n", "beam_logprobs_sum_table", "[", "divm", "]", ",", "\n", "state_table", "[", "divm", "]", ")", "\n", "\n", "# if time's up... or if end token is reached then copy beams", "\n", "for", "vix", "in", "range", "(", "bdash", ")", ":", "\n", "                        ", "if", "beam_seq_table", "[", "divm", "]", "[", "t", "-", "divm", ",", "vix", "]", "==", "0", "or", "t", "==", "self", ".", "seq_length", "+", "divm", "-", "1", ":", "\n", "                            ", "final_beam", "=", "{", "\n", "'seq'", ":", "beam_seq_table", "[", "divm", "]", "[", ":", ",", "vix", "]", ".", "clone", "(", ")", ",", "\n", "'logps'", ":", "beam_seq_logprobs_table", "[", "divm", "]", "[", ":", ",", "vix", "]", ".", "clone", "(", ")", ",", "\n", "'unaug_p'", ":", "beam_seq_logprobs_table", "[", "divm", "]", "[", ":", ",", "vix", "]", ".", "sum", "(", ")", ".", "item", "(", ")", ",", "\n", "'p'", ":", "beam_logprobs_sum_table", "[", "divm", "]", "[", "vix", "]", ".", "item", "(", ")", "\n", "}", "\n", "if", "max_ppl", ":", "\n", "                                ", "final_beam", "[", "'p'", "]", "=", "final_beam", "[", "'p'", "]", "/", "(", "t", "-", "divm", "+", "1", ")", "\n", "", "done_beams_table", "[", "divm", "]", ".", "append", "(", "final_beam", ")", "\n", "# don't continue beams from finished sequences", "\n", "beam_logprobs_sum_table", "[", "divm", "]", "[", "vix", "]", "=", "-", "1000", "\n", "\n", "# move the current group one step forward in time", "\n", "\n", "", "", "it", "=", "beam_seq_table", "[", "divm", "]", "[", "t", "-", "divm", "]", "\n", "logprobs_table", "[", "divm", "]", ",", "state_table", "[", "divm", "]", "=", "self", ".", "get_logprobs_state", "(", "it", ".", "cuda", "(", ")", ",", "*", "(", "args", "[", "divm", "]", "+", "[", "state_table", "[", "divm", "]", "]", ")", ")", "\n", "\n", "# all beams are sorted by their log-probabilities", "\n", "", "", "", "done_beams_table", "=", "[", "sorted", "(", "done_beams_table", "[", "i", "]", ",", "key", "=", "lambda", "x", ":", "-", "x", "[", "'p'", "]", ")", "[", ":", "bdash", "]", "for", "i", "in", "range", "(", "group_size", ")", "]", "\n", "done_beams", "=", "reduce", "(", "lambda", "a", ",", "b", ":", "a", "+", "b", ",", "done_beams_table", ")", "\n", "return", "done_beams", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.EncoderDecoder.__init__": [[42, 49], ["torch.Module.__init__"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "encoder", ",", "decoder", ",", "src_embed", ",", "tgt_embed", ",", "generator", ")", ":", "\n", "        ", "super", "(", "EncoderDecoder", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "encoder", "=", "encoder", "\n", "self", ".", "decoder", "=", "decoder", "\n", "self", ".", "src_embed", "=", "src_embed", "\n", "self", ".", "tgt_embed", "=", "tgt_embed", "\n", "self", ".", "generator", "=", "generator", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.EncoderDecoder.forward": [[51, 55], ["RelationTransformerModel.EncoderDecoder.decode", "RelationTransformerModel.EncoderDecoder.encode"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.decode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.encode"], ["", "def", "forward", "(", "self", ",", "src", ",", "boxes", ",", "tgt", ",", "src_mask", ",", "tgt_mask", ")", ":", "\n", "        ", "\"Take in and process masked src and target sequences.\"", "\n", "return", "self", ".", "decode", "(", "self", ".", "encode", "(", "src", ",", "boxes", ",", "src_mask", ")", ",", "src_mask", ",", "\n", "tgt", ",", "tgt_mask", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.EncoderDecoder.encode": [[56, 58], ["RelationTransformerModel.EncoderDecoder.encoder", "RelationTransformerModel.EncoderDecoder.src_embed"], "methods", ["None"], ["", "def", "encode", "(", "self", ",", "src", ",", "boxes", ",", "src_mask", ")", ":", "\n", "        ", "return", "self", ".", "encoder", "(", "self", ".", "src_embed", "(", "src", ")", ",", "boxes", ",", "src_mask", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.EncoderDecoder.decode": [[59, 61], ["RelationTransformerModel.EncoderDecoder.decoder", "RelationTransformerModel.EncoderDecoder.tgt_embed"], "methods", ["None"], ["", "def", "decode", "(", "self", ",", "memory", ",", "src_mask", ",", "tgt", ",", "tgt_mask", ")", ":", "\n", "        ", "return", "self", ".", "decoder", "(", "self", ".", "tgt_embed", "(", "tgt", ")", ",", "memory", ",", "src_mask", ",", "tgt_mask", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.Generator.__init__": [[64, 67], ["torch.Module.__init__", "torch.Linear", "torch.Linear", "torch.Linear"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "d_model", ",", "vocab", ")", ":", "\n", "        ", "super", "(", "Generator", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "proj", "=", "nn", ".", "Linear", "(", "d_model", ",", "vocab", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.Generator.forward": [[68, 70], ["torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "RelationTransformerModel.Generator.proj"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "return", "F", ".", "log_softmax", "(", "self", ".", "proj", "(", "x", ")", ",", "dim", "=", "-", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.Encoder.__init__": [[77, 81], ["torch.Module.__init__", "RelationTransformerModel.clones", "RelationTransformerModel.LayerNorm"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["def", "__init__", "(", "self", ",", "layer", ",", "N", ")", ":", "\n", "        ", "super", "(", "Encoder", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "layers", "=", "clones", "(", "layer", ",", "N", ")", "\n", "self", ".", "norm", "=", "LayerNorm", "(", "layer", ".", "size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.Encoder.forward": [[82, 87], ["RelationTransformerModel.Encoder.norm", "layer"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "box", ",", "mask", ")", ":", "\n", "        ", "\"Pass the input (and mask) through each layer in turn.\"", "\n", "for", "layer", "in", "self", ".", "layers", ":", "\n", "            ", "x", "=", "layer", "(", "x", ",", "box", ",", "mask", ")", "\n", "", "return", "self", ".", "norm", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.LayerNorm.__init__": [[90, 95], ["torch.Module.__init__", "torch.Parameter", "torch.Parameter", "torch.Parameter", "torch.Parameter", "torch.Parameter", "torch.Parameter", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "features", ",", "eps", "=", "1e-6", ")", ":", "\n", "        ", "super", "(", "LayerNorm", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "a_2", "=", "nn", ".", "Parameter", "(", "torch", ".", "ones", "(", "features", ")", ")", "\n", "self", ".", "b_2", "=", "nn", ".", "Parameter", "(", "torch", ".", "zeros", "(", "features", ")", ")", "\n", "self", ".", "eps", "=", "eps", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.LayerNorm.forward": [[96, 100], ["x.mean", "x.std"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "mean", "=", "x", ".", "mean", "(", "-", "1", ",", "keepdim", "=", "True", ")", "\n", "std", "=", "x", ".", "std", "(", "-", "1", ",", "keepdim", "=", "True", ")", "\n", "return", "self", ".", "a_2", "*", "(", "x", "-", "mean", ")", "/", "(", "std", "+", "self", ".", "eps", ")", "+", "self", ".", "b_2", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.SublayerConnection.__init__": [[106, 110], ["torch.Module.__init__", "RelationTransformerModel.LayerNorm", "torch.Dropout", "torch.Dropout", "torch.Dropout"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "size", ",", "dropout", ")", ":", "\n", "        ", "super", "(", "SublayerConnection", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "norm", "=", "LayerNorm", "(", "size", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "dropout", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.SublayerConnection.forward": [[111, 114], ["RelationTransformerModel.SublayerConnection.dropout", "sublayer", "RelationTransformerModel.SublayerConnection.norm"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "sublayer", ")", ":", "\n", "        ", "\"Apply residual connection to any sublayer with the same size.\"", "\n", "return", "x", "+", "self", ".", "dropout", "(", "sublayer", "(", "self", ".", "norm", "(", "x", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.EncoderLayer.__init__": [[117, 123], ["torch.Module.__init__", "RelationTransformerModel.clones", "RelationTransformerModel.SublayerConnection"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["def", "__init__", "(", "self", ",", "size", ",", "self_attn", ",", "feed_forward", ",", "dropout", ")", ":", "\n", "        ", "super", "(", "EncoderLayer", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "self_attn", "=", "self_attn", "\n", "self", ".", "feed_forward", "=", "feed_forward", "\n", "self", ".", "sublayer", "=", "clones", "(", "SublayerConnection", "(", "size", ",", "dropout", ")", ",", "2", ")", "\n", "self", ".", "size", "=", "size", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.EncoderLayer.forward": [[124, 128], ["RelationTransformerModel.EncoderLayer.self_attn"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "box", ",", "mask", ")", ":", "\n", "        ", "\"Follow Figure 1 (left) for connections.\"", "\n", "x", "=", "self", ".", "sublayer", "[", "0", "]", "(", "x", ",", "lambda", "x", ":", "self", ".", "self_attn", "(", "x", ",", "x", ",", "x", ",", "box", ",", "mask", ")", ")", "\n", "return", "self", ".", "sublayer", "[", "1", "]", "(", "x", ",", "self", ".", "feed_forward", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.Decoder.__init__": [[131, 135], ["torch.Module.__init__", "RelationTransformerModel.clones", "RelationTransformerModel.LayerNorm"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["def", "__init__", "(", "self", ",", "layer", ",", "N", ")", ":", "\n", "        ", "super", "(", "Decoder", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "layers", "=", "clones", "(", "layer", ",", "N", ")", "\n", "self", ".", "norm", "=", "LayerNorm", "(", "layer", ".", "size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.Decoder.forward": [[136, 140], ["RelationTransformerModel.Decoder.norm", "layer"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "memory", ",", "src_mask", ",", "tgt_mask", ")", ":", "\n", "        ", "for", "layer", "in", "self", ".", "layers", ":", "\n", "            ", "x", "=", "layer", "(", "x", ",", "memory", ",", "src_mask", ",", "tgt_mask", ")", "\n", "", "return", "self", ".", "norm", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.DecoderLayer.__init__": [[143, 150], ["torch.Module.__init__", "RelationTransformerModel.clones", "RelationTransformerModel.SublayerConnection"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["def", "__init__", "(", "self", ",", "size", ",", "self_attn", ",", "src_attn", ",", "feed_forward", ",", "dropout", ")", ":", "\n", "        ", "super", "(", "DecoderLayer", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "size", "=", "size", "\n", "self", ".", "self_attn", "=", "self_attn", "\n", "self", ".", "src_attn", "=", "src_attn", "\n", "self", ".", "feed_forward", "=", "feed_forward", "\n", "self", ".", "sublayer", "=", "clones", "(", "SublayerConnection", "(", "size", ",", "dropout", ")", ",", "3", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.DecoderLayer.forward": [[151, 157], ["RelationTransformerModel.DecoderLayer.self_attn", "RelationTransformerModel.DecoderLayer.src_attn"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "memory", ",", "src_mask", ",", "tgt_mask", ")", ":", "\n", "        ", "\"Follow Figure 1 (right) for connections.\"", "\n", "m", "=", "memory", "\n", "x", "=", "self", ".", "sublayer", "[", "0", "]", "(", "x", ",", "lambda", "x", ":", "self", ".", "self_attn", "(", "x", ",", "x", ",", "x", ",", "tgt_mask", ")", ")", "\n", "x", "=", "self", ".", "sublayer", "[", "1", "]", "(", "x", ",", "lambda", "x", ":", "self", ".", "src_attn", "(", "x", ",", "m", ",", "m", ",", "src_mask", ")", ")", "\n", "return", "self", ".", "sublayer", "[", "2", "]", "(", "x", ",", "self", ".", "feed_forward", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.MultiHeadedAttention.__init__": [[177, 187], ["torch.Module.__init__", "RelationTransformerModel.clones", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.Linear", "torch.Linear", "torch.Linear"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["    ", "def", "__init__", "(", "self", ",", "h", ",", "d_model", ",", "dropout", "=", "0.1", ")", ":", "\n", "        ", "\"Take in model size and number of heads.\"", "\n", "super", "(", "MultiHeadedAttention", ",", "self", ")", ".", "__init__", "(", ")", "\n", "assert", "d_model", "%", "h", "==", "0", "\n", "# We assume d_v always equals d_k", "\n", "self", ".", "d_k", "=", "d_model", "//", "h", "\n", "self", ".", "h", "=", "h", "\n", "self", ".", "linears", "=", "clones", "(", "nn", ".", "Linear", "(", "d_model", ",", "d_model", ")", ",", "4", ")", "\n", "self", ".", "attn", "=", "None", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "p", "=", "dropout", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.MultiHeadedAttention.forward": [[188, 208], ["query.size", "RelationTransformerModel.attention", "x.transpose().contiguous().view.transpose().contiguous().view.transpose().contiguous().view", "mask.unsqueeze.unsqueeze.unsqueeze", "l().view().transpose", "zip", "x.transpose().contiguous().view.transpose().contiguous().view.transpose().contiguous", "l().view", "x.transpose().contiguous().view.transpose().contiguous().view.transpose", "l"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.attention"], ["", "def", "forward", "(", "self", ",", "query", ",", "key", ",", "value", ",", "mask", "=", "None", ")", ":", "\n", "        ", "\"Implements Figure 2\"", "\n", "if", "mask", "is", "not", "None", ":", "\n", "# Same mask applied to all h heads.", "\n", "            ", "mask", "=", "mask", ".", "unsqueeze", "(", "1", ")", "\n", "", "nbatches", "=", "query", ".", "size", "(", "0", ")", "\n", "\n", "# 1) Do all the linear projections in batch from d_model => h x d_k", "\n", "query", ",", "key", ",", "value", "=", "[", "l", "(", "x", ")", ".", "view", "(", "nbatches", ",", "-", "1", ",", "self", ".", "h", ",", "self", ".", "d_k", ")", ".", "transpose", "(", "1", ",", "2", ")", "\n", "for", "l", ",", "x", "in", "zip", "(", "self", ".", "linears", ",", "(", "query", ",", "key", ",", "value", ")", ")", "]", "\n", "\n", "# 2) Apply attention on all the projected vectors in batch.", "\n", "x", ",", "self", ".", "attn", "=", "attention", "(", "query", ",", "key", ",", "value", ",", "mask", "=", "mask", ",", "\n", "dropout", "=", "self", ".", "dropout", ")", "\n", "\n", "# 3) \"Concat\" using a view and apply a final linear.", "\n", "x", "=", "x", ".", "transpose", "(", "1", ",", "2", ")", ".", "contiguous", "(", ")", ".", "view", "(", "nbatches", ",", "-", "1", ",", "self", ".", "h", "*", "self", ".", "d_k", ")", "\n", "return", "self", ".", "linears", "[", "-", "1", "]", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.BoxMultiHeadedAttention.__init__": [[251, 274], ["torch.Module.__init__", "RelationTransformerModel.clones", "RelationTransformerModel.clones", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["def", "__init__", "(", "self", ",", "h", ",", "d_model", ",", "trignometric_embedding", "=", "True", ",", "legacy_extra_skip", "=", "False", ",", "dropout", "=", "0.1", ")", ":", "\n", "        ", "\"Take in model size and number of heads.\"", "\n", "super", "(", "BoxMultiHeadedAttention", ",", "self", ")", ".", "__init__", "(", ")", "\n", "\n", "assert", "d_model", "%", "h", "==", "0", "\n", "self", ".", "trignometric_embedding", "=", "trignometric_embedding", "\n", "self", ".", "legacy_extra_skip", "=", "legacy_extra_skip", "\n", "\n", "# We assume d_v always equals d_k", "\n", "self", ".", "h", "=", "h", "\n", "self", ".", "d_k", "=", "d_model", "//", "h", "\n", "if", "self", ".", "trignometric_embedding", ":", "\n", "            ", "self", ".", "dim_g", "=", "64", "\n", "", "else", ":", "\n", "            ", "self", ".", "dim_g", "=", "4", "\n", "", "geo_feature_dim", "=", "self", ".", "dim_g", "\n", "\n", "#matrices W_q, W_k, W_v, and one last projection layer", "\n", "self", ".", "linears", "=", "clones", "(", "nn", ".", "Linear", "(", "d_model", ",", "d_model", ")", ",", "4", ")", "\n", "self", ".", "WGs", "=", "clones", "(", "nn", ".", "Linear", "(", "geo_feature_dim", ",", "1", ",", "bias", "=", "True", ")", ",", "8", ")", "\n", "\n", "self", ".", "attn", "=", "None", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "p", "=", "dropout", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.BoxMultiHeadedAttention.forward": [[276, 313], ["input_query.size", "misc.BoxRelationalEmbedding", "misc.BoxRelationalEmbedding.view", "list", "list.insert", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.relu", "torch.relu", "torch.relu", "RelationTransformerModel.box_attention", "x.transpose().contiguous().view.transpose().contiguous().view.transpose().contiguous().view", "mask.unsqueeze.unsqueeze.unsqueeze", "l().view().transpose", "l().view", "zip", "x.transpose().contiguous().view.transpose().contiguous().view.transpose().contiguous", "l().view", "l", "x.transpose().contiguous().view.transpose().contiguous().view.transpose", "l"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.BoxRelationalEmbedding", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.box_attention"], ["", "def", "forward", "(", "self", ",", "input_query", ",", "input_key", ",", "input_value", ",", "input_box", ",", "mask", "=", "None", ")", ":", "\n", "        ", "\"Implements Figure 2 of Relation Network for Object Detection\"", "\n", "if", "mask", "is", "not", "None", ":", "\n", "# Same mask applied to all h heads.", "\n", "            ", "mask", "=", "mask", ".", "unsqueeze", "(", "1", ")", "\n", "", "nbatches", "=", "input_query", ".", "size", "(", "0", ")", "\n", "\n", "#tensor with entries R_mn given by a hardcoded embedding of the relative position between bbox_m and bbox_n", "\n", "relative_geometry_embeddings", "=", "utils", ".", "BoxRelationalEmbedding", "(", "input_box", ",", "trignometric_embedding", "=", "self", ".", "trignometric_embedding", ")", "\n", "flatten_relative_geometry_embeddings", "=", "relative_geometry_embeddings", ".", "view", "(", "-", "1", ",", "self", ".", "dim_g", ")", "\n", "\n", "# 1) Do all the linear projections in batch from d_model => h x d_k", "\n", "query", ",", "key", ",", "value", "=", "[", "l", "(", "x", ")", ".", "view", "(", "nbatches", ",", "-", "1", ",", "self", ".", "h", ",", "self", ".", "d_k", ")", ".", "transpose", "(", "1", ",", "2", ")", "\n", "for", "l", ",", "x", "in", "zip", "(", "self", ".", "linears", ",", "(", "input_query", ",", "input_key", ",", "input_value", ")", ")", "]", "\n", "box_size_per_head", "=", "list", "(", "relative_geometry_embeddings", ".", "shape", "[", ":", "3", "]", ")", "\n", "box_size_per_head", ".", "insert", "(", "1", ",", "1", ")", "\n", "relative_geometry_weights_per_head", "=", "[", "l", "(", "flatten_relative_geometry_embeddings", ")", ".", "view", "(", "box_size_per_head", ")", "for", "l", "in", "self", ".", "WGs", "]", "\n", "relative_geometry_weights", "=", "torch", ".", "cat", "(", "(", "relative_geometry_weights_per_head", ")", ",", "1", ")", "\n", "relative_geometry_weights", "=", "F", ".", "relu", "(", "relative_geometry_weights", ")", "\n", "\n", "# 2) Apply attention on all the projected vectors in batch.", "\n", "x", ",", "self", ".", "box_attn", "=", "box_attention", "(", "query", ",", "key", ",", "value", ",", "relative_geometry_weights", ",", "mask", "=", "mask", ",", "\n", "dropout", "=", "self", ".", "dropout", ")", "\n", "\n", "# 3) \"Concat\" using a view and apply a final linear.", "\n", "x", "=", "x", ".", "transpose", "(", "1", ",", "2", ")", ".", "contiguous", "(", ")", ".", "view", "(", "nbatches", ",", "-", "1", ",", "self", ".", "h", "*", "self", ".", "d_k", ")", "\n", "\n", "# An extra internal skip connection is added. This is only", "\n", "# kept here for compatibility with some legacy models. In", "\n", "# general, there is no advantage in using it, as there is", "\n", "# already an outer skip connection surrounding this layer.", "\n", "if", "self", ".", "legacy_extra_skip", ":", "\n", "            ", "x", "=", "input_value", "+", "x", "\n", "\n", "", "return", "self", ".", "linears", "[", "-", "1", "]", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.PositionwiseFeedForward.__init__": [[317, 322], ["torch.Module.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Dropout", "torch.Dropout", "torch.Dropout"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "d_model", ",", "d_ff", ",", "dropout", "=", "0.1", ")", ":", "\n", "        ", "super", "(", "PositionwiseFeedForward", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "w_1", "=", "nn", ".", "Linear", "(", "d_model", ",", "d_ff", ")", "\n", "self", ".", "w_2", "=", "nn", ".", "Linear", "(", "d_ff", ",", "d_model", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "dropout", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.PositionwiseFeedForward.forward": [[323, 325], ["RelationTransformerModel.PositionwiseFeedForward.w_2", "RelationTransformerModel.PositionwiseFeedForward.dropout", "torch.relu", "torch.relu", "torch.relu", "RelationTransformerModel.PositionwiseFeedForward.w_1"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "return", "self", ".", "w_2", "(", "self", ".", "dropout", "(", "F", ".", "relu", "(", "self", ".", "w_1", "(", "x", ")", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.Embeddings.__init__": [[328, 332], ["torch.Module.__init__", "torch.Embedding", "torch.Embedding", "torch.Embedding"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "d_model", ",", "vocab", ")", ":", "\n", "        ", "super", "(", "Embeddings", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "lut", "=", "nn", ".", "Embedding", "(", "vocab", ",", "d_model", ")", "\n", "self", ".", "d_model", "=", "d_model", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.Embeddings.forward": [[333, 335], ["RelationTransformerModel.Embeddings.lut", "math.sqrt"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "return", "self", ".", "lut", "(", "x", ")", "*", "math", ".", "sqrt", "(", "self", ".", "d_model", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.PositionalEncoding.__init__": [[338, 351], ["torch.Module.__init__", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "pe.unsqueeze.unsqueeze.unsqueeze", "RelationTransformerModel.PositionalEncoding.register_buffer", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "math.log"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "d_model", ",", "dropout", ",", "max_len", "=", "5000", ")", ":", "\n", "        ", "super", "(", "PositionalEncoding", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "p", "=", "dropout", ")", "\n", "\n", "# Compute the positional encodings once in log space.", "\n", "pe", "=", "torch", ".", "zeros", "(", "max_len", ",", "d_model", ")", "\n", "position", "=", "torch", ".", "arange", "(", "0", ",", "max_len", ")", ".", "unsqueeze", "(", "1", ")", ".", "float", "(", ")", "\n", "div_term", "=", "torch", ".", "exp", "(", "torch", ".", "arange", "(", "0", ",", "d_model", ",", "2", ")", ".", "float", "(", ")", "*", "\n", "-", "(", "math", ".", "log", "(", "10000.0", ")", "/", "d_model", ")", ")", "\n", "pe", "[", ":", ",", "0", ":", ":", "2", "]", "=", "torch", ".", "sin", "(", "position", "*", "div_term", ")", "\n", "pe", "[", ":", ",", "1", ":", ":", "2", "]", "=", "torch", ".", "cos", "(", "position", "*", "div_term", ")", "\n", "pe", "=", "pe", ".", "unsqueeze", "(", "0", ")", "\n", "self", ".", "register_buffer", "(", "'pe'", ",", "pe", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.PositionalEncoding.forward": [[352, 355], ["RelationTransformerModel.PositionalEncoding.dropout", "x.size"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "x", "=", "x", "+", "self", ".", "pe", "[", ":", ",", ":", "x", ".", "size", "(", "1", ")", "]", "\n", "return", "self", ".", "dropout", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.RelationTransformerModel.make_model": [[359, 383], ["RelationTransformerModel.BoxMultiHeadedAttention", "RelationTransformerModel.MultiHeadedAttention", "RelationTransformerModel.PositionwiseFeedForward", "RelationTransformerModel.PositionalEncoding", "RelationTransformerModel.EncoderDecoder", "EncoderDecoder.parameters", "RelationTransformerModel.Encoder", "RelationTransformerModel.Decoder", "torch.Sequential", "torch.Sequential", "torch.Sequential", "RelationTransformerModel.Generator", "RelationTransformerModel.EncoderLayer", "RelationTransformerModel.DecoderLayer", "RelationTransformerModel.Embeddings", "c", "p.dim", "torch.init.xavier_uniform_", "torch.init.xavier_uniform_", "torch.init.xavier_uniform_", "c", "c", "c", "c", "c"], "methods", ["None"], ["    ", "def", "make_model", "(", "self", ",", "src_vocab", ",", "tgt_vocab", ",", "N", "=", "6", ",", "\n", "d_model", "=", "512", ",", "d_ff", "=", "2048", ",", "h", "=", "8", ",", "dropout", "=", "0.1", ",", "\n", "trignometric_embedding", "=", "True", ",", "legacy_extra_skip", "=", "False", ")", ":", "\n", "        ", "\"Helper: Construct a model from hyperparameters.\"", "\n", "c", "=", "copy", ".", "deepcopy", "\n", "bbox_attn", "=", "BoxMultiHeadedAttention", "(", "h", ",", "d_model", ",", "trignometric_embedding", ",", "legacy_extra_skip", ")", "\n", "attn", "=", "MultiHeadedAttention", "(", "h", ",", "d_model", ")", "\n", "ff", "=", "PositionwiseFeedForward", "(", "d_model", ",", "d_ff", ",", "dropout", ")", "\n", "position", "=", "PositionalEncoding", "(", "d_model", ",", "dropout", ")", "\n", "#position = BoxEncoding(d_model, dropout)", "\n", "model", "=", "EncoderDecoder", "(", "\n", "Encoder", "(", "EncoderLayer", "(", "d_model", ",", "c", "(", "bbox_attn", ")", ",", "c", "(", "ff", ")", ",", "dropout", ")", ",", "N", ")", ",", "\n", "Decoder", "(", "DecoderLayer", "(", "d_model", ",", "c", "(", "attn", ")", ",", "c", "(", "attn", ")", ",", "\n", "c", "(", "ff", ")", ",", "dropout", ")", ",", "N", ")", ",", "\n", "lambda", "x", ":", "x", ",", "# nn.Sequential(Embeddings(d_model, src_vocab), c(position)),", "\n", "nn", ".", "Sequential", "(", "Embeddings", "(", "d_model", ",", "tgt_vocab", ")", ",", "c", "(", "position", ")", ")", ",", "\n", "Generator", "(", "d_model", ",", "tgt_vocab", ")", ")", "\n", "\n", "# This was important from their code.", "\n", "# Initialize parameters with Glorot / fan_avg.", "\n", "for", "p", "in", "model", ".", "parameters", "(", ")", ":", "\n", "            ", "if", "p", ".", "dim", "(", ")", ">", "1", ":", "\n", "                ", "nn", ".", "init", ".", "xavier_uniform_", "(", "p", ")", "\n", "", "", "return", "model", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.RelationTransformerModel.__init__": [[384, 427], ["CaptionModel.CaptionModel.__init__", "getattr", "torch.Sequential", "torch.Sequential", "torch.Sequential", "getattr", "getattr", "RelationTransformerModel.RelationTransformerModel.make_model", "torch.Linear", "torch.Linear", "torch.Linear", "torch.ReLU", "torch.ReLU", "torch.ReLU", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.make_model"], ["", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "RelationTransformerModel", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "opt", "=", "opt", "\n", "# self.config = yaml.load(open(opt.config_file))", "\n", "# d_model = self.input_encoding_size # 512", "\n", "\n", "self", ".", "vocab_size", "=", "opt", ".", "vocab_size", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "# #self.rnn_type = opt.rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "# self.num_layers = opt.num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "seq_length", "=", "opt", ".", "seq_length", "\n", "# self.fc_feat_size = opt.fc_feat_size", "\n", "self", ".", "att_feat_size", "=", "opt", ".", "att_feat_size", "\n", "# self.att_hid_size = opt.att_hid_size", "\n", "\n", "self", ".", "use_bn", "=", "getattr", "(", "opt", ",", "'use_bn'", ",", "0", ")", "\n", "\n", "self", ".", "ss_prob", "=", "0.0", "# Schedule sampling probability", "\n", "\n", "# self.embed = nn.Sequential(nn.Embedding(self.vocab_size + 1, self.input_encoding_size),", "\n", "#                         nn.ReLU(),", "\n", "#                         nn.Dropout(self.drop_prob_lm))", "\n", "# self.fc_embed = nn.Sequential(nn.Linear(self.fc_feat_size, self.rnn_size),", "\n", "#                             nn.ReLU(),", "\n", "#                             nn.Dropout(self.drop_prob_lm))", "\n", "self", ".", "att_embed", "=", "nn", ".", "Sequential", "(", "*", "(", "\n", "(", "(", "nn", ".", "BatchNorm1d", "(", "self", ".", "att_feat_size", ")", ",", ")", "if", "self", ".", "use_bn", "else", "(", ")", ")", "+", "\n", "(", "nn", ".", "Linear", "(", "self", ".", "att_feat_size", ",", "self", ".", "input_encoding_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", ")", "+", "\n", "(", "(", "nn", ".", "BatchNorm1d", "(", "self", ".", "input_encoding_size", ")", ",", ")", "if", "self", ".", "use_bn", "==", "2", "else", "(", ")", ")", ")", ")", "\n", "\n", "self", ".", "box_trignometric_embedding", "=", "getattr", "(", "opt", ",", "'box_trignometric_embedding'", ",", "True", ")", "\n", "self", ".", "legacy_extra_skip", "=", "getattr", "(", "opt", ",", "'legacy_extra_skip'", ",", "False", ")", "\n", "\n", "tgt_vocab", "=", "self", ".", "vocab_size", "+", "1", "\n", "self", ".", "model", "=", "self", ".", "make_model", "(", "\n", "0", ",", "tgt_vocab", ",", "N", "=", "opt", ".", "num_layers", ",", "d_model", "=", "opt", ".", "input_encoding_size", ",", "\n", "d_ff", "=", "opt", ".", "rnn_size", ",", "\n", "trignometric_embedding", "=", "self", ".", "box_trignometric_embedding", ",", "\n", "legacy_extra_skip", "=", "self", ".", "legacy_extra_skip", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.RelationTransformerModel.clip_att": [[433, 440], ["att_masks[].contiguous.data.long().sum().max", "att_feats[].contiguous", "att_masks[].contiguous", "att_masks[].contiguous.data.long().sum", "att_masks[].contiguous.data.long"], "methods", ["None"], ["", "def", "clip_att", "(", "self", ",", "att_feats", ",", "att_masks", ")", ":", "\n", "# Clip the length of att_masks and att_feats to the maximum length", "\n", "        ", "if", "att_masks", "is", "not", "None", ":", "\n", "            ", "max_len", "=", "att_masks", ".", "data", ".", "long", "(", ")", ".", "sum", "(", "1", ")", ".", "max", "(", ")", "\n", "att_feats", "=", "att_feats", "[", ":", ",", ":", "max_len", "]", ".", "contiguous", "(", ")", "\n", "att_masks", "=", "att_masks", "[", ":", ",", ":", "max_len", "]", ".", "contiguous", "(", ")", "\n", "", "return", "att_feats", ",", "att_masks", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.RelationTransformerModel._prepare_feature": [[452, 474], ["RelationTransformerModel.RelationTransformerModel.clip_att", "AttModel.pack_wrapper", "AttModel.pack_wrapper.new_ones.unsqueeze", "RelationTransformerModel.RelationTransformerModel.clip_att", "AttModel.pack_wrapper.new_ones", "seq_mask.unsqueeze.unsqueeze.unsqueeze", "subsequent_mask().to", "RelationTransformerModel.subsequent_mask", "seq.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.clip_att", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.pack_wrapper", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.clip_att", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.subsequent_mask"], ["", "def", "_prepare_feature", "(", "self", ",", "att_feats", ",", "att_masks", "=", "None", ",", "boxes", "=", "None", ",", "seq", "=", "None", ")", ":", "\n", "\n", "        ", "att_feats", ",", "att_masks", "=", "self", ".", "clip_att", "(", "att_feats", ",", "att_masks", ")", "\n", "att_feats", "=", "pack_wrapper", "(", "self", ".", "att_embed", ",", "att_feats", ",", "att_masks", ")", "\n", "boxes", "=", "self", ".", "clip_att", "(", "boxes", ",", "att_masks", ")", "[", "0", "]", "\n", "\n", "if", "att_masks", "is", "None", ":", "\n", "            ", "att_masks", "=", "att_feats", ".", "new_ones", "(", "att_feats", ".", "shape", "[", ":", "2", "]", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "", "att_masks", "=", "att_masks", ".", "unsqueeze", "(", "-", "2", ")", "\n", "\n", "if", "seq", "is", "not", "None", ":", "\n", "# crop the last one", "\n", "            ", "seq", "=", "seq", "[", ":", ",", ":", "-", "1", "]", "\n", "seq_mask", "=", "(", "seq", ".", "data", ">", "0", ")", "\n", "seq_mask", "[", ":", ",", "0", "]", "=", "1", "\n", "\n", "seq_mask", "=", "seq_mask", ".", "unsqueeze", "(", "-", "2", ")", "\n", "seq_mask", "=", "seq_mask", "&", "subsequent_mask", "(", "seq", ".", "size", "(", "-", "1", ")", ")", ".", "to", "(", "seq_mask", ")", "\n", "", "else", ":", "\n", "            ", "seq_mask", "=", "None", "\n", "\n", "", "return", "att_feats", ",", "boxes", ",", "seq", ",", "att_masks", ",", "seq_mask", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.RelationTransformerModel._forward": [[475, 481], ["RelationTransformerModel.RelationTransformerModel._prepare_feature", "RelationTransformerModel.RelationTransformerModel.model", "RelationTransformerModel.RelationTransformerModel.model.generator"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature"], ["", "def", "_forward", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "boxes", ",", "seq", ",", "att_masks", "=", "None", ")", ":", "\n", "\n", "        ", "att_feats", ",", "boxes", ",", "seq", ",", "att_masks", ",", "seq_mask", "=", "self", ".", "_prepare_feature", "(", "att_feats", ",", "att_masks", ",", "boxes", ",", "seq", ")", "\n", "out", "=", "self", ".", "model", "(", "att_feats", ",", "boxes", ",", "seq", ",", "att_masks", ",", "seq_mask", ")", "\n", "outputs", "=", "self", ".", "model", ".", "generator", "(", "out", ")", "\n", "return", "outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.RelationTransformerModel.get_logprobs_state": [[483, 498], ["RelationTransformerModel.RelationTransformerModel.model.decode", "RelationTransformerModel.RelationTransformerModel.model.generator", "it.unsqueeze", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "subsequent_mask().to", "torch.cat.unsqueeze", "torch.cat.unsqueeze", "torch.cat.unsqueeze", "it.unsqueeze", "RelationTransformerModel.subsequent_mask", "torch.cat.size", "torch.cat.size", "torch.cat.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.decode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.subsequent_mask"], ["", "def", "get_logprobs_state", "(", "self", ",", "it", ",", "memory", ",", "mask", ",", "state", ")", ":", "\n", "        ", "\"\"\"\n        state = [ys.unsqueeze(0)]\n        \"\"\"", "\n", "if", "state", "is", "None", ":", "\n", "            ", "ys", "=", "it", ".", "unsqueeze", "(", "1", ")", "\n", "", "else", ":", "\n", "            ", "ys", "=", "torch", ".", "cat", "(", "[", "state", "[", "0", "]", "[", "0", "]", ",", "it", ".", "unsqueeze", "(", "1", ")", "]", ",", "dim", "=", "1", ")", "\n", "", "out", "=", "self", ".", "model", ".", "decode", "(", "memory", ",", "mask", ",", "\n", "ys", ",", "\n", "subsequent_mask", "(", "ys", ".", "size", "(", "1", ")", ")", "\n", ".", "to", "(", "memory", ".", "device", ")", ")", "\n", "logprobs", "=", "self", ".", "model", ".", "generator", "(", "out", "[", ":", ",", "-", "1", "]", ")", "\n", "\n", "return", "logprobs", ",", "[", "ys", ".", "unsqueeze", "(", "0", ")", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.RelationTransformerModel._sample_beam": [[499, 528], ["opt.get", "fc_feats.size", "RelationTransformerModel.RelationTransformerModel._prepare_feature", "RelationTransformerModel.RelationTransformerModel.model.encode", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "range", "memory[].expand().contiguous", "range", "RelationTransformerModel.RelationTransformerModel.beam_search", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "range", "att_masks[].expand().contiguous", "RelationTransformerModel.RelationTransformerModel.get_logprobs_state", "memory[].expand", "fc_feats.new_zeros", "att_masks[].expand", "RelationTransformerModel.RelationTransformerModel.size", "att_masks.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.encode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.beam_search", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.get_logprobs_state"], ["", "def", "_sample_beam", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "10", ")", "\n", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "\n", "att_feats", ",", "boxes", ",", "seq", ",", "att_masks", ",", "seq_mask", "=", "self", ".", "_prepare_feature", "(", "att_feats", ",", "att_masks", ",", "boxes", ")", "\n", "memory", "=", "self", ".", "model", ".", "encode", "(", "att_feats", ",", "boxes", ",", "att_masks", ")", "\n", "\n", "assert", "beam_size", "<=", "self", ".", "vocab_size", "+", "1", ",", "'lets assume this for now, otherwise this corner case causes a few headaches down the road. can be dealt with in future if needed'", "\n", "seq", "=", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", ".", "zero_", "(", ")", "\n", "seqLogprobs", "=", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", "\n", "# lets process every image independently for now, for simplicity", "\n", "\n", "self", ".", "done_beams", "=", "[", "[", "]", "for", "_", "in", "range", "(", "batch_size", ")", "]", "\n", "for", "k", "in", "range", "(", "batch_size", ")", ":", "\n", "            ", "state", "=", "None", "\n", "tmp_memory", "=", "memory", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "memory", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "\n", "tmp_att_masks", "=", "att_masks", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "att_masks", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "if", "att_masks", "is", "not", "None", "else", "None", "\n", "\n", "for", "t", "in", "range", "(", "1", ")", ":", "\n", "                ", "if", "t", "==", "0", ":", "# input <bos>", "\n", "                    ", "it", "=", "fc_feats", ".", "new_zeros", "(", "[", "beam_size", "]", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "\n", "", "logprobs", ",", "state", "=", "self", ".", "get_logprobs_state", "(", "it", ",", "tmp_memory", ",", "tmp_att_masks", ",", "state", ")", "\n", "\n", "", "self", ".", "done_beams", "[", "k", "]", "=", "self", ".", "beam_search", "(", "state", ",", "logprobs", ",", "tmp_memory", ",", "tmp_att_masks", ",", "opt", "=", "opt", ")", "\n", "seq", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'seq'", "]", "# the first beam has highest cumulative score", "\n", "seqLogprobs", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'logps'", "]", "\n", "# return the samples and their log likelihoods", "\n", "", "return", "seq", ".", "transpose", "(", "0", ",", "1", ")", ",", "seqLogprobs", ".", "transpose", "(", "0", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.RelationTransformerModel._sample_": [[529, 573], ["opt.get", "opt.get", "opt.get", "opt.get", "RelationTransformerModel.RelationTransformerModel._prepare_feature", "RelationTransformerModel.RelationTransformerModel.model.encode", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "att_feats.new_zeros", "att_feats.new_zeros", "range", "RelationTransformerModel.RelationTransformerModel._sample_beam", "RelationTransformerModel.RelationTransformerModel.model.decode", "RelationTransformerModel.RelationTransformerModel.model.generator", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "RelationTransformerModel.RelationTransformerModel._sample_", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "subsequent_mask().to", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "logprobs.gather", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.multinomial.unsqueeze", "torch.multinomial.unsqueeze", "torch.multinomial.unsqueeze", "RelationTransformerModel.subsequent_mask", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.cat.size", "torch.cat.size", "torch.cat.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.encode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel._sample_beam", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.decode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel._sample_", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.subsequent_mask"], ["", "def", "_sample_", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "sample_max", "=", "opt", ".", "get", "(", "'sample_max'", ",", "1", ")", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "1", ")", "\n", "temperature", "=", "opt", ".", "get", "(", "'temperature'", ",", "1.0", ")", "\n", "decoding_constraint", "=", "opt", ".", "get", "(", "'decoding_constraint'", ",", "0", ")", "\n", "if", "beam_size", ">", "1", ":", "\n", "            ", "return", "self", ".", "_sample_beam", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ",", "opt", ")", "\n", "\n", "", "if", "sample_max", ":", "\n", "            ", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "                ", "seq_", ",", "seqLogprobs_", "=", "self", ".", "_sample_", "(", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", ",", "opt", ")", "\n", "\n", "", "", "batch_size", "=", "att_feats", ".", "shape", "[", "0", "]", "\n", "\n", "att_feats", ",", "boxes", ",", "seq", ",", "att_masks", ",", "seq_mask", "=", "self", ".", "_prepare_feature", "(", "att_feats", ",", "att_masks", ",", "boxes", ")", "\n", "memory", "=", "self", ".", "model", ".", "encode", "(", "att_feats", ",", "boxes", ",", "att_masks", ")", "\n", "ys", "=", "torch", ".", "zeros", "(", "(", "batch_size", ",", "1", ")", ",", "dtype", "=", "torch", ".", "long", ")", ".", "to", "(", "att_feats", ".", "device", ")", "\n", "\n", "seq", "=", "att_feats", ".", "new_zeros", "(", "(", "batch_size", ",", "self", ".", "seq_length", ")", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "seqLogprobs", "=", "att_feats", ".", "new_zeros", "(", "batch_size", ",", "self", ".", "seq_length", ")", "\n", "\n", "for", "i", "in", "range", "(", "self", ".", "seq_length", ")", ":", "\n", "            ", "out", "=", "self", ".", "model", ".", "decode", "(", "memory", ",", "att_masks", ",", "\n", "ys", ",", "\n", "subsequent_mask", "(", "ys", ".", "size", "(", "1", ")", ")", "\n", ".", "to", "(", "att_feats", ".", "device", ")", ")", "\n", "logprob", "=", "self", ".", "model", ".", "generator", "(", "out", "[", ":", ",", "-", "1", "]", ")", "\n", "if", "sample_max", ":", "\n", "                ", "sampleLogprobs", ",", "next_word", "=", "torch", ".", "max", "(", "logprob", ",", "dim", "=", "1", ")", "\n", "", "else", ":", "\n", "                ", "if", "temperature", "==", "1.0", ":", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "logprob", ".", "data", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "", "else", ":", "\n", "# scale logprobs by temperature", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "torch", ".", "div", "(", "logprob", ".", "data", ",", "temperature", ")", ")", "\n", "", "next_word", "=", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", "\n", "sampleLogprobs", "=", "logprobs", ".", "gather", "(", "1", ",", "next_word", ")", "# gather the logprobs at sampled positions", "\n", "\n", "", "seq", "[", ":", ",", "i", "]", "=", "next_word", "\n", "seqLogprobs", "[", ":", ",", "i", "]", "=", "sampleLogprobs", "\n", "ys", "=", "torch", ".", "cat", "(", "[", "ys", ",", "next_word", ".", "unsqueeze", "(", "1", ")", "]", ",", "dim", "=", "1", ")", "\n", "", "assert", "(", "seq", "*", "(", "(", "seq_", ">", "0", ")", ".", "long", "(", ")", ")", "==", "seq_", ")", ".", "all", "(", ")", ",", "'seq doens\\'t match'", "\n", "assert", "(", "seqLogprobs", "*", "(", "(", "seq_", ">", "0", ")", ".", "float", "(", ")", ")", "-", "seqLogprobs_", "*", "(", "(", "seq_", ">", "0", ")", ".", "float", "(", ")", ")", ")", ".", "abs", "(", ")", ".", "max", "(", ")", "<", "1e-5", ",", "'logprobs doens\\'t match'", "\n", "return", "seq", ",", "seqLogprobs", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.RelationTransformerModel._sample": [[574, 631], ["opt.get", "opt.get", "opt.get", "opt.get", "RelationTransformerModel.RelationTransformerModel._prepare_feature", "RelationTransformerModel.RelationTransformerModel.model.encode", "att_feats.new_zeros", "att_feats.new_zeros", "range", "RelationTransformerModel.RelationTransformerModel._sample_beam", "RelationTransformerModel.RelationTransformerModel.get_logprobs_state", "logprobs.gather.view", "fc_feats.new_zeros", "output.new_zeros", "output.new_zeros.scatter_", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "it.view().long.view().long.view().long", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "logprobs.gather", "it.view().long.view().long.view().long", "unfinished.type_as", "unfinished.sum", "output.size", "seq[].data.unsqueeze", "float", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "it.view().long.view().long.view", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "it.view().long.view().long.view"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.encode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel._sample_beam", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.get_logprobs_state"], ["", "def", "_sample", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "sample_max", "=", "opt", ".", "get", "(", "'sample_max'", ",", "1", ")", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "1", ")", "\n", "temperature", "=", "opt", ".", "get", "(", "'temperature'", ",", "1.0", ")", "\n", "decoding_constraint", "=", "opt", ".", "get", "(", "'decoding_constraint'", ",", "0", ")", "\n", "if", "beam_size", ">", "1", ":", "\n", "            ", "return", "self", ".", "_sample_beam", "(", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", ",", "opt", ")", "\n", "\n", "", "batch_size", "=", "att_feats", ".", "shape", "[", "0", "]", "\n", "\n", "att_feats", ",", "boxes", ",", "seq", ",", "att_masks", ",", "seq_mask", "=", "self", ".", "_prepare_feature", "(", "att_feats", ",", "att_masks", ",", "boxes", ")", "\n", "\n", "state", "=", "None", "\n", "memory", "=", "self", ".", "model", ".", "encode", "(", "att_feats", ",", "boxes", ",", "att_masks", ")", "\n", "\n", "seq", "=", "att_feats", ".", "new_zeros", "(", "(", "batch_size", ",", "self", ".", "seq_length", ")", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "seqLogprobs", "=", "att_feats", ".", "new_zeros", "(", "batch_size", ",", "self", ".", "seq_length", ")", "\n", "\n", "for", "t", "in", "range", "(", "self", ".", "seq_length", "+", "1", ")", ":", "\n", "            ", "if", "t", "==", "0", ":", "# input <bos>", "\n", "                ", "it", "=", "fc_feats", ".", "new_zeros", "(", "batch_size", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "\n", "", "logprobs", ",", "state", "=", "self", ".", "get_logprobs_state", "(", "it", ",", "memory", ",", "att_masks", ",", "state", ")", "\n", "if", "decoding_constraint", "and", "t", ">", "0", ":", "\n", "                ", "tmp", "=", "output", ".", "new_zeros", "(", "output", ".", "size", "(", "0", ")", ",", "self", ".", "vocab_size", "+", "1", ")", "\n", "tmp", ".", "scatter_", "(", "1", ",", "seq", "[", ":", ",", "t", "-", "1", "]", ".", "data", ".", "unsqueeze", "(", "1", ")", ",", "float", "(", "'-inf'", ")", ")", "\n", "logprobs", "=", "logprobs", "+", "tmp", "\n", "\n", "# sample the next word", "\n", "", "if", "t", "==", "self", ".", "seq_length", ":", "# skip if we achieve maximum length", "\n", "                ", "break", "\n", "", "if", "sample_max", ":", "\n", "                ", "sampleLogprobs", ",", "it", "=", "torch", ".", "max", "(", "logprobs", ".", "data", ",", "1", ")", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "\n", "", "else", ":", "\n", "                ", "if", "temperature", "==", "1.0", ":", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "logprobs", ".", "data", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "", "else", ":", "\n", "# scale logprobs by temperature", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "torch", ".", "div", "(", "logprobs", ".", "data", ",", "temperature", ")", ")", "\n", "", "it", "=", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", "\n", "sampleLogprobs", "=", "logprobs", ".", "gather", "(", "1", ",", "it", ")", "# gather the logprobs at sampled positions", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "# and flatten indices for downstream processing", "\n", "\n", "# stop when all finished", "\n", "", "if", "t", "==", "0", ":", "\n", "                ", "unfinished", "=", "it", ">", "0", "\n", "", "else", ":", "\n", "                ", "unfinished", "=", "unfinished", "*", "(", "it", ">", "0", ")", "\n", "", "it", "=", "it", "*", "unfinished", ".", "type_as", "(", "it", ")", "\n", "seq", "[", ":", ",", "t", "]", "=", "it", "\n", "seqLogprobs", "[", ":", ",", "t", "]", "=", "sampleLogprobs", ".", "view", "(", "-", "1", ")", "\n", "# quit loop if all sequences have finished", "\n", "if", "unfinished", ".", "sum", "(", ")", "==", "0", ":", "\n", "                ", "break", "\n", "\n", "", "", "return", "seq", ",", "seqLogprobs", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.clones": [[71, 74], ["torch.ModuleList", "copy.deepcopy", "range"], "function", ["None"], ["", "", "def", "clones", "(", "module", ",", "N", ")", ":", "\n", "    ", "\"Produce N identical layers.\"", "\n", "return", "nn", ".", "ModuleList", "(", "[", "copy", ".", "deepcopy", "(", "module", ")", "for", "_", "in", "range", "(", "N", ")", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.subsequent_mask": [[158, 163], ["numpy.triu().astype", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy", "numpy.triu", "numpy.ones"], "function", ["None"], ["", "", "def", "subsequent_mask", "(", "size", ")", ":", "\n", "    ", "\"Mask out subsequent positions.\"", "\n", "attn_shape", "=", "(", "1", ",", "size", ",", "size", ")", "\n", "subsequent_mask", "=", "np", ".", "triu", "(", "np", ".", "ones", "(", "attn_shape", ")", ",", "k", "=", "1", ")", ".", "astype", "(", "'uint8'", ")", "\n", "return", "torch", ".", "from_numpy", "(", "subsequent_mask", ")", "==", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.attention": [[164, 175], ["query.size", "torch.softmax", "torch.matmul", "torch.matmul", "torch.matmul", "math.sqrt", "scores.masked_fill.masked_fill", "dropout", "torch.matmul", "torch.matmul", "torch.matmul", "key.transpose"], "function", ["None"], ["", "def", "attention", "(", "query", ",", "key", ",", "value", ",", "mask", "=", "None", ",", "dropout", "=", "None", ")", ":", "\n", "    ", "\"Compute 'Scaled Dot Product Attention'\"", "\n", "d_k", "=", "query", ".", "size", "(", "-", "1", ")", "\n", "scores", "=", "torch", ".", "matmul", "(", "query", ",", "key", ".", "transpose", "(", "-", "2", ",", "-", "1", ")", ")", "/", "math", ".", "sqrt", "(", "d_k", ")", "\n", "if", "mask", "is", "not", "None", ":", "\n", "        ", "scores", "=", "scores", ".", "masked_fill", "(", "mask", "==", "0", ",", "-", "1e9", ")", "\n", "", "p_attn", "=", "F", ".", "softmax", "(", "scores", ",", "dim", "=", "-", "1", ")", "\n", "if", "dropout", "is", "not", "None", ":", "\n", "        ", "p_attn", "=", "dropout", "(", "p_attn", ")", "\n", "", "return", "torch", ".", "matmul", "(", "p_attn", ",", "value", ")", ",", "p_attn", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.RelationTransformerModel.box_attention": [[210, 244], ["key.size", "key.transpose", "torch.matmul", "torch.matmul", "torch.matmul", "torch.matmul", "torch.matmul", "torch.matmul", "value.size", "box_relation_embds_matrix.size", "numpy.sqrt", "scaled_dot.masked_fill.masked_fill", "torch.log", "torch.log", "torch.log", "torch.nn.Softmax", "torch.nn.Softmax", "torch.nn.Softmax", "dropout", "torch.clamp", "torch.clamp", "torch.clamp"], "function", ["None"], ["", "", "def", "box_attention", "(", "query", ",", "key", ",", "value", ",", "box_relation_embds_matrix", ",", "mask", "=", "None", ",", "dropout", "=", "None", ")", ":", "\n", "    ", "'''\n    Compute 'Scaled Dot Product Attention as in paper Relation Networks for Object Detection'.\n    Follow the implementation in https://github.com/heefe92/Relation_Networks-pytorch/blob/master/model.py#L1026-L1055\n    '''", "\n", "\n", "N", "=", "value", ".", "size", "(", ")", "[", ":", "2", "]", "\n", "dim_k", "=", "key", ".", "size", "(", "-", "1", ")", "\n", "dim_g", "=", "box_relation_embds_matrix", ".", "size", "(", ")", "[", "-", "1", "]", "\n", "\n", "w_q", "=", "query", "\n", "w_k", "=", "key", ".", "transpose", "(", "-", "2", ",", "-", "1", ")", "\n", "w_v", "=", "value", "\n", "\n", "#attention weights", "\n", "scaled_dot", "=", "torch", ".", "matmul", "(", "w_q", ",", "w_k", ")", "\n", "scaled_dot", "=", "scaled_dot", "/", "np", ".", "sqrt", "(", "dim_k", ")", "\n", "if", "mask", "is", "not", "None", ":", "\n", "        ", "scaled_dot", "=", "scaled_dot", ".", "masked_fill", "(", "mask", "==", "0", ",", "-", "1e9", ")", "\n", "\n", "#w_g = box_relation_embds_matrix.view(N,N)", "\n", "", "w_g", "=", "box_relation_embds_matrix", "\n", "w_a", "=", "scaled_dot", "\n", "#w_a = scaled_dot.view(N,N)", "\n", "\n", "# multiplying log of geometric weights by feature weights", "\n", "w_mn", "=", "torch", ".", "log", "(", "torch", ".", "clamp", "(", "w_g", ",", "min", "=", "1e-6", ")", ")", "+", "w_a", "\n", "w_mn", "=", "torch", ".", "nn", ".", "Softmax", "(", "dim", "=", "-", "1", ")", "(", "w_mn", ")", "\n", "if", "dropout", "is", "not", "None", ":", "\n", "        ", "w_mn", "=", "dropout", "(", "w_mn", ")", "\n", "\n", "", "output", "=", "torch", ".", "matmul", "(", "w_mn", ",", "w_v", ")", "\n", "\n", "return", "output", ",", "w_mn", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.__init__": [[37, 44], ["torch.Module.__init__"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "encoder", ",", "decoder", ",", "src_embed", ",", "tgt_embed", ",", "generator", ")", ":", "\n", "        ", "super", "(", "EncoderDecoder", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "encoder", "=", "encoder", "\n", "self", ".", "decoder", "=", "decoder", "\n", "self", ".", "src_embed", "=", "src_embed", "\n", "self", ".", "tgt_embed", "=", "tgt_embed", "\n", "self", ".", "generator", "=", "generator", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.forward": [[46, 50], ["TransformerModel.EncoderDecoder.decode", "TransformerModel.EncoderDecoder.encode"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.decode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.encode"], ["", "def", "forward", "(", "self", ",", "src", ",", "tgt", ",", "src_mask", ",", "tgt_mask", ")", ":", "\n", "        ", "\"Take in and process masked src and target sequences.\"", "\n", "return", "self", ".", "decode", "(", "self", ".", "encode", "(", "src", ",", "src_mask", ")", ",", "src_mask", ",", "\n", "tgt", ",", "tgt_mask", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.encode": [[51, 53], ["TransformerModel.EncoderDecoder.encoder", "TransformerModel.EncoderDecoder.src_embed"], "methods", ["None"], ["", "def", "encode", "(", "self", ",", "src", ",", "src_mask", ")", ":", "\n", "        ", "return", "self", ".", "encoder", "(", "self", ".", "src_embed", "(", "src", ")", ",", "src_mask", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.decode": [[54, 56], ["TransformerModel.EncoderDecoder.decoder", "TransformerModel.EncoderDecoder.tgt_embed"], "methods", ["None"], ["", "def", "decode", "(", "self", ",", "memory", ",", "src_mask", ",", "tgt", ",", "tgt_mask", ")", ":", "\n", "        ", "return", "self", ".", "decoder", "(", "self", ".", "tgt_embed", "(", "tgt", ")", ",", "memory", ",", "src_mask", ",", "tgt_mask", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.Generator.__init__": [[59, 62], ["torch.Module.__init__", "torch.Linear", "torch.Linear", "torch.Linear"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "d_model", ",", "vocab", ")", ":", "\n", "        ", "super", "(", "Generator", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "proj", "=", "nn", ".", "Linear", "(", "d_model", ",", "vocab", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.Generator.forward": [[63, 65], ["torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "TransformerModel.Generator.proj"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "return", "F", ".", "log_softmax", "(", "self", ".", "proj", "(", "x", ")", ",", "dim", "=", "-", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.Encoder.__init__": [[72, 76], ["torch.Module.__init__", "TransformerModel.clones", "TransformerModel.LayerNorm"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["def", "__init__", "(", "self", ",", "layer", ",", "N", ")", ":", "\n", "        ", "super", "(", "Encoder", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "layers", "=", "clones", "(", "layer", ",", "N", ")", "\n", "self", ".", "norm", "=", "LayerNorm", "(", "layer", ".", "size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.Encoder.forward": [[77, 82], ["TransformerModel.Encoder.norm", "layer"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "mask", ")", ":", "\n", "        ", "\"Pass the input (and mask) through each layer in turn.\"", "\n", "for", "layer", "in", "self", ".", "layers", ":", "\n", "            ", "x", "=", "layer", "(", "x", ",", "mask", ")", "\n", "", "return", "self", ".", "norm", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.LayerNorm.__init__": [[85, 90], ["torch.Module.__init__", "torch.Parameter", "torch.Parameter", "torch.Parameter", "torch.Parameter", "torch.Parameter", "torch.Parameter", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.ones", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "features", ",", "eps", "=", "1e-6", ")", ":", "\n", "        ", "super", "(", "LayerNorm", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "a_2", "=", "nn", ".", "Parameter", "(", "torch", ".", "ones", "(", "features", ")", ")", "\n", "self", ".", "b_2", "=", "nn", ".", "Parameter", "(", "torch", ".", "zeros", "(", "features", ")", ")", "\n", "self", ".", "eps", "=", "eps", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.LayerNorm.forward": [[91, 95], ["x.mean", "x.std"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "mean", "=", "x", ".", "mean", "(", "-", "1", ",", "keepdim", "=", "True", ")", "\n", "std", "=", "x", ".", "std", "(", "-", "1", ",", "keepdim", "=", "True", ")", "\n", "return", "self", ".", "a_2", "*", "(", "x", "-", "mean", ")", "/", "(", "std", "+", "self", ".", "eps", ")", "+", "self", ".", "b_2", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.SublayerConnection.__init__": [[101, 105], ["torch.Module.__init__", "TransformerModel.LayerNorm", "torch.Dropout", "torch.Dropout", "torch.Dropout"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "size", ",", "dropout", ")", ":", "\n", "        ", "super", "(", "SublayerConnection", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "norm", "=", "LayerNorm", "(", "size", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "dropout", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.SublayerConnection.forward": [[106, 109], ["TransformerModel.SublayerConnection.dropout", "sublayer", "TransformerModel.SublayerConnection.norm"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "sublayer", ")", ":", "\n", "        ", "\"Apply residual connection to any sublayer with the same size.\"", "\n", "return", "x", "+", "self", ".", "dropout", "(", "sublayer", "(", "self", ".", "norm", "(", "x", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderLayer.__init__": [[112, 118], ["torch.Module.__init__", "TransformerModel.clones", "TransformerModel.SublayerConnection"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["def", "__init__", "(", "self", ",", "size", ",", "self_attn", ",", "feed_forward", ",", "dropout", ")", ":", "\n", "        ", "super", "(", "EncoderLayer", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "self_attn", "=", "self_attn", "\n", "self", ".", "feed_forward", "=", "feed_forward", "\n", "self", ".", "sublayer", "=", "clones", "(", "SublayerConnection", "(", "size", ",", "dropout", ")", ",", "2", ")", "\n", "self", ".", "size", "=", "size", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderLayer.forward": [[119, 123], ["TransformerModel.EncoderLayer.self_attn"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "mask", ")", ":", "\n", "        ", "\"Follow Figure 1 (left) for connections.\"", "\n", "x", "=", "self", ".", "sublayer", "[", "0", "]", "(", "x", ",", "lambda", "x", ":", "self", ".", "self_attn", "(", "x", ",", "x", ",", "x", ",", "mask", ")", ")", "\n", "return", "self", ".", "sublayer", "[", "1", "]", "(", "x", ",", "self", ".", "feed_forward", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.Decoder.__init__": [[126, 130], ["torch.Module.__init__", "TransformerModel.clones", "TransformerModel.LayerNorm"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["def", "__init__", "(", "self", ",", "layer", ",", "N", ")", ":", "\n", "        ", "super", "(", "Decoder", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "layers", "=", "clones", "(", "layer", ",", "N", ")", "\n", "self", ".", "norm", "=", "LayerNorm", "(", "layer", ".", "size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.Decoder.forward": [[131, 135], ["TransformerModel.Decoder.norm", "layer"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "memory", ",", "src_mask", ",", "tgt_mask", ")", ":", "\n", "        ", "for", "layer", "in", "self", ".", "layers", ":", "\n", "            ", "x", "=", "layer", "(", "x", ",", "memory", ",", "src_mask", ",", "tgt_mask", ")", "\n", "", "return", "self", ".", "norm", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.DecoderLayer.__init__": [[138, 145], ["torch.Module.__init__", "TransformerModel.clones", "TransformerModel.SublayerConnection"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["def", "__init__", "(", "self", ",", "size", ",", "self_attn", ",", "src_attn", ",", "feed_forward", ",", "dropout", ")", ":", "\n", "        ", "super", "(", "DecoderLayer", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "size", "=", "size", "\n", "self", ".", "self_attn", "=", "self_attn", "\n", "self", ".", "src_attn", "=", "src_attn", "\n", "self", ".", "feed_forward", "=", "feed_forward", "\n", "self", ".", "sublayer", "=", "clones", "(", "SublayerConnection", "(", "size", ",", "dropout", ")", ",", "3", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.DecoderLayer.forward": [[146, 152], ["TransformerModel.DecoderLayer.self_attn", "TransformerModel.DecoderLayer.src_attn"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ",", "memory", ",", "src_mask", ",", "tgt_mask", ")", ":", "\n", "        ", "\"Follow Figure 1 (right) for connections.\"", "\n", "m", "=", "memory", "\n", "x", "=", "self", ".", "sublayer", "[", "0", "]", "(", "x", ",", "lambda", "x", ":", "self", ".", "self_attn", "(", "x", ",", "x", ",", "x", ",", "tgt_mask", ")", ")", "\n", "x", "=", "self", ".", "sublayer", "[", "1", "]", "(", "x", ",", "lambda", "x", ":", "self", ".", "src_attn", "(", "x", ",", "m", ",", "m", ",", "src_mask", ")", ")", "\n", "return", "self", ".", "sublayer", "[", "2", "]", "(", "x", ",", "self", ".", "feed_forward", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.MultiHeadedAttention.__init__": [[172, 182], ["torch.Module.__init__", "TransformerModel.clones", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.Linear", "torch.Linear", "torch.Linear"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones"], ["    ", "def", "__init__", "(", "self", ",", "h", ",", "d_model", ",", "dropout", "=", "0.1", ")", ":", "\n", "        ", "\"Take in model size and number of heads.\"", "\n", "super", "(", "MultiHeadedAttention", ",", "self", ")", ".", "__init__", "(", ")", "\n", "assert", "d_model", "%", "h", "==", "0", "\n", "# We assume d_v always equals d_k", "\n", "self", ".", "d_k", "=", "d_model", "//", "h", "\n", "self", ".", "h", "=", "h", "\n", "self", ".", "linears", "=", "clones", "(", "nn", ".", "Linear", "(", "d_model", ",", "d_model", ")", ",", "4", ")", "\n", "self", ".", "attn", "=", "None", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "p", "=", "dropout", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.MultiHeadedAttention.forward": [[183, 203], ["query.size", "TransformerModel.attention", "x.transpose().contiguous().view.transpose().contiguous().view.transpose().contiguous().view", "mask.unsqueeze.unsqueeze.unsqueeze", "l().view().transpose", "zip", "x.transpose().contiguous().view.transpose().contiguous().view.transpose().contiguous", "l().view", "x.transpose().contiguous().view.transpose().contiguous().view.transpose", "l"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.attention"], ["", "def", "forward", "(", "self", ",", "query", ",", "key", ",", "value", ",", "mask", "=", "None", ")", ":", "\n", "        ", "\"Implements Figure 2\"", "\n", "if", "mask", "is", "not", "None", ":", "\n", "# Same mask applied to all h heads.", "\n", "            ", "mask", "=", "mask", ".", "unsqueeze", "(", "1", ")", "\n", "", "nbatches", "=", "query", ".", "size", "(", "0", ")", "\n", "\n", "# 1) Do all the linear projections in batch from d_model => h x d_k", "\n", "query", ",", "key", ",", "value", "=", "[", "l", "(", "x", ")", ".", "view", "(", "nbatches", ",", "-", "1", ",", "self", ".", "h", ",", "self", ".", "d_k", ")", ".", "transpose", "(", "1", ",", "2", ")", "\n", "for", "l", ",", "x", "in", "zip", "(", "self", ".", "linears", ",", "(", "query", ",", "key", ",", "value", ")", ")", "]", "\n", "\n", "# 2) Apply attention on all the projected vectors in batch.", "\n", "x", ",", "self", ".", "attn", "=", "attention", "(", "query", ",", "key", ",", "value", ",", "mask", "=", "mask", ",", "\n", "dropout", "=", "self", ".", "dropout", ")", "\n", "\n", "# 3) \"Concat\" using a view and apply a final linear.", "\n", "x", "=", "x", ".", "transpose", "(", "1", ",", "2", ")", ".", "contiguous", "(", ")", ".", "view", "(", "nbatches", ",", "-", "1", ",", "self", ".", "h", "*", "self", ".", "d_k", ")", "\n", "return", "self", ".", "linears", "[", "-", "1", "]", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.PositionwiseFeedForward.__init__": [[206, 211], ["torch.Module.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Dropout", "torch.Dropout", "torch.Dropout"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "d_model", ",", "d_ff", ",", "dropout", "=", "0.1", ")", ":", "\n", "        ", "super", "(", "PositionwiseFeedForward", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "w_1", "=", "nn", ".", "Linear", "(", "d_model", ",", "d_ff", ")", "\n", "self", ".", "w_2", "=", "nn", ".", "Linear", "(", "d_ff", ",", "d_model", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "dropout", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.PositionwiseFeedForward.forward": [[212, 214], ["TransformerModel.PositionwiseFeedForward.w_2", "TransformerModel.PositionwiseFeedForward.dropout", "torch.relu", "torch.relu", "torch.relu", "TransformerModel.PositionwiseFeedForward.w_1"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "return", "self", ".", "w_2", "(", "self", ".", "dropout", "(", "F", ".", "relu", "(", "self", ".", "w_1", "(", "x", ")", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.Embeddings.__init__": [[217, 221], ["torch.Module.__init__", "torch.Embedding", "torch.Embedding", "torch.Embedding"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "d_model", ",", "vocab", ")", ":", "\n", "        ", "super", "(", "Embeddings", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "lut", "=", "nn", ".", "Embedding", "(", "vocab", ",", "d_model", ")", "\n", "self", ".", "d_model", "=", "d_model", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.Embeddings.forward": [[222, 224], ["TransformerModel.Embeddings.lut", "math.sqrt"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "return", "self", ".", "lut", "(", "x", ")", "*", "math", ".", "sqrt", "(", "self", ".", "d_model", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.PositionalEncoding.__init__": [[227, 240], ["torch.Module.__init__", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.arange().unsqueeze().float", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.sin", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "torch.cos", "pe.unsqueeze.unsqueeze.unsqueeze", "TransformerModel.PositionalEncoding.register_buffer", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().unsqueeze", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange().float", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "torch.arange", "math.log"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "d_model", ",", "dropout", ",", "max_len", "=", "5000", ")", ":", "\n", "        ", "super", "(", "PositionalEncoding", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "p", "=", "dropout", ")", "\n", "\n", "# Compute the positional encodings once in log space.", "\n", "pe", "=", "torch", ".", "zeros", "(", "max_len", ",", "d_model", ")", "\n", "position", "=", "torch", ".", "arange", "(", "0", ",", "max_len", ")", ".", "unsqueeze", "(", "1", ")", ".", "float", "(", ")", "\n", "div_term", "=", "torch", ".", "exp", "(", "torch", ".", "arange", "(", "0", ",", "d_model", ",", "2", ")", ".", "float", "(", ")", "*", "\n", "-", "(", "math", ".", "log", "(", "10000.0", ")", "/", "d_model", ")", ")", "\n", "pe", "[", ":", ",", "0", ":", ":", "2", "]", "=", "torch", ".", "sin", "(", "position", "*", "div_term", ")", "\n", "pe", "[", ":", ",", "1", ":", ":", "2", "]", "=", "torch", ".", "cos", "(", "position", "*", "div_term", ")", "\n", "pe", "=", "pe", ".", "unsqueeze", "(", "0", ")", "\n", "self", ".", "register_buffer", "(", "'pe'", ",", "pe", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.PositionalEncoding.forward": [[241, 244], ["TransformerModel.PositionalEncoding.dropout", "x.size"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "x", "=", "x", "+", "self", ".", "pe", "[", ":", ",", ":", "x", ".", "size", "(", "1", ")", "]", "\n", "return", "self", ".", "dropout", "(", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.make_model": [[248, 270], ["TransformerModel.MultiHeadedAttention", "TransformerModel.PositionwiseFeedForward", "TransformerModel.PositionalEncoding", "TransformerModel.EncoderDecoder", "EncoderDecoder.parameters", "TransformerModel.Encoder", "TransformerModel.Decoder", "torch.Sequential", "torch.Sequential", "torch.Sequential", "TransformerModel.Generator", "TransformerModel.EncoderLayer", "TransformerModel.DecoderLayer", "TransformerModel.Embeddings", "c", "p.dim", "torch.init.xavier_uniform_", "torch.init.xavier_uniform_", "torch.init.xavier_uniform_", "c", "c", "c", "c", "c"], "methods", ["None"], ["    ", "def", "make_model", "(", "self", ",", "src_vocab", ",", "tgt_vocab", ",", "N", "=", "6", ",", "\n", "d_model", "=", "512", ",", "d_ff", "=", "2048", ",", "h", "=", "8", ",", "dropout", "=", "0.1", ")", ":", "\n", "        ", "\"Helper: Construct a model from hyperparameters.\"", "\n", "c", "=", "copy", ".", "deepcopy", "\n", "attn", "=", "MultiHeadedAttention", "(", "h", ",", "d_model", ")", "\n", "ff", "=", "PositionwiseFeedForward", "(", "d_model", ",", "d_ff", ",", "dropout", ")", "\n", "position", "=", "PositionalEncoding", "(", "d_model", ",", "dropout", ")", "\n", "\n", "model", "=", "EncoderDecoder", "(", "\n", "Encoder", "(", "EncoderLayer", "(", "d_model", ",", "c", "(", "attn", ")", ",", "c", "(", "ff", ")", ",", "dropout", ")", ",", "N", ")", ",", "\n", "Decoder", "(", "DecoderLayer", "(", "d_model", ",", "c", "(", "attn", ")", ",", "c", "(", "attn", ")", ",", "\n", "c", "(", "ff", ")", ",", "dropout", ")", ",", "N", ")", ",", "\n", "lambda", "x", ":", "x", ",", "# nn.Sequential(Embeddings(d_model, src_vocab), c(position)),", "\n", "nn", ".", "Sequential", "(", "Embeddings", "(", "d_model", ",", "tgt_vocab", ")", ",", "c", "(", "position", ")", ")", ",", "\n", "Generator", "(", "d_model", ",", "tgt_vocab", ")", ")", "\n", "\n", "# This was important from their code.", "\n", "# Initialize parameters with Glorot / fan_avg.", "\n", "for", "p", "in", "model", ".", "parameters", "(", ")", ":", "\n", "            ", "if", "p", ".", "dim", "(", ")", ">", "1", ":", "\n", "                ", "nn", ".", "init", ".", "xavier_uniform_", "(", "p", ")", "\n", "", "", "return", "model", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.__init__": [[271, 318], ["CaptionModel.CaptionModel.__init__", "getattr", "torch.Sequential", "torch.Sequential", "torch.Sequential", "TransformerModel.TransformerModel.make_model", "torch.Linear", "torch.Linear", "torch.Linear", "torch.ReLU", "torch.ReLU", "torch.ReLU", "torch.Dropout", "torch.Dropout", "torch.Dropout", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d", "torch.BatchNorm1d"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.make_model"], ["", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "TransformerModel", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "opt", "=", "opt", "\n", "# self.config = yaml.load(open(opt.config_file))", "\n", "# d_model = self.input_encoding_size # 512", "\n", "\n", "self", ".", "vocab_size", "=", "opt", ".", "vocab_size", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "# #self.rnn_type = opt.rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "# self.num_layers = opt.num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "seq_length", "=", "opt", ".", "seq_length", "\n", "# self.fc_feat_size = opt.fc_feat_size", "\n", "self", ".", "att_feat_size", "=", "opt", ".", "att_feat_size", "\n", "# self.att_hid_size = opt.att_hid_size", "\n", "\n", "self", ".", "use_bn", "=", "getattr", "(", "opt", ",", "'use_bn'", ",", "0", ")", "\n", "\n", "self", ".", "ss_prob", "=", "0.0", "# Schedule sampling probability", "\n", "\n", "# self.embed = nn.Sequential(nn.Embedding(self.vocab_size + 1, self.input_encoding_size),", "\n", "#                         nn.ReLU(),", "\n", "#                         nn.Dropout(self.drop_prob_lm))", "\n", "# self.fc_embed = nn.Sequential(nn.Linear(self.fc_feat_size, self.rnn_size),", "\n", "#                             nn.ReLU(),", "\n", "#                             nn.Dropout(self.drop_prob_lm))", "\n", "self", ".", "att_embed", "=", "nn", ".", "Sequential", "(", "*", "(", "\n", "(", "(", "nn", ".", "BatchNorm1d", "(", "self", ".", "att_feat_size", ")", ",", ")", "if", "self", ".", "use_bn", "else", "(", ")", ")", "+", "\n", "(", "nn", ".", "Linear", "(", "self", ".", "att_feat_size", ",", "self", ".", "input_encoding_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", ")", "+", "\n", "(", "(", "nn", ".", "BatchNorm1d", "(", "self", ".", "input_encoding_size", ")", ",", ")", "if", "self", ".", "use_bn", "==", "2", "else", "(", ")", ")", ")", ")", "\n", "\n", "# self.logit_layers = getattr(opt, 'logit_layers', 1)", "\n", "# if self.logit_layers == 1:", "\n", "#     self.logit = nn.Linear(self.rnn_size, self.vocab_size + 1)", "\n", "# else:", "\n", "#     self.logit = [[nn.Linear(self.rnn_size, self.rnn_size), nn.ReLU(), nn.Dropout(0.5)] for _ in range(opt.logit_layers - 1)]", "\n", "#     self.logit = nn.Sequential(*(reduce(lambda x,y:x+y, self.logit) + [nn.Linear(self.rnn_size, self.vocab_size + 1)]))", "\n", "# self.ctx2att = nn.Linear(self.rnn_size, self.att_hid_size)", "\n", "\n", "tgt_vocab", "=", "self", ".", "vocab_size", "+", "1", "\n", "self", ".", "model", "=", "self", ".", "make_model", "(", "0", ",", "tgt_vocab", ",", "\n", "N", "=", "opt", ".", "num_layers", ",", "\n", "d_model", "=", "opt", ".", "input_encoding_size", ",", "\n", "d_ff", "=", "opt", ".", "rnn_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.clip_att": [[324, 331], ["att_masks[].contiguous.data.long().sum().max", "att_feats[].contiguous", "att_masks[].contiguous", "att_masks[].contiguous.data.long().sum", "att_masks[].contiguous.data.long"], "methods", ["None"], ["", "def", "clip_att", "(", "self", ",", "att_feats", ",", "att_masks", ")", ":", "\n", "# Clip the length of att_masks and att_feats to the maximum length", "\n", "        ", "if", "att_masks", "is", "not", "None", ":", "\n", "            ", "max_len", "=", "att_masks", ".", "data", ".", "long", "(", ")", ".", "sum", "(", "1", ")", ".", "max", "(", ")", "\n", "att_feats", "=", "att_feats", "[", ":", ",", ":", "max_len", "]", ".", "contiguous", "(", ")", "\n", "att_masks", "=", "att_masks", "[", ":", ",", ":", "max_len", "]", ".", "contiguous", "(", ")", "\n", "", "return", "att_feats", ",", "att_masks", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel._prepare_feature": [[343, 364], ["TransformerModel.TransformerModel.clip_att", "AttModel.pack_wrapper", "AttModel.pack_wrapper.new_ones.unsqueeze", "AttModel.pack_wrapper.new_ones", "seq_mask.unsqueeze.unsqueeze.unsqueeze", "subsequent_mask().to", "TransformerModel.subsequent_mask", "seq.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.clip_att", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.pack_wrapper", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.subsequent_mask"], ["", "def", "_prepare_feature", "(", "self", ",", "att_feats", ",", "att_masks", "=", "None", ",", "seq", "=", "None", ")", ":", "\n", "        ", "att_feats", ",", "att_masks", "=", "self", ".", "clip_att", "(", "att_feats", ",", "att_masks", ")", "\n", "\n", "att_feats", "=", "pack_wrapper", "(", "self", ".", "att_embed", ",", "att_feats", ",", "att_masks", ")", "\n", "\n", "if", "att_masks", "is", "None", ":", "\n", "            ", "att_masks", "=", "att_feats", ".", "new_ones", "(", "att_feats", ".", "shape", "[", ":", "2", "]", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "", "att_masks", "=", "att_masks", ".", "unsqueeze", "(", "-", "2", ")", "\n", "\n", "if", "seq", "is", "not", "None", ":", "\n", "# crop the last one", "\n", "            ", "seq", "=", "seq", "[", ":", ",", ":", "-", "1", "]", "\n", "seq_mask", "=", "(", "seq", ".", "data", ">", "0", ")", "\n", "seq_mask", "[", ":", ",", "0", "]", "=", "1", "\n", "\n", "seq_mask", "=", "seq_mask", ".", "unsqueeze", "(", "-", "2", ")", "\n", "seq_mask", "=", "seq_mask", "&", "subsequent_mask", "(", "seq", ".", "size", "(", "-", "1", ")", ")", ".", "to", "(", "seq_mask", ")", "\n", "", "else", ":", "\n", "            ", "seq_mask", "=", "None", "\n", "\n", "", "return", "att_feats", ",", "seq", ",", "att_masks", ",", "seq_mask", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel._forward": [[365, 404], ["TransformerModel.TransformerModel._prepare_feature", "TransformerModel.TransformerModel.model", "TransformerModel.TransformerModel.model.generator"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature"], ["", "def", "_forward", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "seq", ",", "att_masks", "=", "None", ")", ":", "\n", "        ", "att_feats", ",", "seq", ",", "att_masks", ",", "seq_mask", "=", "self", ".", "_prepare_feature", "(", "att_feats", ",", "att_masks", ",", "seq", ")", "\n", "\n", "out", "=", "self", ".", "model", "(", "att_feats", ",", "seq", ",", "att_masks", ",", "seq_mask", ")", "\n", "\n", "# batch_size = fc_feats.size(0)", "\n", "# state = self.init_hidden(batch_size)", "\n", "\n", "# # outputs = []", "\n", "# outputs = fc_feats.new_zeros(batch_size, seq.size(1) - 1, self.vocab_size+1)", "\n", "\n", "# fc_feats, att_feats, p_att_feats = self._prepare_feature(fc_feats, att_feats, att_masks)", "\n", "\n", "# for i in range(seq.size(1) - 1):", "\n", "#     if self.training and i >= 1 and self.ss_prob > 0.0: # otherwiste no need to sample", "\n", "#         sample_prob = fc_feats.new(batch_size).uniform_(0, 1)", "\n", "#         sample_mask = sample_prob < self.ss_prob", "\n", "#         if sample_mask.sum() == 0:", "\n", "#             it = seq[:, i].clone()", "\n", "#         else:", "\n", "#             sample_ind = sample_mask.nonzero().view(-1)", "\n", "#             it = seq[:, i].data.clone()", "\n", "#             #prob_prev = torch.exp(outputs[-1].data.index_select(0, sample_ind)) # fetch prev distribution: shape Nx(M+1)", "\n", "#             #it.index_copy_(0, sample_ind, torch.multinomial(prob_prev, 1).view(-1))", "\n", "#             # prob_prev = torch.exp(outputs[-1].data) # fetch prev distribution: shape Nx(M+1)", "\n", "#             prob_prev = torch.exp(outputs[:, i-1].detach()) # fetch prev distribution: shape Nx(M+1)", "\n", "#             it.index_copy_(0, sample_ind, torch.multinomial(prob_prev, 1).view(-1).index_select(0, sample_ind))", "\n", "#     else:", "\n", "#         it = seq[:, i].clone()", "\n", "#     # break if all the sequences end", "\n", "#     if i >= 1 and seq[:, i].sum() == 0:", "\n", "#         break", "\n", "\n", "#     output, state = self.get_logprobs_state(it, fc_feats, att_feats, p_att_feats, att_masks, state)", "\n", "#     outputs[:, i] = output", "\n", "#     # outputs.append(output)", "\n", "\n", "outputs", "=", "self", ".", "model", ".", "generator", "(", "out", ")", "\n", "return", "outputs", "\n", "# return torch.cat([_.unsqueeze(1) for _ in outputs], 1)", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.get_logprobs_state": [[406, 421], ["TransformerModel.TransformerModel.model.decode", "TransformerModel.TransformerModel.model.generator", "it.unsqueeze", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "subsequent_mask().to", "torch.cat.unsqueeze", "torch.cat.unsqueeze", "torch.cat.unsqueeze", "it.unsqueeze", "TransformerModel.subsequent_mask", "torch.cat.size", "torch.cat.size", "torch.cat.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.decode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.subsequent_mask"], ["", "def", "get_logprobs_state", "(", "self", ",", "it", ",", "memory", ",", "mask", ",", "state", ")", ":", "\n", "        ", "\"\"\"\n        state = [ys.unsqueeze(0)]\n        \"\"\"", "\n", "if", "state", "is", "None", ":", "\n", "            ", "ys", "=", "it", ".", "unsqueeze", "(", "1", ")", "\n", "", "else", ":", "\n", "            ", "ys", "=", "torch", ".", "cat", "(", "[", "state", "[", "0", "]", "[", "0", "]", ",", "it", ".", "unsqueeze", "(", "1", ")", "]", ",", "dim", "=", "1", ")", "\n", "", "out", "=", "self", ".", "model", ".", "decode", "(", "memory", ",", "mask", ",", "\n", "ys", ",", "\n", "subsequent_mask", "(", "ys", ".", "size", "(", "1", ")", ")", "\n", ".", "to", "(", "memory", ".", "device", ")", ")", "\n", "logprobs", "=", "self", ".", "model", ".", "generator", "(", "out", "[", ":", ",", "-", "1", "]", ")", "\n", "\n", "return", "logprobs", ",", "[", "ys", ".", "unsqueeze", "(", "0", ")", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel._sample_beam": [[422, 451], ["opt.get", "fc_feats.size", "TransformerModel.TransformerModel._prepare_feature", "TransformerModel.TransformerModel.model.encode", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "range", "memory[].expand().contiguous", "range", "TransformerModel.TransformerModel.beam_search", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "range", "att_masks[].expand().contiguous", "TransformerModel.TransformerModel.get_logprobs_state", "memory[].expand", "fc_feats.new_zeros", "att_masks[].expand", "TransformerModel.TransformerModel.size", "att_masks.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.encode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.beam_search", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.get_logprobs_state"], ["", "def", "_sample_beam", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "10", ")", "\n", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "\n", "att_feats", ",", "seq", ",", "att_masks", ",", "seq_mask", "=", "self", ".", "_prepare_feature", "(", "att_feats", ",", "att_masks", ")", "\n", "memory", "=", "self", ".", "model", ".", "encode", "(", "att_feats", ",", "att_masks", ")", "\n", "\n", "assert", "beam_size", "<=", "self", ".", "vocab_size", "+", "1", ",", "'lets assume this for now, otherwise this corner case causes a few headaches down the road. can be dealt with in future if needed'", "\n", "seq", "=", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", ".", "zero_", "(", ")", "\n", "seqLogprobs", "=", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", "\n", "# lets process every image independently for now, for simplicity", "\n", "\n", "self", ".", "done_beams", "=", "[", "[", "]", "for", "_", "in", "range", "(", "batch_size", ")", "]", "\n", "for", "k", "in", "range", "(", "batch_size", ")", ":", "\n", "            ", "state", "=", "None", "\n", "tmp_memory", "=", "memory", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "memory", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "\n", "tmp_att_masks", "=", "att_masks", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "att_masks", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "if", "att_masks", "is", "not", "None", "else", "None", "\n", "\n", "for", "t", "in", "range", "(", "1", ")", ":", "\n", "                ", "if", "t", "==", "0", ":", "# input <bos>", "\n", "                    ", "it", "=", "fc_feats", ".", "new_zeros", "(", "[", "beam_size", "]", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "\n", "", "logprobs", ",", "state", "=", "self", ".", "get_logprobs_state", "(", "it", ",", "tmp_memory", ",", "tmp_att_masks", ",", "state", ")", "\n", "\n", "", "self", ".", "done_beams", "[", "k", "]", "=", "self", ".", "beam_search", "(", "state", ",", "logprobs", ",", "tmp_memory", ",", "tmp_att_masks", ",", "opt", "=", "opt", ")", "\n", "seq", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'seq'", "]", "# the first beam has highest cumulative score", "\n", "seqLogprobs", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'logps'", "]", "\n", "# return the samples and their log likelihoods", "\n", "", "return", "seq", ".", "transpose", "(", "0", ",", "1", ")", ",", "seqLogprobs", ".", "transpose", "(", "0", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel._sample_": [[452, 497], ["opt.get", "opt.get", "opt.get", "opt.get", "TransformerModel.TransformerModel._prepare_feature", "TransformerModel.TransformerModel.model.encode", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "torch.zeros().to", "att_feats.new_zeros", "att_feats.new_zeros", "range", "TransformerModel.TransformerModel._sample_beam", "TransformerModel.TransformerModel.model.decode", "TransformerModel.TransformerModel.model.generator", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "torch.no_grad", "TransformerModel.TransformerModel._sample_", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "subsequent_mask().to", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "logprobs.gather", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.multinomial.unsqueeze", "torch.multinomial.unsqueeze", "torch.multinomial.unsqueeze", "TransformerModel.subsequent_mask", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.cat.size", "torch.cat.size", "torch.cat.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.encode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel._sample_beam", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.decode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel._sample_", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.subsequent_mask"], ["", "def", "_sample_", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "sample_max", "=", "opt", ".", "get", "(", "'sample_max'", ",", "1", ")", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "1", ")", "\n", "temperature", "=", "opt", ".", "get", "(", "'temperature'", ",", "1.0", ")", "\n", "decoding_constraint", "=", "opt", ".", "get", "(", "'decoding_constraint'", ",", "0", ")", "\n", "if", "beam_size", ">", "1", ":", "\n", "            ", "return", "self", ".", "_sample_beam", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ",", "opt", ")", "\n", "\n", "", "if", "sample_max", ":", "\n", "            ", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "                ", "seq_", ",", "seqLogprobs_", "=", "self", ".", "_sample_", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ",", "opt", ")", "\n", "\n", "", "", "batch_size", "=", "att_feats", ".", "shape", "[", "0", "]", "\n", "\n", "att_feats", ",", "seq", ",", "att_masks", ",", "seq_mask", "=", "self", ".", "_prepare_feature", "(", "att_feats", ",", "att_masks", ")", "\n", "\n", "memory", "=", "self", ".", "model", ".", "encode", "(", "att_feats", ",", "att_masks", ")", "\n", "ys", "=", "torch", ".", "zeros", "(", "(", "batch_size", ",", "1", ")", ",", "dtype", "=", "torch", ".", "long", ")", ".", "to", "(", "att_feats", ".", "device", ")", "\n", "\n", "seq", "=", "att_feats", ".", "new_zeros", "(", "(", "batch_size", ",", "self", ".", "seq_length", ")", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "seqLogprobs", "=", "att_feats", ".", "new_zeros", "(", "batch_size", ",", "self", ".", "seq_length", ")", "\n", "\n", "for", "i", "in", "range", "(", "self", ".", "seq_length", ")", ":", "\n", "            ", "out", "=", "self", ".", "model", ".", "decode", "(", "memory", ",", "att_masks", ",", "\n", "ys", ",", "\n", "subsequent_mask", "(", "ys", ".", "size", "(", "1", ")", ")", "\n", ".", "to", "(", "att_feats", ".", "device", ")", ")", "\n", "logprob", "=", "self", ".", "model", ".", "generator", "(", "out", "[", ":", ",", "-", "1", "]", ")", "\n", "if", "sample_max", ":", "\n", "                ", "sampleLogprobs", ",", "next_word", "=", "torch", ".", "max", "(", "logprob", ",", "dim", "=", "1", ")", "\n", "", "else", ":", "\n", "                ", "if", "temperature", "==", "1.0", ":", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "logprob", ".", "data", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "", "else", ":", "\n", "# scale logprobs by temperature", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "torch", ".", "div", "(", "logprob", ".", "data", ",", "temperature", ")", ")", "\n", "", "next_word", "=", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", "\n", "sampleLogprobs", "=", "logprobs", ".", "gather", "(", "1", ",", "next_word", ")", "# gather the logprobs at sampled positions", "\n", "\n", "", "seq", "[", ":", ",", "i", "]", "=", "next_word", "\n", "seqLogprobs", "[", ":", ",", "i", "]", "=", "sampleLogprobs", "\n", "ys", "=", "torch", ".", "cat", "(", "[", "ys", ",", "next_word", ".", "unsqueeze", "(", "1", ")", "]", ",", "dim", "=", "1", ")", "\n", "", "assert", "(", "seq", "*", "(", "(", "seq_", ">", "0", ")", ".", "long", "(", ")", ")", "==", "seq_", ")", ".", "all", "(", ")", ",", "'seq doens\\'t match'", "\n", "assert", "(", "seqLogprobs", "*", "(", "(", "seq_", ">", "0", ")", ".", "float", "(", ")", ")", "-", "seqLogprobs_", "*", "(", "(", "seq_", ">", "0", ")", ".", "float", "(", ")", ")", ")", ".", "abs", "(", ")", ".", "max", "(", ")", "<", "1e-5", ",", "'logprobs doens\\'t match'", "\n", "return", "seq", ",", "seqLogprobs", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel._sample": [[498, 555], ["opt.get", "opt.get", "opt.get", "opt.get", "TransformerModel.TransformerModel._prepare_feature", "TransformerModel.TransformerModel.model.encode", "att_feats.new_zeros", "att_feats.new_zeros", "range", "TransformerModel.TransformerModel._sample_beam", "TransformerModel.TransformerModel.get_logprobs_state", "logprobs.gather.view", "fc_feats.new_zeros", "output.new_zeros", "output.new_zeros.scatter_", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "it.view().long.view().long.view().long", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "logprobs.gather", "it.view().long.view().long.view().long", "unfinished.type_as", "unfinished.sum", "output.size", "seq[].data.unsqueeze", "float", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "it.view().long.view().long.view", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "it.view().long.view().long.view"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.EncoderDecoder.encode", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel._sample_beam", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.get_logprobs_state"], ["", "def", "_sample", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "sample_max", "=", "opt", ".", "get", "(", "'sample_max'", ",", "1", ")", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "1", ")", "\n", "temperature", "=", "opt", ".", "get", "(", "'temperature'", ",", "1.0", ")", "\n", "decoding_constraint", "=", "opt", ".", "get", "(", "'decoding_constraint'", ",", "0", ")", "\n", "if", "beam_size", ">", "1", ":", "\n", "            ", "return", "self", ".", "_sample_beam", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ",", "opt", ")", "\n", "\n", "", "batch_size", "=", "att_feats", ".", "shape", "[", "0", "]", "\n", "\n", "att_feats", ",", "seq", ",", "att_masks", ",", "seq_mask", "=", "self", ".", "_prepare_feature", "(", "att_feats", ",", "att_masks", ")", "\n", "\n", "state", "=", "None", "\n", "memory", "=", "self", ".", "model", ".", "encode", "(", "att_feats", ",", "att_masks", ")", "\n", "\n", "seq", "=", "att_feats", ".", "new_zeros", "(", "(", "batch_size", ",", "self", ".", "seq_length", ")", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "seqLogprobs", "=", "att_feats", ".", "new_zeros", "(", "batch_size", ",", "self", ".", "seq_length", ")", "\n", "\n", "for", "t", "in", "range", "(", "self", ".", "seq_length", "+", "1", ")", ":", "\n", "            ", "if", "t", "==", "0", ":", "# input <bos>", "\n", "                ", "it", "=", "fc_feats", ".", "new_zeros", "(", "batch_size", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "\n", "", "logprobs", ",", "state", "=", "self", ".", "get_logprobs_state", "(", "it", ",", "memory", ",", "att_masks", ",", "state", ")", "\n", "if", "decoding_constraint", "and", "t", ">", "0", ":", "\n", "                ", "tmp", "=", "output", ".", "new_zeros", "(", "output", ".", "size", "(", "0", ")", ",", "self", ".", "vocab_size", "+", "1", ")", "\n", "tmp", ".", "scatter_", "(", "1", ",", "seq", "[", ":", ",", "t", "-", "1", "]", ".", "data", ".", "unsqueeze", "(", "1", ")", ",", "float", "(", "'-inf'", ")", ")", "\n", "logprobs", "=", "logprobs", "+", "tmp", "\n", "\n", "# sample the next word", "\n", "", "if", "t", "==", "self", ".", "seq_length", ":", "# skip if we achieve maximum length", "\n", "                ", "break", "\n", "", "if", "sample_max", ":", "\n", "                ", "sampleLogprobs", ",", "it", "=", "torch", ".", "max", "(", "logprobs", ".", "data", ",", "1", ")", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "\n", "", "else", ":", "\n", "                ", "if", "temperature", "==", "1.0", ":", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "logprobs", ".", "data", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "", "else", ":", "\n", "# scale logprobs by temperature", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "torch", ".", "div", "(", "logprobs", ".", "data", ",", "temperature", ")", ")", "\n", "", "it", "=", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", "\n", "sampleLogprobs", "=", "logprobs", ".", "gather", "(", "1", ",", "it", ")", "# gather the logprobs at sampled positions", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "# and flatten indices for downstream processing", "\n", "\n", "# stop when all finished", "\n", "", "if", "t", "==", "0", ":", "\n", "                ", "unfinished", "=", "it", ">", "0", "\n", "", "else", ":", "\n", "                ", "unfinished", "=", "unfinished", "*", "(", "it", ">", "0", ")", "\n", "", "it", "=", "it", "*", "unfinished", ".", "type_as", "(", "it", ")", "\n", "seq", "[", ":", ",", "t", "]", "=", "it", "\n", "seqLogprobs", "[", ":", ",", "t", "]", "=", "sampleLogprobs", ".", "view", "(", "-", "1", ")", "\n", "# quit loop if all sequences have finished", "\n", "if", "unfinished", ".", "sum", "(", ")", "==", "0", ":", "\n", "                ", "break", "\n", "\n", "", "", "return", "seq", ",", "seqLogprobs", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.clones": [[66, 69], ["torch.ModuleList", "copy.deepcopy", "range"], "function", ["None"], ["", "", "def", "clones", "(", "module", ",", "N", ")", ":", "\n", "    ", "\"Produce N identical layers.\"", "\n", "return", "nn", ".", "ModuleList", "(", "[", "copy", ".", "deepcopy", "(", "module", ")", "for", "_", "in", "range", "(", "N", ")", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.subsequent_mask": [[153, 158], ["numpy.triu().astype", "torch.from_numpy", "torch.from_numpy", "torch.from_numpy", "numpy.triu", "numpy.ones"], "function", ["None"], ["", "", "def", "subsequent_mask", "(", "size", ")", ":", "\n", "    ", "\"Mask out subsequent positions.\"", "\n", "attn_shape", "=", "(", "1", ",", "size", ",", "size", ")", "\n", "subsequent_mask", "=", "np", ".", "triu", "(", "np", ".", "ones", "(", "attn_shape", ")", ",", "k", "=", "1", ")", ".", "astype", "(", "'uint8'", ")", "\n", "return", "torch", ".", "from_numpy", "(", "subsequent_mask", ")", "==", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.attention": [[159, 170], ["query.size", "torch.softmax", "torch.matmul", "torch.matmul", "torch.matmul", "math.sqrt", "scores.masked_fill.masked_fill", "dropout", "torch.matmul", "torch.matmul", "torch.matmul", "key.transpose"], "function", ["None"], ["", "def", "attention", "(", "query", ",", "key", ",", "value", ",", "mask", "=", "None", ",", "dropout", "=", "None", ")", ":", "\n", "    ", "\"Compute 'Scaled Dot Product Attention'\"", "\n", "d_k", "=", "query", ".", "size", "(", "-", "1", ")", "\n", "scores", "=", "torch", ".", "matmul", "(", "query", ",", "key", ".", "transpose", "(", "-", "2", ",", "-", "1", ")", ")", "/", "math", ".", "sqrt", "(", "d_k", ")", "\n", "if", "mask", "is", "not", "None", ":", "\n", "        ", "scores", "=", "scores", ".", "masked_fill", "(", "mask", "==", "0", ",", "-", "1e9", ")", "\n", "", "p_attn", "=", "F", ".", "softmax", "(", "scores", ",", "dim", "=", "-", "1", ")", "\n", "if", "dropout", "is", "not", "None", ":", "\n", "        ", "p_attn", "=", "dropout", "(", "p_attn", ")", "\n", "", "return", "torch", ".", "matmul", "(", "p_attn", ",", "value", ")", ",", "p_attn", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.ShowTellModel.ShowTellModel.__init__": [[14, 34], ["CaptionModel.CaptionModel.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Embedding", "torch.Embedding", "torch.Embedding", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Dropout", "torch.Dropout", "torch.Dropout", "ShowTellModel.ShowTellModel.init_weights", "getattr", "ShowTellModel.ShowTellModel.rnn_type.upper"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_weights"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "ShowTellModel", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "vocab_size", "=", "opt", ".", "vocab_size", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "self", ".", "rnn_type", "=", "opt", ".", "rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "num_layers", "=", "opt", ".", "num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "seq_length", "=", "opt", ".", "seq_length", "\n", "self", ".", "fc_feat_size", "=", "opt", ".", "fc_feat_size", "\n", "\n", "self", ".", "ss_prob", "=", "0.0", "# Schedule sampling probability", "\n", "\n", "self", ".", "img_embed", "=", "nn", ".", "Linear", "(", "self", ".", "fc_feat_size", ",", "self", ".", "input_encoding_size", ")", "\n", "self", ".", "core", "=", "getattr", "(", "nn", ",", "self", ".", "rnn_type", ".", "upper", "(", ")", ")", "(", "self", ".", "input_encoding_size", ",", "self", ".", "rnn_size", ",", "self", ".", "num_layers", ",", "bias", "=", "False", ",", "dropout", "=", "self", ".", "drop_prob_lm", ")", "\n", "self", ".", "embed", "=", "nn", ".", "Embedding", "(", "self", ".", "vocab_size", "+", "1", ",", "self", ".", "input_encoding_size", ")", "\n", "self", ".", "logit", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "vocab_size", "+", "1", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", "\n", "\n", "self", ".", "init_weights", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.ShowTellModel.ShowTellModel.init_weights": [[35, 40], ["ShowTellModel.ShowTellModel.embed.weight.data.uniform_", "ShowTellModel.ShowTellModel.logit.bias.data.fill_", "ShowTellModel.ShowTellModel.logit.weight.data.uniform_"], "methods", ["None"], ["", "def", "init_weights", "(", "self", ")", ":", "\n", "        ", "initrange", "=", "0.1", "\n", "self", ".", "embed", ".", "weight", ".", "data", ".", "uniform_", "(", "-", "initrange", ",", "initrange", ")", "\n", "self", ".", "logit", ".", "bias", ".", "data", ".", "fill_", "(", "0", ")", "\n", "self", ".", "logit", ".", "weight", ".", "data", ".", "uniform_", "(", "-", "initrange", ",", "initrange", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.ShowTellModel.ShowTellModel.init_hidden": [[41, 48], ["next", "weight.new_zeros", "ShowTellModel.ShowTellModel.parameters", "weight.new_zeros", "weight.new_zeros"], "methods", ["None"], ["", "def", "init_hidden", "(", "self", ",", "bsz", ")", ":", "\n", "        ", "weight", "=", "next", "(", "self", ".", "parameters", "(", ")", ")", ".", "data", "\n", "if", "self", ".", "rnn_type", "==", "'lstm'", ":", "\n", "            ", "return", "(", "weight", ".", "new_zeros", "(", "self", ".", "num_layers", ",", "bsz", ",", "self", ".", "rnn_size", ")", ",", "\n", "weight", ".", "new_zeros", "(", "self", ".", "num_layers", ",", "bsz", ",", "self", ".", "rnn_size", ")", ")", "\n", "", "else", ":", "\n", "            ", "return", "weight", ".", "new_zeros", "(", "self", ".", "num_layers", ",", "bsz", ",", "self", ".", "rnn_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.ShowTellModel.ShowTellModel._forward": [[49, 82], ["fc_feats.size", "ShowTellModel.ShowTellModel.init_hidden", "range", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "seq.size", "ShowTellModel.ShowTellModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "outputs.append", "ShowTellModel.ShowTellModel.img_embed", "ShowTellModel.ShowTellModel.embed", "ShowTellModel.ShowTellModel.unsqueeze", "ShowTellModel.ShowTellModel.logit", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "fc_feats.data.new().uniform_", "seq[].clone", "ShowTellModel.ShowTellModel.dropout", "sample_mask.sum", "seq[].clone", "sample_mask.nonzero().view", "seq[].data.clone", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "seq[].data.clone.index_copy_", "seq[].data.sum", "torch.log_softmax.squeeze", "_.unsqueeze", "fc_feats.data.new", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "sample_mask.nonzero", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed"], ["", "", "def", "_forward", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "seq", ",", "att_masks", "=", "None", ")", ":", "\n", "        ", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "state", "=", "self", ".", "init_hidden", "(", "batch_size", ")", "\n", "outputs", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "seq", ".", "size", "(", "1", ")", ")", ":", "\n", "            ", "if", "i", "==", "0", ":", "\n", "                ", "xt", "=", "self", ".", "img_embed", "(", "fc_feats", ")", "\n", "", "else", ":", "\n", "                ", "if", "self", ".", "training", "and", "i", ">=", "2", "and", "self", ".", "ss_prob", ">", "0.0", ":", "# otherwiste no need to sample", "\n", "                    ", "sample_prob", "=", "fc_feats", ".", "data", ".", "new", "(", "batch_size", ")", ".", "uniform_", "(", "0", ",", "1", ")", "\n", "sample_mask", "=", "sample_prob", "<", "self", ".", "ss_prob", "\n", "if", "sample_mask", ".", "sum", "(", ")", "==", "0", ":", "\n", "                        ", "it", "=", "seq", "[", ":", ",", "i", "-", "1", "]", ".", "clone", "(", ")", "\n", "", "else", ":", "\n", "                        ", "sample_ind", "=", "sample_mask", ".", "nonzero", "(", ")", ".", "view", "(", "-", "1", ")", "\n", "it", "=", "seq", "[", ":", ",", "i", "-", "1", "]", ".", "data", ".", "clone", "(", ")", "\n", "#prob_prev = torch.exp(outputs[-1].data.index_select(0, sample_ind)) # fetch prev distribution: shape Nx(M+1)", "\n", "#it.index_copy_(0, sample_ind, torch.multinomial(prob_prev, 1).view(-1))", "\n", "prob_prev", "=", "torch", ".", "exp", "(", "outputs", "[", "-", "1", "]", ".", "data", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "it", ".", "index_copy_", "(", "0", ",", "sample_ind", ",", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", ".", "view", "(", "-", "1", ")", ".", "index_select", "(", "0", ",", "sample_ind", ")", ")", "\n", "", "", "else", ":", "\n", "                    ", "it", "=", "seq", "[", ":", ",", "i", "-", "1", "]", ".", "clone", "(", ")", "\n", "# break if all the sequences end", "\n", "", "if", "i", ">=", "2", "and", "seq", "[", ":", ",", "i", "-", "1", "]", ".", "data", ".", "sum", "(", ")", "==", "0", ":", "\n", "                    ", "break", "\n", "", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ".", "unsqueeze", "(", "0", ")", ",", "state", ")", "\n", "output", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "self", ".", "dropout", "(", "output", ".", "squeeze", "(", "0", ")", ")", ")", ",", "dim", "=", "1", ")", "\n", "outputs", ".", "append", "(", "output", ")", "\n", "\n", "", "return", "torch", ".", "cat", "(", "[", "_", ".", "unsqueeze", "(", "1", ")", "for", "_", "in", "outputs", "[", "1", ":", "]", "]", ",", "1", ")", ".", "contiguous", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.ShowTellModel.ShowTellModel.get_logprobs_state": [[83, 91], ["ShowTellModel.ShowTellModel.embed", "ShowTellModel.ShowTellModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "ShowTellModel.ShowTellModel.unsqueeze", "ShowTellModel.ShowTellModel.logit", "ShowTellModel.ShowTellModel.dropout", "output.squeeze"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core"], ["", "def", "get_logprobs_state", "(", "self", ",", "it", ",", "state", ")", ":", "\n", "# 'it' contains a word index", "\n", "        ", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ".", "unsqueeze", "(", "0", ")", ",", "state", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "self", ".", "dropout", "(", "output", ".", "squeeze", "(", "0", ")", ")", ")", ",", "dim", "=", "1", ")", "\n", "\n", "return", "logprobs", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.ShowTellModel.ShowTellModel._sample_beam": [[92, 119], ["opt.get", "fc_feats.size", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "range", "ShowTellModel.ShowTellModel.init_hidden", "range", "ShowTellModel.ShowTellModel.beam_search", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "range", "ShowTellModel.ShowTellModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "ShowTellModel.ShowTellModel.img_embed().expand", "ShowTellModel.ShowTellModel.unsqueeze", "ShowTellModel.ShowTellModel.logit", "fc_feats.data.new().long().zero_", "ShowTellModel.ShowTellModel.embed", "ShowTellModel.ShowTellModel.dropout", "ShowTellModel.ShowTellModel.img_embed", "output.squeeze", "fc_feats.data.new().long", "fc_feats.data.new"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.beam_search", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed"], ["", "def", "_sample_beam", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "10", ")", "\n", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "\n", "assert", "beam_size", "<=", "self", ".", "vocab_size", "+", "1", ",", "'lets assume this for now, otherwise this corner case causes a few headaches down the road. can be dealt with in future if needed'", "\n", "seq", "=", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", ".", "zero_", "(", ")", "\n", "seqLogprobs", "=", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", "\n", "# lets process every image independently for now, for simplicity", "\n", "\n", "self", ".", "done_beams", "=", "[", "[", "]", "for", "_", "in", "range", "(", "batch_size", ")", "]", "\n", "for", "k", "in", "range", "(", "batch_size", ")", ":", "\n", "            ", "state", "=", "self", ".", "init_hidden", "(", "beam_size", ")", "\n", "for", "t", "in", "range", "(", "2", ")", ":", "\n", "                ", "if", "t", "==", "0", ":", "\n", "                    ", "xt", "=", "self", ".", "img_embed", "(", "fc_feats", "[", "k", ":", "k", "+", "1", "]", ")", ".", "expand", "(", "beam_size", ",", "self", ".", "input_encoding_size", ")", "\n", "", "elif", "t", "==", "1", ":", "# input <bos>", "\n", "                    ", "it", "=", "fc_feats", ".", "data", ".", "new", "(", "beam_size", ")", ".", "long", "(", ")", ".", "zero_", "(", ")", "\n", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ".", "unsqueeze", "(", "0", ")", ",", "state", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "self", ".", "dropout", "(", "output", ".", "squeeze", "(", "0", ")", ")", ")", ",", "dim", "=", "1", ")", "\n", "\n", "", "self", ".", "done_beams", "[", "k", "]", "=", "self", ".", "beam_search", "(", "state", ",", "logprobs", ",", "opt", "=", "opt", ")", "\n", "seq", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'seq'", "]", "# the first beam has highest cumulative score", "\n", "seqLogprobs", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'logps'", "]", "\n", "# return the samples and their log likelihoods", "\n", "", "return", "seq", ".", "transpose", "(", "0", ",", "1", ")", ",", "seqLogprobs", ".", "transpose", "(", "0", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.ShowTellModel.ShowTellModel._sample": [[120, 171], ["opt.get", "opt.get", "opt.get", "fc_feats.size", "ShowTellModel.ShowTellModel.init_hidden", "fc_feats.new_zeros", "fc_feats.new_zeros", "range", "ShowTellModel.ShowTellModel.sample_beam", "ShowTellModel.ShowTellModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "ShowTellModel.ShowTellModel.img_embed", "ShowTellModel.ShowTellModel.embed", "ShowTellModel.ShowTellModel.unsqueeze", "ShowTellModel.ShowTellModel.logit", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "fc_feats.data.new().long().zero_.view().long", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.log_softmax.gather", "fc_feats.data.new().long().zero_.view().long", "F.log_softmax.gather.view", "fc_feats.data.new().long().zero_", "ShowTellModel.ShowTellModel.dropout", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "unfinished.type_as", "unfinished.sum", "output.squeeze", "fc_feats.data.new().long().zero_.view", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "fc_feats.data.new().long().zero_.view", "fc_feats.data.new().long", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "fc_feats.data.new"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.OldModel.sample_beam", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed"], ["", "def", "_sample", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "sample_max", "=", "opt", ".", "get", "(", "'sample_max'", ",", "1", ")", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "1", ")", "\n", "temperature", "=", "opt", ".", "get", "(", "'temperature'", ",", "1.0", ")", "\n", "if", "beam_size", ">", "1", ":", "\n", "            ", "return", "self", ".", "sample_beam", "(", "fc_feats", ",", "att_feats", ",", "opt", ")", "\n", "\n", "", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "state", "=", "self", ".", "init_hidden", "(", "batch_size", ")", "\n", "seq", "=", "fc_feats", ".", "new_zeros", "(", "batch_size", ",", "self", ".", "seq_length", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "seqLogprobs", "=", "fc_feats", ".", "new_zeros", "(", "batch_size", ",", "self", ".", "seq_length", ")", "\n", "for", "t", "in", "range", "(", "self", ".", "seq_length", "+", "2", ")", ":", "\n", "            ", "if", "t", "==", "0", ":", "\n", "                ", "xt", "=", "self", ".", "img_embed", "(", "fc_feats", ")", "\n", "", "else", ":", "\n", "                ", "if", "t", "==", "1", ":", "# input <bos>", "\n", "                    ", "it", "=", "fc_feats", ".", "data", ".", "new", "(", "batch_size", ")", ".", "long", "(", ")", ".", "zero_", "(", ")", "\n", "", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ".", "unsqueeze", "(", "0", ")", ",", "state", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "self", ".", "dropout", "(", "output", ".", "squeeze", "(", "0", ")", ")", ")", ",", "dim", "=", "1", ")", "\n", "\n", "# sample the next word", "\n", "if", "t", "==", "self", ".", "seq_length", "+", "1", ":", "# skip if we achieve maximum length", "\n", "                ", "break", "\n", "", "if", "sample_max", ":", "\n", "                ", "sampleLogprobs", ",", "it", "=", "torch", ".", "max", "(", "logprobs", ".", "data", ",", "1", ")", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "\n", "", "else", ":", "\n", "                ", "if", "temperature", "==", "1.0", ":", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "logprobs", ".", "data", ")", ".", "cpu", "(", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "", "else", ":", "\n", "# scale logprobs by temperature", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "torch", ".", "div", "(", "logprobs", ".", "data", ",", "temperature", ")", ")", ".", "cpu", "(", ")", "\n", "", "it", "=", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", ".", "cuda", "(", ")", "\n", "sampleLogprobs", "=", "logprobs", ".", "gather", "(", "1", ",", "it", ")", "# gather the logprobs at sampled positions", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "# and flatten indices for downstream processing", "\n", "\n", "", "if", "t", ">=", "1", ":", "\n", "# stop when all finished", "\n", "                ", "if", "t", "==", "1", ":", "\n", "                    ", "unfinished", "=", "it", ">", "0", "\n", "", "else", ":", "\n", "                    ", "unfinished", "=", "unfinished", "*", "(", "it", ">", "0", ")", "\n", "", "it", "=", "it", "*", "unfinished", ".", "type_as", "(", "it", ")", "\n", "seq", "[", ":", ",", "t", "-", "1", "]", "=", "it", "#seq[t] the input of t+2 time step", "\n", "seqLogprobs", "[", ":", ",", "t", "-", "1", "]", "=", "sampleLogprobs", ".", "view", "(", "-", "1", ")", "\n", "if", "unfinished", ".", "sum", "(", ")", "==", "0", ":", "\n", "                    ", "break", "\n", "\n", "", "", "", "return", "seq", ",", "seqLogprobs", "", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.__init__": [[29, 37], ["CaptionModel.CaptionModel.CaptionModel.__init__", "torch.ModuleList", "torch.ModuleList", "torch.ModuleList"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "models", ")", ":", "\n", "        ", "CaptionModel", ".", "__init__", "(", "self", ")", "\n", "# super(AttEnsemble, self).__init__()", "\n", "\n", "self", ".", "models", "=", "nn", ".", "ModuleList", "(", "models", ")", "\n", "self", ".", "vocab_size", "=", "models", "[", "0", "]", ".", "vocab_size", "\n", "self", ".", "seq_length", "=", "models", "[", "0", "]", ".", "seq_length", "\n", "self", ".", "ss_prob", "=", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.init_hidden": [[38, 40], ["m.init_hidden"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden"], ["", "def", "init_hidden", "(", "self", ",", "batch_size", ")", ":", "\n", "        ", "return", "[", "m", ".", "init_hidden", "(", "batch_size", ")", "for", "m", "in", "self", ".", "models", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed": [[41, 43], ["m.embed"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed"], ["", "def", "embed", "(", "self", ",", "it", ")", ":", "\n", "        ", "return", "[", "m", ".", "embed", "(", "it", ")", "for", "m", "in", "self", ".", "models", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core": [[44, 46], ["zip", "m.core", "zip", "zip"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core"], ["", "def", "core", "(", "self", ",", "*", "args", ")", ":", "\n", "        ", "return", "zip", "(", "*", "[", "m", ".", "core", "(", "*", "_", ")", "for", "m", ",", "_", "in", "zip", "(", "self", ".", "models", ",", "zip", "(", "*", "args", ")", ")", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.get_logprobs_state": [[47, 55], ["AttEnsemble.AttEnsemble.embed", "AttEnsemble.AttEnsemble.core", "torch.stack().mean().log", "torch.stack().mean().log", "torch.stack().mean().log", "torch.stack().mean().log", "torch.stack().mean().log", "torch.stack().mean().log", "torch.stack().mean().log", "torch.stack().mean().log", "torch.stack().mean().log", "torch.stack().mean", "torch.stack().mean", "torch.stack().mean", "torch.stack().mean", "torch.stack().mean", "torch.stack().mean", "torch.stack().mean", "torch.stack().mean", "torch.stack().mean", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.stack", "torch.softmax", "torch.softmax", "torch.softmax", "m.logit", "enumerate"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core"], ["", "def", "get_logprobs_state", "(", "self", ",", "it", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "tmp_p_att_feats", ",", "tmp_att_masks", ",", "state", ")", ":", "\n", "# 'it' contains a word index", "\n", "        ", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "tmp_p_att_feats", ",", "state", ",", "tmp_att_masks", ")", "\n", "logprobs", "=", "torch", ".", "stack", "(", "[", "F", ".", "softmax", "(", "m", ".", "logit", "(", "output", "[", "i", "]", ")", ",", "dim", "=", "1", ")", "for", "i", ",", "m", "in", "enumerate", "(", "self", ".", "models", ")", "]", ",", "2", ")", ".", "mean", "(", "2", ")", ".", "log", "(", ")", "\n", "\n", "return", "logprobs", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature": [[56, 67], ["AttEnsemble.AttEnsemble.clip_att", "m.fc_embed", "AttModel.AttModel.pack_wrapper", "m.ctx2att", "enumerate", "len"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.TransformerModel.TransformerModel.clip_att", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttModel.pack_wrapper"], ["", "def", "_prepare_feature", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", ")", ":", "\n", "        ", "att_feats", ",", "att_masks", "=", "self", ".", "clip_att", "(", "att_feats", ",", "att_masks", ")", "\n", "\n", "# embed fc and att feats", "\n", "fc_feats", "=", "[", "m", ".", "fc_embed", "(", "fc_feats", ")", "for", "m", "in", "self", ".", "models", "]", "\n", "att_feats", "=", "[", "pack_wrapper", "(", "m", ".", "att_embed", ",", "att_feats", "[", "...", ",", ":", "m", ".", "att_feat_size", "]", ",", "att_masks", ")", "for", "m", "in", "self", ".", "models", "]", "\n", "\n", "# Project the attention feats first to reduce memory and computation comsumptions.", "\n", "p_att_feats", "=", "[", "m", ".", "ctx2att", "(", "att_feats", "[", "i", "]", ")", "for", "i", ",", "m", "in", "enumerate", "(", "self", ".", "models", ")", "]", "\n", "\n", "return", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "[", "att_masks", "]", "*", "len", "(", "self", ".", "models", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._sample_beam": [[68, 95], ["opt.get", "fc_feats.size", "AttEnsemble.AttEnsemble._prepare_feature", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "range", "AttEnsemble.AttEnsemble.init_hidden", "fc_feats[].data.new().long().zero_", "AttEnsemble.AttEnsemble.get_logprobs_state", "AttEnsemble.AttEnsemble.beam_search", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "range", "[].expand", "[].expand().contiguous", "[].expand().contiguous", "fc_feats[].size", "enumerate", "enumerate", "enumerate", "att_masks[].expand().contiguous", "fc_feats[].data.new().long", "[].expand", "[].expand", "enumerate", "att_masks[].expand", "fc_feats[].data.new", "att_feats[].size", "p_att_feats[].size", "att_masks.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble._prepare_feature", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.get_logprobs_state", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.beam_search"], ["", "def", "_sample_beam", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "10", ")", "\n", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "\n", "fc_feats", ",", "att_feats", ",", "p_att_feats", ",", "att_masks", "=", "self", ".", "_prepare_feature", "(", "fc_feats", ",", "att_feats", ",", "att_masks", ")", "\n", "\n", "assert", "beam_size", "<=", "self", ".", "vocab_size", "+", "1", ",", "'lets assume this for now, otherwise this corner case causes a few headaches down the road. can be dealt with in future if needed'", "\n", "seq", "=", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", ".", "zero_", "(", ")", "\n", "seqLogprobs", "=", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", "\n", "# lets process every image independently for now, for simplicity", "\n", "\n", "self", ".", "done_beams", "=", "[", "[", "]", "for", "_", "in", "range", "(", "batch_size", ")", "]", "\n", "for", "k", "in", "range", "(", "batch_size", ")", ":", "\n", "            ", "state", "=", "self", ".", "init_hidden", "(", "beam_size", ")", "\n", "tmp_fc_feats", "=", "[", "fc_feats", "[", "i", "]", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "beam_size", ",", "fc_feats", "[", "i", "]", ".", "size", "(", "1", ")", ")", "for", "i", ",", "m", "in", "enumerate", "(", "self", ".", "models", ")", "]", "\n", "tmp_att_feats", "=", "[", "att_feats", "[", "i", "]", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "att_feats", "[", "i", "]", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "for", "i", ",", "m", "in", "enumerate", "(", "self", ".", "models", ")", "]", "\n", "tmp_p_att_feats", "=", "[", "p_att_feats", "[", "i", "]", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "p_att_feats", "[", "i", "]", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "for", "i", ",", "m", "in", "enumerate", "(", "self", ".", "models", ")", "]", "\n", "tmp_att_masks", "=", "[", "att_masks", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "att_masks", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "for", "i", ",", "m", "in", "enumerate", "(", "self", ".", "models", ")", "]", "if", "att_masks", "[", "0", "]", "is", "not", "None", "else", "att_masks", "\n", "\n", "it", "=", "fc_feats", "[", "0", "]", ".", "data", ".", "new", "(", "beam_size", ")", ".", "long", "(", ")", ".", "zero_", "(", ")", "\n", "logprobs", ",", "state", "=", "self", ".", "get_logprobs_state", "(", "it", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "tmp_p_att_feats", ",", "tmp_att_masks", ",", "state", ")", "\n", "\n", "self", ".", "done_beams", "[", "k", "]", "=", "self", ".", "beam_search", "(", "state", ",", "logprobs", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "tmp_p_att_feats", ",", "tmp_att_masks", ",", "opt", "=", "opt", ")", "\n", "seq", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'seq'", "]", "# the first beam has highest cumulative score", "\n", "seqLogprobs", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'logps'", "]", "\n", "# return the samples and their log likelihoods", "\n", "", "return", "seq", ".", "transpose", "(", "0", ",", "1", ")", ",", "seqLogprobs", ".", "transpose", "(", "0", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.beam_search": [[96, 241], ["opt.get", "opt.get", "opt.get", "opt.get", "opt.get", "zip", "list", "range", "reduce", "logprobs_table[].data.float.clone", "range", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "torch.sort", "min", "range", "sorted", "range", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "init_logprobs.chunk", "range", "range", "ys.size", "range", "beam_seq[].clone", "beam_seq_logprobs[].clone", "range", "range", "range", "range", "range", "range", "sorted", "range", "range", "ys[].item", "sorted.append", "_.clone", "len", "range", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "_.chunk", "range", "logprobs_table[].data.float", "AttEnsemble.AttEnsemble.beam_search.add_diversity"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get"], ["", "def", "beam_search", "(", "self", ",", "init_state", ",", "init_logprobs", ",", "*", "args", ",", "**", "kwargs", ")", ":", "\n", "\n", "# function computes the similarity score to be augmented", "\n", "        ", "def", "add_diversity", "(", "beam_seq_table", ",", "logprobsf", ",", "t", ",", "divm", ",", "diversity_lambda", ",", "bdash", ")", ":", "\n", "            ", "local_time", "=", "t", "-", "divm", "\n", "unaug_logprobsf", "=", "logprobsf", ".", "clone", "(", ")", "\n", "for", "prev_choice", "in", "range", "(", "divm", ")", ":", "\n", "                ", "prev_decisions", "=", "beam_seq_table", "[", "prev_choice", "]", "[", "local_time", "]", "\n", "for", "sub_beam", "in", "range", "(", "bdash", ")", ":", "\n", "                    ", "for", "prev_labels", "in", "range", "(", "bdash", ")", ":", "\n", "                        ", "logprobsf", "[", "sub_beam", "]", "[", "prev_decisions", "[", "prev_labels", "]", "]", "=", "logprobsf", "[", "sub_beam", "]", "[", "prev_decisions", "[", "prev_labels", "]", "]", "-", "diversity_lambda", "\n", "", "", "", "return", "unaug_logprobsf", "\n", "\n", "# does one step of classical beam search", "\n", "\n", "", "def", "beam_step", "(", "logprobsf", ",", "unaug_logprobsf", ",", "beam_size", ",", "t", ",", "beam_seq", ",", "beam_seq_logprobs", ",", "beam_logprobs_sum", ",", "state", ")", ":", "\n", "#INPUTS:", "\n", "#logprobsf: probabilities augmented after diversity", "\n", "#beam_size: obvious", "\n", "#t        : time instant", "\n", "#beam_seq : tensor contanining the beams", "\n", "#beam_seq_logprobs: tensor contanining the beam logprobs", "\n", "#beam_logprobs_sum: tensor contanining joint logprobs", "\n", "#OUPUTS:", "\n", "#beam_seq : tensor containing the word indices of the decoded captions", "\n", "#beam_seq_logprobs : log-probability of each decision made, same size as beam_seq", "\n", "#beam_logprobs_sum : joint log-probability of each beam", "\n", "\n", "            ", "ys", ",", "ix", "=", "torch", ".", "sort", "(", "logprobsf", ",", "1", ",", "True", ")", "\n", "candidates", "=", "[", "]", "\n", "cols", "=", "min", "(", "beam_size", ",", "ys", ".", "size", "(", "1", ")", ")", "\n", "rows", "=", "beam_size", "\n", "if", "t", "==", "0", ":", "\n", "                ", "rows", "=", "1", "\n", "", "for", "c", "in", "range", "(", "cols", ")", ":", "# for each column (word, essentially)", "\n", "                ", "for", "q", "in", "range", "(", "rows", ")", ":", "# for each beam expansion", "\n", "#compute logprob of expanding beam q with word in (sorted) position c", "\n", "                    ", "local_logprob", "=", "ys", "[", "q", ",", "c", "]", ".", "item", "(", ")", "\n", "candidate_logprob", "=", "beam_logprobs_sum", "[", "q", "]", "+", "local_logprob", "\n", "local_unaug_logprob", "=", "unaug_logprobsf", "[", "q", ",", "ix", "[", "q", ",", "c", "]", "]", "\n", "candidates", ".", "append", "(", "{", "'c'", ":", "ix", "[", "q", ",", "c", "]", ",", "'q'", ":", "q", ",", "'p'", ":", "candidate_logprob", ",", "'r'", ":", "local_unaug_logprob", "}", ")", "\n", "", "", "candidates", "=", "sorted", "(", "candidates", ",", "key", "=", "lambda", "x", ":", "-", "x", "[", "'p'", "]", ")", "\n", "\n", "new_state", "=", "[", "[", "_", ".", "clone", "(", ")", "for", "_", "in", "state_", "]", "for", "state_", "in", "state", "]", "\n", "#beam_seq_prev, beam_seq_logprobs_prev", "\n", "if", "t", ">=", "1", ":", "\n", "#we''ll need these as reference when we fork beams around", "\n", "                ", "beam_seq_prev", "=", "beam_seq", "[", ":", "t", "]", ".", "clone", "(", ")", "\n", "beam_seq_logprobs_prev", "=", "beam_seq_logprobs", "[", ":", "t", "]", ".", "clone", "(", ")", "\n", "", "for", "vix", "in", "range", "(", "beam_size", ")", ":", "\n", "                ", "v", "=", "candidates", "[", "vix", "]", "\n", "#fork beam index q into index vix", "\n", "if", "t", ">=", "1", ":", "\n", "                    ", "beam_seq", "[", ":", "t", ",", "vix", "]", "=", "beam_seq_prev", "[", ":", ",", "v", "[", "'q'", "]", "]", "\n", "beam_seq_logprobs", "[", ":", "t", ",", "vix", "]", "=", "beam_seq_logprobs_prev", "[", ":", ",", "v", "[", "'q'", "]", "]", "\n", "#rearrange recurrent states", "\n", "", "for", "ii", "in", "range", "(", "len", "(", "new_state", ")", ")", ":", "\n", "                    ", "for", "state_ix", "in", "range", "(", "len", "(", "new_state", "[", "ii", "]", ")", ")", ":", "\n", "#  copy over state in previous beam q to new beam at vix", "\n", "                        ", "new_state", "[", "ii", "]", "[", "state_ix", "]", "[", ":", ",", "vix", "]", "=", "state", "[", "ii", "]", "[", "state_ix", "]", "[", ":", ",", "v", "[", "'q'", "]", "]", "# dimension one is time step", "\n", "#append new end terminal at the end of this beam", "\n", "", "", "beam_seq", "[", "t", ",", "vix", "]", "=", "v", "[", "'c'", "]", "# c'th word is the continuation", "\n", "beam_seq_logprobs", "[", "t", ",", "vix", "]", "=", "v", "[", "'r'", "]", "# the raw logprob here", "\n", "beam_logprobs_sum", "[", "vix", "]", "=", "v", "[", "'p'", "]", "# the new (sum) logprob along this beam", "\n", "", "state", "=", "new_state", "\n", "return", "beam_seq", ",", "beam_seq_logprobs", ",", "beam_logprobs_sum", ",", "state", ",", "candidates", "\n", "\n", "# Start diverse_beam_search", "\n", "", "opt", "=", "kwargs", "[", "'opt'", "]", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "10", ")", "\n", "group_size", "=", "opt", ".", "get", "(", "'group_size'", ",", "1", ")", "\n", "diversity_lambda", "=", "opt", ".", "get", "(", "'diversity_lambda'", ",", "0.5", ")", "\n", "decoding_constraint", "=", "opt", ".", "get", "(", "'decoding_constraint'", ",", "0", ")", "\n", "max_ppl", "=", "opt", ".", "get", "(", "'max_ppl'", ",", "0", ")", "\n", "bdash", "=", "beam_size", "//", "group_size", "# beam per group", "\n", "\n", "# INITIALIZATIONS", "\n", "beam_seq_table", "=", "[", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "bdash", ")", ".", "zero_", "(", ")", "for", "_", "in", "range", "(", "group_size", ")", "]", "\n", "beam_seq_logprobs_table", "=", "[", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "bdash", ")", ".", "zero_", "(", ")", "for", "_", "in", "range", "(", "group_size", ")", "]", "\n", "beam_logprobs_sum_table", "=", "[", "torch", ".", "zeros", "(", "bdash", ")", "for", "_", "in", "range", "(", "group_size", ")", "]", "\n", "\n", "# logprobs # logprobs predicted in last time step, shape (beam_size, vocab_size+1)", "\n", "done_beams_table", "=", "[", "[", "]", "for", "_", "in", "range", "(", "group_size", ")", "]", "\n", "state_table", "=", "zip", "(", "*", "[", "[", "list", "(", "torch", ".", "unbind", "(", "_", ")", ")", "for", "_", "in", "torch", ".", "stack", "(", "init_state_", ")", ".", "chunk", "(", "group_size", ",", "2", ")", "]", "for", "init_state_", "in", "init_state", "]", ")", "\n", "logprobs_table", "=", "list", "(", "init_logprobs", ".", "chunk", "(", "group_size", ",", "0", ")", ")", "\n", "# END INIT", "\n", "\n", "# Chunk elements in the args", "\n", "args", "=", "[", "[", "_", ".", "chunk", "(", "group_size", ")", "if", "_", "is", "not", "None", "else", "[", "None", "]", "*", "group_size", "for", "_", "in", "args_", "]", "for", "args_", "in", "args", "]", "# arg_name, model_name, group_name", "\n", "args", "=", "[", "[", "[", "args", "[", "j", "]", "[", "i", "]", "[", "k", "]", "for", "i", "in", "range", "(", "len", "(", "self", ".", "models", ")", ")", "]", "for", "j", "in", "range", "(", "len", "(", "args", ")", ")", "]", "for", "k", "in", "range", "(", "group_size", ")", "]", "# group_name, arg_name, model_name", "\n", "\n", "for", "t", "in", "range", "(", "self", ".", "seq_length", "+", "group_size", "-", "1", ")", ":", "\n", "            ", "for", "divm", "in", "range", "(", "group_size", ")", ":", "\n", "                ", "if", "t", ">=", "divm", "and", "t", "<=", "self", ".", "seq_length", "+", "divm", "-", "1", ":", "\n", "# add diversity", "\n", "                    ", "logprobsf", "=", "logprobs_table", "[", "divm", "]", ".", "data", ".", "float", "(", ")", "\n", "# suppress previous word", "\n", "if", "decoding_constraint", "and", "t", "-", "divm", ">", "0", ":", "\n", "                        ", "logprobsf", ".", "scatter_", "(", "1", ",", "beam_seq_table", "[", "divm", "]", "[", "t", "-", "divm", "-", "1", "]", ".", "unsqueeze", "(", "1", ")", ".", "cuda", "(", ")", ",", "float", "(", "'-inf'", ")", ")", "\n", "# suppress UNK tokens in the decoding", "\n", "", "logprobsf", "[", ":", ",", "logprobsf", ".", "size", "(", "1", ")", "-", "1", "]", "=", "logprobsf", "[", ":", ",", "logprobsf", ".", "size", "(", "1", ")", "-", "1", "]", "-", "1000", "\n", "# diversity is added here", "\n", "# the function directly modifies the logprobsf values and hence, we need to return", "\n", "# the unaugmented ones for sorting the candidates in the end. # for historical", "\n", "# reasons :-)", "\n", "unaug_logprobsf", "=", "add_diversity", "(", "beam_seq_table", ",", "logprobsf", ",", "t", ",", "divm", ",", "diversity_lambda", ",", "bdash", ")", "\n", "\n", "# infer new beams", "\n", "beam_seq_table", "[", "divm", "]", ",", "beam_seq_logprobs_table", "[", "divm", "]", ",", "beam_logprobs_sum_table", "[", "divm", "]", ",", "state_table", "[", "divm", "]", ",", "candidates_divm", "=", "beam_step", "(", "logprobsf", ",", "\n", "unaug_logprobsf", ",", "\n", "bdash", ",", "\n", "t", "-", "divm", ",", "\n", "beam_seq_table", "[", "divm", "]", ",", "\n", "beam_seq_logprobs_table", "[", "divm", "]", ",", "\n", "beam_logprobs_sum_table", "[", "divm", "]", ",", "\n", "state_table", "[", "divm", "]", ")", "\n", "\n", "# if time's up... or if end token is reached then copy beams", "\n", "for", "vix", "in", "range", "(", "bdash", ")", ":", "\n", "                        ", "if", "beam_seq_table", "[", "divm", "]", "[", "t", "-", "divm", ",", "vix", "]", "==", "0", "or", "t", "==", "self", ".", "seq_length", "+", "divm", "-", "1", ":", "\n", "                            ", "final_beam", "=", "{", "\n", "'seq'", ":", "beam_seq_table", "[", "divm", "]", "[", ":", ",", "vix", "]", ".", "clone", "(", ")", ",", "\n", "'logps'", ":", "beam_seq_logprobs_table", "[", "divm", "]", "[", ":", ",", "vix", "]", ".", "clone", "(", ")", ",", "\n", "'unaug_p'", ":", "beam_seq_logprobs_table", "[", "divm", "]", "[", ":", ",", "vix", "]", ".", "sum", "(", ")", ".", "item", "(", ")", ",", "\n", "'p'", ":", "beam_logprobs_sum_table", "[", "divm", "]", "[", "vix", "]", ".", "item", "(", ")", "\n", "}", "\n", "if", "max_ppl", ":", "\n", "                                ", "final_beam", "[", "'p'", "]", "=", "final_beam", "[", "'p'", "]", "/", "(", "t", "-", "divm", "+", "1", ")", "\n", "", "done_beams_table", "[", "divm", "]", ".", "append", "(", "final_beam", ")", "\n", "# don't continue beams from finished sequences", "\n", "beam_logprobs_sum_table", "[", "divm", "]", "[", "vix", "]", "=", "-", "1000", "\n", "\n", "# move the current group one step forward in time", "\n", "\n", "", "", "it", "=", "beam_seq_table", "[", "divm", "]", "[", "t", "-", "divm", "]", "\n", "logprobs_table", "[", "divm", "]", ",", "state_table", "[", "divm", "]", "=", "self", ".", "get_logprobs_state", "(", "it", ".", "cuda", "(", ")", ",", "*", "(", "args", "[", "divm", "]", "+", "[", "state_table", "[", "divm", "]", "]", ")", ")", "\n", "\n", "# all beams are sorted by their log-probabilities", "\n", "", "", "", "done_beams_table", "=", "[", "sorted", "(", "done_beams_table", "[", "i", "]", ",", "key", "=", "lambda", "x", ":", "-", "x", "[", "'p'", "]", ")", "[", ":", "bdash", "]", "for", "i", "in", "range", "(", "group_size", ")", "]", "\n", "done_beams", "=", "reduce", "(", "lambda", "a", ",", "b", ":", "a", "+", "b", ",", "done_beams_table", ")", "\n", "return", "done_beams", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.OldModel.__init__": [[21, 41], ["CaptionModel.CaptionModel.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Embedding", "torch.Embedding", "torch.Embedding", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Dropout", "torch.Dropout", "torch.Dropout", "OldModel.OldModel.init_weights"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_weights"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "OldModel", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "vocab_size", "=", "opt", ".", "vocab_size", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "self", ".", "rnn_type", "=", "opt", ".", "rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "num_layers", "=", "opt", ".", "num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "seq_length", "=", "opt", ".", "seq_length", "\n", "self", ".", "fc_feat_size", "=", "opt", ".", "fc_feat_size", "\n", "self", ".", "att_feat_size", "=", "opt", ".", "att_feat_size", "\n", "\n", "self", ".", "ss_prob", "=", "0.0", "# Schedule sampling probability", "\n", "\n", "self", ".", "linear", "=", "nn", ".", "Linear", "(", "self", ".", "fc_feat_size", ",", "self", ".", "num_layers", "*", "self", ".", "rnn_size", ")", "# feature to rnn_size", "\n", "self", ".", "embed", "=", "nn", ".", "Embedding", "(", "self", ".", "vocab_size", "+", "1", ",", "self", ".", "input_encoding_size", ")", "\n", "self", ".", "logit", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "vocab_size", "+", "1", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", "\n", "\n", "self", ".", "init_weights", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.OldModel.init_weights": [[42, 47], ["OldModel.OldModel.embed.weight.data.uniform_", "OldModel.OldModel.logit.bias.data.fill_", "OldModel.OldModel.logit.weight.data.uniform_"], "methods", ["None"], ["", "def", "init_weights", "(", "self", ")", ":", "\n", "        ", "initrange", "=", "0.1", "\n", "self", ".", "embed", ".", "weight", ".", "data", ".", "uniform_", "(", "-", "initrange", ",", "initrange", ")", "\n", "self", ".", "logit", ".", "bias", ".", "data", ".", "fill_", "(", "0", ")", "\n", "self", ".", "logit", ".", "weight", ".", "data", ".", "uniform_", "(", "-", "initrange", ",", "initrange", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.OldModel.init_hidden": [[48, 54], ["OldModel.OldModel.linear().view().transpose", "OldModel.OldModel.linear().view", "OldModel.OldModel.linear"], "methods", ["None"], ["", "def", "init_hidden", "(", "self", ",", "fc_feats", ")", ":", "\n", "        ", "image_map", "=", "self", ".", "linear", "(", "fc_feats", ")", ".", "view", "(", "-", "1", ",", "self", ".", "num_layers", ",", "self", ".", "rnn_size", ")", ".", "transpose", "(", "0", ",", "1", ")", "\n", "if", "self", ".", "rnn_type", "==", "'lstm'", ":", "\n", "            ", "return", "(", "image_map", ",", "image_map", ")", "\n", "", "else", ":", "\n", "            ", "return", "image_map", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.OldModel.forward": [[55, 87], ["fc_feats.size", "OldModel.OldModel.init_hidden", "range", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "OldModel.OldModel.embed", "OldModel.OldModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "outputs.append", "seq.size", "fc_feats.data.new().uniform_", "seq[].clone", "OldModel.OldModel.logit", "_.unsqueeze", "sample_mask.sum", "seq[].clone", "sample_mask.nonzero().view", "seq[].data.clone", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "seq[].data.clone.index_copy_", "seq[].sum", "OldModel.OldModel.dropout", "fc_feats.data.new", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "sample_mask.nonzero", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core"], ["", "", "def", "forward", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "seq", ")", ":", "\n", "        ", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "state", "=", "self", ".", "init_hidden", "(", "fc_feats", ")", "\n", "\n", "outputs", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "seq", ".", "size", "(", "1", ")", "-", "1", ")", ":", "\n", "            ", "if", "self", ".", "training", "and", "i", ">=", "1", "and", "self", ".", "ss_prob", ">", "0.0", ":", "# otherwiste no need to sample", "\n", "                ", "sample_prob", "=", "fc_feats", ".", "data", ".", "new", "(", "batch_size", ")", ".", "uniform_", "(", "0", ",", "1", ")", "\n", "sample_mask", "=", "sample_prob", "<", "self", ".", "ss_prob", "\n", "if", "sample_mask", ".", "sum", "(", ")", "==", "0", ":", "\n", "                    ", "it", "=", "seq", "[", ":", ",", "i", "]", ".", "clone", "(", ")", "\n", "", "else", ":", "\n", "                    ", "sample_ind", "=", "sample_mask", ".", "nonzero", "(", ")", ".", "view", "(", "-", "1", ")", "\n", "it", "=", "seq", "[", ":", ",", "i", "]", ".", "data", ".", "clone", "(", ")", "\n", "#prob_prev = torch.exp(outputs[-1].data.index_select(0, sample_ind)) # fetch prev distribution: shape Nx(M+1)", "\n", "#it.index_copy_(0, sample_ind, torch.multinomial(prob_prev, 1).view(-1))", "\n", "prob_prev", "=", "torch", ".", "exp", "(", "outputs", "[", "-", "1", "]", ".", "data", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "it", ".", "index_copy_", "(", "0", ",", "sample_ind", ",", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", ".", "view", "(", "-", "1", ")", ".", "index_select", "(", "0", ",", "sample_ind", ")", ")", "\n", "", "", "else", ":", "\n", "                ", "it", "=", "seq", "[", ":", ",", "i", "]", ".", "clone", "(", ")", "\n", "# break if all the sequences end", "\n", "", "if", "i", ">=", "1", "and", "seq", "[", ":", ",", "i", "]", ".", "sum", "(", ")", "==", "0", ":", "\n", "                ", "break", "\n", "\n", "", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "fc_feats", ",", "att_feats", ",", "state", ")", "\n", "output", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "self", ".", "dropout", "(", "output", ")", ")", ",", "dim", "=", "1", ")", "\n", "outputs", ".", "append", "(", "output", ")", "\n", "\n", "", "return", "torch", ".", "cat", "(", "[", "_", ".", "unsqueeze", "(", "1", ")", "for", "_", "in", "outputs", "]", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.OldModel.get_logprobs_state": [[88, 96], ["OldModel.OldModel.embed", "OldModel.OldModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "OldModel.OldModel.logit", "OldModel.OldModel.dropout"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core"], ["", "def", "get_logprobs_state", "(", "self", ",", "it", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "state", ")", ":", "\n", "# 'it' contains a word index", "\n", "        ", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "state", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "self", ".", "dropout", "(", "output", ")", ")", ",", "dim", "=", "1", ")", "\n", "\n", "return", "logprobs", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.OldModel.sample_beam": [[97, 130], ["opt.get", "fc_feats.size", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "range", "fc_feats[].expand", "att_feats[].expand().contiguous", "OldModel.OldModel.init_hidden", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.FloatTensor().zero_", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "range", "OldModel.OldModel.beam_search", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "range", "OldModel.OldModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "att_feats[].expand", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "fc_feats.data.new().long().zero_", "OldModel.OldModel.embed", "OldModel.OldModel.logit", "OldModel.OldModel.dropout", "fc_feats.data.new().long", "att_feats.size", "fc_feats.data.new"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.beam_search", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed"], ["", "def", "sample_beam", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "10", ")", "\n", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "\n", "assert", "beam_size", "<=", "self", ".", "vocab_size", "+", "1", ",", "'lets assume this for now, otherwise this corner case causes a few headaches down the road. can be dealt with in future if needed'", "\n", "seq", "=", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", ".", "zero_", "(", ")", "\n", "seqLogprobs", "=", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", "\n", "# lets process every image independently for now, for simplicity", "\n", "\n", "self", ".", "done_beams", "=", "[", "[", "]", "for", "_", "in", "range", "(", "batch_size", ")", "]", "\n", "for", "k", "in", "range", "(", "batch_size", ")", ":", "\n", "            ", "tmp_fc_feats", "=", "fc_feats", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "beam_size", ",", "self", ".", "fc_feat_size", ")", "\n", "tmp_att_feats", "=", "att_feats", "[", "k", ":", "k", "+", "1", "]", ".", "expand", "(", "*", "(", "(", "beam_size", ",", ")", "+", "att_feats", ".", "size", "(", ")", "[", "1", ":", "]", ")", ")", ".", "contiguous", "(", ")", "\n", "\n", "state", "=", "self", ".", "init_hidden", "(", "tmp_fc_feats", ")", "\n", "\n", "beam_seq", "=", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "beam_size", ")", ".", "zero_", "(", ")", "\n", "beam_seq_logprobs", "=", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "beam_size", ")", ".", "zero_", "(", ")", "\n", "beam_logprobs_sum", "=", "torch", ".", "zeros", "(", "beam_size", ")", "# running sum of logprobs for each beam", "\n", "done_beams", "=", "[", "]", "\n", "for", "t", "in", "range", "(", "1", ")", ":", "\n", "                ", "if", "t", "==", "0", ":", "# input <bos>", "\n", "                    ", "it", "=", "fc_feats", ".", "data", ".", "new", "(", "beam_size", ")", ".", "long", "(", ")", ".", "zero_", "(", ")", "\n", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "state", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "self", ".", "dropout", "(", "output", ")", ")", ",", "dim", "=", "1", ")", "\n", "\n", "", "self", ".", "done_beams", "[", "k", "]", "=", "self", ".", "beam_search", "(", "state", ",", "logprobs", ",", "tmp_fc_feats", ",", "tmp_att_feats", ",", "opt", "=", "opt", ")", "\n", "seq", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'seq'", "]", "# the first beam has highest cumulative score", "\n", "seqLogprobs", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'logps'", "]", "\n", "# return the samples and their log likelihoods", "\n", "", "return", "seq", ".", "transpose", "(", "0", ",", "1", ")", ",", "seqLogprobs", ".", "transpose", "(", "0", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.OldModel.sample": [[131, 177], ["opt.get", "opt.get", "opt.get", "fc_feats.size", "OldModel.OldModel.init_hidden", "range", "OldModel.OldModel.sample_beam", "OldModel.OldModel.embed", "OldModel.OldModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "fc_feats.data.new().long().zero_", "seq.append", "seqLogprobs.append", "OldModel.OldModel.logit", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "it.view().long.view().long.view().long", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.log_softmax.gather", "it.view().long.view().long.view().long", "unfinished.sum", "unfinished.type_as", "F.log_softmax.gather.view", "OldModel.OldModel.dropout", "_.unsqueeze", "_.unsqueeze", "fc_feats.data.new().long", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "it.view().long.view().long.view", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "it.view().long.view().long.view", "fc_feats.data.new", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.OldModel.sample_beam", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core"], ["", "def", "sample", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "sample_max", "=", "opt", ".", "get", "(", "'sample_max'", ",", "1", ")", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "1", ")", "\n", "temperature", "=", "opt", ".", "get", "(", "'temperature'", ",", "1.0", ")", "\n", "if", "beam_size", ">", "1", ":", "\n", "            ", "return", "self", ".", "sample_beam", "(", "fc_feats", ",", "att_feats", ",", "opt", ")", "\n", "\n", "", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "state", "=", "self", ".", "init_hidden", "(", "fc_feats", ")", "\n", "\n", "seq", "=", "[", "]", "\n", "seqLogprobs", "=", "[", "]", "\n", "for", "t", "in", "range", "(", "self", ".", "seq_length", "+", "1", ")", ":", "\n", "            ", "if", "t", "==", "0", ":", "# input <bos>", "\n", "                ", "it", "=", "fc_feats", ".", "data", ".", "new", "(", "batch_size", ")", ".", "long", "(", ")", ".", "zero_", "(", ")", "\n", "", "elif", "sample_max", ":", "\n", "                ", "sampleLogprobs", ",", "it", "=", "torch", ".", "max", "(", "logprobs", ".", "data", ",", "1", ")", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "\n", "", "else", ":", "\n", "                ", "if", "temperature", "==", "1.0", ":", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "logprobs", ".", "data", ")", ".", "cpu", "(", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "", "else", ":", "\n", "# scale logprobs by temperature", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "torch", ".", "div", "(", "logprobs", ".", "data", ",", "temperature", ")", ")", ".", "cpu", "(", ")", "\n", "", "it", "=", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", ".", "cuda", "(", ")", "\n", "sampleLogprobs", "=", "logprobs", ".", "gather", "(", "1", ",", "it", ")", "# gather the logprobs at sampled positions", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "# and flatten indices for downstream processing", "\n", "\n", "", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "if", "t", ">=", "1", ":", "\n", "# stop when all finished", "\n", "                ", "if", "t", "==", "1", ":", "\n", "                    ", "unfinished", "=", "it", ">", "0", "\n", "", "else", ":", "\n", "                    ", "unfinished", "=", "unfinished", "*", "(", "it", ">", "0", ")", "\n", "", "if", "unfinished", ".", "sum", "(", ")", "==", "0", ":", "\n", "                    ", "break", "\n", "", "it", "=", "it", "*", "unfinished", ".", "type_as", "(", "it", ")", "\n", "seq", ".", "append", "(", "it", ")", "#seq[t] the input of t+2 time step", "\n", "seqLogprobs", ".", "append", "(", "sampleLogprobs", ".", "view", "(", "-", "1", ")", ")", "\n", "\n", "", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "fc_feats", ",", "att_feats", ",", "state", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "self", ".", "dropout", "(", "output", ")", ")", ",", "dim", "=", "1", ")", "\n", "\n", "", "return", "torch", ".", "cat", "(", "[", "_", ".", "unsqueeze", "(", "1", ")", "for", "_", "in", "seq", "]", ",", "1", ")", ",", "torch", ".", "cat", "(", "[", "_", ".", "unsqueeze", "(", "1", ")", "for", "_", "in", "seqLogprobs", "]", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.ShowAttendTellCore.__init__": [[180, 201], ["torch.Module.__init__", "getattr", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "OldModel.ShowAttendTellCore.rnn_type.upper"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "ShowAttendTellCore", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "self", ".", "rnn_type", "=", "opt", ".", "rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "num_layers", "=", "opt", ".", "num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "fc_feat_size", "=", "opt", ".", "fc_feat_size", "\n", "self", ".", "att_feat_size", "=", "opt", ".", "att_feat_size", "\n", "self", ".", "att_hid_size", "=", "opt", ".", "att_hid_size", "\n", "\n", "self", ".", "rnn", "=", "getattr", "(", "nn", ",", "self", ".", "rnn_type", ".", "upper", "(", ")", ")", "(", "self", ".", "input_encoding_size", "+", "self", ".", "att_feat_size", ",", "\n", "self", ".", "rnn_size", ",", "self", ".", "num_layers", ",", "bias", "=", "False", ",", "dropout", "=", "self", ".", "drop_prob_lm", ")", "\n", "\n", "if", "self", ".", "att_hid_size", ">", "0", ":", "\n", "            ", "self", ".", "ctx2att", "=", "nn", ".", "Linear", "(", "self", ".", "att_feat_size", ",", "self", ".", "att_hid_size", ")", "\n", "self", ".", "h2att", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "att_hid_size", ")", "\n", "self", ".", "alpha_net", "=", "nn", ".", "Linear", "(", "self", ".", "att_hid_size", ",", "1", ")", "\n", "", "else", ":", "\n", "            ", "self", ".", "ctx2att", "=", "nn", ".", "Linear", "(", "self", ".", "att_feat_size", ",", "1", ")", "\n", "self", ".", "h2att", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.ShowAttendTellCore.forward": [[202, 228], ["att_feats.view", "torch.softmax", "torch.softmax", "torch.softmax", "att_feats.view", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "torch.bmm().squeeze", "OldModel.ShowAttendTellCore.rnn", "OldModel.ShowAttendTellCore.ctx2att", "att.view.view.view", "OldModel.ShowAttendTellCore.h2att", "att_h.expand_as.expand_as.unsqueeze().expand_as", "torch.tanh", "torch.tanh", "torch.tanh", "dot.view.view.view", "OldModel.ShowAttendTellCore.alpha_net", "dot.view.view.view", "att.view.view.view", "OldModel.ShowAttendTellCore.h2att", "att_h.expand_as.expand_as.expand_as", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "output.squeeze", "att_feats.numel", "att_feats.size", "OldModel.ShowAttendTellCore.ctx2att", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "torch.bmm", "att_h.expand_as.expand_as.unsqueeze", "torch.softmax.unsqueeze", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat"], "methods", ["None"], ["", "", "def", "forward", "(", "self", ",", "xt", ",", "fc_feats", ",", "att_feats", ",", "state", ")", ":", "\n", "        ", "att_size", "=", "att_feats", ".", "numel", "(", ")", "//", "att_feats", ".", "size", "(", "0", ")", "//", "self", ".", "att_feat_size", "\n", "att", "=", "att_feats", ".", "view", "(", "-", "1", ",", "self", ".", "att_feat_size", ")", "\n", "if", "self", ".", "att_hid_size", ">", "0", ":", "\n", "            ", "att", "=", "self", ".", "ctx2att", "(", "att", ")", "# (batch * att_size) * att_hid_size", "\n", "att", "=", "att", ".", "view", "(", "-", "1", ",", "att_size", ",", "self", ".", "att_hid_size", ")", "# batch * att_size * att_hid_size", "\n", "att_h", "=", "self", ".", "h2att", "(", "state", "[", "0", "]", "[", "-", "1", "]", ")", "# batch * att_hid_size", "\n", "att_h", "=", "att_h", ".", "unsqueeze", "(", "1", ")", ".", "expand_as", "(", "att", ")", "# batch * att_size * att_hid_size", "\n", "dot", "=", "att", "+", "att_h", "# batch * att_size * att_hid_size", "\n", "dot", "=", "F", ".", "tanh", "(", "dot", ")", "# batch * att_size * att_hid_size", "\n", "dot", "=", "dot", ".", "view", "(", "-", "1", ",", "self", ".", "att_hid_size", ")", "# (batch * att_size) * att_hid_size", "\n", "dot", "=", "self", ".", "alpha_net", "(", "dot", ")", "# (batch * att_size) * 1", "\n", "dot", "=", "dot", ".", "view", "(", "-", "1", ",", "att_size", ")", "# batch * att_size", "\n", "", "else", ":", "\n", "            ", "att", "=", "self", ".", "ctx2att", "(", "att", ")", "(", "att", ")", "# (batch * att_size) * 1", "\n", "att", "=", "att", ".", "view", "(", "-", "1", ",", "att_size", ")", "# batch * att_size", "\n", "att_h", "=", "self", ".", "h2att", "(", "state", "[", "0", "]", "[", "-", "1", "]", ")", "# batch * 1", "\n", "att_h", "=", "att_h", ".", "expand_as", "(", "att", ")", "# batch * att_size", "\n", "dot", "=", "att_h", "+", "att", "# batch * att_size", "\n", "\n", "", "weight", "=", "F", ".", "softmax", "(", "dot", ",", "dim", "=", "1", ")", "\n", "att_feats_", "=", "att_feats", ".", "view", "(", "-", "1", ",", "att_size", ",", "self", ".", "att_feat_size", ")", "# batch * att_size * att_feat_size", "\n", "att_res", "=", "torch", ".", "bmm", "(", "weight", ".", "unsqueeze", "(", "1", ")", ",", "att_feats_", ")", ".", "squeeze", "(", "1", ")", "# batch * att_feat_size", "\n", "\n", "output", ",", "state", "=", "self", ".", "rnn", "(", "torch", ".", "cat", "(", "[", "xt", ",", "att_res", "]", ",", "1", ")", ".", "unsqueeze", "(", "0", ")", ",", "state", ")", "\n", "return", "output", ".", "squeeze", "(", "0", ")", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.AllImgCore.__init__": [[230, 241], ["torch.Module.__init__", "getattr", "OldModel.AllImgCore.rnn_type.upper"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "AllImgCore", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "self", ".", "rnn_type", "=", "opt", ".", "rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "num_layers", "=", "opt", ".", "num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "fc_feat_size", "=", "opt", ".", "fc_feat_size", "\n", "\n", "self", ".", "rnn", "=", "getattr", "(", "nn", ",", "self", ".", "rnn_type", ".", "upper", "(", ")", ")", "(", "self", ".", "input_encoding_size", "+", "self", ".", "fc_feat_size", ",", "\n", "self", ".", "rnn_size", ",", "self", ".", "num_layers", ",", "bias", "=", "False", ",", "dropout", "=", "self", ".", "drop_prob_lm", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.AllImgCore.forward": [[242, 245], ["OldModel.AllImgCore.rnn", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "torch.cat().unsqueeze", "output.squeeze", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "xt", ",", "fc_feats", ",", "att_feats", ",", "state", ")", ":", "\n", "        ", "output", ",", "state", "=", "self", ".", "rnn", "(", "torch", ".", "cat", "(", "[", "xt", ",", "fc_feats", "]", ",", "1", ")", ".", "unsqueeze", "(", "0", ")", ",", "state", ")", "\n", "return", "output", ".", "squeeze", "(", "0", ")", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.ShowAttendTellModel.__init__": [[247, 250], ["OldModel.OldModel.__init__", "OldModel.ShowAttendTellCore"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "ShowAttendTellModel", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "self", ".", "core", "=", "ShowAttendTellCore", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.OldModel.AllImgModel.__init__": [[252, 255], ["OldModel.OldModel.__init__", "OldModel.AllImgCore"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "AllImgModel", ",", "self", ")", ".", "__init__", "(", "opt", ")", "\n", "self", ".", "core", "=", "AllImgCore", "(", "opt", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.LSTMCore.__init__": [[14, 24], ["torch.Module.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Linear", "torch.Dropout", "torch.Dropout", "torch.Dropout"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "LSTMCore", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "\n", "# Build a LSTM", "\n", "self", ".", "i2h", "=", "nn", ".", "Linear", "(", "self", ".", "input_encoding_size", ",", "5", "*", "self", ".", "rnn_size", ")", "\n", "self", ".", "h2h", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "5", "*", "self", ".", "rnn_size", ")", "\n", "self", ".", "dropout", "=", "nn", ".", "Dropout", "(", "self", ".", "drop_prob_lm", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.LSTMCore.forward": [[25, 43], ["all_input_sums.narrow", "torch.sigmoid", "torch.sigmoid", "torch.sigmoid", "torch.sigmoid.narrow", "torch.sigmoid.narrow", "torch.sigmoid.narrow", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "FCModel.LSTMCore.dropout", "FCModel.LSTMCore.i2h", "FCModel.LSTMCore.h2h", "all_input_sums.narrow", "all_input_sums.narrow", "torch.tanh", "torch.tanh", "torch.tanh", "next_h.unsqueeze", "next_c.unsqueeze"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "xt", ",", "state", ")", ":", "\n", "\n", "        ", "all_input_sums", "=", "self", ".", "i2h", "(", "xt", ")", "+", "self", ".", "h2h", "(", "state", "[", "0", "]", "[", "-", "1", "]", ")", "\n", "sigmoid_chunk", "=", "all_input_sums", ".", "narrow", "(", "1", ",", "0", ",", "3", "*", "self", ".", "rnn_size", ")", "\n", "sigmoid_chunk", "=", "F", ".", "sigmoid", "(", "sigmoid_chunk", ")", "\n", "in_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "0", ",", "self", ".", "rnn_size", ")", "\n", "forget_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", "\n", "out_gate", "=", "sigmoid_chunk", ".", "narrow", "(", "1", ",", "self", ".", "rnn_size", "*", "2", ",", "self", ".", "rnn_size", ")", "\n", "\n", "in_transform", "=", "torch", ".", "max", "(", "all_input_sums", ".", "narrow", "(", "1", ",", "3", "*", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", ",", "\n", "all_input_sums", ".", "narrow", "(", "1", ",", "4", "*", "self", ".", "rnn_size", ",", "self", ".", "rnn_size", ")", ")", "\n", "next_c", "=", "forget_gate", "*", "state", "[", "1", "]", "[", "-", "1", "]", "+", "in_gate", "*", "in_transform", "\n", "next_h", "=", "out_gate", "*", "F", ".", "tanh", "(", "next_c", ")", "\n", "\n", "output", "=", "self", ".", "dropout", "(", "next_h", ")", "\n", "state", "=", "(", "next_h", ".", "unsqueeze", "(", "0", ")", ",", "next_c", ".", "unsqueeze", "(", "0", ")", ")", "\n", "return", "output", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.__init__": [[45, 64], ["CaptionModel.CaptionModel.__init__", "torch.Linear", "torch.Linear", "torch.Linear", "FCModel.LSTMCore", "torch.Embedding", "torch.Embedding", "torch.Embedding", "torch.Linear", "torch.Linear", "torch.Linear", "FCModel.FCModel.init_weights"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_weights"], ["    ", "def", "__init__", "(", "self", ",", "opt", ")", ":", "\n", "        ", "super", "(", "FCModel", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "vocab_size", "=", "opt", ".", "vocab_size", "\n", "self", ".", "input_encoding_size", "=", "opt", ".", "input_encoding_size", "\n", "self", ".", "rnn_type", "=", "opt", ".", "rnn_type", "\n", "self", ".", "rnn_size", "=", "opt", ".", "rnn_size", "\n", "self", ".", "num_layers", "=", "opt", ".", "num_layers", "\n", "self", ".", "drop_prob_lm", "=", "opt", ".", "drop_prob_lm", "\n", "self", ".", "seq_length", "=", "opt", ".", "seq_length", "\n", "self", ".", "fc_feat_size", "=", "opt", ".", "fc_feat_size", "\n", "\n", "self", ".", "ss_prob", "=", "0.0", "# Schedule sampling probability", "\n", "\n", "self", ".", "img_embed", "=", "nn", ".", "Linear", "(", "self", ".", "fc_feat_size", ",", "self", ".", "input_encoding_size", ")", "\n", "self", ".", "core", "=", "LSTMCore", "(", "opt", ")", "\n", "self", ".", "embed", "=", "nn", ".", "Embedding", "(", "self", ".", "vocab_size", "+", "1", ",", "self", ".", "input_encoding_size", ")", "\n", "self", ".", "logit", "=", "nn", ".", "Linear", "(", "self", ".", "rnn_size", ",", "self", ".", "vocab_size", "+", "1", ")", "\n", "\n", "self", ".", "init_weights", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_weights": [[65, 70], ["FCModel.FCModel.embed.weight.data.uniform_", "FCModel.FCModel.logit.bias.data.fill_", "FCModel.FCModel.logit.weight.data.uniform_"], "methods", ["None"], ["", "def", "init_weights", "(", "self", ")", ":", "\n", "        ", "initrange", "=", "0.1", "\n", "self", ".", "embed", ".", "weight", ".", "data", ".", "uniform_", "(", "-", "initrange", ",", "initrange", ")", "\n", "self", ".", "logit", ".", "bias", ".", "data", ".", "fill_", "(", "0", ")", "\n", "self", ".", "logit", ".", "weight", ".", "data", ".", "uniform_", "(", "-", "initrange", ",", "initrange", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden": [[71, 78], ["next", "FCModel.FCModel.parameters", "next.new_zeros", "next.new_zeros", "next.new_zeros"], "methods", ["None"], ["", "def", "init_hidden", "(", "self", ",", "bsz", ")", ":", "\n", "        ", "weight", "=", "next", "(", "self", ".", "parameters", "(", ")", ")", "\n", "if", "self", ".", "rnn_type", "==", "'lstm'", ":", "\n", "            ", "return", "(", "weight", ".", "new_zeros", "(", "self", ".", "num_layers", ",", "bsz", ",", "self", ".", "rnn_size", ")", ",", "\n", "weight", ".", "new_zeros", "(", "self", ".", "num_layers", ",", "bsz", ",", "self", ".", "rnn_size", ")", ")", "\n", "", "else", ":", "\n", "            ", "return", "weight", ".", "new_zeros", "(", "self", ".", "num_layers", ",", "bsz", ",", "self", ".", "rnn_size", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel._forward": [[79, 112], ["fc_feats.size", "FCModel.FCModel.init_hidden", "range", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "torch.cat().contiguous", "seq.size", "FCModel.FCModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "outputs.append", "FCModel.FCModel.img_embed", "FCModel.FCModel.embed", "FCModel.FCModel.logit", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "fc_feats.data.new().uniform_", "seq[].clone", "sample_mask.sum", "seq[].clone", "sample_mask.nonzero().view", "seq[].data.clone", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "seq[].data.clone.index_copy_", "seq[].sum", "_.unsqueeze", "fc_feats.data.new", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "torch.multinomial().view().index_select", "sample_mask.nonzero", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial().view", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed"], ["", "", "def", "_forward", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "seq", ",", "att_masks", "=", "None", ")", ":", "\n", "        ", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "state", "=", "self", ".", "init_hidden", "(", "batch_size", ")", "\n", "outputs", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "seq", ".", "size", "(", "1", ")", ")", ":", "\n", "            ", "if", "i", "==", "0", ":", "\n", "                ", "xt", "=", "self", ".", "img_embed", "(", "fc_feats", ")", "\n", "", "else", ":", "\n", "                ", "if", "self", ".", "training", "and", "i", ">=", "2", "and", "self", ".", "ss_prob", ">", "0.0", ":", "# otherwiste no need to sample", "\n", "                    ", "sample_prob", "=", "fc_feats", ".", "data", ".", "new", "(", "batch_size", ")", ".", "uniform_", "(", "0", ",", "1", ")", "\n", "sample_mask", "=", "sample_prob", "<", "self", ".", "ss_prob", "\n", "if", "sample_mask", ".", "sum", "(", ")", "==", "0", ":", "\n", "                        ", "it", "=", "seq", "[", ":", ",", "i", "-", "1", "]", ".", "clone", "(", ")", "\n", "", "else", ":", "\n", "                        ", "sample_ind", "=", "sample_mask", ".", "nonzero", "(", ")", ".", "view", "(", "-", "1", ")", "\n", "it", "=", "seq", "[", ":", ",", "i", "-", "1", "]", ".", "data", ".", "clone", "(", ")", "\n", "#prob_prev = torch.exp(outputs[-1].data.index_select(0, sample_ind)) # fetch prev distribution: shape Nx(M+1)", "\n", "#it.index_copy_(0, sample_ind, torch.multinomial(prob_prev, 1).view(-1))", "\n", "prob_prev", "=", "torch", ".", "exp", "(", "outputs", "[", "-", "1", "]", ".", "data", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "it", ".", "index_copy_", "(", "0", ",", "sample_ind", ",", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", ".", "view", "(", "-", "1", ")", ".", "index_select", "(", "0", ",", "sample_ind", ")", ")", "\n", "", "", "else", ":", "\n", "                    ", "it", "=", "seq", "[", ":", ",", "i", "-", "1", "]", ".", "clone", "(", ")", "\n", "# break if all the sequences end", "\n", "", "if", "i", ">=", "2", "and", "seq", "[", ":", ",", "i", "-", "1", "]", ".", "sum", "(", ")", "==", "0", ":", "\n", "                    ", "break", "\n", "", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "state", ")", "\n", "output", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "output", ")", ",", "dim", "=", "1", ")", "\n", "outputs", ".", "append", "(", "output", ")", "\n", "\n", "", "return", "torch", ".", "cat", "(", "[", "_", ".", "unsqueeze", "(", "1", ")", "for", "_", "in", "outputs", "[", "1", ":", "]", "]", ",", "1", ")", ".", "contiguous", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.get_logprobs_state": [[113, 121], ["FCModel.FCModel.embed", "FCModel.FCModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "FCModel.FCModel.logit"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core"], ["", "def", "get_logprobs_state", "(", "self", ",", "it", ",", "state", ")", ":", "\n", "# 'it' is contains a word index", "\n", "        ", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "state", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "output", ")", ",", "dim", "=", "1", ")", "\n", "\n", "return", "logprobs", ",", "state", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel._sample_beam": [[122, 149], ["opt.get", "fc_feats.size", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.LongTensor().zero_", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "torch.FloatTensor", "range", "FCModel.FCModel.init_hidden", "range", "FCModel.FCModel.beam_search", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.LongTensor().zero_.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.FloatTensor.transpose", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "torch.LongTensor", "range", "FCModel.FCModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "FCModel.FCModel.img_embed().expand", "FCModel.FCModel.logit", "fc_feats.data.new().long().zero_", "FCModel.FCModel.embed", "FCModel.FCModel.img_embed", "fc_feats.data.new().long", "fc_feats.data.new"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.beam_search", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed"], ["", "def", "_sample_beam", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "10", ")", "\n", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "\n", "assert", "beam_size", "<=", "self", ".", "vocab_size", "+", "1", ",", "'lets assume this for now, otherwise this corner case causes a few headaches down the road. can be dealt with in future if needed'", "\n", "seq", "=", "torch", ".", "LongTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", ".", "zero_", "(", ")", "\n", "seqLogprobs", "=", "torch", ".", "FloatTensor", "(", "self", ".", "seq_length", ",", "batch_size", ")", "\n", "# lets process every image independently for now, for simplicity", "\n", "\n", "self", ".", "done_beams", "=", "[", "[", "]", "for", "_", "in", "range", "(", "batch_size", ")", "]", "\n", "for", "k", "in", "range", "(", "batch_size", ")", ":", "\n", "            ", "state", "=", "self", ".", "init_hidden", "(", "beam_size", ")", "\n", "for", "t", "in", "range", "(", "2", ")", ":", "\n", "                ", "if", "t", "==", "0", ":", "\n", "                    ", "xt", "=", "self", ".", "img_embed", "(", "fc_feats", "[", "k", ":", "k", "+", "1", "]", ")", ".", "expand", "(", "beam_size", ",", "self", ".", "input_encoding_size", ")", "\n", "", "elif", "t", "==", "1", ":", "# input <bos>", "\n", "                    ", "it", "=", "fc_feats", ".", "data", ".", "new", "(", "beam_size", ")", ".", "long", "(", ")", ".", "zero_", "(", ")", "\n", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "state", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "output", ")", ",", "dim", "=", "1", ")", "\n", "\n", "", "self", ".", "done_beams", "[", "k", "]", "=", "self", ".", "beam_search", "(", "state", ",", "logprobs", ",", "opt", "=", "opt", ")", "\n", "seq", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'seq'", "]", "# the first beam has highest cumulative score", "\n", "seqLogprobs", "[", ":", ",", "k", "]", "=", "self", ".", "done_beams", "[", "k", "]", "[", "0", "]", "[", "'logps'", "]", "\n", "# return the samples and their log likelihoods", "\n", "", "return", "seq", ".", "transpose", "(", "0", ",", "1", ")", ",", "seqLogprobs", ".", "transpose", "(", "0", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel._sample": [[150, 201], ["opt.get", "opt.get", "opt.get", "fc_feats.size", "FCModel.FCModel.init_hidden", "fc_feats.new_zeros", "fc_feats.new_zeros", "range", "FCModel.FCModel._sample_beam", "FCModel.FCModel.core", "torch.log_softmax", "torch.log_softmax", "torch.log_softmax", "FCModel.FCModel.img_embed", "FCModel.FCModel.embed", "FCModel.FCModel.logit", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "torch.max", "fc_feats.data.new().long().zero_.view().long", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.multinomial().cuda", "torch.log_softmax.gather", "fc_feats.data.new().long().zero_.view().long", "F.log_softmax.gather.view", "fc_feats.data.new().long().zero_", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "torch.exp().cpu", "unfinished.type_as", "unfinished.sum", "fc_feats.data.new().long().zero_.view", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "torch.multinomial", "fc_feats.data.new().long().zero_.view", "fc_feats.data.new().long", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.exp", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "torch.div", "fc_feats.data.new"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel.init_hidden", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.FCModel.FCModel._sample_beam", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.core", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.AttEnsemble.AttEnsemble.embed"], ["", "def", "_sample", "(", "self", ",", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "None", ",", "opt", "=", "{", "}", ")", ":", "\n", "        ", "sample_max", "=", "opt", ".", "get", "(", "'sample_max'", ",", "1", ")", "\n", "beam_size", "=", "opt", ".", "get", "(", "'beam_size'", ",", "1", ")", "\n", "temperature", "=", "opt", ".", "get", "(", "'temperature'", ",", "1.0", ")", "\n", "if", "beam_size", ">", "1", ":", "\n", "            ", "return", "self", ".", "_sample_beam", "(", "fc_feats", ",", "att_feats", ",", "opt", ")", "\n", "\n", "", "batch_size", "=", "fc_feats", ".", "size", "(", "0", ")", "\n", "state", "=", "self", ".", "init_hidden", "(", "batch_size", ")", "\n", "seq", "=", "fc_feats", ".", "new_zeros", "(", "batch_size", ",", "self", ".", "seq_length", ",", "dtype", "=", "torch", ".", "long", ")", "\n", "seqLogprobs", "=", "fc_feats", ".", "new_zeros", "(", "batch_size", ",", "self", ".", "seq_length", ")", "\n", "for", "t", "in", "range", "(", "self", ".", "seq_length", "+", "2", ")", ":", "\n", "            ", "if", "t", "==", "0", ":", "\n", "                ", "xt", "=", "self", ".", "img_embed", "(", "fc_feats", ")", "\n", "", "else", ":", "\n", "                ", "if", "t", "==", "1", ":", "# input <bos>", "\n", "                    ", "it", "=", "fc_feats", ".", "data", ".", "new", "(", "batch_size", ")", ".", "long", "(", ")", ".", "zero_", "(", ")", "\n", "", "xt", "=", "self", ".", "embed", "(", "it", ")", "\n", "\n", "", "output", ",", "state", "=", "self", ".", "core", "(", "xt", ",", "state", ")", "\n", "logprobs", "=", "F", ".", "log_softmax", "(", "self", ".", "logit", "(", "output", ")", ",", "dim", "=", "1", ")", "\n", "\n", "# sample the next_word", "\n", "if", "t", "==", "self", ".", "seq_length", "+", "1", ":", "# skip if we achieve maximum length", "\n", "                ", "break", "\n", "", "if", "sample_max", ":", "\n", "                ", "sampleLogprobs", ",", "it", "=", "torch", ".", "max", "(", "logprobs", ".", "data", ",", "1", ")", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "\n", "", "else", ":", "\n", "                ", "if", "temperature", "==", "1.0", ":", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "logprobs", ".", "data", ")", ".", "cpu", "(", ")", "# fetch prev distribution: shape Nx(M+1)", "\n", "", "else", ":", "\n", "# scale logprobs by temperature", "\n", "                    ", "prob_prev", "=", "torch", ".", "exp", "(", "torch", ".", "div", "(", "logprobs", ".", "data", ",", "temperature", ")", ")", ".", "cpu", "(", ")", "\n", "", "it", "=", "torch", ".", "multinomial", "(", "prob_prev", ",", "1", ")", ".", "cuda", "(", ")", "\n", "sampleLogprobs", "=", "logprobs", ".", "gather", "(", "1", ",", "it", ")", "# gather the logprobs at sampled positions", "\n", "it", "=", "it", ".", "view", "(", "-", "1", ")", ".", "long", "(", ")", "# and flatten indices for downstream processing", "\n", "\n", "", "if", "t", ">=", "1", ":", "\n", "# stop when all finished", "\n", "                ", "if", "t", "==", "1", ":", "\n", "                    ", "unfinished", "=", "it", ">", "0", "\n", "", "else", ":", "\n", "                    ", "unfinished", "=", "unfinished", "*", "(", "it", ">", "0", ")", "\n", "", "it", "=", "it", "*", "unfinished", ".", "type_as", "(", "it", ")", "\n", "seq", "[", ":", ",", "t", "-", "1", "]", "=", "it", "#seq[t] the input of t+2 time step", "\n", "seqLogprobs", "[", ":", ",", "t", "-", "1", "]", "=", "sampleLogprobs", ".", "view", "(", "-", "1", ")", "\n", "if", "unfinished", ".", "sum", "(", ")", "==", "0", ":", "\n", "                    ", "break", "\n", "\n", "", "", "", "return", "seq", ",", "seqLogprobs", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.models.__init__.setup": [[19, 64], ["FCModel.FCModel", "vars().get", "os.path.isdir", "os.path.isfile", "RelationTransformerModel.RelationTransformerModel.load_state_dict", "ShowTellModel.ShowTellModel", "os.path.join", "torch.load", "AttModel.Att2inModel", "vars", "os.path.join", "AttModel.Att2in2Model", "AttModel.Att2all2Model", "AttModel.AdaAttModel", "AttModel.AdaAttMOModel", "AttModel.TopDownModel", "AttModel.StackAttModel", "AttModel.DenseAttModel", "TransformerModel.TransformerModel", "RelationTransformerModel.RelationTransformerModel", "Exception"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.dataloader.BlobFetcher.get", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["def", "setup", "(", "opt", ")", ":", "\n", "\n", "    ", "if", "opt", ".", "caption_model", "==", "'fc'", ":", "\n", "        ", "model", "=", "FCModel", "(", "opt", ")", "\n", "", "elif", "opt", ".", "caption_model", "==", "'show_tell'", ":", "\n", "        ", "model", "=", "ShowTellModel", "(", "opt", ")", "\n", "# Att2in model in self-critical", "\n", "", "elif", "opt", ".", "caption_model", "==", "'att2in'", ":", "\n", "        ", "model", "=", "Att2inModel", "(", "opt", ")", "\n", "# Att2in model with two-layer MLP img embedding and word embedding", "\n", "", "elif", "opt", ".", "caption_model", "==", "'att2in2'", ":", "\n", "        ", "model", "=", "Att2in2Model", "(", "opt", ")", "\n", "", "elif", "opt", ".", "caption_model", "==", "'att2all2'", ":", "\n", "        ", "model", "=", "Att2all2Model", "(", "opt", ")", "\n", "# Adaptive Attention model from Knowing when to look", "\n", "", "elif", "opt", ".", "caption_model", "==", "'adaatt'", ":", "\n", "        ", "model", "=", "AdaAttModel", "(", "opt", ")", "\n", "# Adaptive Attention with maxout lstm", "\n", "", "elif", "opt", ".", "caption_model", "==", "'adaattmo'", ":", "\n", "        ", "model", "=", "AdaAttMOModel", "(", "opt", ")", "\n", "# Top-down attention model", "\n", "", "elif", "opt", ".", "caption_model", "==", "'topdown'", ":", "\n", "        ", "model", "=", "TopDownModel", "(", "opt", ")", "\n", "# StackAtt", "\n", "", "elif", "opt", ".", "caption_model", "==", "'stackatt'", ":", "\n", "        ", "model", "=", "StackAttModel", "(", "opt", ")", "\n", "# DenseAtt", "\n", "", "elif", "opt", ".", "caption_model", "==", "'denseatt'", ":", "\n", "        ", "model", "=", "DenseAttModel", "(", "opt", ")", "\n", "# Transformer", "\n", "", "elif", "opt", ".", "caption_model", "==", "'transformer'", ":", "\n", "        ", "model", "=", "TransformerModel", "(", "opt", ")", "\n", "", "elif", "opt", ".", "caption_model", "==", "'relation_transformer'", ":", "\n", "        ", "model", "=", "RelationTransformerModel", "(", "opt", ")", "\n", "", "else", ":", "\n", "        ", "raise", "Exception", "(", "\"Caption model not supported: {}\"", ".", "format", "(", "opt", ".", "caption_model", ")", ")", "\n", "\n", "# check compatibility if training is continued from previously saved model", "\n", "", "if", "vars", "(", "opt", ")", ".", "get", "(", "'start_from'", ",", "None", ")", "is", "not", "None", ":", "\n", "# check if all necessary files exist", "\n", "        ", "assert", "os", ".", "path", ".", "isdir", "(", "opt", ".", "start_from", ")", ",", "\" %s must be a a path\"", "%", "opt", ".", "start_from", "\n", "assert", "os", ".", "path", ".", "isfile", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "start_from", ",", "\"infos_\"", "+", "opt", ".", "id", "+", "\".pkl\"", ")", ")", ",", "\"infos.pkl file does not exist in path %s\"", "%", "opt", ".", "start_from", "\n", "model", ".", "load_state_dict", "(", "torch", ".", "load", "(", "os", ".", "path", ".", "join", "(", "opt", ".", "start_from", ",", "'model.pth'", ")", ")", ")", "\n", "\n", "", "return", "model", "\n", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.correct_coco_eval_cap.CorrectCOCOEvalCap.setImgToEvalImgs": [[24, 30], ["pycocoevalcap.eval.COCOEvalCap.setImgToEvalImgs", "sorted"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.correct_coco_eval_cap.CorrectCOCOEvalCap.setImgToEvalImgs"], ["def", "setImgToEvalImgs", "(", "self", ",", "scores", ",", "imgIds", ",", "method", ")", ":", "\n", "        ", "if", "method", "==", "CorrectCOCOEvalCap", ".", "METHOD_SPICE", ":", "\n", "# The SPICE scores are actually ordered according the the sorted", "\n", "# imgIds, and not according the the original imgIds order.", "\n", "            ", "imgIds", "=", "sorted", "(", "imgIds", ")", "\n", "", "COCOEvalCap", ".", "setImgToEvalImgs", "(", "self", ",", "scores", ",", "imgIds", ",", "method", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.ReportConfig.__init__": [[143, 147], ["None"], "methods", ["None"], ["def", "__init__", "(", "self", ",", "out_dir", ")", ":", "\n", "# type: (str) -> None", "\n", "        ", "self", ".", "out_dir", "=", "out_dir", "\n", "self", ".", "histogram_bins", "=", "ReportConfig", ".", "HISTOGRAM_BINS_DICT", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.ReportData.__init__": [[151, 158], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "coco_eval", ",", "predictions", ",", "image_root", ",", "model_id", ",", "split", ")", ":", "\n", "# type (COCOEvalCap, List[Dict[str, Any]], str, str, str) -> None", "\n", "        ", "self", ".", "coco_eval", "=", "coco_eval", "\n", "self", ".", "predictions", "=", "predictions", "\n", "self", ".", "image_root", "=", "image_root", "\n", "self", ".", "model_id", "=", "model_id", "\n", "self", ".", "split", "=", "split", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.ReportData.save_to_pickle": [[159, 165], ["open", "six.moves.cPickle.dump"], "methods", ["None"], ["", "def", "save_to_pickle", "(", "self", ",", "pickle_path", ")", ":", "\n", "# type: (str) -> None", "\n", "        ", "\"\"\"Save ReportData into a pickle file so that we can create\n        visualizations for it later.\"\"\"", "\n", "with", "open", "(", "pickle_path", ",", "'wb'", ")", "as", "pickle_file", ":", "\n", "            ", "pickle", ".", "dump", "(", "self", ",", "pickle_file", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.ReportData.read_from_pickle": [[166, 174], ["open", "six.moves.cPickle.load"], "methods", ["None"], ["", "", "@", "staticmethod", "\n", "def", "read_from_pickle", "(", "pickle_path", ",", "model_id", "=", "None", ")", ":", "\n", "# type: (str, Optional[str]) -> ReportData", "\n", "        ", "with", "open", "(", "pickle_path", ",", "'rb'", ")", "as", "pickle_file", ":", "\n", "            ", "report_data", "=", "pickle", ".", "load", "(", "pickle_file", ")", "\n", "", "if", "model_id", ":", "\n", "            ", "report_data", ".", "model_id", "=", "model_id", "\n", "", "return", "report_data", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.__init__": [[180, 184], ["None"], "methods", ["None"], ["def", "__init__", "(", "self", ",", "regular", ",", "base_dir", ")", ":", "\n", "# type: (str, str) -> None", "\n", "        ", "self", ".", "regular", "=", "regular", "\n", "self", ".", "base_dir", "=", "base_dir", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.relative_to": [[185, 188], ["os.path.relpath"], "methods", ["None"], ["", "def", "relative_to", "(", "self", ",", "other_dir", ")", ":", "\n", "# type: (str) -> str", "\n", "        ", "return", "os", ".", "path", ".", "relpath", "(", "self", ".", "regular", ",", "other_dir", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.relative": [[189, 192], ["report.PathForHTML.relative_to"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.relative_to"], ["", "def", "relative", "(", "self", ")", ":", "\n", "# type: () -> str", "\n", "        ", "return", "self", ".", "relative_to", "(", "self", ".", "base_dir", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join": [[193, 196], ["report.PathForHTML", "os.path.join"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["", "def", "join", "(", "self", ",", "to_append", ")", ":", "\n", "# type: (str) -> PathForHTML", "\n", "        ", "return", "PathForHTML", "(", "os", ".", "path", ".", "join", "(", "self", ".", "regular", ",", "to_append", ")", ",", "self", ".", "base_dir", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.with_base_dir": [[197, 200], ["report.PathForHTML"], "methods", ["None"], ["", "def", "with_base_dir", "(", "self", ",", "base_dir", ")", ":", "\n", "# type: (str) -> PathForHTML", "\n", "        ", "return", "PathForHTML", "(", "self", ".", "regular", ",", "base_dir", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.OutputPaths.__init__": [[209, 224], ["os.path.join", "os.path.join", "os.makedirs", "os.makedirs", "os.makedirs", "os.path.join"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["def", "__init__", "(", "self", ",", "out_dir", ")", ":", "\n", "# type: (str) -> None", "\n", "# Set directories and then run makedirs to create them.", "\n", "        ", "self", ".", "out_dir", "=", "out_dir", "\n", "self", ".", "image_report_dir", "=", "os", ".", "path", ".", "join", "(", "\n", "self", ".", "out_dir", ",", "OutputPaths", ".", "IMAGE_REPORT_DIR_NAME", ")", "\n", "self", ".", "image_dir", "=", "os", ".", "path", ".", "join", "(", "self", ".", "out_dir", ",", "OutputPaths", ".", "IMAGE_DIR_NAME", ")", "\n", "# For now, just fail if the directory already exists, so we don't", "\n", "# overwrite anything accidentally.", "\n", "os", ".", "makedirs", "(", "self", ".", "out_dir", ")", "\n", "os", ".", "makedirs", "(", "self", ".", "image_report_dir", ")", "\n", "os", ".", "makedirs", "(", "self", ".", "image_dir", ")", "\n", "# Create some specific relevant paths", "\n", "self", ".", "report_index_path", "=", "os", ".", "path", ".", "join", "(", "self", ".", "out_dir", ",", "\n", "OutputPaths", ".", "INDEX_HTML", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.RunOutputPaths.__init__": [[230, 239], ["os.path.join", "os.path.join", "os.makedirs", "os.makedirs", "os.path.join"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["def", "__init__", "(", "self", ",", "output_paths", ",", "run_name", ")", ":", "\n", "# type: (OutputPaths, str) -> None", "\n", "        ", "self", ".", "output_paths", "=", "output_paths", "\n", "self", ".", "run_dir", "=", "os", ".", "path", ".", "join", "(", "self", ".", "output_paths", ".", "out_dir", ",", "run_name", ")", "\n", "self", ".", "plot_dir", "=", "os", ".", "path", ".", "join", "(", "self", ".", "run_dir", ",", "\n", "RunOutputPaths", ".", "PLOT_DIR_NAME", ")", "\n", "os", ".", "makedirs", "(", "self", ".", "run_dir", ")", "\n", "os", ".", "makedirs", "(", "self", ".", "plot_dir", ")", "\n", "self", ".", "index_path", "=", "os", ".", "path", ".", "join", "(", "self", ".", "run_dir", ",", "OutputPaths", ".", "INDEX_HTML", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.RunOutputPaths.histogram_image_path": [[240, 244], ["os.path.join"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["", "def", "histogram_image_path", "(", "self", ",", "column_name", ")", ":", "\n", "# type: (str) -> str", "\n", "        ", "histogram_file_name", "=", "column_name", "+", "OutputPaths", ".", "IMAGE_EXTENSION", "\n", "return", "os", ".", "path", ".", "join", "(", "self", ".", "plot_dir", ",", "histogram_file_name", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.RunOutputPaths.metric_path": [[245, 249], ["os.path.join"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["", "def", "metric_path", "(", "self", ",", "column_name", ")", ":", "\n", "# type: (str) -> str", "\n", "        ", "metric_file_name", "=", "column_name", "+", "'.html'", "\n", "return", "os", ".", "path", ".", "join", "(", "self", ".", "run_dir", ",", "metric_file_name", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.MetricData.__init__": [[253, 260], ["series.sort_values"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "data_frame", ",", "column_name", ",", "bins", ")", ":", "\n", "# type: (DataFrame, str, numpy.ndarray) -> None", "\n", "        ", "self", ".", "data_frame", "=", "data_frame", "\n", "self", ".", "column_name", "=", "column_name", "\n", "self", ".", "bins", "=", "bins", "\n", "series", "=", "self", ".", "data_frame", "[", "column_name", "]", "\n", "self", ".", "sorted_series", "=", "series", ".", "sort_values", "(", ")", "# type: Series", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.create_report": [[262, 287], ["report.OutputPaths", "report._create_main_data_frame", "report._create_image_reports", "open", "report._add_all_runs_table", "report._add_all_run_pairs_metric_pages", "report._add_single_run_metric_pages", "report._add_unlabeled_images"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_main_data_frame", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_image_reports", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_all_runs_table", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_all_run_pairs_metric_pages", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_single_run_metric_pages", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_unlabeled_images"], ["", "", "def", "create_report", "(", "report_data_list", ",", "report_config", ")", ":", "\n", "# type: (List[ReportData], ReportConfig) -> None", "\n", "    ", "\"\"\"Create a report from the coco_eval object, storing it in out_dir.\n\n    The report will consist of a series of HTML pages, images, and maybe\n    other files. If out_dir already  exists, this function will throw an\n    exception.\n\n    :param coco_eval: An evaluation object from which the report will be\n    generated\n    :param report_config: See ReportConfig; includes the path of the output\n    directory that will be created\n    :return: None\n    \"\"\"", "\n", "output_paths", "=", "OutputPaths", "(", "report_config", ".", "out_dir", ")", "\n", "data_frame", "=", "_create_main_data_frame", "(", "report_data_list", ")", "\n", "with", "open", "(", "output_paths", ".", "report_index_path", ",", "'w'", ")", "as", "report_index_file", ":", "\n", "        ", "_add_all_runs_table", "(", "report_index_file", ",", "data_frame", ",", "report_data_list", ")", "\n", "_add_all_run_pairs_metric_pages", "(", "\n", "report_index_file", ",", "output_paths", ",", "data_frame", ",", "report_data_list", ")", "\n", "_add_single_run_metric_pages", "(", "\n", "report_index_file", ",", "output_paths", ",", "report_config", ",", "data_frame", ",", "\n", "report_data_list", ")", "\n", "_add_unlabeled_images", "(", "report_index_file", ",", "output_paths", ".", "image_dir", ")", "\n", "", "_create_image_reports", "(", "output_paths", ",", "data_frame", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_all_run_pairs_metric_pages": [[289, 306], ["report._write_header", "len", "report.RunOutputPaths", "report._add_run_pair_metric_page"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_run_pair_metric_page"], ["", "def", "_add_all_run_pairs_metric_pages", "(", "\n", "report_index_file", ",", "output_paths", ",", "data_frame", ",", "report_data_list", ")", ":", "\n", "# type: (IO, OutputPaths, DataFrame, List[ReportData]) -> None", "\n", "    ", "_write_header", "(", "report_index_file", ",", "'Comparison of pairs of runs'", ")", "\n", "run_names", "=", "data_frame", ".", "columns", ".", "levels", "[", "0", "]", "\n", "if", "len", "(", "run_names", ")", "<", "2", ":", "\n", "        ", "return", "\n", "# Only handle comparison of the first two methods for now.", "\n", "", "all_pair_indexes", "=", "[", "[", "0", ",", "1", "]", "]", "\n", "for", "pair_indexes", "in", "all_pair_indexes", ":", "\n", "        ", "pair_names", "=", "run_names", "[", "pair_indexes", "]", "\n", "pair_name", "=", "'_VS_'", ".", "join", "(", "pair_names", ")", "\n", "pair_output_paths", "=", "RunOutputPaths", "(", "output_paths", ",", "pair_name", ")", "\n", "pair_report_data_list", "=", "[", "report_data_list", "[", "i", "]", "for", "i", "in", "pair_indexes", "]", "\n", "_add_run_pair_metric_page", "(", "\n", "report_index_file", ",", "pair_output_paths", ",", "pair_name", ",", "\n", "data_frame", "[", "pair_names", "]", ",", "pair_report_data_list", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_single_run_metric_pages": [[308, 318], ["report._write_header", "zip", "report.RunOutputPaths", "report._add_single_run_metric_page"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_single_run_metric_page"], ["", "", "def", "_add_single_run_metric_pages", "(", "report_index_file", ",", "output_paths", ",", "report_config", ",", "\n", "data_frame", ",", "report_data_list", ")", ":", "\n", "# type: (IO, OutputPaths, ReportConfig, DataFrame, List[ReportData]) -> None", "\n", "    ", "_write_header", "(", "report_index_file", ",", "'Reports per run'", ")", "\n", "run_names", "=", "data_frame", ".", "columns", ".", "levels", "[", "0", "]", "\n", "for", "run_name", ",", "report_data", "in", "zip", "(", "run_names", ",", "report_data_list", ")", ":", "\n", "        ", "run_output_paths", "=", "RunOutputPaths", "(", "output_paths", ",", "run_name", ")", "\n", "_add_single_run_metric_page", "(", "\n", "report_index_file", ",", "run_output_paths", ",", "report_config", ",", "run_name", ",", "\n", "data_frame", "[", "run_name", "]", ",", "report_data", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_run_pair_metric_page": [[320, 334], ["report_index_file.write", "open", "report._write_header", "report._add_run_pair_table", "report._add_run_pair_metric_pages", "os.path.relpath"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_run_pair_table", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_run_pair_metric_pages"], ["", "", "def", "_add_run_pair_metric_page", "(", "\n", "report_index_file", ",", "pair_output_paths", ",", "pair_name", ",", "pair_data_frame", ",", "\n", "pair_report_data_list", ")", ":", "\n", "# type: (IO, RunOutputPaths, str, DataFrame, List[ReportData]) -> None", "\n", "    ", "pair_index_path", "=", "pair_output_paths", ".", "index_path", "\n", "out_dir", "=", "pair_output_paths", ".", "output_paths", ".", "out_dir", "\n", "report_index_file", ".", "write", "(", "'<a href=\"%s\">%s</a><br>\\n'", "%", "(", "\n", "os", ".", "path", ".", "relpath", "(", "pair_index_path", ",", "out_dir", ")", ",", "pair_name", ")", ")", "\n", "with", "open", "(", "pair_index_path", ",", "'w'", ")", "as", "pair_index_file", ":", "\n", "        ", "_write_header", "(", "pair_index_file", ",", "pair_name", ")", "\n", "_add_run_pair_table", "(", "pair_index_file", ",", "pair_data_frame", ",", "\n", "pair_report_data_list", ")", "\n", "_add_run_pair_metric_pages", "(", "pair_index_file", ",", "pair_output_paths", ",", "\n", "pair_data_frame", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_run_pair_metric_pages": [[336, 351], ["report._write_header", "report._write_header", "report._create_difference_metric_data", "report._add_metric_page", "report._create_difference_metric_data", "report._add_metric_page"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_difference_metric_data", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_metric_page", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_difference_metric_data", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_metric_page"], ["", "", "def", "_add_run_pair_metric_pages", "(", "html_file", ",", "pair_output_paths", ",", "pair_data_frame", ")", ":", "\n", "# type: (IO, RunOutputPaths, DataFrame) -> None", "\n", "    ", "_write_header", "(", "html_file", ",", "'Distribution of metric differences (except '", "\n", "'SPICE-related, which come later below)'", ")", "\n", "run_names", "=", "pair_data_frame", ".", "columns", ".", "levels", "[", "0", "]", "\n", "for", "column_name", "in", "COLUMNS_FOR_HISTOGRAM_NON_SPICE", ":", "\n", "        ", "metric_data", "=", "_create_difference_metric_data", "(", "\n", "run_names", ",", "column_name", ",", "pair_data_frame", ")", "\n", "_add_metric_page", "(", "html_file", ",", "pair_output_paths", ",", "metric_data", ")", "\n", "", "_write_header", "(", "html_file", ",", "'Distribution of SPICE-related metric '", "\n", "'differences'", ")", "\n", "for", "column_name", "in", "COLUMNS_FOR_HISTOGRAM_SPICE", ":", "\n", "        ", "metric_data", "=", "_create_difference_metric_data", "(", "\n", "run_names", ",", "column_name", ",", "pair_data_frame", ")", "\n", "_add_metric_page", "(", "html_file", ",", "pair_output_paths", ",", "metric_data", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_difference_metric_data": [[353, 369], ["difference_series.to_frame", "difference_series.to_frame.dropna", "difference_data_frame.dropna.count().item", "report._n_bins_from_count", "numpy.histogram", "report.MetricData", "difference_data_frame.dropna.count"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._n_bins_from_count"], ["", "", "def", "_create_difference_metric_data", "(", "run_names", ",", "column_name", ",", "pair_data_frame", ")", ":", "\n", "# type: (List[str], str, DataFrame) -> MetricData", "\n", "    ", "first_run_name", "=", "run_names", "[", "0", "]", "\n", "second_run_name", "=", "run_names", "[", "1", "]", "\n", "difference_name", "=", "'%s_minus_%s'", "%", "(", "first_run_name", ",", "second_run_name", ")", "\n", "difference_column_name", "=", "'%s_%s'", "%", "(", "column_name", ",", "difference_name", ")", "\n", "difference_series", "=", "(", "\n", "pair_data_frame", "[", "first_run_name", "]", "[", "column_name", "]", "-", "\n", "pair_data_frame", "[", "second_run_name", "]", "[", "column_name", "]", ")", "\n", "difference_data_frame", "=", "difference_series", ".", "to_frame", "(", "\n", "difference_column_name", ")", "# type: DataFrame", "\n", "valid_difference_data_frame", "=", "difference_data_frame", ".", "dropna", "(", ")", "\n", "valid_count", "=", "valid_difference_data_frame", ".", "count", "(", ")", ".", "item", "(", ")", "\n", "n_bins", "=", "_n_bins_from_count", "(", "valid_count", ")", "\n", "_", ",", "bins", "=", "numpy", ".", "histogram", "(", "valid_difference_data_frame", ",", "bins", "=", "n_bins", ")", "\n", "return", "MetricData", "(", "difference_data_frame", ",", "difference_column_name", ",", "bins", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._n_bins_from_count": [[371, 378], ["None"], "function", ["None"], ["", "def", "_n_bins_from_count", "(", "count", ")", ":", "\n", "# type: (int) -> int", "\n", "    ", "if", "count", "<", "50", ":", "\n", "        ", "return", "10", "\n", "", "if", "count", "<", "500", ":", "\n", "        ", "return", "20", "\n", "", "return", "30", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_run_pair_table": [[380, 388], ["report._write_header", "report._create_run_pair_summary", "html_file.write", "_create_run_pair_summary.to_html"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_run_pair_summary"], ["", "def", "_add_run_pair_table", "(", "html_file", ",", "pair_data_frame", ",", "pair_report_data_list", ")", ":", "\n", "# type: (IO, DataFrame, List[ReportData]) -> None", "\n", "    ", "\"\"\"Write overall measures from a pair of runs into a table.\"\"\"", "\n", "_write_header", "(", "html_file", ",", "'Measures over all images'", ")", "\n", "run_pair_summary", "=", "_create_run_pair_summary", "(", "\n", "pair_report_data_list", ",", "pair_data_frame", ")", "\n", "html_file", ".", "write", "(", "\n", "run_pair_summary", ".", "to_html", "(", "float_format", "=", "_table_float_format", ")", "+", "'\\n'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_run_pair_summary": [[390, 422], ["pandas.Series().to_frame", "pandas.Series().to_frame", "pandas.Series().to_frame", "pandas.concat", "report._create_single_run_summary", "[].mean().to_frame", "scipy.stats.ttest_rel", "report._count_paired_sample_size", "zip", "t_test_results.items", "t_test_results.items", "pandas.Series", "pandas.Series", "pandas.Series", "[].mean"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_single_run_summary", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._count_paired_sample_size"], ["", "def", "_create_run_pair_summary", "(", "pair_report_data_list", ",", "pair_data_frame", ")", ":", "\n", "# type(List[ReportData], str, DataFrame) -> DataFrame", "\n", "    ", "run_names", "=", "pair_data_frame", ".", "columns", ".", "levels", "[", "0", "]", "\n", "run_summaries", "=", "[", "\n", "_create_single_run_summary", "(", "\n", "report_data", ",", "run_name", ",", "pair_data_frame", "[", "run_name", "]", ")", "\n", "for", "(", "run_name", ",", "report_data", ")", "in", "zip", "(", "run_names", ",", "pair_report_data_list", ")", "]", "\n", "mean_summaries", "=", "[", "\n", "pair_data_frame", "[", "run_name", "]", "[", "ALL_SUMMARY_COLUMNS", "]", ".", "mean", "(", ")", ".", "to_frame", "(", "\n", "run_name", "+", "'.means'", ")", "for", "run_name", "in", "run_names", "]", "\n", "t_test_results", "=", "{", "column", ":", "ttest_rel", "(", "\n", "pair_data_frame", "[", "run_names", "[", "0", "]", "]", "[", "column", "]", ",", "\n", "pair_data_frame", "[", "run_names", "[", "1", "]", "]", "[", "column", "]", ",", "nan_policy", "=", "'omit'", ")", "\n", "for", "column", "in", "ALL_SUMMARY_COLUMNS", "}", "\n", "sample_size", "=", "{", "column", ":", "_count_paired_sample_size", "(", "\n", "pair_data_frame", "[", "run_names", "[", "0", "]", "]", "[", "column", "]", ",", "\n", "pair_data_frame", "[", "run_names", "[", "1", "]", "]", "[", "column", "]", ")", "\n", "for", "column", "in", "ALL_SUMMARY_COLUMNS", "}", "\n", "t_statistics", "=", "{", "\n", "column", ":", "statistic_and_p_value", "[", "0", "]", "for", "column", ",", "statistic_and_p_value", "in", "\n", "t_test_results", ".", "items", "(", ")", "}", "\n", "p_values", "=", "{", "\n", "column", ":", "statistic_and_p_value", "[", "1", "]", "for", "column", ",", "statistic_and_p_value", "in", "\n", "t_test_results", ".", "items", "(", ")", "}", "\n", "t_statistic_data_frame", "=", "Series", "(", "t_statistics", ")", ".", "to_frame", "(", "\n", "'t-test statistic (two-tailed)'", ")", "\n", "p_value_data_frame", "=", "Series", "(", "p_values", ")", ".", "to_frame", "(", "'p-value (two-tailed)'", ")", "\n", "sample_size_data_frame", "=", "Series", "(", "sample_size", ")", ".", "to_frame", "(", "\n", "'t-test sample size'", ")", "\n", "return", "concat", "(", "run_summaries", "+", "mean_summaries", "+", "[", "\n", "t_statistic_data_frame", ",", "p_value_data_frame", ",", "\n", "sample_size_data_frame", "]", ",", "axis", "=", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._count_paired_sample_size": [[424, 428], ["sum", "zip", "numpy.isfinite", "numpy.isfinite"], "function", ["None"], ["", "def", "_count_paired_sample_size", "(", "first", ",", "second", ")", ":", "\n", "# type: (Iterable[float], Iterable[float]) -> int", "\n", "    ", "return", "sum", "(", "1", "for", "f", ",", "s", "in", "zip", "(", "first", ",", "second", ")", "if", "(", "\n", "numpy", ".", "isfinite", "(", "f", ")", "and", "numpy", ".", "isfinite", "(", "s", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_single_run_metric_page": [[430, 444], ["report_index_file.write", "open", "report._write_header", "report._add_single_run_table", "report._add_metric_pages", "os.path.relpath"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_single_run_table", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_metric_pages"], ["", "def", "_add_single_run_metric_page", "(", "\n", "report_index_file", ",", "run_output_paths", ",", "report_config", ",", "run_name", ",", "\n", "single_run_data_frame", ",", "report_data", ")", ":", "\n", "# type: (IO, RunOutputPaths, ReportConfig, str, DataFrame, ReportData) -> None", "\n", "    ", "run_index_path", "=", "run_output_paths", ".", "index_path", "\n", "out_dir", "=", "run_output_paths", ".", "output_paths", ".", "out_dir", "\n", "report_index_file", ".", "write", "(", "'<a href=\"%s\">%s</a><br>\\n'", "%", "(", "\n", "os", ".", "path", ".", "relpath", "(", "run_index_path", ",", "out_dir", ")", ",", "run_name", ")", ")", "\n", "with", "open", "(", "run_index_path", ",", "'w'", ")", "as", "run_index_file", ":", "\n", "        ", "_write_header", "(", "run_index_file", ",", "run_name", ")", "\n", "_add_single_run_table", "(", "run_index_file", ",", "run_name", ",", "\n", "single_run_data_frame", ",", "report_data", ")", "\n", "_add_metric_pages", "(", "run_index_file", ",", "run_output_paths", ",", "report_config", ",", "\n", "single_run_data_frame", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_single_run_table": [[446, 454], ["report._write_header", "report._create_single_run_summary", "html_file.write", "_create_single_run_summary.to_html"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_single_run_summary"], ["", "", "def", "_add_single_run_table", "(", "\n", "html_file", ",", "run_name", ",", "single_run_data_frame", ",", "report_data", ")", ":", "\n", "# type: (IO, str, DataFrame, ReportData) -> None", "\n", "    ", "\"\"\"Write measures from a single run into a table.\"\"\"", "\n", "_write_header", "(", "html_file", ",", "'Measures over all images'", ")", "\n", "single_run_summary", "=", "_create_single_run_summary", "(", "\n", "report_data", ",", "run_name", ",", "single_run_data_frame", ")", "\n", "html_file", ".", "write", "(", "single_run_summary", ".", "to_html", "(", ")", "+", "'\\n'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_main_data_frame": [[456, 464], ["pandas.concat", "report._create_run_data_frame"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_run_data_frame"], ["", "def", "_create_main_data_frame", "(", "report_data_list", ")", ":", "\n", "# type: (List[ReportData]) -> DataFrame", "\n", "    ", "data_frames", "=", "[", "_create_run_data_frame", "(", "report_data", ")", "for", "report_data", "in", "\n", "report_data_list", "]", "\n", "run_names", "=", "[", "'%s_%s'", "%", "(", "report_data", ".", "model_id", ",", "report_data", ".", "split", ")", "for", "\n", "report_data", "in", "report_data_list", "]", "\n", "data_frame", "=", "concat", "(", "data_frames", ",", "keys", "=", "run_names", ",", "axis", "=", "1", ")", "\n", "return", "data_frame", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_run_data_frame": [[466, 486], ["pandas.io.json.json_normalize", "data_frame[].map", "data_frame[].map", "data_frame[].map", "pandas.io.json.json_normalize.set_index", "coco_eval.imgToEval.values", "report._ground_truth_captions", "os.path.join", "coco_eval.cocoRes.imgToAnns.items", "coco_eval.coco.imgToAnns.items"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._ground_truth_captions", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["", "def", "_create_run_data_frame", "(", "report_data", ")", ":", "\n", "# type: (ReportData) -> DataFrame", "\n", "    ", "coco_eval", "=", "report_data", ".", "coco_eval", "\n", "data_frame", "=", "json_normalize", "(", "coco_eval", ".", "imgToEval", ".", "values", "(", ")", ")", "\n", "result", "=", "{", "image_id", ":", "annotation", "[", "0", "]", "[", "RESULT_KEY_CAPTION", "]", "for", "\n", "(", "image_id", ",", "annotation", ")", "in", "coco_eval", ".", "cocoRes", ".", "imgToAnns", ".", "items", "(", ")", "}", "\n", "ground_truth", "=", "{", "image_id", ":", "_ground_truth_captions", "(", "annotations", ")", "\n", "for", "(", "image_id", ",", "annotations", ")", "in", "\n", "coco_eval", ".", "coco", ".", "imgToAnns", ".", "items", "(", ")", "}", "\n", "data_frame", "[", "EvalColumns", ".", "RESULT_CAPTION", "]", "=", "data_frame", "[", "\n", "EvalColumns", ".", "IMAGE_ID", "]", ".", "map", "(", "result", ")", "\n", "data_frame", "[", "EvalColumns", ".", "GROUND_TRUTH_CAPTIONS", "]", "=", "data_frame", "[", "\n", "EvalColumns", ".", "IMAGE_ID", "]", ".", "map", "(", "ground_truth", ")", "\n", "image_paths", "=", "{", "prediction", "[", "PREDICTION_KEY_IMAGE_ID", "]", ":", "os", ".", "path", ".", "join", "(", "\n", "report_data", ".", "image_root", ",", "prediction", "[", "PREDICTION_KEY_FILE_PATH", "]", ")", "\n", "for", "prediction", "in", "report_data", ".", "predictions", "}", "\n", "data_frame", "[", "EvalColumns", ".", "PATH", "]", "=", "data_frame", "[", "EvalColumns", ".", "IMAGE_ID", "]", ".", "map", "(", "\n", "image_paths", ")", "\n", "data_frame", ".", "set_index", "(", "INDEX_COLUMN_NAME", ",", "inplace", "=", "True", ")", "\n", "return", "data_frame", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._ground_truth_captions": [[488, 491], ["None"], "function", ["None"], ["", "def", "_ground_truth_captions", "(", "annotations", ")", ":", "\n", "# type (List[Dict]) -> List[str]", "\n", "    ", "return", "[", "annotation", "[", "GROUND_TRUTH_KEY_CAPTION", "]", "for", "annotation", "in", "annotations", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_image_reports": [[493, 498], ["data_frame.loc[].unstack", "report._create_image_report"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_image_report"], ["", "def", "_create_image_reports", "(", "output_paths", ",", "data_frame", ")", ":", "\n", "# type: (OutputPaths, DataFrame) -> None", "\n", "    ", "for", "image_id", "in", "data_frame", ".", "index", ":", "\n", "        ", "image_data_frame", "=", "data_frame", ".", "loc", "[", "image_id", "]", ".", "unstack", "(", "level", "=", "0", ")", "\n", "_create_image_report", "(", "output_paths", ",", "image_data_frame", ",", "image_id", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_image_report": [[500, 525], ["report._image_report_path", "str", "open", "report.PathForHTML", "report._copy_and_write_image", "report._write_header", "report._write_header", "report._write_header", "image_report_file.write", "image_report_file.write", "image_report_file.write", "image_report_file.write", "image_report_file.write", "image_data_frame.to_html"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._image_report_path", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._copy_and_write_image", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header"], ["", "", "def", "_create_image_report", "(", "output_paths", ",", "image_data_frame", ",", "image_id", ")", ":", "\n", "# type: (OutputPaths, DataFrame, int) -> None", "\n", "    ", "image_report_path", "=", "_image_report_path", "(", "\n", "output_paths", ".", "image_report_dir", ",", "str", "(", "image_id", ")", ")", "\n", "with", "open", "(", "image_report_path", ",", "'w'", ")", "as", "image_report_file", ":", "\n", "        ", "image_dir_for_html", "=", "PathForHTML", "(", "output_paths", ".", "image_dir", ",", "\n", "output_paths", ".", "image_report_dir", ")", "\n", "run_names", "=", "image_data_frame", ".", "columns", "\n", "first_run_name", "=", "run_names", "[", "0", "]", "\n", "original_path", "=", "image_data_frame", "[", "first_run_name", "]", "[", "EvalColumns", ".", "PATH", "]", "\n", "_copy_and_write_image", "(", "\n", "image_report_file", ",", "image_dir_for_html", ",", "original_path", ",", "image_id", ")", "\n", "_write_header", "(", "image_report_file", ",", "'Generated caption(s)'", ")", "\n", "for", "run_name", "in", "run_names", ":", "\n", "            ", "image_report_file", ".", "write", "(", "'<b>%s</b>: '", "%", "run_name", ")", "\n", "image_report_file", ".", "write", "(", "\n", "image_data_frame", "[", "run_name", "]", "[", "EvalColumns", ".", "RESULT_CAPTION", "]", ")", "\n", "image_report_file", ".", "write", "(", "'<br>\\n'", ")", "\n", "", "_write_header", "(", "image_report_file", ",", "'Ground truth captions'", ")", "\n", "for", "ground_truth_caption", "in", "image_data_frame", "[", "first_run_name", "]", "[", "\n", "EvalColumns", ".", "GROUND_TRUTH_CAPTIONS", "]", ":", "\n", "            ", "image_report_file", ".", "write", "(", "ground_truth_caption", "+", "'<br>\\n'", ")", "\n", "", "_write_header", "(", "image_report_file", ",", "'Metrics'", ")", "\n", "image_report_file", ".", "write", "(", "\n", "image_data_frame", ".", "to_html", "(", "float_format", "=", "_table_float_format", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._copy_and_write_image": [[527, 537], ["image_dir_for_html.join", "shutil.copyfile", "image_dir_for_html.join.relative", "report._write_html_image", "os.path.splitext", "str"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.relative", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_html_image"], ["", "", "def", "_copy_and_write_image", "(", "image_report_file", ",", "image_dir_for_html", ",", "\n", "original_path", ",", "image_id", ")", ":", "\n", "# type: (IO, PathForHTML, str, int) -> None", "\n", "    ", "image_extension", "=", "os", ".", "path", ".", "splitext", "(", "original_path", ")", "[", "1", "]", "\n", "image_file_name", "=", "str", "(", "image_id", ")", "+", "image_extension", "\n", "image_path_for_html", "=", "image_dir_for_html", ".", "join", "(", "image_file_name", ")", "\n", "shutil", ".", "copyfile", "(", "original_path", ",", "image_path_for_html", ".", "regular", ")", "\n", "image_relative_path", "=", "image_path_for_html", ".", "relative", "(", ")", "\n", "_write_html_image", "(", "image_report_file", ",", "image_relative_path", ",", "\n", "image_relative_path", ",", "align", "=", "HTML_IMAGE_ALIGN_LEFT", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_all_runs_table": [[539, 551], ["report._write_header", "pandas.concat", "html_file.write", "report._create_single_run_summary", "zip", "pandas.concat.to_html"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_single_run_summary"], ["", "def", "_add_all_runs_table", "(", "html_file", ",", "data_frame", ",", "report_data_list", ")", ":", "\n", "# type: (IO, DataFrame, List[ReportData]) -> None", "\n", "    ", "\"\"\"Write overall measures into a table.\"\"\"", "\n", "_write_header", "(", "html_file", ",", "'Measures over all images'", ")", "\n", "run_names", "=", "data_frame", ".", "columns", ".", "levels", "[", "0", "]", "\n", "summary_list", "=", "[", "\n", "_create_single_run_summary", "(", "\n", "report_data", ",", "run_name", ",", "data_frame", "[", "run_name", "]", ")", "\n", "for", "(", "report_data", ",", "run_name", ")", "in", "zip", "(", "report_data_list", ",", "run_names", ")", "]", "\n", "summary_data_frame", "=", "concat", "(", "summary_list", ",", "axis", "=", "1", ")", "\n", "html_file", ".", "write", "(", "\n", "summary_data_frame", ".", "to_html", "(", "float_format", "=", "_table_float_format", ")", "+", "'\\n'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_single_run_summary": [[553, 559], ["single_run_data_frame[].mean", "pandas.Series().rename().append().to_frame", "pandas.Series().rename().append", "pandas.Series().rename", "pandas.Series"], "function", ["None"], ["", "def", "_create_single_run_summary", "(", "report_data", ",", "run_name", ",", "single_run_data_frame", ")", ":", "\n", "# type(ReportData, str, DataFrame) -> DataFrame", "\n", "    ", "extra_means", "=", "single_run_data_frame", "[", "EXTRA_SUMMARY_COLUMNS", "]", ".", "mean", "(", ")", "\n", "return", "Series", "(", "report_data", ".", "coco_eval", ".", "eval", ")", ".", "rename", "(", "\n", "index", "=", "{", "COCO_EVAL_SPICE_COLUMN", ":", "EvalColumns", ".", "SPICE", "}", ")", ".", "append", "(", "\n", "extra_means", ")", ".", "to_frame", "(", "run_name", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_metric_pages": [[561, 574], ["report._write_header", "report._write_header", "report.MetricData", "report._add_metric_page", "report.MetricData", "report._add_metric_page"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_metric_page", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_metric_page"], ["", "def", "_add_metric_pages", "(", "html_file", ",", "run_output_paths", ",", "report_config", ",", "data_frame", ")", ":", "\n", "# type: (IO, RunOutputPaths, ReportConfig, DataFrame) -> None", "\n", "    ", "_write_header", "(", "html_file", ",", "'Distribution of different measures (except '", "\n", "'SPICE-related, which come later below)'", ")", "\n", "for", "column_name", "in", "COLUMNS_FOR_HISTOGRAM_NON_SPICE", ":", "\n", "        ", "bins", "=", "report_config", ".", "histogram_bins", "[", "column_name", "]", "\n", "metric_data", "=", "MetricData", "(", "data_frame", ",", "column_name", ",", "bins", ")", "\n", "_add_metric_page", "(", "html_file", ",", "run_output_paths", ",", "metric_data", ")", "\n", "", "_write_header", "(", "html_file", ",", "'Distribution of SPICE-related measures'", ")", "\n", "for", "column_name", "in", "COLUMNS_FOR_HISTOGRAM_SPICE", ":", "\n", "        ", "bins", "=", "report_config", ".", "histogram_bins", "[", "column_name", "]", "\n", "metric_data", "=", "MetricData", "(", "data_frame", ",", "column_name", ",", "bins", ")", "\n", "_add_metric_page", "(", "html_file", ",", "run_output_paths", ",", "metric_data", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_metric_page": [[576, 593], ["report._plot_histogram", "run_output_paths.histogram_image_path", "_plot_histogram.savefig", "matplotlib.close", "run_output_paths.metric_path", "os.path.relpath", "os.path.relpath", "report._write_html_image", "os.path.relpath", "report._create_metric_html"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._plot_histogram", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.RunOutputPaths.histogram_image_path", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.RunOutputPaths.metric_path", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_html_image", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_metric_html"], ["", "", "def", "_add_metric_page", "(", "html_file", ",", "run_output_paths", ",", "metric_data", ")", ":", "\n", "# type: (IO, RunOutputPaths, MetricData) -> None", "\n", "    ", "figure", "=", "_plot_histogram", "(", "metric_data", ".", "data_frame", ",", "metric_data", ".", "bins", ",", "\n", "metric_data", ".", "column_name", ")", "\n", "image_path", "=", "run_output_paths", ".", "histogram_image_path", "(", "metric_data", ".", "column_name", ")", "\n", "figure", ".", "savefig", "(", "image_path", ")", "\n", "# Close the figure so that matplotlib doesn't complain about memory.", "\n", "plt", ".", "close", "(", "figure", ")", "\n", "metric_path", "=", "run_output_paths", ".", "metric_path", "(", "metric_data", ".", "column_name", ")", "\n", "run_dir", "=", "run_output_paths", ".", "run_dir", "\n", "relative_image_path", "=", "os", ".", "path", ".", "relpath", "(", "image_path", ",", "run_dir", ")", "\n", "relative_metric_path", "=", "os", ".", "path", ".", "relpath", "(", "metric_path", ",", "run_dir", ")", "\n", "_write_html_image", "(", "html_file", ",", "relative_image_path", ",", "relative_metric_path", ")", "\n", "relative_image_report_dir", "=", "os", ".", "path", ".", "relpath", "(", "\n", "run_output_paths", ".", "output_paths", ".", "image_report_dir", ",", "run_dir", ")", "\n", "_create_metric_html", "(", "metric_path", ",", "relative_image_path", ",", "\n", "relative_image_report_dir", ",", "metric_data", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_metric_html": [[595, 607], ["open", "report._write_html_image", "report._print_metric_stats", "metric_file.write", "report._write_sorted_images", "report._write_many_line_breaks"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_html_image", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._print_metric_stats", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_sorted_images", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_many_line_breaks"], ["", "def", "_create_metric_html", "(", "metric_path", ",", "relative_image_path", ",", "\n", "relative_image_report_dir", ",", "metric_data", ")", ":", "\n", "# type: (str, str, str, MetricData) -> None", "\n", "    ", "with", "open", "(", "metric_path", ",", "'w'", ")", "as", "metric_file", ":", "\n", "        ", "_write_html_image", "(", "\n", "metric_file", ",", "relative_image_path", ",", "relative_image_path", ",", "\n", "align", "=", "HTML_IMAGE_ALIGN_LEFT", ")", "\n", "_print_metric_stats", "(", "metric_file", ",", "metric_data", ".", "sorted_series", ")", "\n", "metric_file", ".", "write", "(", "'\\n<br>'", ")", "\n", "_write_sorted_images", "(", "metric_file", ",", "relative_image_report_dir", ",", "\n", "metric_data", ".", "sorted_series", ",", "metric_data", ".", "bins", ")", "\n", "_write_many_line_breaks", "(", "metric_file", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_many_line_breaks": [[609, 612], ["html_file.write"], "function", ["None"], ["", "", "def", "_write_many_line_breaks", "(", "html_file", ")", ":", "\n", "# type: (IO) -> None", "\n", "    ", "html_file", ".", "write", "(", "'<br>\\n'", "*", "100", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_sorted_images": [[614, 631], ["numpy.concatenate", "zip", "report._write_header", "report._write_sorted_images_anchor_links", "report._write_header", "zip", "report._write_anchor", "report._write_header", "report._write_image_series"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_sorted_images_anchor_links", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_anchor", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_image_series"], ["", "def", "_write_sorted_images", "(", "\n", "metric_file", ",", "relative_image_report_dir", ",", "sorted_series", ",", "bins", ")", ":", "\n", "# type: (IO, str, Series, numpy.ndarray) -> None", "\n", "    ", "extended_bins", "=", "numpy", ".", "concatenate", "(", "(", "[", "numpy", ".", "NINF", "]", ",", "bins", ",", "[", "numpy", ".", "Inf", "]", ")", ")", "\n", "bins_start_end", "=", "zip", "(", "extended_bins", "[", ":", "-", "1", "]", ",", "extended_bins", "[", "1", ":", "]", ")", "\n", "bin_names", "=", "[", "'%.2f_to_%.2f'", "%", "(", "start", ",", "end", ")", "for", "(", "start", ",", "end", ")", "in", "\n", "bins_start_end", "]", "\n", "_write_header", "(", "metric_file", ",", "'Images per bucket'", ")", "\n", "_write_sorted_images_anchor_links", "(", "metric_file", ",", "bin_names", ")", "\n", "_write_header", "(", "metric_file", ",", "'Images'", ")", "\n", "for", "(", "(", "start", ",", "end", ")", ",", "name", ")", "in", "zip", "(", "bins_start_end", ",", "bin_names", ")", ":", "\n", "        ", "_write_anchor", "(", "metric_file", ",", "name", ")", "\n", "_write_header", "(", "metric_file", ",", "name", ")", "\n", "filtered_series", "=", "sorted_series", "[", "\n", "lambda", "metric", ":", "(", "metric", ">=", "start", ")", "&", "(", "metric", "<", "end", ")", "]", "\n", "_write_image_series", "(", "metric_file", ",", "relative_image_report_dir", ",", "\n", "filtered_series", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_image_series": [[633, 640], ["series.iteritems", "report._image_report_path", "metric_file.write"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._image_report_path"], ["", "", "def", "_write_image_series", "(", "metric_file", ",", "relative_image_report_dir", ",", "series", ")", ":", "\n", "# type: (IO, str, Series) -> None", "\n", "    ", "for", "image_id", ",", "metric", "in", "series", ".", "iteritems", "(", ")", ":", "\n", "        ", "relative_image_report_path", "=", "_image_report_path", "(", "\n", "relative_image_report_dir", ",", "image_id", ")", "\n", "metric_file", ".", "write", "(", "'<a href=\"%s\">%s</a>: %f, \\n'", "%", "(", "\n", "relative_image_report_path", ",", "image_id", ",", "metric", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._image_report_path": [[642, 645], ["os.path.join"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report.PathForHTML.join"], ["", "", "def", "_image_report_path", "(", "relative_image_report_dir", ",", "image_id", ")", ":", "\n", "# type: (str, str) -> str", "\n", "    ", "return", "os", ".", "path", ".", "join", "(", "relative_image_report_dir", ",", "'%s.html'", "%", "image_id", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_anchor": [[647, 650], ["html_file.write"], "function", ["None"], ["", "def", "_write_anchor", "(", "html_file", ",", "name", ")", ":", "\n", "# type: (IO, str) -> None", "\n", "    ", "html_file", ".", "write", "(", "'<a name=\"%s\"></a>'", "%", "name", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_sorted_images_anchor_links": [[652, 656], ["metric_file.write", "report._create_anchor_link"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_anchor_link"], ["", "def", "_write_sorted_images_anchor_links", "(", "metric_file", ",", "bin_names", ")", ":", "\n", "# type: (IO, List[str]) -> None", "\n", "    ", "anchor_links", "=", "[", "_create_anchor_link", "(", "bin_name", ")", "for", "bin_name", "in", "bin_names", "]", "\n", "metric_file", ".", "write", "(", "' || '", ".", "join", "(", "anchor_links", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._create_anchor_link": [[658, 661], ["None"], "function", ["None"], ["", "def", "_create_anchor_link", "(", "bin_name", ")", ":", "\n", "# type: (str) -> str", "\n", "    ", "return", "'<a href=\"#%s\">%s</a>\\n'", "%", "(", "bin_name", ",", "bin_name", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._print_metric_stats": [[663, 669], ["series.describe", "report._write_header", "metric_file.write", "series.describe.to_frame().to_html", "series.describe.to_frame"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header"], ["", "def", "_print_metric_stats", "(", "metric_file", ",", "series", ")", ":", "\n", "# type: (IO, Series) -> None", "\n", "    ", "stats", "=", "series", ".", "describe", "(", ")", "\n", "_write_header", "(", "metric_file", ",", "'Metric stats'", ")", "\n", "metric_file", ".", "write", "(", "stats", ".", "to_frame", "(", ")", ".", "to_html", "(", "\n", "float_format", "=", "_table_float_format", ")", "+", "'\\n'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._plot_histogram": [[671, 682], ["matplotlib.figure", "data_frame.hist", "data_frame[].count", "matplotlib.title", "matplotlib.ylabel", "matplotlib.xlabel", "matplotlib.gca"], "function", ["None"], ["", "def", "_plot_histogram", "(", "data_frame", ",", "bins", ",", "column_name", ")", ":", "\n", "# type: (DataFrame, Optional[numpy.ndarray], str) -> Figure", "\n", "    ", "figure", "=", "plt", ".", "figure", "(", ")", "\n", "# Draw the histogram into the current active axes.", "\n", "data_frame", ".", "hist", "(", "column", "=", "column_name", ",", "ax", "=", "plt", ".", "gca", "(", ")", ",", "edgecolor", "=", "'black'", ",", "\n", "linewidth", "=", "1.2", ",", "grid", "=", "False", ",", "bins", "=", "bins", ")", "\n", "count", "=", "data_frame", "[", "column_name", "]", ".", "count", "(", ")", "\n", "plt", ".", "title", "(", "'%s (image count = %d)'", "%", "(", "column_name", ",", "count", ")", ")", "\n", "plt", ".", "ylabel", "(", "'Frequency'", ")", "\n", "plt", ".", "xlabel", "(", "column_name", ")", "\n", "return", "figure", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_html_image": [[684, 692], ["html_file.write"], "function", ["None"], ["", "def", "_write_html_image", "(", "html_file", ",", "image_src", ",", "link", ",", "align", "=", "None", ")", ":", "\n", "# type: (IO, str, str, Optional[str]) -> None", "\n", "    ", "if", "align", ":", "\n", "        ", "align_string", "=", "\"align='%s'\"", "%", "align", "\n", "", "else", ":", "\n", "        ", "align_string", "=", "''", "\n", "", "html_file", ".", "write", "(", "\"<a href='%s'><img src='%s' width='%d' %s></a>\\n\"", "%", "(", "\n", "link", ",", "image_src", ",", "HTML_IMAGE_WIDTH_PIXELS", ",", "align_string", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._add_unlabeled_images": [[694, 698], ["report._write_header", "html_file.write"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header"], ["", "def", "_add_unlabeled_images", "(", "html_file", ",", "image_dir", ")", ":", "\n", "# type: (IO, str) -> None", "\n", "    ", "_write_header", "(", "html_file", ",", "'Unlabeled images'", ")", "\n", "html_file", ".", "write", "(", "'to be added at some point?'", ")", "\n", "# TODO: implement this to allow us to view unlabeled images (no ground", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._write_header": [[702, 705], ["html_file.write"], "function", ["None"], ["", "def", "_write_header", "(", "html_file", ",", "header", ")", ":", "\n", "# type: (IO, str) -> None", "\n", "    ", "html_file", ".", "write", "(", "'<h1>%s</h1>\\n'", "%", "header", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.report._table_float_format": [[707, 713], ["None"], "function", ["None"], ["", "def", "_table_float_format", "(", "the_float", ")", ":", "\n", "# type: (float) -> str", "\n", "    ", "if", "the_float", ">", "MIN_FLOAT_TO_PRINT", ":", "\n", "        ", "return", "'%.6f'", "%", "the_float", "\n", "", "else", ":", "\n", "        ", "return", "'%g'", "%", "the_float", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet.ResNet.__init__": [[7, 13], ["super().__init__", "torch.MaxPool2d", "torch.MaxPool2d", "range", "getattr", "getattr"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "block", ",", "layers", ",", "num_classes", "=", "1000", ")", ":", "\n", "        ", "super", "(", "ResNet", ",", "self", ")", ".", "__init__", "(", "block", ",", "layers", ",", "num_classes", ")", "\n", "self", ".", "maxpool", "=", "nn", ".", "MaxPool2d", "(", "kernel_size", "=", "3", ",", "stride", "=", "2", ",", "padding", "=", "0", ",", "ceil_mode", "=", "True", ")", "# change", "\n", "for", "i", "in", "range", "(", "2", ",", "5", ")", ":", "\n", "            ", "getattr", "(", "self", ",", "'layer%d'", "%", "i", ")", "[", "0", "]", ".", "conv1", ".", "stride", "=", "(", "2", ",", "2", ")", "\n", "getattr", "(", "self", ",", "'layer%d'", "%", "i", ")", "[", "0", "]", ".", "conv2", ".", "stride", "=", "(", "1", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet.resnet18": [[14, 24], ["resnet.ResNet", "ResNet.load_state_dict", "model_zoo.load_url"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict"], ["", "", "", "def", "resnet18", "(", "pretrained", "=", "False", ")", ":", "\n", "    ", "\"\"\"Constructs a ResNet-18 model.\n\n    Args:\n        pretrained (bool): If True, returns a model pre-trained on ImageNet\n    \"\"\"", "\n", "model", "=", "ResNet", "(", "BasicBlock", ",", "[", "2", ",", "2", ",", "2", ",", "2", "]", ")", "\n", "if", "pretrained", ":", "\n", "        ", "model", ".", "load_state_dict", "(", "model_zoo", ".", "load_url", "(", "model_urls", "[", "'resnet18'", "]", ")", ")", "\n", "", "return", "model", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet.resnet34": [[26, 36], ["resnet.ResNet", "ResNet.load_state_dict", "model_zoo.load_url"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict"], ["", "def", "resnet34", "(", "pretrained", "=", "False", ")", ":", "\n", "    ", "\"\"\"Constructs a ResNet-34 model.\n\n    Args:\n        pretrained (bool): If True, returns a model pre-trained on ImageNet\n    \"\"\"", "\n", "model", "=", "ResNet", "(", "BasicBlock", ",", "[", "3", ",", "4", ",", "6", ",", "3", "]", ")", "\n", "if", "pretrained", ":", "\n", "        ", "model", ".", "load_state_dict", "(", "model_zoo", ".", "load_url", "(", "model_urls", "[", "'resnet34'", "]", ")", ")", "\n", "", "return", "model", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet.resnet50": [[38, 48], ["resnet.ResNet", "ResNet.load_state_dict", "model_zoo.load_url"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict"], ["", "def", "resnet50", "(", "pretrained", "=", "False", ")", ":", "\n", "    ", "\"\"\"Constructs a ResNet-50 model.\n\n    Args:\n        pretrained (bool): If True, returns a model pre-trained on ImageNet\n    \"\"\"", "\n", "model", "=", "ResNet", "(", "Bottleneck", ",", "[", "3", ",", "4", ",", "6", ",", "3", "]", ")", "\n", "if", "pretrained", ":", "\n", "        ", "model", ".", "load_state_dict", "(", "model_zoo", ".", "load_url", "(", "model_urls", "[", "'resnet50'", "]", ")", ")", "\n", "", "return", "model", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet.resnet101": [[50, 60], ["resnet.ResNet", "ResNet.load_state_dict", "model_zoo.load_url"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict"], ["", "def", "resnet101", "(", "pretrained", "=", "False", ")", ":", "\n", "    ", "\"\"\"Constructs a ResNet-101 model.\n\n    Args:\n        pretrained (bool): If True, returns a model pre-trained on ImageNet\n    \"\"\"", "\n", "model", "=", "ResNet", "(", "Bottleneck", ",", "[", "3", ",", "4", ",", "23", ",", "3", "]", ")", "\n", "if", "pretrained", ":", "\n", "        ", "model", ".", "load_state_dict", "(", "model_zoo", ".", "load_url", "(", "model_urls", "[", "'resnet101'", "]", ")", ")", "\n", "", "return", "model", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet.resnet152": [[62, 72], ["resnet.ResNet", "ResNet.load_state_dict", "model_zoo.load_url"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict"], ["", "def", "resnet152", "(", "pretrained", "=", "False", ")", ":", "\n", "    ", "\"\"\"Constructs a ResNet-152 model.\n\n    Args:\n        pretrained (bool): If True, returns a model pre-trained on ImageNet\n    \"\"\"", "\n", "model", "=", "ResNet", "(", "Bottleneck", ",", "[", "3", ",", "8", ",", "36", ",", "3", "]", ")", "\n", "if", "pretrained", ":", "\n", "        ", "model", ".", "load_state_dict", "(", "model_zoo", ".", "load_url", "(", "model_urls", "[", "'resnet152'", "]", ")", ")", "\n", "", "return", "model", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.rewards.init_scorer": [[21, 26], ["pyciderevalcap.ciderD.ciderD.CiderD", "pycocoevalcap.bleu.bleu.Bleu"], "function", ["None"], ["def", "init_scorer", "(", "cached_tokens", ")", ":", "\n", "    ", "global", "CiderD_scorer", "\n", "CiderD_scorer", "=", "CiderD_scorer", "or", "CiderD", "(", "df", "=", "cached_tokens", ")", "\n", "global", "Bleu_scorer", "\n", "Bleu_scorer", "=", "Bleu_scorer", "or", "Bleu", "(", "4", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.rewards.array_to_str": [[27, 34], ["range", "out.strip", "len", "str"], "function", ["None"], ["", "def", "array_to_str", "(", "arr", ")", ":", "\n", "    ", "out", "=", "''", "\n", "for", "i", "in", "range", "(", "len", "(", "arr", ")", ")", ":", "\n", "        ", "out", "+=", "str", "(", "arr", "[", "i", "]", ")", "+", "' '", "\n", "if", "arr", "[", "i", "]", "==", "0", ":", "\n", "            ", "break", "\n", "", "", "return", "out", ".", "strip", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.rewards.get_self_critical_reward": [[35, 82], ["gen_result.data.cpu().numpy.size", "model.eval", "model.train", "collections.OrderedDict", "gen_result.data.cpu().numpy.data.cpu().numpy", "greedy_res.data.cpu().numpy.data.cpu().numpy", "range", "range", "collections.OrderedDict", "range", "numpy.repeat", "len", "torch.no_grad", "len", "CiderD_scorer.compute_score", "print", "Bleu_scorer.compute_score", "numpy.array", "print", "model", "model", "gen_result.data.cpu().numpy.data.cpu", "greedy_res.data.cpu().numpy.data.cpu", "rewards.array_to_str", "rewards.array_to_str", "rewards.array_to_str", "range", "range", "range", "range", "len"], "function", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.None.train.train", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.rewards.array_to_str", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.rewards.array_to_str", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.rewards.array_to_str"], ["", "def", "get_self_critical_reward", "(", "model", ",", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", ",", "data", ",", "gen_result", ",", "opt", ")", ":", "\n", "    ", "batch_size", "=", "gen_result", ".", "size", "(", "0", ")", "# batch_size = sample_size * seq_per_img", "\n", "seq_per_img", "=", "batch_size", "//", "len", "(", "data", "[", "'gts'", "]", ")", "\n", "\n", "# get greedy decoding baseline", "\n", "model", ".", "eval", "(", ")", "\n", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "        ", "if", "boxes", "is", "None", ":", "\n", "            ", "greedy_res", ",", "_", "=", "model", "(", "fc_feats", ",", "att_feats", ",", "att_masks", "=", "att_masks", ",", "mode", "=", "'sample'", ")", "\n", "", "else", ":", "\n", "            ", "greedy_res", ",", "_", "=", "model", "(", "fc_feats", ",", "att_feats", ",", "boxes", ",", "att_masks", "=", "att_masks", ",", "mode", "=", "'sample'", ")", "\n", "", "", "model", ".", "train", "(", ")", "\n", "\n", "res", "=", "OrderedDict", "(", ")", "\n", "\n", "gen_result", "=", "gen_result", ".", "data", ".", "cpu", "(", ")", ".", "numpy", "(", ")", "\n", "greedy_res", "=", "greedy_res", ".", "data", ".", "cpu", "(", ")", ".", "numpy", "(", ")", "\n", "for", "i", "in", "range", "(", "batch_size", ")", ":", "\n", "        ", "res", "[", "i", "]", "=", "[", "array_to_str", "(", "gen_result", "[", "i", "]", ")", "]", "\n", "", "for", "i", "in", "range", "(", "batch_size", ")", ":", "\n", "        ", "res", "[", "batch_size", "+", "i", "]", "=", "[", "array_to_str", "(", "greedy_res", "[", "i", "]", ")", "]", "\n", "\n", "", "gts", "=", "OrderedDict", "(", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "data", "[", "'gts'", "]", ")", ")", ":", "\n", "        ", "gts", "[", "i", "]", "=", "[", "array_to_str", "(", "data", "[", "'gts'", "]", "[", "i", "]", "[", "j", "]", ")", "for", "j", "in", "range", "(", "len", "(", "data", "[", "'gts'", "]", "[", "i", "]", ")", ")", "]", "\n", "\n", "", "res_", "=", "[", "{", "'image_id'", ":", "i", ",", "'caption'", ":", "res", "[", "i", "]", "}", "for", "i", "in", "range", "(", "2", "*", "batch_size", ")", "]", "\n", "res__", "=", "{", "i", ":", "res", "[", "i", "]", "for", "i", "in", "range", "(", "2", "*", "batch_size", ")", "}", "\n", "gts", "=", "{", "i", ":", "gts", "[", "i", "%", "batch_size", "//", "seq_per_img", "]", "for", "i", "in", "range", "(", "2", "*", "batch_size", ")", "}", "\n", "if", "opt", ".", "cider_reward_weight", ">", "0", ":", "\n", "        ", "_", ",", "cider_scores", "=", "CiderD_scorer", ".", "compute_score", "(", "gts", ",", "res_", ")", "\n", "print", "(", "'Cider scores:'", ",", "_", ")", "\n", "", "else", ":", "\n", "        ", "cider_scores", "=", "0", "\n", "", "if", "opt", ".", "bleu_reward_weight", ">", "0", ":", "\n", "        ", "_", ",", "bleu_scores", "=", "Bleu_scorer", ".", "compute_score", "(", "gts", ",", "res__", ")", "\n", "bleu_scores", "=", "np", ".", "array", "(", "bleu_scores", "[", "3", "]", ")", "\n", "print", "(", "'Bleu scores:'", ",", "_", "[", "3", "]", ")", "\n", "", "else", ":", "\n", "        ", "bleu_scores", "=", "0", "\n", "", "scores", "=", "opt", ".", "cider_reward_weight", "*", "cider_scores", "+", "opt", ".", "bleu_reward_weight", "*", "bleu_scores", "\n", "\n", "scores", "=", "scores", "[", ":", "batch_size", "]", "-", "scores", "[", "batch_size", ":", "]", "\n", "\n", "rewards", "=", "np", ".", "repeat", "(", "scores", "[", ":", ",", "np", ".", "newaxis", "]", ",", "gen_result", ".", "shape", "[", "1", "]", ",", "1", ")", "\n", "\n", "return", "rewards", "\n", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.RewardCriterion.__init__": [[47, 49], ["torch.Module.__init__"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ")", ":", "\n", "        ", "super", "(", "RewardCriterion", ",", "self", ")", ".", "__init__", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.RewardCriterion.forward": [[50, 68], ["to_contiguous().view", "to_contiguous().view", "to_contiguous().view", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "utils.to_contiguous", "utils.to_contiguous", "utils.to_contiguous", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "torch.cat", "to_contiguous().view.new().fill_", "to_contiguous().view.new", "to_contiguous().view.size"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.to_contiguous", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.to_contiguous", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.to_contiguous"], ["", "def", "forward", "(", "self", ",", "input", ",", "seq", ",", "reward", ")", ":", "\n", "        ", "'''\n        This function computes\n            log(y_t) * reward * mask_t  (where mask_t zeroes out non-words in the sequence)\n        given\n            input = predicted probability\n            sequence = predicted word index\n            reward = ...\n        '''", "\n", "\n", "input", "=", "to_contiguous", "(", "input", ")", ".", "view", "(", "-", "1", ")", "\n", "reward", "=", "to_contiguous", "(", "reward", ")", ".", "view", "(", "-", "1", ")", "\n", "mask", "=", "(", "seq", ">", "0", ")", ".", "float", "(", ")", "\n", "mask", "=", "to_contiguous", "(", "torch", ".", "cat", "(", "[", "mask", ".", "new", "(", "mask", ".", "size", "(", "0", ")", ",", "1", ")", ".", "fill_", "(", "1", ")", ",", "mask", "[", ":", ",", ":", "-", "1", "]", "]", ",", "1", ")", ")", ".", "view", "(", "-", "1", ")", "\n", "output", "=", "-", "input", "*", "reward", "*", "mask", "\n", "output", "=", "torch", ".", "sum", "(", "output", ")", "/", "torch", ".", "sum", "(", "mask", ")", "\n", "\n", "return", "output", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.LanguageModelCriterion.__init__": [[70, 72], ["torch.Module.__init__"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ")", ":", "\n", "        ", "super", "(", "LanguageModelCriterion", ",", "self", ")", ".", "__init__", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.LanguageModelCriterion.forward": [[73, 82], ["torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "torch.sum", "input.gather().squeeze", "input.size", "input.size", "input.gather", "target.unsqueeze"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "input", ",", "target", ",", "mask", ")", ":", "\n", "# truncate to the same size", "\n", "        ", "target", "=", "target", "[", ":", ",", ":", "input", ".", "size", "(", "1", ")", "]", "\n", "mask", "=", "mask", "[", ":", ",", ":", "input", ".", "size", "(", "1", ")", "]", "\n", "\n", "output", "=", "-", "input", ".", "gather", "(", "2", ",", "target", ".", "unsqueeze", "(", "2", ")", ")", ".", "squeeze", "(", "2", ")", "*", "mask", "\n", "output", "=", "torch", ".", "sum", "(", "output", ")", "/", "torch", ".", "sum", "(", "mask", ")", "\n", "\n", "return", "output", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.LabelSmoothing.__init__": [[85, 93], ["torch.Module.__init__", "torch.KLDivLoss", "torch.KLDivLoss", "torch.KLDivLoss"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["def", "__init__", "(", "self", ",", "size", "=", "0", ",", "padding_idx", "=", "0", ",", "smoothing", "=", "0.0", ")", ":", "\n", "        ", "super", "(", "LabelSmoothing", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "criterion", "=", "nn", ".", "KLDivLoss", "(", "size_average", "=", "False", ",", "reduce", "=", "False", ")", "\n", "# self.padding_idx = padding_idx", "\n", "self", ".", "confidence", "=", "1.0", "-", "smoothing", "\n", "self", ".", "smoothing", "=", "smoothing", "\n", "# self.size = size", "\n", "self", ".", "true_dist", "=", "None", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.LabelSmoothing.forward": [[94, 114], ["to_contiguous().view", "to_contiguous().view", "to_contiguous().view", "to_contiguous().view.size", "to_contiguous().view.data.clone", "to_contiguous().view.data.clone.fill_", "to_contiguous().view.data.clone.scatter_", "to_contiguous().view.size", "to_contiguous().view.data.unsqueeze", "to_contiguous().view.sum", "utils.to_contiguous", "utils.to_contiguous", "utils.to_contiguous", "to_contiguous().view.size", "to_contiguous().view.size", "utils.LabelSmoothing.criterion().sum", "utils.LabelSmoothing.criterion"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.to_contiguous", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.to_contiguous", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.to_contiguous"], ["", "def", "forward", "(", "self", ",", "input", ",", "target", ",", "mask", ")", ":", "\n", "# truncate to the same size", "\n", "        ", "target", "=", "target", "[", ":", ",", ":", "input", ".", "size", "(", "1", ")", "]", "\n", "mask", "=", "mask", "[", ":", ",", ":", "input", ".", "size", "(", "1", ")", "]", "\n", "\n", "input", "=", "to_contiguous", "(", "input", ")", ".", "view", "(", "-", "1", ",", "input", ".", "size", "(", "-", "1", ")", ")", "\n", "target", "=", "to_contiguous", "(", "target", ")", ".", "view", "(", "-", "1", ")", "\n", "mask", "=", "to_contiguous", "(", "mask", ")", ".", "view", "(", "-", "1", ")", "\n", "\n", "# assert x.size(1) == self.size", "\n", "self", ".", "size", "=", "input", ".", "size", "(", "1", ")", "\n", "# true_dist = x.data.clone()", "\n", "true_dist", "=", "input", ".", "data", ".", "clone", "(", ")", "\n", "# true_dist.fill_(self.smoothing / (self.size - 2))", "\n", "true_dist", ".", "fill_", "(", "self", ".", "smoothing", "/", "(", "self", ".", "size", "-", "1", ")", ")", "\n", "true_dist", ".", "scatter_", "(", "1", ",", "target", ".", "data", ".", "unsqueeze", "(", "1", ")", ",", "self", ".", "confidence", ")", "\n", "# true_dist[:, self.padding_idx] = 0", "\n", "# mask = torch.nonzero(target.data == self.padding_idx)", "\n", "# self.true_dist = true_dist", "\n", "return", "(", "self", ".", "criterion", "(", "input", ",", "true_dist", ")", ".", "sum", "(", "1", ")", "*", "mask", ")", ".", "sum", "(", ")", "/", "mask", ".", "sum", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.NoamOpt.__init__": [[147, 154], ["None"], "methods", ["None"], ["def", "__init__", "(", "self", ",", "model_size", ",", "factor", ",", "warmup", ",", "optimizer", ")", ":", "\n", "        ", "self", ".", "optimizer", "=", "optimizer", "\n", "self", ".", "_step", "=", "0", "\n", "self", ".", "warmup", "=", "warmup", "\n", "self", ".", "factor", "=", "factor", "\n", "self", ".", "model_size", "=", "model_size", "\n", "self", ".", "_rate", "=", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.NoamOpt.step": [[155, 163], ["utils.NoamOpt.rate", "utils.NoamOpt.optimizer.step"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.rate", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.step"], ["", "def", "step", "(", "self", ")", ":", "\n", "        ", "\"Update parameters and rate\"", "\n", "self", ".", "_step", "+=", "1", "\n", "rate", "=", "self", ".", "rate", "(", ")", "\n", "for", "p", "in", "self", ".", "optimizer", ".", "param_groups", ":", "\n", "            ", "p", "[", "'lr'", "]", "=", "rate", "\n", "", "self", ".", "_rate", "=", "rate", "\n", "self", ".", "optimizer", ".", "step", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.NoamOpt.rate": [[164, 171], ["min"], "methods", ["None"], ["", "def", "rate", "(", "self", ",", "step", "=", "None", ")", ":", "\n", "        ", "\"Implement `lrate` above\"", "\n", "if", "step", "is", "None", ":", "\n", "            ", "step", "=", "self", ".", "_step", "\n", "", "return", "self", ".", "factor", "*", "(", "self", ".", "model_size", "**", "(", "-", "0.5", ")", "*", "\n", "min", "(", "step", "**", "(", "-", "0.5", ")", ",", "step", "*", "self", ".", "warmup", "**", "(", "-", "1.5", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.NoamOpt.__getattr__": [[172, 174], ["getattr"], "methods", ["None"], ["", "def", "__getattr__", "(", "self", ",", "name", ")", ":", "\n", "        ", "return", "getattr", "(", "self", ".", "optimizer", ",", "name", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.__init__": [[177, 181], ["torch.lr_scheduler.ReduceLROnPlateau", "torch.lr_scheduler.ReduceLROnPlateau", "torch.lr_scheduler.ReduceLROnPlateau", "utils.get_lr"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.get_lr"], ["def", "__init__", "(", "self", ",", "optimizer", ",", "mode", "=", "'min'", ",", "factor", "=", "0.1", ",", "patience", "=", "10", ",", "verbose", "=", "False", ",", "threshold", "=", "0.0001", ",", "threshold_mode", "=", "'rel'", ",", "cooldown", "=", "0", ",", "min_lr", "=", "0", ",", "eps", "=", "1e-08", ")", ":", "\n", "        ", "self", ".", "scheduler", "=", "optim", ".", "lr_scheduler", ".", "ReduceLROnPlateau", "(", "optimizer", ",", "mode", ",", "factor", ",", "patience", ",", "verbose", ",", "threshold", ",", "threshold_mode", ",", "cooldown", ",", "min_lr", ",", "eps", ")", "\n", "self", ".", "optimizer", "=", "optimizer", "\n", "self", ".", "current_lr", "=", "get_lr", "(", "optimizer", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.step": [[182, 185], ["utils.ReduceLROnPlateau.optimizer.step"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.step"], ["", "def", "step", "(", "self", ")", ":", "\n", "        ", "\"Update parameters and rate\"", "\n", "self", ".", "optimizer", ".", "step", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.scheduler_step": [[186, 189], ["utils.ReduceLROnPlateau.scheduler.step", "utils.get_lr"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.step", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.get_lr"], ["", "def", "scheduler_step", "(", "self", ",", "val", ")", ":", "\n", "        ", "self", ".", "scheduler", ".", "step", "(", "val", ")", "\n", "self", ".", "current_lr", "=", "get_lr", "(", "self", ".", "optimizer", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.state_dict": [[190, 194], ["utils.ReduceLROnPlateau.optimizer.state_dict", "utils.ReduceLROnPlateau.scheduler.__dict__.items"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.state_dict"], ["", "def", "state_dict", "(", "self", ")", ":", "\n", "        ", "return", "{", "'current_lr'", ":", "self", ".", "current_lr", ",", "\n", "'scheduler_state_dict'", ":", "{", "key", ":", "value", "for", "key", ",", "value", "in", "self", ".", "scheduler", ".", "__dict__", ".", "items", "(", ")", "if", "key", "not", "in", "{", "'optimizer'", ",", "'is_better'", "}", "}", ",", "\n", "'optimizer_state_dict'", ":", "self", ".", "optimizer", ".", "state_dict", "(", ")", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict": [[195, 206], ["utils.ReduceLROnPlateau.optimizer.load_state_dict", "utils.set_lr", "utils.ReduceLROnPlateau.scheduler.__dict__.update", "utils.ReduceLROnPlateau.scheduler._init_is_better", "utils.ReduceLROnPlateau.optimizer.load_state_dict"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.set_lr", "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.load_state_dict"], ["", "def", "load_state_dict", "(", "self", ",", "state_dict", ")", ":", "\n", "        ", "if", "'current_lr'", "not", "in", "state_dict", ":", "\n", "# it's normal optimizer", "\n", "            ", "self", ".", "optimizer", ".", "load_state_dict", "(", "state_dict", ")", "\n", "set_lr", "(", "self", ".", "optimizer", ",", "self", ".", "current_lr", ")", "# use the lr fromt the option", "\n", "", "else", ":", "\n", "# it's a schduler", "\n", "            ", "self", ".", "current_lr", "=", "state_dict", "[", "'current_lr'", "]", "\n", "self", ".", "scheduler", ".", "__dict__", ".", "update", "(", "state_dict", "[", "'scheduler_state_dict'", "]", ")", "\n", "self", ".", "scheduler", ".", "_init_is_better", "(", "mode", "=", "self", ".", "scheduler", ".", "mode", ",", "threshold", "=", "self", ".", "scheduler", ".", "threshold", ",", "threshold_mode", "=", "self", ".", "scheduler", ".", "threshold_mode", ")", "\n", "self", ".", "optimizer", ".", "load_state_dict", "(", "state_dict", "[", "'optimizer_state_dict'", "]", ")", "\n", "# current_lr is actually useless in this case", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.rate": [[208, 215], ["min"], "methods", ["None"], ["", "", "def", "rate", "(", "self", ",", "step", "=", "None", ")", ":", "\n", "        ", "\"Implement `lrate` above\"", "\n", "if", "step", "is", "None", ":", "\n", "            ", "step", "=", "self", ".", "_step", "\n", "", "return", "self", ".", "factor", "*", "(", "self", ".", "model_size", "**", "(", "-", "0.5", ")", "*", "\n", "min", "(", "step", "**", "(", "-", "0.5", ")", ",", "step", "*", "self", ".", "warmup", "**", "(", "-", "1.5", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.ReduceLROnPlateau.__getattr__": [[216, 218], ["getattr"], "methods", ["None"], ["", "def", "__getattr__", "(", "self", ",", "name", ")", ":", "\n", "        ", "return", "getattr", "(", "self", ".", "optimizer", ",", "name", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.apply_along_batch": [[11, 16], ["torch.stack", "torch.stack", "torch.stack", "func", "torch.unbind", "torch.unbind", "torch.unbind"], "function", ["None"], ["def", "apply_along_batch", "(", "func", ",", "M", ")", ":", "\n", "#apply torch function for each image in a batch, and concatenate results back into a single tensor", "\n", "    ", "tensorList", "=", "[", "func", "(", "m", ")", "for", "m", "in", "torch", ".", "unbind", "(", "M", ",", "dim", "=", "0", ")", "]", "\n", "result", "=", "torch", ".", "stack", "(", "tensorList", ",", "dim", "=", "0", ")", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.if_use_att": [[17, 22], ["None"], "function", ["None"], ["", "def", "if_use_att", "(", "caption_model", ")", ":", "\n", "# Decide if load attention feature according to caption model", "\n", "    ", "if", "caption_model", "in", "[", "'show_tell'", ",", "'all_img'", ",", "'fc'", "]", ":", "\n", "        ", "return", "False", "\n", "", "return", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.decode_sequence": [[24, 39], ["seq.size", "range", "range", "out.append", "str", "ix.item"], "function", ["None"], ["", "def", "decode_sequence", "(", "ix_to_word", ",", "seq", ")", ":", "\n", "    ", "N", ",", "D", "=", "seq", ".", "size", "(", ")", "\n", "out", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "N", ")", ":", "\n", "        ", "txt", "=", "''", "\n", "for", "j", "in", "range", "(", "D", ")", ":", "\n", "            ", "ix", "=", "seq", "[", "i", ",", "j", "]", "\n", "if", "ix", ">", "0", ":", "\n", "                ", "if", "j", ">=", "1", ":", "\n", "                    ", "txt", "=", "txt", "+", "' '", "\n", "", "txt", "=", "txt", "+", "ix_to_word", "[", "str", "(", "ix", ".", "item", "(", ")", ")", "]", "\n", "", "else", ":", "\n", "                ", "break", "\n", "", "", "out", ".", "append", "(", "txt", ")", "\n", "", "return", "out", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.to_contiguous": [[40, 45], ["tensor.is_contiguous", "tensor.contiguous"], "function", ["None"], ["", "def", "to_contiguous", "(", "tensor", ")", ":", "\n", "    ", "if", "tensor", ".", "is_contiguous", "(", ")", ":", "\n", "        ", "return", "tensor", "\n", "", "else", ":", "\n", "        ", "return", "tensor", ".", "contiguous", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.set_lr": [[115, 118], ["None"], "function", ["None"], ["", "", "def", "set_lr", "(", "optimizer", ",", "lr", ")", ":", "\n", "    ", "for", "group", "in", "optimizer", ".", "param_groups", ":", "\n", "        ", "group", "[", "'lr'", "]", "=", "lr", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.get_lr": [[119, 122], ["None"], "function", ["None"], ["", "", "def", "get_lr", "(", "optimizer", ")", ":", "\n", "    ", "for", "group", "in", "optimizer", ".", "param_groups", ":", "\n", "        ", "return", "group", "[", "'lr'", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.clip_gradient": [[123, 127], ["param.grad.data.clamp_"], "function", ["None"], ["", "", "def", "clip_gradient", "(", "optimizer", ",", "grad_clip", ")", ":", "\n", "    ", "for", "group", "in", "optimizer", ".", "param_groups", ":", "\n", "        ", "for", "param", "in", "group", "[", "'params'", "]", ":", "\n", "            ", "param", ".", "grad", ".", "data", ".", "clamp_", "(", "-", "grad_clip", ",", "grad_clip", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.build_optimizer": [[128, 143], ["torch.RMSprop", "torch.Adagrad", "torch.SGD", "torch.SGD", "torch.SGD", "torch.Adam", "Exception"], "function", ["None"], ["", "", "", "def", "build_optimizer", "(", "params", ",", "opt", ")", ":", "\n", "    ", "if", "opt", ".", "optim", "==", "'rmsprop'", ":", "\n", "        ", "return", "optim", ".", "RMSprop", "(", "params", ",", "opt", ".", "learning_rate", ",", "opt", ".", "optim_alpha", ",", "opt", ".", "optim_epsilon", ",", "weight_decay", "=", "opt", ".", "weight_decay", ")", "\n", "", "elif", "opt", ".", "optim", "==", "'adagrad'", ":", "\n", "        ", "return", "optim", ".", "Adagrad", "(", "params", ",", "opt", ".", "learning_rate", ",", "weight_decay", "=", "opt", ".", "weight_decay", ")", "\n", "", "elif", "opt", ".", "optim", "==", "'sgd'", ":", "\n", "        ", "return", "optim", ".", "SGD", "(", "params", ",", "opt", ".", "learning_rate", ",", "weight_decay", "=", "opt", ".", "weight_decay", ")", "\n", "", "elif", "opt", ".", "optim", "==", "'sgdm'", ":", "\n", "        ", "return", "optim", ".", "SGD", "(", "params", ",", "opt", ".", "learning_rate", ",", "opt", ".", "optim_alpha", ",", "weight_decay", "=", "opt", ".", "weight_decay", ")", "\n", "", "elif", "opt", ".", "optim", "==", "'sgdmom'", ":", "\n", "        ", "return", "optim", ".", "SGD", "(", "params", ",", "opt", ".", "learning_rate", ",", "opt", ".", "optim_alpha", ",", "weight_decay", "=", "opt", ".", "weight_decay", ",", "nesterov", "=", "True", ")", "\n", "", "elif", "opt", ".", "optim", "==", "'adam'", ":", "\n", "        ", "return", "optim", ".", "Adam", "(", "params", ",", "opt", ".", "learning_rate", ",", "(", "opt", ".", "optim_alpha", ",", "opt", ".", "optim_beta", ")", ",", "opt", ".", "optim_epsilon", ",", "weight_decay", "=", "opt", ".", "weight_decay", ")", "\n", "", "else", ":", "\n", "        ", "raise", "Exception", "(", "\"bad option opt.optim: {}\"", ".", "format", "(", "opt", ".", "optim", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.get_std_opt": [[219, 224], ["utils.NoamOpt", "torch.optim.Adam", "torch.optim.Adam", "torch.optim.Adam", "model.parameters"], "function", ["None"], ["", "", "def", "get_std_opt", "(", "model", ",", "factor", "=", "1", ",", "warmup", "=", "2000", ")", ":", "\n", "# return NoamOpt(model.tgt_embed[0].d_model, 2, 4000,", "\n", "#         torch.optim.Adam(model.parameters(), lr=0, betas=(0.9, 0.98), eps=1e-9))", "\n", "    ", "return", "NoamOpt", "(", "model", ".", "model", ".", "tgt_embed", "[", "0", "]", ".", "d_model", ",", "factor", ",", "warmup", ",", "\n", "torch", ".", "optim", ".", "Adam", "(", "model", ".", "parameters", "(", ")", ",", "lr", "=", "0", ",", "betas", "=", "(", "0.9", ",", "0.98", ")", ",", "eps", "=", "1e-9", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.BoxRelationalEmbedding": [[225, 285], ["f_g.size", "torch.chunk", "torch.chunk", "torch.chunk", "torch.clamp", "torch.clamp", "torch.clamp", "torch.log", "torch.log", "torch.log", "torch.clamp", "torch.clamp", "torch.clamp", "torch.log", "torch.log", "torch.log", "torch.log", "torch.log", "torch.log", "torch.log", "torch.log", "torch.log", "delta_h.view.size", "delta_x.view.view", "delta_y.view.view", "delta_w.view.view", "delta_h.view.view", "torch.cat", "torch.cat", "torch.cat", "cx.view", "torch.abs", "torch.abs", "torch.abs", "cy.view", "torch.abs", "torch.abs", "torch.abs", "torch.arange().cuda", "torch.arange().cuda", "torch.arange().cuda", "dim_mat.view.view", "position_mat.view.view", "mul_mat.view.view", "torch.sin", "torch.sin", "torch.sin", "torch.cos", "torch.cos", "torch.cos", "torch.cat", "torch.cat", "torch.cat", "w.view", "h.view", "torch.pow", "torch.pow", "torch.pow", "torch.arange", "torch.arange", "torch.arange"], "function", ["None"], ["", "def", "BoxRelationalEmbedding", "(", "f_g", ",", "dim_g", "=", "64", ",", "wave_len", "=", "1000", ",", "trignometric_embedding", "=", "True", ")", ":", "\n", "    ", "\"\"\"\n    Given a tensor with bbox coordinates for detected objects on each batch image,\n    this function computes a matrix for each image\n\n    with entry (i,j) given by a vector representation of the\n    displacement between the coordinates of bbox_i, and bbox_j\n\n    input: np.array of shape=(batch_size, max_nr_bounding_boxes, 4)\n    output: np.array of shape=(batch_size, max_nr_bounding_boxes, max_nr_bounding_boxes, 64)\n    \"\"\"", "\n", "#returns a relational embedding for each pair of bboxes, with dimension = dim_g", "\n", "#follow implementation of https://github.com/heefe92/Relation_Networks-pytorch/blob/master/model.py#L1014-L1055", "\n", "\n", "batch_size", "=", "f_g", ".", "size", "(", "0", ")", "\n", "\n", "x_min", ",", "y_min", ",", "x_max", ",", "y_max", "=", "torch", ".", "chunk", "(", "f_g", ",", "4", ",", "dim", "=", "-", "1", ")", "\n", "\n", "cx", "=", "(", "x_min", "+", "x_max", ")", "*", "0.5", "\n", "cy", "=", "(", "y_min", "+", "y_max", ")", "*", "0.5", "\n", "w", "=", "(", "x_max", "-", "x_min", ")", "+", "1.", "\n", "h", "=", "(", "y_max", "-", "y_min", ")", "+", "1.", "\n", "\n", "#cx.view(1,-1) transposes the vector cx, and so dim(delta_x) = (dim(cx), dim(cx))", "\n", "delta_x", "=", "cx", "-", "cx", ".", "view", "(", "batch_size", ",", "1", ",", "-", "1", ")", "\n", "delta_x", "=", "torch", ".", "clamp", "(", "torch", ".", "abs", "(", "delta_x", "/", "w", ")", ",", "min", "=", "1e-3", ")", "\n", "delta_x", "=", "torch", ".", "log", "(", "delta_x", ")", "\n", "\n", "delta_y", "=", "cy", "-", "cy", ".", "view", "(", "batch_size", ",", "1", ",", "-", "1", ")", "\n", "delta_y", "=", "torch", ".", "clamp", "(", "torch", ".", "abs", "(", "delta_y", "/", "h", ")", ",", "min", "=", "1e-3", ")", "\n", "delta_y", "=", "torch", ".", "log", "(", "delta_y", ")", "\n", "\n", "delta_w", "=", "torch", ".", "log", "(", "w", "/", "w", ".", "view", "(", "batch_size", ",", "1", ",", "-", "1", ")", ")", "\n", "delta_h", "=", "torch", ".", "log", "(", "h", "/", "h", ".", "view", "(", "batch_size", ",", "1", ",", "-", "1", ")", ")", "\n", "\n", "matrix_size", "=", "delta_h", ".", "size", "(", ")", "\n", "delta_x", "=", "delta_x", ".", "view", "(", "batch_size", ",", "matrix_size", "[", "1", "]", ",", "matrix_size", "[", "2", "]", ",", "1", ")", "\n", "delta_y", "=", "delta_y", ".", "view", "(", "batch_size", ",", "matrix_size", "[", "1", "]", ",", "matrix_size", "[", "2", "]", ",", "1", ")", "\n", "delta_w", "=", "delta_w", ".", "view", "(", "batch_size", ",", "matrix_size", "[", "1", "]", ",", "matrix_size", "[", "2", "]", ",", "1", ")", "\n", "delta_h", "=", "delta_h", ".", "view", "(", "batch_size", ",", "matrix_size", "[", "1", "]", ",", "matrix_size", "[", "2", "]", ",", "1", ")", "\n", "\n", "position_mat", "=", "torch", ".", "cat", "(", "(", "delta_x", ",", "delta_y", ",", "delta_w", ",", "delta_h", ")", ",", "-", "1", ")", "\n", "\n", "if", "trignometric_embedding", "==", "True", ":", "\n", "        ", "feat_range", "=", "torch", ".", "arange", "(", "dim_g", "/", "8", ")", ".", "cuda", "(", ")", "\n", "dim_mat", "=", "feat_range", "/", "(", "dim_g", "/", "8", ")", "\n", "dim_mat", "=", "1.", "/", "(", "torch", ".", "pow", "(", "wave_len", ",", "dim_mat", ")", ")", "\n", "\n", "dim_mat", "=", "dim_mat", ".", "view", "(", "1", ",", "1", ",", "1", ",", "-", "1", ")", "\n", "position_mat", "=", "position_mat", ".", "view", "(", "batch_size", ",", "matrix_size", "[", "1", "]", ",", "matrix_size", "[", "2", "]", ",", "4", ",", "-", "1", ")", "\n", "position_mat", "=", "100.", "*", "position_mat", "\n", "\n", "mul_mat", "=", "position_mat", "*", "dim_mat", "\n", "mul_mat", "=", "mul_mat", ".", "view", "(", "batch_size", ",", "matrix_size", "[", "1", "]", ",", "matrix_size", "[", "2", "]", ",", "-", "1", ")", "\n", "sin_mat", "=", "torch", ".", "sin", "(", "mul_mat", ")", "\n", "cos_mat", "=", "torch", ".", "cos", "(", "mul_mat", ")", "\n", "embedding", "=", "torch", ".", "cat", "(", "(", "sin_mat", ",", "cos_mat", ")", ",", "-", "1", ")", "\n", "", "else", ":", "\n", "        ", "embedding", "=", "position_mat", "\n", "", "return", "(", "embedding", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.get_box_feats": [[287, 315], ["numpy.zeros", "range", "numpy.zeros", "range", "range", "range", "numpy.all", "numpy.concatenate", "numpy.all", "numpy.concatenate", "numpy.zeros", "numpy.zeros", "numpy.ones", "numpy.zeros", "numpy.zeros", "numpy.zeros", "numpy.ones", "numpy.zeros"], "function", ["None"], ["", "def", "get_box_feats", "(", "boxes", ",", "d", ")", ":", "\n", "    ", "\"\"\"\n    Given the bounding box coordinates for an object on an image, this function\n    generates the trivial horizontal, and vertical 0-1 vector encoding of the bbox.\n\n    This function is currently not used anywhere else in our codebase.\n    \"\"\"", "\n", "h", ",", "w", "=", "boxes", ".", "shape", "[", ":", "2", "]", "\n", "boxes_times_d", "=", "(", "d", "*", "boxes", ")", ".", "astype", "(", "np", ".", "int32", ")", "\n", "boxes_wmin", "=", "boxes_times_d", "[", ":", ",", ":", ",", "0", "]", "\n", "boxes_wmax", "=", "boxes_times_d", "[", ":", ",", ":", ",", "2", "]", "\n", "boxes_hmin", "=", "boxes_times_d", "[", ":", ",", ":", ",", "1", "]", "\n", "boxes_hmax", "=", "boxes_times_d", "[", ":", ",", ":", ",", "3", "]", "\n", "\n", "box_hfeats", "=", "np", ".", "zeros", "(", "(", "h", ",", "w", ",", "d", ")", ")", "\n", "for", "i", "in", "range", "(", "h", ")", ":", "\n", "        ", "for", "j", "in", "range", "(", "w", ")", ":", "\n", "            ", "if", "not", "np", ".", "all", "(", "boxes_times_d", "[", "i", ",", "j", "]", "==", "np", ".", "zeros", "(", "4", ")", ")", ":", "\n", "                ", "h_vector", "=", "np", ".", "concatenate", "(", "[", "np", ".", "zeros", "(", "boxes_hmin", "[", "i", ",", "j", "]", ")", ",", "np", ".", "ones", "(", "boxes_hmax", "[", "i", ",", "j", "]", "-", "boxes_hmin", "[", "i", ",", "j", "]", ")", ",", "np", ".", "zeros", "(", "d", "-", "boxes_hmax", "[", "i", ",", "j", "]", ")", "]", ")", "\n", "box_hfeats", "[", "i", ",", "j", "]", "+=", "h_vector", "\n", "\n", "", "", "", "box_wfeats", "=", "np", ".", "zeros", "(", "(", "h", ",", "w", ",", "d", ")", ")", "\n", "for", "i", "in", "range", "(", "h", ")", ":", "\n", "        ", "for", "j", "in", "range", "(", "w", ")", ":", "\n", "            ", "if", "not", "np", ".", "all", "(", "boxes_times_d", "[", "i", ",", "j", "]", "==", "np", ".", "zeros", "(", "4", ")", ")", ":", "\n", "                ", "w_vector", "=", "np", ".", "concatenate", "(", "[", "np", ".", "zeros", "(", "boxes_wmin", "[", "i", ",", "j", "]", ")", ",", "np", ".", "ones", "(", "boxes_wmax", "[", "i", ",", "j", "]", "-", "boxes_wmin", "[", "i", ",", "j", "]", ")", ",", "np", ".", "zeros", "(", "d", "-", "boxes_wmax", "[", "i", ",", "j", "]", ")", "]", ")", "\n", "box_wfeats", "[", "i", ",", "j", "]", "+=", "w_vector", "\n", "", "", "", "return", "(", "box_hfeats", ",", "box_wfeats", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.single_image_get_box_feats": [[316, 338], ["numpy.zeros", "range", "numpy.zeros", "range", "numpy.all", "numpy.concatenate", "numpy.all", "numpy.concatenate", "numpy.zeros", "numpy.zeros", "numpy.ones", "numpy.zeros", "numpy.zeros", "numpy.zeros", "numpy.ones", "numpy.zeros"], "function", ["None"], ["", "def", "single_image_get_box_feats", "(", "boxes", ",", "d", ")", ":", "\n", "    ", "h", "=", "boxes", ".", "shape", "[", "0", "]", "\n", "boxes_times_d", "=", "(", "d", "*", "boxes", ")", ".", "astype", "(", "np", ".", "int32", ")", "\n", "boxes_wmin", "=", "boxes_times_d", "[", ":", ",", "0", "]", "\n", "boxes_wmax", "=", "boxes_times_d", "[", ":", ",", "2", "]", "\n", "boxes_hmin", "=", "boxes_times_d", "[", ":", ",", "1", "]", "\n", "boxes_hmax", "=", "boxes_times_d", "[", ":", ",", "3", "]", "\n", "\n", "box_hfeats", "=", "np", ".", "zeros", "(", "(", "h", ",", "d", ")", ")", "\n", "for", "i", "in", "range", "(", "h", ")", ":", "\n", "#for j in range(w):", "\n", "            ", "if", "not", "np", ".", "all", "(", "boxes_times_d", "[", "i", "]", "==", "np", ".", "zeros", "(", "4", ")", ")", ":", "\n", "                ", "h_vector", "=", "np", ".", "concatenate", "(", "[", "np", ".", "zeros", "(", "boxes_hmin", "[", "i", "]", ")", ",", "np", ".", "ones", "(", "boxes_hmax", "[", "i", "]", "-", "boxes_hmin", "[", "i", "]", ")", ",", "np", ".", "zeros", "(", "d", "-", "boxes_hmax", "[", "i", "]", ")", "]", ")", "\n", "box_hfeats", "[", "i", "]", "+=", "h_vector", "\n", "\n", "", "", "box_wfeats", "=", "np", ".", "zeros", "(", "(", "h", ",", "d", ")", ")", "\n", "for", "i", "in", "range", "(", "h", ")", ":", "\n", "#for j in range(w):", "\n", "            ", "if", "not", "np", ".", "all", "(", "boxes_times_d", "[", "i", "]", "==", "np", ".", "zeros", "(", "4", ")", ")", ":", "\n", "                ", "w_vector", "=", "np", ".", "concatenate", "(", "[", "np", ".", "zeros", "(", "boxes_wmin", "[", "i", "]", ")", ",", "np", ".", "ones", "(", "boxes_wmax", "[", "i", "]", "-", "boxes_wmin", "[", "i", "]", ")", ",", "np", ".", "zeros", "(", "d", "-", "boxes_wmax", "[", "i", "]", ")", "]", ")", "\n", "box_wfeats", "[", "i", "]", "+=", "w_vector", "\n", "", "", "return", "(", "box_hfeats", ",", "box_wfeats", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.get_box_areas": [[339, 341], ["None"], "function", ["None"], ["", "def", "get_box_areas", "(", "arr", ")", ":", "\n", "    ", "return", "(", "(", "arr", "[", ":", ",", "2", "]", "-", "arr", "[", ":", ",", "0", "]", ")", "*", "(", "arr", "[", ":", ",", "3", "]", "-", "arr", "[", ":", ",", "1", "]", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.torch_get_box_feats": [[342, 367], ["torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "range", "torch.zeros", "torch.zeros", "torch.zeros", "range", "range", "range", "torch.all", "torch.all", "torch.all", "torch.cat", "torch.cat", "torch.cat", "all", "torch.cat", "torch.cat", "torch.cat", "torch.zeros", "torch.zeros", "torch.zeros", "torch.ones", "torch.ones", "torch.ones", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.zeros", "torch.ones", "torch.ones", "torch.ones", "torch.zeros", "torch.zeros", "torch.zeros"], "function", ["None"], ["", "def", "torch_get_box_feats", "(", "boxes", ",", "d", ")", ":", "\n", "    ", "device", "=", "boxes", ".", "device", "\n", "h", ",", "w", "=", "boxes", ".", "shape", "[", ":", "2", "]", "\n", "boxes_times_d", "=", "(", "d", "*", "boxes", ")", ".", "type", "(", "torch", ".", "int32", ")", "\n", "boxes_wmin", "=", "boxes_times_d", "[", ":", ",", ":", ",", "0", "]", "\n", "boxes_wmax", "=", "boxes_times_d", "[", ":", ",", ":", ",", "2", "]", "\n", "boxes_hmin", "=", "boxes_times_d", "[", ":", ",", ":", ",", "1", "]", "\n", "boxes_hmax", "=", "boxes_times_d", "[", ":", ",", ":", ",", "3", "]", "\n", "\n", "box_hfeats", "=", "torch", ".", "zeros", "(", "(", "h", ",", "w", ",", "d", ")", ",", "device", "=", "device", ")", "\n", "zero_fourtuple", "=", "torch", ".", "zeros", "(", "4", ",", "dtype", "=", "torch", ".", "int32", ",", "device", "=", "device", ")", "\n", "\n", "for", "i", "in", "range", "(", "h", ")", ":", "\n", "        ", "for", "j", "in", "range", "(", "w", ")", ":", "\n", "            ", "if", "not", "torch", ".", "all", "(", "boxes_times_d", "[", "i", ",", "j", "]", "==", "zero_fourtuple", ")", ":", "\n", "                ", "h_vector", "=", "torch", ".", "cat", "(", "[", "torch", ".", "zeros", "(", "boxes_hmin", "[", "i", ",", "j", "]", ",", "device", "=", "device", ")", ",", "torch", ".", "ones", "(", "boxes_hmax", "[", "i", ",", "j", "]", "-", "boxes_hmin", "[", "i", ",", "j", "]", ",", "device", "=", "device", ")", ",", "torch", ".", "zeros", "(", "d", "-", "boxes_hmax", "[", "i", ",", "j", "]", ",", "device", "=", "device", ")", "]", ")", "\n", "box_hfeats", "[", "i", ",", "j", "]", "+=", "h_vector", "\n", "\n", "", "", "", "box_wfeats", "=", "torch", ".", "zeros", "(", "(", "h", ",", "w", ",", "d", ")", ",", "device", "=", "device", ")", "\n", "for", "i", "in", "range", "(", "h", ")", ":", "\n", "        ", "for", "j", "in", "range", "(", "w", ")", ":", "\n", "            ", "if", "not", "all", "(", "boxes_times_d", "[", "i", ",", "j", "]", "==", "zero_fourtuple", ")", ":", "\n", "                ", "w_vector", "=", "torch", ".", "cat", "(", "[", "torch", ".", "zeros", "(", "boxes_wmin", "[", "i", ",", "j", "]", ",", "device", "=", "device", ")", ",", "torch", ".", "ones", "(", "boxes_wmax", "[", "i", ",", "j", "]", "-", "boxes_wmin", "[", "i", ",", "j", "]", ",", "device", "=", "device", ")", ",", "torch", ".", "zeros", "(", "d", "-", "boxes_wmax", "[", "i", ",", "j", "]", ",", "device", "=", "device", ")", "]", ")", "\n", "box_wfeats", "[", "i", ",", "j", "]", "+=", "w_vector", "\n", "", "", "", "return", "(", "box_hfeats", ",", "box_wfeats", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.utils.want_to_continue": [[369, 383], ["print", "print", "raw_input().lower", "raw_input", "sys.stdout.write"], "function", ["None"], ["", "def", "want_to_continue", "(", "found_issue", ")", ":", "\n", "    ", "print", "(", "'--'", "*", "10", ")", "\n", "print", "(", "found_issue", "+", "'. Would you like to continue? [y/N]'", ")", "\n", "\n", "yes", "=", "{", "'yes'", ",", "'y'", ",", "'ye'", ",", "'Y'", "}", "\n", "no", "=", "{", "'no'", ",", "'n'", ",", "''", ",", "'N'", "}", "\n", "\n", "choice", "=", "raw_input", "(", ")", ".", "lower", "(", ")", "\n", "if", "choice", "in", "yes", ":", "\n", "        ", "return", "True", "\n", "", "elif", "choice", "in", "no", ":", "\n", "        ", "return", "False", "\n", "", "else", ":", "\n", "        ", "sys", ".", "stdout", ".", "write", "(", "\"Please respond with 'y' or 'N'\"", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__": [[6, 9], ["torch.Module.__init__"], "methods", ["home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.__init__"], ["    ", "def", "__init__", "(", "self", ",", "resnet", ")", ":", "\n", "        ", "super", "(", "myResnet", ",", "self", ")", ".", "__init__", "(", ")", "\n", "self", ".", "resnet", "=", "resnet", "\n", "\n"]], "home.repos.pwc.inspect_result.yahoo_object_relation_transformer.misc.resnet_utils.myResnet.forward": [[10, 27], ["img.unsqueeze", "resnet_utils.myResnet.resnet.conv1", "resnet_utils.myResnet.resnet.bn1", "resnet_utils.myResnet.resnet.relu", "resnet_utils.myResnet.resnet.maxpool", "resnet_utils.myResnet.resnet.layer1", "resnet_utils.myResnet.resnet.layer2", "resnet_utils.myResnet.resnet.layer3", "resnet_utils.myResnet.resnet.layer4", "resnet_utils.myResnet.mean().mean().squeeze", "torch.adaptive_avg_pool2d().squeeze().permute", "torch.adaptive_avg_pool2d().squeeze().permute", "torch.adaptive_avg_pool2d().squeeze().permute", "resnet_utils.myResnet.mean().mean", "torch.adaptive_avg_pool2d().squeeze", "torch.adaptive_avg_pool2d().squeeze", "torch.adaptive_avg_pool2d().squeeze", "resnet_utils.myResnet.mean", "torch.adaptive_avg_pool2d", "torch.adaptive_avg_pool2d", "torch.adaptive_avg_pool2d"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "img", ",", "att_size", "=", "14", ")", ":", "\n", "        ", "x", "=", "img", ".", "unsqueeze", "(", "0", ")", "\n", "\n", "x", "=", "self", ".", "resnet", ".", "conv1", "(", "x", ")", "\n", "x", "=", "self", ".", "resnet", ".", "bn1", "(", "x", ")", "\n", "x", "=", "self", ".", "resnet", ".", "relu", "(", "x", ")", "\n", "x", "=", "self", ".", "resnet", ".", "maxpool", "(", "x", ")", "\n", "\n", "x", "=", "self", ".", "resnet", ".", "layer1", "(", "x", ")", "\n", "x", "=", "self", ".", "resnet", ".", "layer2", "(", "x", ")", "\n", "x", "=", "self", ".", "resnet", ".", "layer3", "(", "x", ")", "\n", "x", "=", "self", ".", "resnet", ".", "layer4", "(", "x", ")", "\n", "\n", "fc", "=", "x", ".", "mean", "(", "3", ")", ".", "mean", "(", "2", ")", ".", "squeeze", "(", ")", "\n", "att", "=", "F", ".", "adaptive_avg_pool2d", "(", "x", ",", "[", "att_size", ",", "att_size", "]", ")", ".", "squeeze", "(", ")", ".", "permute", "(", "1", ",", "2", ",", "0", ")", "\n", "\n", "return", "fc", ",", "att", "\n", "\n"]]}