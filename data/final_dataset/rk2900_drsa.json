{"home.repos.pwc.inspect_result.rk2900_drsa.python.feateng_support.build_feat_index": [[33, 58], ["feat_index_lines.append", "range", "len", "feat_index_lines.append", "range", "open", "f.writelines", "feat_index_lines.append"], "function", ["None"], ["def", "build_feat_index", "(", "feat_index_f", ")", ":", "\n", "    ", "max_index", "=", "0", "\n", "feat_index_lines", "=", "[", "]", "\n", "\n", "# truncate", "\n", "feat_index", "[", "\"0:truncate\"", "]", "=", "max_index", "\n", "feat_index_lines", ".", "append", "(", "\"0:truncate\\t{}\\n\"", ".", "format", "(", "max_index", ")", ")", "\n", "max_index", "+=", "1", "\n", "\n", "for", "i", "in", "range", "(", "len", "(", "features", ")", ")", ":", "\n", "        ", "feat_num", "=", "i", "+", "1", "\n", "# other", "\n", "feat_index", "[", "\"{}:other\"", ".", "format", "(", "feat_num", ")", "]", "=", "max_index", "\n", "feat_index_lines", ".", "append", "(", "\"{}:other\\t{}\\n\"", ".", "format", "(", "feat_num", ",", "max_index", ")", ")", "\n", "max_index", "+=", "1", "\n", "# normal values", "\n", "width", "=", "feat_size", "[", "features", "[", "i", "]", "]", "\n", "for", "value", "in", "range", "(", "width", "-", "1", ")", ":", "\n", "            ", "feat_index", "[", "\"{}:{}\"", ".", "format", "(", "feat_num", ",", "value", ")", "]", "=", "max_index", "\n", "feat_index_lines", ".", "append", "(", "\"{}:{}\\t{}\\n\"", ".", "format", "(", "feat_num", ",", "value", ",", "max_index", ")", ")", "\n", "max_index", "+=", "1", "\n", "\n", "# write feat_index file:", "\n", "", "", "with", "open", "(", "feat_index_f", ",", "'w'", ")", "as", "f", ":", "\n", "        ", "f", ".", "writelines", "(", "feat_index_lines", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.feateng_support.get_feat_val": [[59, 66], ["int", "int", "int", "float", "float", "float"], "function", ["None"], ["", "", "def", "get_feat_val", "(", "feat_name", ",", "str_val", ")", ":", "\n", "    ", "if", "feat_name", "==", "\"sodium\"", ":", "\n", "        ", "return", "int", "(", "float", "(", "str_val", ")", "*", "2.5", ")", "\n", "", "elif", "feat_name", "==", "\"creatinine\"", ":", "\n", "        ", "return", "int", "(", "float", "(", "str_val", ")", "*", "6", ")", "\n", "", "else", ":", "\n", "        ", "return", "int", "(", "float", "(", "str_val", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.feateng_support.build_yzbx_data": [[68, 106], ["range", "len", "open", "f.readlines", "open", "f.writelines", "x_items.append", "line.split", "range", "int", "yzbx_list.append", "feateng_support.get_feat_val", "x_items.append", "int", "float", "random.randint", "random.randint", "len", "feat_index.keys", "float", "str", "str", "str"], "function", ["home.repos.pwc.inspect_result.rk2900_drsa.python.feateng_support.get_feat_val"], ["", "", "def", "build_yzbx_data", "(", "raw_train", ",", "raw_test", ",", "yzbx_train", ",", "yzbx_test", ")", ":", "\n", "    ", "fnames_i", "=", "[", "raw_train", ",", "raw_test", "]", "\n", "fnames_o", "=", "[", "yzbx_train", ",", "yzbx_test", "]", "\n", "\n", "for", "j", "in", "range", "(", "len", "(", "fnames_i", ")", ")", ":", "\n", "        ", "yzbx_list", "=", "[", "]", "\n", "with", "open", "(", "fnames_i", "[", "j", "]", ",", "'r'", ")", "as", "f", ":", "\n", "            ", "lines", "=", "f", ".", "readlines", "(", ")", "\n", "for", "line", "in", "lines", ":", "\n", "                ", "x_items", "=", "[", "]", "\n", "# truncate", "\n", "x_items", ".", "append", "(", "\"0:1\"", ")", "\n", "line_items", "=", "line", ".", "split", "(", "','", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "line_items", ")", "-", "2", ")", ":", "\n", "                    ", "feat_num", "=", "i", "+", "1", "\n", "feat_name", "=", "features", "[", "i", "]", "\n", "feat_val", "=", "get_feat_val", "(", "feat_name", ",", "line_items", "[", "i", "]", ")", "\n", "key", "=", "\"{}:{}\"", ".", "format", "(", "feat_num", ",", "feat_val", ")", "\n", "if", "key", "not", "in", "feat_index", ".", "keys", "(", ")", ":", "\n", "                        ", "key", "=", "\"{}:other\"", ".", "format", "(", "feat_num", ")", "\n", "", "x_items", ".", "append", "(", "\"{}:1\"", ".", "format", "(", "feat_index", "[", "key", "]", ")", ")", "\n", "# get b and z", "\n", "# t from hour to day", "\n", "", "t", "=", "int", "(", "float", "(", "line_items", "[", "-", "2", "]", ")", "/", "24", ")", "+", "1", "\n", "e", "=", "int", "(", "float", "(", "line_items", "[", "-", "1", "]", ")", ")", "\n", "if", "e", "==", "1", ":", "\n", "                    ", "z", "=", "t", "\n", "b", "=", "random", ".", "randint", "(", "z", "+", "1", ",", "2", "*", "(", "z", "+", "1", ")", ")", "\n", "", "else", ":", "\n", "                    ", "b", "=", "t", "\n", "z", "=", "random", ".", "randint", "(", "b", "+", "1", ",", "2", "*", "(", "b", "+", "1", ")", ")", "\n", "# dummy y", "\n", "", "y", "=", "0", "\n", "yzbx", "=", "' '", ".", "join", "(", "[", "str", "(", "y", ")", ",", "str", "(", "z", ")", ",", "str", "(", "b", ")", "]", "+", "x_items", ")", "\n", "yzbx_list", ".", "append", "(", "yzbx", "+", "'\\n'", ")", "\n", "\n", "", "", "with", "open", "(", "fnames_o", "[", "j", "]", ",", "'w'", ")", "as", "f", ":", "\n", "            ", "f", ".", "writelines", "(", "yzbx_list", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.feateng_support.feat_stat": [[108, 134], ["set", "open", "f.readlines", "open", "f.readlines", "print", "print", "line.split", "range", "line.split", "range", "feat_dict[].add", "feat_dict[].add", "max", "min", "len", "len", "float", "len", "float"], "function", ["None"], ["", "", "", "def", "feat_stat", "(", "train", ",", "test", ")", ":", "\n", "    ", "for", "feat", "in", "features", ":", "\n", "        ", "feat_dict", "[", "feat", "]", "=", "set", "(", ")", "\n", "\n", "# train", "\n", "", "with", "open", "(", "train", ",", "'r'", ")", "as", "f", ":", "\n", "        ", "lines", "=", "f", ".", "readlines", "(", ")", "\n", "for", "line", "in", "lines", ":", "\n", "            ", "items", "=", "line", ".", "split", "(", "','", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "items", ")", "-", "2", ")", ":", "\n", "                ", "feat_name", "=", "features", "[", "i", "]", "\n", "feat_dict", "[", "feat_name", "]", ".", "add", "(", "float", "(", "items", "[", "i", "]", ")", ")", "\n", "# test", "\n", "", "", "", "with", "open", "(", "test", ",", "'r'", ")", "as", "f", ":", "\n", "        ", "lines", "=", "f", ".", "readlines", "(", ")", "\n", "for", "line", "in", "lines", ":", "\n", "            ", "items", "=", "line", ".", "split", "(", "','", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "items", ")", "-", "2", ")", ":", "\n", "                ", "feat_name", "=", "features", "[", "i", "]", "\n", "feat_dict", "[", "feat_name", "]", ".", "add", "(", "float", "(", "items", "[", "i", "]", ")", ")", "\n", "\n", "# print result", "\n", "", "", "", "for", "feat", "in", "features", ":", "\n", "        ", "stats", "=", "feat_dict", "[", "feat", "]", "\n", "print", "(", "\"{} result:\"", ".", "format", "(", "feat", ")", ")", "\n", "print", "(", "\"max value:{0}    min value:{1}   distinct cnt:{2}\"", ".", "format", "(", "max", "(", "stats", ")", ",", "min", "(", "stats", ")", ",", "len", "(", "stats", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.feateng_support.main": [[136, 139], ["feateng_support.feat_stat"], "function", ["home.repos.pwc.inspect_result.rk2900_drsa.python.feateng_support.feat_stat"], ["", "", "def", "main", "(", "args", ")", ":", "\n", "# calculate statistical results on dataset", "\n", "    ", "feat_stat", "(", "args", ".", "raw_train", ",", "args", ".", "raw_test", ")", "\n", "# build_feat_index(args.featindex)", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.deephit.DeepHit.__init__": [[18, 110], ["util_train.get_data_amt", "util_test.get_data_amt", "tensorflow.reset_default_graph", "len", "tensorflow.placeholder", "tensorflow.placeholder", "tensorflow.placeholder", "tensorflow.Variable", "range", "tensorflow.concat", "tensorflow.Variable", "tensorflow.Variable", "tensorflow.Variable", "tensorflow.Variable", "tensorflow.nn.relu", "tensorflow.sigmoid", "tensorflow.nn.relu", "tensorflow.sigmoid", "tensorflow.nn.softmax", "tensorflow.cumsum", "tensorflow.stack", "tensorflow.stack", "tensorflow.gather_nd", "tensorflow.gather_nd", "tensorflow.gather_nd", "tensorflow.transpose", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.exp", "tensorflow.reduce_sum", "tensorflow.train.GradientDescentOptimizer", "deephit.DeepHit.optimizer.minimize", "tensorflow.ConfigProto", "tensorflow.Session", "tensorflow.global_variables_initializer().run", "os.path.exists", "os.makedirs", "tensorflow.sparse_placeholder", "tensorflow.truncated_normal", "tensorflow.Variable", "tensorflow.matmul", "tensorflow.matmul", "tensorflow.matmul", "tensorflow.matmul", "tensorflow.reduce_sum", "tensorflow.reduce_sum", "tensorflow.nn.l2_loss", "tensorflow.nn.embedding_lookup", "tensorflow.tile", "tensorflow.tile", "range", "tensorflow.truncated_normal", "range", "tensorflow.sparse_tensor_dense_matmul", "tensorflow.truncated_normal", "tensorflow.truncated_normal", "tensorflow.truncated_normal", "tensorflow.truncated_normal", "tensorflow.reshape", "tensorflow.cast", "tensorflow.reshape", "tensorflow.cast", "tensorflow.nn.l2_loss", "tensorflow.transpose", "tensorflow.cast", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.matrix_band_part", "tensorflow.global_variables_initializer", "range", "tensorflow.range", "tensorflow.range", "tensorflow.log", "tensorflow.log", "tensorflow.nn.l2_loss", "tensorflow.nn.l2_loss", "tensorflow.clip_by_value", "tensorflow.clip_by_value", "tensorflow.shape", "tensorflow.shape"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_data_amt", "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_data_amt"], ["    ", "def", "__init__", "(", "self", ",", "lr", ",", "batch_size", ",", "dimension", ",", "util_train", ",", "util_test", ",", "campaign", ",", "reg_lambda", ",", "sigma", ")", ":", "\n", "# hyperparameters", "\n", "        ", "self", ".", "lr", "=", "lr", "\n", "self", ".", "batch_size", "=", "batch_size", "\n", "self", ".", "util_train", "=", "util_train", "\n", "self", ".", "util_test", "=", "util_test", "\n", "self", ".", "reg_lambda", "=", "reg_lambda", "\n", "self", ".", "sigma", "=", "sigma", "\n", "self", ".", "emb_size", "=", "20", "\n", "\n", "self", ".", "train_data_amt", "=", "util_train", ".", "get_data_amt", "(", ")", "\n", "self", ".", "test_data_amt", "=", "util_test", ".", "get_data_amt", "(", ")", "\n", "\n", "# output dir", "\n", "model_name", "=", "\"{}_{}_{}_{}\"", ".", "format", "(", "self", ".", "lr", ",", "self", ".", "reg_lambda", ",", "self", ".", "batch_size", ",", "self", ".", "sigma", ")", "\n", "self", ".", "output_dir", "=", "\"output/deephit/{}/{}/\"", ".", "format", "(", "campaign", ",", "model_name", ")", "\n", "if", "not", "os", ".", "path", ".", "exists", "(", "self", ".", "output_dir", ")", ":", "\n", "            ", "os", ".", "makedirs", "(", "self", ".", "output_dir", ")", "\n", "\n", "# reset graph", "\n", "", "tf", ".", "reset_default_graph", "(", ")", "\n", "\n", "# field params", "\n", "self", ".", "field_sizes", "=", "self", ".", "util_train", ".", "feat_sizes", "\n", "self", ".", "field_num", "=", "len", "(", "self", ".", "field_sizes", ")", "\n", "\n", "# placeholders", "\n", "self", ".", "X", "=", "[", "tf", ".", "sparse_placeholder", "(", "tf", ".", "float64", ")", "for", "i", "in", "range", "(", "0", ",", "self", ".", "field_num", ")", "]", "\n", "self", ".", "z", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "self", ".", "b", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "self", ".", "y", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "\n", "# embedding layer", "\n", "self", ".", "var_map", "=", "{", "}", "\n", "# for truncated", "\n", "self", ".", "var_map", "[", "'embed_0'", "]", "=", "tf", ".", "Variable", "(", "\n", "tf", ".", "truncated_normal", "(", "[", "self", ".", "field_sizes", "[", "0", "]", ",", "1", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ")", "\n", "for", "i", "in", "range", "(", "1", ",", "self", ".", "field_num", ")", ":", "\n", "            ", "self", ".", "var_map", "[", "'embed_%d'", "%", "i", "]", "=", "tf", ".", "Variable", "(", "\n", "tf", ".", "truncated_normal", "(", "[", "self", ".", "field_sizes", "[", "i", "]", ",", "self", ".", "emb_size", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ")", "\n", "\n", "# after embedding", "\n", "", "w0", "=", "[", "self", ".", "var_map", "[", "'embed_%d'", "%", "i", "]", "for", "i", "in", "range", "(", "self", ".", "field_num", ")", "]", "\n", "self", ".", "dense_input", "=", "tf", ".", "concat", "(", "[", "tf", ".", "sparse_tensor_dense_matmul", "(", "self", ".", "X", "[", "i", "]", ",", "w0", "[", "i", "]", ")", "for", "i", "in", "range", "(", "self", ".", "field_num", ")", "]", ",", "1", ")", "\n", "\n", "# shared network", "\n", "self", ".", "hidden1", "=", "tf", ".", "Variable", "(", "initial_value", "=", "tf", ".", "truncated_normal", "(", "shape", "=", "[", "(", "self", ".", "field_num", "-", "1", ")", "*", "self", ".", "emb_size", "+", "1", ",", "HIDDEN_SIZE1", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ",", "name", "=", "'h1'", ")", "\n", "self", ".", "out1", "=", "tf", ".", "Variable", "(", "initial_value", "=", "tf", ".", "truncated_normal", "(", "shape", "=", "[", "HIDDEN_SIZE1", ",", "OUT_SIZE1", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ",", "name", "=", "'o1'", ")", "\n", "self", ".", "hidden2", "=", "tf", ".", "Variable", "(", "initial_value", "=", "tf", ".", "truncated_normal", "(", "shape", "=", "[", "OUT_SIZE1", ",", "HIDDEN_SIZE2", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ",", "name", "=", "'h2'", ")", "\n", "self", ".", "out2", "=", "tf", ".", "Variable", "(", "initial_value", "=", "tf", ".", "truncated_normal", "(", "shape", "=", "[", "HIDDEN_SIZE2", ",", "OUT_SIZE2", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ",", "name", "=", "'o2'", ")", "\n", "\n", "# cause-specific network", "\n", "self", ".", "hidden1_val", "=", "tf", ".", "nn", ".", "relu", "(", "tf", ".", "matmul", "(", "self", ".", "dense_input", ",", "self", ".", "hidden1", ")", ")", "\n", "self", ".", "out1_val", "=", "tf", ".", "sigmoid", "(", "tf", ".", "matmul", "(", "self", ".", "hidden1_val", ",", "self", ".", "out1", ")", ")", "\n", "self", ".", "hidden2_val", "=", "tf", ".", "nn", ".", "relu", "(", "tf", ".", "matmul", "(", "self", ".", "out1_val", ",", "self", ".", "hidden2", ")", ")", "\n", "self", ".", "out2_val", "=", "tf", ".", "sigmoid", "(", "tf", ".", "matmul", "(", "self", ".", "hidden2_val", ",", "self", ".", "out2", ")", ")", "\n", "\n", "# p_z and w_b", "\n", "self", ".", "p", "=", "tf", ".", "nn", ".", "softmax", "(", "self", ".", "out2_val", ")", "\n", "self", ".", "w", "=", "tf", ".", "cumsum", "(", "self", ".", "p", ",", "exclusive", "=", "True", ",", "axis", "=", "1", ")", "\n", "\n", "idx_z", "=", "tf", ".", "stack", "(", "[", "tf", ".", "reshape", "(", "tf", ".", "range", "(", "tf", ".", "shape", "(", "self", ".", "z", ")", "[", "0", "]", ")", ",", "(", "-", "1", ",", "1", ")", ")", ",", "tf", ".", "cast", "(", "self", ".", "z", "-", "1", ",", "tf", ".", "int32", ")", "]", ",", "axis", "=", "-", "1", ")", "\n", "idx_b", "=", "tf", ".", "stack", "(", "[", "tf", ".", "reshape", "(", "tf", ".", "range", "(", "tf", ".", "shape", "(", "self", ".", "b", ")", "[", "0", "]", ")", ",", "(", "-", "1", ",", "1", ")", ")", ",", "tf", ".", "cast", "(", "self", ".", "b", "-", "1", ",", "tf", ".", "int32", ")", "]", ",", "axis", "=", "-", "1", ")", "\n", "\n", "self", ".", "pz", "=", "tf", ".", "gather_nd", "(", "self", ".", "p", ",", "idx_z", ")", "\n", "self", ".", "wb", "=", "tf", ".", "gather_nd", "(", "self", ".", "w", ",", "idx_b", ")", "\n", "self", ".", "wz", "=", "tf", ".", "gather_nd", "(", "self", ".", "w", ",", "idx_z", ")", "\n", "\n", "# loss and train step", "\n", "self", ".", "loss1", "=", "-", "tf", ".", "reduce_sum", "(", "tf", ".", "log", "(", "tf", ".", "clip_by_value", "(", "self", ".", "pz", ",", "1e-8", ",", "1.0", ")", ")", "*", "self", ".", "y", ")", "\n", "self", ".", "loss2", "=", "-", "tf", ".", "reduce_sum", "(", "tf", ".", "log", "(", "tf", ".", "clip_by_value", "(", "1", "-", "self", ".", "wb", ",", "1e-8", ",", "1.0", ")", ")", "*", "(", "1", "-", "self", ".", "y", ")", ")", "\n", "self", ".", "reg_loss", "=", "tf", ".", "nn", ".", "l2_loss", "(", "self", ".", "hidden1", "[", "1", ":", ",", "]", ")", "+", "tf", ".", "nn", ".", "l2_loss", "(", "self", ".", "hidden2", "[", "1", ":", ",", "]", ")", "+", "tf", ".", "nn", ".", "l2_loss", "(", "self", ".", "out1", "[", "1", ":", ",", "]", ")", "+", "tf", ".", "nn", ".", "l2_loss", "(", "self", ".", "out2", "[", "1", ":", ",", "]", ")", "\n", "\n", "# get ranking loss", "\n", "self", ".", "w_of_pair", "=", "tf", ".", "transpose", "(", "tf", ".", "nn", ".", "embedding_lookup", "(", "tf", ".", "transpose", "(", "self", ".", "w", ")", ",", "tf", ".", "cast", "(", "self", ".", "z", "[", ":", ",", "0", "]", "-", "1", ",", "tf", ".", "int32", ")", ")", ")", "\n", "self", ".", "w_of_self", "=", "tf", ".", "reshape", "(", "tf", ".", "tile", "(", "tf", ".", "reshape", "(", "self", ".", "wz", ",", "(", "self", ".", "batch_size", ",", ")", ")", ",", "[", "self", ".", "batch_size", "]", ")", ",", "(", "self", ".", "batch_size", ",", "self", ".", "batch_size", ")", ")", "\n", "self", ".", "win_label", "=", "tf", ".", "reshape", "(", "tf", ".", "tile", "(", "tf", ".", "reshape", "(", "self", ".", "y", ",", "(", "self", ".", "batch_size", ",", ")", ")", ",", "[", "self", ".", "batch_size", "]", ")", ",", "(", "self", ".", "batch_size", ",", "self", ".", "batch_size", ")", ")", "\n", "self", ".", "delta", "=", "self", ".", "w_of_self", "-", "self", ".", "w_of_pair", "\n", "self", ".", "candidate", "=", "tf", ".", "exp", "(", "-", "self", ".", "delta", "/", "self", ".", "sigma", ")", "\n", "self", ".", "rank_loss", "=", "tf", ".", "reduce_sum", "(", "tf", ".", "matrix_band_part", "(", "self", ".", "candidate", ",", "-", "1", ",", "0", ")", "*", "self", ".", "win_label", ")", "\n", "\n", "self", ".", "loss", "=", "self", ".", "loss1", "+", "self", ".", "loss2", "+", "self", ".", "reg_lambda", "*", "self", ".", "reg_loss", "+", "self", ".", "rank_loss", "\n", "\n", "self", ".", "optimizer", "=", "tf", ".", "train", ".", "GradientDescentOptimizer", "(", "self", ".", "lr", ")", "\n", "self", ".", "train_step", "=", "self", ".", "optimizer", ".", "minimize", "(", "self", ".", "loss", ")", "\n", "\n", "# session initialization", "\n", "config", "=", "tf", ".", "ConfigProto", "(", ")", "\n", "config", ".", "gpu_options", ".", "allow_growth", "=", "True", "\n", "self", ".", "sess", "=", "tf", ".", "Session", "(", "config", "=", "config", ")", "\n", "tf", ".", "global_variables_initializer", "(", ")", ".", "run", "(", "session", "=", "self", ".", "sess", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.deephit.DeepHit.train": [[111, 150], ["matplotlib.plot", "matplotlib.plot", "matplotlib.savefig", "matplotlib.savefig", "matplotlib.gcf().clear", "matplotlib.gcf().clear", "deephit.DeepHit.util_train.get_batch_data_sorted", "range", "deephit.DeepHit.sess.run", "batch_loss.append", "len", "tensorflow.SparseTensorValue", "deephit.DeepHit.sess.run", "int", "numpy.mean", "loss_list.append", "print", "range", "matplotlib.gcf", "matplotlib.gcf", "len", "len", "int", "int", "int"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data_sorted"], ["", "def", "train", "(", "self", ")", ":", "\n", "        ", "step", "=", "0", "\n", "epoch", "=", "0", "\n", "batch_loss", "=", "[", "]", "\n", "loss_list", "=", "[", "]", "\n", "\n", "while", "True", ":", "\n", "            ", "x_batch_field", ",", "b_batch", ",", "z_batch", ",", "y_batch", "=", "self", ".", "util_train", ".", "get_batch_data_sorted", "(", "step", ")", "\n", "feed_dict", "=", "{", "}", "\n", "for", "j", "in", "range", "(", "len", "(", "self", ".", "X", ")", ")", ":", "\n", "                ", "feed_dict", "[", "self", ".", "X", "[", "j", "]", "]", "=", "tf", ".", "SparseTensorValue", "(", "x_batch_field", "[", "j", "]", ",", "[", "1", "]", "*", "len", "(", "x_batch_field", "[", "j", "]", ")", ",", "\n", "[", "self", ".", "batch_size", ",", "self", ".", "field_sizes", "[", "j", "]", "]", ")", "\n", "", "feed_dict", "[", "self", ".", "b", "]", "=", "b_batch", "\n", "feed_dict", "[", "self", ".", "z", "]", "=", "z_batch", "\n", "feed_dict", "[", "self", ".", "y", "]", "=", "y_batch", "\n", "\n", "self", ".", "sess", ".", "run", "(", "self", ".", "train_step", ",", "feed_dict", ")", "\n", "batch_loss", ".", "append", "(", "self", ".", "sess", ".", "run", "(", "self", ".", "loss", ",", "feed_dict", ")", ")", "\n", "step", "+=", "1", "\n", "\n", "if", "step", "*", "self", ".", "batch_size", "-", "epoch", "*", "int", "(", "0.02", "*", "self", ".", "train_data_amt", ")", ">=", "int", "(", "0.02", "*", "self", ".", "train_data_amt", ")", ":", "\n", "                ", "loss", "=", "np", ".", "mean", "(", "batch_loss", "[", "step", "-", "int", "(", "int", "(", "0.02", "*", "self", ".", "train_data_amt", ")", "/", "self", ".", "batch_size", ")", "-", "1", ":", "]", ")", "\n", "loss_list", ".", "append", "(", "loss", ")", "\n", "print", "(", "\"train loss of epoch-{0} is {1}\"", ".", "format", "(", "epoch", ",", "loss", ")", ")", "\n", "epoch", "+=", "1", "\n", "\n", "# stop condition", "\n", "", "if", "epoch", "*", "0.02", "*", "self", ".", "train_data_amt", "<=", "5", "*", "self", ".", "train_data_amt", ":", "\n", "                ", "continue", "\n", "", "if", "(", "loss_list", "[", "-", "1", "]", "-", "loss_list", "[", "-", "2", "]", ">", "0", "and", "loss_list", "[", "-", "2", "]", "-", "loss_list", "[", "-", "3", "]", ">", "0", ")", ":", "\n", "                ", "break", "\n", "", "if", "epoch", "*", "0.02", "*", "self", ".", "train_data_amt", ">=", "20", "*", "self", ".", "train_data_amt", ":", "\n", "                ", "break", "\n", "\n", "# draw SGD training process", "\n", "", "", "x", "=", "[", "i", "for", "i", "in", "range", "(", "len", "(", "loss_list", ")", ")", "]", "\n", "plt", ".", "plot", "(", "x", ",", "loss_list", ")", "\n", "plt", ".", "savefig", "(", "self", ".", "output_dir", "+", "'train.png'", ")", "\n", "plt", ".", "gcf", "(", ")", ".", "clear", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.deephit.DeepHit.test": [[151, 188], ["int", "range", "numpy.mean", "numpy.mean", "numpy.mean", "print", "print", "print", "deephit.DeepHit.util_test.get_batch_data_sorted", "range", "deephit.DeepHit.sess.run", "deephit.DeepHit.sess.run", "numpy.average", "roc_auc_score", "log_loss", "anlp_batch.append", "auc_batch.append", "logloss_batch.append", "open", "f.writelines", "len", "tensorflow.SparseTensorValue", "numpy.log", "len"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data_sorted"], ["", "def", "test", "(", "self", ")", ":", "\n", "        ", "batch_num", "=", "int", "(", "self", ".", "test_data_amt", "/", "self", ".", "batch_size", ")", "\n", "anlp_batch", "=", "[", "]", "\n", "auc_batch", "=", "[", "]", "\n", "logloss_batch", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "batch_num", ")", ":", "\n", "            ", "x_batch_field", ",", "b_batch", ",", "z_batch", ",", "y_batch", "=", "self", ".", "util_test", ".", "get_batch_data_sorted", "(", "i", ")", "\n", "feed_dict", "=", "{", "}", "\n", "for", "j", "in", "range", "(", "len", "(", "self", ".", "X", ")", ")", ":", "\n", "                ", "feed_dict", "[", "self", ".", "X", "[", "j", "]", "]", "=", "tf", ".", "SparseTensorValue", "(", "x_batch_field", "[", "j", "]", ",", "[", "1", "]", "*", "len", "(", "x_batch_field", "[", "j", "]", ")", ",", "\n", "[", "self", ".", "batch_size", ",", "self", ".", "field_sizes", "[", "j", "]", "]", ")", "\n", "", "feed_dict", "[", "self", ".", "b", "]", "=", "b_batch", "\n", "feed_dict", "[", "self", ".", "z", "]", "=", "z_batch", "\n", "feed_dict", "[", "self", ".", "y", "]", "=", "y_batch", "\n", "\n", "pz", "=", "self", ".", "sess", ".", "run", "(", "self", ".", "pz", ",", "feed_dict", ")", "\n", "wb", "=", "self", ".", "sess", ".", "run", "(", "self", ".", "wb", ",", "feed_dict", ")", "\n", "\n", "pz", "[", "pz", "==", "0", "]", "=", "1e-20", "\n", "anlp", "=", "np", ".", "average", "(", "-", "np", ".", "log", "(", "pz", ")", ")", "\n", "auc", "=", "roc_auc_score", "(", "y_batch", ",", "wb", ")", "\n", "logloss", "=", "log_loss", "(", "y_batch", ",", "wb", ")", "\n", "\n", "anlp_batch", ".", "append", "(", "anlp", ")", "\n", "auc_batch", ".", "append", "(", "auc", ")", "\n", "logloss_batch", ".", "append", "(", "logloss", ")", "\n", "\n", "", "ANLP", "=", "np", ".", "mean", "(", "anlp_batch", ")", "\n", "AUC", "=", "np", ".", "mean", "(", "auc_batch", ")", "\n", "LOGLOSS", "=", "np", ".", "mean", "(", "logloss_batch", ")", "\n", "\n", "print", "(", "\"AUC: {}\"", ".", "format", "(", "AUC", ")", ")", "\n", "print", "(", "\"Log-Loss: {}\"", ".", "format", "(", "LOGLOSS", ")", ")", "\n", "print", "(", "\"ANLP: {}\"", ".", "format", "(", "ANLP", ")", ")", "\n", "\n", "with", "open", "(", "self", ".", "output_dir", "+", "'result.txt'", ",", "'w'", ")", "as", "f", ":", "\n", "            ", "f", ".", "writelines", "(", "[", "\"AUC:{}\\tANLP:{}\\tLog-Loss:{}\"", ".", "format", "(", "AUC", ",", "ANLP", ",", "LOGLOSS", ")", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.deephit.DeepHit.output_s": [[189, 204], ["int", "numpy.ones", "range", "print", "numpy.savetxt", "deephit.DeepHit.util_test.get_batch_data", "range", "numpy.vstack", "len", "tensorflow.SparseTensorValue", "deephit.DeepHit.sess.run", "len"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data"], ["", "", "def", "output_s", "(", "self", ")", ":", "\n", "        ", "batch_num", "=", "int", "(", "self", ".", "test_data_amt", "/", "self", ".", "batch_size", ")", "\n", "output", "=", "np", ".", "ones", "(", "[", "self", ".", "batch_size", ",", "OUT_SIZE2", "]", ")", "\n", "for", "i", "in", "range", "(", "batch_num", ")", ":", "\n", "            ", "x_batch_field", ",", "b_batch", ",", "z_batch", ",", "y_batch", "=", "self", ".", "util_test", ".", "get_batch_data", "(", "i", ")", "\n", "feed_dict", "=", "{", "}", "\n", "for", "j", "in", "range", "(", "len", "(", "self", ".", "X", ")", ")", ":", "\n", "                ", "feed_dict", "[", "self", ".", "X", "[", "j", "]", "]", "=", "tf", ".", "SparseTensorValue", "(", "x_batch_field", "[", "j", "]", ",", "[", "1", "]", "*", "len", "(", "x_batch_field", "[", "j", "]", ")", ",", "\n", "[", "self", ".", "batch_size", ",", "self", ".", "field_sizes", "[", "j", "]", "]", ")", "\n", "", "feed_dict", "[", "self", ".", "b", "]", "=", "b_batch", "\n", "feed_dict", "[", "self", ".", "z", "]", "=", "z_batch", "\n", "feed_dict", "[", "self", ".", "y", "]", "=", "y_batch", "\n", "output", "=", "np", ".", "vstack", "(", "[", "output", ",", "self", ".", "sess", ".", "run", "(", "self", ".", "w", ",", "feed_dict", ")", "]", ")", "\n", "", "print", "(", "output", ".", "shape", ")", "\n", "np", ".", "savetxt", "(", "self", ".", "output_dir", "+", "'s.txt'", ",", "1", "-", "output", "[", "self", ".", "batch_size", ":", ",", "]", ",", "delimiter", "=", "'\\t'", ",", "fmt", "=", "'%.4f'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.km.my_log": [[20, 26], ["math.log", "math.log"], "function", ["None"], ["def", "my_log", "(", "a", ")", ":", "\n", "\t", "if", "a", "<=", "0", ":", "\n", "#countt.counttt+=1", "\n", "\t\t", "return", "math", ".", "log", "(", "1e-10", ")", "\n", "", "else", ":", "\n", "\t\t", "return", "math", ".", "log", "(", "a", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.km.win_prob": [[27, 39], ["None"], "function", ["None"], ["", "", "def", "win_prob", "(", "bid", ",", "zw_dict", ")", ":", "\n", "    ", "if", "bid", "in", "zw_dict", ":", "\n", "        ", "return", "zw_dict", "[", "bid", "]", "\n", "", "last_key", "=", "-", "1", "\n", "for", "key", "in", "zw_dict", ":", "\n", "        ", "if", "last_key", "==", "-", "1", ":", "\n", "            ", "last_key", "=", "key", "\n", "", "if", "bid", "<=", "key", ":", "\n", "            ", "return", "zw_dict", "[", "last_key", "]", "\n", "", "else", ":", "\n", "            ", "last_key", "=", "key", "\n", "", "", "return", "1.", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.km.train": [[40, 93], ["os.path.join", "collections.defaultdict", "open", "open.close", "sorted", "dict", "len", "line.strip().split", "int", "max", "int", "b_data[].append", "dict.items", "sum", "bdns.append", "len", "float", "float", "float", "max", "line.strip", "int"], "function", ["None"], ["", "def", "train", "(", "num", ",", "base_path", "=", "base_path", ")", ":", "\n", "\t", "\"\"\"\n\tthis function is used to process train.bid.txt format\n\tnum:sequence number of the iPinYou,str\n\t\"\"\"", "\n", "train_data_file", "=", "os", ".", "path", ".", "join", "(", "base_path", ",", "num", ",", "train_file", ")", "\n", "b_data", "=", "defaultdict", "(", "list", ")", "\n", "fi", "=", "open", "(", "train_data_file", ",", "'r'", ")", "\n", "size", "=", "0", "\n", "maxb", "=", "0", "\n", "for", "line", "in", "fi", ":", "\n", "\t\t", "s", "=", "line", ".", "strip", "(", ")", ".", "split", "(", ")", "\n", "b", "=", "int", "(", "s", "[", "0", "]", ")", "\n", "maxb", "=", "max", "(", "b", ",", "maxb", ")", "\n", "o", "=", "int", "(", "s", "[", "1", "]", ")", "\n", "b_data", "[", "b", "]", ".", "append", "(", "o", ")", "\n", "size", "+=", "1", "\n", "", "fi", ".", "close", "(", ")", "\n", "b_data", "=", "sorted", "(", "b_data", ".", "items", "(", ")", ",", "key", "=", "lambda", "e", ":", "e", "[", "0", "]", ",", "reverse", "=", "False", ")", "\n", "b_data", "=", "dict", "(", "b_data", ")", "\n", "\n", "bdns", "=", "[", "]", "\n", "wins", "=", "0", "\n", "for", "z", "in", "b_data", ":", "\n", "\t\t", "wins", "=", "sum", "(", "b_data", "[", "z", "]", ")", "\n", "b", "=", "z", "\n", "d", "=", "wins", "\n", "n", "=", "size", "\n", "bdn", "=", "[", "b", ",", "d", ",", "n", "]", "\n", "bdns", ".", "append", "(", "bdn", ")", "\n", "size", "-=", "len", "(", "b_data", "[", "z", "]", ")", "\n", "\n", "#print(bdns)", "\n", "\n", "", "zw_dict", "=", "{", "}", "\n", "min_p_w", "=", "0", "\n", "bdns_length", "=", "len", "(", "bdns", ")", "\n", "count", "=", "0", "\n", "p_l_tmp", "=", "1.0", "\n", "\n", "for", "bdn", "in", "bdns", ":", "\n", "\t\t", "count", "+=", "1", "\n", "b", "=", "float", "(", "bdn", "[", "0", "]", ")", "\n", "d", "=", "float", "(", "bdn", "[", "1", "]", ")", "\n", "n", "=", "float", "(", "bdn", "[", "2", "]", ")", "\n", "if", "count", "<", "bdns_length", ":", "\n", "\t\t\t", "p_l_tmp", "*=", "(", "n", "-", "d", ")", "/", "n", "\n", "", "p_l", "=", "p_l_tmp", "\n", "p_w", "=", "max", "(", "1.0", "-", "p_l", ",", "min_p_w", ")", "\n", "zw_dict", "[", "int", "(", "b", ")", "]", "=", "p_w", "\n", "\n", "#print(zw_dict)", "\n", "", "return", "zw_dict", ",", "maxb", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.km.train2": [[97, 149], ["os.path.join", "collections.defaultdict", "open", "open.close", "sorted", "dict", "len", "line.strip().split", "int", "max", "int", "b_data[].append", "dict.items", "sum", "bdns.append", "len", "float", "float", "float", "max", "int", "line.strip", "int"], "function", ["None"], ["", "def", "train2", "(", "num", ",", "base_path", "=", "base_path", ")", ":", "\n", "\t", "\"\"\"\n\tthis function is used to process train.yzbx.txt format\n\t\"\"\"", "\n", "#train_data_file=\"/home/zyyang/RS/train.yzbx.txt\"", "\n", "train_data_file", "=", "os", ".", "path", ".", "join", "(", "base_path", ",", "num", ",", "'train.yzbx.txt'", ")", "\n", "b_data", "=", "defaultdict", "(", "list", ")", "\n", "fi", "=", "open", "(", "train_data_file", ",", "'r'", ")", "\n", "size", "=", "0", "\n", "maxb", "=", "0", "\n", "for", "line", "in", "fi", ":", "\n", "\t\t", "s", "=", "line", ".", "strip", "(", ")", ".", "split", "(", ")", "\n", "b", "=", "int", "(", "s", "[", "2", "]", ")", "\n", "maxb", "=", "max", "(", "b", ",", "maxb", ")", "\n", "o", "=", "b", ">", "int", "(", "s", "[", "1", "]", ")", "\n", "o", "=", "int", "(", "o", ")", "\n", "b_data", "[", "b", "]", ".", "append", "(", "o", ")", "\n", "size", "+=", "1", "\n", "", "fi", ".", "close", "(", ")", "\n", "b_data", "=", "sorted", "(", "b_data", ".", "items", "(", ")", ",", "key", "=", "lambda", "e", ":", "e", "[", "0", "]", ",", "reverse", "=", "False", ")", "\n", "b_data", "=", "dict", "(", "b_data", ")", "\n", "\n", "bdns", "=", "[", "]", "\n", "wins", "=", "0", "\n", "for", "z", "in", "b_data", ":", "\n", "\t\t", "wins", "=", "sum", "(", "b_data", "[", "z", "]", ")", "\n", "b", "=", "z", "\n", "d", "=", "wins", "\n", "n", "=", "size", "\n", "bdn", "=", "[", "b", ",", "d", ",", "n", "]", "\n", "bdns", ".", "append", "(", "bdn", ")", "\n", "size", "-=", "len", "(", "b_data", "[", "z", "]", ")", "\n", "\n", "", "zw_dict", "=", "{", "}", "\n", "min_p_w", "=", "0", "\n", "bdns_length", "=", "len", "(", "bdns", ")", "\n", "count", "=", "0", "\n", "p_l_tmp", "=", "1.0", "\n", "\n", "for", "bdn", "in", "bdns", ":", "\n", "\t\t", "count", "+=", "1", "\n", "b", "=", "float", "(", "bdn", "[", "0", "]", ")", "\n", "d", "=", "float", "(", "bdn", "[", "1", "]", ")", "\n", "n", "=", "float", "(", "bdn", "[", "2", "]", ")", "\n", "if", "count", "<", "bdns_length", ":", "\n", "\t\t\t", "p_l_tmp", "*=", "(", "n", "-", "d", ")", "/", "n", "\n", "", "p_l", "=", "p_l_tmp", "\n", "p_w", "=", "max", "(", "1.0", "-", "p_l", ",", "min_p_w", ")", "\n", "zw_dict", "[", "int", "(", "b", ")", "]", "=", "p_w", "\n", "\n", "#print(zw_dict)", "\n", "", "return", "zw_dict", ",", "maxb", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.km.draw": [[150, 174], ["range", "range", "matplotlib.step", "numpy.array", "matplotlib.legend", "matplotlib.ylim", "matplotlib.savefig", "matplotlib.close", "b_full_data.append", "km.win_prob"], "function", ["home.repos.pwc.inspect_result.rk2900_drsa.python.km.win_prob"], ["", "def", "draw", "(", "num", ",", "zw_dict", ",", "maxb", ")", ":", "\n", "\t", "\"\"\"\n\t\tdraw the survival rate curve\n\t\"\"\"", "\n", "b_full_data", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "1", ",", "maxb", "+", "1", ")", ":", "\n", "\t\t", "b_full_data", ".", "append", "(", "win_prob", "(", "i", ",", "zw_dict", ")", ")", "\n", "\n", "", "s", "=", "range", "(", "1", ",", "maxb", "+", "1", ")", "\n", "A", ",", "=", "plt", ".", "step", "(", "s", ",", "b_full_data", ",", "'r-'", ",", "where", "=", "'post'", ",", "label", "=", "num", ",", "linewidth", "=", "1.0", ")", "\n", "font1", "=", "{", "'family'", ":", "'Times New Roman'", ",", "\n", "'weight'", ":", "'normal'", ",", "\n", "'size'", ":", "10", ",", "\n", "}", "\n", "\n", "tmp_data", "=", "np", ".", "array", "(", "b_full_data", ")", "\n", "tmp_data", "=", "1", "-", "tmp_data", "\n", "\n", "legend", "=", "plt", ".", "legend", "(", "handles", "=", "[", "A", "]", ",", "prop", "=", "font1", ")", "\n", "plt", ".", "ylim", "(", "(", "0", ",", "1", ")", ")", "\n", "\n", "plt", ".", "savefig", "(", "save_path", "+", "\"/km_\"", "+", "num", ")", "\n", "plt", ".", "close", "(", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.km.test": [[176, 227], ["os.path.join", "open", "range", "sorted", "sklearn.metrics.roc_auc_score", "print", "open.close", "line.strip().split", "int", "int", "int", "km.win_prob", "km.win_prob", "pred.append", "km.win_prob", "km.my_log", "label.append", "len", "sorted.append", "abs", "line.strip", "km.my_log", "km.my_log"], "function", ["home.repos.pwc.inspect_result.rk2900_drsa.python.km.win_prob", "home.repos.pwc.inspect_result.rk2900_drsa.python.km.win_prob", "home.repos.pwc.inspect_result.rk2900_drsa.python.km.win_prob", "home.repos.pwc.inspect_result.rk2900_drsa.python.km.my_log", "home.repos.pwc.inspect_result.rk2900_drsa.python.km.my_log", "home.repos.pwc.inspect_result.rk2900_drsa.python.km.my_log"], ["", "def", "test", "(", "num", ",", "zw_dict", ",", "maxb", ",", "base_path", "=", "base_path", ")", ":", "\n", "\t", "\"\"\"\n\n\t\"\"\"", "\n", "count", "=", "0", "\n", "p_z", "=", "0", "\n", "log_loss", "=", "0", "\n", "c_index", "=", "0", "\n", "#test_data_file=os.path.join(base_path,num,test_file)", "\n", "#test_data_file=\"/home/zyyang/RS/test.yzbx.txt\"", "\n", "#test_data_file=\"/home/zyyang/RS/code/support1/test.yzbx.txt\"", "\n", "test_data_file", "=", "os", ".", "path", ".", "join", "(", "base_path", ",", "num", ",", "test_file", ")", "\n", "fi", "=", "open", "(", "test_data_file", ",", "'r'", ")", "\n", "res_data", "=", "[", "]", "\n", "label", "=", "[", "]", "\n", "pred", "=", "[", "]", "\n", "for", "line", "in", "fi", ":", "\n", "\t\t", "count", "+=", "1", "\n", "s", "=", "line", ".", "strip", "(", ")", ".", "split", "(", ")", "\n", "test_b", "=", "int", "(", "s", "[", "2", "]", ")", "\n", "true_z", "=", "int", "(", "s", "[", "1", "]", ")", "\n", "market_price", "=", "int", "(", "s", "[", "1", "]", ")", "# is the true market price", "\n", "win_proba", "=", "win_prob", "(", "test_b", ",", "zw_dict", ")", "\n", "true_prob", "=", "win_prob", "(", "true_z", ",", "zw_dict", ")", "\n", "pred", ".", "append", "(", "win_proba", ")", "\n", "next_bid", "=", "true_z", "+", "1", "\n", "if", "next_bid", ">=", "maxb", ":", "\n", "#win_prob(next_bid,zw_dict)>=win_prob(maxb,zw_dict):", "\n", "\t\t\t", "next_bid", "=", "next_bid", "\n", "", "else", ":", "\n", "\t\t\t", "while", "(", "next_bid", "not", "in", "zw_dict", ")", ":", "\n", "\t\t\t\t", "next_bid", "+=", "1", ";", "\n", "", "", "next_prob", "=", "win_prob", "(", "next_bid", ",", "zw_dict", ")", "\n", "p_z", "-=", "my_log", "(", "abs", "(", "next_prob", "-", "true_prob", ")", ")", "\n", "w", "=", "test_b", ">", "market_price", "\n", "label", ".", "append", "(", "w", ")", "\n", "log_loss", "-=", "(", "w", "*", "my_log", "(", "win_proba", ")", "+", "(", "1", "-", "w", ")", "*", "my_log", "(", "1", "-", "win_proba", ")", ")", "\n", "#print(len(label))", "\n", "#print(len(pred))", "\n", "", "mytest", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "0", ",", "len", "(", "label", ")", ")", ":", "\n", "\t\t", "mytest", ".", "append", "(", "(", "pred", "[", "i", "]", ",", "label", "[", "i", "]", ")", ")", "\n", "", "mytest", "=", "sorted", "(", "mytest", ",", "key", "=", "lambda", "e", ":", "e", "[", "0", "]", ")", "\n", "#print(len(mytest))", "\n", "\n", "c_index", "=", "roc_auc_score", "(", "label", ",", "pred", ")", "\n", "p_z", "=", "p_z", "/", "count", "\n", "log_loss", "=", "log_loss", "/", "count", "\n", "print", "(", "(", "\"test count is {0}\"", ")", ".", "format", "(", "count", ")", ")", "\n", "fi", ".", "close", "(", ")", "\n", "return", "p_z", ",", "log_loss", ",", "c_index", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.__init__": [[7, 68], ["open", "open.readlines", "open.close", "open", "open.readlines", "open.close", "print", "numpy.array().reshape", "numpy.array().reshape", "numpy.array().reshape", "numpy.array", "int", "line[].replace.split", "split1[].split", "line[].replace", "line[].replace.split", "input_x.append", "len", "int", "int", "int", "int", "util.Util.z.append", "util.Util.b.append", "util.Util.x.append", "numpy.array", "numpy.array", "numpy.array", "len", "int", "util.Util.y.append", "util.Util.y.append", "lines[].split"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "input_file", ",", "featindex", ",", "batch_size", ",", "op", ")", ":", "\n", "        ", "self", ".", "input_file", "=", "input_file", "\n", "self", ".", "featindex", "=", "featindex", "\n", "self", ".", "batch_size", "=", "batch_size", "\n", "\n", "# key = pos, value = (field_num, nth value)", "\n", "self", ".", "feat_dict", "=", "{", "}", "\n", "\n", "# generate feat_dict", "\n", "fin", "=", "open", "(", "featindex", ",", "'r'", ")", "\n", "lines", "=", "fin", ".", "readlines", "(", ")", "\n", "self", ".", "feat_sizes", "=", "[", "0", "]", "*", "(", "int", "(", "lines", "[", "-", "1", "]", ".", "split", "(", "':'", ")", "[", "0", "]", ")", "+", "1", ")", "\n", "\n", "for", "line", "in", "lines", ":", "\n", "            ", "split1", "=", "line", ".", "split", "(", "'\\t'", ")", "\n", "split2", "=", "split1", "[", "0", "]", ".", "split", "(", "':'", ")", "\n", "\n", "# features sizes", "\n", "if", "split2", "[", "0", "]", "==", "'truncate'", ":", "\n", "                ", "self", ".", "feat_dict", "[", "0", "]", "=", "(", "0", ",", "0", ")", "\n", "self", ".", "feat_sizes", "[", "0", "]", "+=", "1", "\n", "", "else", ":", "\n", "                ", "field", "=", "int", "(", "split2", "[", "0", "]", ")", "\n", "pos", "=", "int", "(", "split1", "[", "-", "1", "]", ")", "\n", "nth_value", "=", "int", "(", "self", ".", "feat_sizes", "[", "field", "]", ")", "\n", "self", ".", "feat_dict", "[", "pos", "]", "=", "(", "field", ",", "nth_value", ")", "\n", "self", ".", "feat_sizes", "[", "field", "]", "+=", "1", "\n", "", "", "fin", ".", "close", "(", ")", "\n", "\n", "# get data from input file and sample", "\n", "fin", "=", "open", "(", "input_file", ",", "'r'", ")", "\n", "lines", "=", "fin", ".", "readlines", "(", ")", "\n", "input_x", "=", "[", "]", "\n", "for", "line", "in", "lines", ":", "\n", "            ", "line", "=", "line", "[", ":", "-", "1", "]", ".", "replace", "(", "':1'", ",", "''", ")", "\n", "items", "=", "line", ".", "split", "(", "' '", ")", "\n", "input_x", ".", "append", "(", "[", "int", "(", "x", ")", "for", "x", "in", "items", "[", "1", ":", "]", "]", ")", "\n", "", "fin", ".", "close", "(", ")", "\n", "print", "(", "\"data set size: \"", ",", "len", "(", "input_x", ")", ")", "\n", "\n", "\n", "self", ".", "x", "=", "[", "]", "\n", "self", ".", "b", "=", "[", "]", "\n", "self", ".", "z", "=", "[", "]", "\n", "self", ".", "y", "=", "[", "]", "\n", "for", "zbx", "in", "input_x", ":", "\n", "            ", "if", "(", "zbx", "[", "0", "]", ">", "0", ")", ":", "\n", "                ", "self", ".", "z", ".", "append", "(", "zbx", "[", "0", "]", ")", "\n", "self", ".", "b", ".", "append", "(", "zbx", "[", "1", "]", ")", "\n", "self", ".", "x", ".", "append", "(", "zbx", "[", "2", ":", "]", ")", "\n", "if", "zbx", "[", "0", "]", ">=", "zbx", "[", "1", "]", ":", "\n", "                    ", "self", ".", "y", ".", "append", "(", "0", ")", "\n", "", "else", ":", "\n", "                    ", "self", ".", "y", ".", "append", "(", "1", ")", "\n", "", "", "", "self", ".", "b", "=", "np", ".", "array", "(", "self", ".", "b", ")", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "z", "=", "np", ".", "array", "(", "self", ".", "z", ")", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "y", "=", "np", ".", "array", "(", "self", ".", "y", ")", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "x", "=", "np", ".", "array", "(", "self", ".", "x", ")", "\n", "# get batch number", "\n", "self", ".", "batch_num", "=", "int", "(", "len", "(", "self", ".", "y", ")", "/", "self", ".", "batch_size", ")", "\n", "self", ".", "data_amt", "=", "self", ".", "z", ".", "shape", "[", "0", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.partition": [[69, 88], ["range", "res.append", "len", "field_res[].append", "batch_res.append", "batch_res.append"], "methods", ["None"], ["", "def", "partition", "(", "self", ",", "x_batches", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "batch", "in", "x_batches", ":", "\n", "            ", "batch_res", "=", "[", "]", "\n", "field_res", "=", "{", "}", "\n", "for", "rec", "in", "batch", ":", "\n", "                ", "field_nth", "=", "self", ".", "feat_dict", "[", "rec", "[", "1", "]", "]", "#(field, nth_value)", "\n", "rec", "[", "1", "]", "=", "field_nth", "[", "1", "]", "\n", "if", "field_nth", "[", "0", "]", "in", "field_res", ":", "\n", "                    ", "field_res", "[", "field_nth", "[", "0", "]", "]", ".", "append", "(", "rec", ")", "\n", "", "else", ":", "\n", "                    ", "field_res", "[", "field_nth", "[", "0", "]", "]", "=", "[", "rec", "]", "\n", "", "", "for", "key", "in", "range", "(", "len", "(", "self", ".", "feat_sizes", ")", ")", ":", "\n", "                ", "if", "key", "in", "field_res", ":", "\n", "                    ", "batch_res", ".", "append", "(", "field_res", "[", "key", "]", ")", "\n", "", "else", ":", "\n", "                    ", "batch_res", ".", "append", "(", "[", "]", ")", "\n", "", "", "res", ".", "append", "(", "batch_res", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.generate_indices": [[89, 96], ["range", "len", "indices.append"], "methods", ["None"], ["", "def", "generate_indices", "(", "self", ",", "x", ")", ":", "\n", "        ", "indices", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "len", "(", "x", ")", ")", ":", "\n", "            ", "line", "=", "x", "[", "i", "]", "\n", "for", "pos", "in", "line", ":", "\n", "                ", "indices", ".", "append", "(", "[", "i", ",", "pos", "]", ")", "\n", "", "", "return", "indices", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.sample": [[97, 119], ["range", "len", "random.randint", "res_x.append", "random.randint", "res_x.append", "random.randint", "res_x.append", "random.randint", "res_x.append"], "methods", ["None"], ["", "def", "sample", "(", "self", ",", "x", ")", ":", "\n", "        ", "res_x", "=", "x", "\n", "for", "i", "in", "range", "(", "len", "(", "x", ")", ")", ":", "\n", "            ", "zbx", "=", "x", "[", "i", "]", "\n", "if", "zbx", "[", "0", "]", "==", "0", ":", "continue", "\n", "if", "zbx", "[", "0", "]", "<", "zbx", "[", "1", "]", ":", "\n", "# sample from [1, z]", "\n", "                ", "sample_b", "=", "random", ".", "randint", "(", "1", ",", "zbx", "[", "0", "]", ")", "\n", "res_x", ".", "append", "(", "[", "zbx", "[", "0", "]", "]", "+", "[", "sample_b", "]", "+", "zbx", "[", "2", ":", "]", ")", "\n", "\n", "# sample from [z + 1, b]", "\n", "sample_b", "=", "random", ".", "randint", "(", "zbx", "[", "0", "]", "+", "1", ",", "zbx", "[", "1", "]", ")", "\n", "res_x", ".", "append", "(", "[", "zbx", "[", "0", "]", "]", "+", "[", "sample_b", "]", "+", "zbx", "[", "2", ":", "]", ")", "\n", "\n", "# sample from [b + 1, 2(b + 1)]", "\n", "sample_b", "=", "random", ".", "randint", "(", "zbx", "[", "1", "]", "+", "1", ",", "2", "*", "(", "zbx", "[", "1", "]", "+", "1", ")", ")", "\n", "res_x", ".", "append", "(", "[", "zbx", "[", "0", "]", "]", "+", "[", "sample_b", "]", "+", "zbx", "[", "2", ":", "]", ")", "\n", "", "else", ":", "\n", "# sample from [1, b]", "\n", "                ", "sample_b", "=", "random", ".", "randint", "(", "1", ",", "zbx", "[", "1", "]", ")", "\n", "res_x", ".", "append", "(", "[", "zbx", "[", "0", "]", "]", "+", "[", "sample_b", "]", "+", "zbx", "[", "2", ":", "]", ")", "\n", "", "", "return", "res_x", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data": [[120, 135], ["print", "random.shuffle", "util.Util.b[].reshape", "util.Util.z[].reshape", "util.Util.y[].reshape", "util.Util.x[].reshape", "util.Util.partition", "len", "range", "util.Util.generate_indices", "util.Util.x[].tolist"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.partition", "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.generate_indices"], ["", "def", "get_batch_data", "(", "self", ",", "num", ")", ":", "\n", "        ", "if", "(", "num", "%", "self", ".", "batch_num", ")", "==", "0", ":", "\n", "            ", "print", "(", "'shuffle'", ")", "\n", "index", "=", "[", "i", "for", "i", "in", "range", "(", "self", ".", "data_amt", ")", "]", "\n", "shuffled_index", "=", "random", ".", "shuffle", "(", "index", ")", "\n", "self", ".", "b", "=", "self", ".", "b", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "z", "=", "self", ".", "z", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "y", "=", "self", ".", "y", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "x", "=", "self", ".", "x", "[", "shuffled_index", "]", ".", "reshape", "(", "self", ".", "data_amt", ",", "len", "(", "self", ".", "feat_sizes", ")", ")", "\n", "", "pos", "=", "num", "%", "self", ".", "batch_num", "\n", "x_field_batch", "=", "self", ".", "partition", "(", "[", "self", ".", "generate_indices", "(", "self", ".", "x", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", "]", ".", "tolist", "(", ")", ")", "]", ")", "[", "0", "]", "\n", "b_batch", "=", "self", ".", "b", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", "\n", "z_batch", "=", "self", ".", "z", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", "\n", "y_batch", "=", "self", ".", "y", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", "\n", "return", "x_field_batch", ",", "b_batch", ",", "z_batch", ",", "y_batch", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data_sorted": [[136, 159], ["util.Util.b[].astype", "util.Util.z[].astype", "util.Util.y[].astype", "numpy.argsort", "print", "random.shuffle", "util.Util.b[].reshape", "util.Util.z[].reshape", "util.Util.y[].reshape", "util.Util.x[].reshape", "util.Util.partition", "len", "range", "util.Util.generate_indices", "x_batch[].tolist"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.partition", "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.generate_indices"], ["", "def", "get_batch_data_sorted", "(", "self", ",", "num", ")", ":", "\n", "        ", "if", "(", "num", "%", "self", ".", "batch_num", ")", "==", "0", ":", "\n", "            ", "print", "(", "'shuffle'", ")", "\n", "index", "=", "[", "i", "for", "i", "in", "range", "(", "self", ".", "data_amt", ")", "]", "\n", "shuffled_index", "=", "random", ".", "shuffle", "(", "index", ")", "\n", "self", ".", "b", "=", "self", ".", "b", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "z", "=", "self", ".", "z", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "y", "=", "self", ".", "y", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "x", "=", "self", ".", "x", "[", "shuffled_index", "]", ".", "reshape", "(", "self", ".", "data_amt", ",", "len", "(", "self", ".", "feat_sizes", ")", ")", "\n", "", "pos", "=", "num", "%", "self", ".", "batch_num", "\n", "x_batch", "=", "self", ".", "x", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", "]", "\n", "b_batch", "=", "self", ".", "b", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "z_batch", "=", "self", ".", "z", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "y_batch", "=", "self", ".", "y", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "\n", "#sort", "\n", "base", "=", "(", "b_batch", "*", "(", "1", "-", "y_batch", ")", "+", "z_batch", "*", "y_batch", ")", ".", "reshape", "(", "-", "1", ",", ")", "\n", "sort_index", "=", "np", ".", "argsort", "(", "base", ")", "\n", "x_batch_field_sort", "=", "self", ".", "partition", "(", "[", "self", ".", "generate_indices", "(", "x_batch", "[", "sort_index", "]", ".", "tolist", "(", ")", ")", "]", ")", "[", "0", "]", "\n", "b_batch_sort", "=", "b_batch", "[", "sort_index", "]", "\n", "z_batch_sort", "=", "z_batch", "[", "sort_index", "]", "\n", "y_batch_sort", "=", "y_batch", "[", "sort_index", "]", "\n", "return", "x_batch_field_sort", ",", "b_batch_sort", ",", "z_batch_sort", ",", "y_batch_sort", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batches_data": [[160, 167], ["util.Util.partition", "util.Util.generate_indices", "util.Util.x[].tolist"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.partition", "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.generate_indices"], ["", "def", "get_batches_data", "(", "self", ",", "from_", ",", "num", ")", ":", "\n", "        ", "pos", "=", "from_", "%", "self", ".", "batch_num", "\n", "x_field_batch", "=", "self", ".", "partition", "(", "[", "self", ".", "generate_indices", "(", "self", ".", "x", "[", "pos", ":", "pos", "+", "num", "]", ".", "tolist", "(", ")", ")", "]", ")", "[", "0", "]", "\n", "b_batch", "=", "self", ".", "b", "[", "pos", ":", "pos", "+", "num", "]", "\n", "z_batch", "=", "self", ".", "z", "[", "pos", ":", "pos", "+", "num", "]", "\n", "y_batch", "=", "self", ".", "y", "[", "pos", ":", "pos", "+", "num", "]", "\n", "return", "x_field_batch", ",", "b_batch", ",", "z_batch", ",", "y_batch", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data_origin_with_ks": [[168, 185], ["util.Util.generate_indices", "util.Util.b[].astype", "util.Util.z[].astype", "util.Util.y[].astype", "ks_const[].astype", "print", "random.shuffle", "util.Util.b[].reshape", "util.Util.z[].reshape", "util.Util.y[].reshape", "ks_const[].reshape", "util.Util.x[].reshape", "util.Util.x[].tolist", "len", "range"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.generate_indices"], ["", "def", "get_batch_data_origin_with_ks", "(", "self", ",", "num", ",", "ks_const", ")", ":", "\n", "        ", "if", "(", "num", "%", "self", ".", "batch_num", ")", "==", "0", ":", "\n", "            ", "print", "(", "'shuffle'", ")", "\n", "index", "=", "[", "i", "for", "i", "in", "range", "(", "self", ".", "data_amt", ")", "]", "\n", "shuffled_index", "=", "random", ".", "shuffle", "(", "index", ")", "\n", "self", ".", "b", "=", "self", ".", "b", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "z", "=", "self", ".", "z", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "y", "=", "self", ".", "y", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "ks_const", "=", "ks_const", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "x", "=", "self", ".", "x", "[", "shuffled_index", "]", ".", "reshape", "(", "self", ".", "data_amt", ",", "len", "(", "self", ".", "feat_sizes", ")", ")", "\n", "", "pos", "=", "num", "%", "self", ".", "batch_num", "\n", "x_batch", "=", "self", ".", "generate_indices", "(", "self", ".", "x", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", "]", ".", "tolist", "(", ")", ")", "\n", "b_batch", "=", "self", ".", "b", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "z_batch", "=", "self", ".", "z", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "y_batch", "=", "self", ".", "y", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "ks_batch", "=", "ks_const", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "return", "x_batch", ",", "b_batch", ",", "z_batch", ",", "y_batch", ",", "ks_batch", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data_origin": [[186, 201], ["util.Util.generate_indices", "util.Util.b[].astype", "util.Util.z[].astype", "util.Util.y[].astype", "print", "random.shuffle", "util.Util.b[].reshape", "util.Util.z[].reshape", "util.Util.y[].reshape", "util.Util.x[].reshape", "util.Util.x[].tolist", "len", "range"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.generate_indices"], ["", "def", "get_batch_data_origin", "(", "self", ",", "num", ")", ":", "\n", "        ", "if", "(", "num", "%", "self", ".", "batch_num", ")", "==", "0", ":", "\n", "            ", "print", "(", "'shuffle'", ")", "\n", "index", "=", "[", "i", "for", "i", "in", "range", "(", "self", ".", "data_amt", ")", "]", "\n", "shuffled_index", "=", "random", ".", "shuffle", "(", "index", ")", "\n", "self", ".", "b", "=", "self", ".", "b", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "z", "=", "self", ".", "z", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "y", "=", "self", ".", "y", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "x", "=", "self", ".", "x", "[", "shuffled_index", "]", ".", "reshape", "(", "self", ".", "data_amt", ",", "len", "(", "self", ".", "feat_sizes", ")", ")", "\n", "", "pos", "=", "num", "%", "self", ".", "batch_num", "\n", "x_batch", "=", "self", ".", "generate_indices", "(", "self", ".", "x", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", "]", ".", "tolist", "(", ")", ")", "\n", "b_batch", "=", "self", ".", "b", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "z_batch", "=", "self", ".", "z", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "y_batch", "=", "self", ".", "y", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "return", "x_batch", ",", "b_batch", ",", "z_batch", ",", "y_batch", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data_origin_sorted": [[202, 225], ["util.Util.b[].astype", "util.Util.z[].astype", "util.Util.y[].astype", "numpy.argsort", "util.Util.generate_indices", "print", "random.shuffle", "util.Util.b[].reshape", "util.Util.z[].reshape", "util.Util.y[].reshape", "util.Util.x[].reshape", "x_batch[].tolist", "len", "range"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.generate_indices"], ["", "def", "get_batch_data_origin_sorted", "(", "self", ",", "num", ")", ":", "\n", "        ", "if", "(", "num", "%", "self", ".", "batch_num", ")", "==", "0", ":", "\n", "            ", "print", "(", "'shuffle'", ")", "\n", "index", "=", "[", "i", "for", "i", "in", "range", "(", "self", ".", "data_amt", ")", "]", "\n", "shuffled_index", "=", "random", ".", "shuffle", "(", "index", ")", "\n", "self", ".", "b", "=", "self", ".", "b", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "z", "=", "self", ".", "z", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "y", "=", "self", ".", "y", "[", "shuffled_index", "]", ".", "reshape", "(", "-", "1", ",", "1", ")", "\n", "self", ".", "x", "=", "self", ".", "x", "[", "shuffled_index", "]", ".", "reshape", "(", "self", ".", "data_amt", ",", "len", "(", "self", ".", "feat_sizes", ")", ")", "\n", "", "pos", "=", "num", "%", "self", ".", "batch_num", "\n", "x_batch", "=", "self", ".", "x", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", "]", "\n", "b_batch", "=", "self", ".", "b", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "z_batch", "=", "self", ".", "z", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "y_batch", "=", "self", ".", "y", "[", "pos", "*", "self", ".", "batch_size", ":", "(", "pos", "+", "1", ")", "*", "self", ".", "batch_size", ",", ":", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "\n", "#sort", "\n", "base", "=", "(", "b_batch", "*", "(", "1", "-", "y_batch", ")", "+", "z_batch", "*", "y_batch", ")", ".", "reshape", "(", "-", "1", ",", ")", "\n", "sort_index", "=", "np", ".", "argsort", "(", "base", ")", "\n", "x_batch_sort", "=", "self", ".", "generate_indices", "(", "x_batch", "[", "sort_index", "]", ".", "tolist", "(", ")", ")", "\n", "b_batch_sort", "=", "b_batch", "[", "sort_index", "]", "\n", "z_batch_sort", "=", "z_batch", "[", "sort_index", "]", "\n", "y_batch_sort", "=", "y_batch", "[", "sort_index", "]", "\n", "return", "x_batch_sort", ",", "b_batch_sort", ",", "z_batch_sort", ",", "y_batch_sort", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_all_data_origin": [[226, 228], ["util.Util.generate_indices", "util.Util.b.astype", "util.Util.z.astype", "util.Util.y.astype", "util.Util.x.tolist"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.generate_indices"], ["", "def", "get_all_data_origin", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "generate_indices", "(", "self", ".", "x", ".", "tolist", "(", ")", ")", ",", "self", ".", "b", ".", "astype", "(", "np", ".", "float64", ")", ",", "self", ".", "z", ".", "astype", "(", "np", ".", "float64", ")", ",", "self", ".", "y", ".", "astype", "(", "np", ".", "float64", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_all_data_origin_sort": [[229, 237], ["numpy.argsort", "util.Util.generate_indices", "util.Util.b[].astype", "util.Util.z[].astype", "util.Util.y[].astype", "util.Util.x[].tolist"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.generate_indices"], ["", "def", "get_all_data_origin_sort", "(", "self", ")", ":", "\n", "        ", "base", "=", "(", "self", ".", "b", "*", "(", "1", "-", "self", ".", "y", ")", "+", "self", ".", "z", "*", "self", ".", "y", ")", ".", "reshape", "(", "-", "1", ",", ")", "\n", "sort_index", "=", "np", ".", "argsort", "(", "base", ")", "\n", "x_sort", "=", "self", ".", "generate_indices", "(", "self", ".", "x", "[", "sort_index", "]", ".", "tolist", "(", ")", ")", "\n", "b_sort", "=", "self", ".", "b", "[", "sort_index", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "z_sort", "=", "self", ".", "z", "[", "sort_index", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "y_sort", "=", "self", ".", "y", "[", "sort_index", "]", ".", "astype", "(", "np", ".", "float64", ")", "\n", "return", "x_sort", ",", "b_sort", ",", "z_sort", ",", "y_sort", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_max_z": [[238, 240], ["numpy.max().astype", "numpy.max"], "methods", ["None"], ["", "def", "get_max_z", "(", "self", ")", ":", "\n", "        ", "return", "np", ".", "max", "(", "self", ".", "y", "*", "self", ".", "z", ")", ".", "astype", "(", "np", ".", "float64", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_data_amt": [[241, 243], ["None"], "methods", ["None"], ["", "def", "get_data_amt", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "data_amt", "\n", "", "", ""]], "home.repos.pwc.inspect_result.rk2900_drsa.python.cox.COX.__init__": [[13, 70], ["util_train.get_data_amt", "util_test.get_data_amt", "tensorflow.reset_default_graph", "tensorflow.sparse_placeholder", "tensorflow.placeholder", "tensorflow.placeholder", "tensorflow.placeholder", "tensorflow.exp", "tensorflow.train.GradientDescentOptimizer", "cox.COX.optimizer.minimize", "tensorflow.ConfigProto", "tensorflow.Session", "tensorflow.global_variables_initializer().run", "os.path.exists", "os.makedirs", "tensorflow.Variable", "tensorflow.Variable", "tensorflow.nn.relu", "tensorflow.matmul", "tensorflow.Variable", "tensorflow.sparse_tensor_dense_matmul", "tensorflow.reduce_sum", "tensorflow.sparse_tensor_dense_matmul", "tensorflow.nn.l2_loss", "tensorflow.nn.l2_loss", "tensorflow.abs", "tensorflow.reduce_sum", "tensorflow.cumsum", "tensorflow.global_variables_initializer", "tensorflow.truncated_normal", "tensorflow.truncated_normal", "tensorflow.truncated_normal", "tensorflow.exp", "tensorflow.log", "tensorflow.clip_by_value", "tensorflow.cumsum"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_data_amt", "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_data_amt"], ["    ", "def", "__init__", "(", "self", ",", "lr", ",", "batch_size", ",", "dimension", ",", "util_train", ",", "util_test", ",", "campaign", ",", "reg_lambda", ",", "nn", "=", "False", ")", ":", "\n", "# hyperparameters", "\n", "        ", "self", ".", "lr", "=", "lr", "\n", "self", ".", "batch_size", "=", "batch_size", "\n", "self", ".", "util_train", "=", "util_train", "\n", "self", ".", "util_test", "=", "util_test", "\n", "self", ".", "reg_lambda", "=", "reg_lambda", "\n", "\n", "self", ".", "train_data_amt", "=", "util_train", ".", "get_data_amt", "(", ")", "\n", "self", ".", "test_data_amt", "=", "util_test", ".", "get_data_amt", "(", ")", "\n", "\n", "# output dir", "\n", "model_name", "=", "\"{}_{}_{}\"", ".", "format", "(", "self", ".", "lr", ",", "self", ".", "reg_lambda", ",", "self", ".", "batch_size", ")", "\n", "if", "nn", ":", "\n", "            ", "self", ".", "output_dir", "=", "\"output/coxnn/{}/{}/\"", ".", "format", "(", "campaign", ",", "model_name", ")", "\n", "", "else", ":", "\n", "            ", "self", ".", "output_dir", "=", "\"output/cox/{}/{}/\"", ".", "format", "(", "campaign", ",", "model_name", ")", "\n", "", "if", "not", "os", ".", "path", ".", "exists", "(", "self", ".", "output_dir", ")", ":", "\n", "            ", "os", ".", "makedirs", "(", "self", ".", "output_dir", ")", "\n", "\n", "# reset graph", "\n", "", "tf", ".", "reset_default_graph", "(", ")", "\n", "\n", "# placeholders, sorted value", "\n", "self", ".", "X", "=", "tf", ".", "sparse_placeholder", "(", "tf", ".", "float64", ")", "\n", "self", ".", "z", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "self", ".", "b", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "self", ".", "y", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "\n", "# computation graph, linear estimator or neural network", "\n", "if", "nn", ":", "\n", "            ", "hidden_size", "=", "20", "\n", "self", ".", "w1", "=", "tf", ".", "Variable", "(", "initial_value", "=", "tf", ".", "truncated_normal", "(", "shape", "=", "[", "dimension", ",", "hidden_size", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ",", "name", "=", "'w1'", ")", "\n", "self", ".", "w2", "=", "tf", ".", "Variable", "(", "initial_value", "=", "tf", ".", "truncated_normal", "(", "shape", "=", "[", "hidden_size", ",", "1", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ",", "name", "=", "'w2'", ")", "\n", "self", ".", "hidden_values", "=", "tf", ".", "nn", ".", "relu", "(", "tf", ".", "sparse_tensor_dense_matmul", "(", "self", ".", "X", ",", "self", ".", "w1", ")", ")", "\n", "self", ".", "index", "=", "tf", ".", "matmul", "(", "self", ".", "hidden_values", ",", "self", ".", "w2", ")", "\n", "self", ".", "reg", "=", "tf", ".", "nn", ".", "l2_loss", "(", "self", ".", "w1", "[", "1", ":", ",", "]", ")", "+", "tf", ".", "nn", ".", "l2_loss", "(", "self", ".", "w2", "[", "1", ":", ",", "]", ")", "\n", "", "else", ":", "\n", "            ", "self", ".", "w", "=", "tf", ".", "Variable", "(", "initial_value", "=", "tf", ".", "truncated_normal", "(", "shape", "=", "[", "dimension", ",", "1", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ",", "name", "=", "'w'", ")", "\n", "self", ".", "index", "=", "tf", ".", "sparse_tensor_dense_matmul", "(", "self", ".", "X", ",", "self", ".", "w", ")", "\n", "self", ".", "reg", "=", "tf", ".", "reduce_sum", "(", "tf", ".", "abs", "(", "self", ".", "w", "[", "1", ":", ",", "]", ")", ")", "\n", "\n", "", "self", ".", "multiple_times", "=", "tf", ".", "exp", "(", "self", ".", "index", ")", "\n", "self", ".", "loss", "=", "-", "tf", ".", "reduce_sum", "(", "(", "self", ".", "index", "-", "tf", ".", "log", "(", "tf", ".", "clip_by_value", "(", "tf", ".", "cumsum", "(", "self", ".", "multiple_times", ",", "reverse", "=", "True", ")", ",", "1e-6", ",", "1.0", ")", ")", ")", "*", "self", ".", "y", ")", "+", "self", ".", "reg", "\n", "self", ".", "optimizer", "=", "tf", ".", "train", ".", "GradientDescentOptimizer", "(", "self", ".", "lr", ")", "\n", "self", ".", "train_step", "=", "self", ".", "optimizer", ".", "minimize", "(", "self", ".", "loss", ")", "\n", "\n", "# for test h0", "\n", "self", ".", "base", "=", "self", ".", "z", "*", "self", ".", "y", "+", "self", ".", "b", "*", "(", "1", "-", "self", ".", "y", ")", "\n", "self", ".", "candidate", "=", "(", "1", "/", "tf", ".", "cumsum", "(", "tf", ".", "exp", "(", "self", ".", "index", ")", ",", "reverse", "=", "True", ")", ")", "*", "self", ".", "y", "\n", "\n", "# session initialization", "\n", "config", "=", "tf", ".", "ConfigProto", "(", ")", "\n", "config", ".", "gpu_options", ".", "allow_growth", "=", "True", "\n", "self", ".", "sess", "=", "tf", ".", "Session", "(", "config", "=", "config", ")", "\n", "tf", ".", "global_variables_initializer", "(", ")", ".", "run", "(", "session", "=", "self", ".", "sess", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.cox.COX.train": [[71, 108], ["matplotlib.plot", "matplotlib.plot", "matplotlib.savefig", "matplotlib.savefig", "matplotlib.gcf().clear", "matplotlib.gcf().clear", "cox.COX.util_train.get_batch_data_origin_sorted", "tensorflow.SparseTensorValue", "cox.COX.sess.run", "batch_loss.append", "cox.COX.sess.run", "int", "numpy.mean", "loss_list.append", "print", "range", "matplotlib.gcf", "matplotlib.gcf", "len", "len", "int", "int", "int"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data_origin_sorted"], ["", "def", "train", "(", "self", ")", ":", "\n", "        ", "step", "=", "0", "\n", "epoch", "=", "0", "\n", "loss_list", "=", "[", "]", "\n", "batch_loss", "=", "[", "]", "\n", "\n", "while", "True", ":", "\n", "            ", "x_batch", ",", "b_batch", ",", "z_batch", ",", "y_batch", "=", "self", ".", "util_train", ".", "get_batch_data_origin_sorted", "(", "step", ")", "\n", "feed_dict", "=", "{", "}", "\n", "feed_dict", "[", "self", ".", "X", "]", "=", "tf", ".", "SparseTensorValue", "(", "x_batch", ",", "[", "1", "]", "*", "len", "(", "x_batch", ")", ",", "[", "self", ".", "batch_size", ",", "dimension", "]", ")", "\n", "feed_dict", "[", "self", ".", "b", "]", "=", "b_batch", "\n", "feed_dict", "[", "self", ".", "z", "]", "=", "z_batch", "\n", "feed_dict", "[", "self", ".", "y", "]", "=", "y_batch", "\n", "\n", "self", ".", "sess", ".", "run", "(", "self", ".", "train_step", ",", "feed_dict", ")", "\n", "batch_loss", ".", "append", "(", "self", ".", "sess", ".", "run", "(", "self", ".", "loss", ",", "feed_dict", ")", ")", "\n", "step", "+=", "1", "\n", "\n", "if", "step", "*", "self", ".", "batch_size", "-", "epoch", "*", "int", "(", "0.02", "*", "self", ".", "train_data_amt", ")", ">=", "int", "(", "0.02", "*", "self", ".", "train_data_amt", ")", ":", "\n", "                ", "loss", "=", "np", ".", "mean", "(", "batch_loss", "[", "step", "-", "int", "(", "int", "(", "0.02", "*", "self", ".", "train_data_amt", ")", "/", "self", ".", "batch_size", ")", "-", "1", ":", "]", ")", "\n", "loss_list", ".", "append", "(", "loss", ")", "\n", "print", "(", "\"train loss of epoch-{0} is {1}\"", ".", "format", "(", "epoch", ",", "loss", ")", ")", "\n", "epoch", "+=", "1", "\n", "\n", "# stop condition", "\n", "", "if", "epoch", "*", "0.02", "*", "self", ".", "train_data_amt", "<=", "5", "*", "self", ".", "train_data_amt", ":", "\n", "                ", "continue", "\n", "", "if", "(", "loss_list", "[", "-", "1", "]", "-", "loss_list", "[", "-", "2", "]", ">", "0", "and", "loss_list", "[", "-", "2", "]", "-", "loss_list", "[", "-", "3", "]", ">", "0", ")", ":", "\n", "                ", "break", "\n", "", "if", "epoch", "*", "0.02", "*", "self", ".", "train_data_amt", ">=", "20", "*", "self", ".", "train_data_amt", ":", "\n", "                ", "break", "\n", "\n", "# draw SGD training process", "\n", "", "", "x", "=", "[", "i", "for", "i", "in", "range", "(", "len", "(", "loss_list", ")", ")", "]", "\n", "plt", ".", "plot", "(", "x", ",", "loss_list", ")", "\n", "plt", ".", "savefig", "(", "self", ".", "output_dir", "+", "'train.png'", ")", "\n", "plt", ".", "gcf", "(", ")", ".", "clear", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.cox.COX.test": [[109, 170], ["int", "range", "numpy.mean", "numpy.mean", "numpy.mean", "print", "print", "print", "cox.COX.util_test.get_batch_data_origin", "tensorflow.SparseTensorValue", "cox.COX.sess.run", "cox.COX.sess.run", "cox.COX.sess.run", "numpy.zeros", "numpy.zeros", "numpy.zeros", "range", "numpy.exp", "numpy.exp", "numpy.exp", "numpy.power", "numpy.power", "numpy.power", "numpy.average", "roc_auc_score", "log_loss", "anlp_batch.append", "auc_batch.append", "logloss_batch.append", "open", "f.writelines", "numpy.sum", "numpy.sum", "numpy.sum", "len", "numpy.log"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data_origin"], ["", "def", "test", "(", "self", ")", ":", "\n", "        ", "batch_num", "=", "int", "(", "self", ".", "test_data_amt", "/", "self", ".", "batch_size", ")", "\n", "anlp_batch", "=", "[", "]", "\n", "auc_batch", "=", "[", "]", "\n", "logloss_batch", "=", "[", "]", "\n", "\n", "for", "b", "in", "range", "(", "batch_num", ")", ":", "\n", "            ", "x", ",", "b", ",", "z", ",", "y", "=", "self", ".", "util_test", ".", "get_batch_data_origin", "(", "b", ")", "\n", "feed_dict", "=", "{", "}", "\n", "\n", "feed_dict", "[", "self", ".", "X", "]", "=", "tf", ".", "SparseTensorValue", "(", "x", ",", "[", "1", "]", "*", "len", "(", "x", ")", ",", "[", "self", ".", "batch_size", ",", "dimension", "]", ")", "\n", "feed_dict", "[", "self", ".", "z", "]", "=", "z", "\n", "feed_dict", "[", "self", ".", "y", "]", "=", "y", "\n", "feed_dict", "[", "self", ".", "b", "]", "=", "b", "\n", "\n", "base", "=", "self", ".", "sess", ".", "run", "(", "self", ".", "base", ",", "feed_dict", ")", "\n", "candidate", "=", "self", ".", "sess", ".", "run", "(", "self", ".", "candidate", ",", "feed_dict", ")", "\n", "multiple_times", "=", "self", ".", "sess", ".", "run", "(", "self", ".", "multiple_times", ",", "feed_dict", ")", "\n", "\n", "#get survival rate of b and b+1", "\n", "H0_b", "=", "np", ".", "zeros", "(", "[", "self", ".", "batch_size", ",", "1", "]", ")", "\n", "H0_z", "=", "np", ".", "zeros", "(", "[", "self", ".", "batch_size", ",", "1", "]", ")", "\n", "H0_z1", "=", "np", ".", "zeros", "(", "[", "self", ".", "batch_size", ",", "1", "]", ")", "\n", "for", "i", "in", "range", "(", "self", ".", "batch_size", ")", ":", "\n", "                ", "bid", "=", "b", "[", "i", "]", "[", "0", "]", "\n", "mp", "=", "z", "[", "i", "]", "[", "0", "]", "\n", "H0_b", "[", "i", "]", "[", "0", "]", "=", "np", ".", "sum", "(", "candidate", "[", "base", "<=", "bid", "]", ")", "\n", "H0_z", "[", "i", "]", "[", "0", "]", "=", "np", ".", "sum", "(", "candidate", "[", "base", "<=", "mp", "]", ")", "\n", "H0_z1", "[", "i", "]", "[", "0", "]", "=", "np", ".", "sum", "(", "candidate", "[", "base", "<=", "mp", "+", "1", "]", ")", "\n", "", "S0_b", "=", "np", ".", "exp", "(", "-", "H0_b", ")", "\n", "S0_z", "=", "np", ".", "exp", "(", "-", "H0_z", ")", "\n", "S0_z1", "=", "np", ".", "exp", "(", "-", "H0_z1", ")", "\n", "\n", "S_b", "=", "np", ".", "power", "(", "S0_b", ",", "multiple_times", ")", "\n", "S_z", "=", "np", ".", "power", "(", "S0_z", ",", "multiple_times", ")", "\n", "S_z1", "=", "np", ".", "power", "(", "S0_z1", ",", "multiple_times", ")", "\n", "\n", "p", "=", "S_z", "-", "S_z1", "\n", "p", "[", "p", "<=", "0", "]", "=", "1e-20", "\n", "# print(p[p == 0].size)", "\n", "# print(p[p < 0].size)", "\n", "anlp", "=", "np", ".", "average", "(", "-", "np", ".", "log", "(", "p", ")", ")", "\n", "\n", "W_b", "=", "1", "-", "S_b", "\n", "auc", "=", "roc_auc_score", "(", "y", ",", "W_b", ")", "\n", "logloss", "=", "log_loss", "(", "y", ",", "W_b", ")", "\n", "\n", "anlp_batch", ".", "append", "(", "anlp", ")", "\n", "auc_batch", ".", "append", "(", "auc", ")", "\n", "logloss_batch", ".", "append", "(", "logloss", ")", "\n", "\n", "", "ANLP", "=", "np", ".", "mean", "(", "anlp_batch", ")", "\n", "AUC", "=", "np", ".", "mean", "(", "auc_batch", ")", "\n", "LOGLOSS", "=", "np", ".", "mean", "(", "logloss_batch", ")", "\n", "\n", "print", "(", "\"AUC: {}\"", ".", "format", "(", "AUC", ")", ")", "\n", "print", "(", "\"Log-Loss: {}\"", ".", "format", "(", "LOGLOSS", ")", ")", "\n", "print", "(", "\"ANLP: {}\"", ".", "format", "(", "ANLP", ")", ")", "\n", "\n", "with", "open", "(", "self", ".", "output_dir", "+", "'result.txt'", ",", "'w'", ")", "as", "f", ":", "\n", "            ", "f", ".", "writelines", "(", "[", "\"AUC:{}\\tANLP:{}\\tLog-Loss:{}\"", ".", "format", "(", "AUC", ",", "ANLP", ",", "LOGLOSS", ")", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.gamma_model.Model.__init__": [[14, 73], ["util_train.get_data_amt", "util_test.get_data_amt", "int", "tensorflow.reset_default_graph", "tensorflow.sparse_placeholder", "tensorflow.placeholder", "tensorflow.placeholder", "tensorflow.placeholder", "tensorflow.Variable", "gamma_model.Model.util_train.get_all_data_origin", "tensorflow.Variable", "tensorflow.Variable", "tensorflow.log", "tensorflow.log", "tensorflow.train.GradientDescentOptimizer", "gamma_model.Model.optimizer1.minimize", "tensorflow.placeholder", "tensorflow.log", "tensorflow.train.MomentumOptimizer", "gamma_model.Model.optimizer2.minimize", "tensorflow.ConfigProto", "tensorflow.Session", "tensorflow.global_variables_initializer().run", "os.path.exists", "os.makedirs", "tensorflow.pow", "tensorflow.igamma", "tensorflow.exp", "tensorflow.clip_by_value", "tensorflow.clip_by_value", "tensorflow.reduce_mean", "tensorflow.clip_by_value", "tensorflow.reduce_mean", "tensorflow.truncated_normal", "tensorflow.exp", "tensorflow.lgamma", "tensorflow.square", "tensorflow.nn.l2_loss", "tensorflow.global_variables_initializer", "tensorflow.pow", "tensorflow.exp", "tensorflow.lgamma", "tensorflow.sparse_tensor_dense_matmul"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_data_amt", "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_data_amt", "home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_all_data_origin"], ["    ", "def", "__init__", "(", "self", ",", "lr_1", ",", "lr_2", ",", "l2_loss_weight", ",", "batch_size", ",", "dimension", ",", "theta0", ",", "util_train", ",", "util_test", ",", "campaign", ")", ":", "\n", "        ", "self", ".", "lr_1", "=", "lr_1", "\n", "self", ".", "lr_2", "=", "lr_2", "\n", "self", ".", "util_train", "=", "util_train", "\n", "self", ".", "util_test", "=", "util_test", "\n", "self", ".", "train_data_amt", "=", "util_train", ".", "get_data_amt", "(", ")", "\n", "self", ".", "test_data_amt", "=", "util_test", ".", "get_data_amt", "(", ")", "\n", "self", ".", "batch_size", "=", "batch_size", "\n", "self", ".", "batch_num", "=", "int", "(", "self", ".", "train_data_amt", "/", "self", ".", "batch_size", ")", "\n", "self", ".", "l2_loss_weight", "=", "l2_loss_weight", "\n", "self", ".", "campaign", "=", "campaign", "\n", "\n", "# output directory", "\n", "model_name", "=", "\"{0}_{1}_{2}_{3}\"", ".", "format", "(", "self", ".", "lr_1", ",", "self", ".", "lr_2", ",", "self", ".", "l2_loss_weight", ",", "self", ".", "batch_size", ")", "\n", "self", ".", "output_dir", "=", "'output/gamma/{}/{}/'", ".", "format", "(", "campaign", ",", "model_name", ")", "\n", "if", "not", "os", ".", "path", ".", "exists", "(", "self", ".", "output_dir", ")", ":", "\n", "            ", "os", ".", "makedirs", "(", "self", ".", "output_dir", ")", "\n", "\n", "# reset graph", "\n", "", "tf", ".", "reset_default_graph", "(", ")", "\n", "\n", "# placeholders", "\n", "self", ".", "X", "=", "tf", ".", "sparse_placeholder", "(", "tf", ".", "float64", ")", "\n", "self", ".", "z", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "self", ".", "b", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "self", ".", "y", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "\n", "# trainable variables", "\n", "self", ".", "theta", "=", "tf", ".", "Variable", "(", "[", "theta0", "]", ",", "name", "=", "'theta'", ",", "dtype", "=", "tf", ".", "float64", ")", "\n", "# tf.reshape(self.theta, [1, 1])", "\n", "\n", "all_train_data", "=", "self", ".", "util_train", ".", "get_all_data_origin", "(", ")", "\n", "self", ".", "init_ks_value", "=", "all_train_data", "[", "3", "]", "*", "all_train_data", "[", "2", "]", "/", "theta0", "+", "(", "1", "-", "all_train_data", "[", "3", "]", ")", "*", "all_train_data", "[", "1", "]", "/", "theta0", "\n", "self", ".", "ks", "=", "tf", ".", "Variable", "(", "self", ".", "init_ks_value", ",", "name", "=", "'ks'", ",", "dtype", "=", "tf", ".", "float64", ")", "\n", "self", ".", "w", "=", "tf", ".", "Variable", "(", "initial_value", "=", "tf", ".", "truncated_normal", "(", "shape", "=", "[", "dimension", ",", "1", "]", ",", "dtype", "=", "tf", ".", "float64", ")", ",", "name", "=", "'w'", ")", "\n", "# computation graph phase1", "\n", "self", ".", "ps", "=", "tf", ".", "pow", "(", "self", ".", "z", ",", "(", "self", ".", "ks", "-", "1.", ")", ")", "*", "tf", ".", "exp", "(", "-", "self", ".", "z", "/", "self", ".", "theta", ")", "/", "tf", ".", "exp", "(", "tf", ".", "lgamma", "(", "self", ".", "ks", ")", ")", "/", "tf", ".", "pow", "(", "self", ".", "theta", ",", "self", ".", "ks", ")", "\n", "self", ".", "cs", "=", "tf", ".", "igamma", "(", "self", ".", "ks", ",", "self", ".", "b", "/", "self", ".", "theta", ")", "/", "tf", ".", "exp", "(", "tf", ".", "lgamma", "(", "self", ".", "ks", ")", ")", "\n", "\n", "self", ".", "loss_win", "=", "tf", ".", "log", "(", "tf", ".", "clip_by_value", "(", "self", ".", "ps", ",", "1e-8", ",", "1.0", ")", ")", "\n", "self", ".", "loss_lose", "=", "tf", ".", "log", "(", "tf", ".", "clip_by_value", "(", "1", "-", "self", ".", "cs", ",", "1e-8", ",", "1.0", ")", ")", "\n", "self", ".", "loss_phase1", "=", "-", "tf", ".", "reduce_mean", "(", "self", ".", "y", "*", "self", ".", "loss_win", "+", "(", "1", "-", "self", ".", "y", ")", "*", "self", ".", "loss_lose", ")", "\n", "self", ".", "optimizer1", "=", "tf", ".", "train", ".", "GradientDescentOptimizer", "(", "self", ".", "lr_1", ")", "\n", "self", ".", "train_step1", "=", "self", ".", "optimizer1", ".", "minimize", "(", "self", ".", "loss_phase1", ")", "\n", "\n", "# phase 2", "\n", "self", ".", "label_phase2", "=", "tf", ".", "placeholder", "(", "tf", ".", "float64", ")", "\n", "self", ".", "log_label_phase2", "=", "tf", ".", "log", "(", "tf", ".", "clip_by_value", "(", "self", ".", "label_phase2", ",", "1e-8", ",", "1.0", ")", ")", "\n", "self", ".", "loss_phase2", "=", "tf", ".", "reduce_mean", "(", "tf", ".", "square", "(", "tf", ".", "sparse_tensor_dense_matmul", "(", "self", ".", "X", ",", "self", ".", "w", ")", "-", "self", ".", "log_label_phase2", ")", ")", "+", "self", ".", "l2_loss_weight", "*", "tf", ".", "nn", ".", "l2_loss", "(", "self", ".", "w", ")", "\n", "self", ".", "optimizer2", "=", "tf", ".", "train", ".", "MomentumOptimizer", "(", "self", ".", "lr_2", ",", "0.9", ")", "\n", "self", ".", "train_step2", "=", "self", ".", "optimizer2", ".", "minimize", "(", "self", ".", "loss_phase2", ")", "\n", "\n", "# session initialization", "\n", "config", "=", "tf", ".", "ConfigProto", "(", ")", "\n", "config", ".", "gpu_options", ".", "allow_growth", "=", "True", "\n", "self", ".", "sess", "=", "tf", ".", "Session", "(", "config", "=", "config", ")", "\n", "tf", ".", "global_variables_initializer", "(", ")", ".", "run", "(", "session", "=", "self", ".", "sess", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.gamma_model.Model.train_phase1": [[74, 88], ["gamma_model.Model.util_train.get_all_data_origin", "tensorflow.SparseTensorValue", "print", "range", "gamma_model.Model.sess.run", "gamma_model.Model.sess.run", "print", "len"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_all_data_origin"], ["", "def", "train_phase1", "(", "self", ",", "train_round", "=", "50", ")", ":", "\n", "# get all batches data", "\n", "        ", "x", ",", "b", ",", "z", ",", "y", "=", "self", ".", "util_train", ".", "get_all_data_origin", "(", ")", "\n", "feed_dict", "=", "{", "}", "\n", "feed_dict", "[", "self", ".", "X", "]", "=", "tf", ".", "SparseTensorValue", "(", "x", ",", "[", "1", "]", "*", "len", "(", "x", ")", ",", "[", "b", ".", "shape", "[", "0", "]", ",", "dimension", "]", ")", "\n", "feed_dict", "[", "self", ".", "b", "]", "=", "b", "\n", "feed_dict", "[", "self", ".", "z", "]", "=", "z", "\n", "feed_dict", "[", "self", ".", "y", "]", "=", "y", "\n", "\n", "print", "(", "\"begin training phase 1\"", ")", "\n", "for", "i", "in", "range", "(", "train_round", ")", ":", "\n", "            ", "self", ".", "sess", ".", "run", "(", "self", ".", "train_step1", ",", "feed_dict", ")", "\n", "loss", "=", "self", ".", "sess", ".", "run", "(", "self", ".", "loss_phase1", ",", "feed_dict", ")", "\n", "print", "(", "\"train loss of phase-1, iteration-{0} is {1}\"", ".", "format", "(", "i", ",", "loss", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.gamma_model.Model.train_phase2": [[90, 132], ["gamma_model.Model.ks.eval", "gamma_model.Model.theta.eval", "print", "matplotlib.plot", "matplotlib.plot", "matplotlib.savefig", "matplotlib.savefig", "matplotlib.gcf().clear", "matplotlib.gcf().clear", "gamma_model.Model.util_train.get_batch_data_origin_with_ks", "tensorflow.SparseTensorValue", "gamma_model.Model.sess.run", "batch_loss.append", "gamma_model.Model.sess.run", "int", "numpy.mean", "loss_list.append", "print", "range", "matplotlib.gcf", "matplotlib.gcf", "len", "len", "int", "int", "int"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_batch_data_origin_with_ks"], ["", "", "def", "train_phase2", "(", "self", ")", ":", "\n", "        ", "self", ".", "ks_const", "=", "self", ".", "ks", ".", "eval", "(", "session", "=", "self", ".", "sess", ")", "#np array", "\n", "self", ".", "theta_const", "=", "self", ".", "theta", ".", "eval", "(", "session", "=", "self", ".", "sess", ")", "#np array", "\n", "\n", "step", "=", "0", "\n", "epoch", "=", "0", "\n", "loss_list", "=", "[", "]", "\n", "batch_loss", "=", "[", "]", "\n", "\n", "print", "(", "\"begin training phase 2\"", ")", "\n", "while", "True", ":", "\n", "            ", "x_batch", ",", "b_batch", ",", "z_batch", ",", "y_batch", ",", "ks_batch", "=", "self", ".", "util_train", ".", "get_batch_data_origin_with_ks", "(", "step", ",", "self", ".", "ks_const", ")", "\n", "feed_dict", "=", "{", "}", "\n", "feed_dict", "[", "self", ".", "X", "]", "=", "tf", ".", "SparseTensorValue", "(", "x_batch", ",", "[", "1", "]", "*", "len", "(", "x_batch", ")", ",", "[", "self", ".", "batch_size", ",", "dimension", "]", ")", "\n", "feed_dict", "[", "self", ".", "b", "]", "=", "b_batch", "\n", "feed_dict", "[", "self", ".", "z", "]", "=", "z_batch", "\n", "feed_dict", "[", "self", ".", "y", "]", "=", "y_batch", "\n", "feed_dict", "[", "self", ".", "label_phase2", "]", "=", "self", ".", "theta_const", "*", "ks_batch", "\n", "\n", "self", ".", "sess", ".", "run", "(", "self", ".", "train_step2", ",", "feed_dict", ")", "\n", "batch_loss", ".", "append", "(", "self", ".", "sess", ".", "run", "(", "self", ".", "loss_phase2", ",", "feed_dict", ")", ")", "\n", "step", "+=", "1", "\n", "\n", "if", "step", "*", "self", ".", "batch_size", "-", "epoch", "*", "int", "(", "0.02", "*", "self", ".", "train_data_amt", ")", ">=", "int", "(", "0.02", "*", "self", ".", "train_data_amt", ")", ":", "\n", "                ", "loss", "=", "np", ".", "mean", "(", "batch_loss", "[", "step", "-", "int", "(", "int", "(", "0.02", "*", "self", ".", "train_data_amt", ")", "/", "self", ".", "batch_size", ")", "-", "1", ":", "]", ")", "\n", "loss_list", ".", "append", "(", "loss", ")", "\n", "print", "(", "\"train loss of phase2 epoch-{0} is {1}\"", ".", "format", "(", "epoch", ",", "loss", ")", ")", "\n", "epoch", "+=", "1", "\n", "\n", "# stop condition", "\n", "", "if", "epoch", "*", "0.02", "*", "self", ".", "train_data_amt", "<=", "5", "*", "self", ".", "train_data_amt", ":", "\n", "                ", "continue", "\n", "", "if", "(", "loss_list", "[", "-", "1", "]", "-", "loss_list", "[", "-", "2", "]", ">", "0", "and", "loss_list", "[", "-", "2", "]", "-", "loss_list", "[", "-", "3", "]", ">", "0", ")", ":", "\n", "                ", "break", "\n", "", "if", "epoch", "*", "0.02", "*", "self", ".", "train_data_amt", ">=", "20", "*", "self", ".", "train_data_amt", ":", "\n", "                ", "break", "\n", "\n", "# draw SGD training process", "\n", "", "", "x", "=", "[", "i", "for", "i", "in", "range", "(", "len", "(", "loss_list", ")", ")", "]", "\n", "plt", ".", "plot", "(", "x", ",", "loss_list", ")", "\n", "plt", ".", "savefig", "(", "self", ".", "output_dir", "+", "'train_phase2.png'", ")", "\n", "plt", ".", "gcf", "(", ")", ".", "clear", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.rk2900_drsa.python.gamma_model.Model.test": [[134, 178], ["print", "tensorflow.exp", "tensorflow.reduce_mean", "gamma_model.Model.util_test.get_all_data_origin", "tensorflow.SparseTensorValue", "gamma_model.Model.sess.run", "print", "gamma_model.Model.sess.run", "roc_auc_score", "print", "log_loss", "print", "gamma_model.Model.sess.run", "numpy.mean", "print", "open", "open.writelines", "open.close", "numpy.save", "numpy.save", "numpy.save", "tensorflow.sparse_tensor_dense_matmul", "tensorflow.square", "tensorflow.exp", "tensorflow.igamma", "tensorflow.exp", "tensorflow.log", "gamma_model.Model.sess.run", "gamma_model.Model.sess.run", "gamma_model.Model.sess.run", "len", "tensorflow.pow", "tensorflow.lgamma", "tensorflow.lgamma", "tensorflow.clip_by_value", "numpy.isnan", "tensorflow.pow", "tensorflow.exp"], "methods", ["home.repos.pwc.inspect_result.rk2900_drsa.python.util.Util.get_all_data_origin"], ["", "def", "test", "(", "self", ")", ":", "\n", "        ", "print", "(", "'Test begin'", ")", "\n", "self", ".", "pred_mp", "=", "tf", ".", "exp", "(", "tf", ".", "sparse_tensor_dense_matmul", "(", "self", ".", "X", ",", "self", ".", "w", ")", ")", "\n", "self", ".", "MSE", "=", "tf", ".", "reduce_mean", "(", "tf", ".", "square", "(", "self", ".", "z", "-", "self", ".", "pred_mp", ")", ")", "\n", "\n", "x", ",", "b", ",", "z", ",", "y", "=", "self", ".", "util_test", ".", "get_all_data_origin", "(", ")", "\n", "feed_dict", "=", "{", "}", "\n", "\n", "feed_dict", "[", "self", ".", "X", "]", "=", "tf", ".", "SparseTensorValue", "(", "x", ",", "[", "1", "]", "*", "len", "(", "x", ")", ",", "[", "self", ".", "test_data_amt", ",", "dimension", "]", ")", "\n", "feed_dict", "[", "self", ".", "z", "]", "=", "z", "\n", "feed_dict", "[", "self", ".", "y", "]", "=", "y", "\n", "feed_dict", "[", "self", ".", "b", "]", "=", "b", "\n", "\n", "# calculate MSE", "\n", "mse", "=", "self", ".", "sess", ".", "run", "(", "self", ".", "MSE", ",", "feed_dict", ")", "\n", "print", "(", "\"MSE: {}\"", ".", "format", "(", "mse", ")", ")", "\n", "\n", "ks", "=", "self", ".", "pred_mp", "/", "self", ".", "theta", "\n", "ps", "=", "tf", ".", "pow", "(", "self", ".", "z", ",", "(", "ks", "-", "1.", ")", ")", "*", "tf", ".", "exp", "(", "-", "self", ".", "z", "/", "self", ".", "theta", ")", "/", "tf", ".", "pow", "(", "self", ".", "theta", ",", "ks", ")", "/", "tf", ".", "exp", "(", "tf", ".", "lgamma", "(", "ks", ")", ")", "\n", "cs", "=", "tf", ".", "igamma", "(", "ks", ",", "self", ".", "b", "/", "self", ".", "theta", ")", "/", "tf", ".", "exp", "(", "tf", ".", "lgamma", "(", "ks", ")", ")", "\n", "# calculate AUC and LogLoss", "\n", "win_rate", "=", "self", ".", "sess", ".", "run", "(", "cs", ",", "feed_dict", ")", "\n", "auc", "=", "roc_auc_score", "(", "y", ",", "win_rate", ")", "\n", "print", "(", "\"AUC: {}\"", ".", "format", "(", "auc", ")", ")", "\n", "logloss", "=", "log_loss", "(", "y", ",", "win_rate", ")", "\n", "print", "(", "\"Log Loss: {}\"", ".", "format", "(", "logloss", ")", ")", "\n", "\n", "# calculate ANLP", "\n", "logp", "=", "-", "tf", ".", "log", "(", "tf", ".", "clip_by_value", "(", "ps", ",", "1e-8", ",", "1.0", ")", ")", "\n", "logp_arr", "=", "self", ".", "sess", ".", "run", "(", "logp", ",", "feed_dict", ")", "\n", "logp_arr", "[", "np", ".", "isnan", "(", "logp_arr", ")", "]", "=", "1e-20", "#for overflow values, minor", "\n", "logp_arr", "[", "logp_arr", "==", "0", "]", "=", "1e-20", "\n", "\n", "anlp", "=", "np", ".", "mean", "(", "logp_arr", ")", "\n", "print", "(", "\"ANLP: {}\"", ".", "format", "(", "anlp", ")", ")", "\n", "\n", "# save result and params", "\n", "fin", "=", "open", "(", "self", ".", "output_dir", "+", "'result.txt'", ",", "'w'", ")", "\n", "fin", ".", "writelines", "(", "[", "\"MSE: {0}   AUC: {1}    Log Loss: {2}   ANLP: {3}\\n\"", ".", "format", "(", "mse", ",", "auc", ",", "logloss", ",", "anlp", ")", "]", ")", "\n", "fin", ".", "close", "(", ")", "\n", "\n", "np", ".", "save", "(", "self", ".", "output_dir", "+", "'w'", ",", "self", ".", "sess", ".", "run", "(", "self", ".", "w", ")", ")", "\n", "np", ".", "save", "(", "self", ".", "output_dir", "+", "'k'", ",", "self", ".", "sess", ".", "run", "(", "ks", ",", "feed_dict", ")", ")", "\n", "np", ".", "save", "(", "self", ".", "output_dir", "+", "'theta'", ",", "self", ".", "sess", ".", "run", "(", "self", ".", "theta", ")", ")", "\n", "\n"]]}