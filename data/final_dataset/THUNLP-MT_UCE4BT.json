{"home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.infer_shape": [[12, 30], ["tensorflow.convert_to_tensor", "tf.convert_to_tensor.shape.as_list", "tensorflow.shape", "range", "tensorflow.shape", "len", "ret.append"], "function", ["None"], ["def", "infer_shape", "(", "x", ")", ":", "\n", "    ", "x", "=", "tf", ".", "convert_to_tensor", "(", "x", ")", "\n", "\n", "# If unknown rank, return dynamic shape", "\n", "if", "x", ".", "shape", ".", "dims", "is", "None", ":", "\n", "        ", "return", "tf", ".", "shape", "(", "x", ")", "\n", "\n", "", "static_shape", "=", "x", ".", "shape", ".", "as_list", "(", ")", "\n", "dynamic_shape", "=", "tf", ".", "shape", "(", "x", ")", "\n", "\n", "ret", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "len", "(", "static_shape", ")", ")", ":", "\n", "        ", "dim", "=", "static_shape", "[", "i", "]", "\n", "if", "dim", "is", "None", ":", "\n", "            ", "dim", "=", "dynamic_shape", "[", "i", "]", "\n", "", "ret", ".", "append", "(", "dim", ")", "\n", "\n", "", "return", "ret", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.infer_shape_invariants": [[32, 37], ["tensor.shape.as_list", "range", "tensorflow.TensorShape", "len"], "function", ["None"], ["", "def", "infer_shape_invariants", "(", "tensor", ")", ":", "\n", "    ", "shape", "=", "tensor", ".", "shape", ".", "as_list", "(", ")", "\n", "for", "i", "in", "range", "(", "1", ",", "len", "(", "shape", ")", "-", "1", ")", ":", "\n", "        ", "shape", "[", "i", "]", "=", "None", "\n", "", "return", "tf", ".", "TensorShape", "(", "shape", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.merge_first_two_dims": [[39, 44], ["common.infer_shape", "infer_shape.pop", "tensorflow.reshape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.infer_shape"], ["", "def", "merge_first_two_dims", "(", "tensor", ")", ":", "\n", "    ", "shape", "=", "infer_shape", "(", "tensor", ")", "\n", "shape", "[", "0", "]", "*=", "shape", "[", "1", "]", "\n", "shape", ".", "pop", "(", "1", ")", "\n", "return", "tf", ".", "reshape", "(", "tensor", ",", "shape", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.split_first_two_dims": [[46, 50], ["common.infer_shape", "tensorflow.reshape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.infer_shape"], ["", "def", "split_first_two_dims", "(", "tensor", ",", "dim_0", ",", "dim_1", ")", ":", "\n", "    ", "shape", "=", "infer_shape", "(", "tensor", ")", "\n", "new_shape", "=", "[", "dim_0", "]", "+", "[", "dim_1", "]", "+", "shape", "[", "1", ":", "]", "\n", "return", "tf", ".", "reshape", "(", "tensor", ",", "new_shape", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.tile_to_beam_size": [[52, 59], ["tensorflow.expand_dims", "tensorflow.tile"], "function", ["None"], ["", "def", "tile_to_beam_size", "(", "tensor", ",", "beam_size", ")", ":", "\n", "    ", "\"\"\"Tiles a given tensor by beam_size. \"\"\"", "\n", "tensor", "=", "tf", ".", "expand_dims", "(", "tensor", ",", "axis", "=", "1", ")", "\n", "tile_dims", "=", "[", "1", "]", "*", "tensor", ".", "shape", ".", "ndims", "\n", "tile_dims", "[", "1", "]", "=", "beam_size", "\n", "\n", "return", "tf", ".", "tile", "(", "tensor", ",", "tile_dims", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.tile_batch": [[61, 66], ["tensorflow.tile"], "function", ["None"], ["", "def", "tile_batch", "(", "tensor", ",", "batch_size", ")", ":", "\n", "    ", "tile_dims", "=", "[", "1", "]", "*", "tensor", ".", "shape", ".", "ndims", "\n", "tile_dims", "[", "0", "]", "=", "batch_size", "\n", "\n", "return", "tf", ".", "tile", "(", "tensor", ",", "tile_dims", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch": [[68, 73], ["tensorflow.tile"], "function", ["None"], ["", "def", "repeat_batch", "(", "tensor", ",", "repeat_times", ")", ":", "\n", "# [a, b] to [a, b, a, b]", "\n", "    ", "tile_dims", "=", "[", "1", "]", "*", "(", "tensor", ".", "shape", ".", "ndims", ")", "\n", "tile_dims", "[", "0", "]", "=", "repeat_times", "\n", "return", "tf", ".", "tile", "(", "tensor", ",", "tile_dims", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d": [[75, 90], ["tensorflow.reshape", "tensorflow.stack", "tensorflow.gather_nd", "tensorflow.shape", "tensorflow.shape", "tensorflow.range"], "function", ["None"], ["", "def", "gather_2d", "(", "params", ",", "indices", ",", "name", "=", "None", ")", ":", "\n", "    ", "\"\"\" Gather the 2nd dimension given indices\n    :param params: A tensor with shape [batch_size, M, ...]\n    :param indices: A tensor with shape [batch_size, N]\n    :param name: An optional string\n    :return: A tensor with shape [batch_size, N, ...]\n    \"\"\"", "\n", "batch_size", "=", "tf", ".", "shape", "(", "params", ")", "[", "0", "]", "\n", "range_size", "=", "tf", ".", "shape", "(", "indices", ")", "[", "1", "]", "\n", "batch_pos", "=", "tf", ".", "range", "(", "batch_size", "*", "range_size", ")", "//", "range_size", "\n", "batch_pos", "=", "tf", ".", "reshape", "(", "batch_pos", ",", "[", "batch_size", ",", "range_size", "]", ")", "\n", "indices", "=", "tf", ".", "stack", "(", "[", "batch_pos", ",", "indices", "]", ",", "axis", "=", "-", "1", ")", "\n", "output", "=", "tf", ".", "gather_nd", "(", "params", ",", "indices", ",", "name", "=", "name", ")", "\n", "\n", "return", "output", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.batch_to_moments": [[92, 98], ["tensorflow.split", "tensorflow.python.util.nest.map_structure", "tensorflow.concat", "tensorflow.nn.moments", "tensorflow.expand_dims"], "function", ["None"], ["", "def", "batch_to_moments", "(", "tensor", ",", "res_split", ")", ":", "\n", "    ", "tensor_list", "=", "tf", ".", "split", "(", "tensor", ",", "res_split", ",", "axis", "=", "0", ")", "\n", "tensor_list", "=", "nest", ".", "map_structure", "(", "lambda", "x", ":", "tf", ".", "expand_dims", "(", "x", ",", "axis", "=", "-", "1", ")", ",", "tensor_list", ")", "\n", "tensors", "=", "tf", ".", "concat", "(", "tensor_list", ",", "axis", "=", "-", "1", ")", "\n", "tensor_mean", ",", "tensor_var", "=", "tf", ".", "nn", ".", "moments", "(", "tensors", ",", "axes", "=", "[", "-", "1", "]", ")", "\n", "return", "tensor_mean", ",", "tensor_var", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.inference._get_inference_fn": [[21, 50], ["zip", "tensorflow.pad", "tensorflow.fill", "tensorflow.add_n", "float", "model_fn", "outputs.append", "next_state.append", "model_fn", "outputs.append", "next_state.append", "len", "tensorflow.shape", "tensorflow.shape"], "function", ["None"], ["", "def", "_get_inference_fn", "(", "model_fns", ",", "features", ",", "params", "=", "None", ")", ":", "\n", "    ", "def", "inference_fn", "(", "inputs", ",", "state", ")", ":", "\n", "        ", "local_features", "=", "{", "\n", "\"source\"", ":", "features", "[", "\"source\"", "]", ",", "\n", "\"source_length\"", ":", "features", "[", "\"source_length\"", "]", ",", "\n", "# [bos_id, ...] => [..., 0]", "\n", "\"target\"", ":", "tf", ".", "pad", "(", "inputs", "[", ":", ",", "1", ":", "]", ",", "[", "[", "0", ",", "0", "]", ",", "[", "0", ",", "1", "]", "]", ")", ",", "\n", "\"target_length\"", ":", "tf", ".", "fill", "(", "[", "tf", ".", "shape", "(", "inputs", ")", "[", "0", "]", "]", ",", "\n", "tf", ".", "shape", "(", "inputs", ")", "[", "1", "]", ")", "\n", "}", "\n", "\n", "outputs", "=", "[", "]", "\n", "next_state", "=", "[", "]", "\n", "\n", "for", "(", "model_fn", ",", "model_state", ")", "in", "zip", "(", "model_fns", ",", "state", ")", ":", "\n", "            ", "if", "model_state", ":", "\n", "                ", "output", ",", "new_state", "=", "model_fn", "(", "local_features", ",", "model_state", ")", "\n", "outputs", ".", "append", "(", "output", ")", "\n", "next_state", ".", "append", "(", "new_state", ")", "\n", "", "else", ":", "\n", "                ", "output", "=", "model_fn", "(", "local_features", ")", "\n", "outputs", ".", "append", "(", "output", ")", "\n", "next_state", ".", "append", "(", "{", "}", ")", "\n", "\n", "# Ensemble", "\n", "", "", "log_prob", "=", "tf", ".", "add_n", "(", "outputs", ")", "/", "float", "(", "len", "(", "outputs", ")", ")", "\n", "return", "log_prob", ",", "next_state", "\n", "\n", "", "return", "inference_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.inference._beam_search_step": [[52, 144], ["thumt.merge_first_two_dims", "tensorflow.python.util.nest.map_structure", "func", "thumt.split_first_two_dims", "tensorflow.python.util.nest.map_structure", "tensorflow.pow", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.nn.top_k", "thumt.gather_2d", "thumt.gather_2d", "tensorflow.concat", "thumt.gather_2d", "tensorflow.concat", "tensorflow.equal", "tensorflow.nn.top_k", "thumt.gather_2d", "thumt.gather_2d", "thumt.gather_2d", "thumt.gather_2d", "thumt.gather_2d", "tensorflow.concat", "tensorflow.concat", "tensorflow.python.util.nest.map_structure", "tensorflow.concat", "tensorflow.concat", "tensorflow.nn.top_k", "thumt.gather_2d", "tensorflow.fill", "tensorflow.fill", "tensorflow.concat", "tensorflow.concat", "tensorflow.concat", "tensorflow.concat", "thumt.gather_2d", "thumt.gather_2d", "inference.BeamSearchState", "tensorflow.expand_dims", "tensorflow.constant", "tensorflow.constant", "thumt.merge_first_two_dims", "thumt.split_first_two_dims", "tensorflow.shape", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.to_float", "tensorflow.expand_dims", "tensorflow.expand_dims", "thumt.gather_2d", "tensorflow.to_float", "tensorflow.to_float"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.merge_first_two_dims", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.split_first_two_dims", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.merge_first_two_dims", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.split_first_two_dims", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d"], ["", "def", "_beam_search_step", "(", "time", ",", "func", ",", "state", ",", "batch_size", ",", "beam_size", ",", "alpha", ",", "\n", "pad_id", ",", "eos_id", ")", ":", "\n", "# Compute log probabilities", "\n", "    ", "seqs", ",", "log_probs", "=", "state", ".", "inputs", "[", ":", "2", "]", "\n", "seq_probs", "=", "state", ".", "inputs", "[", "3", "]", "# shape: [batch_size, beam_size, seq_len]", "\n", "flat_seqs", "=", "utils", ".", "merge_first_two_dims", "(", "seqs", ")", "\n", "flat_state", "=", "nest", ".", "map_structure", "(", "lambda", "x", ":", "utils", ".", "merge_first_two_dims", "(", "x", ")", ",", "\n", "state", ".", "state", ")", "\n", "step_log_probs", ",", "next_state", "=", "func", "(", "flat_seqs", ",", "flat_state", ")", "\n", "step_log_probs", "=", "utils", ".", "split_first_two_dims", "(", "step_log_probs", ",", "batch_size", ",", "\n", "beam_size", ")", "# shape: [batch_size, beam_size, vocab_size]", "\n", "next_state", "=", "nest", ".", "map_structure", "(", "\n", "lambda", "x", ":", "utils", ".", "split_first_two_dims", "(", "x", ",", "batch_size", ",", "beam_size", ")", ",", "\n", "next_state", ")", "\n", "# step_log_probs = tf.Print(step_log_probs, [tf.shape(log_probs), tf.shape(step_log_probs)], summarize=50)", "\n", "curr_log_probs", "=", "tf", ".", "expand_dims", "(", "log_probs", ",", "2", ")", "+", "step_log_probs", "# shape: [batch_size, beam_size, vocab_size]", "\n", "\n", "# Apply length penalty", "\n", "length_penalty", "=", "tf", ".", "pow", "(", "(", "5.0", "+", "tf", ".", "to_float", "(", "time", "+", "1", ")", ")", "/", "6.0", ",", "alpha", ")", "\n", "curr_scores", "=", "curr_log_probs", "/", "length_penalty", "# shape: [batch_size, beam_size, vocab_size]", "\n", "vocab_size", "=", "curr_scores", ".", "shape", "[", "-", "1", "]", ".", "value", "or", "tf", ".", "shape", "(", "curr_scores", ")", "[", "-", "1", "]", "\n", "\n", "# Select top-k candidates", "\n", "# [batch_size, beam_size * vocab_size]", "\n", "curr_scores", "=", "tf", ".", "reshape", "(", "curr_scores", ",", "[", "-", "1", ",", "beam_size", "*", "vocab_size", "]", ")", "\n", "flat_step_log_probs", "=", "tf", ".", "reshape", "(", "step_log_probs", ",", "[", "-", "1", ",", "beam_size", "*", "vocab_size", "]", ")", "# wangshuo", "\n", "\n", "# [batch_size, 2 * beam_size]", "\n", "top_scores", ",", "top_indices", "=", "tf", ".", "nn", ".", "top_k", "(", "curr_scores", ",", "k", "=", "2", "*", "beam_size", ")", "\n", "top_word_scores", "=", "utils", ".", "gather_2d", "(", "flat_step_log_probs", ",", "top_indices", ")", "\n", "# Shape: [batch_size, 2 * beam_size]", "\n", "beam_indices", "=", "top_indices", "//", "vocab_size", "\n", "symbol_indices", "=", "top_indices", "%", "vocab_size", "\n", "# Expand sequences", "\n", "# [batch_size, 2 * beam_size, time]", "\n", "candidate_seqs", "=", "utils", ".", "gather_2d", "(", "seqs", ",", "beam_indices", ")", "\n", "candidate_seqs", "=", "tf", ".", "concat", "(", "[", "candidate_seqs", ",", "\n", "tf", ".", "expand_dims", "(", "symbol_indices", ",", "2", ")", "]", ",", "2", ")", "\n", "candidate_seq_probs", "=", "utils", ".", "gather_2d", "(", "seq_probs", ",", "beam_indices", ")", "\n", "candidate_seq_probs", "=", "tf", ".", "concat", "(", "[", "candidate_seq_probs", ",", "\n", "tf", ".", "expand_dims", "(", "top_word_scores", ",", "2", ")", "]", ",", "2", ")", "\n", "\n", "# Expand sequences", "\n", "# Suppress finished sequences", "\n", "flags", "=", "tf", ".", "equal", "(", "symbol_indices", ",", "eos_id", ")", "# [batch, 2 * beam_size]", "\n", "alive_scores", "=", "top_scores", "+", "tf", ".", "to_float", "(", "flags", ")", "*", "tf", ".", "float32", ".", "min", "# [batch, 2 * beam_size]", "\n", "# [batch, beam_size]", "\n", "alive_scores", ",", "alive_indices", "=", "tf", ".", "nn", ".", "top_k", "(", "alive_scores", ",", "beam_size", ")", "\n", "alive_symbols", "=", "utils", ".", "gather_2d", "(", "symbol_indices", ",", "alive_indices", ")", "\n", "alive_word_scores", "=", "utils", ".", "gather_2d", "(", "top_word_scores", ",", "alive_indices", ")", "\n", "\n", "alive_indices", "=", "utils", ".", "gather_2d", "(", "beam_indices", ",", "alive_indices", ")", "\n", "alive_seqs", "=", "utils", ".", "gather_2d", "(", "seqs", ",", "alive_indices", ")", "\n", "alive_seq_probs", "=", "utils", ".", "gather_2d", "(", "seq_probs", ",", "alive_indices", ")", "\n", "\n", "# [batch_size, beam_size, time + 1]", "\n", "alive_seqs", "=", "tf", ".", "concat", "(", "[", "alive_seqs", ",", "tf", ".", "expand_dims", "(", "alive_symbols", ",", "2", ")", "]", ",", "2", ")", "\n", "alive_seq_probs", "=", "tf", ".", "concat", "(", "[", "alive_seq_probs", ",", "tf", ".", "expand_dims", "(", "alive_word_scores", ",", "2", ")", "]", ",", "2", ")", "\n", "\n", "alive_state", "=", "nest", ".", "map_structure", "(", "\n", "lambda", "x", ":", "utils", ".", "gather_2d", "(", "x", ",", "alive_indices", ")", ",", "\n", "next_state", ")", "\n", "alive_log_probs", "=", "alive_scores", "*", "length_penalty", "# Revert to scores before divided by length penalty", "\n", "\n", "# Select finished sequences", "\n", "prev_fin_flags", ",", "prev_fin_seqs", ",", "prev_fin_scores", ",", "prev_fin_seq_probs", "=", "state", ".", "finish", "\n", "# [batch, 2 * beam_size]", "\n", "step_fin_scores", "=", "top_scores", "+", "(", "1.0", "-", "tf", ".", "to_float", "(", "flags", ")", ")", "*", "tf", ".", "float32", ".", "min", "\n", "# [batch, 3 * beam_size]", "\n", "fin_flags", "=", "tf", ".", "concat", "(", "[", "prev_fin_flags", ",", "flags", "]", ",", "axis", "=", "1", ")", "\n", "fin_scores", "=", "tf", ".", "concat", "(", "[", "prev_fin_scores", ",", "step_fin_scores", "]", ",", "axis", "=", "1", ")", "\n", "# [batch, beam_size]", "\n", "fin_scores", ",", "fin_indices", "=", "tf", ".", "nn", ".", "top_k", "(", "fin_scores", ",", "beam_size", ")", "\n", "fin_flags", "=", "utils", ".", "gather_2d", "(", "fin_flags", ",", "fin_indices", ")", "\n", "pad_seqs", "=", "tf", ".", "fill", "(", "[", "batch_size", ",", "beam_size", ",", "1", "]", ",", "\n", "tf", ".", "constant", "(", "pad_id", ",", "tf", ".", "int32", ")", ")", "\n", "pad_seq_probs", "=", "tf", ".", "fill", "(", "[", "batch_size", ",", "beam_size", ",", "1", "]", ",", "\n", "tf", ".", "constant", "(", "0", ",", "tf", ".", "float32", ")", ")", "\n", "prev_fin_seqs", "=", "tf", ".", "concat", "(", "[", "prev_fin_seqs", ",", "pad_seqs", "]", ",", "axis", "=", "2", ")", "\n", "prev_fin_seq_probs", "=", "tf", ".", "concat", "(", "[", "prev_fin_seq_probs", ",", "pad_seq_probs", "]", ",", "axis", "=", "2", ")", "\n", "fin_seqs", "=", "tf", ".", "concat", "(", "[", "prev_fin_seqs", ",", "candidate_seqs", "]", ",", "axis", "=", "1", ")", "\n", "fin_seq_probs", "=", "tf", ".", "concat", "(", "[", "prev_fin_seq_probs", ",", "candidate_seq_probs", "]", ",", "axis", "=", "1", ")", "\n", "fin_seqs", "=", "utils", ".", "gather_2d", "(", "fin_seqs", ",", "fin_indices", ")", "\n", "fin_seq_probs", "=", "utils", ".", "gather_2d", "(", "fin_seq_probs", ",", "fin_indices", ")", "\n", "\n", "new_state", "=", "BeamSearchState", "(", "\n", "inputs", "=", "(", "alive_seqs", ",", "alive_log_probs", ",", "alive_scores", ",", "alive_seq_probs", ")", ",", "\n", "state", "=", "alive_state", ",", "\n", "finish", "=", "(", "fin_flags", ",", "fin_seqs", ",", "fin_scores", ",", "fin_seq_probs", ")", "\n", ")", "\n", "\n", "return", "time", "+", "1", ",", "new_state", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.inference.beam_search": [[146, 231], ["tensorflow.fill", "tensorflow.fill", "tensorflow.constant", "tensorflow.tile", "tensorflow.zeros_like", "tensorflow.zeros", "tensorflow.zeros", "tensorflow.fill", "tensorflow.zeros", "inference.BeamSearchState", "tensorflow.reduce_max", "tensorflow.constant", "inference.BeamSearchState", "tensorflow.while_loop", "alive_seqs.set_shape", "alive_seq_probs.set_shape", "tf.where.set_shape", "tf.where.set_shape", "tensorflow.where", "tensorflow.where", "tensorflow.where", "tensorflow.pow", "tensorflow.reduce_min", "tensorflow.reduce_all", "tensorflow.logical_and", "inference._beam_search_step", "tensorflow.reduce_any", "tensorflow.reduce_any", "tensorflow.reduce_any", "tensorflow.to_float", "tensorflow.greater", "tensorflow.less", "tensorflow.logical_not", "tensorflow.python.util.nest.map_structure", "tensorflow.to_float", "tensorflow.reduce_any", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.to_float"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.inference._beam_search_step"], ["", "def", "beam_search", "(", "func", ",", "state", ",", "batch_size", ",", "beam_size", ",", "max_length", ",", "alpha", ",", "\n", "pad_id", ",", "bos_id", ",", "eos_id", ")", ":", "\n", "    ", "init_seqs", "=", "tf", ".", "fill", "(", "[", "batch_size", ",", "beam_size", ",", "1", "]", ",", "bos_id", ")", "\n", "init_seq_probs", "=", "tf", ".", "fill", "(", "[", "batch_size", ",", "beam_size", ",", "1", "]", ",", "0.0", ")", "\n", "init_log_probs", "=", "tf", ".", "constant", "(", "[", "[", "0.", "]", "+", "[", "tf", ".", "float32", ".", "min", "]", "*", "(", "beam_size", "-", "1", ")", "]", ")", "# shape: [1, beam_size]", "\n", "init_log_probs", "=", "tf", ".", "tile", "(", "init_log_probs", ",", "[", "batch_size", ",", "1", "]", ")", "# shape: [batch_size, beam_size]", "\n", "init_scores", "=", "tf", ".", "zeros_like", "(", "init_log_probs", ")", "# shape: [batch_size, beam_size]", "\n", "\n", "fin_seqs", "=", "tf", ".", "zeros", "(", "[", "batch_size", ",", "beam_size", ",", "1", "]", ",", "tf", ".", "int32", ")", "\n", "fin_seq_probs", "=", "tf", ".", "zeros", "(", "[", "batch_size", ",", "beam_size", ",", "1", "]", ",", "tf", ".", "float32", ")", "\n", "fin_scores", "=", "tf", ".", "fill", "(", "[", "batch_size", ",", "beam_size", "]", ",", "tf", ".", "float32", ".", "min", ")", "\n", "fin_flags", "=", "tf", ".", "zeros", "(", "[", "batch_size", ",", "beam_size", "]", ",", "tf", ".", "bool", ")", "\n", "\n", "state", "=", "BeamSearchState", "(", "\n", "inputs", "=", "(", "init_seqs", ",", "init_log_probs", ",", "init_scores", ",", "init_seq_probs", ")", ",", "\n", "state", "=", "state", ",", "\n", "finish", "=", "(", "fin_flags", ",", "fin_seqs", ",", "fin_scores", ",", "fin_seq_probs", ")", "\n", ")", "\n", "\n", "max_step", "=", "tf", ".", "reduce_max", "(", "max_length", ")", "\n", "\n", "def", "_is_finished", "(", "t", ",", "s", ")", ":", "\n", "        ", "log_probs", "=", "s", ".", "inputs", "[", "1", "]", "\n", "finished_flags", "=", "s", ".", "finish", "[", "0", "]", "\n", "finished_scores", "=", "s", ".", "finish", "[", "2", "]", "\n", "max_lp", "=", "tf", ".", "pow", "(", "(", "(", "5.0", "+", "tf", ".", "to_float", "(", "max_step", ")", ")", "/", "6.0", ")", ",", "alpha", ")", "\n", "best_alive_score", "=", "log_probs", "[", ":", ",", "0", "]", "/", "max_lp", "\n", "worst_finished_score", "=", "tf", ".", "reduce_min", "(", "\n", "finished_scores", "*", "tf", ".", "to_float", "(", "finished_flags", ")", ",", "axis", "=", "1", ")", "\n", "add_mask", "=", "1.0", "-", "tf", ".", "to_float", "(", "tf", ".", "reduce_any", "(", "finished_flags", ",", "1", ")", ")", "\n", "worst_finished_score", "+=", "tf", ".", "float32", ".", "min", "*", "add_mask", "\n", "bound_is_met", "=", "tf", ".", "reduce_all", "(", "tf", ".", "greater", "(", "worst_finished_score", ",", "\n", "best_alive_score", ")", ")", "\n", "\n", "cond", "=", "tf", ".", "logical_and", "(", "tf", ".", "less", "(", "t", ",", "max_step", ")", ",", "\n", "tf", ".", "logical_not", "(", "bound_is_met", ")", ")", "\n", "\n", "return", "cond", "\n", "\n", "", "def", "_loop_fn", "(", "t", ",", "s", ")", ":", "\n", "        ", "outs", "=", "_beam_search_step", "(", "t", ",", "func", ",", "s", ",", "batch_size", ",", "beam_size", ",", "alpha", ",", "\n", "pad_id", ",", "eos_id", ")", "\n", "return", "outs", "\n", "\n", "", "time", "=", "tf", ".", "constant", "(", "0", ",", "name", "=", "\"time\"", ")", "\n", "shape_invariants", "=", "BeamSearchState", "(", "\n", "inputs", "=", "(", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", ",", "None", "]", ")", ",", "\n", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", "]", ")", ",", "\n", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", "]", ")", ",", "\n", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", ",", "None", "]", ")", ")", ",", "\n", "state", "=", "nest", ".", "map_structure", "(", "utils", ".", "infer_shape_invariants", ",", "state", ".", "state", ")", ",", "\n", "finish", "=", "(", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", "]", ")", ",", "\n", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", ",", "None", "]", ")", ",", "\n", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", "]", ")", ",", "\n", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", ",", "None", "]", ")", ")", "\n", ")", "\n", "outputs", "=", "tf", ".", "while_loop", "(", "_is_finished", ",", "_loop_fn", ",", "[", "time", ",", "state", "]", ",", "\n", "shape_invariants", "=", "[", "tf", ".", "TensorShape", "(", "[", "]", ")", ",", "\n", "shape_invariants", "]", ",", "\n", "parallel_iterations", "=", "1", ",", "\n", "back_prop", "=", "False", ")", "\n", "\n", "final_state", "=", "outputs", "[", "1", "]", "\n", "alive_seqs", "=", "final_state", ".", "inputs", "[", "0", "]", "\n", "alive_seq_probs", "=", "final_state", ".", "inputs", "[", "3", "]", "\n", "alive_scores", "=", "final_state", ".", "inputs", "[", "2", "]", "\n", "final_flags", "=", "final_state", ".", "finish", "[", "0", "]", "\n", "final_seqs", "=", "final_state", ".", "finish", "[", "1", "]", "\n", "final_seq_probs", "=", "final_state", ".", "finish", "[", "3", "]", "\n", "final_scores", "=", "final_state", ".", "finish", "[", "2", "]", "\n", "\n", "alive_seqs", ".", "set_shape", "(", "[", "None", ",", "beam_size", ",", "None", "]", ")", "\n", "alive_seq_probs", ".", "set_shape", "(", "[", "None", ",", "beam_size", ",", "None", "]", ")", "\n", "final_seqs", ".", "set_shape", "(", "[", "None", ",", "beam_size", ",", "None", "]", ")", "\n", "final_seq_probs", ".", "set_shape", "(", "[", "None", ",", "beam_size", ",", "None", "]", ")", "\n", "\n", "final_seqs", "=", "tf", ".", "where", "(", "tf", ".", "reduce_any", "(", "final_flags", ",", "1", ")", ",", "final_seqs", ",", "\n", "alive_seqs", ")", "\n", "final_seq_probs", "=", "tf", ".", "where", "(", "tf", ".", "reduce_any", "(", "final_flags", ",", "1", ")", ",", "final_seq_probs", ",", "\n", "alive_seq_probs", ")", "\n", "\n", "final_scores", "=", "tf", ".", "where", "(", "tf", ".", "reduce_any", "(", "final_flags", ",", "1", ")", ",", "final_scores", ",", "\n", "alive_scores", ")", "\n", "\n", "return", "final_seqs", ",", "final_scores", ",", "final_seq_probs", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.inference.create_inference_graph": [[233, 296], ["copy.copy", "tensorflow.expand_dims", "tensorflow.tile", "tensorflow.shape", "tensorflow.reshape", "tensorflow.expand_dims", "tensorflow.tile", "tensorflow.shape", "tensorflow.reshape", "inference._get_inference_fn", "tensorflow.python.util.nest.map_structure", "inference.beam_search", "isinstance", "ValueError", "model.get_inference_func", "callable", "tensorflow.shape", "nest.map_structure.append", "funcs.append", "nest.map_structure.append", "funcs.append", "thumt.tile_to_beam_size"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.sampling._get_inference_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.inference.beam_search", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_inference_func", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.tile_to_beam_size"], ["", "def", "create_inference_graph", "(", "models", ",", "features", ",", "params", ")", ":", "\n", "    ", "if", "not", "isinstance", "(", "models", ",", "(", "list", ",", "tuple", ")", ")", ":", "\n", "        ", "raise", "ValueError", "(", "\"'models' must be a list or tuple\"", ")", "\n", "\n", "", "features", "=", "copy", ".", "copy", "(", "features", ")", "\n", "model_fns", "=", "[", "model", ".", "get_inference_func", "(", ")", "for", "model", "in", "models", "]", "\n", "\n", "decode_length", "=", "params", ".", "decode_length", "\n", "beam_size", "=", "params", ".", "beam_size", "\n", "top_beams", "=", "params", ".", "top_beams", "\n", "alpha", "=", "params", ".", "decode_alpha", "\n", "\n", "# Compute initial state if necessary", "\n", "states", "=", "[", "]", "\n", "funcs", "=", "[", "]", "\n", "\n", "for", "model_fn", "in", "model_fns", ":", "\n", "        ", "if", "callable", "(", "model_fn", ")", ":", "\n", "# For non-incremental decoding", "\n", "            ", "states", ".", "append", "(", "{", "}", ")", "\n", "funcs", ".", "append", "(", "model_fn", ")", "\n", "", "else", ":", "\n", "# For incremental decoding where model_fn is a tuple:", "\n", "# (encoding_fn, decoding_fn)", "\n", "            ", "states", ".", "append", "(", "model_fn", "[", "0", "]", "(", "features", ")", ")", "\n", "funcs", ".", "append", "(", "model_fn", "[", "1", "]", ")", "\n", "\n", "", "", "batch_size", "=", "tf", ".", "shape", "(", "features", "[", "\"source\"", "]", ")", "[", "0", "]", "\n", "pad_id", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "pad", "]", "\n", "bos_id", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "bos", "]", "\n", "eos_id", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "eos", "]", "\n", "\n", "# Expand the inputs", "\n", "# [batch, length] => [batch, beam_size, length]", "\n", "features", "[", "\"source\"", "]", "=", "tf", ".", "expand_dims", "(", "features", "[", "\"source\"", "]", ",", "1", ")", "\n", "features", "[", "\"source\"", "]", "=", "tf", ".", "tile", "(", "features", "[", "\"source\"", "]", ",", "[", "1", ",", "beam_size", ",", "1", "]", ")", "\n", "shape", "=", "tf", ".", "shape", "(", "features", "[", "\"source\"", "]", ")", "\n", "\n", "# [batch, beam_size, length] => [batch * beam_size, length]", "\n", "features", "[", "\"source\"", "]", "=", "tf", ".", "reshape", "(", "features", "[", "\"source\"", "]", ",", "\n", "[", "shape", "[", "0", "]", "*", "shape", "[", "1", "]", ",", "shape", "[", "2", "]", "]", ")", "\n", "\n", "# For source sequence length", "\n", "features", "[", "\"source_length\"", "]", "=", "tf", ".", "expand_dims", "(", "features", "[", "\"source_length\"", "]", ",", "1", ")", "\n", "features", "[", "\"source_length\"", "]", "=", "tf", ".", "tile", "(", "features", "[", "\"source_length\"", "]", ",", "\n", "[", "1", ",", "beam_size", "]", ")", "\n", "shape", "=", "tf", ".", "shape", "(", "features", "[", "\"source_length\"", "]", ")", "\n", "\n", "max_length", "=", "features", "[", "\"source_length\"", "]", "+", "decode_length", "\n", "# max_length = tf.Print(max_length, [features[\"source_length\"], max_length])", "\n", "\n", "# [batch, beam_size, length] => [batch * beam_size, length]", "\n", "features", "[", "\"source_length\"", "]", "=", "tf", ".", "reshape", "(", "features", "[", "\"source_length\"", "]", ",", "\n", "[", "shape", "[", "0", "]", "*", "shape", "[", "1", "]", "]", ")", "\n", "decoding_fn", "=", "_get_inference_fn", "(", "funcs", ",", "features", ",", "params", ")", "\n", "states", "=", "nest", ".", "map_structure", "(", "\n", "lambda", "x", ":", "utils", ".", "tile_to_beam_size", "(", "x", ",", "beam_size", ")", ",", "\n", "states", ")", "\n", "\n", "seqs", ",", "scores", ",", "word_scores", "=", "beam_search", "(", "decoding_fn", ",", "states", ",", "batch_size", ",", "beam_size", ",", "\n", "max_length", ",", "alpha", ",", "pad_id", ",", "bos_id", ",", "eos_id", ")", "\n", "\n", "return", "seqs", "[", ":", ",", ":", "top_beams", ",", "1", ":", "]", ",", "scores", "[", ":", ",", ":", "top_beams", "]", ",", "word_scores", "[", ":", ",", ":", "top_beams", ",", "1", ":", "]", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.closest_length": [[13, 29], ["len", "len", "abs"], "function", ["None"], ["def", "closest_length", "(", "candidate", ",", "references", ")", ":", "\n", "    ", "clen", "=", "len", "(", "candidate", ")", "\n", "closest_diff", "=", "9999", "\n", "closest_len", "=", "9999", "\n", "\n", "for", "reference", "in", "references", ":", "\n", "        ", "rlen", "=", "len", "(", "reference", ")", "\n", "diff", "=", "abs", "(", "rlen", "-", "clen", ")", "\n", "\n", "if", "diff", "<", "closest_diff", ":", "\n", "            ", "closest_diff", "=", "diff", "\n", "closest_len", "=", "rlen", "\n", "", "elif", "diff", "==", "closest_diff", ":", "\n", "            ", "closest_len", "=", "rlen", "if", "rlen", "<", "closest_len", "else", "closest_len", "\n", "\n", "", "", "return", "closest_len", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.shortest_length": [[31, 33], ["min", "len"], "function", ["None"], ["", "def", "shortest_length", "(", "references", ")", ":", "\n", "    ", "return", "min", "(", "[", "len", "(", "ref", ")", "for", "ref", "in", "references", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.modified_precision": [[35, 58], ["collections.Counter", "collections.Counter.items", "len", "collections.Counter", "min", "float", "float", "len", "tuple", "tuple", "max", "sum", "sum", "range", "len", "range", "clipped_counts.values", "collections.Counter.values"], "function", ["None"], ["", "def", "modified_precision", "(", "candidate", ",", "references", ",", "n", ")", ":", "\n", "    ", "tngrams", "=", "len", "(", "candidate", ")", "+", "1", "-", "n", "\n", "counts", "=", "Counter", "(", "[", "tuple", "(", "candidate", "[", "i", ":", "i", "+", "n", "]", ")", "for", "i", "in", "range", "(", "tngrams", ")", "]", ")", "\n", "\n", "if", "len", "(", "counts", ")", "==", "0", ":", "\n", "        ", "return", "0", ",", "0", "\n", "\n", "", "max_counts", "=", "{", "}", "\n", "for", "reference", "in", "references", ":", "\n", "        ", "rngrams", "=", "len", "(", "reference", ")", "+", "1", "-", "n", "\n", "ngrams", "=", "[", "tuple", "(", "reference", "[", "i", ":", "i", "+", "n", "]", ")", "for", "i", "in", "range", "(", "rngrams", ")", "]", "\n", "ref_counts", "=", "Counter", "(", "ngrams", ")", "\n", "for", "ngram", "in", "counts", ":", "\n", "            ", "mcount", "=", "0", "if", "ngram", "not", "in", "max_counts", "else", "max_counts", "[", "ngram", "]", "\n", "rcount", "=", "0", "if", "ngram", "not", "in", "ref_counts", "else", "ref_counts", "[", "ngram", "]", "\n", "max_counts", "[", "ngram", "]", "=", "max", "(", "mcount", ",", "rcount", ")", "\n", "\n", "", "", "clipped_counts", "=", "{", "}", "\n", "\n", "for", "ngram", ",", "count", "in", "counts", ".", "items", "(", ")", ":", "\n", "        ", "clipped_counts", "[", "ngram", "]", "=", "min", "(", "count", ",", "max_counts", "[", "ngram", "]", ")", "\n", "\n", "", "return", "float", "(", "sum", "(", "clipped_counts", ".", "values", "(", ")", ")", ")", ",", "float", "(", "sum", "(", "counts", ".", "values", "(", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.brevity_penalty": [[60, 76], ["zip", "math.exp", "len", "min", "bleu.shortest_length", "bleu.closest_length"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.shortest_length", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.closest_length"], ["", "def", "brevity_penalty", "(", "trans", ",", "refs", ",", "mode", "=", "\"closest\"", ")", ":", "\n", "    ", "bp_c", "=", "0.0", "\n", "bp_r", "=", "0.0", "\n", "\n", "for", "candidate", ",", "references", "in", "zip", "(", "trans", ",", "refs", ")", ":", "\n", "        ", "bp_c", "+=", "len", "(", "candidate", ")", "\n", "\n", "if", "mode", "==", "\"shortest\"", ":", "\n", "            ", "bp_r", "+=", "shortest_length", "(", "references", ")", "\n", "", "else", ":", "\n", "            ", "bp_r", "+=", "closest_length", "(", "candidate", ",", "references", ")", "\n", "\n", "# Prevent zero divide", "\n", "", "", "bp_c", "=", "bp_c", "or", "1.0", "\n", "\n", "return", "math", ".", "exp", "(", "min", "(", "0", ",", "1.0", "-", "bp_r", "/", "bp_c", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.bleu": [[78, 113], ["zip", "range", "bleu.brevity_penalty", "range", "sum", "math.exp", "range", "range", "bleu.modified_precision", "range", "math.log", "len", "ValueError", "sum", "float", "float", "float", "range"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.brevity_penalty", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.modified_precision"], ["", "def", "bleu", "(", "trans", ",", "refs", ",", "bp", "=", "\"closest\"", ",", "smooth", "=", "False", ",", "n", "=", "4", ",", "weights", "=", "None", ")", ":", "\n", "    ", "p_norm", "=", "[", "0", "for", "_", "in", "range", "(", "n", ")", "]", "\n", "p_denorm", "=", "[", "0", "for", "_", "in", "range", "(", "n", ")", "]", "\n", "\n", "for", "candidate", ",", "references", "in", "zip", "(", "trans", ",", "refs", ")", ":", "\n", "        ", "for", "i", "in", "range", "(", "n", ")", ":", "\n", "            ", "ccount", ",", "tcount", "=", "modified_precision", "(", "candidate", ",", "references", ",", "i", "+", "1", ")", "\n", "p_norm", "[", "i", "]", "+=", "ccount", "\n", "p_denorm", "[", "i", "]", "+=", "tcount", "\n", "\n", "", "", "bleu_n", "=", "[", "0", "for", "_", "in", "range", "(", "n", ")", "]", "\n", "\n", "for", "i", "in", "range", "(", "n", ")", ":", "\n", "# add one smoothing", "\n", "        ", "if", "smooth", "and", "i", ">", "0", ":", "\n", "            ", "p_norm", "[", "i", "]", "+=", "1", "\n", "p_denorm", "[", "i", "]", "+=", "1", "\n", "\n", "", "if", "p_norm", "[", "i", "]", "==", "0", "or", "p_denorm", "[", "i", "]", "==", "0", ":", "\n", "            ", "bleu_n", "[", "i", "]", "=", "-", "9999", "\n", "", "else", ":", "\n", "            ", "bleu_n", "[", "i", "]", "=", "math", ".", "log", "(", "float", "(", "p_norm", "[", "i", "]", ")", "/", "float", "(", "p_denorm", "[", "i", "]", ")", ")", "\n", "\n", "", "", "if", "weights", ":", "\n", "        ", "if", "len", "(", "weights", ")", "!=", "n", ":", "\n", "            ", "raise", "ValueError", "(", "\"len(weights) != n: invalid weight number\"", ")", "\n", "", "log_precision", "=", "sum", "(", "[", "bleu_n", "[", "i", "]", "*", "weights", "[", "i", "]", "for", "i", "in", "range", "(", "n", ")", "]", ")", "\n", "", "else", ":", "\n", "        ", "log_precision", "=", "sum", "(", "bleu_n", ")", "/", "float", "(", "n", ")", "\n", "\n", "", "bp", "=", "brevity_penalty", "(", "trans", ",", "refs", ",", "bp", ")", "\n", "\n", "score", "=", "bp", "*", "math", ".", "exp", "(", "log_precision", ")", "\n", "\n", "return", "score", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.create_diagonal": [[17, 28], ["tensorflow.diag", "tensorflow.expand_dims", "tensorflow.tile", "tensorflow.shape", "tensorflow.shape", "tensorflow.ones"], "function", ["None"], ["def", "create_diagonal", "(", "output", ")", ":", "\n", "    ", "'''\n        output: (batchsize, dim)\n        diagonal matrix (batchsize, length, length)\n    '''", "\n", "length", "=", "tf", ".", "shape", "(", "output", ")", "[", "1", "]", "\n", "batchsize", "=", "tf", ".", "shape", "(", "output", ")", "[", "0", "]", "\n", "result", "=", "tf", ".", "diag", "(", "tf", ".", "ones", "(", "[", "length", "]", ")", ")", "\n", "result", "=", "tf", ".", "expand_dims", "(", "result", ",", "0", ")", "\n", "result", "=", "tf", ".", "tile", "(", "result", ",", "[", "batchsize", ",", "1", ",", "1", "]", ")", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.weight_ratio_mean": [[30, 45], ["tensorflow.cast", "tensorflow.shape", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.reshape", "weight_ratio.stabilize", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.stabilize"], ["", "def", "weight_ratio_mean", "(", "input", ",", "output", ",", "stab", "=", "0", ")", ":", "\n", "    ", "'''\n        inputs: (..., dim)\n        output: (..., 1)\n        weight ratios: [(..., dim)]\n    '''", "\n", "dim", "=", "tf", ".", "cast", "(", "tf", ".", "shape", "(", "input", ")", "[", "-", "1", "]", ",", "tf", ".", "float32", ")", "\n", "output_shape", "=", "tf", ".", "shape", "(", "input", ")", "\n", "# Flatten to 2D", "\n", "inputs", "=", "tf", ".", "reshape", "(", "input", ",", "[", "-", "1", ",", "input", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "\n", "output", "=", "tf", ".", "reshape", "(", "output", ",", "[", "-", "1", ",", "output", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "\n", "\n", "w", "=", "inputs", "/", "dim", "/", "stabilize", "(", "output", ",", "stab", ")", "\n", "\n", "return", "tf", ".", "reshape", "(", "w", ",", "output_shape", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.stabilize": [[47, 54], ["tensorflow.sign", "tensorflow.equal", "tensorflow.cast", "tensorflow.zeros", "tensorflow.shape"], "function", ["None"], ["", "def", "stabilize", "(", "matrix", ",", "stab", ")", ":", "\n", "    ", "sign", "=", "tf", ".", "sign", "(", "matrix", ")", "\n", "zero_pos", "=", "tf", ".", "equal", "(", "sign", ",", "tf", ".", "zeros", "(", "tf", ".", "shape", "(", "sign", ")", ")", ")", "\n", "zero_pos", "=", "tf", ".", "cast", "(", "zero_pos", ",", "tf", ".", "float32", ")", "\n", "sign", "+=", "zero_pos", "\n", "result", "=", "matrix", "+", "stab", "*", "sign", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.weight_ratio_linear": [[56, 84], ["range", "tensorflow.reshape", "range", "len", "len", "len", "tensorflow.concat", "output_shape.append", "tensorflow.reshape", "len", "weight_ratios.append", "tensorflow.reshape", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.expand_dims", "zip", "tensorflow.shape", "weight_ratio.stabilize", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.stabilize"], ["", "def", "weight_ratio_linear", "(", "inputs", ",", "weights", ",", "output", ",", "bias", "=", "None", ",", "stab", "=", "0", ")", ":", "\n", "    ", "'''\n        inputs: [(..., dim_in_i)]\n        weights: [(dim_in_i, dim_out)]\n        bias: [(dim_out)]\n        output: (..., dim_out)\n        weight ratios: [(..., dim_in_i, dim_out)]\n    '''", "\n", "assert", "len", "(", "inputs", ")", "==", "len", "(", "weights", ")", "\n", "output_shape", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "len", "(", "inputs", ")", ")", ":", "\n", "        ", "os", "=", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "inputs", "[", "i", "]", ")", ",", "tf", ".", "shape", "(", "weights", "[", "i", "]", ")", "[", "-", "1", ":", "]", "]", ",", "-", "1", ")", "\n", "output_shape", ".", "append", "(", "os", ")", "\n", "# Flatten to 2D", "\n", "", "inputs", "=", "[", "tf", ".", "reshape", "(", "inp", ",", "[", "-", "1", ",", "inp", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "for", "inp", "in", "inputs", "]", "\n", "output", "=", "tf", ".", "reshape", "(", "output", ",", "[", "-", "1", ",", "output", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "\n", "\n", "weight_ratios", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "len", "(", "inputs", ")", ")", ":", "\n", "        ", "r", "=", "tf", ".", "expand_dims", "(", "inputs", "[", "i", "]", ",", "-", "1", ")", "*", "tf", ".", "expand_dims", "(", "weights", "[", "i", "]", ",", "-", "3", ")", "\n", "w", "=", "r", "/", "tf", ".", "expand_dims", "(", "stabilize", "(", "output", ",", "stab", ")", ",", "-", "2", ")", "\n", "weight_ratios", ".", "append", "(", "w", ")", "\n", "\n", "", "weight_ratios", "=", "[", "tf", ".", "reshape", "(", "wr", ",", "os", ")", "\n", "for", "os", ",", "wr", "in", "zip", "(", "output_shape", ",", "weight_ratios", ")", "]", "\n", "\n", "return", "weight_ratios", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.weight_ratio_weighted_sum": [[86, 112], ["tensorflow.reshape", "weight_ratio.create_diagonal", "range", "len", "len", "tensorflow.shape", "tensorflow.concat", "tensorflow.reshape", "len", "weight_ratios.append", "tensorflow.reshape", "weight_ratio.stabilize", "tensorflow.shape", "tensorflow.shape", "tensorflow.expand_dims", "tensorflow.shape", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.create_diagonal", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.stabilize"], ["", "def", "weight_ratio_weighted_sum", "(", "inputs", ",", "weights", ",", "output", ",", "stab", "=", "0", ",", "flatten", "=", "False", ")", ":", "\n", "    ", "'''\n        inputs: [(..., dim)]\n        weights: [scalar]\n        output: (..., dim)\n        weight_ratios: [(..., dim, dim)]\n    '''", "\n", "assert", "len", "(", "inputs", ")", "==", "len", "(", "weights", ")", "\n", "if", "flatten", ":", "\n", "        ", "output_shape", "=", "tf", ".", "shape", "(", "output", ")", "\n", "", "else", ":", "\n", "        ", "output_shape", "=", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "output", ")", ",", "tf", ".", "shape", "(", "output", ")", "[", "-", "1", ":", "]", "]", ",", "-", "1", ")", "\n", "# Flatten to 2D", "\n", "", "inputs", "=", "[", "tf", ".", "reshape", "(", "inp", ",", "[", "-", "1", ",", "tf", ".", "shape", "(", "inp", ")", "[", "-", "1", "]", "]", ")", "for", "inp", "in", "inputs", "]", "\n", "output", "=", "tf", ".", "reshape", "(", "output", ",", "[", "-", "1", ",", "tf", ".", "shape", "(", "output", ")", "[", "-", "1", "]", "]", ")", "\n", "\n", "weight_ratios", "=", "[", "]", "\n", "diag", "=", "create_diagonal", "(", "output", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "inputs", ")", ")", ":", "\n", "        ", "wr", "=", "inputs", "[", "i", "]", "*", "weights", "[", "i", "]", "/", "stabilize", "(", "output", ",", "stab", ")", "\n", "if", "not", "flatten", ":", "\n", "            ", "wr", "=", "tf", ".", "expand_dims", "(", "wr", ",", "-", "1", ")", "*", "diag", "\n", "", "weight_ratios", ".", "append", "(", "wr", ")", "\n", "\n", "", "weight_ratios", "=", "[", "tf", ".", "reshape", "(", "wr", ",", "output_shape", ")", "for", "wr", "in", "weight_ratios", "]", "\n", "return", "weight_ratios", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.weight_ratio_maxpool": [[114, 154], ["tensorflow.constant", "tensorflow.concat", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.shape", "tensorflow.concat", "tensorflow.reshape", "tensorflow.argmax", "tensorflow.cast", "tensorflow.reshape", "tensorflow.sparse_to_dense", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.expand_dims", "tensorflow.reshape", "tensorflow.sparse_to_dense", "tensorflow.reshape", "tensorflow.shape", "tensorflow.ones", "tensorflow.range", "tensorflow.ones", "tensorflow.shape", "tensorflow.range", "tensorflow.shape", "tensorflow.range", "tensorflow.shape", "tensorflow.shape"], "function", ["None"], ["", "def", "weight_ratio_maxpool", "(", "input", ",", "output", ",", "maxnum", ",", "flatten", "=", "False", ")", ":", "\n", "    ", "'''\n        inputs: (..., dim)\n        output: (..., dim/maxpart)\n        weight_ratios: (..., dim, dim/maxnum)\n    '''", "\n", "# Flatten to 2D", "\n", "maxnum", "=", "tf", ".", "constant", "(", "maxnum", ",", "dtype", "=", "tf", ".", "int32", ")", "\n", "weight_shape", "=", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "input", ")", ",", "tf", ".", "shape", "(", "output", ")", "[", "-", "1", ":", "]", "]", ",", "axis", "=", "-", "1", ")", "\n", "input", "=", "tf", ".", "reshape", "(", "input", ",", "[", "-", "1", ",", "input", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "\n", "output", "=", "tf", ".", "reshape", "(", "output", ",", "[", "-", "1", ",", "output", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "\n", "\n", "shape_inp", "=", "tf", ".", "shape", "(", "input", ")", "\n", "batch", "=", "shape_inp", "[", "0", "]", "\n", "dim_in", "=", "shape_inp", "[", "-", "1", "]", "\n", "shape", "=", "tf", ".", "concat", "(", "[", "shape_inp", "[", ":", "-", "1", "]", ",", "[", "shape_inp", "[", "-", "1", "]", "//", "maxnum", ",", "maxnum", "]", "]", ",", "\n", "axis", "=", "0", ")", "\n", "dim_out", "=", "shape", "[", "-", "2", "]", "\n", "value", "=", "tf", ".", "reshape", "(", "input", ",", "shape", ")", "\n", "\n", "pos", "=", "tf", ".", "argmax", "(", "value", ",", "-", "1", ")", "\n", "pos", "=", "tf", ".", "cast", "(", "pos", ",", "tf", ".", "int32", ")", "\n", "pos", "=", "tf", ".", "reshape", "(", "pos", ",", "[", "-", "1", "]", ")", "\n", "if", "flatten", ":", "\n", "        ", "indices", "=", "tf", ".", "range", "(", "tf", ".", "shape", "(", "pos", ")", "[", "0", "]", ")", "*", "maxnum", "+", "pos", "\n", "weight_ratio", "=", "tf", ".", "sparse_to_dense", "(", "indices", ",", "[", "batch", "*", "dim_in", "]", ",", "\n", "tf", ".", "ones", "(", "tf", ".", "shape", "(", "indices", ")", ")", ")", "\n", "weight_ratio", "=", "tf", ".", "reshape", "(", "weight_ratio", ",", "weight_shape", "[", ":", "-", "1", "]", ")", "\n", "", "else", ":", "\n", "        ", "indices", "=", "dim_out", "*", "pos", "+", "dim_in", "*", "tf", ".", "range", "(", "batch", "*", "dim_out", ",", "\n", "dtype", "=", "tf", ".", "int32", ")", "\n", "indices", "=", "tf", ".", "reshape", "(", "indices", ",", "[", "-", "1", ",", "dim_out", "]", ")", "\n", "indices", "+=", "tf", ".", "expand_dims", "(", "tf", ".", "range", "(", "dim_out", ",", "dtype", "=", "tf", ".", "int32", ")", ",", "0", ")", "\n", "indices", "=", "tf", ".", "reshape", "(", "indices", ",", "[", "-", "1", "]", ")", "\n", "\n", "weight_ratio", "=", "tf", ".", "sparse_to_dense", "(", "indices", ",", "[", "batch", "*", "dim_in", "*", "dim_out", "]", ",", "\n", "tf", ".", "ones", "(", "tf", ".", "shape", "(", "indices", ")", ")", ")", "\n", "weight_ratio", "=", "tf", ".", "reshape", "(", "weight_ratio", ",", "weight_shape", ")", "\n", "\n", "", "return", "weight_ratio", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.LegacyGRUCell_encoder_v2n.__init__": [[267, 270], ["super().__init__"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["def", "__init__", "(", "self", ",", "num_units", ",", "reuse", "=", "None", ")", ":", "\n", "        ", "super", "(", "LegacyGRUCell_encoder_v2n", ",", "self", ")", ".", "__init__", "(", "_reuse", "=", "reuse", ")", "\n", "self", ".", "_num_units", "=", "num_units", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.LegacyGRUCell_encoder_v2n.__call__": [[271, 318], ["tensorflow.variable_scope", "tensorflow.ones", "lrp_utils.linear_v2n", "tensorflow.nn.sigmoid", "lrp_utils.linear_v2n", "tensorflow.nn.sigmoid", "tensorflow.concat", "lrp_utils.linear_v2n", "tensorflow.split", "lrp_utils.stabilize", "isinstance", "tensorflow.shape", "tensorflow.shape", "list", "list", "tensorflow.tanh", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.shape"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.stabilize"], ["", "def", "__call__", "(", "self", ",", "inputs", ",", "state", ",", "w_x_h_last", ",", "params", ",", "scope", "=", "None", ")", ":", "\n", "        ", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"gru_cell\"", ",", "\n", "values", "=", "[", "inputs", ",", "state", "]", ")", ":", "\n", "            ", "if", "not", "isinstance", "(", "inputs", ",", "(", "list", ",", "tuple", ")", ")", ":", "\n", "                ", "inputs", "=", "[", "inputs", "]", "\n", "\n", "", "bs", "=", "tf", ".", "shape", "(", "w_x_h_last", ")", "[", "0", "]", "\n", "emb", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "-", "1", "]", "\n", "w_x_x", "=", "tf", ".", "ones", "(", "[", "bs", ",", "1", ",", "emb", "]", ",", "dtype", "=", "tf", ".", "float32", ")", "\n", "all_inputs", "=", "list", "(", "inputs", ")", "+", "[", "state", "]", "\n", "r_linear", "=", "linear_v2n", "(", "all_inputs", ",", "self", ".", "_num_units", ",", "False", ",", "\n", "[", "w_x_x", ",", "w_x_h_last", "]", ",", "params", ",", "False", ",", "\n", "scope", "=", "\"reset_gate\"", ",", "d2", "=", "True", ")", "\n", "w_x_r", ",", "w_xlast_r", "=", "r_linear", "[", "\"weight_ratios\"", "]", "\n", "r", "=", "tf", ".", "nn", ".", "sigmoid", "(", "r_linear", "[", "\"output\"", "]", ")", "\n", "u_linear", "=", "linear_v2n", "(", "all_inputs", ",", "self", ".", "_num_units", ",", "False", ",", "\n", "[", "w_x_x", ",", "w_x_h_last", "]", ",", "params", ",", "False", ",", "\n", "scope", "=", "\"update_gate\"", ",", "d2", "=", "True", ")", "\n", "w_x_u", ",", "w_xlast_u", "=", "u_linear", "[", "\"weight_ratios\"", "]", "\n", "u", "=", "tf", ".", "nn", ".", "sigmoid", "(", "u_linear", "[", "\"output\"", "]", ")", "\n", "\n", "reseted", "=", "r", "*", "state", "\n", "w_x_reseted", "=", "w_x_r", "\n", "w_xlast_reseted", "=", "w_xlast_r", "\n", "\n", "w_tx_reseted", "=", "tf", ".", "concat", "(", "[", "w_x_reseted", ",", "w_xlast_reseted", "]", ",", "1", ")", "\n", "all_inputs", "=", "list", "(", "inputs", ")", "+", "[", "reseted", "]", "\n", "c_linear", "=", "linear_v2n", "(", "all_inputs", ",", "self", ".", "_num_units", ",", "True", ",", "\n", "[", "w_x_x", ",", "w_tx_reseted", "]", ",", "params", ",", "False", ",", "\n", "scope", "=", "\"candidate\"", ",", "d2", "=", "True", ")", "\n", "w_x_c_direct", ",", "w_tx_reseted_c", "=", "c_linear", "[", "\"weight_ratios\"", "]", "\n", "w_x_reseted_c", ",", "w_xlast_c", "=", "tf", ".", "split", "(", "w_tx_reseted_c", ",", "\n", "[", "1", ",", "tf", ".", "shape", "(", "w_tx_reseted_c", ")", "[", "1", "]", "-", "1", "]", ",", "\n", "axis", "=", "1", ")", "\n", "w_x_c", "=", "w_x_c_direct", "+", "w_x_reseted_c", "\n", "c", "=", "c_linear", "[", "\"output\"", "]", "\n", "\n", "h1", "=", "u", "*", "tf", ".", "tanh", "(", "c", ")", "\n", "h2", "=", "(", "1.0", "-", "u", ")", "*", "state", "\n", "new_state", "=", "h1", "+", "h2", "\n", "new_state_stab", "=", "stabilize", "(", "new_state", ",", "params", ".", "stab", ")", "\n", "w_x_newh", "=", "w_x_c", "*", "tf", ".", "expand_dims", "(", "h1", "/", "new_state_stab", ",", "axis", "=", "1", ")", "\n", "w_xlast_newh", "=", "w_xlast_c", "*", "tf", ".", "expand_dims", "(", "h1", "/", "new_state_stab", ",", "axis", "=", "1", ")", "+", "w_x_h_last", "*", "tf", ".", "expand_dims", "(", "h2", "/", "new_state_stab", ",", "axis", "=", "1", ")", "\n", "\n", "", "return", "new_state", ",", "new_state", ",", "w_xlast_newh", ",", "w_x_newh", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.LegacyGRUCell_encoder_v2n.state_size": [[319, 322], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "state_size", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_num_units", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.LegacyGRUCell_encoder_v2n.output_size": [[323, 326], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "output_size", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_num_units", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.LegacyGRUCell_decoder_v2n.__init__": [[336, 339], ["super().__init__"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["def", "__init__", "(", "self", ",", "num_units", ",", "reuse", "=", "None", ")", ":", "\n", "        ", "super", "(", "LegacyGRUCell_decoder_v2n", ",", "self", ")", ".", "__init__", "(", "_reuse", "=", "reuse", ")", "\n", "self", ".", "_num_units", "=", "num_units", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.LegacyGRUCell_decoder_v2n.__call__": [[340, 390], ["tensorflow.variable_scope", "tensorflow.zeros", "lrp_utils.linear_v2n", "tensorflow.nn.sigmoid", "lrp_utils.linear_v2n", "tensorflow.nn.sigmoid", "lrp_utils.linear_v2n", "lrp_utils.weighted_sum", "tensorflow.expand_dims", "tensorflow.expand_dims", "isinstance", "tensorflow.shape", "tensorflow.shape", "list", "list", "tensorflow.tanh"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.weighted_sum"], ["", "def", "__call__", "(", "self", ",", "inputs", ",", "state", ",", "w_x_h_last", ",", "w_x_c", ",", "params", ",", "scope", "=", "None", ")", ":", "\n", "        ", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"gru_cell\"", ",", "\n", "values", "=", "[", "inputs", ",", "state", "]", ")", ":", "\n", "            ", "if", "not", "isinstance", "(", "inputs", ",", "(", "list", ",", "tuple", ")", ")", ":", "\n", "                ", "inputs", "=", "[", "inputs", "]", "\n", "\n", "", "bs", "=", "tf", ".", "shape", "(", "w_x_h_last", ")", "[", "0", "]", "\n", "emb", "=", "tf", ".", "shape", "(", "inputs", "[", "0", "]", ")", "[", "-", "1", "]", "\n", "w_x_y", "=", "tf", ".", "zeros", "(", "[", "bs", ",", "1", ",", "emb", "]", ",", "dtype", "=", "tf", ".", "float32", ")", "\n", "all_inputs", "=", "list", "(", "inputs", ")", "+", "[", "state", "]", "\n", "w_x_h", "=", "w_x_h_last", "\n", "w_x_ctx", "=", "w_x_c", "\n", "r_linear", "=", "linear_v2n", "(", "all_inputs", ",", "self", ".", "_num_units", ",", "False", ",", "\n", "[", "w_x_y", ",", "w_x_c", ",", "w_x_h_last", "]", ",", "params", ",", "False", ",", "\n", "scope", "=", "\"reset_gate\"", ",", "d2", "=", "True", ")", "\n", "_", ",", "w_x_ctx_r", ",", "w_x_h_r", "=", "r_linear", "[", "\"weight_ratios\"", "]", "\n", "w_x_r", "=", "w_x_ctx_r", "+", "w_x_h_r", "\n", "r", "=", "tf", ".", "nn", ".", "sigmoid", "(", "r_linear", "[", "\"output\"", "]", ")", "\n", "\n", "u_linear", "=", "linear_v2n", "(", "all_inputs", ",", "self", ".", "_num_units", ",", "False", ",", "\n", "[", "w_x_y", ",", "w_x_c", ",", "w_x_h_last", "]", ",", "params", ",", "False", ",", "\n", "scope", "=", "\"update_gate\"", ",", "d2", "=", "True", ")", "\n", "_", ",", "w_x_ctx_u", ",", "w_x_h_u", "=", "u_linear", "[", "\"weight_ratios\"", "]", "\n", "w_x_u", "=", "w_x_ctx_u", "+", "w_x_h_u", "\n", "u", "=", "tf", ".", "nn", ".", "sigmoid", "(", "u_linear", "[", "\"output\"", "]", ")", "\n", "\n", "reseted", "=", "r", "*", "state", "\n", "w_x_reseted", "=", "0.5", "*", "w_x_r", "+", "0.5", "*", "w_x_h", "\n", "\n", "all_inputs", "=", "list", "(", "inputs", ")", "+", "[", "reseted", "]", "\n", "c_linear", "=", "linear_v2n", "(", "all_inputs", ",", "self", ".", "_num_units", ",", "True", ",", "\n", "[", "w_x_y", ",", "w_x_c", ",", "w_x_reseted", "]", ",", "params", ",", "False", ",", "\n", "scope", "=", "\"candidate\"", ",", "d2", "=", "True", ")", "\n", "_", ",", "w_x_c_state", ",", "w_x_resetes_state", "=", "c_linear", "[", "\"weight_ratios\"", "]", "\n", "w_x_state", "=", "w_x_c_state", "+", "w_x_resetes_state", "\n", "c", "=", "c_linear", "[", "\"output\"", "]", "\n", "\n", "h1", "=", "u", "*", "tf", ".", "tanh", "(", "c", ")", "\n", "h2", "=", "(", "1.0", "-", "u", ")", "*", "state", "\n", "w_x_h1", "=", "0.5", "*", "w_x_state", "+", "0.5", "*", "w_x_u", "\n", "w_x_h2", "=", "0.5", "*", "w_x_u", "+", "0.5", "*", "w_x_h", "\n", "\n", "newh_ws", "=", "weighted_sum", "(", "[", "h1", ",", "h2", "]", ",", "[", "1.", ",", "1.", "]", ",", "params", ",", "flatten", "=", "True", ")", "\n", "new_state", "=", "newh_ws", "[", "\"output\"", "]", "\n", "w_h1_newh", ",", "w_h2_newh", "=", "newh_ws", "[", "\"weight_ratios\"", "]", "\n", "w_h1_newh", "=", "tf", ".", "expand_dims", "(", "w_h1_newh", ",", "1", ")", "\n", "w_h2_newh", "=", "tf", ".", "expand_dims", "(", "w_h2_newh", ",", "1", ")", "\n", "w_x_newh", "=", "w_x_h1", "*", "w_h1_newh", "+", "w_x_h2", "*", "w_h2_newh", "\n", "\n", "", "return", "new_state", ",", "new_state", ",", "w_x_newh", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.LegacyGRUCell_decoder_v2n.state_size": [[391, 394], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "state_size", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_num_units", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.LegacyGRUCell_decoder_v2n.output_size": [[395, 398], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "output_size", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_num_units", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.reduce_reserve": [[23, 25], ["tensorflow.expand_dims", "tensorflow.reduce_sum"], "function", ["None"], ["def", "reduce_reserve", "(", "matrix", ",", "axis", ")", ":", "\n", "    ", "return", "tf", ".", "expand_dims", "(", "tf", ".", "reduce_sum", "(", "matrix", ",", "axis", ")", ",", "axis", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.v2n_propagate_linear": [[27, 40], ["tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.tile", "tensorflow.matmul", "tensorflow.squeeze", "tensorflow.shape"], "function", ["None"], ["", "def", "v2n_propagate_linear", "(", "w_x_last", ",", "w_linear", ")", ":", "\n", "    ", "'''\n        w_x_last: [bs, len_src, len, d]\n        w_linear: [b, len, d, d]\n        return: [b, len_src, len, d]\n    '''", "\n", "len_src", "=", "tf", ".", "shape", "(", "w_x_last", ")", "[", "1", "]", "\n", "w_x_last", "=", "tf", ".", "expand_dims", "(", "w_x_last", ",", "-", "2", ")", "\n", "w_linear", "=", "tf", ".", "expand_dims", "(", "w_linear", ",", "1", ")", "\n", "w_linear", "=", "tf", ".", "tile", "(", "w_linear", ",", "[", "1", ",", "len_src", ",", "1", ",", "1", ",", "1", "]", ")", "\n", "result", "=", "tf", ".", "matmul", "(", "w_x_last", ",", "w_linear", ")", "\n", "result", "=", "tf", ".", "squeeze", "(", "result", ",", "-", "2", ")", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.create_diagonal_v2n": [[42, 52], ["tensorflow.diag", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.tile", "tensorflow.ones"], "function", ["None"], ["", "def", "create_diagonal_v2n", "(", "batchsize", ",", "length", ",", "dim", ")", ":", "\n", "    ", "'''\n        diagonal matrix (batchsize, len_src, len_src, dim)\n\tresult[bs, len_src, len_src, dim] = 1\n    '''", "\n", "result", "=", "tf", ".", "diag", "(", "tf", ".", "ones", "(", "[", "length", "]", ",", "dtype", "=", "tf", ".", "float32", ")", ")", "\n", "result", "=", "tf", ".", "expand_dims", "(", "result", ",", "0", ")", "\n", "result", "=", "tf", ".", "expand_dims", "(", "result", ",", "-", "1", ")", "\n", "result", "=", "tf", ".", "tile", "(", "result", ",", "[", "batchsize", ",", "1", ",", "1", ",", "dim", "]", ")", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.stabilize": [[54, 61], ["tensorflow.sign", "tensorflow.equal", "tensorflow.cast", "tensorflow.zeros", "tensorflow.shape"], "function", ["None"], ["", "def", "stabilize", "(", "matrix", ",", "stab", ")", ":", "\n", "    ", "sign", "=", "tf", ".", "sign", "(", "matrix", ")", "\n", "zero_pos", "=", "tf", ".", "equal", "(", "sign", ",", "tf", ".", "zeros", "(", "tf", ".", "shape", "(", "sign", ")", ")", ")", "\n", "zero_pos", "=", "tf", ".", "cast", "(", "zero_pos", ",", "tf", ".", "float32", ")", "\n", "sign", "+=", "zero_pos", "\n", "result", "=", "matrix", "+", "stab", "*", "sign", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.normalize": [[63, 66], ["tensorflow.reduce_sum", "tensorflow.abs", "tensorflow.expand_dims"], "function", ["None"], ["", "def", "normalize", "(", "matrix", ")", ":", "\n", "    ", "total", "=", "tf", ".", "reduce_sum", "(", "tf", ".", "abs", "(", "matrix", ")", ",", "axis", "=", "-", "1", ")", "\n", "return", "matrix", "/", "tf", ".", "expand_dims", "(", "total", ",", "axis", "=", "-", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.dot_product": [[68, 76], ["tensorflow.identity", "range", "thumt.weight_ratio_dot_product", "len"], "function", ["None"], ["", "def", "dot_product", "(", "inputs", ",", "params", ")", ":", "\n", "    ", "output", "=", "tf", ".", "identity", "(", "inputs", "[", "0", "]", ")", "\n", "for", "i", "in", "range", "(", "1", ",", "len", "(", "inputs", ")", ")", ":", "\n", "        ", "output", "*=", "inputs", "[", "i", "]", "\n", "\n", "", "weight_ratios", "=", "wr", ".", "weight_ratio_dot_product", "(", "inputs", ",", "output", ")", "\n", "\n", "return", "{", "\"output\"", ":", "output", ",", "\"weight_ratios\"", ":", "weight_ratios", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.weighted_sum": [[78, 87], ["tensorflow.add_n", "thumt.weight_ratio_weighted_sum", "len", "len", "range", "len"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.weight_ratio_weighted_sum"], ["", "def", "weighted_sum", "(", "inputs", ",", "weights", ",", "params", ",", "flatten", "=", "False", ")", ":", "\n", "    ", "assert", "len", "(", "inputs", ")", "==", "len", "(", "weights", ")", "\n", "output", "=", "tf", ".", "add_n", "(", "[", "inputs", "[", "i", "]", "*", "weights", "[", "i", "]", "for", "i", "in", "range", "(", "len", "(", "inputs", ")", ")", "]", ")", "\n", "\n", "weight_ratios", "=", "wr", ".", "weight_ratio_weighted_sum", "(", "inputs", ",", "weights", ",", "output", ",", "\n", "stab", "=", "params", ".", "stab", ",", "\n", "flatten", "=", "flatten", ")", "\n", "\n", "return", "{", "\"output\"", ":", "output", ",", "\"weight_ratios\"", ":", "weight_ratios", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.maxpool": [[89, 97], ["tensorflow.concat", "tensorflow.reshape", "tensorflow.reduce_max", "thumt.weight_ratio_maxpool", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.weight_ratio_maxpool"], ["", "def", "maxpool", "(", "input", ",", "output_size", ",", "params", ",", "flatten", "=", "False", ")", ":", "\n", "    ", "shape", "=", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "input", ")", "[", ":", "-", "1", "]", ",", "[", "output_size", ",", "params", ".", "maxnum", "]", "]", ",", "\n", "axis", "=", "0", ")", "\n", "value", "=", "tf", ".", "reshape", "(", "input", ",", "shape", ")", "\n", "output", "=", "tf", ".", "reduce_max", "(", "value", ",", "-", "1", ")", "\n", "weight_ratio", "=", "wr", ".", "weight_ratio_maxpool", "(", "input", ",", "output", ",", "params", ".", "maxnum", ",", "\n", "flatten", "=", "flatten", ")", "\n", "return", "{", "\"output\"", ":", "output", ",", "\"weight_ratio\"", ":", "weight_ratio", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.weight_ratio_linear_v2n_2d": [[99, 108], ["tensorflow.expand_dims", "lrp_utils.weight_ratio_linear_v2n", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.squeeze"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.weight_ratio_linear_v2n"], ["", "def", "weight_ratio_linear_v2n_2d", "(", "inputs", ",", "weights", ",", "output", ",", "w_x_inp", ",", "bias", "=", "None", ",", "\n", "stab", "=", "0", ")", ":", "\n", "    ", "inputs_ex", "=", "[", "tf", ".", "expand_dims", "(", "inp", ",", "1", ")", "for", "inp", "in", "inputs", "]", "\n", "output_ex", "=", "tf", ".", "expand_dims", "(", "output", ",", "1", ")", "\n", "w_x_inp_ex", "=", "[", "tf", ".", "expand_dims", "(", "w", ",", "2", ")", "for", "w", "in", "w_x_inp", "]", "\n", "result", "=", "weight_ratio_linear_v2n", "(", "inputs_ex", ",", "weights", ",", "output_ex", ",", "\n", "w_x_inp_ex", ",", "bias", "=", "bias", ",", "stab", "=", "stab", ")", "\n", "result", "=", "[", "tf", ".", "squeeze", "(", "res", ",", "2", ")", "for", "res", "in", "result", "]", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.weight_ratio_linear_v2n": [[110, 139], ["tensorflow.expand_dims", "tensorflow.reshape", "range", "len", "len", "tensorflow.shape", "tensorflow.shape", "lrp_utils.stabilize", "len", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.matmul", "tensorflow.reshape", "weight_ratios.append", "tensorflow.shape", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.stabilize"], ["", "def", "weight_ratio_linear_v2n", "(", "inputs", ",", "weights", ",", "output", ",", "w_x_inp", ",", "bias", "=", "None", ",", "\n", "stab", "=", "0", ")", ":", "\n", "    ", "'''\n        inputs: [(bs, lq, di)]\n        weights: [(di, do)]\n        bias: (do)\n        output: (bs, lq, do)\n        w_x_inp: [(bs, ls, lq, di)]\n        weight ratios: [(bs, ls, lq, do)]\n    '''", "\n", "assert", "len", "(", "inputs", ")", "==", "len", "(", "weights", ")", "\n", "weight_ratios", "=", "[", "]", "\n", "bs", "=", "tf", ".", "shape", "(", "w_x_inp", "[", "0", "]", ")", "[", "0", "]", "\n", "lq", "=", "tf", ".", "shape", "(", "w_x_inp", "[", "0", "]", ")", "[", "2", "]", "\n", "outp", "=", "tf", ".", "expand_dims", "(", "stabilize", "(", "output", ",", "stab", ")", ",", "1", ")", "\n", "outp", "=", "tf", ".", "reshape", "(", "outp", ",", "[", "bs", ",", "1", ",", "lq", ",", "-", "1", "]", ")", "\n", "\n", "for", "i", "in", "range", "(", "len", "(", "inputs", ")", ")", ":", "\n", "        ", "di", "=", "tf", ".", "shape", "(", "w_x_inp", "[", "i", "]", ")", "[", "3", "]", "\n", "ls", "=", "tf", ".", "shape", "(", "w_x_inp", "[", "i", "]", ")", "[", "1", "]", "\n", "inp", "=", "tf", ".", "reshape", "(", "inputs", "[", "i", "]", ",", "[", "bs", ",", "1", ",", "lq", ",", "-", "1", "]", ")", "\n", "w", "=", "w_x_inp", "[", "i", "]", "*", "inp", "\n", "w", "=", "tf", ".", "reshape", "(", "w", ",", "[", "-", "1", ",", "di", "]", ")", "\n", "w", "=", "tf", ".", "matmul", "(", "w", ",", "weights", "[", "i", "]", ")", "\n", "w", "=", "tf", ".", "reshape", "(", "w", ",", "[", "bs", ",", "ls", ",", "lq", ",", "-", "1", "]", ")", "\n", "w", "=", "w", "/", "outp", "\n", "weight_ratios", ".", "append", "(", "w", ")", "\n", "\n", "", "return", "weight_ratios", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n": [[141, 214], ["tensorflow.variable_scope", "tensorflow.concat", "tensorflow.add_n", "tensorflow.reshape", "isinstance", "tensorflow.shape", "len", "len", "RuntimeError", "tensorflow.reshape", "sum", "tensorflow.concat", "tensorflow.concat", "tensorflow.get_variable", "results.append", "range", "tensorflow.get_variable", "tensorflow.nn.bias_add", "operator", "operator", "tensorflow.matmul", "len", "weight_shapes.append", "tensorflow.get_variable", "matrixs.append", "results.append", "item.get_shape", "tensorflow.shape", "tensorflow.concat", "tensorflow.matmul"], "function", ["None"], ["", "def", "linear_v2n", "(", "inputs", ",", "output_size", ",", "bias", ",", "w_x_inp", ",", "params", ",", "concat", "=", "False", ",", "\n", "dtype", "=", "None", ",", "scope", "=", "None", ",", "d2", "=", "False", ")", ":", "\n", "    ", "\"\"\"\n    Linear layer\n    :param inputs: A Tensor or a list of Tensors with shape [batch, input_size]\n    :param output_size: An integer specify the output size\n    :param bias: a boolean value indicate whether to use bias term\n    :param concat: a boolean value indicate whether to concatenate all inputs\n    :param dtype: an instance of tf.DType, the default value is ``tf.float32''\n    :param scope: the scope of this layer, the default value is ``linear''\n    :returns: a Tensor with shape [batch, output_size]\n    :raises RuntimeError: raises ``RuntimeError'' when input sizes do not\n                          compatible with each other\n    \"\"\"", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"linear\"", ",", "values", "=", "[", "inputs", "]", ")", ":", "\n", "#assert not concat", "\n", "        ", "if", "not", "isinstance", "(", "inputs", ",", "(", "list", ",", "tuple", ")", ")", ":", "\n", "            ", "inputs", "=", "[", "inputs", "]", "\n", "\n", "", "batch_shape", "=", "tf", ".", "shape", "(", "inputs", "[", "0", "]", ")", "[", ":", "-", "1", "]", "\n", "input_size", "=", "[", "item", ".", "get_shape", "(", ")", "[", "-", "1", "]", ".", "value", "for", "item", "in", "inputs", "]", "\n", "\n", "if", "len", "(", "inputs", ")", "!=", "len", "(", "input_size", ")", ":", "\n", "            ", "raise", "RuntimeError", "(", "\"inputs and input_size unmatched!\"", ")", "\n", "\n", "", "output_shape", "=", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "inputs", "[", "0", "]", ")", "[", ":", "-", "1", "]", ",", "[", "output_size", "]", "]", ",", "\n", "axis", "=", "0", ")", "\n", "# Flatten to 2D", "\n", "inputs", "=", "[", "tf", ".", "reshape", "(", "inp", ",", "[", "-", "1", ",", "inp", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "for", "inp", "in", "inputs", "]", "\n", "\n", "results", "=", "[", "]", "\n", "weight_ratios", "=", "[", "]", "\n", "weight_shapes", "=", "[", "]", "\n", "matrixs", "=", "[", "]", "\n", "\n", "if", "concat", ":", "\n", "            ", "input_size", "=", "sum", "(", "input_size", ")", "\n", "inputs", "=", "tf", ".", "concat", "(", "inputs", ",", "1", ")", "\n", "shape", "=", "[", "input_size", ",", "output_size", "]", "\n", "weight_shape", "=", "tf", ".", "concat", "(", "[", "batch_shape", ",", "shape", "]", ",", "-", "1", ")", "\n", "matrix", "=", "tf", ".", "get_variable", "(", "\"matrix\"", ",", "shape", ",", "dtype", "=", "dtype", ")", "\n", "results", ".", "append", "(", "tf", ".", "matmul", "(", "inputs", ",", "matrix", ")", ")", "\n", "", "else", ":", "\n", "            ", "for", "i", "in", "range", "(", "len", "(", "input_size", ")", ")", ":", "\n", "                ", "shape", "=", "[", "input_size", "[", "i", "]", ",", "output_size", "]", "\n", "weight_shapes", ".", "append", "(", "tf", ".", "concat", "(", "[", "batch_shape", ",", "shape", "]", ",", "-", "1", ")", ")", "\n", "name", "=", "\"matrix_%d\"", "%", "i", "\n", "matrix", "=", "tf", ".", "get_variable", "(", "name", ",", "shape", ",", "dtype", "=", "dtype", ")", "\n", "matrixs", ".", "append", "(", "matrix", ")", "\n", "results", ".", "append", "(", "tf", ".", "matmul", "(", "inputs", "[", "i", "]", ",", "matrix", ")", ")", "\n", "\n", "", "", "output", "=", "tf", ".", "add_n", "(", "results", ")", "\n", "\n", "if", "bias", ":", "\n", "            ", "shape", "=", "[", "output_size", "]", "\n", "bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "shape", ",", "dtype", "=", "dtype", ")", "\n", "output", "=", "tf", ".", "nn", ".", "bias_add", "(", "output", ",", "bias", ")", "\n", "\n", "# calculate weight ratio", "\n", "", "operator", "=", "weight_ratio_linear_v2n", "\n", "if", "d2", ":", "\n", "            ", "operator", "=", "weight_ratio_linear_v2n_2d", "\n", "", "if", "concat", ":", "\n", "            ", "weight_ratios", "=", "operator", "(", "[", "inputs", "]", ",", "[", "matrix", "]", ",", "output", ",", "w_x_inp", ",", "\n", "bias", "=", "bias", ",", "stab", "=", "params", ".", "stab", ")", "\n", "", "else", ":", "\n", "            ", "weight_ratios", "=", "operator", "(", "inputs", ",", "matrixs", ",", "output", ",", "w_x_inp", ",", "\n", "bias", "=", "bias", ",", "stab", "=", "params", ".", "stab", ")", "\n", "\n", "", "output", "=", "tf", ".", "reshape", "(", "output", ",", "output_shape", ")", "\n", "\n", "return", "{", "\"output\"", ":", "output", ",", "\"weight_ratios\"", ":", "weight_ratios", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.maxout_v2n": [[216, 257], ["tensorflow.transpose", "tensorflow.transpose", "tensorflow.zeros", "lrp_utils.linear_v2n", "tensorflow.transpose", "lrp_utils.maxpool", "propagater", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.maxpool"], ["", "", "def", "maxout_v2n", "(", "inputs", ",", "output_size", ",", "maxpart", ",", "w", ",", "params", ",", "use_bias", "=", "True", ",", "\n", "concat", "=", "True", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "\"\"\"\n    Maxout layer\n    :param inputs: see the corresponding description of ``linear''\n    :param output_size: see the corresponding description of ``linear''\n    :param maxpart: an integer, the default value is 2\n    :param use_bias: a boolean value indicate whether to use bias term\n    :param concat: concat all tensors if inputs is a list of tensors\n    :param dtype: an optional instance of tf.Dtype\n    :param scope: the scope of this layer, the default value is ``maxout''\n    :returns: a Tensor with shape [batch, output_size]\n    :raises RuntimeError: see the corresponding description of ``linear''\n    \"\"\"", "\n", "\n", "w_x_dec", ",", "w_x_ctx", "=", "w", "\n", "w_x_dec", "=", "tf", ".", "transpose", "(", "w_x_dec", ",", "[", "1", ",", "2", ",", "0", ",", "3", "]", ")", "\n", "w_x_ctx", "=", "tf", ".", "transpose", "(", "w_x_ctx", ",", "[", "1", ",", "2", ",", "0", ",", "3", "]", ")", "\n", "w_x_y", "=", "tf", ".", "zeros", "(", "tf", ".", "shape", "(", "w_x_dec", ")", ",", "dtype", "=", "tf", ".", "float32", ")", "\n", "candidate_linear", "=", "linear_v2n", "(", "inputs", ",", "output_size", "*", "maxpart", ",", "use_bias", ",", "\n", "[", "w_x_y", ",", "w_x_dec", ",", "w_x_ctx", "]", ",", "params", ",", "concat", ",", "\n", "dtype", "=", "dtype", ",", "scope", "=", "scope", "or", "\"maxout\"", ")", "\n", "candidate", "=", "candidate_linear", "[", "\"output\"", "]", "\n", "_", ",", "w_x_dec_readout", ",", "w_x_ctx_readout", "=", "candidate_linear", "[", "\"weight_ratios\"", "]", "\n", "w_x_readout", "=", "w_x_dec_readout", "+", "w_x_ctx_readout", "\n", "w_x_readout", "=", "tf", ".", "transpose", "(", "w_x_readout", ",", "[", "0", ",", "2", ",", "1", ",", "3", "]", ")", "\n", "\n", "output_maxout", "=", "maxpool", "(", "candidate", ",", "output_size", ",", "params", ")", "\n", "output", "=", "output_maxout", "[", "\"output\"", "]", "\n", "\n", "# direct", "\n", "w_readout_maxout", "=", "output_maxout", "[", "\"weight_ratio\"", "]", "\n", "\n", "#propagate", "\n", "propagater", "=", "tf", ".", "matmul", "\n", "\n", "w_x_maxout", "=", "propagater", "(", "w_x_readout", ",", "w_readout_maxout", ")", "\n", "\n", "weight_ratios", "=", "[", "w_x_maxout", "]", "\n", "\n", "return", "{", "\"output\"", ":", "output", ",", "\"weight_ratios\"", ":", "weight_ratios", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.combine_heads_v2n": [[400, 411], ["tensorflow.name_scope", "tensorflow.transpose", "tensorflow.reshape", "tf.reshape.set_shape", "tf.reshape.get_shape", "tensorflow.concat", "tensorflow.shape"], "function", ["None"], ["", "", "def", "combine_heads_v2n", "(", "inputs", ",", "name", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "name_scope", "(", "name", ",", "default_name", "=", "\"combine_heads\"", ",", "values", "=", "[", "inputs", "]", ")", ":", "\n", "        ", "x", "=", "inputs", "\n", "x", "=", "tf", ".", "transpose", "(", "x", ",", "[", "0", ",", "2", ",", "3", ",", "1", ",", "4", "]", ")", "\n", "old_shape", "=", "x", ".", "get_shape", "(", ")", ".", "dims", "\n", "a", ",", "b", "=", "old_shape", "[", "-", "2", ":", "]", "\n", "new_shape", "=", "old_shape", "[", ":", "-", "2", "]", "+", "[", "a", "*", "b", "if", "a", "and", "b", "else", "None", "]", "\n", "x", "=", "tf", ".", "reshape", "(", "x", ",", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "x", ")", "[", ":", "-", "2", "]", ",", "[", "-", "1", "]", "]", ",", "0", ")", ")", "\n", "x", ".", "set_shape", "(", "new_shape", ")", "\n", "\n", "return", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.split_heads": [[413, 424], ["tensorflow.name_scope", "tensorflow.reshape", "tf.reshape.set_shape", "tensorflow.transpose", "x.get_shape", "tensorflow.concat", "tensorflow.shape"], "function", ["None"], ["", "", "def", "split_heads", "(", "inputs", ",", "num_heads", ",", "name", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "name_scope", "(", "name", ",", "default_name", "=", "\"split_heads\"", ",", "values", "=", "[", "inputs", "]", ")", ":", "\n", "        ", "x", "=", "inputs", "\n", "n", "=", "num_heads", "\n", "old_shape", "=", "x", ".", "get_shape", "(", ")", ".", "dims", "\n", "\n", "last", "=", "old_shape", "[", "-", "1", "]", "\n", "new_shape", "=", "old_shape", "[", ":", "-", "1", "]", "+", "[", "n", "]", "+", "[", "last", "//", "n", "if", "last", "else", "None", "]", "\n", "ret", "=", "tf", ".", "reshape", "(", "x", ",", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "x", ")", "[", ":", "-", "1", "]", ",", "[", "n", ",", "-", "1", "]", "]", ",", "0", ")", ")", "\n", "ret", ".", "set_shape", "(", "new_shape", ")", "\n", "return", "tf", ".", "transpose", "(", "ret", ",", "[", "0", ",", "3", ",", "1", ",", "2", ",", "4", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.combine_heads": [[425, 436], ["tensorflow.name_scope", "tensorflow.transpose", "tensorflow.reshape", "tf.reshape.set_shape", "tf.reshape.get_shape", "tensorflow.concat", "tensorflow.shape"], "function", ["None"], ["", "", "def", "combine_heads", "(", "inputs", ",", "name", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "name_scope", "(", "name", ",", "default_name", "=", "\"combine_heads\"", ",", "values", "=", "[", "inputs", "]", ")", ":", "\n", "        ", "x", "=", "inputs", "\n", "x", "=", "tf", ".", "transpose", "(", "x", ",", "[", "0", ",", "2", ",", "3", ",", "4", ",", "1", ",", "5", "]", ")", "\n", "old_shape", "=", "x", ".", "get_shape", "(", ")", ".", "dims", "\n", "a", ",", "b", "=", "old_shape", "[", "-", "2", ":", "]", "\n", "new_shape", "=", "old_shape", "[", ":", "-", "2", "]", "+", "[", "a", "*", "b", "if", "a", "and", "b", "else", "None", "]", "\n", "x", "=", "tf", ".", "reshape", "(", "x", ",", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "x", ")", "[", ":", "-", "2", "]", ",", "[", "-", "1", "]", "]", ",", "0", ")", ")", "\n", "x", ".", "set_shape", "(", "new_shape", ")", "\n", "\n", "return", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.layer_process": [[438, 446], ["lrp_utils.layer_norm", "ValueError"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.layer_norm"], ["", "", "def", "layer_process", "(", "x", ",", "mode", ",", "w_x_inp", ",", "params", ")", ":", "\n", "    ", "if", "not", "mode", "or", "mode", "==", "\"none\"", ":", "\n", "        ", "return", "{", "\"outputs\"", ":", "x", ",", "\"weight_ratios\"", ":", "w_x_inp", "}", "\n", "", "elif", "mode", "==", "\"layer_norm\"", ":", "\n", "        ", "norm", "=", "layer_norm", "(", "x", ",", "w_x_inp", ",", "params", ")", "\n", "return", "norm", "\n", "", "else", ":", "\n", "        ", "raise", "ValueError", "(", "\"Unknown mode %s\"", "%", "mode", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.layer_norm": [[448, 490], ["tensorflow.variable_scope", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.reduce_mean", "tensorflow.reduce_mean", "thumt.weight_ratio_mean", "thumt.weight_ratio_weighted_sum", "tensorflow.reduce_sum", "tensorflow.expand_dims", "tensorflow.expand_dims", "inputs.get_shape().as_list", "tensorflow.square", "tensorflow.rsqrt", "tensorflow.expand_dims", "tensorflow.ones_initializer", "tensorflow.zeros_initializer", "tensorflow.expand_dims", "inputs.get_shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.weight_ratio_mean", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.weight_ratio_weighted_sum"], ["", "", "def", "layer_norm", "(", "inputs", ",", "w_x_inp", ",", "params", ",", "epsilon", "=", "1e-6", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "\"\"\"\n    Layer Normalization\n    :param inputs: A Tensor of shape [..., channel_size]\n    :param epsilon: A floating number\n    :param dtype: An optional instance of tf.DType\n    :param scope: An optional string\n    :returns: A Tensor with the same shape as inputs\n\n    w_x_inp: [bs, len_src, len, dim]\n    \"\"\"", "\n", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"layer_norm\"", ",", "values", "=", "[", "inputs", "]", ",", "\n", "dtype", "=", "dtype", ")", ":", "\n", "        ", "channel_size", "=", "inputs", ".", "get_shape", "(", ")", ".", "as_list", "(", ")", "[", "-", "1", "]", "\n", "\n", "scale", "=", "tf", ".", "get_variable", "(", "\"scale\"", ",", "shape", "=", "[", "channel_size", "]", ",", "\n", "initializer", "=", "tf", ".", "ones_initializer", "(", ")", ")", "\n", "\n", "offset", "=", "tf", ".", "get_variable", "(", "\"offset\"", ",", "shape", "=", "[", "channel_size", "]", ",", "\n", "initializer", "=", "tf", ".", "zeros_initializer", "(", ")", ")", "\n", "\n", "mean", "=", "tf", ".", "reduce_mean", "(", "inputs", ",", "axis", "=", "-", "1", ",", "keep_dims", "=", "True", ")", "\n", "variance", "=", "tf", ".", "reduce_mean", "(", "tf", ".", "square", "(", "inputs", "-", "mean", ")", ",", "axis", "=", "-", "1", ",", "\n", "keep_dims", "=", "True", ")", "\n", "\n", "averaged", "=", "(", "inputs", "-", "mean", ")", "\n", "norm_inputs", "=", "averaged", "*", "tf", ".", "rsqrt", "(", "variance", "+", "epsilon", ")", "\n", "\n", "w_inp_mean", "=", "wr", ".", "weight_ratio_mean", "(", "inputs", ",", "mean", ",", "stab", "=", "params", ".", "stab", ")", "\n", "w_inp_out", ",", "w_mean_out", "=", "wr", ".", "weight_ratio_weighted_sum", "(", "[", "inputs", ",", "mean", "]", ",", "\n", "[", "1.", ",", "-", "1.", "]", ",", "\n", "averaged", ",", "\n", "stab", "=", "params", ".", "stab", ",", "\n", "flatten", "=", "True", ")", "\n", "w_x_mean", "=", "tf", ".", "reduce_sum", "(", "w_x_inp", "*", "tf", ".", "expand_dims", "(", "w_inp_mean", ",", "1", ")", ",", "-", "1", ")", "\n", "w_inp_out", "=", "tf", ".", "expand_dims", "(", "w_inp_out", ",", "1", ")", "\n", "w_mean_out", "=", "tf", ".", "expand_dims", "(", "w_mean_out", ",", "1", ")", "\n", "w_x_out", "=", "w_x_inp", "*", "w_inp_out", "\n", "w_x_out", "+=", "tf", ".", "expand_dims", "(", "w_x_mean", ",", "-", "1", ")", "*", "w_mean_out", "\n", "\n", "return", "{", "\"outputs\"", ":", "norm_inputs", "*", "scale", "+", "offset", ",", "\n", "\"weight_ratios\"", ":", "w_x_out", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.multihead_attention_v2n": [[491, 593], ["ValueError", "ValueError", "tensorflow.variable_scope", "thumt.split_heads", "thumt.split_heads", "thumt.split_heads", "lrp_utils.split_heads", "thumt.multiplicative_attention", "thumt.combine_heads", "tensorflow.transpose", "tensorflow.reshape", "tensorflow.matmul", "tensorflow.reshape", "tensorflow.transpose", "lrp_utils.combine_heads_v2n", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape", "lrp_utils.linear_v2n", "tensorflow.split", "tensorflow.split", "thumt.linear", "lrp_utils.linear_v2n", "tensorflow.split", "tensorflow.split", "lrp_utils.linear_v2n", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.split_heads", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.split_heads", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.split_heads", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.split_heads", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.multiplicative_attention", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.combine_heads", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.combine_heads_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n"], ["", "", "def", "multihead_attention_v2n", "(", "queries", ",", "memories", ",", "bias", ",", "w_x_inp", ",", "num_heads", ",", "\n", "key_size", ",", "value_size", ",", "output_size", ",", "params", ",", "\n", "keep_prob", "=", "None", ",", "output", "=", "True", ",", "dtype", "=", "None", ",", "\n", "scope", "=", "None", ")", ":", "\n", "    ", "\"\"\" Multi-head scaled-dot-product attention with input/output\n        transformations.\n\n    :param queries: A tensor with shape [batch, length_q, depth_q] if\n    :param memories: A tensor with shape [batch, length_m, depth_m]\n    :param bias: A tensor (see attention_bias)\n    :param num_heads: An integer dividing key_size and value_size\n    :param key_size: An integer\n    :param value_size: An integer\n    :param output_size: An integer\n    :param keep_prob: A floating point number in (0, 1]\n    :param output: Whether to use output transformation\n    :param dtype: An optional instance of tf.DType\n    :param scope: An optional string\n\n\n    :returns: A dict with the following keys:\n        weights: A tensor with shape [batch, heads, length_q, length_v]\n        outputs: A tensor with shape [batch, length_q, depth_v]\n        weight_ratio: [batch. length_q, d, length_v, d]\n\n        w_x_inp: [batch, len_src, len_src, d] or [batch, len_trg, len_trg, d]\n    \"\"\"", "\n", "\n", "if", "key_size", "%", "num_heads", "!=", "0", ":", "\n", "        ", "raise", "ValueError", "(", "\"Key size (%d) must be divisible by the number of \"", "\n", "\"attention heads (%d).\"", "%", "(", "key_size", ",", "num_heads", ")", ")", "\n", "\n", "", "if", "value_size", "%", "num_heads", "!=", "0", ":", "\n", "        ", "raise", "ValueError", "(", "\"Value size (%d) must be divisible by the number of \"", "\n", "\"attention heads (%d).\"", "%", "(", "value_size", ",", "num_heads", ")", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"multihead_attention\"", ",", "\n", "values", "=", "[", "queries", ",", "memories", "]", ",", "dtype", "=", "dtype", ")", ":", "\n", "        ", "bs", "=", "tf", ".", "shape", "(", "w_x_inp", ")", "[", "0", "]", "\n", "len_q", "=", "tf", ".", "shape", "(", "queries", ")", "[", "1", "]", "\n", "len_src", "=", "tf", ".", "shape", "(", "w_x_inp", ")", "[", "1", "]", "\n", "dim", "=", "tf", ".", "shape", "(", "w_x_inp", ")", "[", "3", "]", "\n", "if", "memories", "is", "None", ":", "\n", "# self attention", "\n", "            ", "size", "=", "key_size", "*", "2", "+", "value_size", "\n", "combined_linear", "=", "linear_v2n", "(", "queries", ",", "size", ",", "True", ",", "[", "w_x_inp", "]", ",", "\n", "params", ",", "True", ",", "scope", "=", "\"qkv_transform\"", ")", "\n", "combined", "=", "combined_linear", "[", "\"output\"", "]", "\n", "q", ",", "k", ",", "v", "=", "tf", ".", "split", "(", "combined", ",", "[", "key_size", ",", "key_size", ",", "value_size", "]", ",", "\n", "axis", "=", "-", "1", ")", "\n", "w_x_combined", "=", "combined_linear", "[", "\"weight_ratios\"", "]", "[", "0", "]", "\n", "w_x_q", ",", "w_x_k", ",", "w_x_v", "=", "tf", ".", "split", "(", "w_x_combined", ",", "\n", "[", "key_size", ",", "key_size", ",", "value_size", "]", ",", "\n", "axis", "=", "-", "1", ")", "\n", "", "else", ":", "\n", "            ", "q", "=", "nn", ".", "linear", "(", "queries", ",", "key_size", ",", "True", ",", "params", ",", "True", ",", "\n", "scope", "=", "\"q_transform\"", ")", "\n", "combined_linear", "=", "linear_v2n", "(", "memories", ",", "key_size", "+", "value_size", ",", "True", ",", "\n", "[", "w_x_inp", "]", ",", "params", ",", "True", ",", "\n", "scope", "=", "\"kv_transform\"", ")", "\n", "combined", "=", "combined_linear", "[", "\"output\"", "]", "\n", "k", ",", "v", "=", "tf", ".", "split", "(", "combined", ",", "[", "key_size", ",", "value_size", "]", ",", "axis", "=", "-", "1", ")", "\n", "w_x_combined", "=", "combined_linear", "[", "\"weight_ratios\"", "]", "[", "0", "]", "\n", "w_x_k", ",", "w_x_v", "=", "tf", ".", "split", "(", "w_x_combined", ",", "[", "key_size", ",", "value_size", "]", ",", "\n", "axis", "=", "-", "1", ")", "\n", "\n", "# split heads", "\n", "", "q", "=", "attention", ".", "split_heads", "(", "q", ",", "num_heads", ")", "\n", "k", "=", "attention", ".", "split_heads", "(", "k", ",", "num_heads", ")", "\n", "v", "=", "attention", ".", "split_heads", "(", "v", ",", "num_heads", ")", "\n", "w_x_v", "=", "split_heads", "(", "w_x_v", ",", "num_heads", ")", "\n", "\n", "# scale query", "\n", "key_depth_per_head", "=", "key_size", "//", "num_heads", "\n", "q", "*=", "key_depth_per_head", "**", "-", "0.5", "\n", "\n", "# attention", "\n", "results", "=", "attention", ".", "multiplicative_attention", "(", "q", ",", "k", ",", "v", ",", "bias", ",", "keep_prob", ")", "\n", "\n", "# combine heads", "\n", "weights", "=", "results", "[", "\"weights\"", "]", "\n", "x", "=", "attention", ".", "combine_heads", "(", "results", "[", "\"outputs\"", "]", ")", "\n", "\n", "w_x_v", "=", "tf", ".", "transpose", "(", "w_x_v", ",", "[", "0", ",", "1", ",", "3", ",", "2", ",", "4", "]", ")", "\n", "w_x_v", "=", "tf", ".", "reshape", "(", "w_x_v", ",", "[", "bs", ",", "num_heads", ",", "tf", ".", "shape", "(", "w_x_v", ")", "[", "2", "]", ",", "-", "1", "]", ")", "\n", "w_x_att", "=", "tf", ".", "matmul", "(", "weights", ",", "w_x_v", ")", "\n", "w_x_att", "=", "tf", ".", "reshape", "(", "w_x_att", ",", "\n", "[", "bs", ",", "num_heads", ",", "len_q", ",", "len_src", ",", "key_depth_per_head", "]", ")", "\n", "w_x_att", "=", "tf", ".", "transpose", "(", "w_x_att", ",", "[", "0", ",", "1", ",", "3", ",", "2", ",", "4", "]", ")", "\n", "w_x_att", "=", "combine_heads_v2n", "(", "w_x_att", ")", "\n", "\n", "if", "output", ":", "\n", "            ", "outputs_linear", "=", "linear_v2n", "(", "x", ",", "output_size", ",", "True", ",", "[", "w_x_att", "]", ",", "\n", "params", ",", "True", ",", "\n", "scope", "=", "\"output_transform\"", ")", "\n", "outputs", "=", "outputs_linear", "[", "\"output\"", "]", "\n", "w_x_out", "=", "outputs_linear", "[", "\"weight_ratios\"", "]", "[", "0", "]", "\n", "", "else", ":", "\n", "            ", "outputs", "=", "x", "\n", "w_x_out", "=", "w_x_att", "\n", "\n", "", "return", "{", "\"weights\"", ":", "weights", ",", "\"outputs\"", ":", "outputs", ",", "\"weight_ratio\"", ":", "w_x_out", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel.GPUParamServerDeviceSetter.__init__": [[15, 19], ["len"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "worker_device", ",", "ps_devices", ")", ":", "\n", "        ", "self", ".", "ps_devices", "=", "ps_devices", "\n", "self", ".", "worker_device", "=", "worker_device", "\n", "self", ".", "ps_sizes", "=", "[", "0", "]", "*", "len", "(", "self", ".", "ps_devices", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel.GPUParamServerDeviceSetter.__call__": [[20, 34], ["min", "op.outputs[].get_shape().num_elements", "enumerate", "operator.itemgetter", "op.outputs[].get_shape"], "methods", ["None"], ["", "def", "__call__", "(", "self", ",", "op", ")", ":", "\n", "        ", "if", "op", ".", "device", ":", "\n", "            ", "return", "op", ".", "device", "\n", "", "if", "op", ".", "type", "not", "in", "[", "\"Variable\"", ",", "\"VariableV2\"", ",", "\"VarHandleOp\"", "]", ":", "\n", "            ", "return", "self", ".", "worker_device", "\n", "\n", "# Gets the least loaded ps_device", "\n", "", "device_index", ",", "_", "=", "min", "(", "enumerate", "(", "self", ".", "ps_sizes", ")", ",", "\n", "key", "=", "operator", ".", "itemgetter", "(", "1", ")", ")", "\n", "device_name", "=", "self", ".", "ps_devices", "[", "device_index", "]", "\n", "var_size", "=", "op", ".", "outputs", "[", "0", "]", ".", "get_shape", "(", ")", ".", "num_elements", "(", ")", "\n", "self", ".", "ps_sizes", "[", "device_index", "]", "+=", "var_size", "\n", "\n", "return", "device_name", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel._maybe_repeat": [[36, 42], ["isinstance", "len"], "function", ["None"], ["", "", "def", "_maybe_repeat", "(", "x", ",", "n", ")", ":", "\n", "    ", "if", "isinstance", "(", "x", ",", "list", ")", ":", "\n", "        ", "assert", "len", "(", "x", ")", "==", "n", "\n", "return", "x", "\n", "", "else", ":", "\n", "        ", "return", "[", "x", "]", "*", "n", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel._create_device_setter": [[44, 53], ["tensorflow.train.replica_device_setter", "parallel.GPUParamServerDeviceSetter", "range"], "function", ["None"], ["", "", "def", "_create_device_setter", "(", "is_cpu_ps", ",", "worker", ",", "num_gpus", ")", ":", "\n", "    ", "if", "is_cpu_ps", ":", "\n", "# tf.train.replica_device_setter supports placing variables on the CPU,", "\n", "# all on one GPU, or on ps_servers defined in a cluster_spec.", "\n", "        ", "return", "tf", ".", "train", ".", "replica_device_setter", "(", "\n", "worker_device", "=", "worker", ",", "ps_device", "=", "\"/cpu:0\"", ",", "ps_tasks", "=", "1", ")", "\n", "", "else", ":", "\n", "        ", "gpus", "=", "[", "\"/gpu:%d\"", "%", "i", "for", "i", "in", "range", "(", "num_gpus", ")", "]", "\n", "return", "GPUParamServerDeviceSetter", "(", "worker", ",", "gpus", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel.data_parallelism": [[56, 93], ["len", "kwargs.iteritems", "parallel._maybe_repeat", "range", "isinstance", "parallel._maybe_repeat", "range", "parallel._create_device_setter", "list", "tuple", "parallel._maybe_repeat", "list", "range", "len", "tensorflow.variable_scope", "zip", "zip", "range", "tensorflow.get_variable_scope", "tensorflow.name_scope", "list", "tensorflow.device", "tuple.append"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel._maybe_repeat", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel._maybe_repeat", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel._create_device_setter", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel._maybe_repeat"], ["", "", "def", "data_parallelism", "(", "devices", ",", "fn", ",", "*", "args", ",", "**", "kwargs", ")", ":", "\n", "    ", "num_worker", "=", "len", "(", "devices", ")", "\n", "\n", "# Replicate args and kwargs", "\n", "if", "args", ":", "\n", "        ", "new_args", "=", "[", "_maybe_repeat", "(", "arg", ",", "num_worker", ")", "for", "arg", "in", "args", "]", "\n", "# Transpose", "\n", "new_args", "=", "[", "list", "(", "x", ")", "for", "x", "in", "zip", "(", "*", "new_args", ")", "]", "\n", "", "else", ":", "\n", "        ", "new_args", "=", "[", "[", "]", "for", "_", "in", "range", "(", "num_worker", ")", "]", "\n", "\n", "", "new_kwargs", "=", "[", "{", "}", "for", "_", "in", "range", "(", "num_worker", ")", "]", "\n", "\n", "for", "k", ",", "v", "in", "kwargs", ".", "iteritems", "(", ")", ":", "\n", "        ", "vals", "=", "_maybe_repeat", "(", "v", ",", "num_worker", ")", "\n", "\n", "for", "i", "in", "range", "(", "num_worker", ")", ":", "\n", "            ", "new_kwargs", "[", "i", "]", "[", "k", "]", "=", "vals", "[", "i", "]", "\n", "\n", "", "", "fns", "=", "_maybe_repeat", "(", "fn", ",", "num_worker", ")", "\n", "\n", "# Now make the parallel call.", "\n", "outputs", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "num_worker", ")", ":", "\n", "        ", "worker", "=", "\"/gpu:%d\"", "%", "i", "\n", "device_setter", "=", "_create_device_setter", "(", "False", ",", "worker", ",", "len", "(", "devices", ")", ")", "\n", "with", "tf", ".", "variable_scope", "(", "tf", ".", "get_variable_scope", "(", ")", ",", "reuse", "=", "(", "i", "!=", "0", ")", ")", ":", "\n", "            ", "with", "tf", ".", "name_scope", "(", "\"parallel_%d\"", "%", "i", ")", ":", "\n", "                ", "with", "tf", ".", "device", "(", "device_setter", ")", ":", "\n", "                    ", "outputs", ".", "append", "(", "fns", "[", "i", "]", "(", "*", "new_args", "[", "i", "]", ",", "**", "new_kwargs", "[", "i", "]", ")", ")", "\n", "\n", "", "", "", "", "if", "isinstance", "(", "outputs", "[", "0", "]", ",", "tuple", ")", ":", "\n", "        ", "outputs", "=", "list", "(", "zip", "(", "*", "outputs", ")", ")", "\n", "outputs", "=", "tuple", "(", "[", "list", "(", "o", ")", "for", "o", "in", "outputs", "]", ")", "\n", "\n", "", "return", "outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel.shard_features": [[95, 117], ["len", "features.iteritems", "range", "tensorflow.convert_to_tensor", "datashard_to_features.append", "tf.tile.shape.as_list", "tensorflow.expand_dims", "tensorflow.tile", "tensorflow.device", "tensorflow.split", "sharded_features.iteritems"], "function", ["None"], ["", "def", "shard_features", "(", "features", ",", "device_list", ")", ":", "\n", "    ", "num_datashards", "=", "len", "(", "device_list", ")", "\n", "\n", "sharded_features", "=", "{", "}", "\n", "\n", "for", "k", ",", "v", "in", "features", ".", "iteritems", "(", ")", ":", "\n", "        ", "v", "=", "tf", ".", "convert_to_tensor", "(", "v", ")", "\n", "if", "not", "v", ".", "shape", ".", "as_list", "(", ")", ":", "\n", "            ", "v", "=", "tf", ".", "expand_dims", "(", "v", ",", "axis", "=", "-", "1", ")", "\n", "v", "=", "tf", ".", "tile", "(", "v", ",", "[", "num_datashards", "]", ")", "\n", "", "with", "tf", ".", "device", "(", "v", ".", "device", ")", ":", "\n", "            ", "sharded_features", "[", "k", "]", "=", "tf", ".", "split", "(", "v", ",", "num_datashards", ",", "0", ")", "\n", "\n", "", "", "datashard_to_features", "=", "[", "]", "\n", "\n", "for", "d", "in", "range", "(", "num_datashards", ")", ":", "\n", "        ", "feat", "=", "{", "\n", "k", ":", "v", "[", "d", "]", "for", "k", ",", "v", "in", "sharded_features", ".", "iteritems", "(", ")", "\n", "}", "\n", "datashard_to_features", ".", "append", "(", "feat", ")", "\n", "\n", "", "return", "datashard_to_features", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel.parallel_model": [[119, 132], ["parallel.shard_features", "parallel.data_parallelism", "len", "model_fn"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.shard_features", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel.data_parallelism"], ["", "def", "parallel_model", "(", "model_fn", ",", "features", ",", "devices", ",", "use_cpu", "=", "False", ")", ":", "\n", "    ", "devices", "=", "[", "\"gpu:%d\"", "%", "d", "for", "d", "in", "devices", "]", "\n", "\n", "if", "use_cpu", ":", "\n", "        ", "devices", "+=", "[", "\"cpu:0\"", "]", "\n", "\n", "", "if", "len", "(", "devices", ")", "==", "1", ":", "\n", "        ", "return", "[", "model_fn", "(", "features", ")", "]", "\n", "\n", "", "features", "=", "shard_features", "(", "features", ",", "devices", ")", "\n", "\n", "outputs", "=", "data_parallelism", "(", "devices", ",", "model_fn", ",", "features", ")", "\n", "return", "outputs", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks.EvaluationHook.__init__": [[182, 216], ["tensorflow.logging.info", "base_dir.rstrip", "os.path.join", "os.path.join", "os.path.join", "tensorflow.train.SecondOrStepTimer", "ValueError"], "methods", ["None"], ["def", "__init__", "(", "self", ",", "eval_fn", ",", "eval_input_fn", ",", "eval_decode_fn", ",", "base_dir", ",", "\n", "session_config", ",", "max_to_keep", "=", "5", ",", "eval_secs", "=", "None", ",", "\n", "eval_steps", "=", "None", ",", "metric", "=", "\"BLEU\"", ")", ":", "\n", "        ", "\"\"\" Initializes a `EvaluationHook`.\n        :param eval_fn: A function with signature (feature)\n        :param eval_input_fn: A function with signature ()\n        :param eval_decode_fn: A function with signature (inputs)\n        :param base_dir: A string. Base directory for the checkpoint files.\n        :param session_config: An instance of tf.ConfigProto\n        :param max_to_keep: An integer. The maximum of checkpoints to save\n        :param eval_secs: An integer, eval every N secs.\n        :param eval_steps: An integer, eval every N steps.\n        :param checkpoint_basename: `str`, base name for the checkpoint files.\n        :raises ValueError: One of `save_steps` or `save_secs` should be set.\n        :raises ValueError: At most one of saver or scaffold should be set.\n        \"\"\"", "\n", "tf", ".", "logging", ".", "info", "(", "\"Create EvaluationHook.\"", ")", "\n", "\n", "if", "metric", "!=", "\"BLEU\"", ":", "\n", "            ", "raise", "ValueError", "(", "\"Currently, EvaluationHook only support BLEU\"", ")", "\n", "\n", "", "self", ".", "_base_dir", "=", "base_dir", ".", "rstrip", "(", "\"/\"", ")", "\n", "self", ".", "_session_config", "=", "session_config", "\n", "self", ".", "_save_path", "=", "os", ".", "path", ".", "join", "(", "base_dir", ",", "\"eval\"", ")", "\n", "self", ".", "_record_name", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_save_path", ",", "\"record\"", ")", "\n", "self", ".", "_log_name", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_save_path", ",", "\"log\"", ")", "\n", "self", ".", "_eval_fn", "=", "eval_fn", "\n", "self", ".", "_eval_input_fn", "=", "eval_input_fn", "\n", "self", ".", "_eval_decode_fn", "=", "eval_decode_fn", "\n", "self", ".", "_max_to_keep", "=", "max_to_keep", "\n", "self", ".", "_metric", "=", "metric", "\n", "self", ".", "_global_step", "=", "None", "\n", "self", ".", "_timer", "=", "tf", ".", "train", ".", "SecondOrStepTimer", "(", "\n", "every_secs", "=", "eval_secs", "or", "None", ",", "every_steps", "=", "eval_steps", "or", "None", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks.EvaluationHook.begin": [[218, 239], ["tensorflow.train.get_global_step", "os.path.join", "tensorflow.gfile.Glob", "hooks.EvaluationHook._timer.last_triggered_step", "hooks.EvaluationHook._timer.update_last_triggered_step", "tensorflow.gfile.Exists", "tensorflow.logging.info", "tensorflow.gfile.MakeDirs", "name.replace", "tensorflow.gfile.Copy", "RuntimeError"], "methods", ["None"], ["", "def", "begin", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "_timer", ".", "last_triggered_step", "(", ")", "is", "None", ":", "\n", "            ", "self", ".", "_timer", ".", "update_last_triggered_step", "(", "0", ")", "\n", "\n", "", "global_step", "=", "tf", ".", "train", ".", "get_global_step", "(", ")", "\n", "\n", "if", "not", "tf", ".", "gfile", ".", "Exists", "(", "self", ".", "_save_path", ")", ":", "\n", "            ", "tf", ".", "logging", ".", "info", "(", "\"Making dir: %s\"", "%", "self", ".", "_save_path", ")", "\n", "tf", ".", "gfile", ".", "MakeDirs", "(", "self", ".", "_save_path", ")", "\n", "\n", "", "params_pattern", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_base_dir", ",", "\"*.json\"", ")", "\n", "params_files", "=", "tf", ".", "gfile", ".", "Glob", "(", "params_pattern", ")", "\n", "\n", "for", "name", "in", "params_files", ":", "\n", "            ", "new_name", "=", "name", ".", "replace", "(", "self", ".", "_base_dir", ",", "self", ".", "_save_path", ")", "\n", "tf", ".", "gfile", ".", "Copy", "(", "name", ",", "new_name", ",", "overwrite", "=", "True", ")", "\n", "\n", "", "if", "global_step", "is", "None", ":", "\n", "            ", "raise", "RuntimeError", "(", "\"Global step should be created first\"", ")", "\n", "\n", "", "self", ".", "_global_step", "=", "global_step", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks.EvaluationHook.before_run": [[240, 243], ["tensorflow.train.SessionRunArgs"], "methods", ["None"], ["", "def", "before_run", "(", "self", ",", "run_context", ")", ":", "\n", "        ", "args", "=", "tf", ".", "train", ".", "SessionRunArgs", "(", "self", ".", "_global_step", ")", "\n", "return", "args", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks.EvaluationHook.after_run": [[244, 309], ["hooks.EvaluationHook._timer.should_trigger_for_step", "run_context.session.run", "hooks.EvaluationHook._timer.should_trigger_for_step", "hooks.EvaluationHook._timer.update_last_triggered_step", "os.path.join", "hooks._get_saver", "tensorflow.logging.info", "_get_saver.save", "tensorflow.logging.info", "hooks._evaluate", "tensorflow.logging.info", "hooks._save_log", "os.path.join", "hooks._read_checkpoint_def", "hooks._read_score_record", "hooks._add_to_record", "hooks._save_score_record", "checkpoint_filename.replace.replace.replace", "hooks._save_checkpoint_def", "tensorflow.logging.info", "os.path.join", "os.path.join", "tensorflow.gfile.Glob", "tensorflow.logging.info", "os.path.join", "tensorflow.logging.info", "tensorflow.gfile.Glob", "o_file.replace", "tensorflow.gfile.Copy", "tensorflow.gfile.Remove"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._get_saver", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._evaluate", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._save_log", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._read_checkpoint_def", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._read_score_record", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._add_to_record", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._save_score_record", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._save_checkpoint_def"], ["", "def", "after_run", "(", "self", ",", "run_context", ",", "run_values", ")", ":", "\n", "        ", "stale_global_step", "=", "run_values", ".", "results", "\n", "\n", "if", "self", ".", "_timer", ".", "should_trigger_for_step", "(", "stale_global_step", "+", "1", ")", ":", "\n", "            ", "global_step", "=", "run_context", ".", "session", ".", "run", "(", "self", ".", "_global_step", ")", "\n", "\n", "# Get the real value", "\n", "if", "self", ".", "_timer", ".", "should_trigger_for_step", "(", "global_step", ")", ":", "\n", "                ", "self", ".", "_timer", ".", "update_last_triggered_step", "(", "global_step", ")", "\n", "# Save model", "\n", "save_path", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_base_dir", ",", "\"model.ckpt\"", ")", "\n", "saver", "=", "_get_saver", "(", ")", "\n", "tf", ".", "logging", ".", "info", "(", "\"Saving checkpoints for %d into %s.\"", "%", "\n", "(", "global_step", ",", "save_path", ")", ")", "\n", "saver", ".", "save", "(", "run_context", ".", "session", ",", "\n", "save_path", ",", "\n", "global_step", "=", "global_step", ")", "\n", "# Do validation here", "\n", "tf", ".", "logging", ".", "info", "(", "\"Validating model at step %d\"", "%", "global_step", ")", "\n", "score", "=", "_evaluate", "(", "self", ".", "_eval_fn", ",", "self", ".", "_eval_input_fn", ",", "\n", "self", ".", "_eval_decode_fn", ",", "\n", "self", ".", "_base_dir", ",", "\n", "self", ".", "_session_config", ")", "\n", "tf", ".", "logging", ".", "info", "(", "\"%s at step %d: %f\"", "%", "\n", "(", "self", ".", "_metric", ",", "global_step", ",", "score", ")", ")", "\n", "\n", "_save_log", "(", "self", ".", "_log_name", ",", "(", "self", ".", "_metric", ",", "global_step", ",", "score", ")", ")", "\n", "\n", "checkpoint_filename", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_base_dir", ",", "\n", "\"checkpoint\"", ")", "\n", "all_checkpoints", "=", "_read_checkpoint_def", "(", "checkpoint_filename", ")", "\n", "records", "=", "_read_score_record", "(", "self", ".", "_record_name", ")", "\n", "latest_checkpoint", "=", "all_checkpoints", "[", "-", "1", "]", "\n", "record", "=", "[", "latest_checkpoint", ",", "score", "]", "\n", "added", ",", "removed", ",", "records", "=", "_add_to_record", "(", "records", ",", "record", ",", "\n", "self", ".", "_max_to_keep", ")", "\n", "\n", "if", "added", "is", "not", "None", ":", "\n", "                    ", "old_path", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_base_dir", ",", "added", ")", "\n", "new_path", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_save_path", ",", "added", ")", "\n", "old_files", "=", "tf", ".", "gfile", ".", "Glob", "(", "old_path", "+", "\"*\"", ")", "\n", "tf", ".", "logging", ".", "info", "(", "\"Copying %s to %s\"", "%", "(", "old_path", ",", "new_path", ")", ")", "\n", "\n", "for", "o_file", "in", "old_files", ":", "\n", "                        ", "n_file", "=", "o_file", ".", "replace", "(", "old_path", ",", "new_path", ")", "\n", "tf", ".", "gfile", ".", "Copy", "(", "o_file", ",", "n_file", ",", "overwrite", "=", "True", ")", "\n", "\n", "", "", "if", "removed", "is", "not", "None", ":", "\n", "                    ", "filename", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_save_path", ",", "removed", ")", "\n", "tf", ".", "logging", ".", "info", "(", "\"Removing %s\"", "%", "filename", ")", "\n", "files", "=", "tf", ".", "gfile", ".", "Glob", "(", "filename", "+", "\"*\"", ")", "\n", "\n", "for", "name", "in", "files", ":", "\n", "                        ", "tf", ".", "gfile", ".", "Remove", "(", "name", ")", "\n", "\n", "", "", "_save_score_record", "(", "self", ".", "_record_name", ",", "records", ")", "\n", "checkpoint_filename", "=", "checkpoint_filename", ".", "replace", "(", "\n", "self", ".", "_base_dir", ",", "self", ".", "_save_path", "\n", ")", "\n", "_save_checkpoint_def", "(", "checkpoint_filename", ",", "\n", "[", "item", "[", "0", "]", "for", "item", "in", "records", "]", ")", "\n", "\n", "best_score", "=", "records", "[", "0", "]", "[", "1", "]", "\n", "tf", ".", "logging", ".", "info", "(", "\"Best score at step %d: %f\"", "%", "\n", "(", "global_step", ",", "best_score", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks.EvaluationHook.end": [[310, 359], ["session.run", "hooks.EvaluationHook._timer.last_triggered_step", "tensorflow.logging.info", "hooks._evaluate", "tensorflow.logging.info", "os.path.join", "hooks._read_checkpoint_def", "hooks._read_score_record", "hooks._add_to_record", "hooks._save_score_record", "checkpoint_filename.replace.replace.replace", "hooks._save_checkpoint_def", "tensorflow.logging.info", "os.path.join", "os.path.join", "tensorflow.gfile.Glob", "tensorflow.logging.info", "os.path.join", "tensorflow.logging.info", "tensorflow.gfile.Glob", "o_file.replace", "tensorflow.gfile.Copy", "tensorflow.gfile.Remove"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._evaluate", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._read_checkpoint_def", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._read_score_record", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._add_to_record", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._save_score_record", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._save_checkpoint_def"], ["", "", "", "def", "end", "(", "self", ",", "session", ")", ":", "\n", "        ", "last_step", "=", "session", ".", "run", "(", "self", ".", "_global_step", ")", "\n", "\n", "if", "last_step", "!=", "self", ".", "_timer", ".", "last_triggered_step", "(", ")", ":", "\n", "            ", "global_step", "=", "last_step", "\n", "tf", ".", "logging", ".", "info", "(", "\"Validating model at step %d\"", "%", "global_step", ")", "\n", "score", "=", "_evaluate", "(", "self", ".", "_eval_fn", ",", "self", ".", "_eval_input_fn", ",", "\n", "self", ".", "_eval_decode_fn", ",", "\n", "self", ".", "_base_dir", ",", "\n", "self", ".", "_session_config", ")", "\n", "tf", ".", "logging", ".", "info", "(", "\"%s at step %d: %f\"", "%", "\n", "(", "self", ".", "_metric", ",", "global_step", ",", "score", ")", ")", "\n", "\n", "checkpoint_filename", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_base_dir", ",", "\n", "\"checkpoint\"", ")", "\n", "all_checkpoints", "=", "_read_checkpoint_def", "(", "checkpoint_filename", ")", "\n", "records", "=", "_read_score_record", "(", "self", ".", "_record_name", ")", "\n", "latest_checkpoint", "=", "all_checkpoints", "[", "-", "1", "]", "\n", "record", "=", "[", "latest_checkpoint", ",", "score", "]", "\n", "added", ",", "removed", ",", "records", "=", "_add_to_record", "(", "records", ",", "record", ",", "\n", "self", ".", "_max_to_keep", ")", "\n", "\n", "if", "added", "is", "not", "None", ":", "\n", "                ", "old_path", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_base_dir", ",", "added", ")", "\n", "new_path", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_save_path", ",", "added", ")", "\n", "old_files", "=", "tf", ".", "gfile", ".", "Glob", "(", "old_path", "+", "\"*\"", ")", "\n", "tf", ".", "logging", ".", "info", "(", "\"Copying %s to %s\"", "%", "(", "old_path", ",", "new_path", ")", ")", "\n", "\n", "for", "o_file", "in", "old_files", ":", "\n", "                    ", "n_file", "=", "o_file", ".", "replace", "(", "old_path", ",", "new_path", ")", "\n", "tf", ".", "gfile", ".", "Copy", "(", "o_file", ",", "n_file", ",", "overwrite", "=", "True", ")", "\n", "\n", "", "", "if", "removed", "is", "not", "None", ":", "\n", "                ", "filename", "=", "os", ".", "path", ".", "join", "(", "self", ".", "_save_path", ",", "removed", ")", "\n", "tf", ".", "logging", ".", "info", "(", "\"Removing %s\"", "%", "filename", ")", "\n", "files", "=", "tf", ".", "gfile", ".", "Glob", "(", "filename", "+", "\"*\"", ")", "\n", "\n", "for", "name", "in", "files", ":", "\n", "                    ", "tf", ".", "gfile", ".", "Remove", "(", "name", ")", "\n", "\n", "", "", "_save_score_record", "(", "self", ".", "_record_name", ",", "records", ")", "\n", "checkpoint_filename", "=", "checkpoint_filename", ".", "replace", "(", "\n", "self", ".", "_base_dir", ",", "self", ".", "_save_path", "\n", ")", "\n", "_save_checkpoint_def", "(", "checkpoint_filename", ",", "\n", "[", "item", "[", "0", "]", "for", "item", "in", "records", "]", ")", "\n", "\n", "best_score", "=", "records", "[", "0", "]", "[", "1", "]", "\n", "tf", ".", "logging", ".", "info", "(", "\"Best score: %f\"", "%", "best_score", ")", "\n", "", "", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._get_saver": [[16, 28], ["tensorflow.get_collection", "RuntimeError", "len", "RuntimeError"], "function", ["None"], ["def", "_get_saver", "(", ")", ":", "\n", "# Get saver from the SAVERS collection if present.", "\n", "    ", "collection_key", "=", "tf", ".", "GraphKeys", ".", "SAVERS", "\n", "savers", "=", "tf", ".", "get_collection", "(", "collection_key", ")", "\n", "\n", "if", "not", "savers", ":", "\n", "        ", "raise", "RuntimeError", "(", "\"No items in collection {}. \"", "\n", "\"Please add a saver to the collection \"", ")", "\n", "", "elif", "len", "(", "savers", ")", ">", "1", ":", "\n", "        ", "raise", "RuntimeError", "(", "\"More than one item in collection\"", ")", "\n", "\n", "", "return", "savers", "[", "0", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._save_log": [[30, 37], ["open", "datetime.datetime.now", "fd.write"], "function", ["None"], ["", "def", "_save_log", "(", "filename", ",", "result", ")", ":", "\n", "    ", "metric", ",", "global_step", ",", "score", "=", "result", "\n", "\n", "with", "open", "(", "filename", ",", "\"a\"", ")", "as", "fd", ":", "\n", "        ", "time", "=", "datetime", ".", "datetime", ".", "now", "(", ")", "\n", "msg", "=", "\"%s: %s at step %d: %f\\n\"", "%", "(", "time", ",", "metric", ",", "global_step", ",", "score", ")", "\n", "fd", ".", "write", "(", "msg", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._read_checkpoint_def": [[39, 49], ["tensorflow.gfile.GFile", "fd.readline", "records.append", "[].strip", "line.strip().split", "line.strip"], "function", ["None"], ["", "", "def", "_read_checkpoint_def", "(", "filename", ")", ":", "\n", "    ", "records", "=", "[", "]", "\n", "\n", "with", "tf", ".", "gfile", ".", "GFile", "(", "filename", ")", "as", "fd", ":", "\n", "        ", "fd", ".", "readline", "(", ")", "\n", "\n", "for", "line", "in", "fd", ":", "\n", "            ", "records", ".", "append", "(", "line", ".", "strip", "(", ")", ".", "split", "(", "\":\"", ")", "[", "-", "1", "]", ".", "strip", "(", ")", "[", "1", ":", "-", "1", "]", ")", "\n", "\n", "", "", "return", "records", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._save_checkpoint_def": [[51, 67], ["sorted", "int", "keys.append", "tensorflow.gfile.GFile", "fd.write", "operator.itemgetter", "fd.write", "checkpoint_name.strip().split", "checkpoint_name.strip"], "function", ["None"], ["", "def", "_save_checkpoint_def", "(", "filename", ",", "checkpoint_names", ")", ":", "\n", "    ", "keys", "=", "[", "]", "\n", "\n", "for", "checkpoint_name", "in", "checkpoint_names", ":", "\n", "        ", "step", "=", "int", "(", "checkpoint_name", ".", "strip", "(", ")", ".", "split", "(", "\"-\"", ")", "[", "-", "1", "]", ")", "\n", "keys", ".", "append", "(", "(", "step", ",", "checkpoint_name", ")", ")", "\n", "\n", "", "sorted_names", "=", "sorted", "(", "keys", ",", "key", "=", "operator", ".", "itemgetter", "(", "0", ")", ",", "\n", "reverse", "=", "True", ")", "\n", "\n", "with", "tf", ".", "gfile", ".", "GFile", "(", "filename", ",", "\"w\"", ")", "as", "fd", ":", "\n", "        ", "fd", ".", "write", "(", "\"model_checkpoint_path: \\\"%s\\\"\\n\"", "%", "checkpoint_names", "[", "0", "]", ")", "\n", "\n", "for", "checkpoint_name", "in", "sorted_names", ":", "\n", "            ", "checkpoint_name", "=", "checkpoint_name", "[", "1", "]", "\n", "fd", ".", "write", "(", "\"all_model_checkpoint_paths: \\\"%s\\\"\\n\"", "%", "checkpoint_name", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._read_score_record": [[69, 84], ["tensorflow.gfile.Exists", "tensorflow.gfile.GFile", "line.strip().split", "float", "records.append", "name.strip", "line.strip"], "function", ["None"], ["", "", "", "def", "_read_score_record", "(", "filename", ")", ":", "\n", "# \"checkpoint_name\": score", "\n", "    ", "records", "=", "[", "]", "\n", "\n", "if", "not", "tf", ".", "gfile", ".", "Exists", "(", "filename", ")", ":", "\n", "        ", "return", "records", "\n", "\n", "", "with", "tf", ".", "gfile", ".", "GFile", "(", "filename", ")", "as", "fd", ":", "\n", "        ", "for", "line", "in", "fd", ":", "\n", "            ", "name", ",", "score", "=", "line", ".", "strip", "(", ")", ".", "split", "(", "\":\"", ")", "\n", "name", "=", "name", ".", "strip", "(", ")", "[", "1", ":", "-", "1", "]", "\n", "score", "=", "float", "(", "score", ")", "\n", "records", ".", "append", "(", "[", "name", ",", "score", "]", ")", "\n", "\n", "", "", "return", "records", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._save_score_record": [[86, 102], ["sorted", "int", "keys.append", "tensorflow.gfile.GFile", "operator.itemgetter", "fd.write", "checkpoint_name.strip().split", "checkpoint_name.strip"], "function", ["None"], ["", "def", "_save_score_record", "(", "filename", ",", "records", ")", ":", "\n", "    ", "keys", "=", "[", "]", "\n", "\n", "for", "record", "in", "records", ":", "\n", "        ", "checkpoint_name", "=", "record", "[", "0", "]", "\n", "step", "=", "int", "(", "checkpoint_name", ".", "strip", "(", ")", ".", "split", "(", "\"-\"", ")", "[", "-", "1", "]", ")", "\n", "keys", ".", "append", "(", "(", "step", ",", "record", ")", ")", "\n", "\n", "", "sorted_keys", "=", "sorted", "(", "keys", ",", "key", "=", "operator", ".", "itemgetter", "(", "0", ")", ",", "\n", "reverse", "=", "True", ")", "\n", "sorted_records", "=", "[", "item", "[", "1", "]", "for", "item", "in", "sorted_keys", "]", "\n", "\n", "with", "tf", ".", "gfile", ".", "GFile", "(", "filename", ",", "\"w\"", ")", "as", "fd", ":", "\n", "        ", "for", "record", "in", "sorted_records", ":", "\n", "            ", "checkpoint_name", ",", "score", "=", "record", "\n", "fd", ".", "write", "(", "\"\\\"%s\\\": %f\\n\"", "%", "(", "checkpoint_name", ",", "score", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._add_to_record": [[104, 131], ["sorted", "len", "sorted", "sorted.append"], "function", ["None"], ["", "", "", "def", "_add_to_record", "(", "records", ",", "record", ",", "max_to_keep", ")", ":", "\n", "    ", "added", "=", "None", "\n", "removed", "=", "None", "\n", "models", "=", "{", "}", "\n", "\n", "for", "(", "name", ",", "score", ")", "in", "records", ":", "\n", "        ", "models", "[", "name", "]", "=", "score", "\n", "\n", "", "if", "len", "(", "records", ")", "<", "max_to_keep", ":", "\n", "        ", "if", "record", "[", "0", "]", "not", "in", "models", ":", "\n", "            ", "added", "=", "record", "[", "0", "]", "\n", "records", ".", "append", "(", "record", ")", "\n", "", "", "else", ":", "\n", "        ", "sorted_records", "=", "sorted", "(", "records", ",", "key", "=", "lambda", "x", ":", "-", "x", "[", "1", "]", ")", "\n", "worst_score", "=", "sorted_records", "[", "-", "1", "]", "[", "1", "]", "\n", "current_score", "=", "record", "[", "1", "]", "\n", "\n", "if", "current_score", ">=", "worst_score", ":", "\n", "            ", "if", "record", "[", "0", "]", "not", "in", "models", ":", "\n", "                ", "added", "=", "record", "[", "0", "]", "\n", "removed", "=", "sorted_records", "[", "-", "1", "]", "[", "0", "]", "\n", "records", "=", "sorted_records", "[", ":", "-", "1", "]", "+", "[", "record", "]", "\n", "\n", "# Sort", "\n", "", "", "", "records", "=", "sorted", "(", "records", ",", "key", "=", "lambda", "x", ":", "-", "x", "[", "1", "]", ")", "\n", "\n", "return", "added", ",", "removed", ",", "records", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.hooks._evaluate": [[133, 175], ["tensorflow.Graph", "tf.Graph.as_default", "input_fn", "eval_fn", "tensorflow.train.ChiefSessionCreator", "decode_fn", "thumt.bleu", "tensorflow.placeholder", "tensorflow.placeholder", "tensorflow.train.MonitoredSession", "decode_fn", "list", "range", "sess.should_stop", "sess.run", "sess.run", "outputs.tolist.tolist", "all_outputs.extend", "range", "zip", "len", "item.tolist", "len", "all_refs[].extend"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.bleu.bleu"], ["", "def", "_evaluate", "(", "eval_fn", ",", "input_fn", ",", "decode_fn", ",", "path", ",", "config", ")", ":", "\n", "    ", "graph", "=", "tf", ".", "Graph", "(", ")", "\n", "with", "graph", ".", "as_default", "(", ")", ":", "\n", "        ", "features", "=", "input_fn", "(", ")", "\n", "refs", "=", "features", "[", "\"references\"", "]", "\n", "placeholders", "=", "{", "\n", "\"source\"", ":", "tf", ".", "placeholder", "(", "tf", ".", "int32", ",", "[", "None", ",", "None", "]", ",", "\"source\"", ")", ",", "\n", "\"source_length\"", ":", "tf", ".", "placeholder", "(", "tf", ".", "int32", ",", "[", "None", "]", ",", "\"source_length\"", ")", "\n", "}", "\n", "predictions", "=", "eval_fn", "(", "placeholders", ")", "\n", "predictions", "=", "predictions", "[", "0", "]", "[", ":", ",", "0", ",", ":", "]", "\n", "\n", "all_refs", "=", "[", "[", "]", "for", "_", "in", "range", "(", "len", "(", "refs", ")", ")", "]", "\n", "all_outputs", "=", "[", "]", "\n", "\n", "sess_creator", "=", "tf", ".", "train", ".", "ChiefSessionCreator", "(", "\n", "checkpoint_dir", "=", "path", ",", "\n", "config", "=", "config", "\n", ")", "\n", "\n", "with", "tf", ".", "train", ".", "MonitoredSession", "(", "session_creator", "=", "sess_creator", ")", "as", "sess", ":", "\n", "            ", "while", "not", "sess", ".", "should_stop", "(", ")", ":", "\n", "                ", "feats", "=", "sess", ".", "run", "(", "features", ")", "\n", "outputs", "=", "sess", ".", "run", "(", "predictions", ",", "feed_dict", "=", "{", "\n", "placeholders", "[", "\"source\"", "]", ":", "feats", "[", "\"source\"", "]", ",", "\n", "placeholders", "[", "\"source_length\"", "]", ":", "feats", "[", "\"source_length\"", "]", "\n", "}", ")", "\n", "# shape: [batch, len]", "\n", "outputs", "=", "outputs", ".", "tolist", "(", ")", "\n", "# shape: ([batch, len], ..., [batch, len])", "\n", "references", "=", "[", "item", ".", "tolist", "(", ")", "for", "item", "in", "feats", "[", "\"references\"", "]", "]", "\n", "\n", "all_outputs", ".", "extend", "(", "outputs", ")", "\n", "\n", "for", "i", "in", "range", "(", "len", "(", "refs", ")", ")", ":", "\n", "                    ", "all_refs", "[", "i", "]", ".", "extend", "(", "references", "[", "i", "]", ")", "\n", "\n", "", "", "", "decoded_symbols", "=", "decode_fn", "(", "all_outputs", ")", "\n", "decoded_refs", "=", "[", "decode_fn", "(", "refs", ")", "for", "refs", "in", "all_refs", "]", "\n", "decoded_refs", "=", "[", "list", "(", "x", ")", "for", "x", "in", "zip", "(", "*", "decoded_refs", ")", "]", "\n", "\n", "return", "bleu", ".", "bleu", "(", "decoded_symbols", ",", "decoded_refs", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.optimize._zero_variables": [[11, 20], ["tensorflow.group", "ops.append", "tensorflow.device", "var.assign", "tensorflow.zeros", "var.shape.as_list"], "function", ["None"], ["def", "_zero_variables", "(", "variables", ",", "name", "=", "None", ")", ":", "\n", "    ", "ops", "=", "[", "]", "\n", "\n", "for", "var", "in", "variables", ":", "\n", "        ", "with", "tf", ".", "device", "(", "var", ".", "device", ")", ":", "\n", "            ", "op", "=", "var", ".", "assign", "(", "tf", ".", "zeros", "(", "var", ".", "shape", ".", "as_list", "(", ")", ")", ")", "\n", "", "ops", ".", "append", "(", "op", ")", "\n", "\n", "", "return", "tf", ".", "group", "(", "*", "ops", ",", "name", "=", "name", "or", "\"zero_variables\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.optimize._replicate_variables": [[22, 33], ["tensorflow.device", "new_vars.append", "[].rstrip", "tensorflow.Variable", "tensorflow.zeros", "var.shape.as_list", "var.name.split"], "function", ["None"], ["", "def", "_replicate_variables", "(", "variables", ",", "device", "=", "None", ")", ":", "\n", "    ", "new_vars", "=", "[", "]", "\n", "\n", "for", "var", "in", "variables", ":", "\n", "        ", "device", "=", "device", "or", "var", ".", "device", "\n", "with", "tf", ".", "device", "(", "device", ")", ":", "\n", "            ", "name", "=", "var", ".", "name", ".", "split", "(", "\":\"", ")", "[", "0", "]", ".", "rstrip", "(", "\"/\"", ")", "+", "\"/replica\"", "\n", "new_vars", ".", "append", "(", "tf", ".", "Variable", "(", "tf", ".", "zeros", "(", "var", ".", "shape", ".", "as_list", "(", ")", ")", ",", "\n", "name", "=", "name", ",", "trainable", "=", "False", ")", ")", "\n", "\n", "", "", "return", "new_vars", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.optimize._collect_gradients": [[35, 45], ["zip", "tensorflow.group", "isinstance", "ops.append", "ops.append", "tensorflow.assign_add", "tensorflow.scatter_add"], "function", ["None"], ["", "def", "_collect_gradients", "(", "gradients", ",", "variables", ")", ":", "\n", "    ", "ops", "=", "[", "]", "\n", "\n", "for", "grad", ",", "var", "in", "zip", "(", "gradients", ",", "variables", ")", ":", "\n", "        ", "if", "isinstance", "(", "grad", ",", "tf", ".", "Tensor", ")", ":", "\n", "            ", "ops", ".", "append", "(", "tf", ".", "assign_add", "(", "var", ",", "grad", ")", ")", "\n", "", "else", ":", "\n", "            ", "ops", ".", "append", "(", "tf", ".", "scatter_add", "(", "var", ",", "grad", ".", "indices", ",", "grad", ".", "values", ")", ")", "\n", "\n", "", "", "return", "tf", ".", "group", "(", "*", "ops", ",", "name", "=", "\"collect_gradients\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.optimize.create_train_op": [[47, 107], ["tensorflow.summary.scalar", "tensorflow.name_scope", "optimizer.compute_gradients", "tensorflow.global_norm", "tensorflow.summary.scalar", "zip", "isinstance", "list", "optimizer.apply_gradients", "tensorflow.no_op", "tensorflow.no_op", "tensorflow.Variable", "optimize._replicate_variables", "optimize._zero_variables", "optimize._collect_gradients", "tensorflow.assign_add", "tensorflow.group", "isinstance", "tensorflow.clip_by_global_norm", "zip", "tensorflow.zeros", "variable.name.replace", "tensorflow.summary.histogram", "tensorflow.summary.scalar", "tensorflow.trainable_variables", "zip", "tensorflow.global_norm"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.optimize._replicate_variables", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.optimize._zero_variables", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.optimize._collect_gradients"], ["", "def", "create_train_op", "(", "loss", ",", "optimizer", ",", "global_step", ",", "params", ")", ":", "\n", "\n", "    ", "with", "tf", ".", "name_scope", "(", "\"create_train_op\"", ")", ":", "\n", "        ", "grads_and_vars", "=", "optimizer", ".", "compute_gradients", "(", "\n", "loss", ",", "colocate_gradients_with_ops", "=", "True", ")", "\n", "gradients", "=", "[", "item", "[", "0", "]", "for", "item", "in", "grads_and_vars", "]", "\n", "variables", "=", "[", "item", "[", "1", "]", "for", "item", "in", "grads_and_vars", "]", "\n", "\n", "if", "params", ".", "update_cycle", "==", "1", ":", "\n", "            ", "zero_variables_op", "=", "tf", ".", "no_op", "(", "\"zero_variables\"", ")", "\n", "collect_op", "=", "tf", ".", "no_op", "(", "\"collect_op\"", ")", "\n", "", "else", ":", "\n", "            ", "loss_var", "=", "tf", ".", "Variable", "(", "tf", ".", "zeros", "(", "[", "]", ")", ",", "name", "=", "\"loss/replica\"", ",", "\n", "trainable", "=", "False", ")", "\n", "slot_variables", "=", "_replicate_variables", "(", "variables", ")", "\n", "zero_variables_op", "=", "_zero_variables", "(", "slot_variables", "+", "[", "loss_var", "]", ")", "\n", "collect_grads_op", "=", "_collect_gradients", "(", "gradients", ",", "slot_variables", ")", "\n", "collect_loss_op", "=", "tf", ".", "assign_add", "(", "loss_var", ",", "loss", ")", "\n", "collect_op", "=", "tf", ".", "group", "(", "collect_loss_op", ",", "collect_grads_op", ",", "\n", "name", "=", "\"collect_op\"", ")", "\n", "scale", "=", "1.0", "/", "params", ".", "update_cycle", "\n", "gradients", "=", "[", "scale", "*", "(", "g", "+", "s", ")", "\n", "for", "(", "g", ",", "s", ")", "in", "zip", "(", "gradients", ",", "slot_variables", ")", "]", "\n", "loss", "=", "scale", "*", "(", "loss", "+", "loss_var", ")", "\n", "\n", "", "global_norm", "=", "tf", ".", "global_norm", "(", "gradients", ")", "\n", "tf", ".", "summary", ".", "scalar", "(", "\"global_norm/gradient_norm\"", ",", "global_norm", ")", "\n", "\n", "for", "gradient", ",", "variable", "in", "zip", "(", "gradients", ",", "variables", ")", ":", "\n", "            ", "if", "isinstance", "(", "gradient", ",", "tf", ".", "IndexedSlices", ")", ":", "\n", "                ", "grad_values", "=", "gradient", ".", "values", "\n", "", "else", ":", "\n", "                ", "grad_values", "=", "gradient", "\n", "\n", "", "if", "grad_values", "is", "not", "None", ":", "\n", "                ", "var_name", "=", "variable", ".", "name", ".", "replace", "(", "\":\"", ",", "\"_\"", ")", "\n", "tf", ".", "summary", ".", "histogram", "(", "\"gradients/%s\"", "%", "var_name", ",", "grad_values", ")", "\n", "tf", ".", "summary", ".", "scalar", "(", "\"gradient_norm/%s\"", "%", "var_name", ",", "\n", "tf", ".", "global_norm", "(", "[", "grad_values", "]", ")", ")", "\n", "\n", "# Gradient clipping", "\n", "", "", "if", "isinstance", "(", "params", ".", "clip_grad_norm", "or", "None", ",", "float", ")", ":", "\n", "            ", "gradients", ",", "_", "=", "tf", ".", "clip_by_global_norm", "(", "gradients", ",", "\n", "params", ".", "clip_grad_norm", ",", "\n", "use_norm", "=", "global_norm", ")", "\n", "\n", "# Update variables", "\n", "", "grads_and_vars", "=", "list", "(", "zip", "(", "gradients", ",", "tf", ".", "trainable_variables", "(", ")", ")", ")", "\n", "train_op", "=", "optimizer", ".", "apply_gradients", "(", "grads_and_vars", ",", "global_step", ")", "\n", "\n", "ops", "=", "{", "\n", "\"zero_op\"", ":", "zero_variables_op", ",", "\n", "\"collect_op\"", ":", "collect_op", ",", "\n", "\"train_op\"", ":", "train_op", "\n", "}", "\n", "\n", "# Add summaries", "\n", "", "tf", ".", "summary", ".", "scalar", "(", "params", ".", "model", "+", "\"/loss\"", ",", "loss", ")", "\n", "\n", "return", "loss", ",", "ops", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.sampling._get_inference_fn": [[21, 50], ["zip", "tensorflow.pad", "tensorflow.fill", "tensorflow.add_n", "float", "model_fn", "outputs.append", "next_state.append", "model_fn", "outputs.append", "next_state.append", "len", "tensorflow.shape", "tensorflow.shape"], "function", ["None"], ["", "def", "_get_inference_fn", "(", "model_fns", ",", "features", ")", ":", "\n", "    ", "def", "inference_fn", "(", "inputs", ",", "state", ")", ":", "\n", "        ", "local_features", "=", "{", "\n", "\"source\"", ":", "features", "[", "\"source\"", "]", ",", "\n", "\"source_length\"", ":", "features", "[", "\"source_length\"", "]", ",", "\n", "# [bos_id, ...] => [..., 0]", "\n", "\"target\"", ":", "tf", ".", "pad", "(", "inputs", "[", ":", ",", "1", ":", "]", ",", "[", "[", "0", ",", "0", "]", ",", "[", "0", ",", "1", "]", "]", ")", ",", "\n", "\"target_length\"", ":", "tf", ".", "fill", "(", "[", "tf", ".", "shape", "(", "inputs", ")", "[", "0", "]", "]", ",", "\n", "tf", ".", "shape", "(", "inputs", ")", "[", "1", "]", ")", "\n", "}", "\n", "\n", "outputs", "=", "[", "]", "\n", "next_state", "=", "[", "]", "\n", "\n", "for", "(", "model_fn", ",", "model_state", ")", "in", "zip", "(", "model_fns", ",", "state", ")", ":", "\n", "            ", "if", "model_state", ":", "\n", "                ", "output", ",", "new_state", "=", "model_fn", "(", "local_features", ",", "model_state", ")", "\n", "outputs", ".", "append", "(", "output", ")", "\n", "next_state", ".", "append", "(", "new_state", ")", "\n", "", "else", ":", "\n", "                ", "output", "=", "model_fn", "(", "local_features", ")", "\n", "outputs", ".", "append", "(", "output", ")", "\n", "next_state", ".", "append", "(", "{", "}", ")", "\n", "\n", "# Ensemble", "\n", "", "", "log_prob", "=", "tf", ".", "add_n", "(", "outputs", ")", "/", "float", "(", "len", "(", "outputs", ")", ")", "\n", "return", "log_prob", ",", "next_state", "\n", "\n", "", "return", "inference_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.sampling._sampling_step": [[52, 102], ["func", "tensorflow.one_hot", "tensorflow.tile", "tensorflow.where", "tensorflow.multinomial", "tensorflow.squeeze", "tensorflow.squeeze", "tensorflow.logical_or", "tensorflow.where", "tensorflow.where", "tensorflow.where", "tensorflow.squeeze", "tensorflow.fill", "tensorflow.logical_and", "tensorflow.logical_or", "tensorflow.where", "tensorflow.where", "tensorflow.expand_dims", "sampling.SamplerState", "tensorflow.shape", "tensorflow.reshape", "tensorflow.zeros_like", "thumt.gather_2d", "tensorflow.equal", "tensorflow.fill", "tensorflow.zeros", "tensorflow.ones", "tensorflow.zeros", "thumt.gather_2d", "tensorflow.logical_not", "tensorflow.shape", "tensorflow.fill", "tensorflow.concat", "tensorflow.concat"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.gather_2d"], ["", "def", "_sampling_step", "(", "time", ",", "func", ",", "state", ",", "min_length", ",", "max_length", ",", "pad_id", ",", "eos_id", ")", ":", "\n", "# Compute log probabilities", "\n", "    ", "seqs", "=", "state", ".", "inputs", "\n", "seq_probs", "=", "state", ".", "seq_probs", "\n", "# [batch_size * num_samples, vocab_size]", "\n", "step_log_probs", ",", "next_state", "=", "func", "(", "seqs", ",", "state", ".", "state", ")", "\n", "\n", "# Suppress <eos> if needed", "\n", "batch_size", "=", "tf", ".", "shape", "(", "step_log_probs", ")", "[", "0", "]", "\n", "vocab_size", "=", "step_log_probs", ".", "shape", "[", "-", "1", "]", ".", "value", "or", "tf", ".", "shape", "(", "step_log_probs", ")", "[", "1", "]", "\n", "add_mask", "=", "tf", ".", "one_hot", "(", "eos_id", ",", "vocab_size", ",", "dtype", "=", "step_log_probs", ".", "dtype", ",", "\n", "on_value", "=", "step_log_probs", ".", "dtype", ".", "min", ",", "\n", "off_value", "=", "0.0", ")", "\n", "add_mask", "=", "tf", ".", "tile", "(", "tf", ".", "reshape", "(", "add_mask", ",", "[", "1", ",", "-", "1", "]", ")", ",", "[", "batch_size", ",", "1", "]", ")", "\n", "add_mask", "=", "tf", ".", "where", "(", "time", "<", "min_length", ",", "add_mask", ",", "tf", ".", "zeros_like", "(", "add_mask", ")", ")", "\n", "step_log_probs", "=", "step_log_probs", "+", "add_mask", "\n", "\n", "# sample from distribution", "\n", "symbol_indices", "=", "tf", ".", "multinomial", "(", "step_log_probs", ",", "1", ",", "output_dtype", "=", "tf", ".", "int32", ")", "\n", "symbol_scores", "=", "tf", ".", "squeeze", "(", "utils", ".", "gather_2d", "(", "step_log_probs", ",", "symbol_indices", ")", ")", "\n", "curr_flags", "=", "tf", ".", "squeeze", "(", "tf", ".", "equal", "(", "symbol_indices", ",", "eos_id", ")", ",", "axis", "=", "1", ")", "\n", "curr_flags", "=", "tf", ".", "logical_or", "(", "state", ".", "flags", ",", "curr_flags", ")", "\n", "\n", "# Append <pad> to finished samples", "\n", "symbol_indices", "=", "tf", ".", "where", "(", "state", ".", "flags", ",", "tf", ".", "fill", "(", "[", "batch_size", ",", "1", "]", ",", "pad_id", ")", ",", "\n", "symbol_indices", ")", "\n", "symbol_scores", "=", "tf", ".", "where", "(", "state", ".", "flags", ",", "tf", ".", "zeros", "(", "[", "batch_size", "]", ")", ",", "\n", "symbol_scores", ")", "\n", "\n", "# Force sampler to generate <eos> if length exceed max_length", "\n", "eos_flags", "=", "tf", ".", "where", "(", "time", ">", "max_length", ",", "tf", ".", "ones", "(", "[", "batch_size", "]", ",", "tf", ".", "bool", ")", ",", "\n", "tf", ".", "zeros", "(", "[", "batch_size", "]", ",", "tf", ".", "bool", ")", ")", "\n", "eos_scores", "=", "tf", ".", "squeeze", "(", "utils", ".", "gather_2d", "(", "step_log_probs", ",", "\n", "tf", ".", "fill", "(", "[", "batch_size", ",", "1", "]", ",", "eos_id", ")", ")", ")", "\n", "eos_indices", "=", "tf", ".", "fill", "(", "[", "batch_size", ",", "1", "]", ",", "eos_id", ")", "\n", "cond", "=", "tf", ".", "logical_and", "(", "tf", ".", "logical_not", "(", "curr_flags", ")", ",", "eos_flags", ")", "\n", "curr_flags", "=", "tf", ".", "logical_or", "(", "curr_flags", ",", "eos_flags", ")", "\n", "symbol_indices", "=", "tf", ".", "where", "(", "cond", ",", "eos_indices", ",", "symbol_indices", ")", "\n", "symbol_scores", "=", "tf", ".", "where", "(", "cond", ",", "eos_scores", ",", "symbol_scores", ")", "\n", "step_symbol_scores", "=", "tf", ".", "expand_dims", "(", "symbol_scores", ",", "-", "1", ")", "\n", "\n", "new_state", "=", "SamplerState", "(", "\n", "inputs", "=", "tf", ".", "concat", "(", "[", "seqs", ",", "symbol_indices", "]", ",", "axis", "=", "1", ")", ",", "\n", "state", "=", "next_state", ",", "\n", "scores", "=", "state", ".", "scores", "+", "symbol_scores", ",", "\n", "flags", "=", "curr_flags", ",", "\n", "seq_probs", "=", "tf", ".", "concat", "(", "[", "seq_probs", ",", "step_symbol_scores", "]", ",", "axis", "=", "1", ")", "\n", ")", "\n", "\n", "return", "time", "+", "1", ",", "new_state", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.sampling.random_sample": [[104, 153], ["tensorflow.fill", "tensorflow.fill", "tensorflow.zeros", "tensorflow.zeros", "sampling.SamplerState", "tensorflow.reduce_max", "tensorflow.constant", "sampling.SamplerState", "tensorflow.while_loop", "tensorflow.reduce_all", "tensorflow.logical_and", "sampling._sampling_step", "tensorflow.less", "tensorflow.logical_not", "tensorflow.TensorShape", "tensorflow.python.util.nest.map_structure", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.TensorShape", "tensorflow.TensorShape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.sampling._sampling_step"], ["", "def", "random_sample", "(", "func", ",", "state", ",", "batch_size", ",", "min_length", ",", "max_length", ",", "pad_id", ",", "\n", "bos_id", ",", "eos_id", ")", ":", "\n", "    ", "init_seqs", "=", "tf", ".", "fill", "(", "[", "batch_size", ",", "1", "]", ",", "bos_id", ")", "\n", "init_seq_probs", "=", "tf", ".", "fill", "(", "[", "batch_size", ",", "1", "]", ",", "0.0", ")", "\n", "init_scores", "=", "tf", ".", "zeros", "(", "[", "batch_size", "]", ")", "\n", "init_flags", "=", "tf", ".", "zeros", "(", "[", "batch_size", "]", ",", "tf", ".", "bool", ")", "\n", "\n", "state", "=", "SamplerState", "(", "\n", "inputs", "=", "init_seqs", ",", "\n", "state", "=", "state", ",", "\n", "scores", "=", "init_scores", ",", "\n", "flags", "=", "init_flags", ",", "\n", "seq_probs", "=", "init_seq_probs", "\n", ")", "\n", "\n", "max_step", "=", "tf", ".", "reduce_max", "(", "max_length", ")", "\n", "\n", "def", "_is_finished", "(", "t", ",", "s", ")", ":", "\n", "        ", "all_finished", "=", "tf", ".", "reduce_all", "(", "s", ".", "flags", ")", "\n", "cond", "=", "tf", ".", "logical_and", "(", "tf", ".", "less", "(", "t", ",", "max_step", ")", ",", "\n", "tf", ".", "logical_not", "(", "all_finished", ")", ")", "\n", "\n", "return", "cond", "\n", "\n", "", "def", "_loop_fn", "(", "t", ",", "s", ")", ":", "\n", "        ", "outs", "=", "_sampling_step", "(", "t", ",", "func", ",", "s", ",", "min_length", ",", "max_length", ",", "pad_id", ",", "\n", "eos_id", ")", "\n", "return", "outs", "\n", "\n", "", "time", "=", "tf", ".", "constant", "(", "0", ",", "name", "=", "\"time\"", ")", "\n", "shape_invariants", "=", "SamplerState", "(", "\n", "inputs", "=", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", "]", ")", ",", "\n", "state", "=", "nest", ".", "map_structure", "(", "utils", ".", "infer_shape_invariants", ",", "state", ".", "state", ")", ",", "\n", "scores", "=", "tf", ".", "TensorShape", "(", "[", "None", "]", ")", ",", "\n", "flags", "=", "tf", ".", "TensorShape", "(", "[", "None", "]", ")", ",", "\n", "seq_probs", "=", "tf", ".", "TensorShape", "(", "[", "None", ",", "None", "]", ")", "\n", ")", "\n", "outputs", "=", "tf", ".", "while_loop", "(", "_is_finished", ",", "_loop_fn", ",", "[", "time", ",", "state", "]", ",", "\n", "shape_invariants", "=", "[", "tf", ".", "TensorShape", "(", "[", "]", ")", ",", "\n", "shape_invariants", "]", ",", "\n", "parallel_iterations", "=", "1", ",", "\n", "back_prop", "=", "False", ")", "\n", "\n", "final_state", "=", "outputs", "[", "1", "]", "\n", "final_seqs", "=", "final_state", ".", "inputs", "\n", "final_scores", "=", "final_state", ".", "scores", "\n", "final_word_scores", "=", "final_state", ".", "seq_probs", "\n", "\n", "return", "final_seqs", ",", "final_scores", ",", "final_word_scores", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.sampling.create_sampling_graph": [[155, 220], ["copy.copy", "tensorflow.tile", "tensorflow.tile", "tensorflow.to_float", "tensorflow.to_float", "tensorflow.to_int32", "tensorflow.to_int32", "sampling._get_inference_fn", "tensorflow.python.util.nest.map_structure", "sampling.random_sample", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.reshape", "isinstance", "ValueError", "model.get_inference_func", "callable", "tensorflow.shape", "nest.map_structure.append", "funcs.append", "nest.map_structure.append", "funcs.append", "thumt.tile_batch"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.sampling._get_inference_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.sampling.random_sample", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_inference_func", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.tile_batch"], ["", "def", "create_sampling_graph", "(", "models", ",", "features", ",", "params", ")", ":", "\n", "    ", "if", "not", "isinstance", "(", "models", ",", "(", "list", ",", "tuple", ")", ")", ":", "\n", "        ", "raise", "ValueError", "(", "\"'models' must be a list or tuple\"", ")", "\n", "\n", "", "features", "=", "copy", ".", "copy", "(", "features", ")", "\n", "model_fns", "=", "[", "model", ".", "get_inference_func", "(", ")", "for", "model", "in", "models", "]", "\n", "\n", "num_samples", "=", "params", ".", "num_samples", "\n", "\n", "# Compute initial state if necessary", "\n", "states", "=", "[", "]", "\n", "funcs", "=", "[", "]", "\n", "\n", "for", "model_fn", "in", "model_fns", ":", "\n", "        ", "if", "callable", "(", "model_fn", ")", ":", "\n", "# For non-incremental decoding", "\n", "            ", "states", ".", "append", "(", "{", "}", ")", "\n", "funcs", ".", "append", "(", "model_fn", ")", "\n", "", "else", ":", "\n", "# For incremental decoding where model_fn is a tuple:", "\n", "# (encoding_fn, decoding_fn)", "\n", "            ", "states", ".", "append", "(", "model_fn", "[", "0", "]", "(", "features", ")", ")", "\n", "funcs", ".", "append", "(", "model_fn", "[", "1", "]", ")", "\n", "\n", "", "", "batch_size", "=", "tf", ".", "shape", "(", "features", "[", "\"source\"", "]", ")", "[", "0", "]", "\n", "pad_id", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "pad", "]", "\n", "bos_id", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "bos", "]", "\n", "eos_id", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "eos", "]", "\n", "\n", "# Expand the inputs", "\n", "features", "[", "\"source\"", "]", "=", "tf", ".", "tile", "(", "features", "[", "\"source\"", "]", ",", "[", "num_samples", ",", "1", "]", ")", "\n", "features", "[", "\"source_length\"", "]", "=", "tf", ".", "tile", "(", "features", "[", "\"source_length\"", "]", ",", "\n", "[", "num_samples", "]", ")", "\n", "\n", "min_length", "=", "tf", ".", "to_float", "(", "features", "[", "\"source_length\"", "]", ")", "\n", "max_length", "=", "tf", ".", "to_float", "(", "features", "[", "\"source_length\"", "]", ")", "\n", "\n", "if", "params", ".", "min_length_ratio", ":", "\n", "        ", "min_length", "=", "min_length", "*", "params", ".", "min_length_ratio", "\n", "\n", "", "if", "params", ".", "max_length_ratio", ":", "\n", "        ", "max_length", "=", "max_length", "*", "params", ".", "max_length_ratio", "\n", "\n", "", "if", "params", ".", "min_sample_length", ":", "\n", "        ", "min_length", "=", "min_length", "-", "params", ".", "min_sample_length", "\n", "\n", "", "if", "params", ".", "max_sample_length", ":", "\n", "        ", "max_length", "=", "max_length", "+", "params", ".", "max_sample_length", "\n", "\n", "", "min_length", "=", "tf", ".", "to_int32", "(", "min_length", ")", "\n", "max_length", "=", "tf", ".", "to_int32", "(", "max_length", ")", "\n", "\n", "decoding_fn", "=", "_get_inference_fn", "(", "funcs", ",", "features", ")", "\n", "states", "=", "nest", ".", "map_structure", "(", "lambda", "x", ":", "utils", ".", "tile_batch", "(", "x", ",", "num_samples", ")", ",", "\n", "states", ")", "\n", "\n", "seqs", ",", "scores", ",", "word_scores", "=", "random_sample", "(", "decoding_fn", ",", "states", ",", "batch_size", "*", "num_samples", ",", "\n", "min_length", ",", "max_length", ",", "pad_id", ",", "bos_id", ",", "\n", "eos_id", ")", "\n", "\n", "seqs", "=", "tf", ".", "reshape", "(", "seqs", ",", "[", "batch_size", ",", "num_samples", ",", "-", "1", "]", ")", "\n", "scores", "=", "tf", ".", "reshape", "(", "scores", ",", "[", "batch_size", ",", "num_samples", "]", ")", "\n", "word_scores", "=", "tf", ".", "reshape", "(", "word_scores", ",", "[", "batch_size", ",", "num_samples", ",", "-", "1", "]", ")", "\n", "\n", "return", "seqs", "[", ":", ",", ":", ",", "1", ":", "]", ",", "scores", ",", "word_scores", "[", ":", ",", ":", ",", "1", ":", "]", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.to_text": [[24, 33], ["decoded.append"], "function", ["None"], ["def", "to_text", "(", "vocab", ",", "mapping", ",", "indice", ",", "params", ")", ":", "\n", "    ", "decoded", "=", "[", "]", "\n", "for", "idx", "in", "indice", ":", "\n", "        ", "if", "idx", "==", "mapping", "[", "params", ".", "eos", "]", ":", "\n", "            ", "break", "\n", "", "decoded", ".", "append", "(", "vocab", "[", "idx", "]", ")", "\n", "\n", "", "decoded", "=", "\" \"", ".", "join", "(", "decoded", ")", "\n", "return", "decoded", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.parse_args": [[34, 59], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args"], ["", "def", "parse_args", "(", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", "\n", "description", "=", "\"Translate using existing NMT models\"", ",", "\n", "usage", "=", "\"translator.py [<args>] [-h | --help]\"", "\n", ")", "\n", "\n", "# input files", "\n", "parser", ".", "add_argument", "(", "\"--input\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of input file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--output\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of output file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--relevances\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of relevance result\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--checkpoints\"", ",", "type", "=", "str", ",", "nargs", "=", "\"+\"", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of trained models\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--vocabulary\"", ",", "type", "=", "str", ",", "nargs", "=", "2", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of source and target vocabulary\"", ")", "\n", "\n", "# model and configuration", "\n", "parser", ".", "add_argument", "(", "\"--models\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "nargs", "=", "\"+\"", ",", "\n", "help", "=", "\"Name of the model\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--parameters\"", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Additional hyper parameters\"", ")", "\n", "\n", "return", "parser", ".", "parse_args", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.default_parameters": [[61, 88], ["tensorflow.contrib.training.HParams"], "function", ["None"], ["", "def", "default_parameters", "(", ")", ":", "\n", "    ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", "\n", "input", "=", "None", ",", "\n", "output", "=", "None", ",", "\n", "vocabulary", "=", "None", ",", "\n", "model", "=", "None", ",", "\n", "# vocabulary specific", "\n", "pad", "=", "\"<pad>\"", ",", "\n", "bos", "=", "\"<bos>\"", ",", "\n", "eos", "=", "\"<eos>\"", ",", "\n", "unk", "=", "\"<unk>\"", ",", "\n", "mapping", "=", "None", ",", "\n", "append_eos", "=", "False", ",", "\n", "# decoding", "\n", "top_beams", "=", "1", ",", "\n", "beam_size", "=", "4", ",", "\n", "decode_alpha", "=", "0.6", ",", "\n", "decode_beta", "=", "0.2", ",", "\n", "decode_length", "=", "50", ",", "\n", "decode_batch_size", "=", "1", ",", "\n", "decode_constant", "=", "5.0", ",", "\n", "decode_normalize", "=", "False", ",", "\n", "device_list", "=", "[", "0", "]", ",", "\n", "num_threads", "=", "6", "\n", ")", "\n", "\n", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.merge_parameters": [[90, 106], ["tensorflow.contrib.training.HParams", "params1.values().iteritems", "tf.contrib.training.HParams.values", "params2.values().iteritems", "tf.contrib.training.HParams.add_hparam", "params1.values", "params2.values", "setattr", "tf.contrib.training.HParams.add_hparam"], "function", ["None"], ["", "def", "merge_parameters", "(", "params1", ",", "params2", ")", ":", "\n", "    ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", ")", "\n", "\n", "for", "(", "k", ",", "v", ")", "in", "params1", ".", "values", "(", ")", ".", "iteritems", "(", ")", ":", "\n", "        ", "params", ".", "add_hparam", "(", "k", ",", "v", ")", "\n", "\n", "", "params_dict", "=", "params", ".", "values", "(", ")", "\n", "\n", "for", "(", "k", ",", "v", ")", "in", "params2", ".", "values", "(", ")", ".", "iteritems", "(", ")", ":", "\n", "        ", "if", "k", "in", "params_dict", ":", "\n", "# Override", "\n", "            ", "setattr", "(", "params", ",", "k", ",", "v", ")", "\n", "", "else", ":", "\n", "            ", "params", ".", "add_hparam", "(", "k", ",", "v", ")", "\n", "\n", "", "", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.import_params": [[108, 121], ["os.path.abspath", "os.path.join", "tensorflow.gfile.Exists", "tensorflow.gfile.Open", "tensorflow.logging.info", "fd.readline", "params.parse_json"], "function", ["None"], ["", "def", "import_params", "(", "model_dir", ",", "model_name", ",", "params", ")", ":", "\n", "    ", "model_dir", "=", "os", ".", "path", ".", "abspath", "(", "model_dir", ")", "\n", "m_name", "=", "os", ".", "path", ".", "join", "(", "model_dir", ",", "model_name", "+", "\".json\"", ")", "\n", "\n", "if", "not", "tf", ".", "gfile", ".", "Exists", "(", "m_name", ")", ":", "\n", "        ", "return", "params", "\n", "\n", "", "with", "tf", ".", "gfile", ".", "Open", "(", "m_name", ")", "as", "fd", ":", "\n", "        ", "tf", ".", "logging", ".", "info", "(", "\"Restoring model parameters from %s\"", "%", "m_name", ")", "\n", "json_str", "=", "fd", ".", "readline", "(", ")", "\n", "params", ".", "parse_json", "(", "json_str", ")", "\n", "\n", "", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.override_parameters": [[123, 152], ["thumt.process_vocabulary", "thumt.process_vocabulary", "params.parse", "thumt.load_vocabulary", "thumt.load_vocabulary", "thumt.get_control_mapping", "thumt.get_control_mapping"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.process_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.process_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.load_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.load_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.get_control_mapping", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.get_control_mapping"], ["", "def", "override_parameters", "(", "params", ",", "args", ")", ":", "\n", "    ", "if", "args", ".", "parameters", ":", "\n", "        ", "params", ".", "parse", "(", "args", ".", "parameters", ")", "\n", "\n", "", "params", ".", "vocabulary", "=", "{", "\n", "\"source\"", ":", "vocabulary", ".", "load_vocabulary", "(", "args", ".", "vocabulary", "[", "0", "]", ")", ",", "\n", "\"target\"", ":", "vocabulary", ".", "load_vocabulary", "(", "args", ".", "vocabulary", "[", "1", "]", ")", "\n", "}", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", "=", "vocabulary", ".", "process_vocabulary", "(", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", ",", "params", "\n", ")", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", "=", "vocabulary", ".", "process_vocabulary", "(", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", ",", "params", "\n", ")", "\n", "\n", "control_symbols", "=", "[", "params", ".", "pad", ",", "params", ".", "bos", ",", "params", ".", "eos", ",", "params", ".", "unk", "]", "\n", "\n", "params", ".", "mapping", "=", "{", "\n", "\"source\"", ":", "vocabulary", ".", "get_control_mapping", "(", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", ",", "\n", "control_symbols", "\n", ")", ",", "\n", "\"target\"", ":", "vocabulary", ".", "get_control_mapping", "(", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", ",", "\n", "control_symbols", "\n", ")", "\n", "}", "\n", "\n", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.session_config": [[154, 167], ["tensorflow.OptimizerOptions", "tensorflow.GraphOptions", "tensorflow.ConfigProto", "str"], "function", ["None"], ["", "def", "session_config", "(", "params", ")", ":", "\n", "    ", "optimizer_options", "=", "tf", ".", "OptimizerOptions", "(", "opt_level", "=", "tf", ".", "OptimizerOptions", ".", "L1", ",", "\n", "do_function_inlining", "=", "False", ")", "\n", "graph_options", "=", "tf", ".", "GraphOptions", "(", "optimizer_options", "=", "optimizer_options", ")", "\n", "config", "=", "tf", ".", "ConfigProto", "(", "allow_soft_placement", "=", "True", ",", "\n", "graph_options", "=", "graph_options", ",", "\n", "intra_op_parallelism_threads", "=", "16", ",", "\n", "inter_op_parallelism_threads", "=", "16", ")", "\n", "if", "params", ".", "device_list", ":", "\n", "        ", "device_str", "=", "\",\"", ".", "join", "(", "[", "str", "(", "i", ")", "for", "i", "in", "params", ".", "device_list", "]", ")", "\n", "config", ".", "gpu_options", ".", "visible_device_list", "=", "device_str", "\n", "\n", "", "return", "config", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.set_variables": [[169, 183], ["tensorflow.logging.info", "list", "tensorflow.device", "tensorflow.assign", "ops.append", "name.split"], "function", ["None"], ["", "def", "set_variables", "(", "var_list", ",", "value_dict", ",", "prefix", ")", ":", "\n", "    ", "ops", "=", "[", "]", "\n", "for", "var", "in", "var_list", ":", "\n", "        ", "for", "name", "in", "value_dict", ":", "\n", "            ", "var_name", "=", "\"/\"", ".", "join", "(", "[", "prefix", "]", "+", "list", "(", "name", ".", "split", "(", "\"/\"", ")", "[", "1", ":", "]", ")", ")", "\n", "\n", "if", "var", ".", "name", "[", ":", "-", "2", "]", "==", "var_name", ":", "\n", "                ", "tf", ".", "logging", ".", "info", "(", "\"restoring %s -> %s\"", "%", "(", "name", ",", "var", ".", "name", ")", ")", "\n", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "                    ", "op", "=", "tf", ".", "assign", "(", "var", ",", "value_dict", "[", "name", "]", ")", "\n", "ops", ".", "append", "(", "op", ")", "\n", "", "break", "\n", "\n", "", "", "", "return", "ops", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.main": [[185, 293], ["tensorflow.logging.set_verbosity", "thumt.get_model", "get_relevance.default_parameters", "get_relevance.merge_parameters", "get_relevance.import_params", "get_relevance.override_parameters", "tensorflow.Graph().as_default", "enumerate", "range", "thumt.get_relevance_input", "tensorflow.trainable_variables", "range", "tensorflow.group", "params.add_hparam", "params.add_hparam", "tensorflow.train.ChiefSessionCreator", "range", "model_cls.get_parameters", "zip", "range", "range", "print", "tensorflow.train.list_variables", "tensorflow.train.load_checkpoint", "model_var_lists.append", "len", "model_cls_list[].get_name", "model.get_relevance_func", "model_fns.append", "tensorflow.gfile.Open", "tensorflow.gfile.Open", "len", "model_cls_list[].get_name", "get_relevance.set_variables", "assign_ops.extend", "tensorflow.train.MonitoredSession", "sess.run", "len", "len", "len", "tensorflow.Graph", "tf.train.load_checkpoint.get_tensor", "line.strip", "line.strip", "v.name.startswith", "get_relevance.session_config", "os.path.exists", "os.makedirs", "sess.should_stop", "sess.run", "range", "tensorflow.logging.log", "model_cls_list[].get_name.startswith", "model_cls_list[].get_name.find", "un_init_var_list.append", "get_relevance.to_text", "get_relevance.to_text", "open", "open.write", "open.write", "open.write", "model_cls_list[].get_name", "str", "str"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.__init__.get_model", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.default_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.merge_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.import_params", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.override_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.get_relevance_input", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_name", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_relevance_func", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_name", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.set_variables", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.session_config", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.to_text", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.get_relevance.to_text", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_name"], ["", "def", "main", "(", "args", ")", ":", "\n", "    ", "tf", ".", "logging", ".", "set_verbosity", "(", "tf", ".", "logging", ".", "INFO", ")", "\n", "# Load configs", "\n", "model_cls_list", "=", "[", "models", ".", "get_model", "(", "model", ",", "lrp", "=", "True", ")", "\n", "for", "model", "in", "args", ".", "models", "]", "\n", "params_list", "=", "[", "default_parameters", "(", ")", "for", "_", "in", "range", "(", "len", "(", "model_cls_list", ")", ")", "]", "\n", "params_list", "=", "[", "\n", "merge_parameters", "(", "params", ",", "model_cls", ".", "get_parameters", "(", ")", ")", "\n", "for", "params", ",", "model_cls", "in", "zip", "(", "params_list", ",", "model_cls_list", ")", "\n", "]", "\n", "params_list", "=", "[", "\n", "import_params", "(", "args", ".", "checkpoints", "[", "i", "]", ",", "args", ".", "models", "[", "i", "]", ",", "params_list", "[", "i", "]", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "args", ".", "checkpoints", ")", ")", "\n", "]", "\n", "params_list", "=", "[", "\n", "override_parameters", "(", "params_list", "[", "i", "]", ",", "args", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "model_cls_list", ")", ")", "\n", "]", "\n", "\n", "# Build Graph", "\n", "with", "tf", ".", "Graph", "(", ")", ".", "as_default", "(", ")", ":", "\n", "        ", "model_var_lists", "=", "[", "]", "\n", "\n", "# Load checkpoints", "\n", "for", "i", ",", "checkpoint", "in", "enumerate", "(", "args", ".", "checkpoints", ")", ":", "\n", "            ", "print", "(", "\"Loading %s\"", "%", "checkpoint", ")", "\n", "var_list", "=", "tf", ".", "train", ".", "list_variables", "(", "checkpoint", ")", "\n", "values", "=", "{", "}", "\n", "reader", "=", "tf", ".", "train", ".", "load_checkpoint", "(", "checkpoint", ")", "\n", "\n", "for", "(", "name", ",", "shape", ")", "in", "var_list", ":", "\n", "                ", "if", "not", "name", ".", "startswith", "(", "model_cls_list", "[", "i", "]", ".", "get_name", "(", ")", ")", ":", "\n", "                    ", "continue", "\n", "\n", "", "if", "name", ".", "find", "(", "\"losses_avg\"", ")", ">=", "0", ":", "\n", "                    ", "continue", "\n", "\n", "", "tensor", "=", "reader", ".", "get_tensor", "(", "name", ")", "\n", "values", "[", "name", "]", "=", "tensor", "\n", "\n", "", "model_var_lists", ".", "append", "(", "values", ")", "\n", "\n", "# Build models", "\n", "", "model_fns", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "len", "(", "args", ".", "checkpoints", ")", ")", ":", "\n", "            ", "name", "=", "model_cls_list", "[", "i", "]", ".", "get_name", "(", ")", "\n", "model", "=", "model_cls_list", "[", "i", "]", "(", "params_list", "[", "i", "]", ",", "name", "+", "\"_%d\"", "%", "i", ")", "\n", "model_fn", "=", "model", ".", "get_relevance_func", "(", ")", "\n", "model_fns", ".", "append", "(", "model_fn", ")", "\n", "\n", "", "params", "=", "params_list", "[", "0", "]", "\n", "# Read input file", "\n", "with", "tf", ".", "gfile", ".", "Open", "(", "args", ".", "input", ")", "as", "fd", ":", "\n", "            ", "inputs", "=", "[", "line", ".", "strip", "(", ")", "for", "line", "in", "fd", "]", "\n", "", "with", "tf", ".", "gfile", ".", "Open", "(", "args", ".", "output", ")", "as", "fd", ":", "\n", "            ", "outputs", "=", "[", "line", ".", "strip", "(", ")", "for", "line", "in", "fd", "]", "\n", "# Build input queue", "\n", "", "features", "=", "dataset", ".", "get_relevance_input", "(", "inputs", ",", "outputs", ",", "params", ")", "\n", "relevances", "=", "model_fns", "[", "0", "]", "(", "features", ",", "params", ")", "\n", "\n", "assign_ops", "=", "[", "]", "\n", "\n", "all_var_list", "=", "tf", ".", "trainable_variables", "(", ")", "\n", "\n", "for", "i", "in", "range", "(", "len", "(", "args", ".", "checkpoints", ")", ")", ":", "\n", "            ", "un_init_var_list", "=", "[", "]", "\n", "name", "=", "model_cls_list", "[", "i", "]", ".", "get_name", "(", ")", "\n", "\n", "for", "v", "in", "all_var_list", ":", "\n", "                ", "if", "v", ".", "name", ".", "startswith", "(", "name", "+", "\"_%d\"", "%", "i", ")", ":", "\n", "                    ", "un_init_var_list", ".", "append", "(", "v", ")", "\n", "\n", "", "", "ops", "=", "set_variables", "(", "un_init_var_list", ",", "model_var_lists", "[", "i", "]", ",", "\n", "name", "+", "\"_%d\"", "%", "i", ")", "\n", "assign_ops", ".", "extend", "(", "ops", ")", "\n", "\n", "", "assign_op", "=", "tf", ".", "group", "(", "*", "assign_ops", ")", "\n", "\n", "params", ".", "add_hparam", "(", "'intra_op_parallelism_threads'", ",", "1", ")", "\n", "params", ".", "add_hparam", "(", "'inter_op_parallelism_threads'", ",", "1", ")", "\n", "sess_creator", "=", "tf", ".", "train", ".", "ChiefSessionCreator", "(", "\n", "config", "=", "session_config", "(", "params", ")", "\n", ")", "\n", "\n", "results", "=", "[", "]", "\n", "\n", "# Create session", "\n", "with", "tf", ".", "train", ".", "MonitoredSession", "(", "session_creator", "=", "sess_creator", ")", "as", "sess", ":", "\n", "# Restore variables", "\n", "            ", "sess", ".", "run", "(", "assign_op", ")", "\n", "if", "not", "os", ".", "path", ".", "exists", "(", "args", ".", "relevances", ")", ":", "\n", "                ", "os", ".", "makedirs", "(", "args", ".", "relevances", ")", "\n", "", "count", "=", "0", "\n", "while", "not", "sess", ".", "should_stop", "(", ")", ":", "\n", "                ", "src_seq", ",", "trg_seq", ",", "rlv_info", ",", "loss", "=", "sess", ".", "run", "(", "relevances", ")", "\n", "message", "=", "\"Finished batch\"", "\" %d\"", "%", "count", "\n", "for", "i", "in", "range", "(", "src_seq", ".", "shape", "[", "0", "]", ")", ":", "\n", "                    ", "count", "+=", "1", "\n", "src", "=", "to_text", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ",", "\n", "params", ".", "mapping", "[", "\"source\"", "]", ",", "src_seq", "[", "i", "]", ",", "params", ")", "\n", "trg", "=", "to_text", "(", "params", ".", "vocabulary", "[", "\"target\"", "]", ",", "\n", "params", ".", "mapping", "[", "\"target\"", "]", ",", "trg_seq", "[", "i", "]", ",", "params", ")", "\n", "output", "=", "open", "(", "args", ".", "relevances", "+", "'/'", "+", "str", "(", "count", ")", ",", "'w'", ")", "\n", "output", ".", "write", "(", "'src: '", "+", "src", "+", "'\\n'", ")", "\n", "output", ".", "write", "(", "'trg: '", "+", "trg", "+", "'\\n'", ")", "\n", "output", ".", "write", "(", "'result: '", "+", "str", "(", "rlv_info", "[", "\"result\"", "]", "[", "i", "]", ")", "+", "'\\n'", ")", "\n", "", "tf", ".", "logging", ".", "log", "(", "tf", ".", "logging", ".", "INFO", ",", "message", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.parse_args": [[24, 53], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args"], ["def", "parse_args", "(", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", "\n", "description", "=", "\"Translate using existing NMT models\"", ",", "\n", "usage", "=", "\"translator.py [<args>] [-h | --help]\"", "\n", ")", "\n", "\n", "# input files", "\n", "parser", ".", "add_argument", "(", "\"--input\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of input file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--output\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of output file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--checkpoints\"", ",", "type", "=", "str", ",", "nargs", "=", "\"+\"", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of trained models\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--vocabulary\"", ",", "type", "=", "str", ",", "nargs", "=", "2", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of source and target vocabulary\"", ")", "\n", "\n", "# model and configuration", "\n", "parser", ".", "add_argument", "(", "\"--models\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "nargs", "=", "\"+\"", ",", "\n", "help", "=", "\"Name of the model\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--parameters\"", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Additional hyper parameters\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--verbose\"", ",", "action", "=", "\"store_true\"", ",", "\n", "help", "=", "\"Enable verbose output\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--word_prob\"", ",", "action", "=", "\"store_true\"", ",", "\n", "help", "=", "\"Output the probability of each word\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--prob_files\"", ",", "type", "=", "str", ",", "required", "=", "False", ",", "nargs", "=", "\"+\"", ",", "\n", "help", "=", "\"Path of probability files\"", ")", "\n", "\n", "return", "parser", ".", "parse_args", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.default_parameters": [[55, 89], ["tensorflow.contrib.training.HParams"], "function", ["None"], ["", "def", "default_parameters", "(", ")", ":", "\n", "    ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", "\n", "input", "=", "None", ",", "\n", "output", "=", "None", ",", "\n", "vocabulary", "=", "None", ",", "\n", "# vocabulary specific", "\n", "pad", "=", "\"<pad>\"", ",", "\n", "bos", "=", "\"<bos>\"", ",", "\n", "eos", "=", "\"<eos>\"", ",", "\n", "unk", "=", "\"<unk>\"", ",", "\n", "mapping", "=", "None", ",", "\n", "append_eos", "=", "False", ",", "\n", "device_list", "=", "[", "0", "]", ",", "\n", "num_threads", "=", "1", ",", "\n", "# decoding", "\n", "top_beams", "=", "1", ",", "\n", "beam_size", "=", "4", ",", "\n", "decode_alpha", "=", "0.6", ",", "\n", "decode_length", "=", "50", ",", "\n", "decode_batch_size", "=", "32", ",", "\n", "# sampling", "\n", "generate_samples", "=", "False", ",", "\n", "num_samples", "=", "1", ",", "\n", "min_length_ratio", "=", "0.0", ",", "\n", "max_length_ratio", "=", "1.5", ",", "\n", "min_sample_length", "=", "0", ",", "\n", "max_sample_length", "=", "0", ",", "\n", "sample_batch_size", "=", "32", ",", "\n", "model_uncertainty", "=", "False", ",", "\n", "mu_sample_k", "=", "20", ",", "\n", "side", "=", "'none'", "\n", ")", "\n", "\n", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.merge_parameters": [[91, 107], ["tensorflow.contrib.training.HParams", "params1.values().iteritems", "tf.contrib.training.HParams.values", "params2.values().iteritems", "tf.contrib.training.HParams.add_hparam", "params1.values", "params2.values", "setattr", "tf.contrib.training.HParams.add_hparam"], "function", ["None"], ["", "def", "merge_parameters", "(", "params1", ",", "params2", ")", ":", "\n", "    ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", ")", "\n", "\n", "for", "(", "k", ",", "v", ")", "in", "params1", ".", "values", "(", ")", ".", "iteritems", "(", ")", ":", "\n", "        ", "params", ".", "add_hparam", "(", "k", ",", "v", ")", "\n", "\n", "", "params_dict", "=", "params", ".", "values", "(", ")", "\n", "\n", "for", "(", "k", ",", "v", ")", "in", "params2", ".", "values", "(", ")", ".", "iteritems", "(", ")", ":", "\n", "        ", "if", "k", "in", "params_dict", ":", "\n", "# Override", "\n", "            ", "setattr", "(", "params", ",", "k", ",", "v", ")", "\n", "", "else", ":", "\n", "            ", "params", ".", "add_hparam", "(", "k", ",", "v", ")", "\n", "\n", "", "", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.import_params": [[109, 125], ["model_name.startswith", "os.path.abspath", "os.path.join", "tensorflow.gfile.Exists", "tensorflow.gfile.Open", "tensorflow.logging.info", "fd.readline", "params.parse_json"], "function", ["None"], ["", "def", "import_params", "(", "model_dir", ",", "model_name", ",", "params", ")", ":", "\n", "    ", "if", "model_name", ".", "startswith", "(", "\"experimental_\"", ")", ":", "\n", "        ", "model_name", "=", "model_name", "[", "13", ":", "]", "\n", "\n", "", "model_dir", "=", "os", ".", "path", ".", "abspath", "(", "model_dir", ")", "\n", "m_name", "=", "os", ".", "path", ".", "join", "(", "model_dir", ",", "model_name", "+", "\".json\"", ")", "\n", "\n", "if", "not", "tf", ".", "gfile", ".", "Exists", "(", "m_name", ")", ":", "\n", "        ", "return", "params", "\n", "\n", "", "with", "tf", ".", "gfile", ".", "Open", "(", "m_name", ")", "as", "fd", ":", "\n", "        ", "tf", ".", "logging", ".", "info", "(", "\"Restoring model parameters from %s\"", "%", "m_name", ")", "\n", "json_str", "=", "fd", ".", "readline", "(", ")", "\n", "params", ".", "parse_json", "(", "json_str", ")", "\n", "\n", "", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.override_parameters": [[127, 156], ["thumt.process_vocabulary", "thumt.process_vocabulary", "params.parse", "thumt.load_vocabulary", "thumt.load_vocabulary", "thumt.get_control_mapping", "thumt.get_control_mapping"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.process_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.process_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.load_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.load_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.get_control_mapping", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.get_control_mapping"], ["", "def", "override_parameters", "(", "params", ",", "args", ")", ":", "\n", "    ", "if", "args", ".", "parameters", ":", "\n", "        ", "params", ".", "parse", "(", "args", ".", "parameters", ")", "\n", "\n", "", "params", ".", "vocabulary", "=", "{", "\n", "\"source\"", ":", "vocabulary", ".", "load_vocabulary", "(", "args", ".", "vocabulary", "[", "0", "]", ")", ",", "\n", "\"target\"", ":", "vocabulary", ".", "load_vocabulary", "(", "args", ".", "vocabulary", "[", "1", "]", ")", "\n", "}", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", "=", "vocabulary", ".", "process_vocabulary", "(", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", ",", "params", "\n", ")", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", "=", "vocabulary", ".", "process_vocabulary", "(", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", ",", "params", "\n", ")", "\n", "\n", "control_symbols", "=", "[", "params", ".", "pad", ",", "params", ".", "bos", ",", "params", ".", "eos", ",", "params", ".", "unk", "]", "\n", "\n", "params", ".", "mapping", "=", "{", "\n", "\"source\"", ":", "vocabulary", ".", "get_control_mapping", "(", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", ",", "\n", "control_symbols", "\n", ")", ",", "\n", "\"target\"", ":", "vocabulary", ".", "get_control_mapping", "(", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", ",", "\n", "control_symbols", "\n", ")", "\n", "}", "\n", "\n", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.session_config": [[158, 169], ["tensorflow.OptimizerOptions", "tensorflow.GraphOptions", "tensorflow.ConfigProto", "str"], "function", ["None"], ["", "def", "session_config", "(", "params", ")", ":", "\n", "    ", "optimizer_options", "=", "tf", ".", "OptimizerOptions", "(", "opt_level", "=", "tf", ".", "OptimizerOptions", ".", "L1", ",", "\n", "do_function_inlining", "=", "False", ")", "\n", "graph_options", "=", "tf", ".", "GraphOptions", "(", "optimizer_options", "=", "optimizer_options", ")", "\n", "config", "=", "tf", ".", "ConfigProto", "(", "allow_soft_placement", "=", "True", ",", "\n", "graph_options", "=", "graph_options", ")", "\n", "if", "params", ".", "device_list", ":", "\n", "        ", "device_str", "=", "\",\"", ".", "join", "(", "[", "str", "(", "i", ")", "for", "i", "in", "params", ".", "device_list", "]", ")", "\n", "config", ".", "gpu_options", ".", "visible_device_list", "=", "device_str", "\n", "\n", "", "return", "config", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.set_variables": [[171, 188], ["tensorflow.logging.debug", "tensorflow.placeholder", "list", "tensorflow.device", "tensorflow.assign", "ops.append", "name.split"], "function", ["None"], ["", "def", "set_variables", "(", "var_list", ",", "value_dict", ",", "prefix", ",", "feed_dict", ")", ":", "\n", "    ", "ops", "=", "[", "]", "\n", "for", "var", "in", "var_list", ":", "\n", "        ", "for", "name", "in", "value_dict", ":", "\n", "            ", "var_name", "=", "\"/\"", ".", "join", "(", "[", "prefix", "]", "+", "list", "(", "name", ".", "split", "(", "\"/\"", ")", "[", "1", ":", "]", ")", ")", "\n", "\n", "if", "var", ".", "name", "[", ":", "-", "2", "]", "==", "var_name", ":", "\n", "                ", "tf", ".", "logging", ".", "debug", "(", "\"restoring %s -> %s\"", "%", "(", "name", ",", "var", ".", "name", ")", ")", "\n", "placeholder", "=", "tf", ".", "placeholder", "(", "tf", ".", "float32", ",", "\n", "name", "=", "\"placeholder/\"", "+", "var_name", ")", "\n", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "                    ", "op", "=", "tf", ".", "assign", "(", "var", ",", "placeholder", ")", "\n", "ops", ".", "append", "(", "op", ")", "\n", "", "feed_dict", "[", "placeholder", "]", "=", "value_dict", "[", "name", "]", "\n", "break", "\n", "\n", "", "", "", "return", "ops", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.shard_features": [[190, 213], ["len", "isinstance", "range"], "function", ["None"], ["", "def", "shard_features", "(", "features", ",", "placeholders", ",", "predictions", ")", ":", "\n", "    ", "num_shards", "=", "len", "(", "placeholders", ")", "\n", "feed_dict", "=", "{", "}", "\n", "n", "=", "0", "\n", "\n", "for", "name", "in", "features", ":", "\n", "        ", "feat", "=", "features", "[", "name", "]", "\n", "batch", "=", "feat", ".", "shape", "[", "0", "]", "\n", "shard_size", "=", "(", "batch", "+", "num_shards", "-", "1", ")", "//", "num_shards", "\n", "\n", "for", "i", "in", "range", "(", "num_shards", ")", ":", "\n", "            ", "shard_feat", "=", "feat", "[", "i", "*", "shard_size", ":", "(", "i", "+", "1", ")", "*", "shard_size", "]", "\n", "\n", "if", "shard_feat", ".", "shape", "[", "0", "]", "!=", "0", ":", "\n", "                ", "feed_dict", "[", "placeholders", "[", "i", "]", "[", "name", "]", "]", "=", "shard_feat", "\n", "n", "=", "i", "+", "1", "\n", "", "else", ":", "\n", "                ", "break", "\n", "\n", "", "", "", "if", "isinstance", "(", "predictions", ",", "(", "list", ",", "tuple", ")", ")", ":", "\n", "        ", "predictions", "=", "[", "item", "[", ":", "n", "]", "for", "item", "in", "predictions", "]", "\n", "\n", "", "return", "predictions", ",", "feed_dict", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.main": [[215, 408], ["tensorflow.logging.set_verbosity", "thumt.get_model", "translator.default_parameters", "translator.merge_parameters", "translator.import_params", "translator.override_parameters", "tensorflow.Graph().as_default", "enumerate", "range", "thumt.sort_input_file", "thumt.get_inference_input", "range", "thumt.data_parallelism", "tensorflow.trainable_variables", "range", "tensorflow.group", "tensorflow.tables_initializer", "tensorflow.get_default_graph().finalize", "list", "list", "list", "range", "range", "model_cls.get_parameters", "zip", "range", "range", "tensorflow.logging.info", "tensorflow.train.list_variables", "tensorflow.train.load_checkpoint", "model_var_lists.append", "len", "model_cls_list[].get_name", "model_list.append", "len", "placeholders.append", "len", "model_cls_list[].get_name", "translator.set_variables", "assign_ops.extend", "tensorflow.Session", "sess.run", "sess.run", "itertools.chain", "itertools.chain", "itertools.chain", "len", "restored_inputs.append", "restored_outputs.append", "restored_scores.append", "restored_word_scores.append", "open", "open", "open", "zip", "len", "len", "len", "tensorflow.Graph", "tf.train.load_checkpoint.get_tensor", "inference_fn", "v.name.startswith", "tensorflow.get_default_graph", "list.append", "list.append", "list.append", "open", "zip", "zip", "model_cls_list[].get_name.startswith", "model_cls_list[].get_name.find", "tensorflow.placeholder", "tensorflow.placeholder", "un_init_var_list.append", "translator.session_config", "sess.run", "translator.shard_features", "results.append", "tensorflow.logging.log", "item.tolist", "item.tolist", "item.tolist", "zip", "map", "outfile.write", "out_word_prob.write", "out_sentence_prob.write", "model_cls_list[].get_name", "sess.run", "len", "decoded.append", "len", "decoded.append", "outfile.write", "outfile.write"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.__init__.get_model", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.default_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.merge_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.import_params", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.override_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.sort_input_file", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.get_inference_input", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel.data_parallelism", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_name", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_name", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.set_variables", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.session_config", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.translator.shard_features", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_name"], ["", "def", "main", "(", "args", ")", ":", "\n", "    ", "tf", ".", "logging", ".", "set_verbosity", "(", "tf", ".", "logging", ".", "INFO", ")", "\n", "# Load configs", "\n", "model_cls_list", "=", "[", "models", ".", "get_model", "(", "model", ")", "for", "model", "in", "args", ".", "models", "]", "\n", "params_list", "=", "[", "default_parameters", "(", ")", "for", "_", "in", "range", "(", "len", "(", "model_cls_list", ")", ")", "]", "\n", "params_list", "=", "[", "\n", "merge_parameters", "(", "params", ",", "model_cls", ".", "get_parameters", "(", ")", ")", "\n", "for", "params", ",", "model_cls", "in", "zip", "(", "params_list", ",", "model_cls_list", ")", "\n", "]", "\n", "params_list", "=", "[", "\n", "import_params", "(", "args", ".", "checkpoints", "[", "i", "]", ",", "args", ".", "models", "[", "i", "]", ",", "params_list", "[", "i", "]", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "args", ".", "checkpoints", ")", ")", "\n", "]", "\n", "params_list", "=", "[", "\n", "override_parameters", "(", "params_list", "[", "i", "]", ",", "args", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "model_cls_list", ")", ")", "\n", "]", "\n", "\n", "# Build Graph", "\n", "with", "tf", ".", "Graph", "(", ")", ".", "as_default", "(", ")", ":", "\n", "        ", "model_var_lists", "=", "[", "]", "\n", "\n", "# Load checkpoints", "\n", "for", "i", ",", "checkpoint", "in", "enumerate", "(", "args", ".", "checkpoints", ")", ":", "\n", "            ", "tf", ".", "logging", ".", "info", "(", "\"Loading %s\"", "%", "checkpoint", ")", "\n", "var_list", "=", "tf", ".", "train", ".", "list_variables", "(", "checkpoint", ")", "\n", "values", "=", "{", "}", "\n", "reader", "=", "tf", ".", "train", ".", "load_checkpoint", "(", "checkpoint", ")", "\n", "\n", "for", "(", "name", ",", "shape", ")", "in", "var_list", ":", "\n", "                ", "if", "not", "name", ".", "startswith", "(", "model_cls_list", "[", "i", "]", ".", "get_name", "(", ")", ")", ":", "\n", "                    ", "continue", "\n", "\n", "", "if", "name", ".", "find", "(", "\"losses_avg\"", ")", ">=", "0", ":", "\n", "                    ", "continue", "\n", "\n", "", "tensor", "=", "reader", ".", "get_tensor", "(", "name", ")", "\n", "values", "[", "name", "]", "=", "tensor", "\n", "\n", "", "model_var_lists", ".", "append", "(", "values", ")", "\n", "\n", "# Build models", "\n", "", "model_list", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "len", "(", "args", ".", "checkpoints", ")", ")", ":", "\n", "            ", "name", "=", "model_cls_list", "[", "i", "]", ".", "get_name", "(", ")", "\n", "model", "=", "model_cls_list", "[", "i", "]", "(", "params_list", "[", "i", "]", ",", "name", "+", "\"_%d\"", "%", "i", ")", "\n", "model_list", ".", "append", "(", "model", ")", "\n", "\n", "", "params", "=", "params_list", "[", "0", "]", "\n", "# Read input file", "\n", "sorted_keys", ",", "sorted_inputs", "=", "dataset", ".", "sort_input_file", "(", "args", ".", "input", ")", "\n", "# Build input queue", "\n", "features", "=", "dataset", ".", "get_inference_input", "(", "sorted_inputs", ",", "params", ")", "\n", "# Create placeholders", "\n", "placeholders", "=", "[", "]", "\n", "\n", "for", "i", "in", "range", "(", "len", "(", "params", ".", "device_list", ")", ")", ":", "\n", "            ", "placeholders", ".", "append", "(", "{", "\n", "\"source\"", ":", "tf", ".", "placeholder", "(", "tf", ".", "int32", ",", "[", "None", ",", "None", "]", ",", "\n", "\"source_%d\"", "%", "i", ")", ",", "\n", "\"source_length\"", ":", "tf", ".", "placeholder", "(", "tf", ".", "int32", ",", "[", "None", "]", ",", "\n", "\"source_length_%d\"", "%", "i", ")", "\n", "}", ")", "\n", "\n", "# A list of outputs", "\n", "", "if", "params", ".", "generate_samples", ":", "\n", "            ", "inference_fn", "=", "sampling", ".", "create_sampling_graph", "\n", "", "else", ":", "\n", "            ", "inference_fn", "=", "inference", ".", "create_inference_graph", "\n", "\n", "", "predictions", "=", "parallel", ".", "data_parallelism", "(", "\n", "params", ".", "device_list", ",", "lambda", "f", ":", "inference_fn", "(", "model_list", ",", "f", ",", "params", ")", ",", "\n", "placeholders", ")", "\n", "\n", "# Create assign ops", "\n", "assign_ops", "=", "[", "]", "\n", "feed_dict", "=", "{", "}", "\n", "\n", "all_var_list", "=", "tf", ".", "trainable_variables", "(", ")", "\n", "\n", "for", "i", "in", "range", "(", "len", "(", "args", ".", "checkpoints", ")", ")", ":", "\n", "            ", "un_init_var_list", "=", "[", "]", "\n", "name", "=", "model_cls_list", "[", "i", "]", ".", "get_name", "(", ")", "\n", "\n", "for", "v", "in", "all_var_list", ":", "\n", "                ", "if", "v", ".", "name", ".", "startswith", "(", "name", "+", "\"_%d\"", "%", "i", ")", ":", "\n", "                    ", "un_init_var_list", ".", "append", "(", "v", ")", "\n", "\n", "", "", "ops", "=", "set_variables", "(", "un_init_var_list", ",", "model_var_lists", "[", "i", "]", ",", "\n", "name", "+", "\"_%d\"", "%", "i", ",", "feed_dict", ")", "\n", "assign_ops", ".", "extend", "(", "ops", ")", "\n", "\n", "", "assign_op", "=", "tf", ".", "group", "(", "*", "assign_ops", ")", "\n", "init_op", "=", "tf", ".", "tables_initializer", "(", ")", "\n", "results", "=", "[", "]", "\n", "\n", "tf", ".", "get_default_graph", "(", ")", ".", "finalize", "(", ")", "\n", "\n", "# Create session", "\n", "with", "tf", ".", "Session", "(", "config", "=", "session_config", "(", "params", ")", ")", "as", "sess", ":", "\n", "# Restore variables", "\n", "            ", "sess", ".", "run", "(", "assign_op", ",", "feed_dict", "=", "feed_dict", ")", "\n", "sess", ".", "run", "(", "init_op", ")", "\n", "\n", "while", "True", ":", "\n", "                ", "try", ":", "\n", "                    ", "feats", "=", "sess", ".", "run", "(", "features", ")", "\n", "op", ",", "feed_dict", "=", "shard_features", "(", "feats", ",", "placeholders", ",", "\n", "predictions", ")", "\n", "results", ".", "append", "(", "sess", ".", "run", "(", "op", ",", "feed_dict", "=", "feed_dict", ")", ")", "\n", "message", "=", "\"Finished batch %d\"", "%", "len", "(", "results", ")", "\n", "tf", ".", "logging", ".", "log", "(", "tf", ".", "logging", ".", "INFO", ",", "message", ")", "\n", "", "except", "tf", ".", "errors", ".", "OutOfRangeError", ":", "\n", "                    ", "break", "\n", "\n", "# Convert to plain text", "\n", "", "", "", "vocab", "=", "params", ".", "vocabulary", "[", "\"target\"", "]", "\n", "outputs", "=", "[", "]", "\n", "scores", "=", "[", "]", "\n", "word_scores", "=", "[", "]", "\n", "\n", "for", "result", "in", "results", ":", "\n", "            ", "for", "item", "in", "result", "[", "0", "]", ":", "\n", "                ", "outputs", ".", "append", "(", "item", ".", "tolist", "(", ")", ")", "\n", "", "for", "item", "in", "result", "[", "1", "]", ":", "\n", "                ", "scores", ".", "append", "(", "item", ".", "tolist", "(", ")", ")", "\n", "", "for", "item", "in", "result", "[", "2", "]", ":", "\n", "                ", "word_scores", ".", "append", "(", "item", ".", "tolist", "(", ")", ")", "\n", "\n", "", "", "outputs", "=", "list", "(", "itertools", ".", "chain", "(", "*", "outputs", ")", ")", "\n", "scores", "=", "list", "(", "itertools", ".", "chain", "(", "*", "scores", ")", ")", "\n", "word_scores", "=", "list", "(", "itertools", ".", "chain", "(", "*", "word_scores", ")", ")", "\n", "\n", "restored_inputs", "=", "[", "]", "\n", "restored_outputs", "=", "[", "]", "\n", "restored_scores", "=", "[", "]", "\n", "restored_word_scores", "=", "[", "]", "\n", "\n", "for", "index", "in", "range", "(", "len", "(", "sorted_inputs", ")", ")", ":", "\n", "            ", "restored_inputs", ".", "append", "(", "sorted_inputs", "[", "sorted_keys", "[", "index", "]", "]", ")", "\n", "restored_outputs", ".", "append", "(", "outputs", "[", "sorted_keys", "[", "index", "]", "]", ")", "\n", "restored_scores", ".", "append", "(", "scores", "[", "sorted_keys", "[", "index", "]", "]", ")", "\n", "restored_word_scores", ".", "append", "(", "word_scores", "[", "sorted_keys", "[", "index", "]", "]", ")", "\n", "\n", "# Write to file", "\n", "", "if", "not", "args", ".", "word_prob", ":", "\n", "            ", "with", "open", "(", "args", ".", "output", ",", "\"w\"", ")", "as", "outfile", ":", "\n", "                ", "count", "=", "0", "\n", "for", "outputs", ",", "scores", "in", "zip", "(", "restored_outputs", ",", "restored_scores", ")", ":", "\n", "                    ", "for", "output", ",", "score", "in", "zip", "(", "outputs", ",", "scores", ")", ":", "\n", "                        ", "decoded", "=", "[", "]", "\n", "for", "idx", "in", "output", ":", "\n", "                            ", "if", "idx", "==", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "eos", "]", ":", "\n", "                                ", "break", "\n", "", "decoded", ".", "append", "(", "vocab", "[", "idx", "]", ")", "\n", "\n", "", "decoded", "=", "\" \"", ".", "join", "(", "decoded", ")", "\n", "\n", "if", "not", "args", ".", "verbose", ":", "\n", "                            ", "outfile", ".", "write", "(", "\"%s\\n\"", "%", "decoded", ")", "\n", "break", "\n", "", "else", ":", "\n", "                            ", "pattern", "=", "\"%d ||| %s ||| %s ||| %f\\n\"", "\n", "source", "=", "restored_inputs", "[", "count", "]", "\n", "values", "=", "(", "count", ",", "source", ",", "decoded", ",", "score", ")", "\n", "outfile", ".", "write", "(", "pattern", "%", "values", ")", "\n", "\n", "", "", "count", "+=", "1", "\n", "", "", "return", "\n", "\n", "", "with", "open", "(", "args", ".", "output", ",", "\"w\"", ")", "as", "outfile", ",", "open", "(", "args", ".", "prob_files", "[", "0", "]", ",", "'w'", ")", "as", "out_word_prob", ",", "open", "(", "args", ".", "prob_files", "[", "1", "]", ",", "'w'", ")", "as", "out_sentence_prob", ":", "\n", "            ", "for", "outputs", ",", "scores", ",", "word_scores", "in", "zip", "(", "restored_outputs", ",", "restored_scores", ",", "restored_word_scores", ")", ":", "\n", "                ", "for", "output", ",", "score", ",", "word_score", "in", "zip", "(", "outputs", ",", "scores", ",", "word_scores", ")", ":", "\n", "                    ", "decoded", "=", "[", "]", "\n", "for", "idx", "in", "output", ":", "\n", "                        ", "if", "idx", "==", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "eos", "]", ":", "\n", "                            ", "break", "\n", "", "decoded", ".", "append", "(", "vocab", "[", "idx", "]", ")", "\n", "\n", "", "decoded_len", "=", "len", "(", "decoded", ")", "+", "1", "\n", "decoded_word_score", "=", "word_score", "[", ":", "decoded_len", "]", "\n", "# lp = math.pow((5.0 + decoded_len) / 6.0, params.decode_alpha)", "\n", "# sentence_score = 1.0 * np.sum(decoded_word_score) / lp", "\n", "decoded_word_score", "=", "map", "(", "str", ",", "decoded_word_score", ")", "\n", "decoded_word_score", "=", "\" \"", ".", "join", "(", "decoded_word_score", ")", "\n", "decoded", "=", "\" \"", ".", "join", "(", "decoded", ")", "\n", "\n", "outfile", ".", "write", "(", "\"%s\\n\"", "%", "decoded", ")", "\n", "out_word_prob", ".", "write", "(", "\"%s\\n\"", "%", "decoded_word_score", ")", "\n", "out_sentence_prob", ".", "write", "(", "\"%f\\n\"", "%", "score", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.parse_args": [[26, 64], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args"], ["def", "parse_args", "(", "args", "=", "None", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", "\n", "description", "=", "\"Training neural machine translation models\"", ",", "\n", "usage", "=", "\"trainer.py [<args>] [-h | --help]\"", "\n", ")", "\n", "\n", "# input files", "\n", "parser", ".", "add_argument", "(", "\"--input\"", ",", "type", "=", "str", ",", "nargs", "=", "2", ",", "\n", "help", "=", "\"Path of source and target corpus\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--word_confidence\"", ",", "type", "=", "str", ",", "default", "=", "\"word_confidence.txt\"", ",", "\n", "help", "=", "\"Path of the word-level confidence file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--sen_confidence\"", ",", "type", "=", "str", ",", "default", "=", "\"sen_confidence.txt\"", ",", "\n", "help", "=", "\"Path of the sentence-level confidence file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--side\"", ",", "type", "=", "str", ",", "default", "=", "\"none\"", ",", "\n", "choices", "=", "(", "\"none\"", ",", "\"source_sentence\"", ",", "\"source_word\"", ",", "\n", "\"source_sentence_source_word\"", ",", "\n", "\"target_sentence\"", ",", "\"target_word\"", ")", ",", "\n", "help", "=", "\"Which side the confidence is added to\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--record\"", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Path to tf.Record data\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--output\"", ",", "type", "=", "str", ",", "default", "=", "\"train\"", ",", "\n", "help", "=", "\"Path to saved models\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--vocabulary\"", ",", "type", "=", "str", ",", "nargs", "=", "2", ",", "\n", "help", "=", "\"Path of source and target vocabulary\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--validation\"", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Path of validation file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--references\"", ",", "type", "=", "str", ",", "nargs", "=", "\"+\"", ",", "\n", "help", "=", "\"Path of reference files\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--checkpoint\"", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Path to pre-trained checkpoint\"", ")", "\n", "\n", "# model and configuration", "\n", "parser", ".", "add_argument", "(", "\"--model\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Name of the model\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--parameters\"", ",", "type", "=", "str", ",", "default", "=", "\"\"", ",", "\n", "help", "=", "\"Additional hyper parameters\"", ")", "\n", "\n", "return", "parser", ".", "parse_args", "(", "args", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.default_parameters": [[66, 118], ["tensorflow.contrib.training.HParams"], "function", ["None"], ["", "def", "default_parameters", "(", ")", ":", "\n", "    ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", "\n", "input", "=", "[", "\"\"", ",", "\"\"", "]", ",", "\n", "output", "=", "\"\"", ",", "\n", "record", "=", "\"\"", ",", "\n", "model", "=", "\"transformer\"", ",", "\n", "vocab", "=", "[", "\"\"", ",", "\"\"", "]", ",", "\n", "# Default training hyper parameters", "\n", "num_threads", "=", "6", ",", "\n", "batch_size", "=", "4096", ",", "\n", "max_length", "=", "256", ",", "\n", "length_multiplier", "=", "1", ",", "\n", "mantissa_bits", "=", "2", ",", "\n", "warmup_steps", "=", "4000", ",", "\n", "train_steps", "=", "100000", ",", "\n", "buffer_size", "=", "10000", ",", "\n", "constant_batch_size", "=", "False", ",", "\n", "device_list", "=", "[", "0", "]", ",", "\n", "update_cycle", "=", "1", ",", "\n", "initializer", "=", "\"uniform_unit_scaling\"", ",", "\n", "initializer_gain", "=", "1.0", ",", "\n", "scale_l1", "=", "0.0", ",", "\n", "scale_l2", "=", "0.0", ",", "\n", "optimizer", "=", "\"Adam\"", ",", "\n", "adam_beta1", "=", "0.9", ",", "\n", "adam_beta2", "=", "0.999", ",", "\n", "adam_epsilon", "=", "1e-8", ",", "\n", "clip_grad_norm", "=", "5.0", ",", "\n", "learning_rate", "=", "1.0", ",", "\n", "learning_rate_decay", "=", "\"linear_warmup_rsqrt_decay\"", ",", "\n", "learning_rate_boundaries", "=", "[", "0", "]", ",", "\n", "learning_rate_values", "=", "[", "0.0", "]", ",", "\n", "keep_checkpoint_max", "=", "100", ",", "\n", "keep_top_checkpoint_max", "=", "5", ",", "\n", "# Validation", "\n", "eval_steps", "=", "2000", ",", "\n", "eval_secs", "=", "0", ",", "\n", "eval_batch_size", "=", "32", ",", "\n", "top_beams", "=", "1", ",", "\n", "beam_size", "=", "4", ",", "\n", "decode_alpha", "=", "0.6", ",", "\n", "decode_length", "=", "50", ",", "\n", "validation", "=", "\"\"", ",", "\n", "references", "=", "[", "\"\"", "]", ",", "\n", "save_checkpoint_secs", "=", "0", ",", "\n", "save_checkpoint_steps", "=", "1000", ",", "\n", "# Setting this to True can save disk spaces, but cannot restore", "\n", "# training using the saved checkpoint", "\n", "only_save_trainable", "=", "False", "\n", ")", "\n", "\n", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.import_params": [[120, 139], ["os.path.abspath", "os.path.join", "os.path.join", "tensorflow.gfile.Open", "tensorflow.logging.info", "fd.readline", "params.parse_json", "tensorflow.gfile.Open", "tensorflow.logging.info", "fd.readline", "params.parse_json", "tensorflow.gfile.Exists", "tensorflow.gfile.Exists"], "function", ["None"], ["", "def", "import_params", "(", "model_dir", ",", "model_name", ",", "params", ")", ":", "\n", "    ", "model_dir", "=", "os", ".", "path", ".", "abspath", "(", "model_dir", ")", "\n", "p_name", "=", "os", ".", "path", ".", "join", "(", "model_dir", ",", "\"params.json\"", ")", "\n", "m_name", "=", "os", ".", "path", ".", "join", "(", "model_dir", ",", "model_name", "+", "\".json\"", ")", "\n", "\n", "if", "not", "tf", ".", "gfile", ".", "Exists", "(", "p_name", ")", "or", "not", "tf", ".", "gfile", ".", "Exists", "(", "m_name", ")", ":", "\n", "        ", "return", "params", "\n", "\n", "", "with", "tf", ".", "gfile", ".", "Open", "(", "p_name", ")", "as", "fd", ":", "\n", "        ", "tf", ".", "logging", ".", "info", "(", "\"Restoring hyper parameters from %s\"", "%", "p_name", ")", "\n", "json_str", "=", "fd", ".", "readline", "(", ")", "\n", "params", ".", "parse_json", "(", "json_str", ")", "\n", "\n", "", "with", "tf", ".", "gfile", ".", "Open", "(", "m_name", ")", "as", "fd", ":", "\n", "        ", "tf", ".", "logging", ".", "info", "(", "\"Restoring model parameters from %s\"", "%", "m_name", ")", "\n", "json_str", "=", "fd", ".", "readline", "(", ")", "\n", "params", ".", "parse_json", "(", "json_str", ")", "\n", "\n", "", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.export_params": [[141, 149], ["os.path.join", "tensorflow.gfile.Exists", "tensorflow.gfile.MkDir", "tensorflow.gfile.Open", "fd.write", "params.to_json"], "function", ["None"], ["", "def", "export_params", "(", "output_dir", ",", "name", ",", "params", ")", ":", "\n", "    ", "if", "not", "tf", ".", "gfile", ".", "Exists", "(", "output_dir", ")", ":", "\n", "        ", "tf", ".", "gfile", ".", "MkDir", "(", "output_dir", ")", "\n", "\n", "# Save params as params.json", "\n", "", "filename", "=", "os", ".", "path", ".", "join", "(", "output_dir", ",", "name", ")", "\n", "with", "tf", ".", "gfile", ".", "Open", "(", "filename", ",", "\"w\"", ")", "as", "fd", ":", "\n", "        ", "fd", ".", "write", "(", "params", ".", "to_json", "(", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.collect_params": [[151, 158], ["tensorflow.contrib.training.HParams", "params.values().iterkeys", "tf.contrib.training.HParams.add_hparam", "params.values", "getattr"], "function", ["None"], ["", "", "def", "collect_params", "(", "all_params", ",", "params", ")", ":", "\n", "    ", "collected", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", ")", "\n", "\n", "for", "k", "in", "params", ".", "values", "(", ")", ".", "iterkeys", "(", ")", ":", "\n", "        ", "collected", ".", "add_hparam", "(", "k", ",", "getattr", "(", "all_params", ",", "k", ")", ")", "\n", "\n", "", "return", "collected", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.merge_parameters": [[160, 176], ["tensorflow.contrib.training.HParams", "params1.values().iteritems", "tf.contrib.training.HParams.values", "params2.values().iteritems", "tf.contrib.training.HParams.add_hparam", "params1.values", "params2.values", "setattr", "tf.contrib.training.HParams.add_hparam"], "function", ["None"], ["", "def", "merge_parameters", "(", "params1", ",", "params2", ")", ":", "\n", "    ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", ")", "\n", "\n", "for", "(", "k", ",", "v", ")", "in", "params1", ".", "values", "(", ")", ".", "iteritems", "(", ")", ":", "\n", "        ", "params", ".", "add_hparam", "(", "k", ",", "v", ")", "\n", "\n", "", "params_dict", "=", "params", ".", "values", "(", ")", "\n", "\n", "for", "(", "k", ",", "v", ")", "in", "params2", ".", "values", "(", ")", ".", "iteritems", "(", ")", ":", "\n", "        ", "if", "k", "in", "params_dict", ":", "\n", "# Override", "\n", "            ", "setattr", "(", "params", ",", "k", ",", "v", ")", "\n", "", "else", ":", "\n", "            ", "params", ".", "add_hparam", "(", "k", ",", "v", ")", "\n", "\n", "", "", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.override_parameters": [[178, 216], ["params.parse", "thumt.process_vocabulary", "thumt.process_vocabulary", "thumt.load_vocabulary", "thumt.load_vocabulary", "thumt.get_control_mapping", "thumt.get_control_mapping"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.process_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.process_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.load_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.load_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.get_control_mapping", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.get_control_mapping"], ["", "def", "override_parameters", "(", "params", ",", "args", ")", ":", "\n", "    ", "params", ".", "model", "=", "args", ".", "model", "\n", "params", ".", "input", "=", "args", ".", "input", "or", "params", ".", "input", "\n", "params", ".", "output", "=", "args", ".", "output", "or", "params", ".", "output", "\n", "params", ".", "record", "=", "args", ".", "record", "or", "params", ".", "record", "\n", "params", ".", "vocab", "=", "args", ".", "vocabulary", "or", "params", ".", "vocab", "\n", "params", ".", "validation", "=", "args", ".", "validation", "or", "params", ".", "validation", "\n", "params", ".", "references", "=", "args", ".", "references", "or", "params", ".", "references", "\n", "params", ".", "confidence", "=", "args", ".", "word_confidence", "\n", "params", ".", "sen_confidence", "=", "args", ".", "sen_confidence", "\n", "params", ".", "side", "=", "args", ".", "side", "\n", "params", ".", "parse", "(", "args", ".", "parameters", ")", "\n", "\n", "params", ".", "vocabulary", "=", "{", "\n", "\"source\"", ":", "vocabulary", ".", "load_vocabulary", "(", "params", ".", "vocab", "[", "0", "]", ")", ",", "\n", "\"target\"", ":", "vocabulary", ".", "load_vocabulary", "(", "params", ".", "vocab", "[", "1", "]", ")", "\n", "}", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", "=", "vocabulary", ".", "process_vocabulary", "(", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", ",", "params", "\n", ")", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", "=", "vocabulary", ".", "process_vocabulary", "(", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", ",", "params", "\n", ")", "\n", "\n", "control_symbols", "=", "[", "params", ".", "pad", ",", "params", ".", "bos", ",", "params", ".", "eos", ",", "params", ".", "unk", "]", "\n", "\n", "params", ".", "mapping", "=", "{", "\n", "\"source\"", ":", "vocabulary", ".", "get_control_mapping", "(", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", ",", "\n", "control_symbols", "\n", ")", ",", "\n", "\"target\"", ":", "vocabulary", ".", "get_control_mapping", "(", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", ",", "\n", "control_symbols", "\n", ")", "\n", "}", "\n", "\n", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.get_initializer": [[218, 234], ["tensorflow.random_uniform_initializer", "tensorflow.random_normal_initializer", "tensorflow.variance_scaling_initializer", "tensorflow.variance_scaling_initializer", "ValueError"], "function", ["None"], ["", "def", "get_initializer", "(", "params", ")", ":", "\n", "    ", "if", "params", ".", "initializer", "==", "\"uniform\"", ":", "\n", "        ", "max_val", "=", "params", ".", "initializer_gain", "\n", "return", "tf", ".", "random_uniform_initializer", "(", "-", "max_val", ",", "max_val", ")", "\n", "", "elif", "params", ".", "initializer", "==", "\"normal\"", ":", "\n", "        ", "return", "tf", ".", "random_normal_initializer", "(", "0.0", ",", "params", ".", "initializer_gain", ")", "\n", "", "elif", "params", ".", "initializer", "==", "\"normal_unit_scaling\"", ":", "\n", "        ", "return", "tf", ".", "variance_scaling_initializer", "(", "params", ".", "initializer_gain", ",", "\n", "mode", "=", "\"fan_avg\"", ",", "\n", "distribution", "=", "\"normal\"", ")", "\n", "", "elif", "params", ".", "initializer", "==", "\"uniform_unit_scaling\"", ":", "\n", "        ", "return", "tf", ".", "variance_scaling_initializer", "(", "params", ".", "initializer_gain", ",", "\n", "mode", "=", "\"fan_avg\"", ",", "\n", "distribution", "=", "\"uniform\"", ")", "\n", "", "else", ":", "\n", "        ", "raise", "ValueError", "(", "\"Unrecognized initializer: %s\"", "%", "params", ".", "initializer", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.get_learning_rate_decay": [[236, 253], ["tensorflow.to_float", "tensorflow.to_float", "tensorflow.minimum", "tensorflow.train.piecewise_constant", "tensorflow.to_int32", "ValueError"], "function", ["None"], ["", "", "def", "get_learning_rate_decay", "(", "learning_rate", ",", "global_step", ",", "params", ")", ":", "\n", "    ", "if", "params", ".", "learning_rate_decay", "in", "[", "\"linear_warmup_rsqrt_decay\"", ",", "\"noam\"", "]", ":", "\n", "        ", "step", "=", "tf", ".", "to_float", "(", "global_step", ")", "\n", "warmup_steps", "=", "tf", ".", "to_float", "(", "params", ".", "warmup_steps", ")", "\n", "multiplier", "=", "params", ".", "hidden_size", "**", "-", "0.5", "\n", "decay", "=", "multiplier", "*", "tf", ".", "minimum", "(", "(", "step", "+", "1", ")", "*", "(", "warmup_steps", "**", "-", "1.5", ")", ",", "\n", "(", "step", "+", "1", ")", "**", "-", "0.5", ")", "\n", "\n", "return", "learning_rate", "*", "decay", "\n", "", "elif", "params", ".", "learning_rate_decay", "==", "\"piecewise_constant\"", ":", "\n", "        ", "return", "tf", ".", "train", ".", "piecewise_constant", "(", "tf", ".", "to_int32", "(", "global_step", ")", ",", "\n", "params", ".", "learning_rate_boundaries", ",", "\n", "params", ".", "learning_rate_values", ")", "\n", "", "elif", "params", ".", "learning_rate_decay", "==", "\"none\"", ":", "\n", "        ", "return", "learning_rate", "\n", "", "else", ":", "\n", "        ", "raise", "ValueError", "(", "\"Unknown learning_rate_decay\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.session_config": [[255, 266], ["tensorflow.OptimizerOptions", "tensorflow.GraphOptions", "tensorflow.ConfigProto", "str"], "function", ["None"], ["", "", "def", "session_config", "(", "params", ")", ":", "\n", "    ", "optimizer_options", "=", "tf", ".", "OptimizerOptions", "(", "opt_level", "=", "tf", ".", "OptimizerOptions", ".", "L1", ",", "\n", "do_function_inlining", "=", "True", ")", "\n", "graph_options", "=", "tf", ".", "GraphOptions", "(", "optimizer_options", "=", "optimizer_options", ")", "\n", "config", "=", "tf", ".", "ConfigProto", "(", "allow_soft_placement", "=", "True", ",", "\n", "graph_options", "=", "graph_options", ")", "\n", "if", "params", ".", "device_list", ":", "\n", "        ", "device_str", "=", "\",\"", ".", "join", "(", "[", "str", "(", "i", ")", "for", "i", "in", "params", ".", "device_list", "]", ")", "\n", "config", ".", "gpu_options", ".", "visible_device_list", "=", "device_str", "\n", "\n", "", "return", "config", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.decode_target_ids": [[268, 290], ["decoded.append", "isinstance", "syms.append"], "function", ["None"], ["", "def", "decode_target_ids", "(", "inputs", ",", "params", ")", ":", "\n", "    ", "decoded", "=", "[", "]", "\n", "vocab", "=", "params", ".", "vocabulary", "[", "\"target\"", "]", "\n", "\n", "for", "item", "in", "inputs", ":", "\n", "        ", "syms", "=", "[", "]", "\n", "for", "idx", "in", "item", ":", "\n", "            ", "if", "isinstance", "(", "idx", ",", "six", ".", "integer_types", ")", ":", "\n", "                ", "sym", "=", "vocab", "[", "idx", "]", "\n", "", "else", ":", "\n", "                ", "sym", "=", "idx", "\n", "\n", "", "if", "sym", "==", "params", ".", "eos", ":", "\n", "                ", "break", "\n", "\n", "", "if", "sym", "==", "params", ".", "pad", ":", "\n", "                ", "break", "\n", "\n", "", "syms", ".", "append", "(", "sym", ")", "\n", "", "decoded", ".", "append", "(", "syms", ")", "\n", "\n", "", "return", "decoded", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.restore_variables": [[292, 320], ["tensorflow.logging.info", "tensorflow.train.list_variables", "tensorflow.train.load_checkpoint", "tensorflow.trainable_variables", "tensorflow.group", "tensorflow.no_op", "tf.train.load_checkpoint.get_tensor", "name.split", "var.name.split", "tensorflow.logging.info", "ops.append", "tensorflow.assign"], "function", ["None"], ["", "def", "restore_variables", "(", "checkpoint", ")", ":", "\n", "    ", "if", "not", "checkpoint", ":", "\n", "        ", "return", "tf", ".", "no_op", "(", "\"restore_op\"", ")", "\n", "\n", "# Load checkpoints", "\n", "", "tf", ".", "logging", ".", "info", "(", "\"Loading %s\"", "%", "checkpoint", ")", "\n", "var_list", "=", "tf", ".", "train", ".", "list_variables", "(", "checkpoint", ")", "\n", "reader", "=", "tf", ".", "train", ".", "load_checkpoint", "(", "checkpoint", ")", "\n", "values", "=", "{", "}", "\n", "\n", "for", "(", "name", ",", "shape", ")", "in", "var_list", ":", "\n", "        ", "if", "name", "==", "\"OneShotIterator:0-state\"", ":", "\n", "            ", "continue", "\n", "", "tensor", "=", "reader", ".", "get_tensor", "(", "name", ")", "\n", "name", "=", "name", ".", "split", "(", "\":\"", ")", "[", "0", "]", "\n", "values", "[", "name", "]", "=", "tensor", "\n", "\n", "", "var_list", "=", "tf", ".", "trainable_variables", "(", ")", "\n", "ops", "=", "[", "]", "\n", "\n", "for", "var", "in", "var_list", ":", "\n", "        ", "name", "=", "var", ".", "name", ".", "split", "(", "\":\"", ")", "[", "0", "]", "\n", "\n", "if", "name", "in", "values", ":", "\n", "            ", "tf", ".", "logging", ".", "info", "(", "\"Restore %s\"", "%", "var", ".", "name", ")", "\n", "ops", ".", "append", "(", "tf", ".", "assign", "(", "var", ",", "values", "[", "name", "]", ")", ")", "\n", "\n", "", "", "return", "tf", ".", "group", "(", "*", "ops", ",", "name", "=", "\"restore_op\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.main": [[322, 493], ["tensorflow.logging.set_verbosity", "thumt.get_model", "trainer.default_parameters", "trainer.merge_parameters", "trainer.import_params", "trainer.override_parameters", "trainer.export_params", "trainer.export_params", "models.get_model.get_parameters", "trainer.collect_params", "tensorflow.Graph().as_default", "thumt.cache_features", "trainer.get_initializer", "tensorflow.contrib.layers.l1_l2_regularizer", "models.get_model.", "tensorflow.train.get_or_create_global_step", "thumt.parallel_model", "sorted", "tensorflow.logging.info", "trainer.get_learning_rate_decay", "tensorflow.convert_to_tensor", "tensorflow.summary.scalar", "thumt.create_train_op", "trainer.restore_variables", "tensorflow.train.Saver", "tensorflow.add_to_collection", "tensorflow.convert_to_tensor", "trainer.session_config", "models.get_model.get_parameters", "thumt.get_training_input", "thumt.get_training_confidence_input", "model_cls.get_training_func", "tensorflow.add_n", "len", "tensorflow.losses.get_regularization_loss", "list", "tensorflow.logging.info", "numpy.prod().tolist", "tensorflow.train.AdamOptimizer", "thumt.sort_and_zip_files", "tensorflow.trainable_variables", "tensorflow.train.StopAtStepHook", "tensorflow.train.NanTensorHook", "tensorflow.train.LoggingTensorHook", "tensorflow.train.CheckpointSaverHook", "train_hooks.append", "tensorflow.train.MonitoredTrainingSession", "sess._tf_sess().run", "tensorflow.Graph", "tensorflow.trainable_variables", "v.name[].ljust", "str().ljust", "tensorflow.contrib.opt.LazyAdamOptimizer", "RuntimeError", "list", "thumt.EvaluationHook", "sess.should_stop", "sess._tf_sess().run", "range", "sess.run", "numpy.prod", "sess._tf_sess", "sess._tf_sess().run", "str", "numpy.array", "tensorflow.shape", "tensorflow.shape", "thumt.create_inference_graph", "eval_input_fn", "trainer.decode_target_ids", "sess._tf_sess", "v.shape.as_list", "sess._tf_sess"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.__init__.get_model", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.default_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.merge_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.import_params", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.override_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.export_params", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.export_params", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.collect_params", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.cache.cache_features", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.get_initializer", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel.parallel_model", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.get_learning_rate_decay", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.optimize.create_train_op", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.restore_variables", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.session_config", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.get_training_input", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.get_training_confidence_input", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_training_func", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.sort_and_zip_files", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.inference.create_inference_graph", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.trainer.decode_target_ids"], ["", "def", "main", "(", "args", ")", ":", "\n", "    ", "tf", ".", "logging", ".", "set_verbosity", "(", "tf", ".", "logging", ".", "INFO", ")", "\n", "model_cls", "=", "models", ".", "get_model", "(", "args", ".", "model", ")", "\n", "params", "=", "default_parameters", "(", ")", "\n", "\n", "# Import and override parameters", "\n", "# Priorities (low -> high):", "\n", "# default -> saved -> command", "\n", "params", "=", "merge_parameters", "(", "params", ",", "model_cls", ".", "get_parameters", "(", ")", ")", "\n", "params", "=", "import_params", "(", "args", ".", "output", ",", "args", ".", "model", ",", "params", ")", "\n", "override_parameters", "(", "params", ",", "args", ")", "\n", "\n", "# Export all parameters and model specific parameters", "\n", "export_params", "(", "params", ".", "output", ",", "\"params.json\"", ",", "params", ")", "\n", "export_params", "(", "\n", "params", ".", "output", ",", "\n", "\"%s.json\"", "%", "args", ".", "model", ",", "\n", "collect_params", "(", "params", ",", "model_cls", ".", "get_parameters", "(", ")", ")", "\n", ")", "\n", "\n", "# Build Graph", "\n", "with", "tf", ".", "Graph", "(", ")", ".", "as_default", "(", ")", ":", "\n", "        ", "if", "params", ".", "side", "==", "\"none\"", ":", "\n", "            ", "features", "=", "dataset", ".", "get_training_input", "(", "params", ".", "input", ",", "params", ")", "\n", "", "else", ":", "\n", "            ", "features", "=", "dataset", ".", "get_training_confidence_input", "(", "params", ".", "input", ",", "params", ")", "\n", "\n", "", "update_cycle", "=", "params", ".", "update_cycle", "\n", "features", ",", "init_op", "=", "cache", ".", "cache_features", "(", "features", ",", "update_cycle", ")", "\n", "\n", "# Build model", "\n", "initializer", "=", "get_initializer", "(", "params", ")", "\n", "regularizer", "=", "tf", ".", "contrib", ".", "layers", ".", "l1_l2_regularizer", "(", "\n", "scale_l1", "=", "params", ".", "scale_l1", ",", "scale_l2", "=", "params", ".", "scale_l2", ")", "\n", "model", "=", "model_cls", "(", "params", ")", "\n", "# Create global step", "\n", "global_step", "=", "tf", ".", "train", ".", "get_or_create_global_step", "(", ")", "\n", "\n", "# Multi-GPU setting", "\n", "sharded_losses", "=", "parallel", ".", "parallel_model", "(", "\n", "model", ".", "get_training_func", "(", "initializer", ",", "regularizer", ")", ",", "\n", "features", ",", "\n", "params", ".", "device_list", "\n", ")", "\n", "loss", "=", "tf", ".", "add_n", "(", "sharded_losses", ")", "/", "len", "(", "sharded_losses", ")", "\n", "loss", "=", "loss", "+", "tf", ".", "losses", ".", "get_regularization_loss", "(", ")", "\n", "\n", "# Print parameters", "\n", "all_weights", "=", "{", "v", ".", "name", ":", "v", "for", "v", "in", "tf", ".", "trainable_variables", "(", ")", "}", "\n", "total_size", "=", "0", "\n", "\n", "for", "v_name", "in", "sorted", "(", "list", "(", "all_weights", ")", ")", ":", "\n", "            ", "v", "=", "all_weights", "[", "v_name", "]", "\n", "tf", ".", "logging", ".", "info", "(", "\"%s\\tshape    %s\"", ",", "v", ".", "name", "[", ":", "-", "2", "]", ".", "ljust", "(", "80", ")", ",", "\n", "str", "(", "v", ".", "shape", ")", ".", "ljust", "(", "20", ")", ")", "\n", "v_size", "=", "np", ".", "prod", "(", "np", ".", "array", "(", "v", ".", "shape", ".", "as_list", "(", ")", ")", ")", ".", "tolist", "(", ")", "\n", "total_size", "+=", "v_size", "\n", "", "tf", ".", "logging", ".", "info", "(", "\"Total trainable variables size: %d\"", ",", "total_size", ")", "\n", "\n", "learning_rate", "=", "get_learning_rate_decay", "(", "params", ".", "learning_rate", ",", "\n", "global_step", ",", "params", ")", "\n", "learning_rate", "=", "tf", ".", "convert_to_tensor", "(", "learning_rate", ",", "dtype", "=", "tf", ".", "float32", ")", "\n", "tf", ".", "summary", ".", "scalar", "(", "\"learning_rate\"", ",", "learning_rate", ")", "\n", "\n", "# Create optimizer", "\n", "if", "params", ".", "optimizer", "==", "\"Adam\"", ":", "\n", "            ", "opt", "=", "tf", ".", "train", ".", "AdamOptimizer", "(", "learning_rate", ",", "\n", "beta1", "=", "params", ".", "adam_beta1", ",", "\n", "beta2", "=", "params", ".", "adam_beta2", ",", "\n", "epsilon", "=", "params", ".", "adam_epsilon", ")", "\n", "", "elif", "params", ".", "optimizer", "==", "\"LazyAdam\"", ":", "\n", "            ", "opt", "=", "tf", ".", "contrib", ".", "opt", ".", "LazyAdamOptimizer", "(", "learning_rate", ",", "\n", "beta1", "=", "params", ".", "adam_beta1", ",", "\n", "beta2", "=", "params", ".", "adam_beta2", ",", "\n", "epsilon", "=", "params", ".", "adam_epsilon", ")", "\n", "", "else", ":", "\n", "            ", "raise", "RuntimeError", "(", "\"Optimizer %s not supported\"", "%", "params", ".", "optimizer", ")", "\n", "\n", "", "loss", ",", "ops", "=", "optimize", ".", "create_train_op", "(", "loss", ",", "opt", ",", "global_step", ",", "params", ")", "\n", "restore_op", "=", "restore_variables", "(", "args", ".", "checkpoint", ")", "\n", "\n", "# Validation", "\n", "if", "params", ".", "validation", "and", "params", ".", "references", "[", "0", "]", ":", "\n", "            ", "files", "=", "[", "params", ".", "validation", "]", "+", "list", "(", "params", ".", "references", ")", "\n", "eval_inputs", "=", "dataset", ".", "sort_and_zip_files", "(", "files", ")", "\n", "eval_input_fn", "=", "dataset", ".", "get_evaluation_input", "\n", "", "else", ":", "\n", "            ", "eval_input_fn", "=", "None", "\n", "\n", "# Add hooks", "\n", "", "save_vars", "=", "tf", ".", "trainable_variables", "(", ")", "+", "[", "global_step", "]", "\n", "saver", "=", "tf", ".", "train", ".", "Saver", "(", "\n", "var_list", "=", "save_vars", "if", "params", ".", "only_save_trainable", "else", "None", ",", "\n", "max_to_keep", "=", "params", ".", "keep_checkpoint_max", ",", "\n", "sharded", "=", "False", "\n", ")", "\n", "tf", ".", "add_to_collection", "(", "tf", ".", "GraphKeys", ".", "SAVERS", ",", "saver", ")", "\n", "\n", "multiplier", "=", "tf", ".", "convert_to_tensor", "(", "[", "update_cycle", ",", "1", "]", ")", "\n", "\n", "train_hooks", "=", "[", "\n", "tf", ".", "train", ".", "StopAtStepHook", "(", "last_step", "=", "params", ".", "train_steps", ")", ",", "\n", "tf", ".", "train", ".", "NanTensorHook", "(", "loss", ")", ",", "\n", "tf", ".", "train", ".", "LoggingTensorHook", "(", "\n", "{", "\n", "\"step\"", ":", "global_step", ",", "\n", "\"loss\"", ":", "loss", ",", "\n", "\"source\"", ":", "tf", ".", "shape", "(", "features", "[", "\"source\"", "]", ")", "*", "multiplier", ",", "\n", "\"target\"", ":", "tf", ".", "shape", "(", "features", "[", "\"target\"", "]", ")", "*", "multiplier", "\n", "}", ",", "\n", "every_n_iter", "=", "1", "\n", ")", ",", "\n", "tf", ".", "train", ".", "CheckpointSaverHook", "(", "\n", "checkpoint_dir", "=", "params", ".", "output", ",", "\n", "save_secs", "=", "params", ".", "save_checkpoint_secs", "or", "None", ",", "\n", "save_steps", "=", "params", ".", "save_checkpoint_steps", "or", "None", ",", "\n", "saver", "=", "saver", "\n", ")", "\n", "]", "\n", "\n", "config", "=", "session_config", "(", "params", ")", "\n", "\n", "if", "eval_input_fn", "is", "not", "None", ":", "\n", "            ", "train_hooks", ".", "append", "(", "\n", "hooks", ".", "EvaluationHook", "(", "\n", "lambda", "f", ":", "inference", ".", "create_inference_graph", "(", "\n", "[", "model", "]", ",", "f", ",", "params", "\n", ")", ",", "\n", "lambda", ":", "eval_input_fn", "(", "eval_inputs", ",", "params", ")", ",", "\n", "lambda", "x", ":", "decode_target_ids", "(", "x", ",", "params", ")", ",", "\n", "params", ".", "output", ",", "\n", "config", ",", "\n", "params", ".", "keep_top_checkpoint_max", ",", "\n", "eval_secs", "=", "params", ".", "eval_secs", ",", "\n", "eval_steps", "=", "params", ".", "eval_steps", "\n", ")", "\n", ")", "\n", "\n", "# def restore_fn(step_context):", "\n", "#     step_context.session.run(restore_op)", "\n", "\n", "# def step_fn(step_context):", "\n", "#     # Bypass hook calls", "\n", "#     step_context.session.run([init_op, ops[\"zero_op\"]])", "\n", "#     for i in range(update_cycle - 1):", "\n", "#         step_context.session.run(ops[\"collect_op\"])", "\n", "\n", "#     return step_context.run_with_hooks(ops[\"train_op\"])", "\n", "\n", "# # Create session, do not use default CheckpointSaverHook", "\n", "# with tf.train.MonitoredTrainingSession(", "\n", "#         checkpoint_dir=params.output, hooks=train_hooks,", "\n", "#         save_checkpoint_secs=None, config=config) as sess:", "\n", "#     # Restore pre-trained variables", "\n", "#     sess.run_step_fn(restore_fn)", "\n", "\n", "#     while not sess.should_stop():", "\n", "#         sess.run_step_fn(step_fn)", "\n", "# Create session, do not use default CheckpointSaverHook", "\n", "", "with", "tf", ".", "train", ".", "MonitoredTrainingSession", "(", "\n", "checkpoint_dir", "=", "params", ".", "output", ",", "hooks", "=", "train_hooks", ",", "\n", "save_checkpoint_secs", "=", "None", ",", "config", "=", "config", ")", "as", "sess", ":", "\n", "\n", "            ", "sess", ".", "_tf_sess", "(", ")", ".", "run", "(", "restore_op", ")", "\n", "\n", "while", "not", "sess", ".", "should_stop", "(", ")", ":", "\n", "                ", "sess", ".", "_tf_sess", "(", ")", ".", "run", "(", "[", "init_op", ",", "ops", "[", "\"zero_op\"", "]", "]", ")", "\n", "for", "i", "in", "range", "(", "update_cycle", "-", "1", ")", ":", "\n", "                    ", "sess", ".", "_tf_sess", "(", ")", ".", "run", "(", "ops", "[", "\"collect_op\"", "]", ")", "\n", "\n", "", "sess", ".", "run", "(", "ops", "[", "\"train_op\"", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.parse_args": [[19, 57], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args"], ["def", "parse_args", "(", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", "\n", "description", "=", "\"Translate using existing NMT models\"", ",", "\n", "usage", "=", "\"translator.py [<args>] [-h | --help]\"", "\n", ")", "\n", "\n", "# input files", "\n", "parser", ".", "add_argument", "(", "\"--input\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "nargs", "=", "2", ",", "\n", "help", "=", "\"Path of input file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--side\"", ",", "type", "=", "str", ",", "default", "=", "\"none\"", ",", "\n", "choices", "=", "(", "\"none\"", ",", "\"source_sentence\"", ",", "\"source_word\"", ",", "\n", "\"source_sentence_source_word\"", ",", "\n", "\"target_sentence\"", ",", "\"target_word\"", ")", ",", "\n", "help", "=", "\"Which side the confidence is added to\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--rv_file\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of output file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--mean_file\"", ",", "type", "=", "str", ",", "required", "=", "False", ",", "\n", "help", "=", "\"Path of mean file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--var_file\"", ",", "type", "=", "str", ",", "required", "=", "False", ",", "\n", "help", "=", "\"Path of var file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--sen_mean\"", ",", "type", "=", "str", ",", "required", "=", "False", ",", "\n", "help", "=", "\"Path of sentence mean file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--sen_var\"", ",", "type", "=", "str", ",", "required", "=", "False", ",", "\n", "help", "=", "\"Path of sentence var file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--sen_rv\"", ",", "type", "=", "str", ",", "required", "=", "False", ",", "\n", "help", "=", "\"Path of sentence rv file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--checkpoint\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of trained models\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--vocabulary\"", ",", "type", "=", "str", ",", "nargs", "=", "2", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of source and target vocabulary\"", ")", "\n", "\n", "# model and configuration", "\n", "parser", ".", "add_argument", "(", "\"--model\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Name of the model\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--parameters\"", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Additional hyper parameters\"", ")", "\n", "\n", "return", "parser", ".", "parse_args", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.default_parameters": [[59, 81], ["tensorflow.contrib.training.HParams"], "function", ["None"], ["", "def", "default_parameters", "(", ")", ":", "\n", "    ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", "\n", "input", "=", "None", ",", "\n", "vocabulary", "=", "None", ",", "\n", "model", "=", "None", ",", "\n", "# vocabulary specific", "\n", "pad", "=", "\"<pad>\"", ",", "\n", "bos", "=", "\"<bos>\"", ",", "\n", "eos", "=", "\"<eos>\"", ",", "\n", "unk", "=", "\"<unk>\"", ",", "\n", "mapping", "=", "None", ",", "\n", "append_eos", "=", "False", ",", "\n", "device_list", "=", "[", "0", "]", ",", "\n", "num_threads", "=", "6", ",", "\n", "decode_alpha", "=", "1.0", ",", "\n", "eval_batch_size", "=", "8", ",", "\n", "model_uncertainty", "=", "False", ",", "\n", "mu_sample_k", "=", "20", ",", "\n", "mu_parallel", "=", "False", "\n", ")", "\n", "\n", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.merge_parameters": [[83, 99], ["tensorflow.contrib.training.HParams", "params1.values().iteritems", "tf.contrib.training.HParams.values", "params2.values().iteritems", "tf.contrib.training.HParams.add_hparam", "params1.values", "params2.values", "setattr", "tf.contrib.training.HParams.add_hparam"], "function", ["None"], ["", "def", "merge_parameters", "(", "params1", ",", "params2", ")", ":", "\n", "    ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", ")", "\n", "\n", "for", "(", "k", ",", "v", ")", "in", "params1", ".", "values", "(", ")", ".", "iteritems", "(", ")", ":", "\n", "        ", "params", ".", "add_hparam", "(", "k", ",", "v", ")", "\n", "\n", "", "params_dict", "=", "params", ".", "values", "(", ")", "\n", "\n", "for", "(", "k", ",", "v", ")", "in", "params2", ".", "values", "(", ")", ".", "iteritems", "(", ")", ":", "\n", "        ", "if", "k", "in", "params_dict", ":", "\n", "# Override", "\n", "            ", "setattr", "(", "params", ",", "k", ",", "v", ")", "\n", "", "else", ":", "\n", "            ", "params", ".", "add_hparam", "(", "k", ",", "v", ")", "\n", "\n", "", "", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.import_params": [[101, 114], ["os.path.abspath", "os.path.join", "tensorflow.gfile.Exists", "tensorflow.gfile.Open", "tensorflow.logging.info", "fd.readline", "params.parse_json"], "function", ["None"], ["", "def", "import_params", "(", "model_dir", ",", "model_name", ",", "params", ")", ":", "\n", "    ", "model_dir", "=", "os", ".", "path", ".", "abspath", "(", "model_dir", ")", "\n", "m_name", "=", "os", ".", "path", ".", "join", "(", "model_dir", ",", "model_name", "+", "\".json\"", ")", "\n", "\n", "if", "not", "tf", ".", "gfile", ".", "Exists", "(", "m_name", ")", ":", "\n", "        ", "return", "params", "\n", "\n", "", "with", "tf", ".", "gfile", ".", "Open", "(", "m_name", ")", "as", "fd", ":", "\n", "        ", "tf", ".", "logging", ".", "info", "(", "\"Restoring model parameters from %s\"", "%", "m_name", ")", "\n", "json_str", "=", "fd", ".", "readline", "(", ")", "\n", "params", ".", "parse_json", "(", "json_str", ")", "\n", "\n", "", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.override_parameters": [[116, 146], ["thumt.process_vocabulary", "thumt.process_vocabulary", "params.parse", "thumt.load_vocabulary", "thumt.load_vocabulary", "thumt.get_control_mapping", "thumt.get_control_mapping"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.process_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.process_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.load_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.load_vocabulary", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.get_control_mapping", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.get_control_mapping"], ["", "def", "override_parameters", "(", "params", ",", "args", ")", ":", "\n", "    ", "if", "args", ".", "parameters", ":", "\n", "        ", "params", ".", "parse", "(", "args", ".", "parameters", ")", "\n", "", "params", ".", "side", "=", "args", ".", "side", "\n", "\n", "params", ".", "vocabulary", "=", "{", "\n", "\"source\"", ":", "vocabulary", ".", "load_vocabulary", "(", "args", ".", "vocabulary", "[", "0", "]", ")", ",", "\n", "\"target\"", ":", "vocabulary", ".", "load_vocabulary", "(", "args", ".", "vocabulary", "[", "1", "]", ")", "\n", "}", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", "=", "vocabulary", ".", "process_vocabulary", "(", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", ",", "params", "\n", ")", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", "=", "vocabulary", ".", "process_vocabulary", "(", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", ",", "params", "\n", ")", "\n", "\n", "control_symbols", "=", "[", "params", ".", "pad", ",", "params", ".", "bos", ",", "params", ".", "eos", ",", "params", ".", "unk", "]", "\n", "\n", "params", ".", "mapping", "=", "{", "\n", "\"source\"", ":", "vocabulary", ".", "get_control_mapping", "(", "\n", "params", ".", "vocabulary", "[", "\"source\"", "]", ",", "\n", "control_symbols", "\n", ")", ",", "\n", "\"target\"", ":", "vocabulary", ".", "get_control_mapping", "(", "\n", "params", ".", "vocabulary", "[", "\"target\"", "]", ",", "\n", "control_symbols", "\n", ")", "\n", "}", "\n", "\n", "return", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.session_config": [[148, 159], ["tensorflow.OptimizerOptions", "tensorflow.GraphOptions", "tensorflow.ConfigProto", "str"], "function", ["None"], ["", "def", "session_config", "(", "params", ")", ":", "\n", "    ", "optimizer_options", "=", "tf", ".", "OptimizerOptions", "(", "opt_level", "=", "tf", ".", "OptimizerOptions", ".", "L1", ",", "\n", "do_function_inlining", "=", "False", ")", "\n", "graph_options", "=", "tf", ".", "GraphOptions", "(", "optimizer_options", "=", "optimizer_options", ")", "\n", "config", "=", "tf", ".", "ConfigProto", "(", "allow_soft_placement", "=", "True", ",", "\n", "graph_options", "=", "graph_options", ")", "\n", "if", "params", ".", "device_list", ":", "\n", "        ", "device_str", "=", "\",\"", ".", "join", "(", "[", "str", "(", "i", ")", "for", "i", "in", "params", ".", "device_list", "]", ")", "\n", "config", ".", "gpu_options", ".", "visible_device_list", "=", "device_str", "\n", "\n", "", "return", "config", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.set_variables": [[161, 175], ["tensorflow.logging.debug", "list", "tensorflow.device", "tensorflow.assign", "ops.append", "name.split"], "function", ["None"], ["", "def", "set_variables", "(", "var_list", ",", "value_dict", ",", "prefix", ")", ":", "\n", "    ", "ops", "=", "[", "]", "\n", "for", "var", "in", "var_list", ":", "\n", "        ", "for", "name", "in", "value_dict", ":", "\n", "            ", "var_name", "=", "\"/\"", ".", "join", "(", "[", "prefix", "]", "+", "list", "(", "name", ".", "split", "(", "\"/\"", ")", "[", "1", ":", "]", ")", ")", "\n", "\n", "if", "var", ".", "name", "[", ":", "-", "2", "]", "==", "var_name", ":", "\n", "                ", "tf", ".", "logging", ".", "debug", "(", "\"restoring %s -> %s\"", "%", "(", "name", ",", "var", ".", "name", ")", ")", "\n", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "                    ", "op", "=", "tf", ".", "assign", "(", "var", ",", "value_dict", "[", "name", "]", ")", "\n", "ops", ".", "append", "(", "op", ")", "\n", "", "break", "\n", "\n", "", "", "", "return", "ops", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.read_files": [[177, 196], ["zip", "tensorflow.gfile.GFile", "enumerate", "fd.close", "range", "line.strip", "inputs[].append", "len"], "function", ["None"], ["", "def", "read_files", "(", "names", ")", ":", "\n", "    ", "inputs", "=", "[", "[", "]", "for", "_", "in", "range", "(", "len", "(", "names", ")", ")", "]", "\n", "files", "=", "[", "tf", ".", "gfile", ".", "GFile", "(", "name", ")", "for", "name", "in", "names", "]", "\n", "\n", "count", "=", "0", "\n", "\n", "for", "lines", "in", "zip", "(", "*", "files", ")", ":", "\n", "        ", "lines", "=", "[", "line", ".", "strip", "(", ")", "for", "line", "in", "lines", "]", "\n", "\n", "for", "i", ",", "line", "in", "enumerate", "(", "lines", ")", ":", "\n", "            ", "inputs", "[", "i", "]", ".", "append", "(", "line", ")", "\n", "\n", "", "count", "+=", "1", "\n", "\n", "# Close files", "\n", "", "for", "fd", "in", "files", ":", "\n", "        ", "fd", ".", "close", "(", ")", "\n", "\n", "", "return", "inputs", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.get_features": [[198, 259], ["tensorflow.device", "tensorflow.data.Dataset.zip", "dataset.map.map", "dataset.map.padded_batch", "dataset.map.make_one_shot_iterator", "dataset.make_one_shot_iterator.get_next", "tensorflow.contrib.lookup.index_table_from_tensor", "tensorflow.contrib.lookup.index_table_from_tensor", "tf.contrib.lookup.index_table_from_tensor.lookup", "tf.contrib.lookup.index_table_from_tensor.lookup", "tensorflow.data.Dataset.from_tensor_slices", "dataset.map.map", "dataset.map.map", "datasets.append", "tuple", "tensorflow.constant", "tensorflow.constant", "len", "tensorflow.concat", "tensorflow.Dimension", "tensorflow.Dimension", "tensorflow.string_split", "tensorflow.shape", "tensorflow.shape", "tensorflow.constant"], "function", ["None"], ["", "def", "get_features", "(", "inputs", ",", "params", ")", ":", "\n", "    ", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "# Create datasets", "\n", "        ", "datasets", "=", "[", "]", "\n", "\n", "for", "data", "in", "inputs", ":", "\n", "            ", "dataset", "=", "tf", ".", "data", ".", "Dataset", ".", "from_tensor_slices", "(", "data", ")", "\n", "# Split string", "\n", "dataset", "=", "dataset", ".", "map", "(", "lambda", "x", ":", "tf", ".", "string_split", "(", "[", "x", "]", ")", ".", "values", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", ")", "\n", "# Append <eos>", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "x", ":", "tf", ".", "concat", "(", "[", "x", ",", "[", "tf", ".", "constant", "(", "params", ".", "eos", ")", "]", "]", ",", "axis", "=", "0", ")", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "datasets", ".", "append", "(", "dataset", ")", "\n", "\n", "", "dataset", "=", "tf", ".", "data", ".", "Dataset", ".", "zip", "(", "tuple", "(", "datasets", ")", ")", "\n", "\n", "# Convert tuple to dictionary", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "*", "x", ":", "{", "\n", "\"source\"", ":", "x", "[", "0", "]", ",", "\n", "\"source_length\"", ":", "tf", ".", "shape", "(", "x", "[", "0", "]", ")", "[", "0", "]", ",", "\n", "\"target\"", ":", "x", "[", "1", "]", ",", "\n", "\"target_length\"", ":", "tf", ".", "shape", "(", "x", "[", "1", "]", ")", "[", "0", "]", "\n", "}", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "dataset", "=", "dataset", ".", "padded_batch", "(", "\n", "params", ".", "eval_batch_size", "*", "len", "(", "params", ".", "device_list", ")", ",", "\n", "{", "\n", "\"source\"", ":", "[", "tf", ".", "Dimension", "(", "None", ")", "]", ",", "\n", "\"source_length\"", ":", "[", "]", ",", "\n", "\"target\"", ":", "[", "tf", ".", "Dimension", "(", "None", ")", "]", ",", "\n", "\"target_length\"", ":", "[", "]", "\n", "}", ",", "\n", "{", "\n", "\"source\"", ":", "params", ".", "pad", ",", "\n", "\"source_length\"", ":", "0", ",", "\n", "\"target\"", ":", "params", ".", "pad", ",", "\n", "\"target_length\"", ":", "0", "\n", "}", "\n", ")", "\n", "\n", "iterator", "=", "dataset", ".", "make_one_shot_iterator", "(", ")", "\n", "features", "=", "iterator", ".", "get_next", "(", ")", "\n", "\n", "src_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"source\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "tgt_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"target\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "features", "[", "\"source\"", "]", "=", "src_table", ".", "lookup", "(", "features", "[", "\"source\"", "]", ")", "\n", "features", "[", "\"target\"", "]", "=", "tgt_table", ".", "lookup", "(", "features", "[", "\"target\"", "]", ")", "\n", "\n", "", "return", "features", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.main": [[261, 378], ["tensorflow.logging.set_verbosity", "thumt.get_model", "scorer.default_parameters", "scorer.merge_parameters", "scorer.import_params", "scorer.override_parameters", "models.get_model.get_parameters", "tensorflow.Graph().as_default", "models.get_model.", "scorer.read_files", "scorer.get_features", "model_cls.get_evaluation_func", "thumt.parallel_model", "tensorflow.train.ChiefSessionCreator", "tensorflow.logging.info", "tensorflow.train.list_variables", "tensorflow.train.load_checkpoint", "scorer.set_variables", "tensorflow.group", "tf.train.load_checkpoint.get_tensor", "tensorflow.trainable_variables", "models.get_model.get_name", "tensorflow.train.MonitoredSession", "sess.run", "tensorflow.gfile.Open", "tf.gfile.Open.close", "tensorflow.Graph", "scorer.session_config", "name.startswith", "tensorflow.gfile.Open", "tensorflow.gfile.Open", "tensorflow.gfile.Open", "tensorflow.gfile.Open", "tensorflow.gfile.Open", "sess.should_stop", "sess.run", "tensorflow.logging.log", "models.get_model.get_name", "list", "list", "list", "list", "list", "list", "list", "map", "enumerate", "itertools.chain", "list.append", "list.append", "list.append", "map.append", "list.append", "list.append", "list.append", "itertools.chain", "itertools.chain", "itertools.chain", "itertools.chain", "itertools.chain", "itertools.chain", "itertools.chain", "zip", "tf.gfile.Open.write", "tf.gfile.Open.write", "tf.gfile.Open.write", "tf.gfile.Open.write", "tf.gfile.Open.write", "tf.gfile.Open.write", "tf.gfile.Open.write", "result[].tolist", "result[].tolist", "result[].tolist", "result[].tolist", "result[].tolist", "result[].tolist", "result[].tolist", "tf.gfile.Open.write", "tf.gfile.Open.write", "tf.gfile.Open.write"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.__init__.get_model", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.default_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.merge_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.import_params", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.override_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_parameters", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.read_files", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.get_features", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_evaluation_func", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.parallel.parallel_model", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.set_variables", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_name", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.bin.scorer.session_config", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_name"], ["", "def", "main", "(", "args", ")", ":", "\n", "    ", "tf", ".", "logging", ".", "set_verbosity", "(", "tf", ".", "logging", ".", "INFO", ")", "\n", "model_cls", "=", "models", ".", "get_model", "(", "args", ".", "model", ")", "\n", "params", "=", "default_parameters", "(", ")", "\n", "\n", "# Import and override parameters", "\n", "# Priorities (low -> high):", "\n", "# default -> saved -> command", "\n", "params", "=", "merge_parameters", "(", "params", ",", "model_cls", ".", "get_parameters", "(", ")", ")", "\n", "params", "=", "import_params", "(", "args", ".", "checkpoint", ",", "args", ".", "model", ",", "params", ")", "\n", "override_parameters", "(", "params", ",", "args", ")", "\n", "\n", "# Build Graph", "\n", "with", "tf", ".", "Graph", "(", ")", ".", "as_default", "(", ")", ":", "\n", "        ", "model", "=", "model_cls", "(", "params", ")", "\n", "inputs", "=", "read_files", "(", "args", ".", "input", ")", "\n", "features", "=", "get_features", "(", "inputs", ",", "params", ")", "\n", "score_fn", "=", "model", ".", "get_evaluation_func", "(", ")", "\n", "# scores = score_fn(features, params)", "\n", "# Multi-GPU setting", "\n", "scores", "=", "parallel", ".", "parallel_model", "(", "\n", "score_fn", ",", "\n", "features", ",", "\n", "params", ".", "device_list", "\n", ")", "\n", "\n", "sess_creator", "=", "tf", ".", "train", ".", "ChiefSessionCreator", "(", "\n", "config", "=", "session_config", "(", "params", ")", "\n", ")", "\n", "\n", "# Load checkpoint", "\n", "tf", ".", "logging", ".", "info", "(", "\"Loading %s\"", "%", "args", ".", "checkpoint", ")", "\n", "var_list", "=", "tf", ".", "train", ".", "list_variables", "(", "args", ".", "checkpoint", ")", "\n", "values", "=", "{", "}", "\n", "reader", "=", "tf", ".", "train", ".", "load_checkpoint", "(", "args", ".", "checkpoint", ")", "\n", "\n", "for", "(", "name", ",", "shape", ")", "in", "var_list", ":", "\n", "            ", "if", "not", "name", ".", "startswith", "(", "model_cls", ".", "get_name", "(", ")", ")", ":", "\n", "                ", "continue", "\n", "\n", "", "tensor", "=", "reader", ".", "get_tensor", "(", "name", ")", "\n", "values", "[", "name", "]", "=", "tensor", "\n", "\n", "", "ops", "=", "set_variables", "(", "tf", ".", "trainable_variables", "(", ")", ",", "values", ",", "\n", "model_cls", ".", "get_name", "(", ")", ")", "\n", "assign_op", "=", "tf", ".", "group", "(", "*", "ops", ")", "\n", "\n", "# Create session", "\n", "fb", "=", "0", "\n", "with", "tf", ".", "train", ".", "MonitoredSession", "(", "session_creator", "=", "sess_creator", ")", "as", "sess", ":", "\n", "# Restore variables", "\n", "            ", "sess", ".", "run", "(", "assign_op", ")", "\n", "fd", "=", "tf", ".", "gfile", ".", "Open", "(", "args", ".", "rv_file", ",", "\"w\"", ")", "\n", "if", "params", ".", "model_uncertainty", ":", "\n", "                ", "fm", "=", "tf", ".", "gfile", ".", "Open", "(", "args", ".", "mean_file", ",", "'w'", ")", "\n", "fv", "=", "tf", ".", "gfile", ".", "Open", "(", "args", ".", "var_file", ",", "'w'", ")", "\n", "fsm", "=", "tf", ".", "gfile", ".", "Open", "(", "args", ".", "sen_mean", ",", "'w'", ")", "\n", "fsv", "=", "tf", ".", "gfile", ".", "Open", "(", "args", ".", "sen_var", ",", "'w'", ")", "\n", "fsr", "=", "tf", ".", "gfile", ".", "Open", "(", "args", ".", "sen_rv", ",", "'w'", ")", "\n", "\n", "", "while", "not", "sess", ".", "should_stop", "(", ")", ":", "\n", "                ", "results", "=", "sess", ".", "run", "(", "scores", ")", "\n", "fb", "+=", "1", "\n", "message", "=", "\"Finished batch %d\"", "%", "fb", "\n", "tf", ".", "logging", ".", "log", "(", "tf", ".", "logging", ".", "INFO", ",", "message", ")", "\n", "if", "params", ".", "model_uncertainty", ":", "\n", "                    ", "rv_score", "=", "[", "]", "\n", "mean_score", "=", "[", "]", "\n", "var_score", "=", "[", "]", "\n", "len_score", "=", "[", "]", "\n", "sen_mean", "=", "[", "]", "\n", "sen_var", "=", "[", "]", "\n", "sen_rv", "=", "[", "]", "\n", "for", "result", "in", "results", ":", "\n", "                        ", "rv_score", ".", "append", "(", "result", "[", "\"rv\"", "]", ".", "tolist", "(", ")", ")", "\n", "mean_score", ".", "append", "(", "result", "[", "\"mean\"", "]", ".", "tolist", "(", ")", ")", "\n", "var_score", ".", "append", "(", "result", "[", "\"var\"", "]", ".", "tolist", "(", ")", ")", "\n", "len_score", ".", "append", "(", "result", "[", "\"len\"", "]", ".", "tolist", "(", ")", ")", "\n", "sen_mean", ".", "append", "(", "result", "[", "\"sen_mean\"", "]", ".", "tolist", "(", ")", ")", "\n", "sen_var", ".", "append", "(", "result", "[", "\"sen_var\"", "]", ".", "tolist", "(", ")", ")", "\n", "sen_rv", ".", "append", "(", "result", "[", "\"sen_rv\"", "]", ".", "tolist", "(", ")", ")", "\n", "", "rv_score", "=", "list", "(", "itertools", ".", "chain", "(", "*", "rv_score", ")", ")", "\n", "mean_score", "=", "list", "(", "itertools", ".", "chain", "(", "*", "mean_score", ")", ")", "\n", "var_score", "=", "list", "(", "itertools", ".", "chain", "(", "*", "var_score", ")", ")", "\n", "len_score", "=", "list", "(", "itertools", ".", "chain", "(", "*", "len_score", ")", ")", "\n", "sen_mean", "=", "list", "(", "itertools", ".", "chain", "(", "*", "sen_mean", ")", ")", "\n", "sen_var", "=", "list", "(", "itertools", ".", "chain", "(", "*", "sen_var", ")", ")", "\n", "sen_rv", "=", "list", "(", "itertools", ".", "chain", "(", "*", "sen_rv", ")", ")", "\n", "\n", "# mean_score = results[\"mean\"]", "\n", "# var_score = results[\"var\"]", "\n", "# rv_score = results[\"rv\"]", "\n", "# len_score = results[\"len\"].tolist()", "\n", "len_score", "=", "map", "(", "int", ",", "len_score", ")", "\n", "\n", "for", "i", ",", "l", "in", "enumerate", "(", "len_score", ")", ":", "\n", "                        ", "m", "=", "mean_score", "[", "i", "]", "[", ":", "l", "]", "\n", "v", "=", "var_score", "[", "i", "]", "[", ":", "l", "]", "\n", "r", "=", "rv_score", "[", "i", "]", "[", ":", "l", "]", "\n", "for", "(", "i_m", ",", "i_v", ",", "i_r", ")", "in", "zip", "(", "m", ",", "v", ",", "r", ")", ":", "\n", "# fd.write('%f/%f/%f ' % (i_m, i_v, i_r))", "\n", "                            ", "fd", ".", "write", "(", "'%f '", "%", "i_r", ")", "\n", "fm", ".", "write", "(", "'%f '", "%", "i_m", ")", "\n", "fv", ".", "write", "(", "'%f '", "%", "i_v", ")", "\n", "", "fd", ".", "write", "(", "\"\\n\"", ")", "\n", "fm", ".", "write", "(", "\"\\n\"", ")", "\n", "fv", ".", "write", "(", "\"\\n\"", ")", "\n", "\n", "fsm", ".", "write", "(", "\"{}\\n\"", ".", "format", "(", "sen_mean", "[", "i", "]", ")", ")", "\n", "fsv", ".", "write", "(", "\"{}\\n\"", ".", "format", "(", "sen_var", "[", "i", "]", ")", ")", "\n", "fsr", ".", "write", "(", "\"{}\\n\"", ".", "format", "(", "sen_rv", "[", "i", "]", ")", ")", "\n", "", "", "else", ":", "\n", "                    ", "results", "=", "itertools", ".", "chain", "(", "*", "results", ")", "\n", "for", "value", "in", "results", ":", "\n", "                        ", "fd", ".", "write", "(", "\"%f\\n\"", "%", "value", ")", "\n", "\n", "", "", "", "fd", ".", "close", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.interface.model.NMTModel.__init__": [[12, 15], ["None"], "methods", ["None"], ["def", "__init__", "(", "self", ",", "params", ",", "scope", ")", ":", "\n", "        ", "self", ".", "_scope", "=", "scope", "\n", "self", ".", "_params", "=", "params", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.interface.model.NMTModel.get_training_func": [[16, 24], ["NotImplementedError"], "methods", ["None"], ["", "def", "get_training_func", "(", "self", ",", "initializer", ",", "regularizer", "=", "None", ")", ":", "\n", "        ", "\"\"\"\n        :param initializer: the initializer used to initialize the model\n        :param regularizer: the regularizer used for model regularization\n        :return: a function with the following signature:\n            (features, params, reuse) -> loss\n        \"\"\"", "\n", "raise", "NotImplementedError", "(", "\"Not implemented\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.interface.model.NMTModel.get_evaluation_func": [[25, 31], ["NotImplementedError"], "methods", ["None"], ["", "def", "get_evaluation_func", "(", "self", ")", ":", "\n", "        ", "\"\"\"\n        :return: a function with the following signature:\n            (features, params) -> score\n        \"\"\"", "\n", "raise", "NotImplementedError", "(", "\"Not implemented\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.interface.model.NMTModel.get_inference_func": [[32, 51], ["NotImplementedError"], "methods", ["None"], ["", "def", "get_inference_func", "(", "self", ")", ":", "\n", "        ", "\"\"\"\n        :returns:\n            If a model implements incremental decoding, this function should\n            returns a tuple of (encoding_fn, decoding_fn), with the following\n            requirements:\n                encoding_fn: (features, params) -> initial_state\n                decoding_fn: (feature, state, params) -> log_prob, next_state\n\n            If a model does not implement the incremental decoding (slower\n            decoding speed but easier to write the code), then this\n            function should returns a single function with the following\n            signature:\n                (features, params) -> log_prob\n\n            See models/transformer.py and models/rnnsearch.py\n            for comparison.\n        \"\"\"", "\n", "raise", "NotImplementedError", "(", "\"Not implemented\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.interface.model.NMTModel.get_name": [[52, 55], ["NotImplementedError"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_name", "(", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", "\"Not implemented\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.interface.model.NMTModel.get_parameters": [[56, 59], ["NotImplementedError"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_parameters", "(", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", "\"Not implemented\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.interface.model.NMTModel.parameters": [[60, 63], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "parameters", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_params", "\n", "", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.LegacyGRUCell.__init__": [[22, 25], ["super().__init__"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["def", "__init__", "(", "self", ",", "num_units", ",", "reuse", "=", "None", ")", ":", "\n", "        ", "super", "(", "LegacyGRUCell", ",", "self", ")", ".", "__init__", "(", "_reuse", "=", "reuse", ")", "\n", "self", ".", "_num_units", "=", "num_units", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.LegacyGRUCell.__call__": [[26, 44], ["tensorflow.variable_scope", "tensorflow.nn.sigmoid", "tensorflow.nn.sigmoid", "nn.linear", "isinstance", "list", "nn.linear", "nn.linear", "list", "tensorflow.tanh"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear"], ["", "def", "__call__", "(", "self", ",", "inputs", ",", "state", ",", "scope", "=", "None", ")", ":", "\n", "        ", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"gru_cell\"", ",", "\n", "values", "=", "[", "inputs", ",", "state", "]", ")", ":", "\n", "            ", "if", "not", "isinstance", "(", "inputs", ",", "(", "list", ",", "tuple", ")", ")", ":", "\n", "                ", "inputs", "=", "[", "inputs", "]", "\n", "\n", "", "all_inputs", "=", "list", "(", "inputs", ")", "+", "[", "state", "]", "\n", "r", "=", "tf", ".", "nn", ".", "sigmoid", "(", "linear", "(", "all_inputs", ",", "self", ".", "_num_units", ",", "False", ",", "False", ",", "\n", "scope", "=", "\"reset_gate\"", ")", ")", "\n", "u", "=", "tf", ".", "nn", ".", "sigmoid", "(", "linear", "(", "all_inputs", ",", "self", ".", "_num_units", ",", "False", ",", "False", ",", "\n", "scope", "=", "\"update_gate\"", ")", ")", "\n", "all_inputs", "=", "list", "(", "inputs", ")", "+", "[", "r", "*", "state", "]", "\n", "c", "=", "linear", "(", "all_inputs", ",", "self", ".", "_num_units", ",", "True", ",", "False", ",", "\n", "scope", "=", "\"candidate\"", ")", "\n", "\n", "new_state", "=", "(", "1.0", "-", "u", ")", "*", "state", "+", "u", "*", "tf", ".", "tanh", "(", "c", ")", "\n", "\n", "", "return", "new_state", ",", "new_state", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.LegacyGRUCell.state_size": [[45, 48], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "state_size", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_num_units", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.LegacyGRUCell.output_size": [[49, 52], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "output_size", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_num_units", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.StateToOutputWrapper.__init__": [[64, 67], ["super().__init__"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["def", "__init__", "(", "self", ",", "cell", ",", "reuse", "=", "None", ")", ":", "\n", "        ", "super", "(", "StateToOutputWrapper", ",", "self", ")", ".", "__init__", "(", "_reuse", "=", "reuse", ")", "\n", "self", ".", "_cell", "=", "cell", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.StateToOutputWrapper.__call__": [[68, 72], ["rnn_cell.StateToOutputWrapper._cell"], "methods", ["None"], ["", "def", "__call__", "(", "self", ",", "inputs", ",", "state", ",", "scope", "=", "None", ")", ":", "\n", "        ", "output", ",", "new_state", "=", "self", ".", "_cell", "(", "inputs", ",", "state", ",", "scope", "=", "scope", ")", "\n", "\n", "return", "(", "output", ",", "new_state", ")", ",", "new_state", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.StateToOutputWrapper.state_size": [[73, 76], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "state_size", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_cell", ".", "state_size", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.StateToOutputWrapper.output_size": [[77, 80], ["tuple"], "methods", ["None"], ["", "@", "property", "\n", "def", "output_size", "(", "self", ")", ":", "\n", "        ", "return", "tuple", "(", "[", "self", ".", "_cell", ".", "output_size", ",", "self", ".", "state_size", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.AttentionWrapper.__init__": [[97, 107], ["super().__init__", "memory.shape.assert_has_rank"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["def", "__init__", "(", "self", ",", "cell", ",", "memory", ",", "bias", ",", "attention_fn", ",", "output_weight", "=", "False", ",", "\n", "output_value", "=", "False", ",", "reuse", "=", "None", ")", ":", "\n", "        ", "super", "(", "AttentionWrapper", ",", "self", ")", ".", "__init__", "(", "_reuse", "=", "reuse", ")", "\n", "memory", ".", "shape", ".", "assert_has_rank", "(", "3", ")", "\n", "self", ".", "_cell", "=", "cell", "\n", "self", ".", "_memory", "=", "memory", "\n", "self", ".", "_bias", "=", "bias", "\n", "self", ".", "_attention_fn", "=", "attention_fn", "\n", "self", ".", "_output_weight", "=", "output_weight", "\n", "self", ".", "_output_value", "=", "output_value", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.AttentionWrapper.__call__": [[108, 126], ["rnn_cell.AttentionWrapper._attention_fn", "rnn_cell.AttentionWrapper._cell", "new_output.append", "new_output.append", "tuple"], "methods", ["None"], ["", "def", "__call__", "(", "self", ",", "inputs", ",", "state", ",", "scope", "=", "None", ")", ":", "\n", "        ", "outputs", "=", "self", ".", "_attention_fn", "(", "inputs", ",", "state", ",", "self", ".", "_memory", ",", "self", ".", "_bias", ")", "\n", "cell_inputs", ",", "cell_state", ",", "weight", ",", "value", "=", "outputs", "\n", "cell_output", ",", "new_state", "=", "self", ".", "_cell", "(", "cell_inputs", ",", "cell_state", ",", "\n", "scope", "=", "scope", ")", "\n", "\n", "if", "not", "self", ".", "_output_weight", "and", "not", "self", ".", "_output_value", ":", "\n", "            ", "return", "cell_output", ",", "new_state", "\n", "\n", "", "new_output", "=", "[", "cell_output", "]", "\n", "\n", "if", "self", ".", "_output_weight", ":", "\n", "            ", "new_output", ".", "append", "(", "weights", ")", "\n", "\n", "", "if", "self", ".", "_output_value", ":", "\n", "            ", "new_output", ".", "append", "(", "value", ")", "\n", "\n", "", "return", "tuple", "(", "new_output", ")", ",", "new_state", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.AttentionWrapper.state_size": [[127, 130], ["None"], "methods", ["None"], ["", "@", "property", "\n", "def", "state_size", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "_cell", ".", "state_size", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.rnn_cell.AttentionWrapper.output_size": [[131, 145], ["tuple", "new_output_size.append", "new_output_size.append"], "methods", ["None"], ["", "@", "property", "\n", "def", "output_size", "(", "self", ")", ":", "\n", "        ", "if", "not", "self", ".", "_output_weight", "and", "not", "self", ".", "_output_value", ":", "\n", "            ", "return", "self", ".", "_cell", ".", "output_size", "\n", "\n", "", "new_output_size", "=", "[", "self", ".", "_cell", ".", "output_size", "]", "\n", "\n", "if", "self", ".", "_output_weight", ":", "\n", "            ", "new_output_size", ".", "append", "(", "self", ".", "_memory", ".", "shape", "[", "1", "]", ")", "\n", "\n", "", "if", "self", ".", "_output_value", ":", "\n", "            ", "new_output_size", ".", "append", "(", "self", ".", "_memory", ".", "shape", "[", "2", "]", ".", "value", ")", "\n", "\n", "", "return", "tuple", "(", "new_output_size", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.add_timing_signal": [[14, 48], ["tensorflow.name_scope", "tensorflow.to_float", "tensorflow.concat", "tensorflow.pad", "tensorflow.reshape", "tensorflow.shape", "tensorflow.shape", "tensorflow.range", "math.log", "tensorflow.exp", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.to_float", "tensorflow.sin", "tensorflow.cos", "float", "float", "tensorflow.to_float", "tensorflow.mod", "tensorflow.range"], "function", ["None"], ["def", "add_timing_signal", "(", "x", ",", "min_timescale", "=", "1.0", ",", "max_timescale", "=", "1.0e4", ",", "name", "=", "None", ")", ":", "\n", "    ", "\"\"\"\n    This function adds a bunch of sinusoids of different frequencies to a\n    Tensor. See paper: `Attention is all you need'\n\n    :param x: A tensor with shape [batch, length, channels]\n    :param min_timescale: A floating point number\n    :param max_timescale: A floating point number\n    :param name: An optional string\n\n    :returns: a Tensor the same shape as x.\n    \"\"\"", "\n", "\n", "with", "tf", ".", "name_scope", "(", "name", ",", "default_name", "=", "\"add_timing_signal\"", ",", "values", "=", "[", "x", "]", ")", ":", "\n", "        ", "length", "=", "tf", ".", "shape", "(", "x", ")", "[", "1", "]", "\n", "channels", "=", "tf", ".", "shape", "(", "x", ")", "[", "2", "]", "\n", "position", "=", "tf", ".", "to_float", "(", "tf", ".", "range", "(", "length", ")", ")", "\n", "num_timescales", "=", "channels", "//", "2", "\n", "\n", "log_timescale_increment", "=", "(", "\n", "math", ".", "log", "(", "float", "(", "max_timescale", ")", "/", "float", "(", "min_timescale", ")", ")", "/", "\n", "(", "tf", ".", "to_float", "(", "num_timescales", ")", "-", "1", ")", "\n", ")", "\n", "inv_timescales", "=", "min_timescale", "*", "tf", ".", "exp", "(", "\n", "tf", ".", "to_float", "(", "tf", ".", "range", "(", "num_timescales", ")", ")", "*", "-", "log_timescale_increment", "\n", ")", "\n", "\n", "scaled_time", "=", "(", "tf", ".", "expand_dims", "(", "position", ",", "1", ")", "*", "\n", "tf", ".", "expand_dims", "(", "inv_timescales", ",", "0", ")", ")", "\n", "signal", "=", "tf", ".", "concat", "(", "[", "tf", ".", "sin", "(", "scaled_time", ")", ",", "tf", ".", "cos", "(", "scaled_time", ")", "]", ",", "axis", "=", "1", ")", "\n", "signal", "=", "tf", ".", "pad", "(", "signal", ",", "[", "[", "0", ",", "0", "]", ",", "[", "0", ",", "tf", ".", "mod", "(", "channels", ",", "2", ")", "]", "]", ")", "\n", "signal", "=", "tf", ".", "reshape", "(", "signal", ",", "[", "1", ",", "length", ",", "channels", "]", ")", "\n", "\n", "return", "x", "+", "signal", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.split_heads": [[50, 70], ["tensorflow.name_scope", "tensorflow.reshape", "tf.reshape.set_shape", "tensorflow.transpose", "x.get_shape", "tensorflow.concat", "tensorflow.shape", "range"], "function", ["None"], ["", "", "def", "split_heads", "(", "inputs", ",", "num_heads", ",", "name", "=", "None", ")", ":", "\n", "    ", "\"\"\" Split heads\n    :param inputs: A tensor with shape [batch, ..., channels]\n    :param num_heads: An integer\n    :param name: An optional string\n    :returns: A tensor with shape [batch, heads, ..., channels / heads]\n    \"\"\"", "\n", "\n", "with", "tf", ".", "name_scope", "(", "name", ",", "default_name", "=", "\"split_heads\"", ",", "values", "=", "[", "inputs", "]", ")", ":", "\n", "        ", "x", "=", "inputs", "\n", "n", "=", "num_heads", "\n", "old_shape", "=", "x", ".", "get_shape", "(", ")", ".", "dims", "\n", "ndims", "=", "x", ".", "shape", ".", "ndims", "\n", "\n", "last", "=", "old_shape", "[", "-", "1", "]", "\n", "new_shape", "=", "old_shape", "[", ":", "-", "1", "]", "+", "[", "n", "]", "+", "[", "last", "//", "n", "if", "last", "else", "None", "]", "\n", "ret", "=", "tf", ".", "reshape", "(", "x", ",", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "x", ")", "[", ":", "-", "1", "]", ",", "[", "n", ",", "-", "1", "]", "]", ",", "0", ")", ")", "\n", "ret", ".", "set_shape", "(", "new_shape", ")", "\n", "perm", "=", "[", "0", ",", "ndims", "-", "1", "]", "+", "[", "i", "for", "i", "in", "range", "(", "1", ",", "ndims", "-", "1", ")", "]", "+", "[", "ndims", "]", "\n", "return", "tf", ".", "transpose", "(", "ret", ",", "perm", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.combine_heads": [[72, 89], ["tensorflow.name_scope", "tensorflow.transpose", "tensorflow.reshape", "tf.reshape.set_shape", "tf.reshape.get_shape", "tensorflow.concat", "tensorflow.shape"], "function", ["None"], ["", "", "def", "combine_heads", "(", "inputs", ",", "name", "=", "None", ")", ":", "\n", "    ", "\"\"\" Combine heads\n    :param inputs: A tensor with shape [batch, heads, length, channels]\n    :param name: An optional string\n    :returns: A tensor with shape [batch, length, heads * channels]\n    \"\"\"", "\n", "\n", "with", "tf", ".", "name_scope", "(", "name", ",", "default_name", "=", "\"combine_heads\"", ",", "values", "=", "[", "inputs", "]", ")", ":", "\n", "        ", "x", "=", "inputs", "\n", "x", "=", "tf", ".", "transpose", "(", "x", ",", "[", "0", ",", "2", ",", "1", ",", "3", "]", ")", "\n", "old_shape", "=", "x", ".", "get_shape", "(", ")", ".", "dims", "\n", "a", ",", "b", "=", "old_shape", "[", "-", "2", ":", "]", "\n", "new_shape", "=", "old_shape", "[", ":", "-", "2", "]", "+", "[", "a", "*", "b", "if", "a", "and", "b", "else", "None", "]", "\n", "x", "=", "tf", ".", "reshape", "(", "x", ",", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "x", ")", "[", ":", "-", "2", "]", ",", "[", "-", "1", "]", "]", ",", "0", ")", ")", "\n", "x", ".", "set_shape", "(", "new_shape", ")", "\n", "\n", "return", "x", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_bias": [[91, 132], ["tensorflow.name_scope", "tensorflow.matrix_band_part", "tensorflow.reshape", "tensorflow.ones", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.to_float", "tensorflow.expand_dims", "tensorflow.range", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.where", "tensorflow.cast", "tensorflow.matrix_band_part", "tensorflow.reshape", "ValueError", "tensorflow.ones", "tensorflow.matrix_band_part", "tensorflow.log", "tensorflow.ones", "tensorflow.abs"], "function", ["None"], ["", "", "def", "attention_bias", "(", "inputs", ",", "mode", ",", "inf", "=", "-", "1e9", ",", "name", "=", "None", ")", ":", "\n", "    ", "\"\"\" A bias tensor used in attention mechanism\n    :param inputs: A tensor\n    :param mode: one of \"causal\", \"masking\", \"proximal\" or \"distance\"\n    :param inf: A floating value\n    :param name: optional string\n    :returns: A 4D tensor with shape [batch, heads, queries, memories]\n    \"\"\"", "\n", "\n", "with", "tf", ".", "name_scope", "(", "name", ",", "default_name", "=", "\"attention_bias\"", ",", "values", "=", "[", "inputs", "]", ")", ":", "\n", "        ", "if", "mode", "==", "\"causal\"", ":", "\n", "            ", "length", "=", "inputs", "\n", "lower_triangle", "=", "tf", ".", "matrix_band_part", "(", "\n", "tf", ".", "ones", "(", "[", "length", ",", "length", "]", ")", ",", "-", "1", ",", "0", "\n", ")", "\n", "ret", "=", "inf", "*", "(", "1.0", "-", "lower_triangle", ")", "\n", "return", "tf", ".", "reshape", "(", "ret", ",", "[", "1", ",", "1", ",", "length", ",", "length", "]", ")", "\n", "", "elif", "mode", "==", "\"masking\"", ":", "\n", "            ", "mask", "=", "inputs", "\n", "ret", "=", "(", "1.0", "-", "mask", ")", "*", "inf", "\n", "return", "tf", ".", "expand_dims", "(", "tf", ".", "expand_dims", "(", "ret", ",", "1", ")", ",", "1", ")", "\n", "", "elif", "mode", "==", "\"proximal\"", ":", "\n", "            ", "length", "=", "inputs", "\n", "r", "=", "tf", ".", "to_float", "(", "tf", ".", "range", "(", "length", ")", ")", "\n", "diff", "=", "tf", ".", "expand_dims", "(", "r", ",", "0", ")", "-", "tf", ".", "expand_dims", "(", "r", ",", "1", ")", "\n", "m", "=", "tf", ".", "expand_dims", "(", "tf", ".", "expand_dims", "(", "-", "tf", ".", "log", "(", "1", "+", "tf", ".", "abs", "(", "diff", ")", ")", ",", "0", ")", ",", "0", ")", "\n", "return", "m", "\n", "", "elif", "mode", "==", "\"distance\"", ":", "\n", "            ", "length", ",", "distance", "=", "inputs", "\n", "distance", "=", "tf", ".", "where", "(", "distance", ">", "length", ",", "0", ",", "distance", ")", "\n", "distance", "=", "tf", ".", "cast", "(", "distance", ",", "tf", ".", "int64", ")", "\n", "lower_triangle", "=", "tf", ".", "matrix_band_part", "(", "\n", "tf", ".", "ones", "(", "[", "length", ",", "length", "]", ")", ",", "-", "1", ",", "0", "\n", ")", "\n", "mask_triangle", "=", "1.0", "-", "tf", ".", "matrix_band_part", "(", "\n", "tf", ".", "ones", "(", "[", "length", ",", "length", "]", ")", ",", "distance", "-", "1", ",", "0", "\n", ")", "\n", "ret", "=", "inf", "*", "(", "1.0", "-", "lower_triangle", "+", "mask_triangle", ")", "\n", "return", "tf", ".", "reshape", "(", "ret", ",", "[", "1", ",", "1", ",", "length", ",", "length", "]", ")", "\n", "", "else", ":", "\n", "            ", "raise", "ValueError", "(", "\"Unknown mode %s\"", "%", "mode", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.should_generate_summaries": [[134, 143], ["tensorflow.contrib.framework.get_name_scope", "tensorflow.get_variable_scope"], "function", ["None"], ["", "", "", "def", "should_generate_summaries", "(", ")", ":", "\n", "    ", "\"\"\"Is this an appropriate context to generate summaries.\n    :returns: a boolean\n    \"\"\"", "\n", "if", "\"while/\"", "in", "tf", ".", "contrib", ".", "framework", ".", "get_name_scope", "(", ")", ":", "\n", "        ", "return", "False", "\n", "", "if", "tf", ".", "get_variable_scope", "(", ")", ".", "reuse", ":", "\n", "        ", "return", "False", "\n", "", "return", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_image_summary": [[145, 174], ["tensorflow.shape", "tensorflow.summary.image", "tensorflow.transpose", "tensorflow.pow", "tensorflow.pad", "tensorflow.shape", "tensorflow.reshape", "tensorflow.reduce_max", "tensorflow.reshape", "tensorflow.mod"], "function", ["None"], ["", "def", "attention_image_summary", "(", "weights", ",", "rgb", "=", "True", ")", ":", "\n", "    ", "\"\"\"Compute attention image summary.\n    :param weights: a Tensor with shape [batch, heads, queries, memories]\n    :param rgb: use RGB color to represent a head\n    \"\"\"", "\n", "shape", "=", "tf", ".", "shape", "(", "weights", ")", "\n", "batch_size", "=", "shape", "[", "0", "]", "\n", "num_heads", "=", "shape", "[", "1", "]", "\n", "num_queries", "=", "shape", "[", "2", "]", "\n", "num_memories", "=", "shape", "[", "3", "]", "\n", "\n", "if", "rgb", ":", "\n", "# [batch, queries, memories, heads]", "\n", "        ", "image", "=", "tf", ".", "transpose", "(", "weights", ",", "[", "0", ",", "2", ",", "3", ",", "1", "]", ")", "\n", "# for high-dynamic-range", "\n", "image", "=", "tf", ".", "pow", "(", "image", ",", "0.2", ")", "\n", "# Each head will correspond to one of RGB", "\n", "image", "=", "tf", ".", "pad", "(", "image", ",", "[", "[", "0", ",", "0", "]", ",", "[", "0", ",", "0", "]", ",", "[", "0", ",", "0", "]", ",", "\n", "[", "0", ",", "tf", ".", "mod", "(", "-", "num_heads", ",", "3", ")", "]", "]", ")", "\n", "shape", "=", "tf", ".", "shape", "(", "image", ")", "\n", "# [batch, queries, memories, 3, heads]", "\n", "image", "=", "tf", ".", "reshape", "(", "image", ",", "[", "batch_size", ",", "num_queries", ",", "num_memories", ",", "\n", "3", ",", "shape", "[", "-", "1", "]", "//", "3", "]", ")", "\n", "image", "=", "tf", ".", "reduce_max", "(", "image", ",", "4", ")", "\n", "", "else", ":", "\n", "        ", "image", "=", "tf", ".", "reshape", "(", "weights", ",", "[", "-", "1", ",", "num_queries", ",", "num_memories", ",", "1", "]", ")", "\n", "\n", "# [batch, height, width, channel]", "\n", "", "tf", ".", "summary", ".", "image", "(", "\"attention\"", ",", "image", ",", "max_outputs", "=", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention": [[176, 227], ["tensorflow.variable_scope", "tensorflow.shape", "thumt.layers.nn.linear", "tensorflow.reshape", "tensorflow.tanh", "tensorflow.reshape", "thumt.layers.nn.linear", "tensorflow.reshape", "tensorflow.nn.softmax", "memories.get_shape().as_list", "tensorflow.reshape", "thumt.layers.nn.linear", "tensorflow.reduce_sum", "memories.get_shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear"], ["", "def", "attention", "(", "query", ",", "memories", ",", "bias", ",", "hidden_size", ",", "cache", "=", "None", ",", "reuse", "=", "None", ",", "\n", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "\"\"\" Standard attention layer\n\n    :param query: A tensor with shape [batch, key_size]\n    :param memories: A tensor with shape [batch, memory_size, key_size]\n    :param bias: A tensor with shape [batch, memory_size]\n    :param hidden_size: An integer\n    :param cache: A dictionary of precomputed value\n    :param reuse: A boolean value, whether to reuse the scope\n    :param dtype: An optional instance of tf.DType\n    :param scope: An optional string, the scope of this layer\n    :return: A tensor with shape [batch, value_size] and\n        a Tensor with shape [batch, memory_size]\n    \"\"\"", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "scope", "or", "\"attention\"", ",", "reuse", "=", "reuse", ",", "\n", "values", "=", "[", "query", ",", "memories", ",", "bias", "]", ",", "dtype", "=", "dtype", ")", ":", "\n", "        ", "mem_shape", "=", "tf", ".", "shape", "(", "memories", ")", "\n", "key_size", "=", "memories", ".", "get_shape", "(", ")", ".", "as_list", "(", ")", "[", "-", "1", "]", "\n", "\n", "if", "cache", "is", "None", ":", "\n", "            ", "k", "=", "tf", ".", "reshape", "(", "memories", ",", "[", "-", "1", ",", "key_size", "]", ")", "\n", "k", "=", "linear", "(", "k", ",", "hidden_size", ",", "False", ",", "False", ",", "scope", "=", "\"k_transform\"", ")", "\n", "\n", "if", "query", "is", "None", ":", "\n", "                ", "return", "{", "\"key\"", ":", "k", "}", "\n", "", "", "else", ":", "\n", "            ", "k", "=", "cache", "[", "\"key\"", "]", "\n", "\n", "", "q", "=", "linear", "(", "query", ",", "hidden_size", ",", "False", ",", "False", ",", "scope", "=", "\"q_transform\"", ")", "\n", "k", "=", "tf", ".", "reshape", "(", "k", ",", "[", "mem_shape", "[", "0", "]", ",", "mem_shape", "[", "1", "]", ",", "hidden_size", "]", ")", "\n", "\n", "hidden", "=", "tf", ".", "tanh", "(", "q", "[", ":", ",", "None", ",", ":", "]", "+", "k", ")", "\n", "hidden", "=", "tf", ".", "reshape", "(", "hidden", ",", "[", "-", "1", ",", "hidden_size", "]", ")", "\n", "\n", "# Shape: [batch, mem_size, 1]", "\n", "logits", "=", "linear", "(", "hidden", ",", "1", ",", "False", ",", "False", ",", "scope", "=", "\"logits\"", ")", "\n", "logits", "=", "tf", ".", "reshape", "(", "logits", ",", "[", "-", "1", ",", "mem_shape", "[", "1", "]", "]", ")", "\n", "\n", "if", "bias", "is", "not", "None", ":", "\n", "            ", "logits", "=", "logits", "+", "bias", "\n", "\n", "", "alpha", "=", "tf", ".", "nn", ".", "softmax", "(", "logits", ")", "\n", "\n", "outputs", "=", "{", "\n", "\"value\"", ":", "tf", ".", "reduce_sum", "(", "alpha", "[", ":", ",", ":", ",", "None", "]", "*", "memories", ",", "axis", "=", "1", ")", ",", "\n", "\"weight\"", ":", "alpha", "\n", "}", "\n", "\n", "", "return", "outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.additive_attention": [[229, 282], ["tensorflow.variable_scope", "tensorflow.tile", "tensorflow.tile", "tensorflow.squeeze", "tensorflow.nn.softmax", "tensorflow.matmul", "tensorflow.shape", "tensorflow.shape", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.tanh", "thumt.layers.nn.linear", "thumt.layers.nn.linear", "tensorflow.tanh", "thumt.layers.nn.linear", "tensorflow.nn.dropout", "thumt.layers.nn.linear", "tensorflow.concat"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear"], ["", "def", "additive_attention", "(", "queries", ",", "keys", ",", "values", ",", "bias", ",", "hidden_size", ",", "concat", "=", "False", ",", "\n", "keep_prob", "=", "None", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "\"\"\" Additive attention mechanism. This layer is implemented using a\n        one layer feed forward neural network\n\n    :param queries: A tensor with shape [batch, heads, length_q, depth_k]\n    :param keys: A tensor with shape [batch, heads, length_kv, depth_k]\n    :param values: A tensor with shape [batch, heads, length_kv, depth_v]\n    :param bias: A tensor\n    :param hidden_size: An integer\n    :param concat: A boolean value. If ``concat'' is set to True, then\n        the computation of attention mechanism is following $tanh(W[q, k])$.\n        When ``concat'' is set to False, the computation is following\n        $tanh(Wq + Vk)$\n    :param keep_prob: a scalar in [0, 1]\n    :param dtype: An optional instance of tf.DType\n    :param scope: An optional string, the scope of this layer\n\n    :returns: A dict with the following keys:\n        weights: A tensor with shape [batch, length_q]\n        outputs: A tensor with shape [batch, length_q, depth_v]\n    \"\"\"", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"additive_attention\"", ",", "\n", "values", "=", "[", "queries", ",", "keys", ",", "values", ",", "bias", "]", ",", "dtype", "=", "dtype", ")", ":", "\n", "        ", "length_q", "=", "tf", ".", "shape", "(", "queries", ")", "[", "2", "]", "\n", "length_kv", "=", "tf", ".", "shape", "(", "keys", ")", "[", "2", "]", "\n", "q", "=", "tf", ".", "tile", "(", "tf", ".", "expand_dims", "(", "queries", ",", "3", ")", ",", "[", "1", ",", "1", ",", "1", ",", "length_kv", ",", "1", "]", ")", "\n", "k", "=", "tf", ".", "tile", "(", "tf", ".", "expand_dims", "(", "keys", ",", "2", ")", ",", "[", "1", ",", "1", ",", "length_q", ",", "1", ",", "1", "]", ")", "\n", "\n", "if", "concat", ":", "\n", "            ", "combined", "=", "tf", ".", "tanh", "(", "linear", "(", "tf", ".", "concat", "(", "[", "q", ",", "k", "]", ",", "axis", "=", "-", "1", ")", ",", "hidden_size", ",", "\n", "True", ",", "True", ",", "name", "=", "\"qk_transform\"", ")", ")", "\n", "", "else", ":", "\n", "            ", "q", "=", "linear", "(", "queries", ",", "hidden_size", ",", "True", ",", "True", ",", "name", "=", "\"q_transform\"", ")", "\n", "k", "=", "linear", "(", "keys", ",", "hidden_size", ",", "True", ",", "True", ",", "name", "=", "\"key_transform\"", ")", "\n", "combined", "=", "tf", ".", "tanh", "(", "q", "+", "k", ")", "\n", "\n", "# shape: [batch, heads, length_q, length_kv]", "\n", "", "logits", "=", "tf", ".", "squeeze", "(", "linear", "(", "combined", ",", "1", ",", "True", ",", "True", ",", "name", "=", "\"logits\"", ")", ",", "\n", "axis", "=", "-", "1", ")", "\n", "\n", "if", "bias", "is", "not", "None", ":", "\n", "            ", "logits", "+=", "bias", "\n", "\n", "", "weights", "=", "tf", ".", "nn", ".", "softmax", "(", "logits", ",", "name", "=", "\"attention_weights\"", ")", "\n", "\n", "if", "keep_prob", "or", "keep_prob", "<", "1.0", ":", "\n", "            ", "weights", "=", "tf", ".", "nn", ".", "dropout", "(", "weights", ",", "keep_prob", ")", "\n", "\n", "", "outputs", "=", "tf", ".", "matmul", "(", "weights", ",", "values", ")", "\n", "\n", "return", "{", "\"weights\"", ":", "weights", ",", "\"outputs\"", ":", "outputs", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.multiplicative_attention": [[284, 326], ["tensorflow.name_scope", "tensorflow.matmul", "tensorflow.nn.softmax", "tensorflow.matmul", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.ones_like", "tensorflow.tile", "tensorflow.tile", "tensorflow.concat", "tensorflow.nn.dropout"], "function", ["None"], ["", "", "def", "multiplicative_attention", "(", "queries", ",", "keys", ",", "values", ",", "bias", ",", "keep_prob", "=", "None", ",", "\n", "confidence", "=", "None", ",", "nhead", "=", "8", ",", "chead", "=", "8", ",", "name", "=", "None", ")", ":", "\n", "    ", "\"\"\" Multiplicative attention mechanism. This layer is implemented using\n        dot-product operation.\n\n    :param queries: A tensor with shape [batch, heads, length_q, depth_k]\n    :param keys: A tensor with shape [batch, heads, length_kv, depth_k]\n    :param values: A tensor with shape [batch, heads, length_kv, depth_v]\n    :param bias: A tensor\n    :param keep_prob: a scalar in (0, 1]\n    :param confidence: A tensor with shape [batch, length_kv]\n    :param name: the name of this operation\n\n    :returns: A dict with the following keys:\n        weights: A tensor with shape [batch, heads, length_q, length_kv]\n        outputs: A tensor with shape [batch, heads, length_q, depth_v]\n    \"\"\"", "\n", "\n", "with", "tf", ".", "name_scope", "(", "name", ",", "default_name", "=", "\"multiplicative_attention\"", ",", "\n", "values", "=", "[", "queries", ",", "keys", ",", "values", ",", "bias", "]", ")", ":", "\n", "# shape: [batch, heads, length_q, length_kv]", "\n", "        ", "logits", "=", "tf", ".", "matmul", "(", "queries", ",", "keys", ",", "transpose_b", "=", "True", ")", "\n", "\n", "if", "bias", "is", "not", "None", ":", "\n", "            ", "logits", "+=", "bias", "\n", "\n", "", "weights", "=", "tf", ".", "nn", ".", "softmax", "(", "logits", ",", "name", "=", "\"attention_weights\"", ")", "\n", "if", "confidence", "is", "not", "None", ":", "\n", "            ", "temp_cf", "=", "tf", ".", "expand_dims", "(", "confidence", ",", "1", ")", "\n", "temp_cf", "=", "tf", ".", "expand_dims", "(", "temp_cf", ",", "1", ")", "\n", "none_cf", "=", "tf", ".", "ones_like", "(", "temp_cf", ")", "\n", "temp_cf", "=", "tf", ".", "tile", "(", "temp_cf", ",", "[", "1", ",", "chead", ",", "1", ",", "1", "]", ")", "\n", "none_cf", "=", "tf", ".", "tile", "(", "none_cf", ",", "[", "1", ",", "nhead", "-", "chead", ",", "1", ",", "1", "]", ")", "\n", "temp_cf", "=", "tf", ".", "concat", "(", "[", "temp_cf", ",", "none_cf", "]", ",", "1", ")", "\n", "weights", "=", "weights", "*", "temp_cf", "\n", "\n", "", "if", "keep_prob", "is", "not", "None", "and", "keep_prob", "<", "1.0", ":", "\n", "            ", "weights", "=", "tf", ".", "nn", ".", "dropout", "(", "weights", ",", "keep_prob", ")", "\n", "\n", "", "outputs", "=", "tf", ".", "matmul", "(", "weights", ",", "values", ")", "\n", "\n", "return", "{", "\"weights\"", ":", "weights", ",", "\"outputs\"", ":", "outputs", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.multihead_attention": [[328, 417], ["ValueError", "ValueError", "tensorflow.variable_scope", "attention.split_heads", "attention.split_heads", "attention.split_heads", "attention.multiplicative_attention", "attention.combine_heads", "thumt.layers.nn.linear", "tensorflow.split", "thumt.layers.nn.linear", "thumt.layers.nn.linear", "tensorflow.split", "thumt.layers.nn.linear", "attention.should_generate_summaries", "attention.attention_image_summary", "tensorflow.concat", "tensorflow.concat"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.split_heads", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.split_heads", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.split_heads", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.multiplicative_attention", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.combine_heads", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.should_generate_summaries", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_image_summary"], ["", "", "def", "multihead_attention", "(", "queries", ",", "memories", ",", "bias", ",", "num_heads", ",", "key_size", ",", "\n", "value_size", ",", "output_size", ",", "keep_prob", "=", "None", ",", "\n", "confidence", "=", "None", ",", "chead", "=", "8", ",", "output", "=", "True", ",", "\n", "state", "=", "None", ",", "summary", "=", "True", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "\"\"\" Multi-head scaled-dot-product attention with input/output\n        transformations.\n\n    :param queries: A tensor with shape [batch, length_q, depth_q]\n    :param memories: A tensor with shape [batch, length_m, depth_m]\n    :param bias: A tensor (see attention_bias)\n    :param num_heads: An integer dividing key_size and value_size\n    :param key_size: An integer\n    :param value_size: An integer\n    :param output_size: An integer\n    :param keep_prob: A floating point number in (0, 1]\n    :param confidence: A tensor with shape [batch, length_m]\n    :param chead: The number of heads multiplied by confidence\n    :param output: Whether to use output transformation\n    :param state: An optional dictionary used for incremental decoding\n    :param summary: Use image summary\n    :param dtype: An optional instance of tf.DType\n    :param scope: An optional string\n\n    :returns: A dict with the following keys:\n        weights: A tensor with shape [batch, heads, length_q, length_kv]\n        outputs: A tensor with shape [batch, length_q, depth_v]\n    \"\"\"", "\n", "\n", "if", "key_size", "%", "num_heads", "!=", "0", ":", "\n", "        ", "raise", "ValueError", "(", "\"Key size (%d) must be divisible by the number of \"", "\n", "\"attention heads (%d).\"", "%", "(", "key_size", ",", "num_heads", ")", ")", "\n", "\n", "", "if", "value_size", "%", "num_heads", "!=", "0", ":", "\n", "        ", "raise", "ValueError", "(", "\"Value size (%d) must be divisible by the number of \"", "\n", "\"attention heads (%d).\"", "%", "(", "value_size", ",", "num_heads", ")", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"multihead_attention\"", ",", "\n", "values", "=", "[", "queries", ",", "memories", "]", ",", "dtype", "=", "dtype", ")", ":", "\n", "        ", "next_state", "=", "{", "}", "\n", "\n", "if", "memories", "is", "None", ":", "\n", "# self attention", "\n", "            ", "size", "=", "key_size", "*", "2", "+", "value_size", "\n", "combined", "=", "linear", "(", "queries", ",", "size", ",", "True", ",", "True", ",", "scope", "=", "\"qkv_transform\"", ")", "\n", "q", ",", "k", ",", "v", "=", "tf", ".", "split", "(", "combined", ",", "[", "key_size", ",", "key_size", ",", "value_size", "]", ",", "\n", "axis", "=", "-", "1", ")", "\n", "\n", "if", "state", "is", "not", "None", ":", "\n", "                ", "k", "=", "tf", ".", "concat", "(", "[", "state", "[", "\"key\"", "]", ",", "k", "]", ",", "axis", "=", "1", ")", "\n", "v", "=", "tf", ".", "concat", "(", "[", "state", "[", "\"value\"", "]", ",", "v", "]", ",", "axis", "=", "1", ")", "\n", "next_state", "[", "\"key\"", "]", "=", "k", "\n", "next_state", "[", "\"value\"", "]", "=", "v", "\n", "", "", "else", ":", "\n", "            ", "q", "=", "linear", "(", "queries", ",", "key_size", ",", "True", ",", "True", ",", "scope", "=", "\"q_transform\"", ")", "\n", "combined", "=", "linear", "(", "memories", ",", "key_size", "+", "value_size", ",", "True", ",", "\n", "scope", "=", "\"kv_transform\"", ")", "\n", "k", ",", "v", "=", "tf", ".", "split", "(", "combined", ",", "[", "key_size", ",", "value_size", "]", ",", "axis", "=", "-", "1", ")", "\n", "\n", "# split heads", "\n", "", "q", "=", "split_heads", "(", "q", ",", "num_heads", ")", "\n", "k", "=", "split_heads", "(", "k", ",", "num_heads", ")", "\n", "v", "=", "split_heads", "(", "v", ",", "num_heads", ")", "\n", "\n", "# scale query", "\n", "key_depth_per_head", "=", "key_size", "//", "num_heads", "\n", "q", "*=", "key_depth_per_head", "**", "-", "0.5", "\n", "\n", "# attention", "\n", "results", "=", "multiplicative_attention", "(", "q", ",", "k", ",", "v", ",", "bias", ",", "keep_prob", ",", "confidence", ",", "num_heads", ",", "chead", ")", "\n", "\n", "# combine heads", "\n", "weights", "=", "results", "[", "\"weights\"", "]", "\n", "x", "=", "combine_heads", "(", "results", "[", "\"outputs\"", "]", ")", "\n", "\n", "if", "output", ":", "\n", "            ", "outputs", "=", "linear", "(", "x", ",", "output_size", ",", "True", ",", "True", ",", "\n", "scope", "=", "\"output_transform\"", ")", "\n", "", "else", ":", "\n", "            ", "outputs", "=", "x", "\n", "\n", "", "if", "should_generate_summaries", "(", ")", "and", "summary", ":", "\n", "            ", "attention_image_summary", "(", "weights", ")", "\n", "\n", "", "outputs", "=", "{", "\"weights\"", ":", "weights", ",", "\"outputs\"", ":", "outputs", "}", "\n", "\n", "if", "state", "is", "not", "None", ":", "\n", "            ", "outputs", "[", "\"state\"", "]", "=", "next_state", "\n", "\n", "", "return", "outputs", "\n", "", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear": [[11, 65], ["tensorflow.variable_scope", "tensorflow.concat", "tensorflow.add_n", "tensorflow.reshape", "isinstance", "len", "len", "RuntimeError", "tensorflow.reshape", "sum", "tensorflow.concat", "tensorflow.get_variable", "results.append", "range", "tensorflow.get_variable", "tensorflow.nn.bias_add", "tensorflow.matmul", "len", "tensorflow.get_variable", "results.append", "item.get_shape", "tensorflow.shape", "tensorflow.matmul"], "function", ["None"], ["def", "linear", "(", "inputs", ",", "output_size", ",", "bias", ",", "concat", "=", "True", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "\"\"\"\n    Linear layer\n    :param inputs: A Tensor or a list of Tensors with shape [batch, input_size]\n    :param output_size: An integer specify the output size\n    :param bias: a boolean value indicate whether to use bias term\n    :param concat: a boolean value indicate whether to concatenate all inputs\n    :param dtype: an instance of tf.DType, the default value is ``tf.float32''\n    :param scope: the scope of this layer, the default value is ``linear''\n    :returns: a Tensor with shape [batch, output_size]\n    :raises RuntimeError: raises ``RuntimeError'' when input sizes do not\n                          compatible with each other\n    \"\"\"", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"linear\"", ",", "values", "=", "[", "inputs", "]", ")", ":", "\n", "        ", "if", "not", "isinstance", "(", "inputs", ",", "(", "list", ",", "tuple", ")", ")", ":", "\n", "            ", "inputs", "=", "[", "inputs", "]", "\n", "\n", "", "input_size", "=", "[", "item", ".", "get_shape", "(", ")", "[", "-", "1", "]", ".", "value", "for", "item", "in", "inputs", "]", "\n", "\n", "if", "len", "(", "inputs", ")", "!=", "len", "(", "input_size", ")", ":", "\n", "            ", "raise", "RuntimeError", "(", "\"inputs and input_size unmatched!\"", ")", "\n", "\n", "", "output_shape", "=", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "inputs", "[", "0", "]", ")", "[", ":", "-", "1", "]", ",", "[", "output_size", "]", "]", ",", "\n", "axis", "=", "0", ")", "\n", "# Flatten to 2D", "\n", "inputs", "=", "[", "tf", ".", "reshape", "(", "inp", ",", "[", "-", "1", ",", "inp", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "for", "inp", "in", "inputs", "]", "\n", "\n", "results", "=", "[", "]", "\n", "\n", "if", "concat", ":", "\n", "            ", "input_size", "=", "sum", "(", "input_size", ")", "\n", "inputs", "=", "tf", ".", "concat", "(", "inputs", ",", "1", ")", "\n", "\n", "shape", "=", "[", "input_size", ",", "output_size", "]", "\n", "matrix", "=", "tf", ".", "get_variable", "(", "\"matrix\"", ",", "shape", ",", "dtype", "=", "dtype", ")", "\n", "results", ".", "append", "(", "tf", ".", "matmul", "(", "inputs", ",", "matrix", ")", ")", "\n", "", "else", ":", "\n", "            ", "for", "i", "in", "range", "(", "len", "(", "input_size", ")", ")", ":", "\n", "                ", "shape", "=", "[", "input_size", "[", "i", "]", ",", "output_size", "]", "\n", "name", "=", "\"matrix_%d\"", "%", "i", "\n", "matrix", "=", "tf", ".", "get_variable", "(", "name", ",", "shape", ",", "dtype", "=", "dtype", ")", "\n", "results", ".", "append", "(", "tf", ".", "matmul", "(", "inputs", "[", "i", "]", ",", "matrix", ")", ")", "\n", "\n", "", "", "output", "=", "tf", ".", "add_n", "(", "results", ")", "\n", "\n", "if", "bias", ":", "\n", "            ", "shape", "=", "[", "output_size", "]", "\n", "bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "shape", ",", "dtype", "=", "dtype", ")", "\n", "output", "=", "tf", ".", "nn", ".", "bias_add", "(", "output", ",", "bias", ")", "\n", "\n", "", "output", "=", "tf", ".", "reshape", "(", "output", ",", "output_shape", ")", "\n", "\n", "return", "output", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.maxout": [[67, 90], ["nn.linear", "tensorflow.concat", "tensorflow.reshape", "tensorflow.reduce_max", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear"], ["", "", "def", "maxout", "(", "inputs", ",", "output_size", ",", "maxpart", "=", "2", ",", "use_bias", "=", "True", ",", "concat", "=", "True", ",", "\n", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "\"\"\"\n    Maxout layer\n    :param inputs: see the corresponding description of ``linear''\n    :param output_size: see the corresponding description of ``linear''\n    :param maxpart: an integer, the default value is 2\n    :param use_bias: a boolean value indicate whether to use bias term\n    :param concat: concat all tensors if inputs is a list of tensors\n    :param dtype: an optional instance of tf.Dtype\n    :param scope: the scope of this layer, the default value is ``maxout''\n    :returns: a Tensor with shape [batch, output_size]\n    :raises RuntimeError: see the corresponding description of ``linear''\n    \"\"\"", "\n", "\n", "candidate", "=", "linear", "(", "inputs", ",", "output_size", "*", "maxpart", ",", "use_bias", ",", "concat", ",", "\n", "dtype", "=", "dtype", ",", "scope", "=", "scope", "or", "\"maxout\"", ")", "\n", "shape", "=", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "candidate", ")", "[", ":", "-", "1", "]", ",", "[", "output_size", ",", "maxpart", "]", "]", ",", "\n", "axis", "=", "0", ")", "\n", "value", "=", "tf", ".", "reshape", "(", "candidate", ",", "shape", ")", "\n", "output", "=", "tf", ".", "reduce_max", "(", "value", ",", "-", "1", ")", "\n", "\n", "return", "output", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.layer_norm": [[92, 117], ["tensorflow.variable_scope", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.reduce_mean", "tensorflow.reduce_mean", "inputs.get_shape().as_list", "tensorflow.square", "tensorflow.rsqrt", "tensorflow.ones_initializer", "tensorflow.zeros_initializer", "inputs.get_shape"], "function", ["None"], ["", "def", "layer_norm", "(", "inputs", ",", "epsilon", "=", "1e-6", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "\"\"\"\n    Layer Normalization\n    :param inputs: A Tensor of shape [..., channel_size]\n    :param epsilon: A floating number\n    :param dtype: An optional instance of tf.DType\n    :param scope: An optional string\n    :returns: A Tensor with the same shape as inputs\n    \"\"\"", "\n", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"layer_norm\"", ",", "values", "=", "[", "inputs", "]", ",", "\n", "dtype", "=", "dtype", ")", ":", "\n", "        ", "channel_size", "=", "inputs", ".", "get_shape", "(", ")", ".", "as_list", "(", ")", "[", "-", "1", "]", "\n", "\n", "scale", "=", "tf", ".", "get_variable", "(", "\"scale\"", ",", "shape", "=", "[", "channel_size", "]", ",", "\n", "initializer", "=", "tf", ".", "ones_initializer", "(", ")", ")", "\n", "\n", "offset", "=", "tf", ".", "get_variable", "(", "\"offset\"", ",", "shape", "=", "[", "channel_size", "]", ",", "\n", "initializer", "=", "tf", ".", "zeros_initializer", "(", ")", ")", "\n", "\n", "mean", "=", "tf", ".", "reduce_mean", "(", "inputs", ",", "-", "1", ",", "True", ")", "\n", "variance", "=", "tf", ".", "reduce_mean", "(", "tf", ".", "square", "(", "inputs", "-", "mean", ")", ",", "-", "1", ",", "True", ")", "\n", "\n", "norm_inputs", "=", "(", "inputs", "-", "mean", ")", "*", "tf", ".", "rsqrt", "(", "variance", "+", "epsilon", ")", "\n", "\n", "return", "norm_inputs", "*", "scale", "+", "offset", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.smoothed_softmax_cross_entropy_with_logits": [[119, 162], ["kwargs.get", "kwargs.get", "kwargs.get", "kwargs.get", "kwargs.get", "ValueError", "tensorflow.name_scope", "tensorflow.reshape", "tensorflow.to_float", "tensorflow.one_hot", "tensorflow.nn.softmax_cross_entropy_with_logits", "tensorflow.nn.sparse_softmax_cross_entropy_with_logits", "tensorflow.shape", "tensorflow.cast", "tensorflow.log", "tensorflow.log"], "function", ["None"], ["", "", "def", "smoothed_softmax_cross_entropy_with_logits", "(", "**", "kwargs", ")", ":", "\n", "    ", "logits", "=", "kwargs", ".", "get", "(", "\"logits\"", ")", "\n", "labels", "=", "kwargs", ".", "get", "(", "\"labels\"", ")", "\n", "smoothing", "=", "kwargs", ".", "get", "(", "\"smoothing\"", ")", "or", "0.0", "\n", "normalize", "=", "kwargs", ".", "get", "(", "\"normalize\"", ")", "\n", "scope", "=", "kwargs", ".", "get", "(", "\"scope\"", ")", "\n", "\n", "if", "logits", "is", "None", "or", "labels", "is", "None", ":", "\n", "        ", "raise", "ValueError", "(", "\"Both logits and labels must be provided\"", ")", "\n", "\n", "", "with", "tf", ".", "name_scope", "(", "scope", "or", "\"smoothed_softmax_cross_entropy_with_logits\"", ",", "\n", "values", "=", "[", "logits", ",", "labels", "]", ")", ":", "\n", "\n", "        ", "labels", "=", "tf", ".", "reshape", "(", "labels", ",", "[", "-", "1", "]", ")", "\n", "\n", "if", "not", "smoothing", ":", "\n", "            ", "ce", "=", "tf", ".", "nn", ".", "sparse_softmax_cross_entropy_with_logits", "(", "\n", "logits", "=", "logits", ",", "\n", "labels", "=", "labels", "\n", ")", "\n", "return", "ce", "\n", "\n", "# label smoothing", "\n", "", "vocab_size", "=", "tf", ".", "shape", "(", "logits", ")", "[", "1", "]", "\n", "\n", "n", "=", "tf", ".", "to_float", "(", "vocab_size", "-", "1", ")", "\n", "p", "=", "1.0", "-", "smoothing", "\n", "q", "=", "smoothing", "/", "n", "\n", "\n", "soft_targets", "=", "tf", ".", "one_hot", "(", "tf", ".", "cast", "(", "labels", ",", "tf", ".", "int32", ")", ",", "depth", "=", "vocab_size", ",", "\n", "on_value", "=", "p", ",", "off_value", "=", "q", ")", "\n", "xentropy", "=", "tf", ".", "nn", ".", "softmax_cross_entropy_with_logits", "(", "logits", "=", "logits", ",", "\n", "labels", "=", "soft_targets", ")", "\n", "\n", "if", "normalize", "is", "False", ":", "\n", "            ", "return", "xentropy", "\n", "\n", "# Normalizing constant is the best cross-entropy value with soft", "\n", "# targets. We subtract it just for readability, makes no difference on", "\n", "# learning", "\n", "", "normalizing", "=", "-", "(", "p", "*", "tf", ".", "log", "(", "p", ")", "+", "n", "*", "q", "*", "tf", ".", "log", "(", "q", "+", "1e-20", ")", ")", "\n", "\n", "return", "xentropy", "-", "normalizing", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.generate_confidence": [[164, 199], ["tensorflow.pow", "tensorflow.pow", "tensorflow.expand_dims", "tensorflow.exp", "tensorflow.exp", "tensorflow.reduce_sum", "tensorflow.to_float", "tensorflow.reduce_sum", "tensorflow.log"], "function", ["None"], ["", "", "def", "generate_confidence", "(", "features", ",", "level", ",", "params", ",", "src_mask", "=", "None", ")", ":", "\n", "    ", "if", "level", "==", "'sentence'", ":", "\n", "        ", "if", "params", ".", "sencf_convert", ":", "\n", "            ", "confidence", "=", "features", "[", "\"confidence\"", "]", "\n", "sen_len", "=", "features", "[", "\"source_length\"", "]", "\n", "lp", "=", "tf", ".", "pow", "(", "(", "5.0", "+", "tf", ".", "to_float", "(", "sen_len", ")", ")", "/", "6.0", ",", "params", ".", "decode_alpha", ")", "\n", "if", "params", ".", "cf_type", "==", "3", ":", "\n", "                ", "sen_cf", "=", "tf", ".", "reduce_sum", "(", "confidence", "*", "src_mask", ",", "axis", "=", "-", "1", ")", "/", "lp", "\n", "", "else", ":", "\n", "# confidence = confidence * src_mask + 1 - src_mask", "\n", "                ", "sen_cf", "=", "tf", ".", "exp", "(", "tf", ".", "reduce_sum", "(", "tf", ".", "log", "(", "confidence", ")", ",", "axis", "=", "-", "1", ")", "/", "lp", ")", "\n", "", "confidence", "=", "tf", ".", "expand_dims", "(", "sen_cf", ",", "-", "1", ")", "\n", "", "else", ":", "\n", "            ", "confidence", "=", "features", "[", "\"sen_confidence\"", "]", "\n", "\n", "# if params.sencf_batch_max_length:", "\n", "#     max_len_mask = src_mask[:, -1:]", "\n", "#     confidence *= max_len_mask", "\n", "", "", "else", ":", "\n", "        ", "confidence", "=", "features", "[", "\"confidence\"", "]", "\n", "\n", "", "if", "params", ".", "cf_type", "==", "1", ":", "\n", "# pow", "\n", "        ", "confidence", "=", "1", "-", "confidence", "\n", "confidence", "=", "tf", ".", "pow", "(", "confidence", ",", "params", ".", "confidence_alpha", ")", "\n", "", "elif", "params", ".", "cf_type", "==", "2", ":", "\n", "# mul", "\n", "        ", "confidence", "=", "1", "-", "params", ".", "confidence_alpha", "*", "confidence", "\n", "", "elif", "params", ".", "cf_type", "==", "3", ":", "\n", "# ptp", "\n", "        ", "confidence", "=", "tf", ".", "exp", "(", "confidence", ")", "\n", "", "else", ":", "\n", "        ", "pass", "\n", "\n", "", "return", "confidence", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.convert_old_model.parseargs": [[15, 24], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args"], ["def", "parseargs", "(", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", "description", "=", "\"Convert old models\"", ")", "\n", "\n", "parser", ".", "add_argument", "(", "\"--input\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of old model\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--output\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"Path of output checkpoint\"", ")", "\n", "\n", "return", "parser", ".", "parse_args", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.convert_old_model.old_keys": [[26, 71], ["None"], "function", ["None"], ["", "def", "old_keys", "(", ")", ":", "\n", "    ", "keys", "=", "[", "\n", "\"GRU_dec_attcontext\"", ",", "\n", "\"GRU_dec_att\"", ",", "\n", "\"GRU_dec_atthidden\"", ",", "\n", "\"GRU_dec_inputoffset\"", ",", "\n", "\"GRU_dec_inputemb\"", ",", "\n", "\"GRU_dec_inputcontext\"", ",", "\n", "\"GRU_dec_inputhidden\"", ",", "\n", "\"GRU_dec_resetemb\"", ",", "\n", "\"GRU_dec_resetcontext\"", ",", "\n", "\"GRU_dec_resethidden\"", ",", "\n", "\"GRU_dec_gateemb\"", ",", "\n", "\"GRU_dec_gatecontext\"", ",", "\n", "\"GRU_dec_gatehidden\"", ",", "\n", "\"initer_b\"", ",", "\n", "\"initer_W\"", ",", "\n", "\"GRU_dec_probsemb\"", ",", "\n", "\"GRU_enc_back_inputoffset\"", ",", "\n", "\"GRU_enc_back_inputemb\"", ",", "\n", "\"GRU_enc_back_inputhidden\"", ",", "\n", "\"GRU_enc_back_resetemb\"", ",", "\n", "\"GRU_enc_back_resethidden\"", ",", "\n", "\"GRU_enc_back_gateemb\"", ",", "\n", "\"GRU_enc_back_gatehidden\"", ",", "\n", "\"GRU_enc_inputoffset\"", ",", "\n", "\"GRU_enc_inputemb\"", ",", "\n", "\"GRU_enc_inputhidden\"", ",", "\n", "\"GRU_enc_resetemb\"", ",", "\n", "\"GRU_enc_resethidden\"", ",", "\n", "\"GRU_enc_gateemb\"", ",", "\n", "\"GRU_enc_gatehidden\"", ",", "\n", "\"GRU_dec_readoutoffset\"", ",", "\n", "\"GRU_dec_readoutemb\"", ",", "\n", "\"GRU_dec_readouthidden\"", ",", "\n", "\"GRU_dec_readoutcontext\"", ",", "\n", "\"GRU_dec_probsoffset\"", ",", "\n", "\"GRU_dec_probs\"", ",", "\n", "\"emb_src_b\"", ",", "\n", "\"emb_src_emb\"", ",", "\n", "\"emb_trg_b\"", ",", "\n", "\"emb_trg_emb\"", "\n", "]", "\n", "\n", "return", "keys", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.convert_old_model.new_keys": [[73, 118], ["None"], "function", ["None"], ["", "def", "new_keys", "(", ")", ":", "\n", "    ", "keys", "=", "[", "\n", "\"rnnsearch/decoder/attention/k_transform/matrix_0\"", ",", "\n", "\"rnnsearch/decoder/attention/logits/matrix_0\"", ",", "\n", "\"rnnsearch/decoder/attention/q_transform/matrix_0\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/candidate/bias\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/candidate/matrix_0\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/candidate/matrix_1\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/candidate/matrix_2\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/reset_gate/matrix_0\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/reset_gate/matrix_1\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/reset_gate/matrix_2\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/update_gate/matrix_0\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/update_gate/matrix_1\"", ",", "\n", "\"rnnsearch/decoder/gru_cell/update_gate/matrix_2\"", ",", "\n", "\"rnnsearch/decoder/s_transform/bias\"", ",", "\n", "\"rnnsearch/decoder/s_transform/matrix_0\"", ",", "\n", "\"rnnsearch/deepout/matrix_0\"", ",", "\n", "\"rnnsearch/encoder/backward/gru_cell/candidate/bias\"", ",", "\n", "\"rnnsearch/encoder/backward/gru_cell/candidate/matrix_0\"", ",", "\n", "\"rnnsearch/encoder/backward/gru_cell/candidate/matrix_1\"", ",", "\n", "\"rnnsearch/encoder/backward/gru_cell/reset_gate/matrix_0\"", ",", "\n", "\"rnnsearch/encoder/backward/gru_cell/reset_gate/matrix_1\"", ",", "\n", "\"rnnsearch/encoder/backward/gru_cell/update_gate/matrix_0\"", ",", "\n", "\"rnnsearch/encoder/backward/gru_cell/update_gate/matrix_1\"", ",", "\n", "\"rnnsearch/encoder/forward/gru_cell/candidate/bias\"", ",", "\n", "\"rnnsearch/encoder/forward/gru_cell/candidate/matrix_0\"", ",", "\n", "\"rnnsearch/encoder/forward/gru_cell/candidate/matrix_1\"", ",", "\n", "\"rnnsearch/encoder/forward/gru_cell/reset_gate/matrix_0\"", ",", "\n", "\"rnnsearch/encoder/forward/gru_cell/reset_gate/matrix_1\"", ",", "\n", "\"rnnsearch/encoder/forward/gru_cell/update_gate/matrix_0\"", ",", "\n", "\"rnnsearch/encoder/forward/gru_cell/update_gate/matrix_1\"", ",", "\n", "\"rnnsearch/maxout/bias\"", ",", "\n", "\"rnnsearch/maxout/matrix_0\"", ",", "\n", "\"rnnsearch/maxout/matrix_1\"", ",", "\n", "\"rnnsearch/maxout/matrix_2\"", ",", "\n", "\"rnnsearch/softmax/bias\"", ",", "\n", "\"rnnsearch/softmax/matrix_0\"", ",", "\n", "\"rnnsearch/source_embedding/bias\"", ",", "\n", "\"rnnsearch/source_embedding/embedding\"", ",", "\n", "\"rnnsearch/target_embedding/bias\"", ",", "\n", "\"rnnsearch/target_embedding/embedding\"", ",", "\n", "]", "\n", "\n", "return", "keys", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.convert_old_model.main": [[120, 144], ["dict", "convert_old_model.old_keys", "convert_old_model.new_keys", "enumerate", "numpy.load", "tensorflow.Graph().as_default", "tensorflow.train.Saver", "tensorflow.device", "tensorflow.Variable", "tensorflow.Session", "sess.run", "tf.train.Saver.save", "tensorflow.Graph", "tensorflow.get_variable", "tensorflow.global_variables_initializer"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.convert_old_model.old_keys", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.convert_old_model.new_keys"], ["", "def", "main", "(", "args", ")", ":", "\n", "    ", "values", "=", "dict", "(", "np", ".", "load", "(", "args", ".", "input", ")", ")", "\n", "variables", "=", "{", "}", "\n", "o_keys", "=", "old_keys", "(", ")", "\n", "n_keys", "=", "new_keys", "(", ")", "\n", "\n", "for", "i", ",", "key", "in", "enumerate", "(", "o_keys", ")", ":", "\n", "        ", "v", "=", "values", "[", "key", "]", "\n", "variables", "[", "n_keys", "[", "i", "]", "]", "=", "v", "\n", "\n", "", "with", "tf", ".", "Graph", "(", ")", ".", "as_default", "(", ")", ":", "\n", "        ", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "            ", "tf_vars", "=", "[", "\n", "tf", ".", "get_variable", "(", "v", ",", "initializer", "=", "variables", "[", "v", "]", ",", "dtype", "=", "tf", ".", "float32", ")", "\n", "for", "v", "in", "variables", "\n", "]", "\n", "global_step", "=", "tf", ".", "Variable", "(", "0", ",", "name", "=", "\"global_step\"", ",", "trainable", "=", "False", ",", "\n", "dtype", "=", "tf", ".", "int64", ")", "\n", "\n", "", "saver", "=", "tf", ".", "train", ".", "Saver", "(", "tf_vars", ")", "\n", "\n", "with", "tf", ".", "Session", "(", ")", "as", "sess", ":", "\n", "            ", "sess", ".", "run", "(", "tf", ".", "global_variables_initializer", "(", ")", ")", "\n", "saver", ".", "save", "(", "sess", ",", "args", ".", "output", ",", "global_step", "=", "global_step", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.shuffle_corpus.parseargs": [[12, 22], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args"], ["def", "parseargs", "(", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", "description", "=", "\"Shuffle corpus\"", ")", "\n", "\n", "parser", ".", "add_argument", "(", "\"--corpus\"", ",", "nargs", "=", "\"+\"", ",", "required", "=", "True", ",", "\n", "help", "=", "\"input corpora\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--suffix\"", ",", "type", "=", "str", ",", "default", "=", "\"shuf\"", ",", "\n", "help", "=", "\"Suffix of output files\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--seed\"", ",", "type", "=", "int", ",", "help", "=", "\"Random seed\"", ")", "\n", "\n", "return", "parser", ".", "parse_args", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.shuffle_corpus.main": [[24, 48], ["min", "numpy.arange", "numpy.random.shuffle", "numpy.arange.tolist", "zip", "open", "fd.readlines", "numpy.random.seed", "open", "zip", "fdr.close", "fdw.close", "len", "fd.write"], "function", ["None"], ["", "def", "main", "(", "args", ")", ":", "\n", "    ", "name", "=", "args", ".", "corpus", "\n", "suffix", "=", "\".\"", "+", "args", ".", "suffix", "\n", "stream", "=", "[", "open", "(", "item", ",", "\"r\"", ")", "for", "item", "in", "name", "]", "\n", "data", "=", "[", "fd", ".", "readlines", "(", ")", "for", "fd", "in", "stream", "]", "\n", "minlen", "=", "min", "(", "[", "len", "(", "lines", ")", "for", "lines", "in", "data", "]", ")", "\n", "\n", "if", "args", ".", "seed", ":", "\n", "        ", "numpy", ".", "random", ".", "seed", "(", "args", ".", "seed", ")", "\n", "\n", "", "indices", "=", "numpy", ".", "arange", "(", "minlen", ")", "\n", "numpy", ".", "random", ".", "shuffle", "(", "indices", ")", "\n", "\n", "newstream", "=", "[", "open", "(", "item", "+", "suffix", ",", "\"w\"", ")", "for", "item", "in", "name", "]", "\n", "\n", "for", "idx", "in", "indices", ".", "tolist", "(", ")", ":", "\n", "        ", "lines", "=", "[", "item", "[", "idx", "]", "for", "item", "in", "data", "]", "\n", "\n", "for", "line", ",", "fd", "in", "zip", "(", "lines", ",", "newstream", ")", ":", "\n", "            ", "fd", ".", "write", "(", "line", ")", "\n", "\n", "", "", "for", "fdr", ",", "fdw", "in", "zip", "(", "stream", ",", "newstream", ")", ":", "\n", "        ", "fdr", ".", "close", "(", ")", "\n", "fdw", ".", "close", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.checkpoint_averaging.parseargs": [[17, 29], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args"], ["def", "parseargs", "(", ")", ":", "\n", "    ", "msg", "=", "\"Average checkpoints\"", "\n", "usage", "=", "\"average.py [<args>] [-h | --help]\"", "\n", "parser", "=", "argparse", ".", "ArgumentParser", "(", "description", "=", "msg", ",", "usage", "=", "usage", ")", "\n", "\n", "parser", ".", "add_argument", "(", "\"--path\"", ",", "type", "=", "str", ",", "required", "=", "True", ",", "\n", "help", "=", "\"checkpoint dir\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--checkpoints\"", ",", "type", "=", "int", ",", "required", "=", "True", ",", "\n", "help", "=", "\"number of checkpoints to use\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--output\"", ",", "type", "=", "str", ",", "help", "=", "\"output path\"", ")", "\n", "\n", "return", "parser", ".", "parse_args", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.checkpoint_averaging.get_checkpoints": [[31, 49], ["sorted", "tensorflow.gfile.Exists", "ValueError", "tensorflow.gfile.GFile", "fd.readline", "os.path.join", "os.path.join", "int", "checkpoint_names.append", "operator.itemgetter", "[].strip", "name.split", "os.path.join", "line.strip().split", "line.strip"], "function", ["None"], ["", "def", "get_checkpoints", "(", "path", ")", ":", "\n", "    ", "if", "not", "tf", ".", "gfile", ".", "Exists", "(", "os", ".", "path", ".", "join", "(", "path", ",", "\"checkpoint\"", ")", ")", ":", "\n", "        ", "raise", "ValueError", "(", "\"Cannot find checkpoints in %s\"", "%", "path", ")", "\n", "\n", "", "checkpoint_names", "=", "[", "]", "\n", "\n", "with", "tf", ".", "gfile", ".", "GFile", "(", "os", ".", "path", ".", "join", "(", "path", ",", "\"checkpoint\"", ")", ")", "as", "fd", ":", "\n", "# Skip the first line", "\n", "        ", "fd", ".", "readline", "(", ")", "\n", "for", "line", "in", "fd", ":", "\n", "            ", "name", "=", "line", ".", "strip", "(", ")", ".", "split", "(", "\":\"", ")", "[", "-", "1", "]", ".", "strip", "(", ")", "[", "1", ":", "-", "1", "]", "\n", "key", "=", "int", "(", "name", ".", "split", "(", "\"-\"", ")", "[", "-", "1", "]", ")", "\n", "checkpoint_names", ".", "append", "(", "(", "key", ",", "os", ".", "path", ".", "join", "(", "path", ",", "name", ")", ")", ")", "\n", "\n", "", "", "sorted_names", "=", "sorted", "(", "checkpoint_names", ",", "key", "=", "operator", ".", "itemgetter", "(", "0", ")", ",", "\n", "reverse", "=", "True", ")", "\n", "\n", "return", "[", "item", "[", "-", "1", "]", "for", "item", "in", "sorted_names", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.checkpoint_averaging.checkpoint_exists": [[51, 54], ["tensorflow.gfile.Exists", "tensorflow.gfile.Exists", "tensorflow.gfile.Exists"], "function", ["None"], ["", "def", "checkpoint_exists", "(", "path", ")", ":", "\n", "    ", "return", "(", "tf", ".", "gfile", ".", "Exists", "(", "path", ")", "or", "tf", ".", "gfile", ".", "Exists", "(", "path", "+", "\".meta\"", ")", "or", "\n", "tf", ".", "gfile", ".", "Exists", "(", "path", "+", "\".index\"", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.checkpoint_averaging.main": [[56, 121], ["tensorflow.logging.set_verbosity", "checkpoint_averaging.get_checkpoints", "tensorflow.contrib.framework.list_variables", "tensorflow.Variable", "tensorflow.train.Saver", "tensorflow.logging.info", "os.path.join", "tensorflow.gfile.Glob", "ValueError", "ValueError", "tensorflow.contrib.framework.load_checkpoint", "tensorflow.logging.info", "len", "tensorflow.get_variable", "tensorflow.placeholder", "tensorflow.assign", "tensorflow.global_variables", "tensorflow.Session", "sess.run", "zip", "os.path.join", "tf.train.Saver.save", "name.replace", "tensorflow.gfile.Copy", "checkpoint_averaging.checkpoint_exists", "name.startswith", "numpy.zeros", "tf.contrib.framework.load_checkpoint.get_tensor", "zip", "tensorflow.global_variables_initializer", "var_values.iteritems", "sess.run", "FLAGS.path.rstrip", "FLAGS.output.rstrip"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.checkpoint_averaging.get_checkpoints", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.checkpoint_averaging.checkpoint_exists"], ["", "def", "main", "(", "_", ")", ":", "\n", "    ", "tf", ".", "logging", ".", "set_verbosity", "(", "tf", ".", "logging", ".", "INFO", ")", "\n", "checkpoints", "=", "get_checkpoints", "(", "FLAGS", ".", "path", ")", "\n", "checkpoints", "=", "checkpoints", "[", ":", "FLAGS", ".", "checkpoints", "]", "\n", "\n", "if", "not", "checkpoints", ":", "\n", "        ", "raise", "ValueError", "(", "\"No checkpoints provided for averaging.\"", ")", "\n", "\n", "", "checkpoints", "=", "[", "c", "for", "c", "in", "checkpoints", "if", "checkpoint_exists", "(", "c", ")", "]", "\n", "\n", "if", "not", "checkpoints", ":", "\n", "        ", "raise", "ValueError", "(", "\n", "\"None of the provided checkpoints exist. %s\"", "%", "FLAGS", ".", "checkpoints", "\n", ")", "\n", "\n", "", "var_list", "=", "tf", ".", "contrib", ".", "framework", ".", "list_variables", "(", "checkpoints", "[", "0", "]", ")", "\n", "var_values", ",", "var_dtypes", "=", "{", "}", ",", "{", "}", "\n", "\n", "for", "(", "name", ",", "shape", ")", "in", "var_list", ":", "\n", "        ", "if", "not", "name", ".", "startswith", "(", "\"global_step\"", ")", ":", "\n", "            ", "if", "name", "==", "\"OneShotIterator:0-state\"", ":", "\n", "                ", "continue", "\n", "", "var_values", "[", "name", "]", "=", "np", ".", "zeros", "(", "shape", ")", "\n", "\n", "", "", "for", "checkpoint", "in", "checkpoints", ":", "\n", "        ", "reader", "=", "tf", ".", "contrib", ".", "framework", ".", "load_checkpoint", "(", "checkpoint", ")", "\n", "for", "name", "in", "var_values", ":", "\n", "            ", "if", "name", "==", "\"OneShotIterator:0-state\"", ":", "\n", "                ", "continue", "\n", "", "tensor", "=", "reader", ".", "get_tensor", "(", "name", ")", "\n", "var_dtypes", "[", "name", "]", "=", "tensor", ".", "dtype", "\n", "var_values", "[", "name", "]", "+=", "tensor", "\n", "", "tf", ".", "logging", ".", "info", "(", "\"Read from checkpoint %s\"", ",", "checkpoint", ")", "\n", "\n", "# Average checkpoints", "\n", "", "for", "name", "in", "var_values", ":", "\n", "        ", "var_values", "[", "name", "]", "/=", "len", "(", "checkpoints", ")", "\n", "\n", "", "tf_vars", "=", "[", "\n", "tf", ".", "get_variable", "(", "name", ",", "shape", "=", "var_values", "[", "name", "]", ".", "shape", ",", "\n", "dtype", "=", "var_dtypes", "[", "name", "]", ")", "for", "name", "in", "var_values", "\n", "]", "\n", "placeholders", "=", "[", "tf", ".", "placeholder", "(", "v", ".", "dtype", ",", "shape", "=", "v", ".", "shape", ")", "for", "v", "in", "tf_vars", "]", "\n", "assign_ops", "=", "[", "tf", ".", "assign", "(", "v", ",", "p", ")", "for", "(", "v", ",", "p", ")", "in", "zip", "(", "tf_vars", ",", "placeholders", ")", "]", "\n", "global_step", "=", "tf", ".", "Variable", "(", "0", ",", "name", "=", "\"global_step\"", ",", "trainable", "=", "False", ",", "\n", "dtype", "=", "tf", ".", "int64", ")", "\n", "saver", "=", "tf", ".", "train", ".", "Saver", "(", "tf", ".", "global_variables", "(", ")", ")", "\n", "\n", "with", "tf", ".", "Session", "(", ")", "as", "sess", ":", "\n", "        ", "sess", ".", "run", "(", "tf", ".", "global_variables_initializer", "(", ")", ")", "\n", "for", "p", ",", "assign_op", ",", "(", "name", ",", "value", ")", "in", "zip", "(", "placeholders", ",", "assign_ops", ",", "\n", "var_values", ".", "iteritems", "(", ")", ")", ":", "\n", "            ", "sess", ".", "run", "(", "assign_op", ",", "{", "p", ":", "value", "}", ")", "\n", "", "saved_name", "=", "os", ".", "path", ".", "join", "(", "FLAGS", ".", "output", ",", "\"average\"", ")", "\n", "saver", ".", "save", "(", "sess", ",", "saved_name", ",", "global_step", "=", "global_step", ")", "\n", "\n", "", "tf", ".", "logging", ".", "info", "(", "\"Averaged checkpoints saved in %s\"", ",", "saved_name", ")", "\n", "\n", "params_pattern", "=", "os", ".", "path", ".", "join", "(", "FLAGS", ".", "path", ",", "\"*.json\"", ")", "\n", "params_files", "=", "tf", ".", "gfile", ".", "Glob", "(", "params_pattern", ")", "\n", "\n", "for", "name", "in", "params_files", ":", "\n", "        ", "new_name", "=", "name", ".", "replace", "(", "FLAGS", ".", "path", ".", "rstrip", "(", "\"/\"", ")", ",", "\n", "FLAGS", ".", "output", ".", "rstrip", "(", "\"/\"", ")", ")", "\n", "tf", ".", "gfile", ".", "Copy", "(", "name", ",", "new_name", ",", "overwrite", "=", "True", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.load_vocab": [[16, 26], ["tensorflow.gfile.Open", "line.strip"], "function", ["None"], ["def", "load_vocab", "(", "filename", ")", ":", "\n", "    ", "with", "tf", ".", "gfile", ".", "Open", "(", "filename", ")", "as", "fd", ":", "\n", "        ", "count", "=", "0", "\n", "vocab", "=", "{", "}", "\n", "for", "line", "in", "fd", ":", "\n", "            ", "word", "=", "line", ".", "strip", "(", ")", "\n", "vocab", "[", "word", "]", "=", "count", "\n", "count", "+=", "1", "\n", "\n", "", "", "return", "vocab", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.to_example": [[28, 50], ["six.iteritems", "tensorflow.train.Example", "isinstance", "ValueError", "tensorflow.train.Int64List", "tensorflow.train.Feature", "isinstance", "tensorflow.train.Features", "str", "tensorflow.train.FloatList", "tensorflow.train.Feature", "isinstance", "tensorflow.train.BytesList", "tensorflow.train.Feature", "ValueError", "str", "str", "type"], "function", ["None"], ["", "def", "to_example", "(", "dictionary", ")", ":", "\n", "    ", "\"\"\" Convert python dictionary to tf.train.Example \"\"\"", "\n", "features", "=", "{", "}", "\n", "\n", "for", "(", "k", ",", "v", ")", "in", "six", ".", "iteritems", "(", "dictionary", ")", ":", "\n", "        ", "if", "not", "v", ":", "\n", "            ", "raise", "ValueError", "(", "\"Empty generated field: %s\"", ",", "str", "(", "(", "k", ",", "v", ")", ")", ")", "\n", "\n", "", "if", "isinstance", "(", "v", "[", "0", "]", ",", "six", ".", "integer_types", ")", ":", "\n", "            ", "int64_list", "=", "tf", ".", "train", ".", "Int64List", "(", "value", "=", "v", ")", "\n", "features", "[", "k", "]", "=", "tf", ".", "train", ".", "Feature", "(", "int64_list", "=", "int64_list", ")", "\n", "", "elif", "isinstance", "(", "v", "[", "0", "]", ",", "float", ")", ":", "\n", "            ", "float_list", "=", "tf", ".", "train", ".", "FloatList", "(", "value", "=", "v", ")", "\n", "features", "[", "k", "]", "=", "tf", ".", "train", ".", "Feature", "(", "float_list", "=", "float_list", ")", "\n", "", "elif", "isinstance", "(", "v", "[", "0", "]", ",", "six", ".", "string_types", ")", ":", "\n", "            ", "bytes_list", "=", "tf", ".", "train", ".", "BytesList", "(", "value", "=", "v", ")", "\n", "features", "[", "k", "]", "=", "tf", ".", "train", ".", "Feature", "(", "bytes_list", "=", "bytes_list", ")", "\n", "", "else", ":", "\n", "            ", "raise", "ValueError", "(", "\"Value is neither an int nor a float; \"", "\n", "\"v: %s type: %s\"", "%", "(", "str", "(", "v", "[", "0", "]", ")", ",", "str", "(", "type", "(", "v", "[", "0", "]", ")", ")", ")", ")", "\n", "\n", "", "", "return", "tf", ".", "train", ".", "Example", "(", "features", "=", "tf", ".", "train", ".", "Features", "(", "feature", "=", "features", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.write_records": [[52, 62], ["tensorflow.python_io.TFRecordWriter", "enumerate", "tf.python_io.TFRecordWriter.close", "tf.python_io.TFRecordWriter.write", "tensorflow.logging.info"], "function", ["None"], ["", "def", "write_records", "(", "records", ",", "out_filename", ")", ":", "\n", "    ", "\"\"\" Write to TensorFlow record \"\"\"", "\n", "writer", "=", "tf", ".", "python_io", ".", "TFRecordWriter", "(", "out_filename", ")", "\n", "\n", "for", "count", ",", "record", "in", "enumerate", "(", "records", ")", ":", "\n", "        ", "writer", ".", "write", "(", "record", ")", "\n", "if", "count", "%", "10000", "==", "0", ":", "\n", "            ", "tf", ".", "logging", ".", "info", "(", "\"write: %d\"", ",", "count", ")", "\n", "\n", "", "", "writer", ".", "close", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.convert_to_record": [[64, 111], ["xrange", "tensorflow.gfile.Open", "os.path.join", "output_files.append", "writers.append", "random.shuffle", "input_converter.to_example", "writers[].write", "writer.close", "tensorflow.gfile.Open", "zip", "tensorflow.python_io.TFRecordWriter", "to_example.SerializeToString", "sline.strip().split.strip().split", "tline.strip().split.strip().split", "records.append", "sline.strip().split.strip", "tline.strip().split.strip", "len", "len"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.to_example"], ["", "def", "convert_to_record", "(", "inputs", ",", "vocab", ",", "output_name", ",", "output_dir", ",", "num_shards", ",", "\n", "shuffle", "=", "False", ")", ":", "\n", "    ", "\"\"\" Convert plain parallel text to TensorFlow record \"\"\"", "\n", "source", ",", "target", "=", "inputs", "\n", "svocab", ",", "tvocab", "=", "vocab", "\n", "records", "=", "[", "]", "\n", "\n", "with", "tf", ".", "gfile", ".", "Open", "(", "source", ")", "as", "src", ":", "\n", "        ", "with", "tf", ".", "gfile", ".", "Open", "(", "target", ")", "as", "tgt", ":", "\n", "            ", "for", "sline", ",", "tline", "in", "zip", "(", "src", ",", "tgt", ")", ":", "\n", "                ", "sline", "=", "sline", ".", "strip", "(", ")", ".", "split", "(", ")", "\n", "sline", "=", "[", "svocab", "[", "item", "]", "if", "item", "in", "svocab", "else", "svocab", "[", "FLAGS", ".", "unk", "]", "\n", "for", "item", "in", "sline", "]", "+", "[", "svocab", "[", "FLAGS", ".", "eos", "]", "]", "\n", "tline", "=", "tline", ".", "strip", "(", ")", ".", "split", "(", ")", "\n", "tline", "=", "[", "tvocab", "[", "item", "]", "if", "item", "in", "tvocab", "else", "tvocab", "[", "FLAGS", ".", "unk", "]", "\n", "for", "item", "in", "tline", "]", "+", "[", "tvocab", "[", "FLAGS", ".", "eos", "]", "]", "\n", "\n", "feature", "=", "{", "\n", "\"source\"", ":", "sline", ",", "\n", "\"target\"", ":", "tline", ",", "\n", "\"source_length\"", ":", "[", "len", "(", "sline", ")", "]", ",", "\n", "\"target_length\"", ":", "[", "len", "(", "tline", ")", "]", "\n", "}", "\n", "records", ".", "append", "(", "feature", ")", "\n", "\n", "", "", "", "output_files", "=", "[", "]", "\n", "writers", "=", "[", "]", "\n", "\n", "for", "shard", "in", "xrange", "(", "num_shards", ")", ":", "\n", "        ", "output_filename", "=", "\"%s-%.5d-of-%.5d\"", "%", "(", "output_name", ",", "shard", ",", "num_shards", ")", "\n", "output_file", "=", "os", ".", "path", ".", "join", "(", "output_dir", ",", "output_filename", ")", "\n", "output_files", ".", "append", "(", "output_file", ")", "\n", "writers", ".", "append", "(", "tf", ".", "python_io", ".", "TFRecordWriter", "(", "output_file", ")", ")", "\n", "\n", "", "counter", ",", "shard", "=", "0", ",", "0", "\n", "\n", "if", "shuffle", ":", "\n", "        ", "random", ".", "shuffle", "(", "records", ")", "\n", "\n", "", "for", "record", "in", "records", ":", "\n", "        ", "counter", "+=", "1", "\n", "example", "=", "to_example", "(", "record", ")", "\n", "writers", "[", "shard", "]", ".", "write", "(", "example", ".", "SerializeToString", "(", ")", ")", "\n", "shard", "=", "(", "shard", "+", "1", ")", "%", "num_shards", "\n", "\n", "", "for", "writer", "in", "writers", ":", "\n", "        ", "writer", ".", "close", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.parse_args": [[113, 136], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args"], ["", "", "def", "parse_args", "(", ")", ":", "\n", "    ", "msg", "=", "\"convert inputs to tf.Record format\"", "\n", "usage", "=", "\"input_converter.py [<args>] [-h | --help]\"", "\n", "parser", "=", "argparse", ".", "ArgumentParser", "(", "description", "=", "msg", ",", "usage", "=", "usage", ")", "\n", "\n", "parser", ".", "add_argument", "(", "\"--input\"", ",", "required", "=", "True", ",", "type", "=", "str", ",", "nargs", "=", "2", ",", "\n", "help", "=", "\"Path of input file\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--output_name\"", ",", "required", "=", "True", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Output name\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--output_dir\"", ",", "required", "=", "True", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Output directory\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--vocab\"", ",", "nargs", "=", "2", ",", "required", "=", "True", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Path of vocabulary\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--num_shards\"", ",", "default", "=", "100", ",", "type", "=", "int", ",", "\n", "help", "=", "\"Number of output shards\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--shuffle\"", ",", "action", "=", "\"store_true\"", ",", "\n", "help", "=", "\"Shuffle inputs\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--unk\"", ",", "default", "=", "\"<unk>\"", ",", "type", "=", "str", ",", "\n", "help", "=", "\"Unknown word symbol\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--eos\"", ",", "default", "=", "\"<eos>\"", ",", "type", "=", "str", ",", "\n", "help", "=", "\"End of sentence symbol\"", ")", "\n", "\n", "return", "parser", ".", "parse_args", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.main": [[138, 145], ["input_converter.load_vocab", "input_converter.load_vocab", "input_converter.convert_to_record"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.load_vocab", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.load_vocab", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.input_converter.convert_to_record"], ["", "def", "main", "(", "_", ")", ":", "\n", "    ", "svocab", "=", "load_vocab", "(", "FLAGS", ".", "vocab", "[", "0", "]", ")", "\n", "tvocab", "=", "load_vocab", "(", "FLAGS", ".", "vocab", "[", "1", "]", ")", "\n", "\n", "# convert data", "\n", "convert_to_record", "(", "FLAGS", ".", "input", ",", "[", "svocab", ",", "tvocab", "]", ",", "FLAGS", ".", "output_name", ",", "\n", "FLAGS", ".", "output_dir", ",", "FLAGS", ".", "num_shards", ",", "FLAGS", ".", "shuffle", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.count_words": [[13, 25], ["collections.Counter", "sorted", "list", "open", "collections.Counter.items", "zip", "line.strip().split", "collections.Counter.update", "line.strip"], "function", ["None"], ["def", "count_words", "(", "filename", ")", ":", "\n", "    ", "counter", "=", "collections", ".", "Counter", "(", ")", "\n", "\n", "with", "open", "(", "filename", ",", "\"r\"", ")", "as", "fd", ":", "\n", "        ", "for", "line", "in", "fd", ":", "\n", "            ", "words", "=", "line", ".", "strip", "(", ")", ".", "split", "(", ")", "\n", "counter", ".", "update", "(", "words", ")", "\n", "\n", "", "", "count_pairs", "=", "sorted", "(", "counter", ".", "items", "(", ")", ",", "key", "=", "lambda", "x", ":", "(", "-", "x", "[", "1", "]", ",", "x", "[", "0", "]", ")", ")", "\n", "words", ",", "counts", "=", "list", "(", "zip", "(", "*", "count_pairs", ")", ")", "\n", "\n", "return", "words", ",", "counts", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.control_symbols": [[27, 32], ["string.strip().split", "string.strip"], "function", ["None"], ["", "def", "control_symbols", "(", "string", ")", ":", "\n", "    ", "if", "not", "string", ":", "\n", "        ", "return", "[", "]", "\n", "", "else", ":", "\n", "        ", "return", "string", ".", "strip", "(", ")", ".", "split", "(", "\",\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.save_vocab": [[34, 44], ["sorted", "list", "vocab.items", "zip", "open", "name.split", "f.write"], "function", ["None"], ["", "", "def", "save_vocab", "(", "name", ",", "vocab", ")", ":", "\n", "    ", "if", "name", ".", "split", "(", "\".\"", ")", "[", "-", "1", "]", "!=", "\"txt\"", ":", "\n", "        ", "name", "=", "name", "+", "\".txt\"", "\n", "\n", "", "pairs", "=", "sorted", "(", "vocab", ".", "items", "(", ")", ",", "key", "=", "lambda", "x", ":", "(", "x", "[", "1", "]", ",", "x", "[", "0", "]", ")", ")", "\n", "words", ",", "ids", "=", "list", "(", "zip", "(", "*", "pairs", ")", ")", "\n", "\n", "with", "open", "(", "name", ",", "\"w\"", ")", "as", "f", ":", "\n", "        ", "for", "word", "in", "words", ":", "\n", "            ", "f", ".", "write", "(", "word", "+", "\"\\n\"", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args": [[46, 58], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.parse_args"], ["", "", "", "def", "parse_args", "(", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", "description", "=", "\"Create vocabulary\"", ")", "\n", "\n", "parser", ".", "add_argument", "(", "\"corpus\"", ",", "help", "=", "\"input corpus\"", ")", "\n", "parser", ".", "add_argument", "(", "\"output\"", ",", "default", "=", "\"vocab.txt\"", ",", "\n", "help", "=", "\"Output vocabulary name\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--limit\"", ",", "default", "=", "0", ",", "type", "=", "int", ",", "help", "=", "\"Vocabulary size\"", ")", "\n", "parser", ".", "add_argument", "(", "\"--control\"", ",", "type", "=", "str", ",", "default", "=", "\"<pad>,<eos>,<unk>\"", ",", "\n", "help", "=", "\"Add control symbols to vocabulary. \"", "\n", "\"Control symbols are separated by comma.\"", ")", "\n", "\n", "return", "parser", ".", "parse_args", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.main": [[60, 87], ["build_vocab.count_words", "build_vocab.control_symbols", "zip", "build_vocab.save_vocab", "print", "print", "print", "len", "len", "print", "sum", "len", "len", "sum"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.count_words", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.control_symbols", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.build_vocab.save_vocab"], ["", "def", "main", "(", "args", ")", ":", "\n", "    ", "vocab", "=", "{", "}", "\n", "limit", "=", "args", ".", "limit", "\n", "count", "=", "0", "\n", "\n", "words", ",", "counts", "=", "count_words", "(", "args", ".", "corpus", ")", "\n", "ctrl_symbols", "=", "control_symbols", "(", "args", ".", "control", ")", "\n", "\n", "for", "sym", "in", "ctrl_symbols", ":", "\n", "        ", "vocab", "[", "sym", "]", "=", "len", "(", "vocab", ")", "\n", "\n", "", "for", "word", ",", "freq", "in", "zip", "(", "words", ",", "counts", ")", ":", "\n", "        ", "if", "limit", "and", "len", "(", "vocab", ")", ">=", "limit", ":", "\n", "            ", "break", "\n", "\n", "", "if", "word", "in", "vocab", ":", "\n", "            ", "print", "(", "\"Warning: found duplicate token %s, ignored\"", "%", "word", ")", "\n", "continue", "\n", "\n", "", "vocab", "[", "word", "]", "=", "len", "(", "vocab", ")", "\n", "count", "+=", "freq", "\n", "\n", "", "save_vocab", "(", "args", ".", "output", ",", "vocab", ")", "\n", "\n", "print", "(", "\"Total words: %d\"", "%", "sum", "(", "counts", ")", ")", "\n", "print", "(", "\"Unique words: %d\"", "%", "len", "(", "words", ")", ")", "\n", "print", "(", "\"Vocabulary coverage: %4.2f%%\"", "%", "(", "100.0", "*", "count", "/", "sum", "(", "counts", ")", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.scripts.visualize.parse_numpy": [[10, 15], ["re.sub.replace().replace().replace", "re.sub", "numpy.fromstring", "re.sub.replace().replace", "re.sub.replace"], "function", ["None"], ["def", "parse_numpy", "(", "string", ")", ":", "\n", "    ", "string", "=", "string", ".", "replace", "(", "'['", ",", "' '", ")", ".", "replace", "(", "']'", ",", "' '", ")", ".", "replace", "(", "','", ",", "' '", ")", "\n", "string", "=", "re", ".", "sub", "(", "' +'", ",", "' '", ",", "string", ")", "\n", "result", "=", "numpy", ".", "fromstring", "(", "string", ",", "sep", "=", "' '", ")", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch.RNNsearch.__init__": [[333, 335], ["thumt.NMTModel.__init__"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["    ", "def", "__init__", "(", "self", ",", "params", ",", "scope", "=", "\"rnnsearch\"", ")", ":", "\n", "        ", "super", "(", "RNNsearch", ",", "self", ")", ".", "__init__", "(", "params", "=", "params", ",", "scope", "=", "scope", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch.RNNsearch.get_training_func": [[336, 346], ["tensorflow.variable_scope", "rnnsearch.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_training_func", "(", "self", ",", "initializer", ",", "regularizer", "=", "None", ")", ":", "\n", "        ", "def", "training_fn", "(", "features", ",", "params", "=", "None", ",", "reuse", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "self", ".", "parameters", "\n", "", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ",", "initializer", "=", "initializer", ",", "\n", "regularizer", "=", "regularizer", ",", "reuse", "=", "reuse", ")", ":", "\n", "                ", "loss", "=", "model_graph", "(", "features", ",", "\"train\"", ",", "params", ")", "\n", "return", "loss", "\n", "\n", "", "", "return", "training_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch.RNNsearch.get_evaluation_func": [[347, 364], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "rnnsearch.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_evaluation_func", "(", "self", ")", ":", "\n", "        ", "def", "evaluation_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "params", ".", "dropout", "=", "0.0", "\n", "params", ".", "use_variational_dropout", "=", "False", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "score", "=", "model_graph", "(", "features", ",", "\"eval\"", ",", "params", ")", "\n", "\n", "", "return", "score", "\n", "\n", "", "return", "evaluation_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch.RNNsearch.get_inference_func": [[365, 382], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "rnnsearch.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_inference_func", "(", "self", ")", ":", "\n", "        ", "def", "inference_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "params", ".", "dropout", "=", "0.0", "\n", "params", ".", "use_variational_dropout", "=", "False", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "log_prob", "=", "model_graph", "(", "features", ",", "\"infer\"", ",", "params", ")", "\n", "\n", "", "return", "log_prob", "\n", "\n", "", "return", "inference_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch.RNNsearch.get_name": [[383, 386], ["None"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_name", "(", ")", ":", "\n", "        ", "return", "\"rnnsearch\"", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch.RNNsearch.get_parameters": [[387, 412], ["tensorflow.contrib.training.HParams"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_parameters", "(", ")", ":", "\n", "        ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", "\n", "# vocabulary", "\n", "pad", "=", "\"<pad>\"", ",", "\n", "unk", "=", "\"<unk>\"", ",", "\n", "eos", "=", "\"<eos>\"", ",", "\n", "bos", "=", "\"<eos>\"", ",", "\n", "append_eos", "=", "False", ",", "\n", "# model", "\n", "rnn_cell", "=", "\"LegacyGRUCell\"", ",", "\n", "embedding_size", "=", "620", ",", "\n", "hidden_size", "=", "1000", ",", "\n", "maxnum", "=", "2", ",", "\n", "# regularization", "\n", "dropout", "=", "0.2", ",", "\n", "use_variational_dropout", "=", "False", ",", "\n", "label_smoothing", "=", "0.1", ",", "\n", "constant_batch_size", "=", "True", ",", "\n", "batch_size", "=", "128", ",", "\n", "max_length", "=", "60", ",", "\n", "clip_grad_norm", "=", "5.0", "\n", ")", "\n", "\n", "return", "params", "\n", "", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch._copy_through": [[15, 18], ["tensorflow.where"], "function", ["None"], ["def", "_copy_through", "(", "time", ",", "length", ",", "output", ",", "new_output", ")", ":", "\n", "    ", "copy_cond", "=", "(", "time", ">=", "length", ")", "\n", "return", "tf", ".", "where", "(", "copy_cond", ",", "output", ",", "new_output", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch._gru_encoder": [[20, 63], ["tensorflow.zeros", "tensorflow.TensorArray", "tensorflow.TensorArray", "input_ta.unstack.unstack", "tensorflow.constant", "tensorflow.while_loop", "output_final_ta.stack", "tf.transpose.set_shape", "tensorflow.transpose", "tensorflow.shape", "tensorflow.shape", "cell.zero_state", "tensorflow.transpose", "input_ta.unstack.read", "cell", "rnnsearch._copy_through", "rnnsearch._copy_through", "out_ta.write.write"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through"], ["", "def", "_gru_encoder", "(", "cell", ",", "inputs", ",", "sequence_length", ",", "initial_state", ",", "dtype", "=", "None", ")", ":", "\n", "# Assume that the underlying cell is GRUCell-like", "\n", "    ", "output_size", "=", "cell", ".", "output_size", "\n", "dtype", "=", "dtype", "or", "inputs", ".", "dtype", "\n", "\n", "batch", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "0", "]", "\n", "time_steps", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "1", "]", "\n", "\n", "zero_output", "=", "tf", ".", "zeros", "(", "[", "batch", ",", "output_size", "]", ",", "dtype", ")", "\n", "\n", "if", "initial_state", "is", "None", ":", "\n", "        ", "initial_state", "=", "cell", ".", "zero_state", "(", "batch", ",", "dtype", ")", "\n", "\n", "", "input_ta", "=", "tf", ".", "TensorArray", "(", "dtype", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"input_array\"", ")", "\n", "output_ta", "=", "tf", ".", "TensorArray", "(", "dtype", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"output_array\"", ")", "\n", "input_ta", "=", "input_ta", ".", "unstack", "(", "tf", ".", "transpose", "(", "inputs", ",", "[", "1", ",", "0", ",", "2", "]", ")", ")", "\n", "\n", "def", "loop_func", "(", "t", ",", "out_ta", ",", "state", ")", ":", "\n", "        ", "inp_t", "=", "input_ta", ".", "read", "(", "t", ")", "\n", "cell_output", ",", "new_state", "=", "cell", "(", "inp_t", ",", "state", ")", "\n", "cell_output", "=", "_copy_through", "(", "t", ",", "sequence_length", ",", "zero_output", ",", "\n", "cell_output", ")", "\n", "new_state", "=", "_copy_through", "(", "t", ",", "sequence_length", ",", "state", ",", "new_state", ")", "\n", "out_ta", "=", "out_ta", ".", "write", "(", "t", ",", "cell_output", ")", "\n", "return", "t", "+", "1", ",", "out_ta", ",", "new_state", "\n", "\n", "", "time", "=", "tf", ".", "constant", "(", "0", ",", "dtype", "=", "tf", ".", "int32", ",", "name", "=", "\"time\"", ")", "\n", "loop_vars", "=", "(", "time", ",", "output_ta", ",", "initial_state", ")", "\n", "\n", "outputs", "=", "tf", ".", "while_loop", "(", "lambda", "t", ",", "*", "_", ":", "t", "<", "time_steps", ",", "loop_func", ",", "\n", "loop_vars", ",", "parallel_iterations", "=", "32", ",", "\n", "swap_memory", "=", "True", ")", "\n", "\n", "output_final_ta", "=", "outputs", "[", "1", "]", "\n", "final_state", "=", "outputs", "[", "2", "]", "\n", "\n", "all_output", "=", "output_final_ta", ".", "stack", "(", ")", "\n", "all_output", ".", "set_shape", "(", "[", "None", ",", "None", ",", "output_size", "]", ")", "\n", "all_output", "=", "tf", ".", "transpose", "(", "all_output", ",", "[", "1", ",", "0", ",", "2", "]", ")", "\n", "\n", "return", "all_output", ",", "final_state", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch._encoder": [[65, 98], ["tensorflow.variable_scope", "tensorflow.reverse_sequence", "tensorflow.variable_scope", "rnnsearch._gru_encoder", "tensorflow.variable_scope", "rnnsearch._gru_encoder", "tensorflow.reverse_sequence", "tensorflow.concat"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._gru_encoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._gru_encoder"], ["", "def", "_encoder", "(", "cell_fw", ",", "cell_bw", ",", "inputs", ",", "sequence_length", ",", "dtype", "=", "None", ",", "\n", "scope", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "scope", "or", "\"encoder\"", ",", "\n", "values", "=", "[", "inputs", ",", "sequence_length", "]", ")", ":", "\n", "        ", "inputs_fw", "=", "inputs", "\n", "inputs_bw", "=", "tf", ".", "reverse_sequence", "(", "inputs", ",", "sequence_length", ",", "\n", "batch_axis", "=", "0", ",", "seq_axis", "=", "1", ")", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "\"forward\"", ")", ":", "\n", "            ", "output_fw", ",", "state_fw", "=", "_gru_encoder", "(", "cell_fw", ",", "inputs_fw", ",", "\n", "sequence_length", ",", "None", ",", "\n", "dtype", "=", "dtype", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"backward\"", ")", ":", "\n", "            ", "output_bw", ",", "state_bw", "=", "_gru_encoder", "(", "cell_bw", ",", "inputs_bw", ",", "\n", "sequence_length", ",", "None", ",", "\n", "dtype", "=", "dtype", ")", "\n", "output_bw", "=", "tf", ".", "reverse_sequence", "(", "output_bw", ",", "sequence_length", ",", "\n", "batch_axis", "=", "0", ",", "seq_axis", "=", "1", ")", "\n", "\n", "", "results", "=", "{", "\n", "\"annotation\"", ":", "tf", ".", "concat", "(", "[", "output_fw", ",", "output_bw", "]", ",", "axis", "=", "2", ")", ",", "\n", "\"outputs\"", ":", "{", "\n", "\"forward\"", ":", "output_fw", ",", "\n", "\"backward\"", ":", "output_bw", "\n", "}", ",", "\n", "\"final_states\"", ":", "{", "\n", "\"forward\"", ":", "state_fw", ",", "\n", "\"backward\"", ":", "state_bw", "\n", "}", "\n", "}", "\n", "\n", "return", "results", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch._decoder": [[100, 181], ["tensorflow.zeros", "tensorflow.zeros", "tensorflow.shape", "tensorflow.shape", "tensorflow.variable_scope", "tensorflow.transpose", "tensorflow.sequence_mask", "thumt.attention.attention_bias", "tensorflow.squeeze", "thumt.attention.attention", "tensorflow.TensorArray", "tensorflow.TensorArray", "tensorflow.TensorArray", "tensorflow.TensorArray", "input_ta.unstack.unstack", "thumt.nn.linear", "tensorflow.tanh", "tensorflow.constant", "tensorflow.while_loop", "output_final_ta.stack", "tf.transpose.set_shape", "tensorflow.transpose", "value_final_ta.stack", "tf.transpose.set_shape", "tensorflow.transpose", "input_ta.unstack.read", "thumt.attention.attention", "cell", "rnnsearch._copy_through", "rnnsearch._copy_through", "rnnsearch._copy_through", "out_ta.write.write", "att_ta.write.write", "val_ta.write.write", "tensorflow.identity", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_bias", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through"], ["", "", "def", "_decoder", "(", "cell", ",", "inputs", ",", "memory", ",", "sequence_length", ",", "initial_state", ",", "dtype", "=", "None", ",", "\n", "scope", "=", "None", ")", ":", "\n", "# Assume that the underlying cell is GRUCell-like", "\n", "    ", "batch", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "0", "]", "\n", "time_steps", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "1", "]", "\n", "dtype", "=", "dtype", "or", "inputs", ".", "dtype", "\n", "output_size", "=", "cell", ".", "output_size", "\n", "zero_output", "=", "tf", ".", "zeros", "(", "[", "batch", ",", "output_size", "]", ",", "dtype", ")", "\n", "zero_value", "=", "tf", ".", "zeros", "(", "[", "batch", ",", "memory", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ",", "dtype", ")", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "scope", "or", "\"decoder\"", ",", "dtype", "=", "dtype", ")", ":", "\n", "        ", "inputs", "=", "tf", ".", "transpose", "(", "inputs", ",", "[", "1", ",", "0", ",", "2", "]", ")", "\n", "mem_mask", "=", "tf", ".", "sequence_mask", "(", "sequence_length", "[", "\"source\"", "]", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "memory", ")", "[", "1", "]", ",", "\n", "dtype", "=", "tf", ".", "float32", ")", "\n", "bias", "=", "layers", ".", "attention", ".", "attention_bias", "(", "mem_mask", ",", "\"masking\"", ")", "\n", "bias", "=", "tf", ".", "squeeze", "(", "bias", ",", "axis", "=", "[", "1", ",", "2", "]", ")", "\n", "cache", "=", "layers", ".", "attention", ".", "attention", "(", "None", ",", "memory", ",", "None", ",", "output_size", ")", "\n", "\n", "input_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"input_array\"", ")", "\n", "output_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"output_array\"", ")", "\n", "value_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"value_array\"", ")", "\n", "alpha_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"alpha_array\"", ")", "\n", "input_ta", "=", "input_ta", ".", "unstack", "(", "inputs", ")", "\n", "initial_state", "=", "layers", ".", "nn", ".", "linear", "(", "initial_state", ",", "output_size", ",", "True", ",", "\n", "False", ",", "scope", "=", "\"s_transform\"", ")", "\n", "initial_state", "=", "tf", ".", "tanh", "(", "initial_state", ")", "\n", "\n", "def", "loop_func", "(", "t", ",", "out_ta", ",", "att_ta", ",", "val_ta", ",", "state", ",", "cache_key", ")", ":", "\n", "            ", "inp_t", "=", "input_ta", ".", "read", "(", "t", ")", "\n", "results", "=", "layers", ".", "attention", ".", "attention", "(", "state", ",", "memory", ",", "bias", ",", "\n", "output_size", ",", "\n", "cache", "=", "{", "\"key\"", ":", "cache_key", "}", ")", "\n", "alpha", "=", "results", "[", "\"weight\"", "]", "\n", "context", "=", "results", "[", "\"value\"", "]", "\n", "cell_input", "=", "[", "inp_t", ",", "context", "]", "\n", "cell_output", ",", "new_state", "=", "cell", "(", "cell_input", ",", "state", ")", "\n", "cell_output", "=", "_copy_through", "(", "t", ",", "sequence_length", "[", "\"target\"", "]", ",", "\n", "zero_output", ",", "cell_output", ")", "\n", "new_state", "=", "_copy_through", "(", "t", ",", "sequence_length", "[", "\"target\"", "]", ",", "state", ",", "\n", "new_state", ")", "\n", "new_value", "=", "_copy_through", "(", "t", ",", "sequence_length", "[", "\"target\"", "]", ",", "zero_value", ",", "\n", "context", ")", "\n", "\n", "out_ta", "=", "out_ta", ".", "write", "(", "t", ",", "cell_output", ")", "\n", "att_ta", "=", "att_ta", ".", "write", "(", "t", ",", "alpha", ")", "\n", "val_ta", "=", "val_ta", ".", "write", "(", "t", ",", "new_value", ")", "\n", "cache_key", "=", "tf", ".", "identity", "(", "cache_key", ")", "\n", "return", "t", "+", "1", ",", "out_ta", ",", "att_ta", ",", "val_ta", ",", "new_state", ",", "cache_key", "\n", "\n", "", "time", "=", "tf", ".", "constant", "(", "0", ",", "dtype", "=", "tf", ".", "int32", ",", "name", "=", "\"time\"", ")", "\n", "loop_vars", "=", "(", "time", ",", "output_ta", ",", "alpha_ta", ",", "value_ta", ",", "initial_state", ",", "\n", "cache", "[", "\"key\"", "]", ")", "\n", "\n", "outputs", "=", "tf", ".", "while_loop", "(", "lambda", "t", ",", "*", "_", ":", "t", "<", "time_steps", ",", "\n", "loop_func", ",", "loop_vars", ",", "\n", "parallel_iterations", "=", "32", ",", "\n", "swap_memory", "=", "True", ")", "\n", "\n", "output_final_ta", "=", "outputs", "[", "1", "]", "\n", "value_final_ta", "=", "outputs", "[", "3", "]", "\n", "\n", "final_output", "=", "output_final_ta", ".", "stack", "(", ")", "\n", "final_output", ".", "set_shape", "(", "[", "None", ",", "None", ",", "output_size", "]", ")", "\n", "final_output", "=", "tf", ".", "transpose", "(", "final_output", ",", "[", "1", ",", "0", ",", "2", "]", ")", "\n", "\n", "final_value", "=", "value_final_ta", ".", "stack", "(", ")", "\n", "final_value", ".", "set_shape", "(", "[", "None", ",", "None", ",", "memory", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "\n", "final_value", "=", "tf", ".", "transpose", "(", "final_value", ",", "[", "1", ",", "0", ",", "2", "]", ")", "\n", "\n", "result", "=", "{", "\n", "\"outputs\"", ":", "final_output", ",", "\n", "\"values\"", ":", "final_value", ",", "\n", "\"initial_state\"", ":", "initial_state", "\n", "}", "\n", "\n", "", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch.model_graph": [[183, 329], ["len", "len", "tensorflow.nn.bias_add", "tensorflow.nn.bias_add", "thumt.rnn_cell.LegacyGRUCell", "thumt.rnn_cell.LegacyGRUCell", "rnnsearch._encoder", "thumt.rnn_cell.LegacyGRUCell", "rnnsearch._decoder", "tensorflow.pad", "tensorflow.concat", "thumt.nn.maxout", "thumt.nn.linear", "thumt.nn.linear", "tensorflow.reshape", "thumt.nn.smoothed_softmax_cross_entropy_with_logits", "tensorflow.reshape", "tensorflow.to_float", "tensorflow.variable_scope", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.nn.embedding_lookup", "tensorflow.variable_scope", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.nn.embedding_lookup", "tensorflow.nn.dropout", "tensorflow.nn.dropout", "tensorflow.nn.rnn_cell.DropoutWrapper", "tensorflow.nn.rnn_cell.DropoutWrapper", "tensorflow.nn.rnn_cell.DropoutWrapper", "thumt.nn.maxout", "thumt.nn.linear", "thumt.nn.linear", "tensorflow.nn.log_softmax", "tensorflow.nn.dropout", "tensorflow.shape", "tensorflow.sequence_mask", "tensorflow.reduce_sum", "tensorflow.reduce_sum", "tensorflow.expand_dims", "tensorflow.reduce_sum", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._encoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._decoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.maxout", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.smoothed_softmax_cross_entropy_with_logits", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.maxout", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear"], ["", "def", "model_graph", "(", "features", ",", "mode", ",", "params", ")", ":", "\n", "    ", "src_vocab_size", "=", "len", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ")", "\n", "tgt_vocab_size", "=", "len", "(", "params", ".", "vocabulary", "[", "\"target\"", "]", ")", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "\"source_embedding\"", ")", ":", "\n", "        ", "src_emb", "=", "tf", ".", "get_variable", "(", "\"embedding\"", ",", "\n", "[", "src_vocab_size", ",", "params", ".", "embedding_size", "]", ")", "\n", "src_bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "[", "params", ".", "embedding_size", "]", ")", "\n", "src_inputs", "=", "tf", ".", "nn", ".", "embedding_lookup", "(", "src_emb", ",", "features", "[", "\"source\"", "]", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"target_embedding\"", ")", ":", "\n", "        ", "tgt_emb", "=", "tf", ".", "get_variable", "(", "\"embedding\"", ",", "\n", "[", "tgt_vocab_size", ",", "params", ".", "embedding_size", "]", ")", "\n", "tgt_bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "[", "params", ".", "embedding_size", "]", ")", "\n", "tgt_inputs", "=", "tf", ".", "nn", ".", "embedding_lookup", "(", "tgt_emb", ",", "features", "[", "\"target\"", "]", ")", "\n", "\n", "", "src_inputs", "=", "tf", ".", "nn", ".", "bias_add", "(", "src_inputs", ",", "src_bias", ")", "\n", "tgt_inputs", "=", "tf", ".", "nn", ".", "bias_add", "(", "tgt_inputs", ",", "tgt_bias", ")", "\n", "\n", "if", "params", ".", "dropout", "and", "not", "params", ".", "use_variational_dropout", ":", "\n", "        ", "src_inputs", "=", "tf", ".", "nn", ".", "dropout", "(", "src_inputs", ",", "1.0", "-", "params", ".", "dropout", ")", "\n", "tgt_inputs", "=", "tf", ".", "nn", ".", "dropout", "(", "tgt_inputs", ",", "1.0", "-", "params", ".", "dropout", ")", "\n", "\n", "# encoder", "\n", "", "cell_fw", "=", "layers", ".", "rnn_cell", ".", "LegacyGRUCell", "(", "params", ".", "hidden_size", ")", "\n", "cell_bw", "=", "layers", ".", "rnn_cell", ".", "LegacyGRUCell", "(", "params", ".", "hidden_size", ")", "\n", "\n", "if", "params", ".", "use_variational_dropout", ":", "\n", "        ", "cell_fw", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "DropoutWrapper", "(", "\n", "cell_fw", ",", "\n", "input_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "output_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "state_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "variational_recurrent", "=", "True", ",", "\n", "input_size", "=", "params", ".", "embedding_size", ",", "\n", "dtype", "=", "tf", ".", "float32", "\n", ")", "\n", "cell_bw", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "DropoutWrapper", "(", "\n", "cell_bw", ",", "\n", "input_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "output_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "state_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "variational_recurrent", "=", "True", ",", "\n", "input_size", "=", "params", ".", "embedding_size", ",", "\n", "dtype", "=", "tf", ".", "float32", "\n", ")", "\n", "\n", "", "encoder_output", "=", "_encoder", "(", "cell_fw", ",", "cell_bw", ",", "src_inputs", ",", "\n", "features", "[", "\"source_length\"", "]", ")", "\n", "\n", "# decoder", "\n", "cell", "=", "layers", ".", "rnn_cell", ".", "LegacyGRUCell", "(", "params", ".", "hidden_size", ")", "\n", "\n", "if", "params", ".", "use_variational_dropout", ":", "\n", "        ", "cell", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "DropoutWrapper", "(", "\n", "cell", ",", "\n", "input_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "output_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "state_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "variational_recurrent", "=", "True", ",", "\n", "# input + context", "\n", "input_size", "=", "params", ".", "embedding_size", "+", "2", "*", "params", ".", "hidden_size", ",", "\n", "dtype", "=", "tf", ".", "float32", "\n", ")", "\n", "\n", "", "length", "=", "{", "\n", "\"source\"", ":", "features", "[", "\"source_length\"", "]", ",", "\n", "\"target\"", ":", "features", "[", "\"target_length\"", "]", "\n", "}", "\n", "initial_state", "=", "encoder_output", "[", "\"final_states\"", "]", "[", "\"backward\"", "]", "\n", "decoder_output", "=", "_decoder", "(", "cell", ",", "tgt_inputs", ",", "encoder_output", "[", "\"annotation\"", "]", ",", "\n", "length", ",", "initial_state", ")", "\n", "\n", "# Shift left", "\n", "shifted_tgt_inputs", "=", "tf", ".", "pad", "(", "tgt_inputs", ",", "[", "[", "0", ",", "0", "]", ",", "[", "1", ",", "0", "]", ",", "[", "0", ",", "0", "]", "]", ")", "\n", "shifted_tgt_inputs", "=", "shifted_tgt_inputs", "[", ":", ",", ":", "-", "1", ",", ":", "]", "\n", "\n", "all_outputs", "=", "tf", ".", "concat", "(", "\n", "[", "\n", "tf", ".", "expand_dims", "(", "decoder_output", "[", "\"initial_state\"", "]", ",", "axis", "=", "1", ")", ",", "\n", "decoder_output", "[", "\"outputs\"", "]", ",", "\n", "]", ",", "\n", "axis", "=", "1", "\n", ")", "\n", "shifted_outputs", "=", "all_outputs", "[", ":", ",", ":", "-", "1", ",", ":", "]", "\n", "\n", "maxout_features", "=", "[", "\n", "shifted_tgt_inputs", ",", "\n", "shifted_outputs", ",", "\n", "decoder_output", "[", "\"values\"", "]", "\n", "]", "\n", "maxout_size", "=", "params", ".", "hidden_size", "//", "params", ".", "maxnum", "\n", "\n", "if", "mode", "is", "\"infer\"", ":", "\n", "# Special case for non-incremental decoding", "\n", "        ", "maxout_features", "=", "[", "\n", "shifted_tgt_inputs", "[", ":", ",", "-", "1", ",", ":", "]", ",", "\n", "shifted_outputs", "[", ":", ",", "-", "1", ",", ":", "]", ",", "\n", "decoder_output", "[", "\"values\"", "]", "[", ":", ",", "-", "1", ",", ":", "]", "\n", "]", "\n", "maxhid", "=", "layers", ".", "nn", ".", "maxout", "(", "maxout_features", ",", "maxout_size", ",", "params", ".", "maxnum", ",", "\n", "concat", "=", "False", ")", "\n", "readout", "=", "layers", ".", "nn", ".", "linear", "(", "maxhid", ",", "params", ".", "embedding_size", ",", "False", ",", "\n", "False", ",", "scope", "=", "\"deepout\"", ")", "\n", "\n", "# Prediction", "\n", "logits", "=", "layers", ".", "nn", ".", "linear", "(", "readout", ",", "tgt_vocab_size", ",", "True", ",", "False", ",", "\n", "scope", "=", "\"softmax\"", ")", "\n", "\n", "return", "tf", ".", "nn", ".", "log_softmax", "(", "logits", ")", "\n", "\n", "", "maxhid", "=", "layers", ".", "nn", ".", "maxout", "(", "maxout_features", ",", "maxout_size", ",", "params", ".", "maxnum", ",", "\n", "concat", "=", "False", ")", "\n", "readout", "=", "layers", ".", "nn", ".", "linear", "(", "maxhid", ",", "params", ".", "embedding_size", ",", "False", ",", "False", ",", "\n", "scope", "=", "\"deepout\"", ")", "\n", "\n", "if", "params", ".", "dropout", "and", "not", "params", ".", "use_variational_dropout", ":", "\n", "        ", "readout", "=", "tf", ".", "nn", ".", "dropout", "(", "readout", ",", "1.0", "-", "params", ".", "dropout", ")", "\n", "\n", "# Prediction", "\n", "", "logits", "=", "layers", ".", "nn", ".", "linear", "(", "readout", ",", "tgt_vocab_size", ",", "True", ",", "False", ",", "\n", "scope", "=", "\"softmax\"", ")", "\n", "logits", "=", "tf", ".", "reshape", "(", "logits", ",", "[", "-", "1", ",", "tgt_vocab_size", "]", ")", "\n", "labels", "=", "features", "[", "\"target\"", "]", "\n", "\n", "ce", "=", "layers", ".", "nn", ".", "smoothed_softmax_cross_entropy_with_logits", "(", "\n", "logits", "=", "logits", ",", "\n", "labels", "=", "labels", ",", "\n", "smoothing", "=", "params", ".", "label_smoothing", ",", "\n", "normalize", "=", "True", "\n", ")", "\n", "\n", "ce", "=", "tf", ".", "reshape", "(", "ce", ",", "tf", ".", "shape", "(", "labels", ")", ")", "\n", "tgt_mask", "=", "tf", ".", "to_float", "(", "\n", "tf", ".", "sequence_mask", "(", "\n", "features", "[", "\"target_length\"", "]", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "features", "[", "\"target\"", "]", ")", "[", "1", "]", "\n", ")", "\n", ")", "\n", "\n", "if", "mode", "==", "\"eval\"", ":", "\n", "        ", "return", "-", "tf", ".", "reduce_sum", "(", "ce", "*", "tgt_mask", ",", "axis", "=", "1", ")", "\n", "\n", "", "loss", "=", "tf", ".", "reduce_sum", "(", "ce", "*", "tgt_mask", ")", "/", "tf", ".", "reduce_sum", "(", "tgt_mask", ")", "\n", "\n", "return", "loss", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.seq2seq.Seq2Seq.__init__": [[137, 139], ["thumt.NMTModel.__init__"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["    ", "def", "__init__", "(", "self", ",", "params", ",", "scope", "=", "\"seq2seq\"", ")", ":", "\n", "        ", "super", "(", "Seq2Seq", ",", "self", ")", ".", "__init__", "(", "params", "=", "params", ",", "scope", "=", "scope", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.seq2seq.Seq2Seq.get_training_func": [[140, 150], ["tensorflow.variable_scope", "seq2seq.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_training_func", "(", "self", ",", "initializer", ",", "regularizer", "=", "None", ")", ":", "\n", "        ", "def", "training_fn", "(", "features", ",", "params", "=", "None", ",", "reuse", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "self", ".", "parameters", "\n", "", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ",", "initializer", "=", "initializer", ",", "\n", "regularizer", "=", "regularizer", ",", "reuse", "=", "reuse", ")", ":", "\n", "                ", "loss", "=", "model_graph", "(", "features", ",", "\"train\"", ",", "params", ")", "\n", "return", "loss", "\n", "\n", "", "", "return", "training_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.seq2seq.Seq2Seq.get_evaluation_func": [[151, 167], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "seq2seq.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_evaluation_func", "(", "self", ")", ":", "\n", "        ", "def", "evaluation_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "", "params", ".", "dropout", "=", "0.0", "\n", "params", ".", "use_variational_dropout", "=", "False", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "score", "=", "model_graph", "(", "features", ",", "\"eval\"", ",", "params", ")", "\n", "\n", "", "return", "score", "\n", "\n", "", "return", "evaluation_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.seq2seq.Seq2Seq.get_inference_func": [[168, 184], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "seq2seq.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_inference_func", "(", "self", ")", ":", "\n", "        ", "def", "inference_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "", "params", ".", "dropout", "=", "0.0", "\n", "params", ".", "use_variational_dropout", "=", "False", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "logits", "=", "model_graph", "(", "features", ",", "\"infer\"", ",", "params", ")", "\n", "\n", "", "return", "logits", "\n", "\n", "", "return", "inference_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.seq2seq.Seq2Seq.get_name": [[185, 188], ["None"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_name", "(", ")", ":", "\n", "        ", "return", "\"seq2seq\"", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.seq2seq.Seq2Seq.get_parameters": [[189, 216], ["tensorflow.contrib.training.HParams"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_parameters", "(", ")", ":", "\n", "        ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", "\n", "# vocabulary", "\n", "pad", "=", "\"<pad>\"", ",", "\n", "bos", "=", "\"<eos>\"", ",", "\n", "eos", "=", "\"<eos>\"", ",", "\n", "unk", "=", "\"<unk>\"", ",", "\n", "append_eos", "=", "False", ",", "\n", "# model", "\n", "rnn_cell", "=", "\"LSTMCell\"", ",", "\n", "embedding_size", "=", "1000", ",", "\n", "hidden_size", "=", "1000", ",", "\n", "num_hidden_layers", "=", "4", ",", "\n", "# regularization", "\n", "dropout", "=", "0.2", ",", "\n", "use_variational_dropout", "=", "False", ",", "\n", "label_smoothing", "=", "0.1", ",", "\n", "constant_batch_size", "=", "True", ",", "\n", "batch_size", "=", "128", ",", "\n", "max_length", "=", "80", ",", "\n", "reverse_source", "=", "True", ",", "\n", "use_residual", "=", "True", ",", "\n", "clip_grad_norm", "=", "5.0", "\n", ")", "\n", "\n", "return", "params", "\n", "", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.seq2seq.model_graph": [[15, 133], ["len", "len", "tensorflow.nn.bias_add", "tensorflow.nn.bias_add", "range", "tensorflow.nn.rnn_cell.MultiRNNCell", "tensorflow.nn.rnn_cell.MultiRNNCell", "tensorflow.pad", "thumt.nn.linear", "tensorflow.reshape", "thumt.nn.smoothed_softmax_cross_entropy_with_logits", "tensorflow.reshape", "tensorflow.to_float", "tensorflow.reverse_sequence", "tensorflow.device", "tensorflow.nn.dropout", "tensorflow.nn.dropout", "tensorflow.nn.rnn_cell.DropoutWrapper", "tensorflow.nn.rnn_cell.DropoutWrapper", "tf.nn.rnn_cell.MultiRNNCell.append", "tf.nn.rnn_cell.MultiRNNCell.append", "tensorflow.variable_scope", "tensorflow.nn.dynamic_rnn", "tensorflow.variable_scope", "tensorflow.nn.dynamic_rnn", "tensorflow.nn.dropout", "thumt.nn.linear", "tensorflow.nn.log_softmax", "tensorflow.shape", "tensorflow.sequence_mask", "tensorflow.reduce_sum", "tensorflow.reduce_sum", "tensorflow.variable_scope", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.nn.embedding_lookup", "tensorflow.variable_scope", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.nn.embedding_lookup", "tensorflow.nn.rnn_cell.BasicLSTMCell", "tensorflow.nn.rnn_cell.BasicLSTMCell", "tensorflow.nn.rnn_cell.ResidualWrapper", "tensorflow.nn.rnn_cell.ResidualWrapper", "tensorflow.reduce_sum", "tensorflow.nn.rnn_cell.GRUCell", "tensorflow.nn.rnn_cell.GRUCell", "ValueError", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.smoothed_softmax_cross_entropy_with_logits", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear"], ["def", "model_graph", "(", "features", ",", "mode", ",", "params", ")", ":", "\n", "    ", "src_vocab_size", "=", "len", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ")", "\n", "tgt_vocab_size", "=", "len", "(", "params", ".", "vocabulary", "[", "\"target\"", "]", ")", "\n", "\n", "src_seq", "=", "features", "[", "\"source\"", "]", "\n", "tgt_seq", "=", "features", "[", "\"target\"", "]", "\n", "\n", "if", "params", ".", "reverse_source", ":", "\n", "        ", "src_seq", "=", "tf", ".", "reverse_sequence", "(", "src_seq", ",", "seq_dim", "=", "1", ",", "\n", "seq_lengths", "=", "features", "[", "\"source_length\"", "]", ")", "\n", "\n", "", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "        ", "with", "tf", ".", "variable_scope", "(", "\"source_embedding\"", ")", ":", "\n", "            ", "src_emb", "=", "tf", ".", "get_variable", "(", "\"embedding\"", ",", "\n", "[", "src_vocab_size", ",", "params", ".", "embedding_size", "]", ")", "\n", "src_bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "[", "params", ".", "embedding_size", "]", ")", "\n", "src_inputs", "=", "tf", ".", "nn", ".", "embedding_lookup", "(", "src_emb", ",", "src_seq", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"target_embedding\"", ")", ":", "\n", "            ", "tgt_emb", "=", "tf", ".", "get_variable", "(", "\"embedding\"", ",", "\n", "[", "tgt_vocab_size", ",", "params", ".", "embedding_size", "]", ")", "\n", "tgt_bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "[", "params", ".", "embedding_size", "]", ")", "\n", "tgt_inputs", "=", "tf", ".", "nn", ".", "embedding_lookup", "(", "tgt_emb", ",", "tgt_seq", ")", "\n", "\n", "", "", "src_inputs", "=", "tf", ".", "nn", ".", "bias_add", "(", "src_inputs", ",", "src_bias", ")", "\n", "tgt_inputs", "=", "tf", ".", "nn", ".", "bias_add", "(", "tgt_inputs", ",", "tgt_bias", ")", "\n", "\n", "if", "params", ".", "dropout", "and", "not", "params", ".", "use_variational_dropout", ":", "\n", "        ", "src_inputs", "=", "tf", ".", "nn", ".", "dropout", "(", "src_inputs", ",", "1.0", "-", "params", ".", "dropout", ")", "\n", "tgt_inputs", "=", "tf", ".", "nn", ".", "dropout", "(", "tgt_inputs", ",", "1.0", "-", "params", ".", "dropout", ")", "\n", "\n", "", "cell_enc", "=", "[", "]", "\n", "cell_dec", "=", "[", "]", "\n", "\n", "for", "_", "in", "range", "(", "params", ".", "num_hidden_layers", ")", ":", "\n", "        ", "if", "params", ".", "rnn_cell", "==", "\"LSTMCell\"", ":", "\n", "            ", "cell_e", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "BasicLSTMCell", "(", "params", ".", "hidden_size", ")", "\n", "cell_d", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "BasicLSTMCell", "(", "params", ".", "hidden_size", ")", "\n", "", "elif", "params", ".", "rnn_cell", "==", "\"GRUCell\"", ":", "\n", "            ", "cell_e", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "GRUCell", "(", "params", ".", "hidden_size", ")", "\n", "cell_d", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "GRUCell", "(", "params", ".", "hidden_size", ")", "\n", "", "else", ":", "\n", "            ", "raise", "ValueError", "(", "\"%s not supported\"", "%", "params", ".", "rnn_cell", ")", "\n", "\n", "", "cell_e", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "DropoutWrapper", "(", "\n", "cell_e", ",", "\n", "output_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "variational_recurrent", "=", "params", ".", "use_variational_dropout", ",", "\n", "input_size", "=", "params", ".", "embedding_size", ",", "\n", "dtype", "=", "tf", ".", "float32", "\n", ")", "\n", "cell_d", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "DropoutWrapper", "(", "\n", "cell_d", ",", "\n", "output_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "variational_recurrent", "=", "params", ".", "use_variational_dropout", ",", "\n", "input_size", "=", "params", ".", "embedding_size", ",", "\n", "dtype", "=", "tf", ".", "float32", "\n", ")", "\n", "\n", "if", "params", ".", "use_residual", ":", "\n", "            ", "cell_e", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "ResidualWrapper", "(", "cell_e", ")", "\n", "cell_d", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "ResidualWrapper", "(", "cell_d", ")", "\n", "\n", "", "cell_enc", ".", "append", "(", "cell_e", ")", "\n", "cell_dec", ".", "append", "(", "cell_d", ")", "\n", "\n", "", "cell_enc", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "MultiRNNCell", "(", "cell_enc", ")", "\n", "cell_dec", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "MultiRNNCell", "(", "cell_dec", ")", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "\"encoder\"", ")", ":", "\n", "        ", "_", ",", "final_state", "=", "tf", ".", "nn", ".", "dynamic_rnn", "(", "cell_enc", ",", "src_inputs", ",", "\n", "features", "[", "\"source_length\"", "]", ",", "\n", "dtype", "=", "tf", ".", "float32", ")", "\n", "# Shift left", "\n", "", "shifted_tgt_inputs", "=", "tf", ".", "pad", "(", "tgt_inputs", ",", "[", "[", "0", ",", "0", "]", ",", "[", "1", ",", "0", "]", ",", "[", "0", ",", "0", "]", "]", ")", "\n", "shifted_tgt_inputs", "=", "shifted_tgt_inputs", "[", ":", ",", ":", "-", "1", ",", ":", "]", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "\"decoder\"", ")", ":", "\n", "        ", "outputs", ",", "_", "=", "tf", ".", "nn", ".", "dynamic_rnn", "(", "cell_dec", ",", "shifted_tgt_inputs", ",", "\n", "features", "[", "\"target_length\"", "]", ",", "\n", "initial_state", "=", "final_state", ")", "\n", "\n", "", "if", "params", ".", "dropout", ":", "\n", "        ", "outputs", "=", "tf", ".", "nn", ".", "dropout", "(", "outputs", ",", "1.0", "-", "params", ".", "dropout", ")", "\n", "\n", "", "if", "mode", "==", "\"infer\"", ":", "\n", "# Prediction", "\n", "        ", "logits", "=", "layers", ".", "nn", ".", "linear", "(", "outputs", "[", ":", ",", "-", "1", ",", ":", "]", ",", "tgt_vocab_size", ",", "True", ",", "\n", "scope", "=", "\"softmax\"", ")", "\n", "\n", "return", "tf", ".", "nn", ".", "log_softmax", "(", "logits", ")", "\n", "\n", "# Prediction", "\n", "", "logits", "=", "layers", ".", "nn", ".", "linear", "(", "outputs", ",", "tgt_vocab_size", ",", "True", ",", "scope", "=", "\"softmax\"", ")", "\n", "logits", "=", "tf", ".", "reshape", "(", "logits", ",", "[", "-", "1", ",", "tgt_vocab_size", "]", ")", "\n", "labels", "=", "features", "[", "\"target\"", "]", "\n", "\n", "ce", "=", "layers", ".", "nn", ".", "smoothed_softmax_cross_entropy_with_logits", "(", "\n", "logits", "=", "logits", ",", "\n", "labels", "=", "labels", ",", "\n", "smoothing", "=", "params", ".", "label_smoothing", ",", "\n", "normalize", "=", "True", "\n", ")", "\n", "\n", "ce", "=", "tf", ".", "reshape", "(", "ce", ",", "tf", ".", "shape", "(", "labels", ")", ")", "\n", "tgt_mask", "=", "tf", ".", "to_float", "(", "\n", "tf", ".", "sequence_mask", "(", "\n", "features", "[", "\"target_length\"", "]", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "features", "[", "\"target\"", "]", ")", "[", "1", "]", "\n", ")", "\n", ")", "\n", "\n", "if", "mode", "==", "\"eval\"", ":", "\n", "        ", "return", "-", "tf", ".", "reduce_sum", "(", "ce", "*", "tgt_mask", ",", "axis", "=", "1", ")", "\n", "\n", "", "loss", "=", "tf", ".", "reduce_sum", "(", "ce", "*", "tgt_mask", ")", "/", "tf", ".", "reduce_sum", "(", "tgt_mask", ")", "\n", "\n", "return", "loss", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.__init__.get_model": [[14, 31], ["name.lower.lower", "LookupError"], "function", ["None"], []], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.Transformer.__init__": [[348, 350], ["thumt.NMTModel.__init__"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["    ", "def", "__init__", "(", "self", ",", "params", ",", "scope", "=", "\"transformer\"", ")", ":", "\n", "        ", "super", "(", "Transformer", ",", "self", ")", ".", "__init__", "(", "params", "=", "params", ",", "scope", "=", "scope", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.Transformer.get_training_func": [[351, 364], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "transformer.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_training_func", "(", "self", ",", "initializer", ",", "regularizer", "=", "None", ")", ":", "\n", "        ", "def", "training_fn", "(", "features", ",", "params", "=", "None", ",", "reuse", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ",", "initializer", "=", "initializer", ",", "\n", "regularizer", "=", "regularizer", ",", "reuse", "=", "reuse", ")", ":", "\n", "                ", "loss", "=", "model_graph", "(", "features", ",", "\"train\"", ",", "params", ")", "\n", "return", "loss", "\n", "\n", "", "", "return", "training_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.Transformer.get_evaluation_func": [[365, 416], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "range", "tensorflow.concat", "tensorflow.concat", "tensorflow.nn.moments", "tensorflow.nn.moments", "transformer.model_graph", "thumt.batch_to_moments", "thumt.batch_to_moments", "thumt.batch_to_moments", "thumt.batch_to_moments", "thumt.batch_to_moments", "thumt.batch_to_moments", "transformer.model_graph", "transformer.model_graph", "tensorflow.expand_dims", "word_scores.append", "tensorflow.expand_dims", "tensorflow.concat.append", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "thumt.repeat_batch", "tensorflow.split"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.batch_to_moments", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.batch_to_moments", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.batch_to_moments", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.batch_to_moments", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.batch_to_moments", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.batch_to_moments", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.common.repeat_batch"], ["", "def", "get_evaluation_func", "(", "self", ")", ":", "\n", "        ", "def", "evaluation_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "if", "params", ".", "model_uncertainty", "and", "not", "params", ".", "mu_parallel", ":", "\n", "                    ", "word_scores", "=", "[", "]", "\n", "sen_scores", "=", "[", "]", "\n", "for", "sample_i", "in", "range", "(", "params", ".", "mu_sample_k", ")", ":", "\n", "                        ", "word_score", ",", "len_score", ",", "sen_score", "=", "model_graph", "(", "features", ",", "\"eval\"", ",", "params", ")", "\n", "\n", "word_score", "=", "tf", ".", "expand_dims", "(", "word_score", ",", "axis", "=", "-", "1", ")", "\n", "word_scores", ".", "append", "(", "word_score", ")", "\n", "\n", "sen_score", "=", "tf", ".", "expand_dims", "(", "sen_score", ",", "axis", "=", "-", "1", ")", "\n", "sen_scores", ".", "append", "(", "sen_score", ")", "\n", "\n", "", "sampled_scores", "=", "tf", ".", "concat", "(", "word_scores", ",", "axis", "=", "-", "1", ")", "\n", "sen_scores", "=", "tf", ".", "concat", "(", "sen_scores", ",", "axis", "=", "-", "1", ")", "\n", "\n", "mean_scores", ",", "var_scores", "=", "tf", ".", "nn", ".", "moments", "(", "sampled_scores", ",", "axes", "=", "[", "-", "1", "]", ")", "\n", "mean_sen_scores", ",", "var_sen_scores", "=", "tf", ".", "nn", ".", "moments", "(", "sen_scores", ",", "axes", "=", "[", "-", "1", "]", ")", "\n", "", "if", "params", ".", "model_uncertainty", "and", "params", ".", "mu_parallel", ":", "\n", "                    ", "parallel_features", "=", "{", "\n", "\"source\"", ":", "utils", ".", "repeat_batch", "(", "features", "[", "\"source\"", "]", ",", "params", ".", "mu_sample_k", ")", ",", "\n", "\"target\"", ":", "utils", ".", "repeat_batch", "(", "features", "[", "\"target\"", "]", ",", "params", ".", "mu_sample_k", ")", ",", "\n", "\"source_length\"", ":", "utils", ".", "repeat_batch", "(", "features", "[", "\"source_length\"", "]", ",", "params", ".", "mu_sample_k", ")", ",", "\n", "\"target_length\"", ":", "utils", ".", "repeat_batch", "(", "features", "[", "\"target_length\"", "]", ",", "params", ".", "mu_sample_k", ")", "\n", "}", "\n", "\n", "word_scores", ",", "len_scores", ",", "sen_scores", "=", "model_graph", "(", "parallel_features", ",", "\"eval\"", ",", "params", ")", "\n", "mean_scores", ",", "var_scores", "=", "utils", ".", "batch_to_moments", "(", "word_scores", ",", "params", ".", "mu_sample_k", ")", "\n", "mean_sen_scores", ",", "var_sen_scores", "=", "utils", ".", "batch_to_moments", "(", "sen_scores", ",", "params", ".", "mu_sample_k", ")", "\n", "len_score", "=", "tf", ".", "split", "(", "len_scores", ",", "params", ".", "mu_sample_k", ",", "axis", "=", "0", ")", "[", "0", "]", "\n", "", "else", ":", "\n", "                    ", "score", "=", "model_graph", "(", "features", ",", "\"eval\"", ",", "params", ")", "\n", "\n", "", "if", "params", ".", "model_uncertainty", ":", "\n", "                    ", "return", "{", "\"mean\"", ":", "mean_scores", ",", "\n", "\"var\"", ":", "var_scores", ",", "\n", "\"rv\"", ":", "var_scores", "/", "mean_scores", ",", "\n", "\"len\"", ":", "len_score", ",", "\n", "\"sen_mean\"", ":", "mean_sen_scores", ",", "\n", "\"sen_var\"", ":", "var_sen_scores", ",", "\n", "\"sen_rv\"", ":", "var_sen_scores", "/", "mean_sen_scores", "}", "\n", "", "else", ":", "\n", "                    ", "return", "score", "\n", "", "", "", "return", "evaluation_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.Transformer.get_inference_func": [[417, 452], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "transformer.encoding_graph", "copy.copy", "copy.copy", "tensorflow.variable_scope", "transformer.decoding_graph", "tensorflow.shape", "tensorflow.zeros", "tensorflow.zeros", "range"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.encoding_graph", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.decoding_graph"], ["", "def", "get_inference_func", "(", "self", ")", ":", "\n", "        ", "def", "encoding_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "encoder_output", "=", "encoding_graph", "(", "features", ",", "\"infer\"", ",", "params", ")", "\n", "batch", "=", "tf", ".", "shape", "(", "encoder_output", ")", "[", "0", "]", "\n", "\n", "state", "=", "{", "\n", "\"encoder\"", ":", "encoder_output", ",", "\n", "\"decoder\"", ":", "{", "\n", "\"layer_%d\"", "%", "i", ":", "{", "\n", "\"key\"", ":", "tf", ".", "zeros", "(", "[", "batch", ",", "0", ",", "params", ".", "hidden_size", "]", ")", ",", "\n", "\"value\"", ":", "tf", ".", "zeros", "(", "[", "batch", ",", "0", ",", "params", ".", "hidden_size", "]", ")", "\n", "}", "\n", "for", "i", "in", "range", "(", "params", ".", "num_decoder_layers", ")", "\n", "}", "\n", "}", "\n", "", "return", "state", "\n", "\n", "", "def", "decoding_fn", "(", "features", ",", "state", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "log_prob", ",", "new_state", "=", "decoding_graph", "(", "features", ",", "state", ",", "\"infer\"", ",", "params", ")", "\n", "\n", "", "return", "log_prob", ",", "new_state", "\n", "\n", "", "return", "encoding_fn", ",", "decoding_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.Transformer.get_name": [[453, 456], ["None"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_name", "(", ")", ":", "\n", "        ", "return", "\"transformer\"", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.Transformer.get_parameters": [[457, 502], ["tensorflow.contrib.training.HParams"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_parameters", "(", ")", ":", "\n", "        ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", "\n", "pad", "=", "\"<pad>\"", ",", "\n", "bos", "=", "\"<eos>\"", ",", "\n", "eos", "=", "\"<eos>\"", ",", "\n", "unk", "=", "\"<unk>\"", ",", "\n", "append_eos", "=", "False", ",", "\n", "hidden_size", "=", "512", ",", "\n", "filter_size", "=", "2048", ",", "\n", "num_heads", "=", "8", ",", "\n", "num_encoder_layers", "=", "6", ",", "\n", "num_decoder_layers", "=", "6", ",", "\n", "attention_dropout", "=", "0.0", ",", "\n", "residual_dropout", "=", "0.1", ",", "\n", "relu_dropout", "=", "0.0", ",", "\n", "label_smoothing", "=", "0.1", ",", "\n", "attention_key_channels", "=", "0", ",", "\n", "attention_value_channels", "=", "0", ",", "\n", "layer_preprocess", "=", "\"none\"", ",", "\n", "layer_postprocess", "=", "\"layer_norm\"", ",", "\n", "multiply_embedding_mode", "=", "\"sqrt_depth\"", ",", "\n", "shared_embedding_and_softmax_weights", "=", "False", ",", "\n", "shared_source_target_embedding", "=", "False", ",", "\n", "# Override default parameters", "\n", "learning_rate_decay", "=", "\"linear_warmup_rsqrt_decay\"", ",", "\n", "initializer", "=", "\"uniform_unit_scaling\"", ",", "\n", "initializer_gain", "=", "1.0", ",", "\n", "learning_rate", "=", "1.0", ",", "\n", "batch_size", "=", "4096", ",", "\n", "constant_batch_size", "=", "False", ",", "\n", "adam_beta1", "=", "0.9", ",", "\n", "adam_beta2", "=", "0.98", ",", "\n", "adam_epsilon", "=", "1e-9", ",", "\n", "clip_grad_norm", "=", "0.0", ",", "\n", "confidence_alpha", "=", "2.0", ",", "\n", "sencf_convert", "=", "True", ",", "\n", "cf_type", "=", "1", ",", "\n", "encoder_cf_layers", "=", "[", "0", ",", "1", ",", "2", "]", ",", "\n", "decoder_cf_layers", "=", "[", "-", "1", "]", ",", "\n", "chead", "=", "8", ",", "\n", "sencf_batch_max_length", "=", "True", "\n", ")", "\n", "\n", "return", "params", "\n", "", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process": [[16, 23], ["thumt.nn.layer_norm", "ValueError"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.layer_norm"], ["def", "_layer_process", "(", "x", ",", "mode", ")", ":", "\n", "    ", "if", "not", "mode", "or", "mode", "==", "\"none\"", ":", "\n", "        ", "return", "x", "\n", "", "elif", "mode", "==", "\"layer_norm\"", ":", "\n", "        ", "return", "layers", ".", "nn", ".", "layer_norm", "(", "x", ")", "\n", "", "else", ":", "\n", "        ", "raise", "ValueError", "(", "\"Unknown mode %s\"", "%", "mode", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._residual_fn": [[25, 29], ["tensorflow.nn.dropout"], "function", ["None"], ["", "", "def", "_residual_fn", "(", "x", ",", "y", ",", "keep_prob", "=", "None", ")", ":", "\n", "    ", "if", "keep_prob", "and", "keep_prob", "<", "1.0", ":", "\n", "        ", "y", "=", "tf", ".", "nn", ".", "dropout", "(", "y", ",", "keep_prob", ")", "\n", "", "return", "x", "+", "y", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._ffn_layer": [[31, 46], ["tensorflow.variable_scope", "tensorflow.variable_scope", "thumt.nn.linear", "tensorflow.nn.relu", "tensorflow.nn.dropout", "tensorflow.variable_scope", "thumt.nn.linear"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear"], ["", "def", "_ffn_layer", "(", "inputs", ",", "hidden_size", ",", "output_size", ",", "keep_prob", "=", "None", ",", "\n", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"ffn_layer\"", ",", "values", "=", "[", "inputs", "]", ",", "\n", "dtype", "=", "dtype", ")", ":", "\n", "        ", "with", "tf", ".", "variable_scope", "(", "\"input_layer\"", ")", ":", "\n", "            ", "hidden", "=", "layers", ".", "nn", ".", "linear", "(", "inputs", ",", "hidden_size", ",", "True", ",", "True", ")", "\n", "hidden", "=", "tf", ".", "nn", ".", "relu", "(", "hidden", ")", "\n", "\n", "", "if", "keep_prob", "and", "keep_prob", "<", "1.0", ":", "\n", "            ", "hidden", "=", "tf", ".", "nn", ".", "dropout", "(", "hidden", ",", "keep_prob", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"output_layer\"", ")", ":", "\n", "            ", "output", "=", "layers", ".", "nn", ".", "linear", "(", "hidden", ",", "output_size", ",", "True", ",", "True", ")", "\n", "\n", "", "return", "output", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.transformer_encoder": [[48, 88], ["tensorflow.variable_scope", "range", "transformer._layer_process", "tensorflow.variable_scope", "tensorflow.variable_scope", "thumt.attention.multihead_attention", "transformer._residual_fn", "transformer._layer_process", "tensorflow.variable_scope", "transformer._ffn_layer", "transformer._residual_fn", "transformer._layer_process", "transformer._layer_process", "transformer._layer_process"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.multihead_attention", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._ffn_layer", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process"], ["", "", "def", "transformer_encoder", "(", "inputs", ",", "bias", ",", "params", ",", "confidence", "=", "None", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"encoder\"", ",", "dtype", "=", "dtype", ",", "\n", "values", "=", "[", "inputs", ",", "bias", "]", ")", ":", "\n", "        ", "x", "=", "inputs", "\n", "for", "layer", "in", "range", "(", "params", ".", "num_encoder_layers", ")", ":", "\n", "            ", "with", "tf", ".", "variable_scope", "(", "\"layer_%d\"", "%", "layer", ")", ":", "\n", "                ", "if", "layer", "in", "params", ".", "encoder_cf_layers", ":", "\n", "                    ", "temp_cf", "=", "confidence", "\n", "", "else", ":", "\n", "                    ", "temp_cf", "=", "None", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"self_attention\"", ")", ":", "\n", "                    ", "y", "=", "layers", ".", "attention", ".", "multihead_attention", "(", "\n", "_layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "None", ",", "\n", "bias", ",", "\n", "params", ".", "num_heads", ",", "\n", "params", ".", "attention_key_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "attention_value_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "1.0", "-", "params", ".", "attention_dropout", ",", "\n", "confidence", "=", "temp_cf", ",", "\n", "chead", "=", "params", ".", "chead", "\n", ")", "\n", "y", "=", "y", "[", "\"outputs\"", "]", "\n", "x", "=", "_residual_fn", "(", "x", ",", "y", ",", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "_layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"feed_forward\"", ")", ":", "\n", "                    ", "y", "=", "_ffn_layer", "(", "\n", "_layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "params", ".", "filter_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "1.0", "-", "params", ".", "relu_dropout", ",", "\n", ")", "\n", "x", "=", "_residual_fn", "(", "x", ",", "y", ",", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "_layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ")", "\n", "\n", "", "", "", "outputs", "=", "_layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", "\n", "\n", "return", "outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.transformer_decoder": [[90, 159], ["tensorflow.variable_scope", "range", "transformer._layer_process", "tensorflow.variable_scope", "tensorflow.variable_scope", "thumt.attention.multihead_attention", "transformer._residual_fn", "transformer._layer_process", "tensorflow.variable_scope", "thumt.attention.multihead_attention", "transformer._residual_fn", "transformer._layer_process", "tensorflow.variable_scope", "transformer._ffn_layer", "transformer._residual_fn", "transformer._layer_process", "transformer._layer_process", "transformer._layer_process", "transformer._layer_process"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.multihead_attention", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.multihead_attention", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._ffn_layer", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer._layer_process"], ["", "", "def", "transformer_decoder", "(", "inputs", ",", "memory", ",", "bias", ",", "mem_bias", ",", "params", ",", "\n", "confidence", "=", "None", ",", "state", "=", "None", ",", "\n", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"decoder\"", ",", "dtype", "=", "dtype", ",", "\n", "values", "=", "[", "inputs", ",", "memory", ",", "bias", ",", "mem_bias", "]", ")", ":", "\n", "        ", "x", "=", "inputs", "\n", "next_state", "=", "{", "}", "\n", "for", "layer", "in", "range", "(", "params", ".", "num_decoder_layers", ")", ":", "\n", "            ", "layer_name", "=", "\"layer_%d\"", "%", "layer", "\n", "with", "tf", ".", "variable_scope", "(", "layer_name", ")", ":", "\n", "                ", "layer_state", "=", "state", "[", "layer_name", "]", "if", "state", "is", "not", "None", "else", "None", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "\"self_attention\"", ")", ":", "\n", "                    ", "y", "=", "layers", ".", "attention", ".", "multihead_attention", "(", "\n", "_layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "None", ",", "\n", "bias", ",", "\n", "params", ".", "num_heads", ",", "\n", "params", ".", "attention_key_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "attention_value_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "1.0", "-", "params", ".", "attention_dropout", ",", "\n", "state", "=", "layer_state", "\n", ")", "\n", "\n", "if", "layer_state", "is", "not", "None", ":", "\n", "                        ", "next_state", "[", "layer_name", "]", "=", "y", "[", "\"state\"", "]", "\n", "\n", "", "y", "=", "y", "[", "\"outputs\"", "]", "\n", "x", "=", "_residual_fn", "(", "x", ",", "y", ",", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "_layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ")", "\n", "\n", "", "if", "layer", "in", "params", ".", "decoder_cf_layers", ":", "\n", "                    ", "temp_cf", "=", "confidence", "\n", "", "else", ":", "\n", "                    ", "temp_cf", "=", "None", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"encdec_attention\"", ")", ":", "\n", "                    ", "y", "=", "layers", ".", "attention", ".", "multihead_attention", "(", "\n", "_layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "memory", ",", "\n", "mem_bias", ",", "\n", "params", ".", "num_heads", ",", "\n", "params", ".", "attention_key_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "attention_value_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "1.0", "-", "params", ".", "attention_dropout", ",", "\n", "confidence", "=", "temp_cf", ",", "\n", "chead", "=", "params", ".", "chead", "\n", ")", "\n", "y", "=", "y", "[", "\"outputs\"", "]", "\n", "x", "=", "_residual_fn", "(", "x", ",", "y", ",", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "_layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"feed_forward\"", ")", ":", "\n", "                    ", "y", "=", "_ffn_layer", "(", "\n", "_layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "params", ".", "filter_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "1.0", "-", "params", ".", "relu_dropout", ",", "\n", ")", "\n", "x", "=", "_residual_fn", "(", "x", ",", "y", ",", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "_layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ")", "\n", "\n", "", "", "", "outputs", "=", "_layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", "\n", "\n", "if", "state", "is", "not", "None", ":", "\n", "            ", "return", "outputs", ",", "next_state", "\n", "\n", "", "return", "outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.encoding_graph": [[161, 218], ["tensorflow.sequence_mask", "len", "tensorflow.random_normal_initializer", "tensorflow.get_variable", "tensorflow.gather", "tensorflow.nn.bias_add", "thumt.attention.add_timing_signal", "thumt.attention.attention_bias", "transformer.transformer_encoder", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.expand_dims", "tensorflow.nn.dropout", "thumt.nn.generate_confidence", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.add_timing_signal", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_bias", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.transformer_encoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.generate_confidence"], ["", "", "def", "encoding_graph", "(", "features", ",", "mode", ",", "params", ")", ":", "\n", "    ", "if", "mode", "==", "\"infer\"", ":", "\n", "        ", "params", ".", "residual_dropout", "=", "0.0", "\n", "params", ".", "attention_dropout", "=", "0.0", "\n", "params", ".", "relu_dropout", "=", "0.0", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "", "elif", "mode", "==", "\"eval\"", ":", "\n", "        ", "params", ".", "label_smoothing", "=", "0.0", "\n", "if", "not", "params", ".", "model_uncertainty", ":", "\n", "            ", "params", ".", "residual_dropout", "=", "0.0", "\n", "params", ".", "attention_dropout", "=", "0.0", "\n", "params", ".", "relu_dropout", "=", "0.0", "\n", "\n", "", "", "hidden_size", "=", "params", ".", "hidden_size", "\n", "src_seq", "=", "features", "[", "\"source\"", "]", "\n", "src_len", "=", "features", "[", "\"source_length\"", "]", "\n", "src_mask", "=", "tf", ".", "sequence_mask", "(", "src_len", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "features", "[", "\"source\"", "]", ")", "[", "1", "]", ",", "\n", "dtype", "=", "tf", ".", "float32", ")", "\n", "\n", "svocab", "=", "params", ".", "vocabulary", "[", "\"source\"", "]", "\n", "src_vocab_size", "=", "len", "(", "svocab", ")", "\n", "initializer", "=", "tf", ".", "random_normal_initializer", "(", "0.0", ",", "params", ".", "hidden_size", "**", "-", "0.5", ")", "\n", "\n", "if", "params", ".", "shared_source_target_embedding", ":", "\n", "        ", "src_embedding", "=", "tf", ".", "get_variable", "(", "\"weights\"", ",", "\n", "[", "src_vocab_size", ",", "hidden_size", "]", ",", "\n", "initializer", "=", "initializer", ")", "\n", "", "else", ":", "\n", "        ", "src_embedding", "=", "tf", ".", "get_variable", "(", "\"source_embedding\"", ",", "\n", "[", "src_vocab_size", ",", "hidden_size", "]", ",", "\n", "initializer", "=", "initializer", ")", "\n", "\n", "", "bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "[", "hidden_size", "]", ")", "\n", "\n", "inputs", "=", "tf", ".", "gather", "(", "src_embedding", ",", "src_seq", ")", "\n", "\n", "if", "params", ".", "multiply_embedding_mode", "==", "\"sqrt_depth\"", ":", "\n", "        ", "inputs", "=", "inputs", "*", "(", "hidden_size", "**", "0.5", ")", "\n", "\n", "", "inputs", "=", "inputs", "*", "tf", ".", "expand_dims", "(", "src_mask", ",", "-", "1", ")", "\n", "\n", "encoder_input", "=", "tf", ".", "nn", ".", "bias_add", "(", "inputs", ",", "bias", ")", "\n", "encoder_input", "=", "layers", ".", "attention", ".", "add_timing_signal", "(", "encoder_input", ")", "\n", "enc_attn_bias", "=", "layers", ".", "attention", ".", "attention_bias", "(", "src_mask", ",", "\"masking\"", ")", "\n", "\n", "if", "params", ".", "residual_dropout", ":", "\n", "        ", "keep_prob", "=", "1.0", "-", "params", ".", "residual_dropout", "\n", "encoder_input", "=", "tf", ".", "nn", ".", "dropout", "(", "encoder_input", ",", "keep_prob", ")", "\n", "\n", "", "if", "\"source_word\"", "in", "params", ".", "side", "and", "mode", "==", "\"train\"", ":", "\n", "        ", "confidence", "=", "layers", ".", "nn", ".", "generate_confidence", "(", "features", ",", "'word'", ",", "params", ")", "\n", "", "else", ":", "\n", "        ", "confidence", "=", "None", "\n", "", "encoder_output", "=", "transformer_encoder", "(", "encoder_input", ",", "enc_attn_bias", ",", "params", ",", "confidence", ")", "\n", "\n", "return", "encoder_output", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.decoding_graph": [[220, 333], ["tensorflow.sequence_mask", "tensorflow.sequence_mask", "len", "tensorflow.random_normal_initializer", "tensorflow.gather", "thumt.attention.attention_bias", "thumt.attention.attention_bias", "thumt.attention.add_timing_signal", "tensorflow.reshape", "tensorflow.matmul", "thumt.nn.smoothed_softmax_cross_entropy_with_logits", "tensorflow.reshape", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.expand_dims", "tensorflow.pad", "tensorflow.nn.dropout", "thumt.nn.generate_confidence", "transformer.transformer_decoder", "transformer.transformer_decoder", "tensorflow.matmul", "tensorflow.nn.log_softmax", "tensorflow.shape", "thumt.nn.generate_confidence", "tensorflow.reduce_sum", "tensorflow.reduce_sum", "tensorflow.variable_scope", "tensorflow.get_variable", "tensorflow.shape", "tensorflow.pow", "tensorflow.exp", "tensorflow.shape", "tensorflow.shape", "tensorflow.get_variable_scope", "tensorflow.reduce_sum", "tensorflow.exp", "tensorflow.reduce_sum", "tensorflow.to_float", "tensorflow.log"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_bias", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_bias", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.add_timing_signal", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.smoothed_softmax_cross_entropy_with_logits", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.generate_confidence", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.transformer_decoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.transformer_decoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.generate_confidence"], ["", "def", "decoding_graph", "(", "features", ",", "state", ",", "mode", ",", "params", ")", ":", "\n", "    ", "if", "mode", "==", "\"infer\"", ":", "\n", "        ", "params", ".", "residual_dropout", "=", "0.0", "\n", "params", ".", "attention_dropout", "=", "0.0", "\n", "params", ".", "relu_dropout", "=", "0.0", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "", "elif", "mode", "==", "\"eval\"", ":", "\n", "        ", "params", ".", "label_smoothing", "=", "0.0", "\n", "if", "not", "params", ".", "model_uncertainty", ":", "\n", "            ", "params", ".", "residual_dropout", "=", "0.0", "\n", "params", ".", "attention_dropout", "=", "0.0", "\n", "params", ".", "relu_dropout", "=", "0.0", "\n", "\n", "", "", "tgt_seq", "=", "features", "[", "\"target\"", "]", "\n", "src_len", "=", "features", "[", "\"source_length\"", "]", "\n", "tgt_len", "=", "features", "[", "\"target_length\"", "]", "\n", "src_mask", "=", "tf", ".", "sequence_mask", "(", "src_len", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "features", "[", "\"source\"", "]", ")", "[", "1", "]", ",", "\n", "dtype", "=", "tf", ".", "float32", ")", "\n", "tgt_mask", "=", "tf", ".", "sequence_mask", "(", "tgt_len", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "features", "[", "\"target\"", "]", ")", "[", "1", "]", ",", "\n", "dtype", "=", "tf", ".", "float32", ")", "\n", "\n", "hidden_size", "=", "params", ".", "hidden_size", "\n", "tvocab", "=", "params", ".", "vocabulary", "[", "\"target\"", "]", "\n", "tgt_vocab_size", "=", "len", "(", "tvocab", ")", "\n", "initializer", "=", "tf", ".", "random_normal_initializer", "(", "0.0", ",", "params", ".", "hidden_size", "**", "-", "0.5", ")", "\n", "\n", "if", "params", ".", "shared_source_target_embedding", ":", "\n", "        ", "with", "tf", ".", "variable_scope", "(", "tf", ".", "get_variable_scope", "(", ")", ",", "reuse", "=", "True", ")", ":", "\n", "            ", "tgt_embedding", "=", "tf", ".", "get_variable", "(", "\"weights\"", ",", "\n", "[", "tgt_vocab_size", ",", "hidden_size", "]", ",", "\n", "initializer", "=", "initializer", ")", "\n", "", "", "else", ":", "\n", "        ", "tgt_embedding", "=", "tf", ".", "get_variable", "(", "\"target_embedding\"", ",", "\n", "[", "tgt_vocab_size", ",", "hidden_size", "]", ",", "\n", "initializer", "=", "initializer", ")", "\n", "\n", "", "if", "params", ".", "shared_embedding_and_softmax_weights", ":", "\n", "        ", "weights", "=", "tgt_embedding", "\n", "", "else", ":", "\n", "        ", "weights", "=", "tf", ".", "get_variable", "(", "\"softmax\"", ",", "[", "tgt_vocab_size", ",", "hidden_size", "]", ",", "\n", "initializer", "=", "initializer", ")", "\n", "\n", "", "targets", "=", "tf", ".", "gather", "(", "tgt_embedding", ",", "tgt_seq", ")", "\n", "\n", "if", "params", ".", "multiply_embedding_mode", "==", "\"sqrt_depth\"", ":", "\n", "        ", "targets", "=", "targets", "*", "(", "hidden_size", "**", "0.5", ")", "\n", "\n", "", "targets", "=", "targets", "*", "tf", ".", "expand_dims", "(", "tgt_mask", ",", "-", "1", ")", "\n", "\n", "enc_attn_bias", "=", "layers", ".", "attention", ".", "attention_bias", "(", "src_mask", ",", "\"masking\"", ")", "\n", "dec_attn_bias", "=", "layers", ".", "attention", ".", "attention_bias", "(", "tf", ".", "shape", "(", "targets", ")", "[", "1", "]", ",", "\n", "\"causal\"", ")", "\n", "# Shift left", "\n", "decoder_input", "=", "tf", ".", "pad", "(", "targets", ",", "[", "[", "0", ",", "0", "]", ",", "[", "1", ",", "0", "]", ",", "[", "0", ",", "0", "]", "]", ")", "[", ":", ",", ":", "-", "1", ",", ":", "]", "\n", "decoder_input", "=", "layers", ".", "attention", ".", "add_timing_signal", "(", "decoder_input", ")", "\n", "\n", "if", "params", ".", "residual_dropout", ":", "\n", "        ", "keep_prob", "=", "1.0", "-", "params", ".", "residual_dropout", "\n", "decoder_input", "=", "tf", ".", "nn", ".", "dropout", "(", "decoder_input", ",", "keep_prob", ")", "\n", "\n", "", "encoder_output", "=", "state", "[", "\"encoder\"", "]", "\n", "\n", "if", "\"source_word\"", "in", "params", ".", "side", "and", "mode", "==", "\"train\"", ":", "\n", "        ", "confidence", "=", "layers", ".", "nn", ".", "generate_confidence", "(", "features", ",", "'word'", ",", "params", ")", "\n", "", "else", ":", "\n", "        ", "confidence", "=", "None", "\n", "", "if", "mode", "!=", "\"infer\"", ":", "\n", "        ", "decoder_output", "=", "transformer_decoder", "(", "decoder_input", ",", "encoder_output", ",", "\n", "dec_attn_bias", ",", "enc_attn_bias", ",", "\n", "params", ",", "confidence", ")", "\n", "", "else", ":", "\n", "        ", "decoder_input", "=", "decoder_input", "[", ":", ",", "-", "1", ":", ",", ":", "]", "\n", "dec_attn_bias", "=", "dec_attn_bias", "[", ":", ",", ":", ",", "-", "1", ":", ",", ":", "]", "\n", "decoder_outputs", "=", "transformer_decoder", "(", "decoder_input", ",", "encoder_output", ",", "\n", "dec_attn_bias", ",", "enc_attn_bias", ",", "\n", "params", ",", "confidence", ",", "state", "=", "state", "[", "\"decoder\"", "]", ")", "\n", "\n", "decoder_output", ",", "decoder_state", "=", "decoder_outputs", "\n", "decoder_output", "=", "decoder_output", "[", ":", ",", "-", "1", ",", ":", "]", "\n", "logits", "=", "tf", ".", "matmul", "(", "decoder_output", ",", "weights", ",", "False", ",", "True", ")", "\n", "log_prob", "=", "tf", ".", "nn", ".", "log_softmax", "(", "logits", ")", "\n", "\n", "return", "log_prob", ",", "{", "\"encoder\"", ":", "encoder_output", ",", "\"decoder\"", ":", "decoder_state", "}", "\n", "\n", "", "decoder_output", "=", "tf", ".", "reshape", "(", "decoder_output", ",", "[", "-", "1", ",", "hidden_size", "]", ")", "\n", "logits", "=", "tf", ".", "matmul", "(", "decoder_output", ",", "weights", ",", "False", ",", "True", ")", "\n", "labels", "=", "features", "[", "\"target\"", "]", "\n", "# label smoothing", "\n", "ce", "=", "layers", ".", "nn", ".", "smoothed_softmax_cross_entropy_with_logits", "(", "\n", "logits", "=", "logits", ",", "\n", "labels", "=", "labels", ",", "\n", "smoothing", "=", "params", ".", "label_smoothing", ",", "\n", "normalize", "=", "True", "\n", ")", "\n", "ce", "=", "tf", ".", "reshape", "(", "ce", ",", "tf", ".", "shape", "(", "tgt_seq", ")", ")", "\n", "if", "mode", "==", "\"eval\"", ":", "\n", "        ", "if", "params", ".", "model_uncertainty", ":", "\n", "            ", "lp", "=", "tf", ".", "pow", "(", "(", "5.0", "+", "tf", ".", "to_float", "(", "tgt_len", ")", ")", "/", "6.0", ",", "params", ".", "decode_alpha", ")", "\n", "word_score", "=", "tf", ".", "exp", "(", "-", "ce", ")", "*", "tgt_mask", "+", "(", "1", "-", "tgt_mask", ")", "\n", "sen_score", "=", "tf", ".", "exp", "(", "tf", ".", "reduce_sum", "(", "tf", ".", "log", "(", "word_score", ")", ",", "axis", "=", "-", "1", ")", "/", "lp", ")", "\n", "return", "word_score", ",", "tgt_len", ",", "sen_score", "\n", "", "else", ":", "\n", "            ", "return", "-", "tf", ".", "reduce_sum", "(", "ce", "*", "tgt_mask", ",", "axis", "=", "1", ")", "\n", "\n", "", "", "if", "\"sentence\"", "in", "params", ".", "side", ":", "\n", "        ", "sen_confidence", "=", "layers", ".", "nn", ".", "generate_confidence", "(", "features", ",", "'sentence'", ",", "params", ",", "src_mask", "=", "src_mask", ")", "\n", "ce", "=", "ce", "*", "sen_confidence", "\n", "\n", "", "loss", "=", "tf", ".", "reduce_sum", "(", "ce", "*", "tgt_mask", ")", "/", "tf", ".", "reduce_sum", "(", "tgt_mask", ")", "\n", "\n", "return", "loss", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.model_graph": [[335, 344], ["tensorflow.variable_scope", "transformer.encoding_graph", "transformer.decoding_graph", "tensorflow.get_variable_scope"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.encoding_graph", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer.decoding_graph"], ["", "def", "model_graph", "(", "features", ",", "mode", ",", "params", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "tf", ".", "get_variable_scope", "(", ")", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "        ", "encoder_output", "=", "encoding_graph", "(", "features", ",", "mode", ",", "params", ")", "\n", "state", "=", "{", "\n", "\"encoder\"", ":", "encoder_output", "\n", "}", "\n", "output", "=", "decoding_graph", "(", "features", ",", "state", ",", "mode", ",", "params", ")", "\n", "\n", "", "return", "output", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.RNNsearch_lrp.__init__": [[444, 446], ["thumt.NMTModel.__init__"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["    ", "def", "__init__", "(", "self", ",", "params", ",", "scope", "=", "\"rnnsearch\"", ")", ":", "\n", "        ", "super", "(", "RNNsearch_lrp", ",", "self", ")", ".", "__init__", "(", "params", "=", "params", ",", "scope", "=", "scope", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.RNNsearch_lrp.get_training_func": [[447, 457], ["tensorflow.variable_scope", "rnnsearch_lrp.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_training_func", "(", "self", ",", "initializer", ")", ":", "\n", "        ", "def", "training_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "self", ".", "parameters", "\n", "", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ",", "initializer", "=", "initializer", ",", "\n", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "                ", "loss", "=", "model_graph", "(", "features", ",", "features", "[", "\"target\"", "]", ",", "params", ")", "[", "0", "]", "\n", "return", "loss", "\n", "\n", "", "", "return", "training_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.RNNsearch_lrp.get_evaluation_func": [[458, 474], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "rnnsearch_lrp.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_evaluation_func", "(", "self", ")", ":", "\n", "        ", "def", "evaluation_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "", "params", ".", "dropout", "=", "0.0", "\n", "params", ".", "use_variational_dropout", "=", "False", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "logits", "=", "model_graph", "(", "features", ",", "None", ",", "params", ")", "\n", "\n", "", "return", "logits", "\n", "\n", "", "return", "evaluation_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.RNNsearch_lrp.get_relevance_func": [[475, 491], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "rnnsearch_lrp.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_relevance_func", "(", "self", ")", ":", "\n", "        ", "def", "relevance_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "params", ".", "dropout", "=", "0.0", "\n", "params", ".", "use_variational_dropout", "=", "False", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "loss", ",", "rlv", "=", "model_graph", "(", "features", ",", "features", "[", "\"target\"", "]", ",", "\n", "params", ")", "\n", "return", "features", "[", "\"source\"", "]", ",", "features", "[", "\"target\"", "]", ",", "rlv", ",", "loss", "\n", "", "", "return", "relevance_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.RNNsearch_lrp.get_inference_func": [[492, 508], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "rnnsearch_lrp.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_inference_func", "(", "self", ")", ":", "\n", "        ", "def", "inference_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "", "params", ".", "dropout", "=", "0.0", "\n", "params", ".", "use_variational_dropout", "=", "False", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "logits", "=", "model_graph", "(", "features", ",", "None", ",", "params", ")", "\n", "\n", "", "return", "logits", "\n", "\n", "", "return", "inference_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.RNNsearch_lrp.get_name": [[509, 512], ["None"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_name", "(", ")", ":", "\n", "        ", "return", "\"rnnsearch\"", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.RNNsearch_lrp.get_parameters": [[513, 540], ["tensorflow.contrib.training.HParams"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_parameters", "(", ")", ":", "\n", "        ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", "\n", "# vocabulary", "\n", "pad", "=", "\"<pad>\"", ",", "\n", "unk", "=", "\"<unk>\"", ",", "\n", "eos", "=", "\"<eos>\"", ",", "\n", "bos", "=", "\"<eos>\"", ",", "\n", "append_eos", "=", "False", ",", "\n", "# model", "\n", "rnn_cell", "=", "\"LegacyGRUCell\"", ",", "\n", "embedding_size", "=", "620", ",", "\n", "hidden_size", "=", "1000", ",", "\n", "maxnum", "=", "2", ",", "\n", "# regularization", "\n", "dropout", "=", "0.2", ",", "\n", "use_variational_dropout", "=", "False", ",", "\n", "label_smoothing", "=", "0.1", ",", "\n", "constant_batch_size", "=", "True", ",", "\n", "batch_size", "=", "128", ",", "\n", "max_length", "=", "60", ",", "\n", "clip_grad_norm", "=", "5.0", ",", "\n", "#lrp", "\n", "stab", "=", "0.05", "\n", ")", "\n", "\n", "return", "params", "\n", "", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.normalize": [[15, 24], ["tensorflow.abs", "tensorflow.reduce_sum", "tensorflow.abs", "tensorflow.reduce_sum", "tensorflow.expand_dims", "tensorflow.expand_dims"], "function", ["None"], ["def", "normalize", "(", "matrix", ",", "negative", "=", "False", ")", ":", "\n", "    ", "if", "negative", ":", "\n", "        ", "matrix_abs", "=", "tf", ".", "abs", "(", "matrix", ")", "\n", "total", "=", "tf", ".", "reduce_sum", "(", "matrix_abs", ",", "-", "1", ")", "\n", "return", "matrix", "/", "tf", ".", "expand_dims", "(", "total", ",", "-", "1", ")", "\n", "", "else", ":", "\n", "        ", "matrix", "=", "tf", ".", "abs", "(", "matrix", ")", "\n", "total", "=", "tf", ".", "reduce_sum", "(", "matrix", ",", "-", "1", ")", "\n", "return", "matrix", "/", "tf", ".", "expand_dims", "(", "total", ",", "-", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.stabilize": [[26, 33], ["tensorflow.sign", "tensorflow.equal", "tensorflow.cast", "tensorflow.zeros", "tensorflow.shape"], "function", ["None"], ["", "", "def", "stabilize", "(", "matrix", ",", "stab", ")", ":", "\n", "    ", "sign", "=", "tf", ".", "sign", "(", "matrix", ")", "\n", "zero_pos", "=", "tf", ".", "equal", "(", "sign", ",", "tf", ".", "zeros", "(", "tf", ".", "shape", "(", "sign", ")", ")", ")", "\n", "zero_pos", "=", "tf", ".", "cast", "(", "zero_pos", ",", "tf", ".", "float32", ")", "\n", "sign", "+=", "zero_pos", "\n", "result", "=", "matrix", "+", "stab", "*", "sign", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through": [[35, 38], ["tensorflow.where"], "function", ["None"], ["", "def", "_copy_through", "(", "time", ",", "length", ",", "output", ",", "new_output", ")", ":", "\n", "    ", "copy_cond", "=", "(", "time", ">=", "length", ")", "\n", "return", "tf", ".", "where", "(", "copy_cond", ",", "output", ",", "new_output", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._gru_encoder": [[40, 98], ["tensorflow.zeros", "tensorflow.TensorArray", "tensorflow.TensorArray", "tensorflow.TensorArray", "tensorflow.zeros", "input_ta.unstack.unstack", "tensorflow.constant", "tensorflow.while_loop", "output_final_ta.stack", "tf.transpose.set_shape", "tensorflow.transpose", "w_x_h_final_ta.stack", "tensorflow.shape", "tensorflow.shape", "cell.zero_state", "tensorflow.transpose", "input_ta.unstack.read", "cell", "tensorflow.pad", "rnnsearch_lrp._copy_through", "rnnsearch_lrp._copy_through", "rnnsearch_lrp._copy_through", "out_ta.write.write", "wxh_ta.write.write"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through"], ["", "def", "_gru_encoder", "(", "cell", ",", "inputs", ",", "sequence_length", ",", "initial_state", ",", "params", ",", "\n", "dtype", "=", "None", ")", ":", "\n", "# Assume that the underlying cell is GRUCell-like", "\n", "    ", "output_size", "=", "cell", ".", "output_size", "\n", "dtype", "=", "dtype", "or", "inputs", ".", "dtype", "\n", "\n", "batch", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "0", "]", "\n", "time_steps", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "1", "]", "\n", "\n", "zero_output", "=", "tf", ".", "zeros", "(", "[", "batch", ",", "output_size", "]", ",", "dtype", ")", "\n", "\n", "if", "initial_state", "is", "None", ":", "\n", "        ", "initial_state", "=", "cell", ".", "zero_state", "(", "batch", ",", "dtype", ")", "\n", "\n", "", "input_ta", "=", "tf", ".", "TensorArray", "(", "dtype", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"input_array\"", ")", "\n", "output_ta", "=", "tf", ".", "TensorArray", "(", "dtype", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"output_array\"", ")", "\n", "\n", "w_x_h_ta", "=", "tf", ".", "TensorArray", "(", "dtype", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"w_x_h_array\"", ")", "\n", "w_x_h_init", "=", "tf", ".", "zeros", "(", "[", "batch", ",", "time_steps", ",", "output_size", "]", ",", "dtype", "=", "tf", ".", "float32", ")", "\n", "\n", "input_ta", "=", "input_ta", ".", "unstack", "(", "tf", ".", "transpose", "(", "inputs", ",", "[", "1", ",", "0", ",", "2", "]", ")", ")", "\n", "\n", "def", "loop_func", "(", "t", ",", "out_ta", ",", "state", ",", "wxh_ta", ",", "w_x_h_last", ")", ":", "\n", "        ", "inp_t", "=", "input_ta", ".", "read", "(", "t", ")", "\n", "cell_output", ",", "new_state", ",", "w_xlast_newh", ",", "w_x_newh", "=", "cell", "(", "inp_t", ",", "state", ",", "\n", "w_x_h_last", ",", "\n", "params", ")", "\n", "w_x_newh", "=", "tf", ".", "pad", "(", "w_x_newh", ",", "[", "[", "0", ",", "0", "]", ",", "[", "t", ",", "time_steps", "-", "t", "-", "1", "]", ",", "[", "0", ",", "0", "]", "]", ")", "\n", "w_x_h_new", "=", "w_xlast_newh", "+", "w_x_newh", "\n", "cell_output", "=", "_copy_through", "(", "t", ",", "sequence_length", ",", "zero_output", ",", "\n", "cell_output", ")", "\n", "new_state", "=", "_copy_through", "(", "t", ",", "sequence_length", ",", "state", ",", "new_state", ")", "\n", "w_x_h_new", "=", "_copy_through", "(", "t", ",", "sequence_length", ",", "w_x_h_last", ",", "w_x_h_new", ")", "\n", "out_ta", "=", "out_ta", ".", "write", "(", "t", ",", "cell_output", ")", "\n", "wxh_ta", "=", "wxh_ta", ".", "write", "(", "t", ",", "w_x_h_new", ")", "\n", "return", "t", "+", "1", ",", "out_ta", ",", "new_state", ",", "wxh_ta", ",", "w_x_h_new", "\n", "\n", "", "time", "=", "tf", ".", "constant", "(", "0", ",", "dtype", "=", "tf", ".", "int32", ",", "name", "=", "\"time\"", ")", "\n", "loop_vars", "=", "(", "time", ",", "output_ta", ",", "initial_state", ",", "w_x_h_ta", ",", "w_x_h_init", ")", "\n", "\n", "outputs", "=", "tf", ".", "while_loop", "(", "lambda", "t", ",", "*", "_", ":", "t", "<", "time_steps", ",", "loop_func", ",", "\n", "loop_vars", ",", "parallel_iterations", "=", "32", ",", "\n", "swap_memory", "=", "True", ")", "\n", "\n", "output_final_ta", "=", "outputs", "[", "1", "]", "\n", "final_state", "=", "outputs", "[", "2", "]", "\n", "\n", "all_output", "=", "output_final_ta", ".", "stack", "(", ")", "\n", "all_output", ".", "set_shape", "(", "[", "None", ",", "None", ",", "output_size", "]", ")", "\n", "all_output", "=", "tf", ".", "transpose", "(", "all_output", ",", "[", "1", ",", "0", ",", "2", "]", ")", "\n", "\n", "w_x_h_final_ta", "=", "outputs", "[", "3", "]", "\n", "w_x_h_final", "=", "w_x_h_final_ta", ".", "stack", "(", ")", "\n", "\n", "return", "all_output", ",", "final_state", ",", "w_x_h_final", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._encoder": [[100, 134], ["tensorflow.variable_scope", "tensorflow.reverse_sequence", "tensorflow.variable_scope", "rnnsearch_lrp._gru_encoder", "tensorflow.variable_scope", "rnnsearch_lrp._gru_encoder", "tensorflow.reverse_sequence", "tensorflow.concat"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._gru_encoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._gru_encoder"], ["", "def", "_encoder", "(", "cell_fw", ",", "cell_bw", ",", "inputs", ",", "sequence_length", ",", "params", ",", "dtype", "=", "None", ",", "\n", "scope", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "scope", "or", "\"encoder\"", ",", "\n", "values", "=", "[", "inputs", ",", "sequence_length", "]", ")", ":", "\n", "        ", "inputs_fw", "=", "inputs", "\n", "inputs_bw", "=", "tf", ".", "reverse_sequence", "(", "inputs", ",", "sequence_length", ",", "\n", "batch_axis", "=", "0", ",", "seq_axis", "=", "1", ")", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "\"forward\"", ")", ":", "\n", "            ", "output_fw", ",", "state_fw", ",", "w_x_h_fw", "=", "_gru_encoder", "(", "cell_fw", ",", "inputs_fw", ",", "\n", "sequence_length", ",", "None", ",", "params", ",", "\n", "dtype", "=", "dtype", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"backward\"", ")", ":", "\n", "            ", "output_bw", ",", "state_bw", ",", "w_x_h_bw", "=", "_gru_encoder", "(", "cell_bw", ",", "inputs_bw", ",", "\n", "sequence_length", ",", "None", ",", "params", ",", "\n", "dtype", "=", "dtype", ")", "\n", "output_bw", "=", "tf", ".", "reverse_sequence", "(", "output_bw", ",", "sequence_length", ",", "\n", "batch_axis", "=", "0", ",", "seq_axis", "=", "1", ")", "\n", "\n", "", "results", "=", "{", "\n", "\"annotation\"", ":", "tf", ".", "concat", "(", "[", "output_fw", ",", "output_bw", "]", ",", "axis", "=", "2", ")", ",", "\n", "\"outputs\"", ":", "{", "\n", "\"forward\"", ":", "output_fw", ",", "\n", "\"backward\"", ":", "output_bw", "\n", "}", ",", "\n", "\"final_states\"", ":", "{", "\n", "\"forward\"", ":", "state_fw", ",", "\n", "\"backward\"", ":", "state_bw", "\n", "}", ",", "\n", "\"weight_ratios\"", ":", "[", "w_x_h_fw", ",", "w_x_h_bw", "]", "\n", "}", "\n", "\n", "return", "results", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._decoder": [[136, 267], ["tensorflow.zeros", "tensorflow.zeros", "tensorflow.shape", "tensorflow.shape", "tensorflow.variable_scope", "tensorflow.transpose", "tensorflow.sequence_mask", "thumt.attention.attention_bias", "tensorflow.squeeze", "thumt.attention.attention", "tensorflow.TensorArray", "tensorflow.TensorArray", "tensorflow.TensorArray", "tensorflow.TensorArray", "input_ta.unstack.unstack", "tensorflow.TensorArray", "w_x_bw_ta.unstack.unstack", "tensorflow.transpose", "tensorflow.reshape", "tensorflow.TensorArray", "tensorflow.TensorArray", "thumt.linear_v2n", "tensorflow.tanh", "tensorflow.constant", "tensorflow.while_loop", "output_final_ta.stack", "tf.transpose.set_shape", "tensorflow.transpose", "value_final_ta.stack", "tf.transpose.set_shape", "tensorflow.transpose", "w_x_h_final_ta.stack", "w_x_c_final_ta.stack", "tensorflow.shape", "tensorflow.shape", "tensorflow.concat", "wxh_ta.write.write", "input_ta.unstack.read", "thumt.attention.attention", "tensorflow.expand_dims", "tensorflow.squeeze", "rnnsearch_lrp.stabilize", "tensorflow.expand_dims", "tensorflow.reduce_sum", "tensorflow.reshape", "wxc_ta.write.write", "cell", "rnnsearch_lrp._copy_through", "rnnsearch_lrp._copy_through", "rnnsearch_lrp._copy_through", "rnnsearch_lrp._copy_through", "out_ta.write.write", "att_ta.write.write", "val_ta.write.write", "tensorflow.identity", "w_x_bw_ta.unstack.read", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.shape", "tensorflow.reshape", "tensorflow.shape", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_bias", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.stabilize", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._copy_through"], ["", "", "def", "_decoder", "(", "cell", ",", "inputs", ",", "memory", ",", "sequence_length", ",", "initial_state", ",", "w_x_enc", ",", "\n", "w_x_bw", ",", "params", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "# Assume that the underlying cell is GRUCell-like", "\n", "    ", "batch", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "0", "]", "\n", "time_steps", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "1", "]", "\n", "dtype", "=", "dtype", "or", "inputs", ".", "dtype", "\n", "output_size", "=", "cell", ".", "output_size", "\n", "zero_output", "=", "tf", ".", "zeros", "(", "[", "batch", ",", "output_size", "]", ",", "dtype", ")", "\n", "zero_value", "=", "tf", ".", "zeros", "(", "[", "batch", ",", "memory", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ",", "dtype", ")", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "scope", "or", "\"decoder\"", ",", "dtype", "=", "dtype", ")", ":", "\n", "        ", "inputs", "=", "tf", ".", "transpose", "(", "inputs", ",", "[", "1", ",", "0", ",", "2", "]", ")", "\n", "mem_mask", "=", "tf", ".", "sequence_mask", "(", "sequence_length", "[", "\"source\"", "]", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "memory", ")", "[", "1", "]", ",", "\n", "dtype", "=", "tf", ".", "float32", ")", "\n", "bias", "=", "layers", ".", "attention", ".", "attention_bias", "(", "mem_mask", ",", "\"masking\"", ")", "\n", "bias", "=", "tf", ".", "squeeze", "(", "bias", ",", "axis", "=", "[", "1", ",", "2", "]", ")", "\n", "cache", "=", "layers", ".", "attention", ".", "attention", "(", "None", ",", "memory", ",", "None", ",", "output_size", ")", "\n", "\n", "input_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"input_array\"", ")", "\n", "output_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"output_array\"", ")", "\n", "value_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"value_array\"", ")", "\n", "alpha_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"alpha_array\"", ")", "\n", "input_ta", "=", "input_ta", ".", "unstack", "(", "inputs", ")", "\n", "\n", "len_src", "=", "tf", ".", "shape", "(", "w_x_bw", ")", "[", "0", "]", "\n", "w_x_bw_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "len_src", ",", "\n", "tensor_array_name", "=", "\"w_x_bw_array\"", ")", "\n", "\n", "w_x_bw_ta", "=", "w_x_bw_ta", ".", "unstack", "(", "w_x_bw", ")", "\n", "w_x_c_shape", "=", "tf", ".", "shape", "(", "w_x_enc", ")", "[", "1", ":", "]", "\n", "w_x_enc", "=", "tf", ".", "transpose", "(", "w_x_enc", ",", "[", "1", ",", "0", ",", "2", ",", "3", "]", ")", "\n", "w_x_enc", "=", "tf", ".", "reshape", "(", "w_x_enc", ",", "\n", "tf", ".", "concat", "(", "[", "tf", ".", "shape", "(", "w_x_enc", ")", "[", ":", "2", "]", ",", "[", "-", "1", "]", "]", ",", "-", "1", ")", ")", "\n", "\n", "w_x_h_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"w_x_h_array\"", ")", "\n", "w_x_ctx_ta", "=", "tf", ".", "TensorArray", "(", "tf", ".", "float32", ",", "time_steps", ",", "\n", "tensor_array_name", "=", "\"w_x_ctx_array\"", ")", "\n", "\n", "initial_state_linear", "=", "lrp", ".", "linear_v2n", "(", "initial_state", ",", "output_size", ",", "True", ",", "\n", "[", "w_x_bw_ta", ".", "read", "(", "0", ")", "]", ",", "params", ",", "\n", "False", ",", "scope", "=", "\"s_transform\"", ",", "\n", "d2", "=", "True", ")", "\n", "initial_state", "=", "initial_state_linear", "[", "\"output\"", "]", "\n", "w_initial", "=", "initial_state_linear", "[", "\"weight_ratios\"", "]", "[", "0", "]", "\n", "initial_state", "=", "tf", ".", "tanh", "(", "initial_state", ")", "\n", "\n", "def", "loop_func", "(", "t", ",", "out_ta", ",", "att_ta", ",", "val_ta", ",", "state", ",", "cache_key", ",", "wxh_ta", ",", "\n", "wxc_ta", ",", "w_x_h_last", ")", ":", "\n", "# now state", "\n", "            ", "wxh_ta", "=", "wxh_ta", ".", "write", "(", "t", ",", "w_x_h_last", ")", "\n", "inp_t", "=", "input_ta", ".", "read", "(", "t", ")", "\n", "results", "=", "layers", ".", "attention", ".", "attention", "(", "state", ",", "memory", ",", "bias", ",", "\n", "output_size", ",", "\n", "cache", "=", "{", "\"key\"", ":", "cache_key", "}", ")", "\n", "alpha", "=", "results", "[", "\"weight\"", "]", "\n", "context", "=", "results", "[", "\"value\"", "]", "\n", "\n", "att", "=", "tf", ".", "expand_dims", "(", "alpha", ",", "1", ")", "\n", "\n", "wr_att", "=", "tf", ".", "expand_dims", "(", "att", ",", "-", "1", ")", "*", "tf", ".", "expand_dims", "(", "memory", ",", "1", ")", "\n", "wr_att", "=", "tf", ".", "squeeze", "(", "wr_att", ",", "1", ")", "\n", "result_stab", "=", "stabilize", "(", "context", ",", "params", ".", "stab", ")", "\n", "wr_att", "/=", "tf", ".", "expand_dims", "(", "result_stab", ",", "1", ")", "\n", "len_src", "=", "tf", ".", "shape", "(", "wr_att", ")", "[", "1", "]", "\n", "w_x_c", "=", "tf", ".", "reshape", "(", "w_x_enc", ",", "[", "1", ",", "len_src", ",", "len_src", ",", "-", "1", "]", ")", "*", "wr_att", "\n", "w_x_c", "=", "tf", ".", "reduce_sum", "(", "w_x_c", ",", "2", ")", "\n", "\n", "#w_x_c = tf.matmul(att, w_x_enc)", "\n", "w_x_c", "=", "tf", ".", "reshape", "(", "w_x_c", ",", "w_x_c_shape", ")", "\n", "wxc_ta", "=", "wxc_ta", ".", "write", "(", "t", ",", "w_x_c", ")", "\n", "\n", "# next state", "\n", "cell_input", "=", "[", "inp_t", ",", "context", "]", "\n", "cell_output", ",", "new_state", ",", "w_x_h_new", "=", "cell", "(", "cell_input", ",", "state", ",", "\n", "w_x_h_last", ",", "w_x_c", ",", "params", ")", "\n", "cell_output", "=", "_copy_through", "(", "t", ",", "sequence_length", "[", "\"target\"", "]", ",", "\n", "zero_output", ",", "cell_output", ")", "\n", "new_state", "=", "_copy_through", "(", "t", ",", "sequence_length", "[", "\"target\"", "]", ",", "state", ",", "\n", "new_state", ")", "\n", "new_value", "=", "_copy_through", "(", "t", ",", "sequence_length", "[", "\"target\"", "]", ",", "zero_value", ",", "\n", "context", ")", "\n", "w_x_h_new", "=", "_copy_through", "(", "t", ",", "sequence_length", "[", "\"target\"", "]", ",", "w_x_h_last", ",", "\n", "w_x_h_new", ")", "\n", "\n", "out_ta", "=", "out_ta", ".", "write", "(", "t", ",", "cell_output", ")", "\n", "att_ta", "=", "att_ta", ".", "write", "(", "t", ",", "alpha", ")", "\n", "val_ta", "=", "val_ta", ".", "write", "(", "t", ",", "new_value", ")", "\n", "cache_key", "=", "tf", ".", "identity", "(", "cache_key", ")", "\n", "\n", "return", "t", "+", "1", ",", "out_ta", ",", "att_ta", ",", "val_ta", ",", "new_state", ",", "cache_key", ",", "wxh_ta", ",", "wxc_ta", ",", "w_x_h_new", "\n", "\n", "", "time", "=", "tf", ".", "constant", "(", "0", ",", "dtype", "=", "tf", ".", "int32", ",", "name", "=", "\"time\"", ")", "\n", "loop_vars", "=", "(", "time", ",", "output_ta", ",", "alpha_ta", ",", "value_ta", ",", "initial_state", ",", "\n", "cache", "[", "\"key\"", "]", ",", "w_x_h_ta", ",", "w_x_ctx_ta", ",", "w_initial", ")", "\n", "\n", "outputs", "=", "tf", ".", "while_loop", "(", "lambda", "t", ",", "*", "_", ":", "t", "<", "time_steps", ",", "\n", "loop_func", ",", "loop_vars", ",", "\n", "parallel_iterations", "=", "32", ",", "\n", "swap_memory", "=", "True", ")", "\n", "\n", "output_final_ta", "=", "outputs", "[", "1", "]", "\n", "value_final_ta", "=", "outputs", "[", "3", "]", "\n", "\n", "final_output", "=", "output_final_ta", ".", "stack", "(", ")", "\n", "final_output", ".", "set_shape", "(", "[", "None", ",", "None", ",", "output_size", "]", ")", "\n", "final_output", "=", "tf", ".", "transpose", "(", "final_output", ",", "[", "1", ",", "0", ",", "2", "]", ")", "\n", "\n", "final_value", "=", "value_final_ta", ".", "stack", "(", ")", "\n", "final_value", ".", "set_shape", "(", "[", "None", ",", "None", ",", "memory", ".", "shape", "[", "-", "1", "]", ".", "value", "]", ")", "\n", "final_value", "=", "tf", ".", "transpose", "(", "final_value", ",", "[", "1", ",", "0", ",", "2", "]", ")", "\n", "\n", "w_x_h_final_ta", "=", "outputs", "[", "6", "]", "\n", "w_x_h_final", "=", "w_x_h_final_ta", ".", "stack", "(", ")", "\n", "w_x_c_final_ta", "=", "outputs", "[", "7", "]", "\n", "w_x_c_final", "=", "w_x_c_final_ta", ".", "stack", "(", ")", "\n", "\n", "result", "=", "{", "\n", "\"outputs\"", ":", "final_output", ",", "\n", "\"values\"", ":", "final_value", ",", "\n", "\"initial_state\"", ":", "initial_state", ",", "\n", "\"weight_ratios\"", ":", "[", "w_x_h_final", ",", "w_x_c_final", ",", "w_initial", "]", "\n", "}", "\n", "\n", "", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.model_graph": [[269, 441], ["len", "len", "tensorflow.nn.bias_add", "tensorflow.nn.bias_add", "thumt.LegacyGRUCell_encoder_v2n", "thumt.LegacyGRUCell_encoder_v2n", "rnnsearch_lrp._encoder", "tensorflow.concat", "thumt.LegacyGRUCell_decoder_v2n", "rnnsearch_lrp._decoder", "tensorflow.pad", "tensorflow.concat", "thumt.maxout_v2n", "tensorflow.transpose", "thumt.linear_v2n", "thumt.linear_v2n", "tensorflow.reshape", "tensorflow.transpose", "tensorflow.reshape", "tensorflow.transpose", "tensorflow.range", "tensorflow.cast", "tensorflow.reshape", "tensorflow.concat", "tensorflow.transpose", "tensorflow.gather_nd", "tensorflow.reshape", "thumt.nn.smoothed_softmax_cross_entropy_with_logits", "tensorflow.reshape", "tensorflow.to_float", "tensorflow.variable_scope", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.nn.embedding_lookup", "tensorflow.variable_scope", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.nn.embedding_lookup", "tensorflow.nn.dropout", "tensorflow.nn.dropout", "tensorflow.nn.rnn_cell.DropoutWrapper", "tensorflow.nn.rnn_cell.DropoutWrapper", "tensorflow.nn.rnn_cell.DropoutWrapper", "thumt.nn.maxout", "thumt.nn.linear", "thumt.nn.linear", "tensorflow.nn.dropout", "tensorflow.shape", "tensorflow.shape", "tensorflow.sequence_mask", "tensorflow.reduce_sum", "tensorflow.reduce_sum", "tensorflow.expand_dims", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._encoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp._decoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.maxout_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.smoothed_softmax_cross_entropy_with_logits", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.maxout", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.linear"], ["", "def", "model_graph", "(", "features", ",", "labels", ",", "params", ")", ":", "\n", "    ", "src_vocab_size", "=", "len", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ")", "\n", "tgt_vocab_size", "=", "len", "(", "params", ".", "vocabulary", "[", "\"target\"", "]", ")", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "\"source_embedding\"", ")", ":", "\n", "        ", "src_emb", "=", "tf", ".", "get_variable", "(", "\"embedding\"", ",", "\n", "[", "src_vocab_size", ",", "params", ".", "embedding_size", "]", ")", "\n", "src_bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "[", "params", ".", "embedding_size", "]", ")", "\n", "src_inputs", "=", "tf", ".", "nn", ".", "embedding_lookup", "(", "src_emb", ",", "features", "[", "\"source\"", "]", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"target_embedding\"", ")", ":", "\n", "        ", "tgt_emb", "=", "tf", ".", "get_variable", "(", "\"embedding\"", ",", "\n", "[", "tgt_vocab_size", ",", "params", ".", "embedding_size", "]", ")", "\n", "tgt_bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "[", "params", ".", "embedding_size", "]", ")", "\n", "tgt_inputs", "=", "tf", ".", "nn", ".", "embedding_lookup", "(", "tgt_emb", ",", "features", "[", "\"target\"", "]", ")", "\n", "\n", "", "src_inputs", "=", "tf", ".", "nn", ".", "bias_add", "(", "src_inputs", ",", "src_bias", ")", "\n", "tgt_inputs", "=", "tf", ".", "nn", ".", "bias_add", "(", "tgt_inputs", ",", "tgt_bias", ")", "\n", "\n", "if", "params", ".", "dropout", "and", "not", "params", ".", "use_variational_dropout", ":", "\n", "        ", "src_inputs", "=", "tf", ".", "nn", ".", "dropout", "(", "src_inputs", ",", "1.0", "-", "params", ".", "dropout", ")", "\n", "tgt_inputs", "=", "tf", ".", "nn", ".", "dropout", "(", "tgt_inputs", ",", "1.0", "-", "params", ".", "dropout", ")", "\n", "\n", "# encoder", "\n", "", "cell_fw", "=", "lrp", ".", "LegacyGRUCell_encoder_v2n", "(", "params", ".", "hidden_size", ")", "\n", "cell_bw", "=", "lrp", ".", "LegacyGRUCell_encoder_v2n", "(", "params", ".", "hidden_size", ")", "\n", "\n", "if", "params", ".", "use_variational_dropout", ":", "\n", "        ", "cell_fw", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "DropoutWrapper", "(", "\n", "cell_fw", ",", "\n", "input_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "output_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "state_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "variational_recurrent", "=", "True", ",", "\n", "input_size", "=", "params", ".", "embedding_size", ",", "\n", "dtype", "=", "tf", ".", "float32", "\n", ")", "\n", "cell_bw", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "DropoutWrapper", "(", "\n", "cell_bw", ",", "\n", "input_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "output_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "state_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "variational_recurrent", "=", "True", ",", "\n", "input_size", "=", "params", ".", "embedding_size", ",", "\n", "dtype", "=", "tf", ".", "float32", "\n", ")", "\n", "\n", "", "encoder_output", "=", "_encoder", "(", "cell_fw", ",", "cell_bw", ",", "src_inputs", ",", "\n", "features", "[", "\"source_length\"", "]", ",", "params", ")", "\n", "\n", "w_x_h_fw", ",", "w_x_h_bw", "=", "encoder_output", "[", "\"weight_ratios\"", "]", "\n", "w_x_h_bw", "=", "w_x_h_bw", "[", ":", ":", "-", "1", ",", ":", ",", ":", ":", "-", "1", "]", "\n", "w_x_enc", "=", "tf", ".", "concat", "(", "[", "w_x_h_fw", ",", "w_x_h_bw", "]", ",", "-", "1", ")", "\n", "\n", "# decoder", "\n", "cell", "=", "lrp", ".", "LegacyGRUCell_decoder_v2n", "(", "params", ".", "hidden_size", ")", "\n", "\n", "if", "params", ".", "use_variational_dropout", ":", "\n", "        ", "cell", "=", "tf", ".", "nn", ".", "rnn_cell", ".", "DropoutWrapper", "(", "\n", "cell", ",", "\n", "input_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "output_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "state_keep_prob", "=", "1.0", "-", "params", ".", "dropout", ",", "\n", "variational_recurrent", "=", "True", ",", "\n", "# input + context", "\n", "input_size", "=", "params", ".", "embedding_size", "+", "2", "*", "params", ".", "hidden_size", ",", "\n", "dtype", "=", "tf", ".", "float32", "\n", ")", "\n", "\n", "", "length", "=", "{", "\n", "\"source\"", ":", "features", "[", "\"source_length\"", "]", ",", "\n", "\"target\"", ":", "features", "[", "\"target_length\"", "]", "\n", "}", "\n", "initial_state", "=", "encoder_output", "[", "\"final_states\"", "]", "[", "\"backward\"", "]", "\n", "decoder_output", "=", "_decoder", "(", "cell", ",", "tgt_inputs", ",", "encoder_output", "[", "\"annotation\"", "]", ",", "\n", "length", ",", "initial_state", ",", "w_x_enc", ",", "w_x_h_bw", ",", "params", ")", "\n", "\n", "w_x_dec", ",", "w_x_ctx", ",", "w_x_init", "=", "decoder_output", "[", "\"weight_ratios\"", "]", "\n", "\n", "# Shift left", "\n", "shifted_tgt_inputs", "=", "tf", ".", "pad", "(", "tgt_inputs", ",", "[", "[", "0", ",", "0", "]", ",", "[", "1", ",", "0", "]", ",", "[", "0", ",", "0", "]", "]", ")", "\n", "shifted_tgt_inputs", "=", "shifted_tgt_inputs", "[", ":", ",", ":", "-", "1", ",", ":", "]", "\n", "\n", "all_outputs", "=", "tf", ".", "concat", "(", "\n", "[", "\n", "tf", ".", "expand_dims", "(", "decoder_output", "[", "\"initial_state\"", "]", ",", "axis", "=", "1", ")", ",", "\n", "decoder_output", "[", "\"outputs\"", "]", ",", "\n", "]", ",", "\n", "axis", "=", "1", "\n", ")", "\n", "shifted_outputs", "=", "all_outputs", "[", ":", ",", ":", "-", "1", ",", ":", "]", "\n", "\n", "maxout_features", "=", "[", "\n", "shifted_tgt_inputs", ",", "\n", "shifted_outputs", ",", "\n", "decoder_output", "[", "\"values\"", "]", "\n", "]", "\n", "maxout_size", "=", "params", ".", "hidden_size", "//", "params", ".", "maxnum", "\n", "\n", "if", "labels", "is", "None", ":", "\n", "# Special case for non-incremental decoding", "\n", "        ", "maxout_features", "=", "[", "\n", "shifted_tgt_inputs", "[", ":", ",", "-", "1", ",", ":", "]", ",", "\n", "shifted_outputs", "[", ":", ",", "-", "1", ",", ":", "]", ",", "\n", "decoder_output", "[", "\"values\"", "]", "[", ":", ",", "-", "1", ",", ":", "]", "\n", "]", "\n", "maxhid", "=", "layers", ".", "nn", ".", "maxout", "(", "maxout_features", ",", "maxout_size", ",", "params", ".", "maxnum", ",", "\n", "params", ",", "concat", "=", "False", ")", "\n", "\n", "readout", "=", "layers", ".", "nn", ".", "linear", "(", "maxhid", ",", "params", ".", "embedding_size", ",", "False", ",", "\n", "False", ",", "scope", "=", "\"deepout\"", ")", "\n", "\n", "# Prediction", "\n", "logits", "=", "layers", ".", "nn", ".", "linear", "(", "readout", ",", "tgt_vocab_size", ",", "True", ",", "False", ",", "\n", "scope", "=", "\"softmax\"", ")", "\n", "\n", "return", "logits", "\n", "\n", "", "maxhid_maxout", "=", "lrp", ".", "maxout_v2n", "(", "maxout_features", ",", "maxout_size", ",", "params", ".", "maxnum", ",", "\n", "[", "w_x_dec", ",", "w_x_ctx", "]", ",", "params", ",", "concat", "=", "False", ")", "\n", "maxhid", "=", "maxhid_maxout", "[", "\"output\"", "]", "\n", "w_x_maxout", "=", "maxhid_maxout", "[", "\"weight_ratios\"", "]", "[", "0", "]", "\n", "w_x_maxout", "=", "tf", ".", "transpose", "(", "w_x_maxout", ",", "[", "0", ",", "2", ",", "1", ",", "3", "]", ")", "\n", "readout", "=", "lrp", ".", "linear_v2n", "(", "maxhid", ",", "params", ".", "embedding_size", ",", "False", ",", "\n", "[", "w_x_maxout", "]", ",", "params", ",", "False", ",", "scope", "=", "\"deepout\"", ")", "\n", "w_x_readout", "=", "readout", "[", "\"weight_ratios\"", "]", "[", "0", "]", "\n", "readout", "=", "readout", "[", "\"output\"", "]", "\n", "\n", "if", "params", ".", "dropout", "and", "not", "params", ".", "use_variational_dropout", ":", "\n", "        ", "readout", "=", "tf", ".", "nn", ".", "dropout", "(", "readout", ",", "1.0", "-", "params", ".", "dropout", ")", "\n", "\n", "# Prediction and final relevance", "\n", "", "logits", "=", "lrp", ".", "linear_v2n", "(", "readout", ",", "tgt_vocab_size", ",", "True", ",", "[", "w_x_readout", "]", ",", "\n", "params", ",", "False", ",", "scope", "=", "\"softmax\"", ")", "\n", "w_x_true", "=", "logits", "[", "\"weight_ratios\"", "]", "[", "0", "]", "\n", "logits", "=", "logits", "[", "\"output\"", "]", "\n", "logits", "=", "tf", ".", "reshape", "(", "logits", ",", "[", "-", "1", ",", "tgt_vocab_size", "]", ")", "\n", "w_x_true", "=", "tf", ".", "transpose", "(", "w_x_true", ",", "[", "0", ",", "2", ",", "1", ",", "3", "]", ")", "\n", "w_x_true", "=", "tf", ".", "reshape", "(", "w_x_true", ",", "[", "-", "1", ",", "tf", ".", "shape", "(", "w_x_true", ")", "[", "-", "2", "]", ",", "\n", "tf", ".", "shape", "(", "w_x_true", ")", "[", "-", "1", "]", "]", ")", "\n", "w_x_true", "=", "tf", ".", "transpose", "(", "w_x_true", ",", "[", "0", ",", "2", ",", "1", "]", ")", "\n", "labels_lrp", "=", "labels", "\n", "bs", "=", "tf", ".", "shape", "(", "labels_lrp", ")", "[", "0", "]", "\n", "idx", "=", "tf", ".", "range", "(", "tf", ".", "shape", "(", "labels_lrp", ")", "[", "-", "1", "]", ")", "\n", "idx", "=", "tf", ".", "cast", "(", "idx", ",", "tf", ".", "int64", ")", "\n", "idx", "=", "tf", ".", "reshape", "(", "idx", ",", "[", "1", ",", "-", "1", "]", ")", "\n", "labels_lrp", "=", "tf", ".", "concat", "(", "[", "idx", ",", "labels_lrp", "]", ",", "axis", "=", "0", ")", "\n", "labels_lrp", "=", "tf", ".", "transpose", "(", "labels_lrp", ",", "[", "1", ",", "0", "]", ")", "\n", "w_x_true", "=", "tf", ".", "gather_nd", "(", "w_x_true", ",", "labels_lrp", ")", "\n", "w_x_true", "=", "tf", ".", "reshape", "(", "w_x_true", ",", "[", "bs", ",", "-", "1", ",", "tf", ".", "shape", "(", "w_x_true", ")", "[", "-", "1", "]", "]", ")", "\n", "\n", "ce", "=", "layers", ".", "nn", ".", "smoothed_softmax_cross_entropy_with_logits", "(", "\n", "logits", "=", "logits", ",", "\n", "labels", "=", "labels", ",", "\n", "smoothing", "=", "params", ".", "label_smoothing", ",", "\n", "normalize", "=", "True", "\n", ")", "\n", "\n", "ce", "=", "tf", ".", "reshape", "(", "ce", ",", "tf", ".", "shape", "(", "labels", ")", ")", "\n", "tgt_mask", "=", "tf", ".", "to_float", "(", "\n", "tf", ".", "sequence_mask", "(", "\n", "features", "[", "\"target_length\"", "]", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "features", "[", "\"target\"", "]", ")", "[", "1", "]", "\n", ")", "\n", ")", "\n", "\n", "rlv_info", "=", "{", "}", "\n", "rlv_info", "[", "\"result\"", "]", "=", "w_x_true", "\n", "\n", "loss", "=", "tf", ".", "reduce_sum", "(", "ce", "*", "tgt_mask", ")", "/", "tf", ".", "reduce_sum", "(", "tgt_mask", ")", "\n", "\n", "return", "loss", ",", "rlv_info", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__": [[364, 366], ["thumt.NMTModel.__init__"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.__init__"], ["    ", "def", "__init__", "(", "self", ",", "params", ",", "scope", "=", "\"transformer\"", ")", ":", "\n", "        ", "super", "(", "Transformer_lrp", ",", "self", ")", ".", "__init__", "(", "params", "=", "params", ",", "scope", "=", "scope", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_training_func": [[367, 378], ["tensorflow.variable_scope", "transformer_lrp.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_training_func", "(", "self", ",", "initializer", ")", ":", "\n", "        ", "def", "training_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "self", ".", "parameters", "\n", "", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ",", "initializer", "=", "initializer", ",", "\n", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "                ", "loss", "=", "model_graph", "(", "features", ",", "features", "[", "\"target\"", "]", ",", "\n", "\"train\"", ",", "params", ")", "[", "0", "]", "\n", "return", "loss", "\n", "\n", "", "", "return", "training_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_relevance_func": [[379, 396], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "transformer_lrp.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_relevance_func", "(", "self", ")", ":", "\n", "        ", "def", "relevance_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "params", ".", "residual_dropout", "=", "0.0", "\n", "params", ".", "attention_dropout", "=", "0.0", "\n", "params", ".", "relu_dropout", "=", "0.0", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ",", "reuse", "=", "tf", ".", "AUTO_REUSE", ")", ":", "\n", "                ", "loss", ",", "rlv", "=", "model_graph", "(", "features", ",", "features", "[", "\"target\"", "]", ",", "\n", "\"train\"", ",", "params", ")", "\n", "return", "features", "[", "\"source\"", "]", ",", "features", "[", "\"target\"", "]", ",", "rlv", ",", "loss", "\n", "", "", "return", "relevance_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_evaluation_func": [[397, 415], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "transformer_lrp.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_evaluation_func", "(", "self", ")", ":", "\n", "        ", "def", "evaluation_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "params", ".", "residual_dropout", "=", "0.0", "\n", "params", ".", "attention_dropout", "=", "0.0", "\n", "params", ".", "relu_dropout", "=", "0.0", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "logits", "=", "model_graph", "(", "features", ",", "None", ",", "\"infer\"", ",", "params", ")", "\n", "\n", "", "return", "logits", "\n", "\n", "", "return", "evaluation_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_inference_func": [[416, 434], ["copy.copy", "copy.copy", "tensorflow.variable_scope", "transformer_lrp.model_graph"], "methods", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph"], ["", "def", "get_inference_func", "(", "self", ")", ":", "\n", "        ", "def", "inference_fn", "(", "features", ",", "params", "=", "None", ")", ":", "\n", "            ", "if", "params", "is", "None", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "self", ".", "parameters", ")", "\n", "", "else", ":", "\n", "                ", "params", "=", "copy", ".", "copy", "(", "params", ")", "\n", "\n", "", "params", ".", "residual_dropout", "=", "0.0", "\n", "params", ".", "attention_dropout", "=", "0.0", "\n", "params", ".", "relu_dropout", "=", "0.0", "\n", "params", ".", "label_smoothing", "=", "0.0", "\n", "\n", "with", "tf", ".", "variable_scope", "(", "self", ".", "_scope", ")", ":", "\n", "                ", "logits", "=", "model_graph", "(", "features", ",", "None", ",", "\"infer\"", ",", "params", ")", "\n", "\n", "", "return", "logits", "\n", "\n", "", "return", "inference_fn", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_name": [[435, 438], ["None"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_name", "(", ")", ":", "\n", "        ", "return", "\"transformer\"", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.Transformer_lrp.get_parameters": [[439, 479], ["tensorflow.contrib.training.HParams"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "get_parameters", "(", ")", ":", "\n", "        ", "params", "=", "tf", ".", "contrib", ".", "training", ".", "HParams", "(", "\n", "pad", "=", "\"<pad>\"", ",", "\n", "bos", "=", "\"<eos>\"", ",", "\n", "eos", "=", "\"<eos>\"", ",", "\n", "unk", "=", "\"<unk>\"", ",", "\n", "append_eos", "=", "False", ",", "\n", "hidden_size", "=", "512", ",", "\n", "filter_size", "=", "2048", ",", "\n", "num_heads", "=", "8", ",", "\n", "num_encoder_layers", "=", "6", ",", "\n", "num_decoder_layers", "=", "6", ",", "\n", "attention_dropout", "=", "0.0", ",", "\n", "residual_dropout", "=", "0.1", ",", "\n", "relu_dropout", "=", "0.0", ",", "\n", "label_smoothing", "=", "0.1", ",", "\n", "attention_key_channels", "=", "0", ",", "\n", "attention_value_channels", "=", "0", ",", "\n", "multiply_embedding_mode", "=", "\"sqrt_depth\"", ",", "\n", "shared_embedding_and_softmax_weights", "=", "False", ",", "\n", "shared_source_target_embedding", "=", "False", ",", "\n", "# Override default parameters", "\n", "learning_rate_decay", "=", "\"noam\"", ",", "\n", "initializer", "=", "\"uniform_unit_scaling\"", ",", "\n", "initializer_gain", "=", "1.0", ",", "\n", "learning_rate", "=", "1.0", ",", "\n", "layer_preprocess", "=", "\"none\"", ",", "\n", "layer_postprocess", "=", "\"layer_norm\"", ",", "\n", "batch_size", "=", "4096", ",", "\n", "constant_batch_size", "=", "False", ",", "\n", "adam_beta1", "=", "0.9", ",", "\n", "adam_beta2", "=", "0.98", ",", "\n", "adam_epsilon", "=", "1e-9", ",", "\n", "clip_grad_norm", "=", "0.0", ",", "\n", "# lrp", "\n", "stab", "=", "0.05", ",", "\n", ")", "\n", "\n", "return", "params", "\n", "", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.normalize": [[16, 25], ["tensorflow.abs", "tensorflow.reduce_sum", "tensorflow.abs", "tensorflow.reduce_sum", "tensorflow.expand_dims", "tensorflow.expand_dims"], "function", ["None"], ["def", "normalize", "(", "matrix", ",", "negative", "=", "False", ")", ":", "\n", "    ", "if", "negative", ":", "\n", "        ", "matrix_abs", "=", "tf", ".", "abs", "(", "matrix", ")", "\n", "total", "=", "tf", ".", "reduce_sum", "(", "matrix_abs", ",", "-", "1", ")", "\n", "return", "matrix", "/", "tf", ".", "expand_dims", "(", "total", ",", "-", "1", ")", "\n", "", "else", ":", "\n", "        ", "matrix", "=", "tf", ".", "abs", "(", "matrix", ")", "\n", "total", "=", "tf", ".", "reduce_sum", "(", "matrix", ",", "-", "1", ")", "\n", "return", "matrix", "/", "tf", ".", "expand_dims", "(", "total", ",", "-", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.get_weights": [[27, 59], ["len", "len", "tensorflow.random_normal_initializer", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.get_variable", "tensorflow.get_variable", "cmp", "ValueError"], "function", ["None"], ["", "", "def", "get_weights", "(", "params", ")", ":", "\n", "    ", "svocab", "=", "params", ".", "vocabulary", "[", "\"source\"", "]", "\n", "tvocab", "=", "params", ".", "vocabulary", "[", "\"target\"", "]", "\n", "src_vocab_size", "=", "len", "(", "svocab", ")", "\n", "tgt_vocab_size", "=", "len", "(", "tvocab", ")", "\n", "vocab_size", "=", "tgt_vocab_size", "\n", "\n", "hidden_size", "=", "params", ".", "hidden_size", "\n", "initializer", "=", "tf", ".", "random_normal_initializer", "(", "0.0", ",", "params", ".", "hidden_size", "**", "-", "0.5", ")", "\n", "\n", "if", "params", ".", "shared_source_target_embedding", ":", "\n", "        ", "if", "cmp", "(", "svocab", ",", "tvocab", ")", "!=", "0", ":", "\n", "            ", "raise", "ValueError", "(", "\"Source and target vocabularies are not the same\"", ")", "\n", "\n", "", "weights", "=", "tf", ".", "get_variable", "(", "\"weights\"", ",", "[", "src_vocab_size", ",", "hidden_size", "]", ",", "\n", "initializer", "=", "initializer", ")", "\n", "semb", ",", "temb", "=", "weights", ",", "weights", "\n", "", "else", ":", "\n", "        ", "semb", "=", "tf", ".", "get_variable", "(", "\"source_embedding\"", ",", "\n", "[", "src_vocab_size", ",", "hidden_size", "]", ",", "\n", "initializer", "=", "initializer", ")", "\n", "temb", "=", "tf", ".", "get_variable", "(", "\"target_embedding\"", ",", "\n", "[", "tgt_vocab_size", ",", "hidden_size", "]", ",", "\n", "initializer", "=", "initializer", ")", "\n", "\n", "", "if", "params", ".", "shared_embedding_and_softmax_weights", ":", "\n", "        ", "softmax_weights", "=", "temb", "\n", "", "else", ":", "\n", "        ", "softmax_weights", "=", "tf", ".", "get_variable", "(", "\"softmax\"", ",", "[", "vocab_size", ",", "hidden_size", "]", ",", "\n", "initializer", "=", "initializer", ")", "\n", "\n", "", "return", "semb", ",", "temb", ",", "softmax_weights", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process": [[61, 68], ["thumt.nn.layer_norm", "ValueError"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.layer_norm"], ["", "def", "layer_process", "(", "x", ",", "mode", ")", ":", "\n", "    ", "if", "not", "mode", "or", "mode", "==", "\"none\"", ":", "\n", "        ", "return", "x", "\n", "", "elif", "mode", "==", "\"layer_norm\"", ":", "\n", "        ", "return", "layers", ".", "nn", ".", "layer_norm", "(", "x", ")", "\n", "", "else", ":", "\n", "        ", "raise", "ValueError", "(", "\"Unknown mode %s\"", "%", "mode", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.residual_fn": [[70, 94], ["tensorflow.reshape", "tensorflow.reshape", "tensorflow.reshape", "thumt.weight_ratio_weighted_sum", "tensorflow.reshape", "tensorflow.reshape", "tensorflow.nn.dropout", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.weight_ratio.weight_ratio_weighted_sum"], ["", "", "def", "residual_fn", "(", "x", ",", "y", ",", "w_x_last", ",", "w_x_inp", ",", "params", ",", "keep_prob", "=", "None", ")", ":", "\n", "    ", "if", "keep_prob", "and", "keep_prob", "<", "1.0", ":", "\n", "        ", "y", "=", "tf", ".", "nn", ".", "dropout", "(", "y", ",", "keep_prob", ")", "\n", "", "batchsize", "=", "tf", ".", "shape", "(", "x", ")", "[", "0", "]", "\n", "len_inp", "=", "tf", ".", "shape", "(", "x", ")", "[", "1", "]", "\n", "len_src", "=", "tf", ".", "shape", "(", "w_x_last", ")", "[", "1", "]", "\n", "dim", "=", "tf", ".", "shape", "(", "x", ")", "[", "2", "]", "\n", "result", "=", "{", "}", "\n", "result", "[", "\"output\"", "]", "=", "x", "+", "y", "\n", "x_down", "=", "tf", ".", "reshape", "(", "x", ",", "[", "batchsize", ",", "-", "1", "]", ")", "\n", "y_down", "=", "tf", ".", "reshape", "(", "y", ",", "[", "batchsize", ",", "-", "1", "]", ")", "\n", "z_down", "=", "tf", ".", "reshape", "(", "result", "[", "\"output\"", "]", ",", "[", "batchsize", ",", "-", "1", "]", ")", "\n", "\n", "w_last_out", ",", "w_inp_out", "=", "wr", ".", "weight_ratio_weighted_sum", "(", "[", "x_down", ",", "y_down", "]", ",", "\n", "[", "1.", ",", "1.", "]", ",", "\n", "z_down", ",", "\n", "stab", "=", "params", ".", "stab", ",", "\n", "flatten", "=", "True", ")", "\n", "# bs, len*d", "\n", "w_last_out", "=", "tf", ".", "reshape", "(", "w_last_out", ",", "[", "batchsize", ",", "1", ",", "len_inp", ",", "dim", "]", ")", "\n", "w_inp_out", "=", "tf", ".", "reshape", "(", "w_inp_out", ",", "[", "batchsize", ",", "1", ",", "len_inp", ",", "dim", "]", ")", "\n", "w_x_out", "=", "w_x_last", "*", "w_last_out", "+", "w_x_inp", "*", "w_inp_out", "\n", "result", "[", "\"weight_ratio\"", "]", "=", "w_x_out", "\n", "return", "result", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.ffn_layer": [[96, 117], ["tensorflow.variable_scope", "tensorflow.variable_scope", "thumt.linear_v2n", "tensorflow.nn.relu", "tensorflow.nn.dropout", "tensorflow.variable_scope", "thumt.linear_v2n"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.linear_v2n"], ["", "def", "ffn_layer", "(", "inputs", ",", "w_x_inp", ",", "hidden_size", ",", "output_size", ",", "params", ",", "\n", "keep_prob", "=", "None", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"ffn_layer\"", ",", "values", "=", "[", "inputs", "]", ",", "\n", "dtype", "=", "dtype", ")", ":", "\n", "        ", "with", "tf", ".", "variable_scope", "(", "\"input_layer\"", ")", ":", "\n", "            ", "hidden_linear", "=", "lrp", ".", "linear_v2n", "(", "inputs", ",", "hidden_size", ",", "True", ",", "\n", "[", "w_x_inp", "]", ",", "params", ",", "True", ")", "\n", "hidden", "=", "hidden_linear", "[", "\"output\"", "]", "\n", "w_x_hid", "=", "hidden_linear", "[", "\"weight_ratios\"", "]", "[", "0", "]", "\n", "hidden", "=", "tf", ".", "nn", ".", "relu", "(", "hidden", ")", "\n", "\n", "", "if", "keep_prob", "and", "keep_prob", "<", "1.0", ":", "\n", "            ", "hidden", "=", "tf", ".", "nn", ".", "dropout", "(", "hidden", ",", "keep_prob", ")", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"output_layer\"", ")", ":", "\n", "            ", "output_linear", "=", "lrp", ".", "linear_v2n", "(", "hidden", ",", "output_size", ",", "True", ",", "\n", "[", "w_x_hid", "]", ",", "params", ",", "True", ")", "\n", "output", "=", "output_linear", "[", "\"output\"", "]", "\n", "w_x_outp", "=", "output_linear", "[", "\"weight_ratios\"", "]", "[", "0", "]", "\n", "\n", "", "return", "{", "\"output\"", ":", "output", ",", "\"weight_ratios\"", ":", "w_x_outp", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.transformer_encoder": [[119, 181], ["tensorflow.variable_scope", "thumt.create_diagonal_v2n", "range", "transformer_lrp.layer_process", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape", "tensorflow.variable_scope", "tensorflow.variable_scope", "thumt.multihead_attention_v2n", "transformer_lrp.residual_fn", "thumt.layer_process", "tensorflow.variable_scope", "transformer_lrp.ffn_layer", "transformer_lrp.residual_fn", "thumt.layer_process", "transformer_lrp.layer_process", "transformer_lrp.layer_process"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.create_diagonal_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.multihead_attention_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.ffn_layer", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process"], ["", "", "def", "transformer_encoder", "(", "inputs", ",", "bias", ",", "params", ",", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"encoder\"", ",", "dtype", "=", "dtype", ",", "\n", "values", "=", "[", "inputs", ",", "bias", "]", ")", ":", "\n", "        ", "len_src", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "1", "]", "\n", "batchsize", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "0", "]", "\n", "dim", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "2", "]", "\n", "x", "=", "inputs", "\n", "w_x_last", "=", "lrp", ".", "create_diagonal_v2n", "(", "batchsize", ",", "len_src", ",", "dim", ")", "\n", "for", "layer", "in", "range", "(", "params", ".", "num_encoder_layers", ")", ":", "\n", "            ", "with", "tf", ".", "variable_scope", "(", "\"layer_%d\"", "%", "layer", ")", ":", "\n", "                ", "with", "tf", ".", "variable_scope", "(", "\"self_attention\"", ")", ":", "\n", "                    ", "y_self", "=", "lrp", ".", "multihead_attention_v2n", "(", "\n", "layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "None", ",", "\n", "bias", ",", "\n", "w_x_last", ",", "\n", "params", ".", "num_heads", ",", "\n", "params", ".", "attention_key_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "attention_value_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "params", ",", "\n", "1.0", "-", "params", ".", "attention_dropout", "\n", ")", "\n", "y", "=", "y_self", "[", "\"outputs\"", "]", "\n", "w_x_self", "=", "y_self", "[", "\"weight_ratio\"", "]", "\n", "\n", "x_res", "=", "residual_fn", "(", "x", ",", "y", ",", "w_x_last", ",", "w_x_self", ",", "params", ",", "\n", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "x_res", "[", "\"output\"", "]", "\n", "w_x_selfres", "=", "x_res", "[", "\"weight_ratio\"", "]", "\n", "\n", "x_norm", "=", "lrp", ".", "layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ",", "\n", "w_x_selfres", ",", "params", ")", "\n", "x", "=", "x_norm", "[", "\"outputs\"", "]", "\n", "w_x_selfres", "=", "x_norm", "[", "\"weight_ratios\"", "]", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"feed_forward\"", ")", ":", "\n", "                    ", "y_ffn", "=", "ffn_layer", "(", "\n", "layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "w_x_selfres", ",", "\n", "params", ".", "filter_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "params", ",", "\n", "1.0", "-", "params", ".", "relu_dropout", ",", "\n", ")", "\n", "y", "=", "y_ffn", "[", "\"output\"", "]", "\n", "w_x_ffn", "=", "y_ffn", "[", "\"weight_ratios\"", "]", "\n", "\n", "x_res", "=", "residual_fn", "(", "x", ",", "y", ",", "w_x_selfres", ",", "w_x_ffn", ",", "params", ",", "\n", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "x_res", "[", "\"output\"", "]", "\n", "w_x_ffnres", "=", "x_res", "[", "\"weight_ratio\"", "]", "\n", "\n", "x_norm", "=", "lrp", ".", "layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ",", "\n", "w_x_ffnres", ",", "params", ")", "\n", "x", "=", "x_norm", "[", "\"outputs\"", "]", "\n", "w_x_ffnres", "=", "x_norm", "[", "\"weight_ratios\"", "]", "\n", "\n", "w_x_last", "=", "w_x_ffnres", "\n", "\n", "", "", "", "outputs", "=", "layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", "\n", "return", "{", "\"outputs\"", ":", "outputs", ",", "\"weight_ratios\"", ":", "w_x_last", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.transformer_decoder": [[183, 275], ["tensorflow.variable_scope", "tensorflow.zeros", "range", "transformer_lrp.layer_process", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape", "tensorflow.variable_scope", "tensorflow.variable_scope", "thumt.multihead_attention_v2n", "transformer_lrp.residual_fn", "thumt.layer_process", "tensorflow.variable_scope", "thumt.multihead_attention_v2n", "transformer_lrp.residual_fn", "thumt.layer_process", "tensorflow.variable_scope", "transformer_lrp.ffn_layer", "transformer_lrp.residual_fn", "thumt.layer_process", "transformer_lrp.layer_process", "transformer_lrp.layer_process", "transformer_lrp.layer_process"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.multihead_attention_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.utils.lrp_utils.multihead_attention_v2n", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.ffn_layer", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.residual_fn", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.layer_process"], ["", "", "def", "transformer_decoder", "(", "inputs", ",", "memory", ",", "bias", ",", "mem_bias", ",", "w_x_enc", ",", "params", ",", "\n", "dtype", "=", "None", ",", "scope", "=", "None", ")", ":", "\n", "    ", "with", "tf", ".", "variable_scope", "(", "scope", ",", "default_name", "=", "\"decoder\"", ",", "dtype", "=", "dtype", ",", "\n", "values", "=", "[", "inputs", ",", "memory", ",", "bias", ",", "mem_bias", "]", ")", ":", "\n", "        ", "len_src", "=", "tf", ".", "shape", "(", "memory", ")", "[", "1", "]", "\n", "len_trg", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "1", "]", "\n", "batchsize", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "0", "]", "\n", "dim", "=", "tf", ".", "shape", "(", "inputs", ")", "[", "2", "]", "\n", "x", "=", "inputs", "\n", "w_x_last", "=", "tf", ".", "zeros", "(", "[", "batchsize", ",", "len_src", ",", "len_trg", ",", "dim", "]", ",", "\n", "dtype", "=", "tf", ".", "float32", ")", "\n", "for", "layer", "in", "range", "(", "params", ".", "num_decoder_layers", ")", ":", "\n", "            ", "with", "tf", ".", "variable_scope", "(", "\"layer_%d\"", "%", "layer", ")", ":", "\n", "                ", "with", "tf", ".", "variable_scope", "(", "\"self_attention\"", ")", ":", "\n", "                    ", "y_self", "=", "lrp", ".", "multihead_attention_v2n", "(", "\n", "layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "None", ",", "\n", "bias", ",", "\n", "w_x_last", ",", "\n", "params", ".", "num_heads", ",", "\n", "params", ".", "attention_key_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "attention_value_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "params", ",", "\n", "1.0", "-", "params", ".", "attention_dropout", "\n", ")", "\n", "y", "=", "y_self", "[", "\"outputs\"", "]", "\n", "w_x_self", "=", "y_self", "[", "\"weight_ratio\"", "]", "\n", "\n", "x_res", "=", "residual_fn", "(", "x", ",", "y", ",", "w_x_last", ",", "w_x_self", ",", "params", ",", "\n", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "x_res", "[", "\"output\"", "]", "\n", "w_x_selfres", "=", "x_res", "[", "\"weight_ratio\"", "]", "\n", "\n", "x_norm", "=", "lrp", ".", "layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ",", "\n", "w_x_selfres", ",", "params", ")", "\n", "x", "=", "x_norm", "[", "\"outputs\"", "]", "\n", "w_x_selfres", "=", "x_norm", "[", "\"weight_ratios\"", "]", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"encdec_attention\"", ")", ":", "\n", "                    ", "y_encdec", "=", "lrp", ".", "multihead_attention_v2n", "(", "\n", "layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "memory", ",", "\n", "mem_bias", ",", "\n", "w_x_enc", ",", "\n", "params", ".", "num_heads", ",", "\n", "params", ".", "attention_key_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "attention_value_channels", "or", "params", ".", "hidden_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "params", ",", "\n", "1.0", "-", "params", ".", "attention_dropout", "\n", ")", "\n", "y", "=", "y_encdec", "[", "\"outputs\"", "]", "\n", "w_x_encdec", "=", "y_encdec", "[", "\"weight_ratio\"", "]", "\n", "\n", "x_res", "=", "residual_fn", "(", "x", ",", "y", ",", "w_x_selfres", ",", "w_x_encdec", ",", "params", ",", "\n", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "x_res", "[", "\"output\"", "]", "\n", "w_x_encdecres", "=", "x_res", "[", "\"weight_ratio\"", "]", "\n", "\n", "x_norm", "=", "lrp", ".", "layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ",", "\n", "w_x_encdecres", ",", "params", ")", "\n", "x", "=", "x_norm", "[", "\"outputs\"", "]", "\n", "w_x_encdecres", "=", "x_norm", "[", "\"weight_ratios\"", "]", "\n", "\n", "", "with", "tf", ".", "variable_scope", "(", "\"feed_forward\"", ")", ":", "\n", "                    ", "y_ffn", "=", "ffn_layer", "(", "\n", "layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", ",", "\n", "w_x_encdecres", ",", "\n", "params", ".", "filter_size", ",", "\n", "params", ".", "hidden_size", ",", "\n", "params", ",", "\n", "1.0", "-", "params", ".", "relu_dropout", ",", "\n", ")", "\n", "y", "=", "y_ffn", "[", "\"output\"", "]", "\n", "w_x_ffn", "=", "y_ffn", "[", "\"weight_ratios\"", "]", "\n", "\n", "x_res", "=", "residual_fn", "(", "x", ",", "y", ",", "w_x_encdecres", ",", "w_x_ffn", ",", "params", ",", "\n", "1.0", "-", "params", ".", "residual_dropout", ")", "\n", "x", "=", "x_res", "[", "\"output\"", "]", "\n", "w_x_ffnres", "=", "x_res", "[", "\"weight_ratio\"", "]", "\n", "\n", "x_norm", "=", "lrp", ".", "layer_process", "(", "x", ",", "params", ".", "layer_postprocess", ",", "\n", "w_x_ffnres", ",", "params", ")", "\n", "x", "=", "x_norm", "[", "\"outputs\"", "]", "\n", "w_x_ffnres", "=", "x_norm", "[", "\"weight_ratios\"", "]", "\n", "\n", "w_x_last", "=", "w_x_ffnres", "\n", "\n", "", "", "", "outputs", "=", "layer_process", "(", "x", ",", "params", ".", "layer_preprocess", ")", "\n", "\n", "return", "{", "\"outputs\"", ":", "outputs", ",", "\"weight_ratios\"", ":", "w_x_last", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.model_graph": [[277, 361], ["tensorflow.sequence_mask", "tensorflow.sequence_mask", "transformer_lrp.get_weights", "tensorflow.get_variable", "tensorflow.nn.bias_add", "thumt.attention.add_timing_signal", "thumt.attention.attention_bias", "thumt.attention.attention_bias", "thumt.attention.add_timing_signal", "transformer_lrp.transformer_encoder", "transformer_lrp.transformer_decoder", "tensorflow.gather", "tensorflow.reduce_sum", "thumt.stabilize", "tensorflow.reduce_sum", "tensorflow.reshape", "tensorflow.matmul", "thumt.nn.smoothed_softmax_cross_entropy_with_logits", "tensorflow.reshape", "tensorflow.transpose", "transformer_lrp.normalize", "tensorflow.gather", "tensorflow.gather", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.pad", "tensorflow.nn.dropout", "tensorflow.nn.dropout", "tensorflow.expand_dims", "tensorflow.expand_dims", "tensorflow.matmul", "tensorflow.shape", "tensorflow.reduce_sum", "tensorflow.reduce_sum", "tensorflow.shape", "tensorflow.shape", "tensorflow.shape"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.get_weights", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.add_timing_signal", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_bias", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.attention_bias", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.attention.add_timing_signal", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.transformer_encoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.transformer_decoder", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.rnnsearch_lrp.stabilize", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.layers.nn.smoothed_softmax_cross_entropy_with_logits", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.models.transformer_lrp.normalize"], ["", "", "def", "model_graph", "(", "features", ",", "labels", ",", "mode", ",", "params", ")", ":", "\n", "    ", "hidden_size", "=", "params", ".", "hidden_size", "\n", "\n", "src_seq", "=", "features", "[", "\"source\"", "]", "\n", "tgt_seq", "=", "features", "[", "\"target\"", "]", "\n", "src_len", "=", "features", "[", "\"source_length\"", "]", "\n", "tgt_len", "=", "features", "[", "\"target_length\"", "]", "\n", "src_mask", "=", "tf", ".", "sequence_mask", "(", "src_len", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "features", "[", "\"source\"", "]", ")", "[", "1", "]", ",", "\n", "dtype", "=", "tf", ".", "float32", ")", "\n", "tgt_mask", "=", "tf", ".", "sequence_mask", "(", "tgt_len", ",", "\n", "maxlen", "=", "tf", ".", "shape", "(", "features", "[", "\"target\"", "]", ")", "[", "1", "]", ",", "\n", "dtype", "=", "tf", ".", "float32", ")", "\n", "\n", "src_embedding", ",", "tgt_embedding", ",", "weights", "=", "get_weights", "(", "params", ")", "\n", "bias", "=", "tf", ".", "get_variable", "(", "\"bias\"", ",", "[", "hidden_size", "]", ")", "\n", "\n", "# id => embedding", "\n", "# src_seq: [batch, max_src_length]", "\n", "# tgt_seq: [batch, max_tgt_length]", "\n", "inputs", "=", "tf", ".", "gather", "(", "src_embedding", ",", "src_seq", ")", "*", "(", "hidden_size", "**", "0.5", ")", "\n", "targets", "=", "tf", ".", "gather", "(", "tgt_embedding", ",", "tgt_seq", ")", "*", "(", "hidden_size", "**", "0.5", ")", "\n", "inputs", "=", "inputs", "*", "tf", ".", "expand_dims", "(", "src_mask", ",", "-", "1", ")", "\n", "targets", "=", "targets", "*", "tf", ".", "expand_dims", "(", "tgt_mask", ",", "-", "1", ")", "\n", "\n", "# Preparing encoder & decoder input", "\n", "encoder_input", "=", "tf", ".", "nn", ".", "bias_add", "(", "inputs", ",", "bias", ")", "\n", "encoder_input", "=", "layers", ".", "attention", ".", "add_timing_signal", "(", "encoder_input", ")", "\n", "enc_attn_bias", "=", "layers", ".", "attention", ".", "attention_bias", "(", "src_mask", ",", "\"masking\"", ")", "\n", "dec_attn_bias", "=", "layers", ".", "attention", ".", "attention_bias", "(", "tf", ".", "shape", "(", "targets", ")", "[", "1", "]", ",", "\n", "\"causal\"", ")", "\n", "\n", "# Shift left", "\n", "decoder_input", "=", "tf", ".", "pad", "(", "targets", ",", "[", "[", "0", ",", "0", "]", ",", "[", "1", ",", "0", "]", ",", "[", "0", ",", "0", "]", "]", ")", "[", ":", ",", ":", "-", "1", ",", ":", "]", "\n", "decoder_input", "=", "layers", ".", "attention", ".", "add_timing_signal", "(", "decoder_input", ")", "\n", "\n", "if", "params", ".", "residual_dropout", ":", "\n", "        ", "keep_prob", "=", "1.0", "-", "params", ".", "residual_dropout", "\n", "encoder_input", "=", "tf", ".", "nn", ".", "dropout", "(", "encoder_input", ",", "keep_prob", ")", "\n", "decoder_input", "=", "tf", ".", "nn", ".", "dropout", "(", "decoder_input", ",", "keep_prob", ")", "\n", "\n", "", "encoder_out", "=", "transformer_encoder", "(", "encoder_input", ",", "enc_attn_bias", ",", "params", ")", "\n", "encoder_output", "=", "encoder_out", "[", "\"outputs\"", "]", "\n", "w_x_enc", "=", "encoder_out", "[", "\"weight_ratios\"", "]", "\n", "decoder_out", "=", "transformer_decoder", "(", "decoder_input", ",", "encoder_output", ",", "\n", "dec_attn_bias", ",", "enc_attn_bias", ",", "\n", "w_x_enc", ",", "params", ")", "\n", "decoder_output", "=", "decoder_out", "[", "\"outputs\"", "]", "\n", "w_x_dec", "=", "decoder_out", "[", "\"weight_ratios\"", "]", "\n", "\n", "weights_true", "=", "tf", ".", "gather", "(", "weights", ",", "labels", ")", "\n", "logits_elewise_true", "=", "decoder_output", "*", "weights_true", "\n", "logits_true", "=", "tf", ".", "reduce_sum", "(", "logits_elewise_true", ",", "-", "1", ")", "\n", "logits_stab", "=", "lrp", ".", "stabilize", "(", "tf", ".", "expand_dims", "(", "logits_true", ",", "-", "1", ")", ",", "params", ".", "stab", ")", "\n", "wr_logit_decoder", "=", "logits_elewise_true", "/", "logits_stab", "\n", "w_x_true", "=", "w_x_dec", "*", "tf", ".", "expand_dims", "(", "wr_logit_decoder", ",", "1", ")", "\n", "w_x_true", "=", "tf", ".", "reduce_sum", "(", "w_x_true", ",", "-", "1", ")", "\n", "# inference mode, take the last position", "\n", "if", "mode", "==", "\"infer\"", ":", "\n", "        ", "decoder_output", "=", "decoder_output", "[", ":", ",", "-", "1", ",", ":", "]", "\n", "logits", "=", "tf", ".", "matmul", "(", "decoder_output", ",", "weights", ",", "False", ",", "True", ")", "\n", "\n", "return", "logits", "\n", "\n", "# [batch, length, channel] => [batch * length, vocab_size]", "\n", "", "decoder_output", "=", "tf", ".", "reshape", "(", "decoder_output", ",", "[", "-", "1", ",", "hidden_size", "]", ")", "\n", "logits", "=", "tf", ".", "matmul", "(", "decoder_output", ",", "weights", ",", "False", ",", "True", ")", "\n", "\n", "# label smoothing", "\n", "ce", "=", "layers", ".", "nn", ".", "smoothed_softmax_cross_entropy_with_logits", "(", "\n", "logits", "=", "logits", ",", "\n", "labels", "=", "labels", ",", "\n", "smoothing", "=", "params", ".", "label_smoothing", ",", "\n", "normalize", "=", "True", "\n", ")", "\n", "\n", "ce", "=", "tf", ".", "reshape", "(", "ce", ",", "tf", ".", "shape", "(", "tgt_seq", ")", ")", "\n", "loss", "=", "tf", ".", "reduce_sum", "(", "ce", "*", "tgt_mask", ")", "/", "tf", ".", "reduce_sum", "(", "tgt_mask", ")", "\n", "\n", "rlv_info", "=", "{", "}", "\n", "R_x_true", "=", "tf", ".", "transpose", "(", "w_x_true", ",", "[", "0", ",", "2", ",", "1", "]", ")", "\n", "rlv_info", "[", "\"result\"", "]", "=", "normalize", "(", "R_x_true", ",", "True", ")", "\n", "\n", "return", "loss", ",", "rlv_info", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.cache.cache_features": [[11, 29], ["list", "tensorflow.FIFOQueue", "list", "tf.FIFOQueue.dequeue", "zip", "features.itervalues", "tensorflow.split", "zip", "tf.FIFOQueue.enqueue", "features.iterkeys", "v.set_shape", "tensorflow.group", "tensorflow.no_op", "enumerate"], "function", ["None"], ["def", "cache_features", "(", "features", ",", "num_shards", ")", ":", "\n", "    ", "if", "num_shards", "==", "1", ":", "\n", "        ", "return", "features", ",", "tf", ".", "no_op", "(", "name", "=", "\"init_queue\"", ")", "\n", "\n", "", "flat_features", "=", "list", "(", "features", ".", "itervalues", "(", ")", ")", "\n", "queue", "=", "tf", ".", "FIFOQueue", "(", "num_shards", ",", "dtypes", "=", "[", "v", ".", "dtype", "for", "v", "in", "flat_features", "]", ")", "\n", "flat_features", "=", "[", "tf", ".", "split", "(", "v", ",", "num_shards", ",", "axis", "=", "0", ")", "for", "v", "in", "flat_features", "]", "\n", "flat_features", "=", "list", "(", "zip", "(", "*", "flat_features", ")", ")", "\n", "init_ops", "=", "[", "queue", ".", "enqueue", "(", "v", ",", "name", "=", "\"enqueue_%d\"", "%", "i", ")", "\n", "for", "i", ",", "v", "in", "enumerate", "(", "flat_features", ")", "]", "\n", "flat_feature", "=", "queue", ".", "dequeue", "(", ")", "\n", "new_features", "=", "{", "}", "\n", "\n", "for", "k", ",", "v", "in", "zip", "(", "features", ".", "iterkeys", "(", ")", ",", "flat_feature", ")", ":", "\n", "        ", "v", ".", "set_shape", "(", "features", "[", "k", "]", ".", "shape", ")", "\n", "new_features", "[", "k", "]", "=", "v", "\n", "\n", "", "return", "new_features", ",", "tf", ".", "group", "(", "*", "init_ops", ")", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.batch_examples": [[15, 82], ["tensorflow.name_scope", "example.values", "tensorflow.contrib.training.bucket_by_sequence_length", "boundaries.append", "max", "max", "tensorflow.maximum", "tensorflow.shape", "int", "math.log"], "function", ["None"], ["def", "batch_examples", "(", "example", ",", "batch_size", ",", "max_length", ",", "mantissa_bits", ",", "\n", "shard_multiplier", "=", "1", ",", "length_multiplier", "=", "1", ",", "constant", "=", "False", ",", "\n", "num_threads", "=", "4", ",", "drop_long_sequences", "=", "True", ")", ":", "\n", "    ", "\"\"\" Batch examples\n\n    :param example: A dictionary of <feature name, Tensor>.\n    :param batch_size: The number of tokens or sentences in a batch\n    :param max_length: The maximum length of a example to keep\n    :param mantissa_bits: An integer\n    :param shard_multiplier: an integer increasing the batch_size to suit\n        splitting across data shards.\n    :param length_multiplier: an integer multiplier that is used to\n        increase the batch sizes and sequence length tolerance.\n    :param constant: Whether to use constant batch size\n    :param num_threads: Number of threads\n    :param drop_long_sequences: Whether to drop long sequences\n\n    :returns: A dictionary of batched examples\n    \"\"\"", "\n", "\n", "with", "tf", ".", "name_scope", "(", "\"batch_examples\"", ")", ":", "\n", "        ", "max_length", "=", "max_length", "or", "batch_size", "\n", "min_length", "=", "8", "\n", "mantissa_bits", "=", "mantissa_bits", "\n", "\n", "# Compute boundaries", "\n", "x", "=", "min_length", "\n", "boundaries", "=", "[", "]", "\n", "\n", "while", "x", "<", "max_length", ":", "\n", "            ", "boundaries", ".", "append", "(", "x", ")", "\n", "x", "+=", "2", "**", "max", "(", "0", ",", "int", "(", "math", ".", "log", "(", "x", ",", "2", ")", ")", "-", "mantissa_bits", ")", "\n", "\n", "# Whether the batch size is constant", "\n", "", "if", "not", "constant", ":", "\n", "            ", "batch_sizes", "=", "[", "max", "(", "1", ",", "batch_size", "//", "length", ")", "\n", "for", "length", "in", "boundaries", "+", "[", "max_length", "]", "]", "\n", "batch_sizes", "=", "[", "b", "*", "shard_multiplier", "for", "b", "in", "batch_sizes", "]", "\n", "bucket_capacities", "=", "[", "2", "*", "b", "for", "b", "in", "batch_sizes", "]", "\n", "", "else", ":", "\n", "            ", "batch_sizes", "=", "batch_size", "*", "shard_multiplier", "\n", "bucket_capacities", "=", "[", "2", "*", "n", "for", "n", "in", "boundaries", "+", "[", "max_length", "]", "]", "\n", "\n", "", "max_length", "*=", "length_multiplier", "\n", "boundaries", "=", "[", "boundary", "*", "length_multiplier", "for", "boundary", "in", "boundaries", "]", "\n", "max_length", "=", "max_length", "if", "drop_long_sequences", "else", "10", "**", "9", "\n", "\n", "# The queue to bucket on will be chosen based on maximum length", "\n", "max_example_length", "=", "0", "\n", "for", "v", "in", "example", ".", "values", "(", ")", ":", "\n", "            ", "if", "v", ".", "shape", ".", "ndims", ">", "0", ":", "\n", "                ", "seq_length", "=", "tf", ".", "shape", "(", "v", ")", "[", "0", "]", "\n", "max_example_length", "=", "tf", ".", "maximum", "(", "max_example_length", ",", "seq_length", ")", "\n", "\n", "", "", "(", "_", ",", "outputs", ")", "=", "tf", ".", "contrib", ".", "training", ".", "bucket_by_sequence_length", "(", "\n", "max_example_length", ",", "\n", "example", ",", "\n", "batch_sizes", ",", "\n", "[", "b", "+", "1", "for", "b", "in", "boundaries", "]", ",", "\n", "num_threads", "=", "num_threads", ",", "\n", "capacity", "=", "2", ",", "# Number of full batches to store, we don't need many.", "\n", "bucket_capacities", "=", "bucket_capacities", ",", "\n", "dynamic_pad", "=", "True", ",", "\n", "keep_input", "=", "(", "max_example_length", "<=", "max_length", ")", "\n", ")", "\n", "\n", "", "return", "outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.get_training_input": [[84, 172], ["tensorflow.device", "tensorflow.data.TextLineDataset", "tensorflow.data.TextLineDataset", "tensorflow.data.Dataset.zip", "dataset.map.shuffle", "dataset.map.repeat", "dataset.map.map", "dataset.map.map", "dataset.map.map", "dataset.map.make_one_shot_iterator", "tensorflow.contrib.data.make_saveable_from_iterator", "tensorflow.add_to_collection", "dataset.make_one_shot_iterator.get_next", "tensorflow.contrib.lookup.index_table_from_tensor", "tensorflow.contrib.lookup.index_table_from_tensor", "tf.contrib.lookup.index_table_from_tensor.lookup", "tf.contrib.lookup.index_table_from_tensor.lookup", "dataset.batch_examples", "tensorflow.to_int32", "tensorflow.to_int32", "tensorflow.to_int32", "tensorflow.to_int32", "tensorflow.squeeze", "tensorflow.squeeze", "tensorflow.constant", "tensorflow.constant", "len", "tensorflow.concat", "tensorflow.concat", "tensorflow.shape", "tensorflow.shape", "tensorflow.string_split", "tensorflow.string_split", "tensorflow.constant", "tensorflow.constant"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.record.batch_examples"], ["", "def", "get_training_input", "(", "filenames", ",", "params", ")", ":", "\n", "    ", "\"\"\" Get input for training stage\n\n    :param filenames: A list contains [source_filename, target_filename]\n    :param params: Hyper-parameters\n\n    :returns: A dictionary of pair <Key, Tensor>\n    \"\"\"", "\n", "\n", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "        ", "src_dataset", "=", "tf", ".", "data", ".", "TextLineDataset", "(", "filenames", "[", "0", "]", ")", "\n", "tgt_dataset", "=", "tf", ".", "data", ".", "TextLineDataset", "(", "filenames", "[", "1", "]", ")", "\n", "\n", "dataset", "=", "tf", ".", "data", ".", "Dataset", ".", "zip", "(", "(", "src_dataset", ",", "tgt_dataset", ")", ")", "\n", "dataset", "=", "dataset", ".", "shuffle", "(", "params", ".", "buffer_size", ")", "\n", "dataset", "=", "dataset", ".", "repeat", "(", ")", "\n", "\n", "# Split string", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "src", ",", "tgt", ":", "(", "\n", "tf", ".", "string_split", "(", "[", "src", "]", ")", ".", "values", ",", "\n", "tf", ".", "string_split", "(", "[", "tgt", "]", ")", ".", "values", "\n", ")", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "# Append <eos> symbol", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "src", ",", "tgt", ":", "(", "\n", "tf", ".", "concat", "(", "[", "src", ",", "[", "tf", ".", "constant", "(", "params", ".", "eos", ")", "]", "]", ",", "axis", "=", "0", ")", ",", "\n", "tf", ".", "concat", "(", "[", "tgt", ",", "[", "tf", ".", "constant", "(", "params", ".", "eos", ")", "]", "]", ",", "axis", "=", "0", ")", "\n", ")", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "# Convert to dictionary", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "src", ",", "tgt", ":", "{", "\n", "\"source\"", ":", "src", ",", "\n", "\"target\"", ":", "tgt", ",", "\n", "\"source_length\"", ":", "tf", ".", "shape", "(", "src", ")", ",", "\n", "\"target_length\"", ":", "tf", ".", "shape", "(", "tgt", ")", "\n", "}", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "# Create iterator", "\n", "iterator", "=", "dataset", ".", "make_one_shot_iterator", "(", ")", "\n", "\n", "# Create saveable object from iterator.", "\n", "saveable", "=", "tf", ".", "contrib", ".", "data", ".", "make_saveable_from_iterator", "(", "iterator", ")", "\n", "# Save the iterator state by adding it to the saveable objects collection.", "\n", "tf", ".", "add_to_collection", "(", "tf", ".", "GraphKeys", ".", "SAVEABLE_OBJECTS", ",", "saveable", ")", "\n", "\n", "features", "=", "iterator", ".", "get_next", "(", ")", "\n", "\n", "# Create lookup table", "\n", "src_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"source\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "tgt_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"target\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "\n", "# String to index lookup", "\n", "features", "[", "\"source\"", "]", "=", "src_table", ".", "lookup", "(", "features", "[", "\"source\"", "]", ")", "\n", "features", "[", "\"target\"", "]", "=", "tgt_table", ".", "lookup", "(", "features", "[", "\"target\"", "]", ")", "\n", "\n", "# Batching", "\n", "shard_multiplier", "=", "len", "(", "params", ".", "device_list", ")", "*", "params", ".", "update_cycle", "\n", "features", "=", "batch_examples", "(", "features", ",", "params", ".", "batch_size", ",", "\n", "params", ".", "max_length", ",", "params", ".", "mantissa_bits", ",", "\n", "shard_multiplier", "=", "shard_multiplier", ",", "\n", "length_multiplier", "=", "params", ".", "length_multiplier", ",", "\n", "constant", "=", "params", ".", "constant_batch_size", ",", "\n", "num_threads", "=", "params", ".", "num_threads", ")", "\n", "\n", "# Convert to int32", "\n", "features", "[", "\"source\"", "]", "=", "tf", ".", "to_int32", "(", "features", "[", "\"source\"", "]", ")", "\n", "features", "[", "\"target\"", "]", "=", "tf", ".", "to_int32", "(", "features", "[", "\"target\"", "]", ")", "\n", "features", "[", "\"source_length\"", "]", "=", "tf", ".", "to_int32", "(", "features", "[", "\"source_length\"", "]", ")", "\n", "features", "[", "\"target_length\"", "]", "=", "tf", ".", "to_int32", "(", "features", "[", "\"target_length\"", "]", ")", "\n", "features", "[", "\"source_length\"", "]", "=", "tf", ".", "squeeze", "(", "features", "[", "\"source_length\"", "]", ",", "1", ")", "\n", "features", "[", "\"target_length\"", "]", "=", "tf", ".", "squeeze", "(", "features", "[", "\"target_length\"", "]", ",", "1", ")", "\n", "\n", "return", "features", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.get_training_confidence_input": [[174, 272], ["tensorflow.device", "tensorflow.data.TextLineDataset", "tensorflow.data.TextLineDataset", "tensorflow.data.TextLineDataset", "tensorflow.data.TextLineDataset", "tensorflow.data.Dataset.zip", "dataset.map.shuffle", "dataset.map.repeat", "dataset.map.map", "dataset.map.map", "dataset.map.map", "dataset.map.make_one_shot_iterator", "tensorflow.contrib.data.make_saveable_from_iterator", "tensorflow.add_to_collection", "dataset.make_one_shot_iterator.get_next", "tensorflow.contrib.lookup.index_table_from_tensor", "tensorflow.contrib.lookup.index_table_from_tensor", "tf.contrib.lookup.index_table_from_tensor.lookup", "tf.contrib.lookup.index_table_from_tensor.lookup", "dataset.batch_examples", "tensorflow.to_int32", "tensorflow.to_int32", "tensorflow.to_int32", "tensorflow.to_int32", "tensorflow.squeeze", "tensorflow.squeeze", "tensorflow.constant", "tensorflow.constant", "len", "tensorflow.concat", "tensorflow.concat", "tensorflow.string_to_number", "tensorflow.string_to_number", "tensorflow.shape", "tensorflow.shape", "tensorflow.string_split", "tensorflow.string_split", "tensorflow.string_split", "tensorflow.string_split", "tensorflow.constant", "tensorflow.constant"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.record.batch_examples"], ["", "", "def", "get_training_confidence_input", "(", "filenames", ",", "params", ")", ":", "\n", "    ", "\"\"\" Get input for training stage\n\n    :param filenames: A list contains [source_filename, target_filename]\n    :param params: Hyper-parameters\n\n    :returns: A dictionary of pair <Key, Tensor>\n    \"\"\"", "\n", "\n", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "        ", "src_dataset", "=", "tf", ".", "data", ".", "TextLineDataset", "(", "filenames", "[", "0", "]", ")", "\n", "tgt_dataset", "=", "tf", ".", "data", ".", "TextLineDataset", "(", "filenames", "[", "1", "]", ")", "\n", "confidence_dataset", "=", "tf", ".", "data", ".", "TextLineDataset", "(", "params", ".", "confidence", ")", "\n", "sencf_dataset", "=", "tf", ".", "data", ".", "TextLineDataset", "(", "params", ".", "sen_confidence", ")", "\n", "\n", "dataset", "=", "tf", ".", "data", ".", "Dataset", ".", "zip", "(", "(", "src_dataset", ",", "tgt_dataset", ",", "confidence_dataset", ",", "sencf_dataset", ")", ")", "\n", "dataset", "=", "dataset", ".", "shuffle", "(", "params", ".", "buffer_size", ")", "\n", "dataset", "=", "dataset", ".", "repeat", "(", ")", "\n", "\n", "# Split string", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "src", ",", "tgt", ",", "cfd", ",", "scf", ":", "(", "\n", "tf", ".", "string_split", "(", "[", "src", "]", ")", ".", "values", ",", "\n", "tf", ".", "string_split", "(", "[", "tgt", "]", ")", ".", "values", ",", "\n", "tf", ".", "string_split", "(", "[", "cfd", "]", ")", ".", "values", ",", "\n", "tf", ".", "string_split", "(", "[", "scf", "]", ")", ".", "values", "\n", ")", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "# Append <eos> symbol", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "src", ",", "tgt", ",", "cfd", ",", "scf", ":", "(", "\n", "tf", ".", "concat", "(", "[", "src", ",", "[", "tf", ".", "constant", "(", "params", ".", "eos", ")", "]", "]", ",", "axis", "=", "0", ")", ",", "\n", "tf", ".", "concat", "(", "[", "tgt", ",", "[", "tf", ".", "constant", "(", "params", ".", "eos", ")", "]", "]", ",", "axis", "=", "0", ")", ",", "\n", "tf", ".", "string_to_number", "(", "cfd", ")", ",", "\n", "tf", ".", "string_to_number", "(", "scf", ")", "\n", "# cfd", "\n", ")", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "# Convert to dictionary", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "src", ",", "tgt", ",", "cfd", ",", "scf", ":", "{", "\n", "\"source\"", ":", "src", ",", "\n", "\"target\"", ":", "tgt", ",", "\n", "\"confidence\"", ":", "cfd", ",", "\n", "\"sen_confidence\"", ":", "scf", ",", "\n", "\"source_length\"", ":", "tf", ".", "shape", "(", "src", ")", ",", "\n", "\"target_length\"", ":", "tf", ".", "shape", "(", "tgt", ")", "\n", "}", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "# Create iterator", "\n", "iterator", "=", "dataset", ".", "make_one_shot_iterator", "(", ")", "\n", "\n", "# Create saveable object from iterator.", "\n", "saveable", "=", "tf", ".", "contrib", ".", "data", ".", "make_saveable_from_iterator", "(", "iterator", ")", "\n", "# Save the iterator state by adding it to the saveable objects collection.", "\n", "tf", ".", "add_to_collection", "(", "tf", ".", "GraphKeys", ".", "SAVEABLE_OBJECTS", ",", "saveable", ")", "\n", "\n", "features", "=", "iterator", ".", "get_next", "(", ")", "\n", "\n", "# Create lookup table", "\n", "src_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"source\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "tgt_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"target\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "\n", "# String to index lookup", "\n", "features", "[", "\"source\"", "]", "=", "src_table", ".", "lookup", "(", "features", "[", "\"source\"", "]", ")", "\n", "features", "[", "\"target\"", "]", "=", "tgt_table", ".", "lookup", "(", "features", "[", "\"target\"", "]", ")", "\n", "\n", "# Batching", "\n", "shard_multiplier", "=", "len", "(", "params", ".", "device_list", ")", "*", "params", ".", "update_cycle", "\n", "features", "=", "batch_examples", "(", "features", ",", "params", ".", "batch_size", ",", "\n", "params", ".", "max_length", ",", "params", ".", "mantissa_bits", ",", "\n", "shard_multiplier", "=", "shard_multiplier", ",", "\n", "length_multiplier", "=", "params", ".", "length_multiplier", ",", "\n", "constant", "=", "params", ".", "constant_batch_size", ",", "\n", "num_threads", "=", "params", ".", "num_threads", ")", "\n", "\n", "# Convert to int32", "\n", "features", "[", "\"source\"", "]", "=", "tf", ".", "to_int32", "(", "features", "[", "\"source\"", "]", ")", "\n", "features", "[", "\"target\"", "]", "=", "tf", ".", "to_int32", "(", "features", "[", "\"target\"", "]", ")", "\n", "# features[\"confidence\"] = tf.string_to_number(features[\"confidence\"])", "\n", "features", "[", "\"source_length\"", "]", "=", "tf", ".", "to_int32", "(", "features", "[", "\"source_length\"", "]", ")", "\n", "features", "[", "\"target_length\"", "]", "=", "tf", ".", "to_int32", "(", "features", "[", "\"target_length\"", "]", ")", "\n", "features", "[", "\"source_length\"", "]", "=", "tf", ".", "squeeze", "(", "features", "[", "\"source_length\"", "]", ",", "1", ")", "\n", "features", "[", "\"target_length\"", "]", "=", "tf", ".", "squeeze", "(", "features", "[", "\"target_length\"", "]", ",", "1", ")", "\n", "\n", "return", "features", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.sort_input_file": [[274, 293], ["sorted", "enumerate", "tensorflow.gfile.Open", "sorted_inputs.append", "line.strip", "len", "enumerate", "operator.itemgetter", "line.strip().split", "line.strip"], "function", ["None"], ["", "", "def", "sort_input_file", "(", "filename", ",", "reverse", "=", "True", ")", ":", "\n", "# Read file", "\n", "    ", "with", "tf", ".", "gfile", ".", "Open", "(", "filename", ")", "as", "fd", ":", "\n", "        ", "inputs", "=", "[", "line", ".", "strip", "(", ")", "for", "line", "in", "fd", "]", "\n", "\n", "", "input_lens", "=", "[", "\n", "(", "i", ",", "len", "(", "line", ".", "strip", "(", ")", ".", "split", "(", ")", ")", ")", "for", "i", ",", "line", "in", "enumerate", "(", "inputs", ")", "\n", "]", "\n", "\n", "sorted_input_lens", "=", "sorted", "(", "input_lens", ",", "key", "=", "operator", ".", "itemgetter", "(", "1", ")", ",", "\n", "reverse", "=", "reverse", ")", "\n", "sorted_keys", "=", "{", "}", "\n", "sorted_inputs", "=", "[", "]", "\n", "\n", "for", "i", ",", "(", "index", ",", "_", ")", "in", "enumerate", "(", "sorted_input_lens", ")", ":", "\n", "        ", "sorted_inputs", ".", "append", "(", "inputs", "[", "index", "]", ")", "\n", "sorted_keys", "[", "index", "]", "=", "i", "\n", "\n", "", "return", "sorted_keys", ",", "sorted_inputs", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.sort_and_zip_files": [[295, 320], ["zip", "sorted", "enumerate", "tensorflow.gfile.GFile", "input_lens.append", "inputs.append", "fd.close", "sorted_inputs.append", "list", "line.strip", "operator.itemgetter", "zip", "len", "lines[].split"], "function", ["None"], ["", "def", "sort_and_zip_files", "(", "names", ")", ":", "\n", "    ", "inputs", "=", "[", "]", "\n", "input_lens", "=", "[", "]", "\n", "files", "=", "[", "tf", ".", "gfile", ".", "GFile", "(", "name", ")", "for", "name", "in", "names", "]", "\n", "\n", "count", "=", "0", "\n", "\n", "for", "lines", "in", "zip", "(", "*", "files", ")", ":", "\n", "        ", "lines", "=", "[", "line", ".", "strip", "(", ")", "for", "line", "in", "lines", "]", "\n", "input_lens", ".", "append", "(", "(", "count", ",", "len", "(", "lines", "[", "0", "]", ".", "split", "(", ")", ")", ")", ")", "\n", "inputs", ".", "append", "(", "lines", ")", "\n", "count", "+=", "1", "\n", "\n", "# Close files", "\n", "", "for", "fd", "in", "files", ":", "\n", "        ", "fd", ".", "close", "(", ")", "\n", "\n", "", "sorted_input_lens", "=", "sorted", "(", "input_lens", ",", "key", "=", "operator", ".", "itemgetter", "(", "1", ")", ",", "\n", "reverse", "=", "True", ")", "\n", "sorted_inputs", "=", "[", "]", "\n", "\n", "for", "i", ",", "(", "index", ",", "_", ")", "in", "enumerate", "(", "sorted_input_lens", ")", ":", "\n", "        ", "sorted_inputs", ".", "append", "(", "inputs", "[", "index", "]", ")", "\n", "\n", "", "return", "[", "list", "(", "x", ")", "for", "x", "in", "zip", "(", "*", "sorted_inputs", ")", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.get_evaluation_input": [[322, 377], ["tensorflow.device", "tensorflow.data.Dataset.zip", "dataset.map.map", "dataset.map.padded_batch", "dataset.map.make_one_shot_iterator", "dataset.make_one_shot_iterator.get_next", "tensorflow.contrib.lookup.index_table_from_tensor", "tf.contrib.lookup.index_table_from_tensor.lookup", "tensorflow.data.Dataset.from_tensor_slices", "dataset.map.map", "dataset.map.map", "datasets.append", "tuple", "tensorflow.constant", "tensorflow.concat", "tensorflow.Dimension", "tensorflow.string_split", "tensorflow.shape", "tensorflow.Dimension", "len", "len", "tensorflow.constant"], "function", ["None"], ["", "def", "get_evaluation_input", "(", "inputs", ",", "params", ")", ":", "\n", "    ", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "# Create datasets", "\n", "        ", "datasets", "=", "[", "]", "\n", "\n", "for", "data", "in", "inputs", ":", "\n", "            ", "dataset", "=", "tf", ".", "data", ".", "Dataset", ".", "from_tensor_slices", "(", "data", ")", "\n", "# Split string", "\n", "dataset", "=", "dataset", ".", "map", "(", "lambda", "x", ":", "tf", ".", "string_split", "(", "[", "x", "]", ")", ".", "values", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", ")", "\n", "# Append <eos>", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "x", ":", "tf", ".", "concat", "(", "[", "x", ",", "[", "tf", ".", "constant", "(", "params", ".", "eos", ")", "]", "]", ",", "axis", "=", "0", ")", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "datasets", ".", "append", "(", "dataset", ")", "\n", "\n", "", "dataset", "=", "tf", ".", "data", ".", "Dataset", ".", "zip", "(", "tuple", "(", "datasets", ")", ")", "\n", "\n", "# Convert tuple to dictionary", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "*", "x", ":", "{", "\n", "\"source\"", ":", "x", "[", "0", "]", ",", "\n", "\"source_length\"", ":", "tf", ".", "shape", "(", "x", "[", "0", "]", ")", "[", "0", "]", ",", "\n", "\"references\"", ":", "x", "[", "1", ":", "]", "\n", "}", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "dataset", "=", "dataset", ".", "padded_batch", "(", "\n", "params", ".", "eval_batch_size", ",", "\n", "{", "\n", "\"source\"", ":", "[", "tf", ".", "Dimension", "(", "None", ")", "]", ",", "\n", "\"source_length\"", ":", "[", "]", ",", "\n", "\"references\"", ":", "(", "tf", ".", "Dimension", "(", "None", ")", ",", ")", "*", "(", "len", "(", "inputs", ")", "-", "1", ")", "\n", "}", ",", "\n", "{", "\n", "\"source\"", ":", "params", ".", "pad", ",", "\n", "\"source_length\"", ":", "0", ",", "\n", "\"references\"", ":", "(", "params", ".", "pad", ",", ")", "*", "(", "len", "(", "inputs", ")", "-", "1", ")", "\n", "}", "\n", ")", "\n", "\n", "iterator", "=", "dataset", ".", "make_one_shot_iterator", "(", ")", "\n", "features", "=", "iterator", ".", "get_next", "(", ")", "\n", "\n", "# Covert source symbols to ids", "\n", "src_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"source\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "\n", "features", "[", "\"source\"", "]", "=", "src_table", ".", "lookup", "(", "features", "[", "\"source\"", "]", ")", "\n", "\n", "", "return", "features", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.get_inference_input": [[379, 417], ["tensorflow.device", "tensorflow.data.Dataset.from_tensor_slices", "dataset.padded_batch.map", "dataset.padded_batch.map", "dataset.padded_batch.map", "dataset.padded_batch.padded_batch", "dataset.padded_batch.make_one_shot_iterator", "dataset.make_one_shot_iterator.get_next", "tensorflow.contrib.lookup.index_table_from_tensor", "tf.contrib.lookup.index_table_from_tensor.lookup", "tensorflow.constant", "tensorflow.constant", "tensorflow.concat", "len", "tensorflow.string_split", "tensorflow.Dimension", "tensorflow.shape", "tensorflow.constant"], "function", ["None"], ["", "def", "get_inference_input", "(", "inputs", ",", "params", ")", ":", "\n", "    ", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "        ", "dataset", "=", "tf", ".", "data", ".", "Dataset", ".", "from_tensor_slices", "(", "\n", "tf", ".", "constant", "(", "inputs", ")", "\n", ")", "\n", "\n", "# Split string", "\n", "dataset", "=", "dataset", ".", "map", "(", "lambda", "x", ":", "tf", ".", "string_split", "(", "[", "x", "]", ")", ".", "values", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", ")", "\n", "\n", "# Append <eos>", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "x", ":", "tf", ".", "concat", "(", "[", "x", ",", "[", "tf", ".", "constant", "(", "params", ".", "eos", ")", "]", "]", ",", "axis", "=", "0", ")", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "# Convert tuple to dictionary", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "x", ":", "{", "\"source\"", ":", "x", ",", "\"source_length\"", ":", "tf", ".", "shape", "(", "x", ")", "[", "0", "]", "}", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "dataset", "=", "dataset", ".", "padded_batch", "(", "\n", "params", ".", "decode_batch_size", "*", "len", "(", "params", ".", "device_list", ")", ",", "\n", "{", "\"source\"", ":", "[", "tf", ".", "Dimension", "(", "None", ")", "]", ",", "\"source_length\"", ":", "[", "]", "}", ",", "\n", "{", "\"source\"", ":", "params", ".", "pad", ",", "\"source_length\"", ":", "0", "}", "\n", ")", "\n", "\n", "iterator", "=", "dataset", ".", "make_one_shot_iterator", "(", ")", "\n", "features", "=", "iterator", ".", "get_next", "(", ")", "\n", "\n", "src_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"source\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "features", "[", "\"source\"", "]", "=", "src_table", ".", "lookup", "(", "features", "[", "\"source\"", "]", ")", "\n", "\n", "return", "features", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.dataset.get_relevance_input": [[419, 494], ["tensorflow.data.Dataset.from_tensor_slices", "dataset.padded_batch.map", "dataset.padded_batch.map", "dataset.padded_batch.map", "dataset.padded_batch.padded_batch", "dataset.padded_batch.make_one_shot_iterator", "dataset_o.make_one_shot_iterator.get_next", "tensorflow.contrib.lookup.index_table_from_tensor", "tf.contrib.lookup.index_table_from_tensor.lookup", "tensorflow.data.Dataset.from_tensor_slices", "dataset_o.padded_batch.map", "dataset_o.padded_batch.map", "dataset_o.padded_batch.map", "dataset_o.padded_batch.padded_batch", "dataset_o.padded_batch.make_one_shot_iterator", "dataset_o.make_one_shot_iterator.get_next", "tensorflow.contrib.lookup.index_table_from_tensor", "tf.contrib.lookup.index_table_from_tensor.lookup", "tensorflow.constant", "tensorflow.constant", "tensorflow.constant", "tensorflow.constant", "tensorflow.concat", "tensorflow.concat", "tensorflow.string_split", "tensorflow.Dimension", "tensorflow.string_split", "tensorflow.Dimension", "tensorflow.shape", "tensorflow.shape", "tensorflow.constant", "tensorflow.constant"], "function", ["None"], ["", "", "def", "get_relevance_input", "(", "inputs", ",", "outputs", ",", "params", ")", ":", "\n", "# inputs", "\n", "    ", "dataset", "=", "tf", ".", "data", ".", "Dataset", ".", "from_tensor_slices", "(", "\n", "tf", ".", "constant", "(", "inputs", ")", "\n", ")", "\n", "\n", "# Split string", "\n", "dataset", "=", "dataset", ".", "map", "(", "lambda", "x", ":", "tf", ".", "string_split", "(", "[", "x", "]", ")", ".", "values", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", ")", "\n", "\n", "# Append <eos>", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "x", ":", "tf", ".", "concat", "(", "[", "x", ",", "[", "tf", ".", "constant", "(", "params", ".", "eos", ")", "]", "]", ",", "axis", "=", "0", ")", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "# Convert tuple to dictionary", "\n", "dataset", "=", "dataset", ".", "map", "(", "\n", "lambda", "x", ":", "{", "\"source\"", ":", "x", ",", "\"source_length\"", ":", "tf", ".", "shape", "(", "x", ")", "[", "0", "]", "}", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "dataset", "=", "dataset", ".", "padded_batch", "(", "\n", "params", ".", "decode_batch_size", ",", "\n", "{", "\"source\"", ":", "[", "tf", ".", "Dimension", "(", "None", ")", "]", ",", "\"source_length\"", ":", "[", "]", "}", ",", "\n", "{", "\"source\"", ":", "params", ".", "pad", ",", "\"source_length\"", ":", "0", "}", "\n", ")", "\n", "\n", "iterator", "=", "dataset", ".", "make_one_shot_iterator", "(", ")", "\n", "features", "=", "iterator", ".", "get_next", "(", ")", "\n", "\n", "src_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"source\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"source\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "features", "[", "\"source\"", "]", "=", "src_table", ".", "lookup", "(", "features", "[", "\"source\"", "]", ")", "\n", "\n", "# outputs", "\n", "dataset_o", "=", "tf", ".", "data", ".", "Dataset", ".", "from_tensor_slices", "(", "\n", "tf", ".", "constant", "(", "outputs", ")", "\n", ")", "\n", "\n", "# Split string", "\n", "dataset_o", "=", "dataset_o", ".", "map", "(", "lambda", "x", ":", "tf", ".", "string_split", "(", "[", "x", "]", ")", ".", "values", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", ")", "\n", "\n", "# Append <eos>", "\n", "dataset_o", "=", "dataset_o", ".", "map", "(", "\n", "lambda", "x", ":", "tf", ".", "concat", "(", "[", "x", ",", "[", "tf", ".", "constant", "(", "params", ".", "eos", ")", "]", "]", ",", "axis", "=", "0", ")", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "# Convert tuple to dictionary", "\n", "dataset_o", "=", "dataset_o", ".", "map", "(", "\n", "lambda", "x", ":", "{", "\"target\"", ":", "x", ",", "\"target_length\"", ":", "tf", ".", "shape", "(", "x", ")", "[", "0", "]", "}", ",", "\n", "num_parallel_calls", "=", "params", ".", "num_threads", "\n", ")", "\n", "\n", "dataset_o", "=", "dataset_o", ".", "padded_batch", "(", "\n", "params", ".", "decode_batch_size", ",", "\n", "{", "\"target\"", ":", "[", "tf", ".", "Dimension", "(", "None", ")", "]", ",", "\"target_length\"", ":", "[", "]", "}", ",", "\n", "{", "\"target\"", ":", "params", ".", "pad", ",", "\"target_length\"", ":", "0", "}", "\n", ")", "\n", "\n", "iterator", "=", "dataset_o", ".", "make_one_shot_iterator", "(", ")", "\n", "features_o", "=", "iterator", ".", "get_next", "(", ")", "\n", "\n", "src_table", "=", "tf", ".", "contrib", ".", "lookup", ".", "index_table_from_tensor", "(", "\n", "tf", ".", "constant", "(", "params", ".", "vocabulary", "[", "\"target\"", "]", ")", ",", "\n", "default_value", "=", "params", ".", "mapping", "[", "\"target\"", "]", "[", "params", ".", "unk", "]", "\n", ")", "\n", "features", "[", "\"target\"", "]", "=", "src_table", ".", "lookup", "(", "features_o", "[", "\"target\"", "]", ")", "\n", "features", "[", "\"target_length\"", "]", "=", "features_o", "[", "\"target_length\"", "]", "\n", "\n", "return", "features", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.record.input_pipeline": [[17, 58], ["tensorflow.VarLenFeature", "tensorflow.VarLenFeature", "tensorflow.FixedLenFeature", "tensorflow.FixedLenFeature", "tensorflow.contrib.slim.tfexample_decoder.Tensor", "tensorflow.contrib.slim.tfexample_decoder.Tensor", "tensorflow.contrib.slim.tfexample_decoder.Tensor", "tensorflow.contrib.slim.tfexample_decoder.Tensor", "tensorflow.name_scope", "tensorflow.contrib.slim.parallel_reader.get_data_files", "min", "tensorflow.contrib.slim.parallel_reader.parallel_read", "tensorflow.contrib.slim.tfexample_decoder.TFExampleDecoder", "tfexample_decoder.TFExampleDecoder.decode", "zip", "len", "tensorflow.to_int32", "list", "six.iteritems"], "function", ["None"], ["def", "input_pipeline", "(", "file_pattern", ",", "mode", ",", "capacity", "=", "64", ")", ":", "\n", "    ", "keys_to_features", "=", "{", "\n", "\"source\"", ":", "tf", ".", "VarLenFeature", "(", "tf", ".", "int64", ")", ",", "\n", "\"target\"", ":", "tf", ".", "VarLenFeature", "(", "tf", ".", "int64", ")", ",", "\n", "\"source_length\"", ":", "tf", ".", "FixedLenFeature", "(", "[", "1", "]", ",", "tf", ".", "int64", ")", ",", "\n", "\"target_length\"", ":", "tf", ".", "FixedLenFeature", "(", "[", "1", "]", ",", "tf", ".", "int64", ")", "\n", "}", "\n", "\n", "items_to_handlers", "=", "{", "\n", "\"source\"", ":", "tfexample_decoder", ".", "Tensor", "(", "\"source\"", ")", ",", "\n", "\"target\"", ":", "tfexample_decoder", ".", "Tensor", "(", "\"target\"", ")", ",", "\n", "\"source_length\"", ":", "tfexample_decoder", ".", "Tensor", "(", "\"source_length\"", ")", ",", "\n", "\"target_length\"", ":", "tfexample_decoder", ".", "Tensor", "(", "\"target_length\"", ")", "\n", "}", "\n", "\n", "# Now the non-trivial case construction.", "\n", "with", "tf", ".", "name_scope", "(", "\"examples_queue\"", ")", ":", "\n", "        ", "training", "=", "(", "mode", "==", "\"train\"", ")", "\n", "# Read serialized examples using slim parallel_reader.", "\n", "num_epochs", "=", "None", "if", "training", "else", "1", "\n", "data_files", "=", "parallel_reader", ".", "get_data_files", "(", "file_pattern", ")", "\n", "num_readers", "=", "min", "(", "4", "if", "training", "else", "1", ",", "len", "(", "data_files", ")", ")", "\n", "_", ",", "examples", "=", "parallel_reader", ".", "parallel_read", "(", "[", "file_pattern", "]", ",", "\n", "tf", ".", "TFRecordReader", ",", "\n", "num_epochs", "=", "num_epochs", ",", "\n", "shuffle", "=", "training", ",", "\n", "capacity", "=", "2", "*", "capacity", ",", "\n", "min_after_dequeue", "=", "capacity", ",", "\n", "num_readers", "=", "num_readers", ")", "\n", "\n", "decoder", "=", "tfexample_decoder", ".", "TFExampleDecoder", "(", "keys_to_features", ",", "\n", "items_to_handlers", ")", "\n", "\n", "decoded", "=", "decoder", ".", "decode", "(", "examples", ",", "items", "=", "list", "(", "items_to_handlers", ")", ")", "\n", "examples", "=", "{", "}", "\n", "\n", "for", "(", "field", ",", "tensor", ")", "in", "zip", "(", "keys_to_features", ",", "decoded", ")", ":", "\n", "            ", "examples", "[", "field", "]", "=", "tensor", "\n", "\n", "# We do not want int64s as they do are not supported on GPUs.", "\n", "", "return", "{", "k", ":", "tf", ".", "to_int32", "(", "v", ")", "for", "(", "k", ",", "v", ")", "in", "six", ".", "iteritems", "(", "examples", ")", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.record.batch_examples": [[60, 107], ["tensorflow.name_scope", "examples.values", "tensorflow.contrib.training.bucket_by_sequence_length", "boundaries.append", "tensorflow.maximum", "max", "max", "tensorflow.shape", "int", "math.log"], "function", ["None"], ["", "", "def", "batch_examples", "(", "examples", ",", "batch_size", ",", "max_length", ",", "mantissa_bits", ",", "\n", "shard_multiplier", "=", "1", ",", "length_multiplier", "=", "1", ",", "scheme", "=", "\"token\"", ",", "\n", "drop_long_sequences", "=", "True", ")", ":", "\n", "    ", "with", "tf", ".", "name_scope", "(", "\"batch_examples\"", ")", ":", "\n", "        ", "max_length", "=", "max_length", "or", "batch_size", "\n", "min_length", "=", "8", "\n", "mantissa_bits", "=", "mantissa_bits", "\n", "\n", "# compute boundaries", "\n", "x", "=", "min_length", "\n", "boundaries", "=", "[", "]", "\n", "\n", "while", "x", "<", "max_length", ":", "\n", "            ", "boundaries", ".", "append", "(", "x", ")", "\n", "x", "+=", "2", "**", "max", "(", "0", ",", "int", "(", "math", ".", "log", "(", "x", ",", "2", ")", ")", "-", "mantissa_bits", ")", "\n", "\n", "", "if", "scheme", "is", "\"token\"", ":", "\n", "            ", "batch_sizes", "=", "[", "max", "(", "1", ",", "batch_size", "//", "length", ")", "\n", "for", "length", "in", "boundaries", "+", "[", "max_length", "]", "]", "\n", "batch_sizes", "=", "[", "b", "*", "shard_multiplier", "for", "b", "in", "batch_sizes", "]", "\n", "bucket_capacities", "=", "[", "2", "*", "b", "for", "b", "in", "batch_sizes", "]", "\n", "", "else", ":", "\n", "            ", "batch_sizes", "=", "batch_size", "*", "shard_multiplier", "\n", "bucket_capacities", "=", "[", "2", "*", "n", "for", "n", "in", "boundaries", "+", "[", "max_length", "]", "]", "\n", "\n", "", "max_length", "*=", "length_multiplier", "\n", "boundaries", "=", "[", "boundary", "*", "length_multiplier", "for", "boundary", "in", "boundaries", "]", "\n", "max_length", "=", "max_length", "if", "drop_long_sequences", "else", "10", "**", "9", "\n", "\n", "# The queue to bucket on will be chosen based on maximum length.", "\n", "max_example_length", "=", "0", "\n", "for", "v", "in", "examples", ".", "values", "(", ")", ":", "\n", "            ", "seq_length", "=", "tf", ".", "shape", "(", "v", ")", "[", "0", "]", "\n", "max_example_length", "=", "tf", ".", "maximum", "(", "max_example_length", ",", "seq_length", ")", "\n", "\n", "", "(", "_", ",", "outputs", ")", "=", "tf", ".", "contrib", ".", "training", ".", "bucket_by_sequence_length", "(", "\n", "max_example_length", ",", "\n", "examples", ",", "\n", "batch_sizes", ",", "\n", "[", "b", "+", "1", "for", "b", "in", "boundaries", "]", ",", "\n", "capacity", "=", "2", ",", "\n", "bucket_capacities", "=", "bucket_capacities", ",", "\n", "dynamic_pad", "=", "True", ",", "\n", "keep_input", "=", "(", "max_example_length", "<=", "max_length", ")", "\n", ")", "\n", "\n", "", "return", "outputs", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.record.get_input_features": [[109, 143], ["tensorflow.name_scope", "tensorflow.device", "record.input_pipeline", "record.batch_examples", "tensorflow.squeeze", "tensorflow.squeeze", "len"], "function", ["home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.record.input_pipeline", "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.record.batch_examples"], ["", "def", "get_input_features", "(", "file_patterns", ",", "mode", ",", "params", ")", ":", "\n", "    ", "with", "tf", ".", "name_scope", "(", "\"input_queues\"", ")", ":", "\n", "        ", "with", "tf", ".", "device", "(", "\"/cpu:0\"", ")", ":", "\n", "            ", "if", "mode", "!=", "\"train\"", ":", "\n", "                ", "num_datashards", "=", "1", "\n", "batch_size", "=", "params", ".", "eval_batch_size", "\n", "", "else", ":", "\n", "                ", "num_datashards", "=", "len", "(", "params", ".", "device_list", ")", "\n", "batch_size", "=", "params", ".", "batch_size", "\n", "\n", "", "batch_size_multiplier", "=", "1", "\n", "capacity", "=", "64", "*", "num_datashards", "\n", "examples", "=", "input_pipeline", "(", "file_patterns", ",", "mode", ",", "capacity", ")", "\n", "drop_long_sequences", "=", "(", "mode", "==", "\"train\"", ")", "\n", "\n", "feature_map", "=", "batch_examples", "(", "\n", "examples", ",", "\n", "batch_size", ",", "\n", "params", ".", "max_length", ",", "\n", "params", ".", "mantissa_bits", ",", "\n", "num_datashards", ",", "\n", "batch_size_multiplier", ",", "\n", "\"token\"", "if", "not", "params", ".", "constant_batch_size", "else", "\"constant\"", ",", "\n", "drop_long_sequences", "\n", ")", "\n", "\n", "", "features", "=", "{", "\n", "\"source\"", ":", "feature_map", "[", "\"source\"", "]", ",", "\n", "\"target\"", ":", "feature_map", "[", "\"target\"", "]", ",", "\n", "\"source_length\"", ":", "tf", ".", "squeeze", "(", "feature_map", "[", "\"source_length\"", "]", ",", "axis", "=", "1", ")", ",", "\n", "\"target_length\"", ":", "tf", ".", "squeeze", "(", "feature_map", "[", "\"target_length\"", "]", ",", "axis", "=", "1", ")", "\n", "}", "\n", "\n", "", "return", "features", "\n", "", ""]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.load_vocabulary": [[11, 19], ["tensorflow.gfile.GFile", "line.strip", "vocab.append"], "function", ["None"], ["def", "load_vocabulary", "(", "filename", ")", ":", "\n", "    ", "vocab", "=", "[", "]", "\n", "with", "tf", ".", "gfile", ".", "GFile", "(", "filename", ")", "as", "fd", ":", "\n", "        ", "for", "line", "in", "fd", ":", "\n", "            ", "word", "=", "line", ".", "strip", "(", ")", "\n", "vocab", ".", "append", "(", "word", ")", "\n", "\n", "", "", "return", "vocab", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.process_vocabulary": [[21, 26], ["vocab.append"], "function", ["None"], ["", "def", "process_vocabulary", "(", "vocab", ",", "params", ")", ":", "\n", "    ", "if", "params", ".", "append_eos", ":", "\n", "        ", "vocab", ".", "append", "(", "params", ".", "eos", ")", "\n", "\n", "", "return", "vocab", "\n", "\n"]], "home.repos.pwc.inspect_result.THUNLP-MT_UCE4BT.data.vocab.get_control_mapping": [[28, 37], ["enumerate", "symbol.decode", "token.decode"], "function", ["None"], ["", "def", "get_control_mapping", "(", "vocab", ",", "symbols", ")", ":", "\n", "    ", "mapping", "=", "{", "}", "\n", "\n", "for", "i", ",", "token", "in", "enumerate", "(", "vocab", ")", ":", "\n", "        ", "for", "symbol", "in", "symbols", ":", "\n", "            ", "if", "symbol", ".", "decode", "(", "\"utf-8\"", ")", "==", "token", ".", "decode", "(", "\"utf-8\"", ")", ":", "\n", "                ", "mapping", "[", "symbol", "]", "=", "i", "\n", "\n", "", "", "", "return", "mapping", "\n", "", ""]]}