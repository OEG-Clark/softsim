{"home.repos.pwc.inspect_result.zyr17_unilight.None.main.main_wrapper": [[12, 79], ["vars", "utils.log.loginit", "utils.log.log", "time.sleep", "main.main_wrapper.cleancheck"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.log.loginit", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log"], ["def", "main_wrapper", "(", "args", ")", ":", "\n", "    ", "args", "=", "vars", "(", "parse_args", "(", "args", ")", ")", "\n", "args", "=", "loginit", "(", "args", ")", "\n", "log", "(", "args", ",", "level", "=", "'ALL'", ")", "\n", "M", "=", "args", "[", "'main'", "]", "\n", "\n", "def", "cleancheck", "(", "args", ")", ":", "\n", "        ", "clean_flag", "=", "False", "\n", "if", "args", "[", "'clean_logs'", "]", ":", "\n", "            ", "clean_flag", "=", "True", "\n", "if", "not", "args", "[", "'force_clean'", "]", ":", "\n", "                ", "log", "(", "'run over, try to clean log folder `%s`. are you sure to '", "\n", "'clean? if not, press Ctrl+C'", "%", "args", "[", "'log_folder'", "]", ")", "\n", "try", ":", "\n", "                    ", "input", "(", ")", "\n", "", "except", "KeyboardInterrupt", ":", "\n", "                    ", "clean_flag", "=", "False", "\n", "", "except", "EOFError", ":", "\n", "                    ", "log", "(", "'got EOF, stop cleaning'", ",", "level", "=", "'WARN'", ")", "\n", "clean_flag", "=", "False", "\n", "", "", "", "lf", "=", "os", ".", "path", ".", "split", "(", "args", "[", "'log_folder'", "]", ")", "\n", "if", "len", "(", "lf", "[", "1", "]", ")", "==", "0", ":", "# last folder name not split", "\n", "            ", "lf", "=", "os", ".", "path", ".", "split", "(", "lf", "[", "0", "]", ")", "\n", "", "assert", "len", "(", "lf", "[", "1", "]", ")", "!=", "0", "\n", "lf", "=", "lf", "[", "1", "]", "\n", "os", ".", "makedirs", "(", "'./results/cleaned'", ",", "exist_ok", "=", "True", ")", "\n", "srcfile", "=", "'%s/main.log'", "%", "args", "[", "'log_folder'", "]", "\n", "destfile", "=", "'./results/%s%s_%s.log'", "%", "(", "\n", "'cleaned/'", "if", "clean_flag", "else", "''", ",", "\n", "lf", ",", "\n", "socket", ".", "gethostname", "(", ")", "\n", ")", "\n", "open", "(", "destfile", ",", "'w'", ")", ".", "write", "(", "open", "(", "srcfile", ")", ".", "read", "(", ")", ")", "\n", "if", "clean_flag", ":", "\n", "            ", "logexit", "(", ")", "\n", "if", "'linux'", "in", "sys", ".", "platform", ":", "\n", "                ", "os", ".", "system", "(", "'rm -r %s'", "%", "args", "[", "'log_folder'", "]", ")", "\n", "", "else", ":", "\n", "                ", "print", "(", "'[ERROR] not in linux, cannot remove log folder! please '", "\n", "'remove it manually.'", ")", "\n", "\n", "", "", "", "try", ":", "\n", "        ", "if", "M", ".", "lower", "(", ")", "==", "'dqn'", ":", "\n", "            ", "main", "=", "DQNMain", "(", "**", "args", ")", "\n", "", "elif", "M", ".", "lower", "(", ")", "==", "'determined'", ":", "\n", "            ", "main", "=", "DeterminedMain", "(", "**", "args", ")", "\n", "", "elif", "M", "in", "globals", "(", ")", ":", "\n", "            ", "main", "=", "globals", "(", ")", "[", "M", "]", "(", "**", "args", ")", "\n", "", "else", ":", "\n", "            ", "M", "=", "M", "+", "'Main'", "\n", "if", "M", "in", "globals", "(", ")", ":", "\n", "                ", "main", "=", "globals", "(", ")", "[", "M", "]", "(", "**", "args", ")", "\n", "", "else", ":", "\n", "                ", "raise", "NotImplementedError", "(", "'unknown main '", "+", "M", "[", ":", "-", "4", "]", ")", "\n", "", "", "main", ".", "main", "(", ")", "\n", "", "except", "(", "Exception", ",", "KeyboardInterrupt", ")", "as", "e", ":", "\n", "        ", "try", ":", "\n", "            ", "del", "main", "\n", "", "except", "Exception", ":", "\n", "            ", "pass", "\n", "", "time", ".", "sleep", "(", "0.3", ")", "\n", "log", "(", "'some error cooured! will show below.'", ",", "level", "=", "'ERROR'", ")", "\n", "cleancheck", "(", "args", ")", "\n", "raise", "e", "\n", "", "del", "main", "\n", "time", ".", "sleep", "(", "0.3", ")", "\n", "cleancheck", "(", "args", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.combine_include": [[12, 22], ["full.update", "arguments.combine_include", "full.update"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.combine_include"], ["def", "combine_include", "(", "d", ")", ":", "\n", "    ", "if", "'includes'", "in", "d", ":", "\n", "        ", "full", "=", "{", "}", "\n", "for", "i", "in", "d", "[", "'includes'", "]", ":", "\n", "            ", "i", "=", "combine_include", "(", "i", ")", "\n", "full", ".", "update", "(", "i", ")", "\n", "", "del", "d", "[", "'includes'", "]", "\n", "full", ".", "update", "(", "d", ")", "\n", "d", "=", "full", "\n", "", "return", "d", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.parse_cityflow_config": [[24, 71], ["yaml.load", "arguments.combine_include", "utils.utils.parse_roadnet", "open().read", "ValueError", "len", "print", "ValueError", "mconfigs.split", "open", "print", "config.split", "keys.split.split", "node.keys", "isinstance", "type", "value.lower"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.combine_include", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.parse_roadnet"], ["", "def", "parse_cityflow_config", "(", "args", ",", "configname", ",", "simulate_time_changable", "=", "False", ",", "\n", "cityflow_config_modify", "=", "''", ")", ":", "\n", "    ", "cf_conf", "=", "yaml", ".", "load", "(", "open", "(", "configname", ")", ".", "read", "(", ")", ",", "yaml", ".", "FullLoader", ")", "\n", "cf_conf", "=", "combine_include", "(", "cf_conf", ")", "\n", "cf_conf", "[", "'ROADNET_INFO'", "]", ",", "cf_conf", "[", "'VIRTUAL_INTERSECTION_NAMES'", "]", "=", "parse_roadnet", "(", "cf_conf", "[", "'ROADNET_FILE'", "]", ")", "\n", "# cf_conf['EPISODE_LEN'] = args.simulate_time * cf_conf['MIN_ACTION_TIME']", "\n", "if", "cf_conf", "[", "'EPISODE_LEN'", "]", "%", "cf_conf", "[", "'MIN_ACTION_TIME'", "]", "!=", "0", ":", "\n", "        ", "raise", "ValueError", "(", "'in cityflow config: EPISODE_LEN(%d) should be '", "\n", "'fully divided by MIN_ACTION_TIME(%d)'", "\n", "%", "(", "cf_conf", "[", "'EPISODE_LEN'", "]", ",", "\n", "cf_conf", "[", "'MIN_ACTION_TIME'", "]", ")", ")", "\n", "", "stcal", "=", "cf_conf", "[", "'EPISODE_LEN'", "]", "//", "cf_conf", "[", "'MIN_ACTION_TIME'", "]", "\n", "if", "args", ".", "simulate_time", "is", "None", "or", "args", ".", "simulate_time", "!=", "stcal", ":", "\n", "        ", "if", "simulate_time_changable", ":", "\n", "            ", "if", "args", ".", "simulate_time", "is", "not", "None", ":", "\n", "                ", "print", "(", "'[WARN ] simulate-time is set (%d), but will be '", "\n", "'replaced by %d calculated from cityflow config.'", "\n", "%", "(", "args", ".", "simulate_time", ",", "stcal", ")", ")", "\n", "", "args", ".", "simulate_time", "=", "stcal", "\n", "", "else", ":", "\n", "            ", "print", "(", "args", ".", "simulate_time", ",", "stcal", ")", "\n", "raise", "ValueError", "(", "'in cityflow config: simulate-time isn\\'t None, '", "\n", "'and is not same in cityflow config: %s'", "\n", "%", "configname", ")", "\n", "", "", "cf_conf", "[", "'CONFIG_FILE'", "]", "=", "configname", "\n", "\n", "if", "len", "(", "cityflow_config_modify", ")", ">", "0", ":", "\n", "# modify config", "\n", "        ", "for", "mconfigs", "in", "cityflow_config_modify", ":", "\n", "            ", "for", "config", "in", "mconfigs", ".", "split", "(", "';'", ")", ":", "\n", "                ", "keys", ",", "value", "=", "config", ".", "split", "(", "'='", ")", "\n", "keys", "=", "keys", ".", "split", "(", "':'", ")", "\n", "node", "=", "cf_conf", "\n", "for", "key", "in", "keys", "[", ":", "-", "1", "]", ":", "\n", "                    ", "node", "=", "node", "[", "key", "]", "\n", "", "if", "keys", "[", "-", "1", "]", "in", "node", ".", "keys", "(", ")", ":", "\n", "# for bool type, do specially", "\n", "                    ", "if", "isinstance", "(", "node", "[", "keys", "[", "-", "1", "]", "]", ",", "bool", ")", ":", "\n", "                        ", "node", "[", "keys", "[", "-", "1", "]", "]", "=", "value", "!=", "'0'", "and", "value", ".", "lower", "(", ")", "!=", "'false'", "\n", "", "else", ":", "\n", "                        ", "node", "[", "keys", "[", "-", "1", "]", "]", "=", "type", "(", "node", "[", "keys", "[", "-", "1", "]", "]", ")", "(", "value", ")", "\n", "", "", "else", ":", "\n", "                    ", "node", "[", "keys", "[", "-", "1", "]", "]", "=", "value", "\n", "\n", "", "", "", "", "return", "cf_conf", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.parse_args": [[73, 228], ["argparse.ArgumentParser", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.add_argument", "argparse.ArgumentParser.parse_args", "arguments.parse_cityflow_config", "tcc.split.split", "range", "len", "confs.keys", "argparse.ArgumentParser.parse_args", "print", "len", "arguments.parse_cityflow_config", "len", "print", "yaml.load", "confs.update", "carg.append", "multiprocessing.cpu_count", "int", "open", "arguments.combine_include", "isinstance", "carg.append", "str", "time.time"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.parse_args", "home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.parse_cityflow_config", "home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.parse_args", "home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.parse_cityflow_config", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.utils.arguments.combine_include", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "parse_args", "(", "input_args", "=", "sys", ".", "argv", ")", ":", "\n", "    ", "parser", "=", "argparse", ".", "ArgumentParser", "(", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--log-folder'", ",", "type", "=", "str", ",", "default", "=", "'logs/'", ")", "\n", "parser", ".", "add_argument", "(", "'--work-folder'", ",", "type", "=", "str", ",", "default", "=", "'./'", ")", "\n", "parser", ".", "add_argument", "(", "'--model'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--wrapper-model'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "# st_default = int(1e9) + random.random()", "\n", "parser", ".", "add_argument", "(", "'--simulate-time'", ",", "type", "=", "int", ",", "default", "=", "None", ")", "\n", "parser", ".", "add_argument", "(", "'--cityflow-config'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--cityflow-config-modify'", ",", "type", "=", "str", ",", "action", "=", "'append'", ",", "\n", "default", "=", "[", "]", ",", "help", "=", "'change cityflow configs manually, '", "\n", "'write as `key1:subkey1=val1;key2=val2`. support '", "\n", "'calling multiple times.'", ")", "\n", "parser", ".", "add_argument", "(", "'--cityflow-log'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--preload-model-file'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--test-round'", ",", "type", "=", "int", ",", "default", "=", "0", ",", "help", "=", "\n", "'when set positive integer, start evaluate mode and '", "\n", "'show result.'", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--dqn-split-model'", ",", "action", "=", "'store_true'", ",", "\n", "default", "=", "False", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--sotl-green-threshold'", ",", "type", "=", "int", ",", "default", "=", "3", ")", "\n", "parser", ".", "add_argument", "(", "'--sotl-red-threshold'", ",", "type", "=", "int", ",", "default", "=", "6", ")", "\n", "parser", ".", "add_argument", "(", "'--sotl-min-switch'", ",", "type", "=", "int", ",", "default", "=", "10", ")", "\n", "parser", ".", "add_argument", "(", "'--sotl-max-switch'", ",", "type", "=", "int", ",", "default", "=", "30", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--fixed-time'", ",", "type", "=", "float", ",", "default", "=", "30", ")", "\n", "parser", ".", "add_argument", "(", "'-rm'", ",", "'--clean-logs'", ",", "action", "=", "'store_true'", ",", "\n", "default", "=", "False", ")", "\n", "parser", ".", "add_argument", "(", "'-rmf'", ",", "'--force-clean'", ",", "action", "=", "'store_true'", ",", "\n", "default", "=", "False", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--NM-lane-embedding-size'", ",", "type", "=", "int", ",", "default", "=", "32", ")", "\n", "parser", ".", "add_argument", "(", "'--NM-road-predict-hidden'", ",", "type", "=", "int", ",", "default", "=", "32", ")", "\n", "parser", ".", "add_argument", "(", "'--NM-scale-by-lane-number'", ",", "action", "=", "'store_true'", ",", "\n", "default", "=", "False", ")", "\n", "parser", ".", "add_argument", "(", "'--NM-phase-loss-weight'", ",", "type", "=", "float", ",", "default", "=", "0", ")", "\n", "parser", ".", "add_argument", "(", "'--NM-volume-loss-weight'", ",", "type", "=", "float", ",", "default", "=", "0", ")", "\n", "parser", ".", "add_argument", "(", "'--NM-phase-loss-with-replay'", ",", "action", "=", "'store_true'", ",", "\n", "default", "=", "False", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--CM-selected-inner'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--gammas'", ",", "type", "=", "str", ",", "default", "=", "'0.99'", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--multi-agent'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "\n", "parser", ".", "add_argument", "(", "'--enable-wandb'", ",", "action", "=", "'store_true'", ",", "default", "=", "False", ")", "\n", "parser", ".", "add_argument", "(", "'--wandb-entity-name'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--wandb-api-key'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--wandb-project-name'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'--wandb-sync-mode'", ",", "type", "=", "str", ",", "default", "=", "'online'", ")", "\n", "\n", "# common args", "\n", "parser", ".", "add_argument", "(", "'-m'", ",", "'--main'", ",", "type", "=", "str", ")", "\n", "parser", ".", "add_argument", "(", "'-a'", ",", "'--agent'", ",", "type", "=", "str", ")", "\n", "parser", ".", "add_argument", "(", "'--env'", ",", "type", "=", "str", ",", "default", "=", "'PongNoFrameskip-v4'", ")", "\n", "parser", ".", "add_argument", "(", "'-lr'", ",", "'--learning-rate'", ",", "type", "=", "float", ",", "default", "=", "1e-4", ")", "\n", "parser", ".", "add_argument", "(", "'-n'", ",", "'--n-frames'", ",", "type", "=", "int", ",", "default", "=", "1000000", ")", "\n", "parser", ".", "add_argument", "(", "'-t'", ",", "'--target-reward'", ",", "type", "=", "float", ",", "default", "=", "1e100", ")", "\n", "parser", ".", "add_argument", "(", "'-tx'", ",", "'--tensorboardx-comment'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'-s'", ",", "'--model-save-path'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'-si'", ",", "'--save-interval'", ",", "type", "=", "int", ",", "default", "=", "0", ")", "\n", "parser", ".", "add_argument", "(", "'--gamma'", ",", "type", "=", "float", ",", "default", "=", "0.99", ")", "\n", "parser", ".", "add_argument", "(", "'--threads'", ",", "type", "=", "int", ",", "default", "=", "-", "1", ")", "\n", "parser", ".", "add_argument", "(", "'-r'", ",", "'--render-steps'", ",", "type", "=", "int", ",", "default", "=", "-", "1", ")", "\n", "parser", ".", "add_argument", "(", "'--seed'", ",", "type", "=", "int", ",", "default", "=", "-", "1", ")", "\n", "parser", ".", "add_argument", "(", "'-li'", ",", "'--log-interval'", ",", "type", "=", "int", ",", "default", "=", "100", ")", "\n", "parser", ".", "add_argument", "(", "'--no-cuda'", ",", "action", "=", "'store_true'", ",", "default", "=", "False", ")", "\n", "parser", ".", "add_argument", "(", "'-c'", ",", "'--config'", ",", "type", "=", "str", ",", "action", "=", "'append'", ",", "\n", "default", "=", "[", "]", ")", "\n", "parser", ".", "add_argument", "(", "'--n-steps'", ",", "type", "=", "int", ",", "default", "=", "5", ")", "\n", "parser", ".", "add_argument", "(", "'--evaluate-round'", ",", "type", "=", "int", ",", "default", "=", "10", ")", "\n", "parser", ".", "add_argument", "(", "'--evaluate-interval'", ",", "type", "=", "int", ",", "default", "=", "10", ")", "\n", "parser", ".", "add_argument", "(", "'--feature-hidden-size'", ",", "type", "=", "int", ",", "default", "=", "512", ")", "\n", "parser", ".", "add_argument", "(", "'-g'", ",", "'--gpu-to-use'", ",", "type", "=", "str", ",", "default", "=", "''", ")", "\n", "parser", ".", "add_argument", "(", "'-dev'", ",", "'--development'", ",", "action", "=", "'store_true'", ",", "\n", "default", "=", "False", ")", "\n", "\n", "# DQN args", "\n", "parser", ".", "add_argument", "(", "'-Dr'", ",", "'--dqn-replay-size'", ",", "type", "=", "int", ",", "default", "=", "10000", ")", "\n", "parser", ".", "add_argument", "(", "'-Db'", ",", "'--dqn-batch-size'", ",", "type", "=", "int", ",", "default", "=", "128", ")", "\n", "parser", ".", "add_argument", "(", "'-Dei'", ",", "'--dqn-initial-eps'", ",", "type", "=", "float", ",", "default", "=", "1.0", ")", "\n", "parser", ".", "add_argument", "(", "'-Def'", ",", "'--dqn-final-eps'", ",", "type", "=", "float", ",", "default", "=", "0.02", ")", "\n", "parser", ".", "add_argument", "(", "'-Del'", ",", "'--dqn-explore-len-frac'", ",", "type", "=", "float", ",", "\n", "default", "=", "0.1", ")", "\n", "parser", ".", "add_argument", "(", "'-Dn'", ",", "'--dqn-n-steps'", ",", "type", "=", "int", ",", "default", "=", "1", ")", "\n", "parser", ".", "add_argument", "(", "'-Du'", ",", "'--dqn-net-update-freq'", ",", "type", "=", "int", ",", "default", "=", "1000", ")", "\n", "parser", ".", "add_argument", "(", "'-Dh'", ",", "'--dqn-hidden-size'", ",", "type", "=", "int", ",", "default", "=", "512", ")", "\n", "parser", ".", "add_argument", "(", "'-DDo'", ",", "'--double-dqn'", ",", "action", "=", "'store_true'", ",", "\n", "default", "=", "False", ")", "\n", "parser", ".", "add_argument", "(", "'-DDu'", ",", "'--dueling-dqn'", ",", "action", "=", "'store_true'", ",", "\n", "default", "=", "False", ")", "\n", "\n", "args", "=", "parser", ".", "parse_args", "(", "input_args", "[", "1", ":", "]", ")", "\n", "\n", "# if config file is set, read it and parse it before cmd arguments", "\n", "if", "len", "(", "args", ".", "config", ")", ">", "0", ":", "\n", "        ", "confs", "=", "{", "}", "\n", "for", "config", "in", "args", ".", "config", ":", "\n", "            ", "one_conf", "=", "yaml", ".", "load", "(", "open", "(", "config", ")", ",", "Loader", "=", "yaml", ".", "FullLoader", ")", "\n", "confs", ".", "update", "(", "combine_include", "(", "one_conf", ")", ")", "\n", "", "carg", "=", "[", "]", "\n", "for", "conf", "in", "confs", ".", "keys", "(", ")", ":", "\n", "            ", "carg", ".", "append", "(", "'--'", "+", "conf", ")", "\n", "if", "not", "isinstance", "(", "confs", "[", "conf", "]", ",", "bool", ")", ":", "\n", "                ", "carg", ".", "append", "(", "str", "(", "confs", "[", "conf", "]", ")", ")", "\n", "", "else", ":", "\n", "                ", "if", "not", "confs", "[", "conf", "]", ":", "\n", "                    ", "carg", "=", "carg", "[", ":", "-", "1", "]", "\n", "# print('config:', carg, confs, carg + sys.argv[1:])", "\n", "", "", "", "args", "=", "parser", ".", "parse_args", "(", "carg", "+", "input_args", "[", "1", ":", "]", ")", "\n", "\n", "# if thread number not set, use half cpus", "\n", "", "if", "args", ".", "threads", "==", "-", "1", ":", "\n", "        ", "cpu_count", "=", "multiprocessing", ".", "cpu_count", "(", ")", "//", "2", "\n", "if", "cpu_count", "<", "1", ":", "\n", "            ", "cpu_count", "=", "1", "\n", "", "args", ".", "threads", "=", "cpu_count", "\n", "print", "(", "'threads unset, auto use %d threads'", "%", "args", ".", "threads", ")", "\n", "\n", "", "if", "args", ".", "seed", "==", "-", "1", ":", "\n", "        ", "args", ".", "seed", "=", "int", "(", "time", ".", "time", "(", ")", "*", "1000000000", ")", "%", "(", "2", "**", "31", ")", "\n", "\n", "", "if", "args", ".", "tensorboardx_comment", "==", "'-'", ":", "\n", "        ", "args", ".", "tensorboardx_comment", "=", "''", "\n", "\n", "# CityFlow args processing", "\n", "", "tcc", "=", "args", ".", "cityflow_config", "\n", "args", ".", "cityflow_config", "=", "parse_cityflow_config", "(", "args", ",", "args", ".", "cityflow_config", ",", "\n", "True", ",", "\n", "args", ".", "cityflow_config_modify", ")", "\n", "tcc", "=", "tcc", ".", "split", "(", "','", ")", "\n", "for", "i", "in", "range", "(", "len", "(", "tcc", ")", ")", ":", "\n", "        ", "tcc", "[", "i", "]", "=", "parse_cityflow_config", "(", "\n", "args", ",", "\n", "tcc", "[", "i", "]", ",", "\n", "cityflow_config_modify", "=", "args", ".", "cityflow_config_modify", "\n", ")", "\n", "", "while", "args", ".", "threads", ">", "len", "(", "tcc", ")", ":", "\n", "        ", "tcc", "+=", "tcc", "\n", "", "tcc", "=", "tcc", "[", ":", "args", ".", "threads", "]", "\n", "args", ".", "train_cityflow_config", "=", "tcc", "\n", "\n", "if", "args", ".", "force_clean", ":", "\n", "        ", "args", ".", "clean_logs", "=", "True", "\n", "args", ".", "tensorboardx_comment", "=", "''", "\n", "\n", "", "if", "args", ".", "gpu_to_use", "!=", "''", ":", "\n", "        ", "os", ".", "environ", "[", "\"CUDA_VISIBLE_DEVICES\"", "]", "=", "args", ".", "gpu_to_use", "\n", "print", "(", "'[INFO ] CUDA_VISIBLE_DEVICES is set to'", ",", "args", ".", "gpu_to_use", ")", "\n", "\n", "", "return", "args", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.Logger.__init__": [[22, 25], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ")", ":", "\n", "        ", "self", ".", "print_level", "=", "[", "'ERROR'", ",", "'WARN'", ",", "'INFO'", "]", "\n", "self", ".", "log_folder", "=", "''", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.Logger.init": [[26, 80], ["kwargs.copy", "os.makedirs", "open", "log.Logger.log", "log.Logger.log", "log.Logger.log", "log.Logger.log", "os.makedirs", "[].strip", "socket.gethostname", "len", "os.mkdir", "open().read", "open().write", "log.gettime", "open", "f.write", "open", "f.write", "open", "f.write", "open", "open", "open().read", "open().read", "os.popen().readlines", "open().read", "open", "open", "os.popen", "os.path.split", "open"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.gettime"], ["", "def", "init", "(", "self", ",", "kwargs", ")", ":", "\n", "        ", "args", "=", "kwargs", ".", "copy", "(", ")", "\n", "self", ".", "log_folder", "=", "(", "kwargs", "[", "'work_folder'", "]", "+", "'/'", "\n", "+", "kwargs", "[", "'log_folder'", "]", "+", "'/'", ")", "\n", "if", "kwargs", "[", "'work_folder'", "]", "==", "''", "or", "kwargs", "[", "'log_folder'", "]", "==", "''", ":", "\n", "            ", "self", ".", "log_folder", "=", "''", "\n", "return", "kwargs", "\n", "\n", "", "subfolder", "=", "'_'", ".", "join", "(", "[", "gettime", "(", ")", ",", "\n", "# kwargs['env'], ", "\n", "kwargs", "[", "'multi_agent'", "]", ",", "\n", "kwargs", "[", "'agent'", "]", ",", "\n", "kwargs", "[", "'model'", "]", ",", "\n", "kwargs", "[", "'tensorboardx_comment'", "]", "]", ")", "\n", "self", ".", "log_folder", "+=", "subfolder", "+", "'/'", "\n", "kwargs", "[", "'log_folder'", "]", "=", "self", ".", "log_folder", "\n", "\n", "os", ".", "makedirs", "(", "self", ".", "log_folder", ")", "\n", "self", ".", "main_log", "=", "open", "(", "self", ".", "log_folder", "+", "'main.log'", ",", "'w'", ")", "\n", "\n", "gitdata", "=", "'unknown'", "\n", "try", ":", "\n", "            ", "gitdata", "=", "os", ".", "popen", "(", "\n", "'git log --pretty=oneline -n 1'", ")", ".", "readlines", "(", ")", "[", "0", "]", ".", "strip", "(", ")", "\n", "", "except", "Exception", ":", "\n", "            ", "pass", "\n", "\n", "", "self", ".", "log", "(", "'host name:'", ",", "socket", ".", "gethostname", "(", ")", ",", "level", "=", "'TRACE'", ")", "\n", "self", ".", "log", "(", "'log folder:'", ",", "self", ".", "log_folder", ",", "level", "=", "'INFO'", ")", "\n", "self", ".", "log", "(", "'GIT STATUS: '", "+", "gitdata", ",", "level", "=", "'INFO'", ")", "\n", "self", ".", "log", "(", "'command:'", ",", "sys", ".", "argv", ",", "level", "=", "'INFO'", ")", "\n", "\n", "# save used files", "\n", "inf", "=", "self", ".", "log_folder", "+", "'input_files/'", "\n", "os", ".", "makedirs", "(", "inf", ")", "\n", "if", "len", "(", "kwargs", "[", "'config'", "]", ")", ">", "0", ":", "\n", "            ", "conf", "=", "inf", "+", "'configs/'", "\n", "os", ".", "mkdir", "(", "conf", ")", "\n", "for", "config", "in", "kwargs", "[", "'config'", "]", ":", "\n", "                ", "with", "open", "(", "conf", "+", "os", ".", "path", ".", "split", "(", "config", ")", "[", "1", "]", ",", "'w'", ")", "as", "f", ":", "\n", "                    ", "f", ".", "write", "(", "open", "(", "config", ")", ".", "read", "(", ")", ")", "\n", "\n", "", "", "", "if", "kwargs", "[", "'cityflow_config'", "]", "!=", "''", ":", "\n", "            ", "cf_config", "=", "open", "(", "kwargs", "[", "'cityflow_config'", "]", "[", "'CONFIG_FILE'", "]", ")", ".", "read", "(", ")", "\n", "open", "(", "inf", "+", "'cityflow-config.yml'", ",", "'w'", ")", ".", "write", "(", "cf_config", ")", "\n", "cf_config", "=", "kwargs", "[", "'cityflow_config'", "]", "\n", "with", "open", "(", "inf", "+", "'flow.json'", ",", "'w'", ")", "as", "f", ":", "\n", "                ", "f", ".", "write", "(", "open", "(", "kwargs", "[", "'work_folder'", "]", "\n", "+", "cf_config", "[", "'FLOW_FILE'", "]", ")", ".", "read", "(", ")", ")", "\n", "", "with", "open", "(", "inf", "+", "'roadnet.json'", ",", "'w'", ")", "as", "f", ":", "\n", "                ", "f", ".", "write", "(", "open", "(", "kwargs", "[", "'work_folder'", "]", "\n", "+", "cf_config", "[", "'ROADNET_FILE'", "]", ")", ".", "read", "(", ")", ")", "\n", "\n", "", "", "return", "kwargs", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.Logger.log": [[81, 95], ["time.asctime", "len", "print", "time.localtime", "log.get_call_func", "log.Logger.main_log.write", "log.Logger.main_log.write", "log.Logger.main_log.flush", "str", "sys._getframe"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.log.get_call_func"], ["", "def", "log", "(", "self", ",", "*", "msg", ",", "level", ")", ":", "\n", "        ", "msg", "=", "' '", ".", "join", "(", "[", "str", "(", "x", ")", "for", "x", "in", "msg", "]", ")", "\n", "logstr", "=", "'['", "+", "level", "\n", "while", "len", "(", "logstr", ")", "<", "6", ":", "\n", "            ", "logstr", "+=", "' '", "\n", "", "logstr", "+=", "']'", "\n", "if", "level", "in", "self", ".", "print_level", ":", "\n", "            ", "print", "(", "logstr", ",", "msg", ")", "\n", "", "logstr", "+=", "time", ".", "asctime", "(", "time", ".", "localtime", "(", ")", ")", "\n", "logstr", "+=", "' | '", "+", "get_call_func", "(", "sys", ".", "_getframe", "(", ")", ".", "f_back", ")", "\n", "if", "self", ".", "log_folder", "!=", "''", ":", "\n", "            ", "self", ".", "main_log", ".", "write", "(", "logstr", "+", "'\\n'", ")", "\n", "self", ".", "main_log", ".", "write", "(", "'       '", "+", "msg", "+", "'\\n'", ")", "\n", "self", ".", "main_log", ".", "flush", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.Logger.logData": [[96, 101], ["log.Logger.log", "NotImplementedError", "log.Logger.log"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log"], ["", "", "def", "logData", "(", "self", ",", "data", ",", "filename", ")", ":", "\n", "        ", "if", "self", ".", "log_folder", "==", "''", ":", "\n", "            ", "self", ".", "log", "(", "'log folder unset!'", ",", "level", "=", "'ERROR'", ")", "\n", "", "self", ".", "log", "(", "'save file `%s`'", "%", "filename", ",", "level", "=", "'FILE'", ")", "\n", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.gettime": [[8, 11], ["time.localtime", "int", "time.time"], "function", ["None"], ["def", "gettime", "(", ")", ":", "\n", "    ", "dt", "=", "[", "'%02d'", "%", "x", "for", "x", "in", "time", ".", "localtime", "(", ")", "]", "\n", "return", "'_'", ".", "join", "(", "dt", "[", ":", "6", "]", "+", "[", "'%06d'", "%", "(", "int", "(", "time", ".", "time", "(", ")", "*", "1000000", ")", "%", "1000000", ")", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.get_call_func": [[13, 19], ["log.get_call_func", "str", "sys._getframe", "sys._getframe().f_back"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.log.get_call_func"], ["", "def", "get_call_func", "(", "frame", ")", ":", "\n", "    ", "if", "frame", ".", "f_code", ".", "co_filename", "==", "sys", ".", "_getframe", "(", ")", ".", "f_code", ".", "co_filename", ":", "\n", "        ", "return", "get_call_func", "(", "frame", ".", "f_back", ")", "\n", "", "return", "(", "frame", ".", "f_code", ".", "co_filename", "+", "':'", "\n", "+", "frame", ".", "f_code", ".", "co_name", "+", "':'", "\n", "+", "str", "(", "frame", ".", "f_code", ".", "co_firstlineno", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.loginit": [[103, 110], ["log.Logger.init", "globals", "log.Logger", "globals"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.log.Logger.init"], ["", "", "def", "loginit", "(", "kwargs", ")", ":", "\n", "    ", "if", "'_logger'", "not", "in", "globals", "(", ")", ":", "\n", "        ", "globals", "(", ")", "[", "'_logger'", "]", "=", "None", "\n", "", "global", "_logger", "\n", "if", "not", "_logger", ":", "\n", "        ", "_logger", "=", "Logger", "(", ")", "\n", "", "return", "_logger", ".", "init", "(", "kwargs", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.log": [[112, 114], ["_logger.log"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log"], ["", "def", "log", "(", "*", "msg", ",", "level", "=", "'INFO'", ")", ":", "\n", "    ", "_logger", ".", "log", "(", "*", "msg", ",", "level", "=", "level", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.logdata": [[116, 118], ["_logger.logData"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.log.Logger.logData"], ["", "def", "logdata", "(", "data", ",", "filename", ")", ":", "\n", "    ", "_logger", ".", "logData", "(", "data", ",", "filename", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.log.logexit": [[120, 124], ["globals"], "function", ["None"], ["", "def", "logexit", "(", ")", ":", "\n", "    ", "if", "'_logger'", "in", "globals", "(", ")", ":", "\n", "        ", "global", "_logger", "\n", "del", "_logger", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.Fake_TXSW.__init__": [[32, 34], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ")", ":", "\n", "        ", "pass", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.Fake_TXSW.add_scalar": [[35, 37], ["None"], "methods", ["None"], ["", "def", "add_scalar", "(", "self", ",", "*", "x", ")", ":", "\n", "        ", "pass", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.Fake_TXSW.add_image": [[38, 40], ["None"], "methods", ["None"], ["", "def", "add_image", "(", "self", ",", "*", "x", ")", ":", "\n", "        ", "pass", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.Fake_TXSW.add_graph": [[41, 43], ["None"], "methods", ["None"], ["", "def", "add_graph", "(", "self", ",", "*", "x", ")", ":", "\n", "        ", "pass", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.Fake_TXSW.close": [[44, 46], ["None"], "methods", ["None"], ["", "def", "close", "(", "self", ")", ":", "\n", "        ", "pass", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.__init__": [[49, 58], ["wandb.init"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.log.Logger.init"], ["    ", "def", "__init__", "(", "self", ",", "wandb_api_key", ",", "wandb_entity_name", ",", "wandb_project_name", ",", "\n", "wandb_sync_mode", ",", "tensorboardx_comment", ",", "**", "kwargs", ")", ":", "\n", "        ", "os", ".", "environ", "[", "'WANDB_API_KEY'", "]", "=", "wandb_api_key", "\n", "wandb", ".", "init", "(", "\n", "entity", "=", "wandb_entity_name", ",", "\n", "project", "=", "wandb_project_name", ",", "\n", "mode", "=", "wandb_sync_mode", ",", "\n", "name", "=", "tensorboardx_comment", ",", "\n", "config", "=", "kwargs", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.log_one": [[60, 62], ["wandb.log"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log"], ["", "def", "log_one", "(", "self", ",", "name", ",", "data", ",", "step", ")", ":", "\n", "        ", "wandb", ".", "log", "(", "{", "name", ":", "data", "}", ",", "step", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_scalar": [[63, 65], ["utils.WanDB_TXSW.log_one"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.log_one"], ["", "def", "add_scalar", "(", "self", ",", "*", "x", ")", ":", "\n", "        ", "self", ".", "log_one", "(", "*", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_image": [[66, 68], ["utils.WanDB_TXSW.log_one"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.log_one"], ["", "def", "add_image", "(", "self", ",", "*", "x", ")", ":", "\n", "        ", "self", ".", "log_one", "(", "*", "x", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_graph": [[69, 71], ["None"], "methods", ["None"], ["", "def", "add_graph", "(", "self", ",", "*", "x", ")", ":", "\n", "        ", "raise", "NotImplementedError", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.close": [[72, 74], ["None"], "methods", ["None"], ["", "def", "close", "(", "self", ")", ":", "\n", "        ", "pass", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.cuda": [[13, 29], ["torch.cuda.is_available", "tensor.cuda"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["def", "cuda", "(", "tensor", ",", "use_cuda", "=", "None", ")", ":", "\n", "    ", "\"\"\"\n    A cuda wrapper\n    \"\"\"", "\n", "global", "last_use_cuda", "\n", "if", "use_cuda", "is", "None", ":", "\n", "        ", "use_cuda", "=", "last_use_cuda", "\n", "", "last_use_cuda", "=", "use_cuda", "\n", "if", "not", "use_cuda", ":", "\n", "        ", "return", "tensor", "\n", "", "if", "tensor", "is", "None", ":", "\n", "        ", "return", "None", "\n", "", "if", "torch", ".", "cuda", ".", "is_available", "(", ")", ":", "\n", "        ", "return", "tensor", ".", "cuda", "(", ")", "\n", "", "else", ":", "\n", "        ", "return", "tensor", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.showarray": [[76, 79], ["numpy.array", "print", "np.array.max", "np.array.min"], "function", ["None"], ["", "", "def", "showarray", "(", "arr", ")", ":", "\n", "    ", "arr", "=", "np", ".", "array", "(", "arr", ")", "\n", "print", "(", "'max: %.2f, min: %.2f'", "%", "(", "arr", ".", "max", "(", ")", ",", "arr", ".", "min", "(", ")", ")", ")", "\n", "# plt.imshow(arr)", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.set_seed": [[83, 87], ["numpy.random.seed", "torch.manual_seed", "torch.cuda.manual_seed"], "function", ["None"], ["", "def", "set_seed", "(", "seed", ")", ":", "\n", "    ", "np", ".", "random", ".", "seed", "(", "seed", ")", "\n", "torch", ".", "manual_seed", "(", "seed", ")", "\n", "torch", ".", "cuda", ".", "manual_seed", "(", "seed", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils._real_gzip_file": [[89, 94], ["os.remove", "open", "gzip.open", "shutil.copyfileobj"], "function", ["None"], ["", "def", "_real_gzip_file", "(", "filename", ")", ":", "\n", "    ", "with", "open", "(", "filename", ",", "'rb'", ")", "as", "f_in", ":", "\n", "        ", "with", "gzip", ".", "open", "(", "filename", "+", "'.gz'", ",", "'wb'", ")", "as", "f_out", ":", "\n", "            ", "shutil", ".", "copyfileobj", "(", "f_in", ",", "f_out", ")", "\n", "", "", "os", ".", "remove", "(", "filename", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.gzip_file": [[96, 99], ["utils._real_gzip_file"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.utils._real_gzip_file"], ["", "def", "gzip_file", "(", "filename", ")", ":", "\n", "# _gzip_processor(filename)", "\n", "    ", "_real_gzip_file", "(", "filename", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.floyd": [[104, 115], ["adj_mat.copy", "range", "range", "len", "range"], "function", ["None"], ["", "def", "floyd", "(", "adj_mat", ")", ":", "\n", "# input: adjacent np.array, disconnect is assigned a big number", "\n", "    ", "assert", "len", "(", "adj_mat", ".", "shape", ")", "==", "2", "and", "adj_mat", ".", "shape", "[", "0", "]", "==", "adj_mat", ".", "shape", "[", "1", "]", "\n", "n", "=", "adj_mat", ".", "shape", "[", "0", "]", "\n", "res", "=", "adj_mat", ".", "copy", "(", ")", "\n", "for", "k", "in", "range", "(", "n", ")", ":", "\n", "        ", "for", "i", "in", "range", "(", "n", ")", ":", "\n", "            ", "for", "j", "in", "range", "(", "n", ")", ":", "\n", "                ", "if", "res", "[", "i", "]", "[", "k", "]", "+", "res", "[", "k", "]", "[", "j", "]", "<", "res", "[", "i", "]", "[", "j", "]", ":", "\n", "                    ", "res", "[", "i", "]", "[", "j", "]", "=", "res", "[", "i", "]", "[", "k", "]", "+", "res", "[", "k", "]", "[", "j", "]", "\n", "", "", "", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.get_length": [[117, 124], ["zip"], "function", ["None"], ["", "def", "get_length", "(", "points", ")", ":", "\n", "    ", "res", "=", "0", "\n", "for", "p1", ",", "p2", "in", "zip", "(", "points", "[", ":", "-", "1", "]", ",", "points", "[", "1", ":", "]", ")", ":", "\n", "        ", "dx", "=", "p1", "[", "'x'", "]", "-", "p2", "[", "'x'", "]", "\n", "dy", "=", "p1", "[", "'y'", "]", "-", "p2", "[", "'y'", "]", "\n", "res", "+=", "(", "dx", "**", "2", "+", "dy", "**", "2", ")", "**", "0.5", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.parse_roadnet": [[126, 163], ["json.load", "open", "set", "len", "set.add", "detail_lanes.append", "utils.get_length", "str", "str"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.get_length"], ["", "def", "parse_roadnet", "(", "filename", ")", ":", "\n", "    ", "roadnet", "=", "json", ".", "load", "(", "open", "(", "filename", ")", ")", "\n", "inters", "=", "roadnet", "[", "'intersections'", "]", "\n", "roads", "=", "{", "}", "\n", "for", "road", "in", "roadnet", "[", "'roads'", "]", ":", "\n", "        ", "roads", "[", "road", "[", "'id'", "]", "]", "=", "road", "\n", "", "res", "=", "{", "}", "\n", "virtual_res", "=", "{", "}", "\n", "for", "inter", "in", "inters", ":", "\n", "        ", "one", "=", "{", "}", "\n", "one", "[", "'roadlinks'", "]", "=", "inter", "[", "'roadLinks'", "]", "\n", "for", "i", "in", "one", "[", "'roadlinks'", "]", ":", "\n", "            ", "lanes", "=", "set", "(", ")", "\n", "detail_lanes", "=", "[", "]", "\n", "for", "j", "in", "i", "[", "'laneLinks'", "]", ":", "\n", "                ", "lanes", ".", "add", "(", "j", "[", "'startLaneIndex'", "]", ")", "\n", "detail_lanes", ".", "append", "(", "[", "\n", "i", "[", "'startRoad'", "]", "+", "'_'", "+", "str", "(", "j", "[", "'startLaneIndex'", "]", ")", ",", "\n", "i", "[", "'endRoad'", "]", "+", "'_'", "+", "str", "(", "j", "[", "'endLaneIndex'", "]", ")", "\n", "]", ")", "\n", "", "i", "[", "'lanenumber'", "]", "=", "len", "(", "lanes", ")", "\n", "i", "[", "'lanelinks'", "]", "=", "detail_lanes", "\n", "del", "i", "[", "'laneLinks'", "]", "\n", "", "one", "[", "'connection'", "]", "=", "{", "}", "# save edges to other intersections", "\n", "for", "road", "in", "inter", "[", "'roads'", "]", ":", "\n", "            ", "if", "roads", "[", "road", "]", "[", "'startIntersection'", "]", "==", "inter", "[", "'id'", "]", ":", "\n", "                ", "one", "[", "'connection'", "]", "[", "road", "]", "=", "[", "\n", "roads", "[", "road", "]", "[", "'endIntersection'", "]", ",", "\n", "get_length", "(", "roads", "[", "road", "]", "[", "'points'", "]", ")", "]", "\n", "", "", "if", "inter", "[", "'virtual'", "]", ":", "\n", "            ", "virtual_res", "[", "inter", "[", "'id'", "]", "]", "=", "one", "\n", "", "else", ":", "\n", "            ", "phase", "=", "inter", "[", "'trafficLight'", "]", "[", "'lightphases'", "]", "\n", "phase", "=", "[", "x", "[", "'availableRoadLinks'", "]", "for", "x", "in", "phase", "]", "\n", "one", "[", "'phases'", "]", "=", "phase", "\n", "res", "[", "inter", "[", "'id'", "]", "]", "=", "one", "\n", "", "", "return", "res", ",", "virtual_res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.flatten_data": [[165, 180], ["list", "list", "zip", "map", "dic[].keys", "NotImplementedError", "len", "numpy.stack", "numpy.stack"], "function", ["None"], ["", "def", "flatten_data", "(", "datatype", ",", "data", ")", ":", "\n", "    ", "if", "datatype", "==", "'array'", ":", "\n", "        ", "data", "=", "list", "(", "zip", "(", "*", "data", ")", ")", "\n", "data", "=", "list", "(", "map", "(", "lambda", "x", ":", "np", ".", "stack", "(", "x", ")", ",", "data", ")", ")", "\n", "return", "data", "[", "0", "]", "\n", "", "elif", "datatype", "==", "'dict'", ":", "\n", "        ", "dic", "=", "data", "\n", "if", "len", "(", "dic", ")", "==", "0", ":", "\n", "            ", "return", "{", "}", "\n", "", "res", "=", "{", "}", "\n", "for", "key", "in", "dic", "[", "0", "]", ".", "keys", "(", ")", ":", "\n", "            ", "res", "[", "key", "]", "=", "np", ".", "stack", "(", "[", "x", "[", "key", "]", "for", "x", "in", "dic", "]", ")", "\n", "", "return", "res", "\n", "", "else", ":", "\n", "        ", "raise", "NotImplementedError", "(", "'unknown flatten type '", "+", "datatype", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.unpack_flattened_data": [[182, 197], ["NotImplementedError", "list", "len", "range", "NotImplementedError", "data.keys", "res.append"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "", "def", "unpack_flattened_data", "(", "datatype", ",", "data", ")", ":", "\n", "    ", "if", "datatype", "==", "'array'", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "", "elif", "datatype", "==", "'dict'", ":", "\n", "        ", "res", "=", "[", "]", "\n", "keys", "=", "list", "(", "data", ".", "keys", "(", ")", ")", "\n", "size", "=", "len", "(", "data", "[", "keys", "[", "0", "]", "]", ")", "\n", "for", "i", "in", "range", "(", "size", ")", ":", "\n", "            ", "one", "=", "{", "}", "\n", "for", "key", "in", "keys", ":", "\n", "                ", "one", "[", "key", "]", "=", "data", "[", "key", "]", "[", "i", "]", "\n", "", "res", ".", "append", "(", "one", ")", "\n", "", "return", "res", "\n", "", "else", ":", "\n", "        ", "raise", "NotImplementedError", "(", "'unknown flatten type '", "+", "datatype", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.get_intersection_info": [[199, 205], ["json.load", "open"], "function", ["None"], ["", "", "def", "get_intersection_info", "(", "filename", ",", "intername", ")", ":", "\n", "    ", "j", "=", "json", ".", "load", "(", "open", "(", "filename", ")", ")", "\n", "j", "=", "j", "[", "'intersections'", "]", "\n", "for", "i", "in", "j", ":", "\n", "        ", "if", "i", "[", "'id'", "]", "==", "intername", ":", "\n", "            ", "return", "i", "\n", "", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal.__init__": [[15, 30], ["len", "CityFlowEnv.TrafficSignal._set_observation_space", "CityFlowEnv.TrafficSignal.set_eng_phase"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs._set_observation_space", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal.set_eng_phase"], ["def", "__init__", "(", "self", ",", "ID", ",", "eng", ",", "yellow_time", ",", "roadnet_info", ")", ":", "\n", "        ", "self", ".", "roadnet_info", "=", "roadnet_info", "\n", "self", ".", "ID", "=", "ID", "\n", "self", ".", "eng", "=", "eng", "\n", "self", ".", "now_idx", "=", "1", "\n", "self", ".", "old_idx", "=", "1", "\n", "self", ".", "next_idx", "=", "None", "\n", "self", ".", "now_time", "=", "-", "1", "\n", "self", ".", "yellow_flag", "=", "False", "\n", "self", ".", "flicker", "=", "False", "\n", "self", ".", "yellow_time", "=", "yellow_time", "\n", "self", ".", "phase_number", "=", "len", "(", "roadnet_info", "[", "'phases'", "]", ")", "\n", "self", ".", "_set_observation_space", "(", ")", "\n", "self", ".", "action_space", "=", "self", ".", "phase_number", "-", "1", "\n", "self", ".", "set_eng_phase", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal._set_observation_space": [[31, 50], ["len", "len", "len", "len"], "methods", ["None"], ["", "def", "_set_observation_space", "(", "self", ")", ":", "\n", "        ", "\"\"\"\n            include intersection dimension.\n            TSflow, TSwait, TSgreen, TStime means array shape\n            TSphase means how many phases available and roadlinks opened in \n                each phase, and when in yellow phase, returns next controllable \n                phase.\n            TStime: phase activated time of every lane\n        \"\"\"", "\n", "self", ".", "observation_space", "=", "{", "\n", "'TSflow'", ":", "[", "len", "(", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ")", "]", ",", "\n", "'TSwait'", ":", "[", "len", "(", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ")", "]", ",", "\n", "'TSgreen'", ":", "[", "len", "(", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ")", "]", ",", "\n", "'TSphase'", ":", "self", ".", "roadnet_info", "[", "'phases'", "]", "[", "1", ":", "]", ",", "\n", "'TStime'", ":", "[", "1", "]", ",", "\n", "'Envtime'", ":", "[", "1", "]", ",", "\n", "'LaneCount'", ":", "[", "len", "(", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ")", "]", ",", "\n", "'RoadLinkDirection'", ":", "[", "x", "[", "'type'", "]", "\n", "for", "x", "in", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", "]", ",", "\n", "}", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal.set_eng_phase": [[52, 54], ["CityFlowEnv.TrafficSignal.eng.set_tl_phase"], "methods", ["None"], ["", "def", "set_eng_phase", "(", "self", ")", ":", "\n", "        ", "self", ".", "eng", ".", "set_tl_phase", "(", "self", ".", "ID", ",", "self", ".", "now_idx", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal.set_signal": [[55, 87], ["CityFlowEnv.TrafficSignal.set_eng_phase", "CityFlowEnv.TrafficSignal.set_eng_phase", "sys.exit"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal.set_eng_phase", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal.set_eng_phase"], ["", "def", "set_signal", "(", "self", ",", "action", ",", "action_pattern", ")", ":", "\n", "        ", "if", "self", ".", "yellow_flag", ":", "\n", "# in yellow phase", "\n", "            ", "if", "self", ".", "now_time", ">=", "self", ".", "yellow_time", ":", "# yellow time reached", "\n", "                ", "self", ".", "now_idx", "=", "self", ".", "next_idx", "\n", "self", ".", "set_eng_phase", "(", ")", "\n", "self", ".", "yellow_flag", "=", "False", "\n", "", "else", ":", "\n", "                ", "pass", "\n", "", "", "else", ":", "\n", "# determine phase", "\n", "            ", "if", "action_pattern", "==", "\"switch\"", ":", "# switch by order", "\n", "                ", "if", "action", "==", "0", ":", "# keep the phase", "\n", "                    ", "self", ".", "new_idx", "=", "self", ".", "now_idx", "\n", "", "elif", "action", "==", "1", ":", "# change to the next phase", "\n", "                    ", "self", ".", "next_idx", "=", "self", ".", "now_idx", "+", "1", "\n", "if", "self", ".", "next_idx", "==", "self", ".", "phase_number", ":", "\n", "                        ", "self", ".", "next_idx", "=", "1", "\n", "", "", "else", ":", "\n", "                    ", "sys", ".", "exit", "(", "\"action not recognized\\n action must be 0 or 1\"", ")", "\n", "\n", "", "", "elif", "action_pattern", "==", "\"set\"", ":", "# set to certain phase", "\n", "                ", "self", ".", "next_idx", "=", "action", "+", "1", "\n", "\n", "# set phase", "\n", "", "if", "self", ".", "now_idx", "==", "self", ".", "next_idx", ":", "# light phase keeps unchanged", "\n", "                ", "pass", "\n", "", "else", ":", "# the light phase needs to change", "\n", "# change to yellow first, and activate the counter and flag", "\n", "                ", "self", ".", "now_idx", "=", "0", "\n", "self", ".", "set_eng_phase", "(", ")", "\n", "self", ".", "yellow_flag", "=", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal.step_time": [[88, 93], ["None"], "methods", ["None"], ["", "", "", "def", "step_time", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "now_idx", "!=", "self", ".", "old_idx", ":", "\n", "            ", "self", ".", "now_time", "=", "1", "\n", "", "else", ":", "\n", "            ", "self", ".", "now_time", "+=", "1", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal._get_signal_state": [[94, 98], ["None"], "methods", ["None"], ["", "", "def", "_get_signal_state", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "now_idx", "==", "0", ":", "\n", "            ", "return", "self", ".", "next_idx", "-", "1", "\n", "", "return", "self", ".", "now_idx", "-", "1", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal.get_state": [[99, 130], ["CityFlowEnv.TrafficSignal._get_signal_state", "range", "CityFlowEnv.TrafficSignal.eng.get_current_time", "len", "CityFlowEnv.TrafficSignal.eng.get_roadlink_vehicle_count", "CityFlowEnv.TrafficSignal.eng.get_roadlink_waiting_vehicle_count", "LaneCount.append", "TSgreen.append", "TSflow.append", "TSwait.append", "TSflow.append", "TSwait.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal._get_signal_state", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "get_state", "(", "self", ")", ":", "\n", "        ", "TSflow", "=", "[", "]", "\n", "TSwait", "=", "[", "]", "\n", "TSgreen", "=", "[", "]", "\n", "TSphase", "=", "self", ".", "_get_signal_state", "(", ")", "\n", "TStime", "=", "self", ".", "now_time", "\n", "LaneCount", "=", "[", "]", "\n", "for", "roadlink", "in", "range", "(", "len", "(", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ")", ")", ":", "\n", "            ", "count", "=", "self", ".", "eng", ".", "get_roadlink_vehicle_count", "(", "self", ".", "ID", ",", "roadlink", ")", "\n", "wait_count", "=", "self", ".", "eng", ".", "get_roadlink_waiting_vehicle_count", "(", "\n", "self", ".", "ID", ",", "roadlink", ")", "\n", "assert", "count", "[", "1", "]", "==", "wait_count", "[", "1", "]", ",", "f'{count} {wait_count}'", "\n", "if", "count", "[", "1", "]", "==", "0", ":", "\n", "                ", "TSflow", ".", "append", "(", "0", ")", "\n", "TSwait", ".", "append", "(", "0", ")", "\n", "", "else", ":", "\n", "                ", "TSflow", ".", "append", "(", "count", "[", "0", "]", "/", "count", "[", "1", "]", ")", "\n", "TSwait", ".", "append", "(", "wait_count", "[", "0", "]", "/", "wait_count", "[", "1", "]", ")", "\n", "", "LaneCount", ".", "append", "(", "count", "[", "1", "]", ")", "\n", "TSgreen", ".", "append", "(", "0", ")", "\n", "", "for", "phase", "in", "self", ".", "roadnet_info", "[", "'phases'", "]", "[", "self", ".", "now_idx", "]", ":", "\n", "            ", "TSgreen", "[", "phase", "]", "=", "1", "\n", "", "envtime", "=", "self", ".", "eng", ".", "get_current_time", "(", ")", "\n", "return", "{", "\n", "'TSflow'", ":", "TSflow", ",", "\n", "'TSwait'", ":", "TSwait", ",", "\n", "'TSgreen'", ":", "TSgreen", ",", "\n", "'TSphase'", ":", "TSphase", ",", "\n", "'TStime'", ":", "TStime", ",", "\n", "'Envtime'", ":", "envtime", ",", "\n", "'LaneCount'", ":", "LaneCount", "\n", "}", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.TrafficSignal.update_old": [[132, 134], ["None"], "methods", ["None"], ["", "def", "update_old", "(", "self", ")", ":", "\n", "        ", "self", ".", "old_idx", "=", "self", ".", "now_idx", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.__init__": [[166, 180], ["CityFlowEnv.Intersection._init_components", "CityFlowEnv.Intersection._set_observation_space", "CityFlowEnv.Intersection._set_action_space"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._init_components", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs._set_observation_space", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs._set_action_space"], ["    ", "def", "__init__", "(", "self", ",", "ID", ",", "config", ",", "eng", ",", "intersection_names", ",", "\n", "virtual_intersection_names", ")", ":", "\n", "        ", "self", ".", "ID", "=", "ID", "\n", "self", ".", "config", "=", "config", "\n", "self", ".", "eng", "=", "eng", "\n", "self", ".", "intersection_names", "=", "intersection_names", "\n", "self", ".", "virtual_intersection_names", "=", "virtual_intersection_names", "\n", "self", ".", "save_lane_count_step", "=", "5", "\n", "self", ".", "lanename2roaddirection", "=", "{", "}", "\n", "\n", "self", ".", "_init_components", "(", ")", "\n", "\n", "self", ".", "_set_observation_space", "(", ")", "\n", "self", ".", "_set_action_space", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._init_components": [[181, 197], ["CityFlowEnv.TrafficSignal", "numpy.zeros", "numpy.zeros", "numpy.zeros", "len", "len"], "methods", ["None"], ["", "def", "_init_components", "(", "self", ")", ":", "\n", "        ", "self", ".", "roadnet_info", "=", "self", ".", "config", "[", "'ROADNET_INFO'", "]", "[", "self", ".", "ID", "]", "\n", "\n", "self", ".", "TS", "=", "TrafficSignal", "(", "self", ".", "ID", ",", "self", ".", "eng", ",", "self", ".", "config", "[", "'YELLOW_TIME'", "]", ",", "\n", "self", ".", "roadnet_info", ")", "\n", "self", ".", "last_reward", "=", "0", "\n", "\n", "self", ".", "saved_phases", "=", "np", ".", "zeros", "(", "(", "self", ".", "save_lane_count_step", ",", ")", ",", "dtype", "=", "int", ")", "\n", "self", ".", "saved_phases", "[", ":", "]", "=", "-", "1", "\n", "\n", "self", ".", "lane_vehicle_count_mat", "=", "np", ".", "zeros", "(", "(", "# this is in count", "\n", "self", ".", "save_lane_count_step", ",", "\n", "len", "(", "self", ".", "roadnet_info", "[", "'connection'", "]", ")", ",", "3", ")", ",", "dtype", "=", "int", ")", "\n", "self", ".", "lane_vehicle_out_count_mat", "=", "np", ".", "zeros", "(", "(", "\n", "self", ".", "save_lane_count_step", ",", "\n", "len", "(", "self", ".", "roadnet_info", "[", "'connection'", "]", ")", ",", "3", ")", ",", "dtype", "=", "int", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.reset": [[198, 200], ["CityFlowEnv.Intersection._init_components"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._init_components"], ["", "def", "reset", "(", "self", ")", ":", "\n", "        ", "self", ".", "_init_components", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_road_direction_idx": [[201, 206], ["enumerate", "ValueError"], "methods", ["None"], ["", "def", "_get_road_direction_idx", "(", "self", ",", "roadname", ",", "direction", ")", ":", "\n", "        ", "for", "num", ",", "i", "in", "enumerate", "(", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ")", ":", "\n", "            ", "if", "i", "[", "'startRoad'", "]", "==", "roadname", "and", "i", "[", "'type'", "]", "==", "direction", ":", "\n", "                ", "return", "num", "\n", "", "", "raise", "ValueError", "(", "roadname", ",", "direction", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._set_observation_space": [[230, 264], ["len", "list", "CityFlowEnv.Intersection.roadnames.sort", "CityFlowEnv.Intersection.roadnet_info[].keys", "tot[].append", "tot[].append", "tot[].append", "len", "len", "CityFlowEnv.Intersection.intersection_names.index", "len", "CityFlowEnv.Intersection.roadnames.index", "CityFlowEnv.Intersection.virtual_intersection_names.index"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["def", "_set_observation_space", "(", "self", ")", ":", "\n", "        ", "tot", "=", "self", ".", "TS", ".", "observation_space", "\n", "tot", "[", "'DirectionNames'", "]", "=", "[", "\n", "'turn_left'", ",", "\n", "'go_straight'", ",", "\n", "'turn_right'", "\n", "]", "# now assume three direction", "\n", "self", ".", "lane_direction_number", "=", "len", "(", "tot", "[", "'DirectionNames'", "]", ")", "\n", "self", ".", "roadnames", "=", "list", "(", "self", ".", "roadnet_info", "[", "'connection'", "]", ".", "keys", "(", ")", ")", "\n", "self", ".", "roadnames", ".", "sort", "(", ")", "\n", "tot", "[", "'RoadsOut'", "]", "=", "[", "]", "\n", "tot", "[", "'RoadsIn'", "]", "=", "[", "]", "\n", "for", "road", "in", "self", ".", "roadnames", ":", "\n", "            ", "interto", "=", "self", ".", "roadnet_info", "[", "'connection'", "]", "[", "road", "]", "[", "0", "]", "\n", "intertoid", "=", "self", ".", "intersection_names", ".", "index", "(", "interto", ")", "if", "interto", "in", "self", ".", "intersection_names", "else", "-", "1", "-", "self", ".", "virtual_intersection_names", ".", "index", "(", "interto", ")", "\n", "tot", "[", "'RoadsOut'", "]", ".", "append", "(", "intertoid", ")", "\n", "", "tot", "[", "'RoadLinksOut'", "]", "=", "[", "]", "\n", "tot", "[", "'RoadLinksIn'", "]", "=", "[", "]", "# can't fill now, fill later", "\n", "tot", "[", "'RoadOutLanes'", "]", "=", "[", "[", "0", "]", "*", "len", "(", "tot", "[", "'DirectionNames'", "]", ")", "\n", "for", "_", "in", "self", ".", "roadnames", "]", "# also can't fill now", "\n", "tot", "[", "'LaneCount'", "]", "=", "[", "]", "\n", "for", "rl", "in", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ":", "\n", "            ", "tot", "[", "'RoadLinksOut'", "]", ".", "append", "(", "self", ".", "roadnames", ".", "index", "(", "rl", "[", "'endRoad'", "]", ")", ")", "\n", "tot", "[", "'LaneCount'", "]", ".", "append", "(", "rl", "[", "'lanenumber'", "]", ")", "\n", "", "tot", "[", "'InLaneVehicleNumber'", "]", "=", "[", "self", ".", "save_lane_count_step", ",", "\n", "len", "(", "self", ".", "roadnames", ")", ",", "\n", "self", ".", "lane_direction_number", "]", "\n", "tot", "[", "'OutLaneVehicleNumber'", "]", "=", "[", "self", ".", "save_lane_count_step", ",", "\n", "len", "(", "self", ".", "roadnames", ")", ",", "\n", "self", ".", "lane_direction_number", "]", "\n", "tot", "[", "'TSprevphases'", "]", "=", "[", "self", ".", "save_lane_count_step", "]", "\n", "self", ".", "observation_space", "=", "tot", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._set_road_links_in": [[265, 278], ["rlin.append", "rlin.append", "CityFlowEnv.Intersection.roadinnames.append", "rin.append", "CityFlowEnv.Intersection.roadinnames.index"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "_set_road_links_in", "(", "self", ",", "roadname2id", ")", ":", "\n", "        ", "self", ".", "roadinnames", "=", "[", "]", "\n", "rlin", "=", "self", ".", "observation_space", "[", "'RoadLinksIn'", "]", "\n", "rin", "=", "self", ".", "observation_space", "[", "'RoadsIn'", "]", "\n", "for", "rl", "in", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ":", "\n", "            ", "rn", "=", "rl", "[", "'startRoad'", "]", "\n", "if", "rn", "not", "in", "roadname2id", ":", "\n", "                ", "rlin", ".", "append", "(", "-", "1", ")", "\n", "", "else", ":", "\n", "                ", "if", "rn", "not", "in", "self", ".", "roadinnames", ":", "\n", "                    ", "self", ".", "roadinnames", ".", "append", "(", "rn", ")", "\n", "rin", ".", "append", "(", "roadname2id", "[", "rn", "]", ")", "\n", "", "rlin", ".", "append", "(", "self", ".", "roadinnames", ".", "index", "(", "rn", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_road_id": [[279, 291], ["enumerate", "enumerate", "torid.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "", "", "def", "_get_road_id", "(", "self", ",", "inters", ",", "ask_inter_id", ",", "ask_roadnumber", ")", ":", "\n", "        ", "torid", "=", "-", "1", "\n", "for", "num", ",", "[", "i", ",", "j", "]", "in", "enumerate", "(", "self", ".", "observation_space", "[", "'RoadsIn'", "]", ")", ":", "\n", "            ", "if", "i", ">=", "0", "and", "ask_inter_id", "==", "inters", "[", "i", "]", ".", "ID", "and", "ask_roadnumber", "==", "j", ":", "\n", "                ", "torid", "=", "num", "\n", "", "", "if", "torid", "!=", "-", "1", ":", "\n", "            ", "return", "torid", "\n", "", "torid", "=", "[", "]", "\n", "for", "num", ",", "[", "i", ",", "j", "]", "in", "enumerate", "(", "self", ".", "observation_space", "[", "'RoadsIn'", "]", ")", ":", "\n", "            ", "if", "i", "<", "0", "and", "ask_roadnumber", "==", "j", ":", "\n", "                ", "torid", ".", "append", "(", "[", "i", ",", "num", "]", ")", "\n", "", "", "return", "torid", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._update_lanename": [[292, 317], ["enumerate", "zip", "enumerate", "enumerate", "o_inter._get_road_id", "range", "set", "set"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_road_id"], ["", "def", "_update_lanename", "(", "self", ",", "lanename2roaddirection", ",", "inters", ",", "\n", "now_in_lane_vehicles", ",", "last_in_lane_vehicles", ")", ":", "\n", "        ", "self", ".", "lanename2roaddirection", "=", "lanename2roaddirection", "\n", "self", ".", "now_in_lane_vehicles", "=", "now_in_lane_vehicles", "\n", "self", ".", "last_in_lane_vehicles", "=", "last_in_lane_vehicles", "\n", "for", "rn", ",", "[", "rname", ",", "toid", "]", "in", "enumerate", "(", "zip", "(", "\n", "self", ".", "roadnames", ",", "\n", "self", ".", "observation_space", "[", "'RoadsOut'", "]", ")", ")", ":", "\n", "            ", "if", "toid", "<", "0", ":", "\n", "                ", "continue", "\n", "", "o_inter", "=", "inters", "[", "toid", "]", "\n", "torid", "=", "-", "1", "\n", "for", "num", ",", "[", "i", ",", "j", "]", "in", "enumerate", "(", "o_inter", ".", "observation_space", "[", "'RoadsIn'", "]", ")", ":", "\n", "                ", "if", "i", ">=", "0", "and", "self", "==", "inters", "[", "i", "]", "and", "rn", "==", "j", ":", "\n", "                    ", "torid", "=", "num", "\n", "", "", "assert", "torid", "==", "o_inter", ".", "_get_road_id", "(", "inters", ",", "self", ".", "ID", ",", "rn", ")", "\n", "now_lanen", "=", "0", "\n", "for", "dn", ",", "d", "in", "enumerate", "(", "self", ".", "observation_space", "[", "'RoadOutLanes'", "]", "[", "rn", "]", ")", ":", "\n", "# now assume lane order same as direction name order", "\n", "                ", "for", "_", "in", "range", "(", "d", ")", ":", "\n", "                    ", "lanename", "=", "'%s_%d'", "%", "(", "rname", ",", "now_lanen", ")", "\n", "now_lanen", "+=", "1", "\n", "self", ".", "lanename2roaddirection", "[", "lanename", "]", "=", "[", "toid", ",", "torid", ",", "dn", "]", "\n", "self", ".", "now_in_lane_vehicles", "[", "lanename", "]", "=", "set", "(", ")", "\n", "self", ".", "last_in_lane_vehicles", "[", "lanename", "]", "=", "set", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._set_action_space": [[318, 321], ["None"], "methods", ["None"], ["", "", "", "", "def", "_set_action_space", "(", "self", ")", ":", "\n", "        ", "tot", "=", "[", "self", ".", "TS", ".", "action_space", "]", "\n", "self", ".", "action_space", "=", "tot", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.set_signal": [[322, 324], ["CityFlowEnv.Intersection.TS.set_signal"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.set_signal"], ["", "def", "set_signal", "(", "self", ",", "action", ",", "action_pattern", ")", ":", "\n", "        ", "self", ".", "TS", ".", "set_signal", "(", "action", ",", "action_pattern", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.step_time": [[325, 327], ["CityFlowEnv.Intersection.TS.step_time"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.step_time"], ["", "def", "step_time", "(", "self", ")", ":", "\n", "        ", "self", ".", "TS", ".", "step_time", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.get_state": [[328, 338], ["CityFlowEnv.Intersection.TS.get_state", "list", "CityFlowEnv.Intersection._get_pressure_observation"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.get_state", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_pressure_observation"], ["", "def", "get_state", "(", "self", ")", ":", "\n", "        ", "res", "=", "self", ".", "TS", ".", "get_state", "(", ")", "\n", "DCphase", "=", "[", "]", "\n", "res", "[", "'InLaneVehicleNumber'", "]", "=", "self", ".", "lane_vehicle_count_mat", "\n", "res", "[", "'OutLaneVehicleNumber'", "]", "=", "self", ".", "lane_vehicle_out_count_mat", "\n", "self", ".", "saved_phases", "[", "-", "1", "]", "=", "res", "[", "'TSphase'", "]", "\n", "res", "[", "'TSprevphases'", "]", "=", "list", "(", "self", ".", "saved_phases", ")", "\n", "res", "[", "'DCphase'", "]", "=", "DCphase", "\n", "res", "[", "'pressure'", "]", "=", "self", ".", "_get_pressure_observation", "(", ")", "\n", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.act": [[339, 349], ["CityFlowEnv.Intersection.set_signal", "len", "len", "arr.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.set_signal", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "act", "(", "self", ",", "actions", ",", "pattern", ")", ":", "\n", "        ", "if", "len", "(", "actions", ")", "==", "1", ":", "# input single number, treat as combined action", "\n", "            ", "arr", "=", "[", "]", "\n", "action", "=", "actions", "[", "0", "]", "\n", "for", "i", "in", "self", ".", "action_space", ":", "\n", "                ", "arr", ".", "append", "(", "action", "%", "i", ")", "\n", "action", "//=", "i", "\n", "", "actions", "=", "arr", "\n", "", "self", ".", "set_signal", "(", "actions", "[", "0", "]", ",", "pattern", ")", "\n", "assert", "len", "(", "actions", ")", "==", "1", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.get_default_action": [[350, 353], ["None"], "methods", ["None"], ["", "def", "get_default_action", "(", "self", ")", ":", "\n", "# use single number format as default action", "\n", "        ", "return", "[", "0", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_pressure_observation": [[354, 373], ["CityFlowEnv.Intersection.eng.get_lane_vehicle_count", "CityFlowEnv.Intersection.eng.get_lane_waiting_vehicle_count", "numpy.array", "zip", "set", "set", "res.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "_get_pressure_observation", "(", "self", ")", ":", "\n", "# count every roadlink pressure and average, Sigma(|P_ri|)", "\n", "        ", "lane_count_1", "=", "self", ".", "eng", ".", "get_lane_vehicle_count", "(", ")", "\n", "lane_count_2", "=", "self", ".", "eng", ".", "get_lane_waiting_vehicle_count", "(", ")", "\n", "lanelinks", "=", "[", "x", "[", "'lanelinks'", "]", "for", "x", "in", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", "]", "\n", "res", "=", "[", "]", "\n", "for", "ll", "in", "lanelinks", ":", "\n", "            ", "start", ",", "end", "=", "zip", "(", "*", "ll", ")", "\n", "start", "=", "set", "(", "start", ")", "\n", "end", "=", "set", "(", "end", ")", "\n", "RA", "=", "0", "\n", "RS", "=", "0", "\n", "for", "s", "in", "start", ":", "\n", "                ", "RA", "+=", "lane_count_1", "[", "s", "]", "\n", "", "for", "e", "in", "end", ":", "\n", "                ", "RS", "+=", "lane_count_2", "[", "e", "]", "\n", "", "RR", "=", "RA", "-", "RS", "\n", "res", ".", "append", "(", "RR", ")", "\n", "", "return", "np", ".", "array", "(", "res", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_average_vehicle_count": [[374, 391], ["range", "type.lower", "len", "target_func", "type.lower", "ValueError"], "methods", ["None"], ["", "def", "_get_average_vehicle_count", "(", "self", ",", "type", ",", "weight", ")", ":", "\n", "        ", "res", "=", "0", "\n", "cres", "=", "0", "\n", "if", "type", ".", "lower", "(", ")", "==", "'flow'", ":", "\n", "            ", "target_func", "=", "self", ".", "eng", ".", "get_roadlink_vehicle_count", "\n", "", "elif", "type", ".", "lower", "(", ")", "==", "'wait'", ":", "\n", "            ", "target_func", "=", "self", ".", "eng", ".", "get_roadlink_waiting_vehicle_count", "\n", "", "else", ":", "\n", "            ", "raise", "ValueError", "(", "'unknown type '", "+", "type", ")", "\n", "", "for", "roadlink", "in", "range", "(", "len", "(", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ")", ")", ":", "\n", "            ", "count", "=", "target_func", "(", "self", ".", "ID", ",", "roadlink", ")", "\n", "if", "count", "[", "1", "]", "==", "0", ":", "\n", "                ", "pass", "\n", "", "else", ":", "\n", "                ", "res", "+=", "count", "[", "0", "]", "/", "count", "[", "1", "]", "\n", "cres", "+=", "1", "\n", "", "", "return", "-", "res", "/", "cres", "*", "weight", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_average_pressure": [[392, 434], ["CityFlowEnv.Intersection.eng.get_lane_vehicle_count", "type.lower", "zip", "set", "set", "lanelinks.extend", "type.lower", "abs", "zip", "set", "set", "abs", "res.append", "type.lower", "ValueError", "numpy.array().mean", "res.append", "numpy.array().mean", "numpy.array", "abs", "numpy.array"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "_get_average_pressure", "(", "self", ",", "type", ",", "weight", ")", ":", "\n", "        ", "lane_count", "=", "self", ".", "eng", ".", "get_lane_vehicle_count", "(", ")", "\n", "if", "type", ".", "lower", "(", ")", "==", "'intersection'", ":", "\n", "# count intersection as one unit, |Sigma(#in) - Sigma(#out)|", "\n", "            ", "lanelinks", "=", "[", "]", "\n", "for", "roadlink", "in", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ":", "\n", "                ", "lanelinks", ".", "extend", "(", "roadlink", "[", "'lanelinks'", "]", ")", "\n", "", "start", ",", "end", "=", "zip", "(", "*", "lanelinks", ")", "\n", "start", "=", "set", "(", "start", ")", "\n", "end", "=", "set", "(", "end", ")", "\n", "res", "=", "0", "\n", "for", "s", "in", "start", ":", "\n", "                ", "res", "+=", "lane_count", "[", "s", "]", "\n", "", "for", "e", "in", "end", ":", "\n", "                ", "res", "-=", "lane_count", "[", "e", "]", "\n", "", "return", "-", "abs", "(", "res", ")", "*", "weight", "\n", "", "elif", "type", ".", "lower", "(", ")", "==", "'roadlink'", ":", "\n", "# count every roadlink pressure and average, Sigma(|P_ri|)", "\n", "            ", "lanelinks", "=", "[", "x", "[", "'lanelinks'", "]", "\n", "for", "x", "in", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", "]", "\n", "res", "=", "[", "]", "\n", "for", "lanelink", "in", "lanelinks", ":", "\n", "                ", "start", ",", "end", "=", "zip", "(", "*", "lanelink", ")", "\n", "start", "=", "set", "(", "start", ")", "\n", "end", "=", "set", "(", "end", ")", "\n", "RR", "=", "0", "\n", "for", "s", "in", "start", ":", "\n", "                    ", "RR", "+=", "lane_count", "[", "s", "]", "\n", "", "for", "e", "in", "end", ":", "\n", "                    ", "RR", "-=", "lane_count", "[", "e", "]", "\n", "", "RR", "=", "abs", "(", "RR", ")", "\n", "res", ".", "append", "(", "RR", ")", "\n", "", "return", "-", "np", ".", "array", "(", "res", ")", ".", "mean", "(", ")", "*", "weight", "\n", "", "elif", "type", ".", "lower", "(", ")", "==", "'lanelink'", ":", "\n", "# count every lanelink pressure and average", "\n", "            ", "res", "=", "[", "]", "\n", "for", "roadlink", "in", "self", ".", "roadnet_info", "[", "'roadlinks'", "]", ":", "\n", "                ", "for", "s", ",", "t", "in", "roadlink", "[", "'lanelinks'", "]", ":", "\n", "                    ", "res", ".", "append", "(", "abs", "(", "lane_count", "[", "s", "]", "-", "lane_count", "[", "t", "]", ")", ")", "\n", "", "", "return", "-", "np", ".", "array", "(", "res", ")", ".", "mean", "(", ")", "*", "weight", "\n", "", "else", ":", "\n", "            ", "raise", "ValueError", "(", "'unknown type '", "+", "type", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.get_reward": [[435, 470], ["list", "weight.keys", "float", "CityFlowEnv.Intersection._get_average_vehicle_count", "CityFlowEnv.Intersection._get_average_vehicle_count", "CityFlowEnv.Intersection._get_average_pressure", "CityFlowEnv.Intersection._get_average_pressure", "CityFlowEnv.Intersection._get_average_pressure"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_average_vehicle_count", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_average_vehicle_count", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_average_pressure", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_average_pressure", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_average_pressure"], ["", "", "def", "get_reward", "(", "self", ",", "weight", ")", ":", "\n", "        ", "res", "=", "0", "\n", "wkeys", "=", "list", "(", "weight", ".", "keys", "(", ")", ")", "\n", "for", "i", "in", "wkeys", ":", "\n", "            ", "if", "not", "weight", "[", "i", "]", ":", "\n", "                ", "del", "weight", "[", "i", "]", "\n", "continue", "\n", "", "weight", "[", "i", "]", "=", "float", "(", "weight", "[", "i", "]", ")", "\n", "if", "not", "weight", "[", "i", "]", ":", "\n", "                ", "del", "weight", "[", "i", "]", "\n", "", "", "if", "'AVERAGE_FLOW_VEHICLE_COUNT'", "in", "weight", ":", "\n", "            ", "res", "+=", "self", ".", "_get_average_vehicle_count", "(", "\n", "type", "=", "'flow'", ",", "\n", "weight", "=", "weight", "[", "'AVERAGE_FLOW_VEHICLE_COUNT'", "]", ")", "\n", "", "if", "'AVERAGE_WAIT_VEHICLE_COUNT'", "in", "weight", ":", "\n", "            ", "res", "+=", "self", ".", "_get_average_vehicle_count", "(", "\n", "type", "=", "'wait'", ",", "\n", "weight", "=", "weight", "[", "'AVERAGE_WAIT_VEHICLE_COUNT'", "]", ")", "\n", "", "if", "'AVERAGE_INTERSECTION_PRESSURE'", "in", "weight", ":", "\n", "            ", "res", "+=", "self", ".", "_get_average_pressure", "(", "\n", "type", "=", "'intersection'", ",", "\n", "weight", "=", "weight", "[", "'AVERAGE_INTERSECTION_PRESSURE'", "]", ")", "\n", "", "if", "'AVERAGE_ROADLINK_PRESSURE'", "in", "weight", ":", "\n", "            ", "res", "+=", "self", ".", "_get_average_pressure", "(", "\n", "type", "=", "'roadlink'", ",", "\n", "weight", "=", "weight", "[", "'AVERAGE_ROADLINK_PRESSURE'", "]", ")", "\n", "", "if", "'AVERAGE_LANELINK_PRESSURE'", "in", "weight", ":", "\n", "            ", "res", "+=", "self", ".", "_get_average_pressure", "(", "\n", "type", "=", "'lanelink'", ",", "\n", "weight", "=", "weight", "[", "'AVERAGE_LANELINK_PRESSURE'", "]", ")", "\n", "", "if", "self", ".", "config", "[", "'DELTA_REWARD'", "]", ":", "\n", "            ", "res", "=", "res", "-", "self", ".", "last_reward", "\n", "self", ".", "last_reward", "+=", "res", "\n", "res", "*=", "self", ".", "config", "[", "'DELTA_REWARD_MULTIPLIER'", "]", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.update_old": [[471, 473], ["CityFlowEnv.Intersection.TS.update_old"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.update_old"], ["", "def", "update_old", "(", "self", ")", ":", "\n", "        ", "self", ".", "TS", ".", "update_old", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Flow.__init__": [[476, 478], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ")", ":", "\n", "        ", "pass", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.__init__": [[498, 621], ["os.path.join", "CityFlowEnv.CityFlowEnv.init_engine", "list", "list.sort", "list", "list.sort", "numpy.zeros", "set", "enumerate", "CityFlowEnv.CityFlowEnv.update_virtual_lanename", "CityFlowEnv.CityFlowEnv._set_adj_mat", "CityFlowEnv.CityFlowEnv._set_observation_space", "CityFlowEnv.CityFlowEnv._set_action_space", "os.path.join", "os.path.join", "os.path.join", "os.path.join", "print", "open", "json.dump", "CityFlowEnv.CityFlowEnv.log", "len", "os.path.join", "CityFlowEnv.CityFlowEnv.log", "CityFlowEnv.CityFlowEnv.config[].keys", "virtual_inters.keys", "CityFlowEnv.Intersection", "enumerate", "list.index", "list", "inter._set_road_links_in", "inter._update_lanename", "str", "len", "v_inter[].keys", "len", "range", "len", "CityFlowEnv.CityFlowEnv.virtual_direction_names.index", "ninter.observation_space[].index"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.init_engine", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.update_virtual_lanename", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._set_adj_mat", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs._set_observation_space", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs._set_action_space", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._set_road_links_in", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._update_lanename"], ["    ", "def", "__init__", "(", "self", ",", "log_path", ",", "work_folder", ",", "config", ",", "logfile", "=", "''", ",", "seed", "=", "0", ",", "\n", "suffix", "=", "True", ")", ":", "\n", "        ", "self", ".", "log_path", "=", "log_path", "\n", "self", ".", "work_folder", "=", "work_folder", "\n", "self", ".", "config", "=", "config", "\n", "self", ".", "logfile", "=", "logfile", "\n", "self", ".", "seed", "=", "seed", "\n", "\n", "self", ".", "env_padding", "=", "'ENV_PADDING'", "in", "config", "and", "config", "[", "'ENV_PADDING'", "]", "\n", "\n", "file_suffix", "=", "''", "\n", "if", "suffix", ":", "\n", "            ", "file_suffix", "=", "'_'", "+", "str", "(", "seed", ")", "\n", "\n", "", "self", ".", "replay_path", "=", "os", ".", "path", ".", "join", "(", "self", ".", "log_path", ",", "\n", "\"replay%s.txt\"", "%", "file_suffix", ")", "+", "'.%04d'", "\n", "self", ".", "replay_count", "=", "0", "\n", "config_dict", "=", "{", "\n", "\"interval\"", ":", "self", ".", "config", "[", "\"INTERVAL\"", "]", ",", "\n", "\"seed\"", ":", "seed", ",", "\n", "\"dir\"", ":", "\"\"", ",", "\n", "\"roadnetFile\"", ":", "os", ".", "path", ".", "join", "(", "self", ".", "work_folder", ",", "\n", "self", ".", "config", "[", "'ROADNET_FILE'", "]", ")", ",", "\n", "\"flowFile\"", ":", "os", ".", "path", ".", "join", "(", "self", ".", "work_folder", ",", "\n", "self", ".", "config", "[", "\"FLOW_FILE\"", "]", ")", ",", "\n", "\"rlTrafficLight\"", ":", "True", ",", "\n", "\"laneChange\"", ":", "True", ",", "\n", "\"saveReplay\"", ":", "self", ".", "config", "[", "\"SAVEREPLAY\"", "]", ",", "\n", "\"roadnetLogFile\"", ":", "os", ".", "path", ".", "join", "(", "self", ".", "log_path", ",", "\n", "\"roadnet%s.json\"", "%", "file_suffix", ")", ",", "\n", "\"replayLogFile\"", ":", "self", ".", "replay_path", "%", "self", ".", "replay_count", "\n", "}", "\n", "\n", "if", "'linux'", "not", "in", "sys", ".", "platform", ":", "\n", "            ", "print", "(", "'[WARN ] not in linux platform, some log from CityFlowEnv '", "\n", "'can\\'t be recorded in log file!'", ")", "\n", "\n", "", "config_path", "=", "os", ".", "path", ".", "join", "(", "log_path", ",", "\"cityflow_config%s\"", "%", "file_suffix", ")", "\n", "self", ".", "config_path", "=", "config_path", "\n", "with", "open", "(", "config_path", ",", "\"w\"", ")", "as", "f", ":", "\n", "            ", "json", ".", "dump", "(", "config_dict", ",", "f", ")", "\n", "self", ".", "log", "(", "\"dump cityflow config:\"", ",", "config_path", ",", "level", "=", "'TRACE'", ")", "\n", "# print(config_path, log)", "\n", "", "if", "len", "(", "logfile", ")", ">", "0", ":", "\n", "            ", "logfile", "=", "os", ".", "path", ".", "join", "(", "log_path", ",", "'%s%s'", "%", "(", "logfile", ",", "file_suffix", ")", ")", "\n", "self", ".", "logfile", "=", "logfile", "\n", "", "self", ".", "init_engine", "(", ")", "\n", "\n", "self", ".", "list_inter_log", "=", "None", "\n", "\n", "# check min action time", "\n", "if", "self", ".", "config", "[", "\"MIN_ACTION_TIME\"", "]", "<=", "self", ".", "config", "[", "\"YELLOW_TIME\"", "]", ":", "\n", "            ", "self", ".", "log", "(", "\"MIN_ACTION_TIME should include YELLOW_TIME\"", ",", "\n", "level", "=", "\"ERROR\"", ")", "\n", "pass", "\n", "# raise ValueError", "\n", "\n", "", "roadnet_info_keys", "=", "list", "(", "self", ".", "config", "[", "'ROADNET_INFO'", "]", ".", "keys", "(", ")", ")", "\n", "roadnet_info_keys", ".", "sort", "(", ")", "\n", "virtual_inters", "=", "self", ".", "config", "[", "'VIRTUAL_INTERSECTION_NAMES'", "]", "\n", "virtual_inter_keys", "=", "list", "(", "virtual_inters", ".", "keys", "(", ")", ")", "\n", "virtual_inter_keys", ".", "sort", "(", ")", "\n", "self", ".", "virtual_road_out_lanes", "=", "np", ".", "zeros", "(", "(", "len", "(", "virtual_inters", ")", ",", "3", ")", ",", "int", ")", "\n", "self", ".", "virtual_direction_names", "=", "[", "\n", "'turn_left'", ",", "\n", "'go_straight'", ",", "\n", "'turn_right'", "\n", "]", "\n", "self", ".", "list_intersection", "=", "[", "Intersection", "(", "x", ",", "self", ".", "config", ",", "self", ".", "eng", ",", "\n", "roadnet_info_keys", ",", "virtual_inter_keys", ")", "\n", "for", "x", "in", "roadnet_info_keys", "]", "\n", "for", "inter", "in", "self", ".", "list_intersection", ":", "\n", "            ", "assert", "self", ".", "virtual_direction_names", "==", "inter", ".", "observation_space", "[", "\n", "'DirectionNames'", "\n", "]", "\n", "", "self", ".", "intername2idx", "=", "{", "}", "\n", "self", ".", "roadname2id", "=", "{", "}", "\n", "self", ".", "lanename2roaddirection", "=", "{", "}", "\n", "self", ".", "now_in_lane_vehicles", "=", "{", "}", "\n", "self", ".", "last_in_lane_vehicles", "=", "{", "}", "\n", "self", ".", "all_vehicles", "=", "set", "(", ")", "\n", "self", ".", "wait_ticks", "=", "0", "\n", "for", "num", ",", "inter", "in", "enumerate", "(", "self", ".", "list_intersection", ")", ":", "\n", "            ", "self", ".", "intername2idx", "[", "inter", ".", "ID", "]", "=", "num", "\n", "assert", "roadnet_info_keys", "[", "num", "]", "==", "inter", ".", "ID", "\n", "for", "rnum", ",", "rname", "in", "enumerate", "(", "inter", ".", "roadnames", ")", ":", "\n", "                ", "self", ".", "roadname2id", "[", "rname", "]", "=", "[", "num", ",", "rnum", "]", "\n", "", "", "for", "ID", "in", "virtual_inters", ":", "\n", "            ", "v_inter", "=", "virtual_inters", "[", "ID", "]", "\n", "num", "=", "virtual_inter_keys", ".", "index", "(", "ID", ")", "\n", "roadnames", "=", "list", "(", "v_inter", "[", "'connection'", "]", ".", "keys", "(", ")", ")", "\n", "assert", "len", "(", "roadnames", ")", "==", "1", "\n", "self", ".", "roadname2id", "[", "roadnames", "[", "0", "]", "]", "=", "[", "-", "1", "-", "num", ",", "0", "]", "\n", "", "for", "inter", "in", "self", ".", "list_intersection", ":", "\n", "            ", "inter", ".", "_set_road_links_in", "(", "self", ".", "roadname2id", ")", "\n", "for", "rl", "in", "inter", ".", "roadnet_info", "[", "'roadlinks'", "]", ":", "\n", "                ", "if", "rl", "[", "'startRoad'", "]", "in", "self", ".", "roadname2id", ":", "\n", "                    ", "num", ",", "rnum", "=", "self", ".", "roadname2id", "[", "rl", "[", "'startRoad'", "]", "]", "\n", "if", "num", "<", "0", ":", "\n", "                        ", "vid", "=", "-", "1", "-", "num", "\n", "typeid", "=", "self", ".", "virtual_direction_names", ".", "index", "(", "rl", "[", "'type'", "]", ")", "\n", "self", ".", "virtual_road_out_lanes", "[", "\n", "vid", ",", "typeid", "]", "+=", "rl", "[", "'lanenumber'", "]", "\n", "continue", "\n", "", "ninter", "=", "self", ".", "list_intersection", "[", "num", "]", "\n", "ninter", ".", "observation_space", "[", "'RoadOutLanes'", "]", "[", "rnum", "]", "[", "\n", "ninter", ".", "observation_space", "[", "'DirectionNames'", "]", ".", "index", "(", "\n", "rl", "[", "'type'", "]", ")", "\n", "]", "+=", "rl", "[", "'lanenumber'", "]", "\n", "", "", "", "for", "inter", "in", "self", ".", "list_intersection", ":", "\n", "            ", "inter", ".", "_update_lanename", "(", "self", ".", "lanename2roaddirection", ",", "\n", "self", ".", "list_intersection", ",", "\n", "self", ".", "now_in_lane_vehicles", ",", "\n", "self", ".", "last_in_lane_vehicles", ")", "\n", "# self.log(inter.ID, inter.observation_space)", "\n", "", "self", ".", "update_virtual_lanename", "(", "virtual_inters", ",", "virtual_inter_keys", ")", "\n", "# self.log(self.lanename2roaddirection)", "\n", "\n", "self", ".", "list_inter_log", "=", "[", "[", "]", "for", "i", "in", "range", "(", "len", "(", "self", ".", "list_intersection", ")", ")", "]", "\n", "\n", "self", ".", "_set_adj_mat", "(", ")", "\n", "self", ".", "_set_observation_space", "(", ")", "\n", "self", ".", "_set_action_space", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.update_virtual_lanename": [[622, 650], ["enumerate", "enumerate", "o_inter._get_road_id", "isinstance", "enumerate", "list", "range", "v_inter[].keys", "set", "set"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection._get_road_id"], ["", "def", "update_virtual_lanename", "(", "self", ",", "virtual_inters", ",", "virtual_inter_keys", ")", ":", "\n", "        ", "for", "v_num", ",", "v_inter_key", "in", "enumerate", "(", "virtual_inter_keys", ")", ":", "\n", "            ", "v_inter", "=", "virtual_inters", "[", "v_inter_key", "]", "\n", "rn", "=", "0", "\n", "rname", "=", "list", "(", "v_inter", "[", "'connection'", "]", ".", "keys", "(", ")", ")", "[", "0", "]", "\n", "toiname", "=", "v_inter", "[", "'connection'", "]", "[", "rname", "]", "[", "0", "]", "\n", "toid", "=", "-", "999", "\n", "for", "num", ",", "inter", "in", "enumerate", "(", "self", ".", "list_intersection", ")", ":", "\n", "                ", "if", "inter", ".", "ID", "==", "toiname", ":", "\n", "                    ", "toid", "=", "num", "\n", "break", "\n", "", "", "assert", "toid", ">=", "0", "\n", "o_inter", "=", "self", ".", "list_intersection", "[", "toid", "]", "\n", "torid", "=", "o_inter", ".", "_get_road_id", "(", "self", ".", "list_intersection", ",", "\n", "self", ",", "rn", ")", "\n", "assert", "isinstance", "(", "torid", ",", "list", ")", "\n", "for", "i", ",", "j", "in", "torid", ":", "\n", "                ", "if", "virtual_inter_keys", "[", "-", "1", "-", "i", "]", "==", "v_inter_key", ":", "\n", "                    ", "torid", "=", "j", "\n", "", "", "now_lanen", "=", "0", "\n", "dn", "=", "0", "\n", "for", "dn", ",", "d", "in", "enumerate", "(", "self", ".", "virtual_road_out_lanes", "[", "v_num", "]", ")", ":", "\n", "                ", "for", "_", "in", "range", "(", "d", ")", ":", "\n", "                    ", "lanename", "=", "'%s_%d'", "%", "(", "rname", ",", "now_lanen", ")", "\n", "now_lanen", "+=", "1", "\n", "self", ".", "lanename2roaddirection", "[", "lanename", "]", "=", "[", "toid", ",", "torid", ",", "dn", "]", "\n", "self", ".", "now_in_lane_vehicles", "[", "lanename", "]", "=", "set", "(", ")", "\n", "self", ".", "last_in_lane_vehicles", "[", "lanename", "]", "=", "set", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log": [[651, 658], ["utils.log.log", "print"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log"], ["", "", "", "", "def", "log", "(", "self", ",", "*", "argv", ",", "**", "kwargs", ")", ":", "\n", "        ", "if", "'linux'", "in", "sys", ".", "platform", ":", "\n", "            ", "log", "(", "*", "argv", ",", "**", "kwargs", ")", "\n", "", "else", ":", "\n", "            ", "level", "=", "'INFO'", "if", "'level'", "not", "in", "kwargs", "else", "kwargs", "[", "'level'", "]", "\n", "if", "level", "in", "[", "'INFO'", ",", "'WARN'", ",", "'ERROR'", "]", ":", "\n", "                ", "print", "(", "'[%-5s]'", "%", "level", ",", "*", "argv", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.init_engine": [[659, 661], ["cityflow.Engine"], "methods", ["None"], ["", "", "", "def", "init_engine", "(", "self", ")", ":", "\n", "        ", "self", ".", "eng", "=", "Engine", "(", "self", ".", "config_path", ",", "4", ",", "self", ".", "logfile", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._set_adj_mat": [[662, 679], ["len", "numpy.zeros", "CityFlowEnv.CityFlowEnv.config[].keys", "range", "CityFlowEnv.CityFlowEnv.intername2idx.keys", "CityFlowEnv.CityFlowEnv.intername2idx.keys"], "methods", ["None"], ["", "def", "_set_adj_mat", "(", "self", ")", ":", "\n", "        ", "n", "=", "len", "(", "self", ".", "list_intersection", ")", "\n", "self", ".", "adj_mat", "=", "np", ".", "zeros", "(", "(", "n", ",", "n", ")", ")", "\n", "self", ".", "adj_mat", "[", ":", "]", "=", "1e100", "\n", "for", "i", "in", "self", ".", "config", "[", "'ROADNET_INFO'", "]", ".", "keys", "(", ")", ":", "\n", "            ", "if", "i", "not", "in", "self", ".", "intername2idx", ".", "keys", "(", ")", ":", "\n", "                ", "continue", "\n", "", "iidx", "=", "self", ".", "intername2idx", "[", "i", "]", "\n", "conn", "=", "self", ".", "config", "[", "'ROADNET_INFO'", "]", "[", "i", "]", "[", "'connection'", "]", "\n", "for", "road", "in", "conn", ":", "\n", "                ", "j", ",", "dist", "=", "conn", "[", "road", "]", "\n", "if", "j", "not", "in", "self", ".", "intername2idx", ".", "keys", "(", ")", ":", "\n", "                    ", "continue", "\n", "", "jidx", "=", "self", ".", "intername2idx", "[", "j", "]", "\n", "self", ".", "adj_mat", "[", "iidx", ",", "jidx", "]", "=", "dist", "\n", "", "", "for", "i", "in", "range", "(", "n", ")", ":", "\n", "            ", "self", ".", "adj_mat", "[", "i", ",", "i", "]", "=", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._set_observation_space_one": [[680, 683], ["None"], "methods", ["None"], ["", "", "def", "_set_observation_space_one", "(", "self", ",", "i", ")", ":", "\n", "        ", "observation_space", "=", "self", ".", "list_intersection", "[", "i", "]", ".", "observation_space", "\n", "return", "observation_space", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._set_observation_space": [[684, 699], ["range", "len", "CityFlowEnv.CityFlowEnv.observation_space.append", "CityFlowEnv.CityFlowEnv._set_observation_space_one"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._set_observation_space_one"], ["", "def", "_set_observation_space", "(", "self", ")", ":", "\n", "        ", "self", ".", "observation_space", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "len", "(", "self", ".", "list_intersection", ")", ")", ":", "\n", "            ", "self", ".", "observation_space", ".", "append", "(", "self", ".", "_set_observation_space_one", "(", "i", ")", ")", "\n", "", "\"\"\"\n        for obs in self.observation_space:\n            if obs != self.observation_space[0] and self.env_padding and False:\n                self.log('observation space not all same, and env_padding is '\n                         'set, which is not implemented!', level = 'ERROR')\n                raise ValueError\n        \"\"\"", "\n", "self", ".", "observation_space", "=", "{", "\n", "'intersections'", ":", "self", ".", "observation_space", ",", "\n", "'virtual_intersection_out_lines'", ":", "self", ".", "virtual_road_out_lanes", ",", "\n", "'adj_mat'", ":", "self", ".", "adj_mat", "\n", "}", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._set_action_space_one": [[701, 703], ["None"], "methods", ["None"], ["", "def", "_set_action_space_one", "(", "self", ",", "i", ")", ":", "\n", "        ", "return", "self", ".", "list_intersection", "[", "i", "]", ".", "action_space", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._set_action_space": [[704, 715], ["range", "len", "CityFlowEnv.CityFlowEnv.action_space.append", "CityFlowEnv.CityFlowEnv._set_action_space_one"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._set_action_space_one"], ["", "def", "_set_action_space", "(", "self", ")", ":", "\n", "        ", "self", ".", "action_space", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "len", "(", "self", ".", "list_intersection", ")", ")", ":", "\n", "            ", "self", ".", "action_space", ".", "append", "(", "self", ".", "_set_action_space_one", "(", "i", ")", ")", "\n", "", "\"\"\"\n        for act in self.action_space:\n            if act != self.action_space[0] and self.env_padding:\n                self.log('action space not all same, and env_padding is set, '\n                         'which is not implemented!', level = 'ERROR')\n                raise ValueError\n        \"\"\"", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.reset": [[716, 744], ["CityFlowEnv.CityFlowEnv.eng.reset", "CityFlowEnv.CityFlowEnv.all_vehicles.clear", "CityFlowEnv.CityFlowEnv._collect_state", "CityFlowEnv.CityFlowEnv.eng.set_replay_file", "utils.utils.gzip_file", "inter.reset", "inter.step_time", "set", "set"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.reset", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._collect_state", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.gzip_file", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.reset", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.step_time"], ["", "def", "reset", "(", "self", ")", ":", "\n", "        ", "self", ".", "eng", ".", "reset", "(", ")", "\n", "self", ".", "replay_count", "+=", "1", "\n", "# self.eng.set_random_seed(self.seed + self.replay_count)", "\n", "if", "self", ".", "config", "[", "'SAVEREPLAY'", "]", ":", "\n", "            ", "self", ".", "eng", ".", "set_replay_file", "(", "self", ".", "replay_path", "%", "self", ".", "replay_count", ")", "\n", "old_replay", "=", "self", ".", "replay_path", "%", "(", "self", ".", "replay_count", "-", "1", ")", "\n", "gzip_file", "(", "old_replay", ")", "\n", "\n", "# reset intersections (grid)", "\n", "", "for", "inter", "in", "self", ".", "list_intersection", ":", "\n", "            ", "inter", ".", "reset", "(", ")", "\n", "\n", "# get new measurements", "\n", "", "for", "inter", "in", "self", ".", "list_intersection", ":", "\n", "            ", "inter", ".", "step_time", "(", ")", "\n", "\n", "# self.flow_generator.reset()", "\n", "\n", "", "for", "k", "in", "self", ".", "now_in_lane_vehicles", ":", "\n", "            ", "self", ".", "now_in_lane_vehicles", "[", "k", "]", "=", "set", "(", ")", "\n", "", "for", "k", "in", "self", ".", "last_in_lane_vehicles", ":", "\n", "            ", "self", ".", "last_in_lane_vehicles", "[", "k", "]", "=", "set", "(", ")", "\n", "", "self", ".", "all_vehicles", ".", "clear", "(", ")", "\n", "self", ".", "wait_ticks", "=", "0", "\n", "\n", "state", "=", "self", ".", "_collect_state", "(", ")", "\n", "return", "state", ",", "{", "'average_time'", ":", "0.0", ",", "'average_delay'", ":", "0.0", "}", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._collect_state": [[745, 751], ["res.append", "inter.get_state"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.get_state"], ["", "def", "_collect_state", "(", "self", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "inter", "in", "self", ".", "list_intersection", ":", "\n", "            ", "res", ".", "append", "(", "inter", ".", "get_state", "(", ")", ")", "\n", "# self.log(inter.ID, res[-1]['InLaneVehicleNumber'], level='TRACE')", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._collect_reward": [[752, 757], ["numpy.array", "rew.append", "inter.get_reward"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.get_reward"], ["", "def", "_collect_reward", "(", "self", ")", ":", "\n", "        ", "rew", "=", "[", "]", "\n", "for", "inter", "in", "self", ".", "list_intersection", ":", "\n", "            ", "rew", ".", "append", "(", "inter", ".", "get_reward", "(", "self", ".", "config", "[", "'REWARD_INFO'", "]", ")", ")", "\n", "", "return", "np", ".", "array", "(", "rew", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._is_done": [[758, 760], ["CityFlowEnv.CityFlowEnv.eng.get_current_time"], "methods", ["None"], ["", "def", "_is_done", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "eng", ".", "get_current_time", "(", ")", ">=", "self", ".", "config", "[", "'EPISODE_LEN'", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._average_time": [[761, 763], ["CityFlowEnv.CityFlowEnv.eng.get_average_travel_time"], "methods", ["None"], ["", "def", "_average_time", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "eng", ".", "get_average_travel_time", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._average_delay": [[764, 766], ["CityFlowEnv.CityFlowEnv.eng.get_average_delay"], "methods", ["None"], ["", "def", "_average_delay", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "eng", ".", "get_average_delay", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.step": [[767, 794], ["numpy.zeros", "range", "NotImplementedError", "len", "CityFlowEnv.CityFlowEnv._inner_step", "CityFlowEnv.CityFlowEnv._collect_state", "CityFlowEnv.CityFlowEnv._collect_reward", "CityFlowEnv.CityFlowEnv._is_done", "CityFlowEnv.CityFlowEnv._average_time", "CityFlowEnv.CityFlowEnv._average_delay", "CityFlowEnv.CityFlowEnv.eng.get_current_time", "CityFlowEnv.CityFlowEnv.step_lane_vehicles", "len", "len", "len", "CityFlowEnv.CityFlowEnv.eng.get_vehicles", "len"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._inner_step", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._collect_state", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._collect_reward", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._is_done", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._average_time", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._average_delay", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.step_lane_vehicles"], ["", "def", "step", "(", "self", ",", "action", ")", ":", "\n", "        ", "if", "self", ".", "config", "[", "'ACTION_PATTERN'", "]", "==", "'switch'", ":", "\n", "            ", "raise", "NotImplementedError", "(", "'ACTION_PATTERN `switch` '", "\n", "'is not implemented'", ")", "\n", "\n", "", "all_reward", "=", "np", ".", "zeros", "(", "len", "(", "self", ".", "list_intersection", ")", ",", "dtype", "=", "'float'", ")", "\n", "for", "i", "in", "range", "(", "self", ".", "config", "[", "'MIN_ACTION_TIME'", "]", ")", ":", "\n", "            ", "if", "i", "==", "0", ":", "\n", "                ", "self", ".", "step_lane_vehicles", "(", ")", "\n", "", "self", ".", "_inner_step", "(", "action", ",", "self", ".", "config", "[", "'ACTION_PATTERN'", "]", ")", "\n", "state", "=", "self", ".", "_collect_state", "(", ")", "\n", "all_reward", "+=", "self", ".", "_collect_reward", "(", ")", "\n", "done", "=", "self", ".", "_is_done", "(", ")", "\n", "\n", "", "all_reward", "/=", "self", ".", "config", "[", "'MIN_ACTION_TIME'", "]", "\n", "\n", "infos", "=", "{", "\n", "'average_time'", ":", "self", ".", "_average_time", "(", ")", ",", "\n", "'average_delay'", ":", "self", ".", "_average_delay", "(", ")", ",", "\n", "'current_time'", ":", "self", ".", "eng", ".", "get_current_time", "(", ")", ",", "\n", "'throughput'", ":", "(", "len", "(", "self", ".", "all_vehicles", ")", "\n", "-", "len", "(", "self", ".", "eng", ".", "get_vehicles", "(", "True", ")", ")", ")", ",", "\n", "'average_wait_time'", ":", "self", ".", "wait_ticks", "/", "len", "(", "self", ".", "all_vehicles", ")", "if", "len", "(", "self", ".", "all_vehicles", ")", "else", "-", "1", ",", "\n", "}", "\n", "\n", "return", "state", ",", "all_reward", ",", "done", ",", "infos", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.step_lane_vehicles": [[795, 804], ["None"], "methods", ["None"], ["", "def", "step_lane_vehicles", "(", "self", ")", ":", "\n", "        ", "for", "inter", "in", "self", ".", "list_intersection", ":", "\n", "            ", "inter", ".", "lane_vehicle_count_mat", "[", ":", "-", "1", "]", "=", "inter", ".", "lane_vehicle_count_mat", "[", "1", ":", "]", "\n", "inter", ".", "lane_vehicle_count_mat", "[", "-", "1", "]", "=", "0", "\n", "inter", ".", "lane_vehicle_out_count_mat", "[", ":", "-", "1", "]", "=", "inter", ".", "lane_vehicle_out_count_mat", "[", "1", ":", "]", "\n", "inter", ".", "lane_vehicle_out_count_mat", "[", "-", "1", "]", "=", "0", "\n", "inter", ".", "saved_phases", "[", ":", "-", "1", "]", "=", "inter", ".", "saved_phases", "[", "1", ":", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.update_lane_vehicles": [[805, 828], ["lane_vehicles.items", "CityFlowEnv.CityFlowEnv.now_in_lane_vehicles[].copy", "CityFlowEnv.CityFlowEnv.now_in_lane_vehicles[].clear", "len", "len", "CityFlowEnv.CityFlowEnv.now_in_lane_vehicles[].add"], "methods", ["None"], ["", "", "def", "update_lane_vehicles", "(", "self", ",", "lane_vehicles", ")", ":", "\n", "        ", "for", "i", "in", "self", ".", "now_in_lane_vehicles", ":", "# copy current to last", "\n", "            ", "self", ".", "last_in_lane_vehicles", "[", "i", "]", "=", "self", ".", "now_in_lane_vehicles", "[", "i", "]", ".", "copy", "(", ")", "\n", "self", ".", "now_in_lane_vehicles", "[", "i", "]", ".", "clear", "(", ")", "\n", "\n", "# for i in self.now_in_lane_vehicles:", "\n", "# self.now_in_lane_vehicles[i].clear()", "\n", "", "for", "k", ",", "vs", "in", "lane_vehicles", ".", "items", "(", ")", ":", "\n", "            ", "if", "k", "in", "self", ".", "lanename2roaddirection", ":", "\n", "                ", "for", "v", "in", "vs", ":", "\n", "                    ", "if", "'shadow'", "in", "v", ":", "\n", "                        ", "continue", "\n", "", "self", ".", "now_in_lane_vehicles", "[", "k", "]", ".", "add", "(", "v", ")", "\n", "\n", "", "", "", "for", "k", "in", "self", ".", "now_in_lane_vehicles", ":", "\n", "            ", "i", ",", "r", ",", "d", "=", "self", ".", "lanename2roaddirection", "[", "k", "]", "\n", "inter", "=", "self", ".", "list_intersection", "[", "i", "]", "\n", "inter", ".", "lane_vehicle_count_mat", "[", "-", "1", ",", "r", ",", "d", "]", "+=", "len", "(", "self", ".", "now_in_lane_vehicles", "[", "k", "]", "\n", "-", "self", ".", "last_in_lane_vehicles", "[", "k", "]", ")", "\n", "inter", ".", "lane_vehicle_out_count_mat", "[", "-", "1", ",", "r", ",", "d", "]", "+=", "len", "(", "self", ".", "last_in_lane_vehicles", "[", "k", "]", "\n", "-", "self", ".", "now_in_lane_vehicles", "[", "k", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv._inner_step": [[829, 850], ["zip", "range", "inter.update_old", "inter.act", "int", "CityFlowEnv.CityFlowEnv.eng.next_step", "inter.step_time", "CityFlowEnv.CityFlowEnv.eng.get_lane_vehicles", "CityFlowEnv.CityFlowEnv.eng.get_vehicles", "len", "CityFlowEnv.CityFlowEnv.eng.get_vehicle_speed", "CityFlowEnv.CityFlowEnv.update_lane_vehicles", "CityFlowEnv.CityFlowEnv.all_vehicles.add"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.update_old", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.act", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.Intersection.step_time", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.update_lane_vehicles"], ["", "", "def", "_inner_step", "(", "self", ",", "actions", ",", "pattern", ")", ":", "\n", "        ", "for", "action", ",", "inter", "in", "zip", "(", "actions", ",", "self", ".", "list_intersection", ")", ":", "\n", "            ", "inter", ".", "update_old", "(", ")", "\n", "inter", ".", "act", "(", "action", ",", "pattern", ")", "\n", "", "for", "i", "in", "range", "(", "int", "(", "1", "/", "self", ".", "config", "[", "'INTERVAL'", "]", ")", ")", ":", "\n", "# self.flow_generator.check(self.eng.get_current_time())", "\n", "            ", "self", ".", "eng", ".", "next_step", "(", ")", "# catch errors and report to above", "\n", "if", "'NOT_COUNT_VEHICLE_VOLUME'", "not", "in", "self", ".", "config", "or", "not", "self", ".", "config", "[", "'NOT_COUNT_VEHICLE_VOLUME'", "]", ":", "\n", "                ", "lane_vehicles", "=", "self", ".", "eng", ".", "get_lane_vehicles", "(", ")", "\n", "vehicles", "=", "self", ".", "eng", ".", "get_vehicles", "(", "include_waiting", "=", "True", ")", "\n", "for", "v", "in", "vehicles", ":", "\n", "                    ", "self", ".", "all_vehicles", ".", "add", "(", "v", ")", "\n", "", "self", ".", "wait_ticks", "+=", "len", "(", "vehicles", ")", "\n", "v_speeds", "=", "self", ".", "eng", ".", "get_vehicle_speed", "(", ")", "\n", "for", "v", "in", "v_speeds", ":", "\n", "                    ", "if", "v_speeds", "[", "v", "]", ">", "0.1", ":", "\n", "                        ", "self", ".", "wait_ticks", "-=", "1", "\n", "", "", "self", ".", "update_lane_vehicles", "(", "lane_vehicles", ")", "\n", "", "", "for", "inter", "in", "self", ".", "list_intersection", ":", "\n", "            ", "inter", ".", "step_time", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.get_default_action": [[851, 853], ["x.get_default_action"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.get_default_action"], ["", "", "def", "get_default_action", "(", "self", ")", ":", "\n", "        ", "return", "[", "x", ".", "get_default_action", "(", ")", "for", "x", "in", "self", ".", "list_intersection", "]", "", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvWorker.__init__": [[12, 19], ["multiprocessing.Process.__init__"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "env", ",", "envargs", ",", "pipe1", ",", "pipe2", ",", "index", "=", "-", "1", ")", ":", "\n", "        ", "multiprocessing", ".", "Process", ".", "__init__", "(", "self", ",", "daemon", "=", "True", ")", "\n", "self", ".", "pipe", "=", "pipe1", "\n", "self", ".", "pipe2", "=", "pipe2", "\n", "self", ".", "envargs", "=", "envargs", "\n", "self", ".", "env", "=", "env", "\n", "self", ".", "index", "=", "index", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvWorker.run": [[20, 60], ["SubprocVecEnv.EnvWorker.env", "SubprocVecEnv.EnvWorker.pipe2.close", "SubprocVecEnv.EnvWorker.pipe.recv", "SubprocVecEnv.EnvWorker.pipe.send", "SubprocVecEnv.EnvWorker.pipe.close", "SubprocVecEnv.EnvWorker.pipe.close", "SubprocVecEnv.EnvWorker.pipe.close", "log", "SubprocVecEnv.EnvWorker.pipe.close", "SubprocVecEnv.EnvWorker.env.step", "SubprocVecEnv.EnvWorker.pipe.close", "SubprocVecEnv.EnvWorker.pipe.send", "SubprocVecEnv.EnvWorker.env.reset", "SubprocVecEnv.EnvWorker.pipe.send", "SubprocVecEnv.EnvWorker.pipe.send", "SubprocVecEnv.EnvWorker.pipe.send", "isinstance", "SubprocVecEnv.EnvWorker.pipe.send", "SubprocVecEnv.EnvWorker.env.get_default_action"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.reset", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.get_default_action"], ["", "def", "run", "(", "self", ")", ":", "\n", "        ", "self", ".", "env", "=", "self", ".", "env", "(", "*", "self", ".", "envargs", ")", "\n", "self", ".", "pipe2", ".", "close", "(", ")", "\n", "while", "True", ":", "\n", "            ", "try", ":", "\n", "                ", "cmd", ",", "data", "=", "self", ".", "pipe", ".", "recv", "(", ")", "\n", "# print(self.index, 'Worker', cmd)", "\n", "if", "cmd", "==", "'step'", ":", "\n", "                    ", "self", ".", "pipe", ".", "send", "(", "self", ".", "env", ".", "step", "(", "data", ")", ")", "\n", "", "elif", "cmd", "==", "'close'", ":", "\n", "                    ", "self", ".", "pipe", ".", "close", "(", ")", "\n", "break", "\n", "", "elif", "cmd", "==", "'reset'", ":", "\n", "                    ", "self", ".", "pipe", ".", "send", "(", "self", ".", "env", ".", "reset", "(", ")", ")", "\n", "", "elif", "cmd", "==", "'observation_space'", ":", "\n", "                    ", "self", ".", "pipe", ".", "send", "(", "self", ".", "env", ".", "observation_space", ")", "\n", "", "elif", "cmd", "==", "'action_space'", ":", "\n", "                    ", "self", ".", "pipe", ".", "send", "(", "self", ".", "env", ".", "action_space", ")", "\n", "", "elif", "cmd", "==", "'replay_count'", ":", "\n", "                    ", "if", "data", "is", "not", "None", ":", "\n", "                        ", "assert", "isinstance", "(", "data", ",", "int", ")", "\n", "self", ".", "env", ".", "replay_count", "=", "data", "\n", "", "self", ".", "pipe", ".", "send", "(", "self", ".", "env", ".", "replay_count", ")", "\n", "", "elif", "cmd", "==", "'get_default_action'", ":", "\n", "                    ", "self", ".", "pipe", ".", "send", "(", "self", ".", "env", ".", "get_default_action", "(", ")", ")", "\n", "", "else", ":", "\n", "                    ", "raise", "NotImplementedError", "\n", "", "", "except", "EOFError", ":", "\n", "                ", "self", ".", "pipe", ".", "close", "(", ")", "\n", "break", "\n", "", "except", "IndexError", ":", "\n", "                ", "self", ".", "pipe", ".", "close", "(", ")", "\n", "break", "\n", "", "except", "KeyboardInterrupt", ":", "\n", "                ", "self", ".", "pipe", ".", "close", "(", ")", "\n", "break", "\n", "", "except", "Exception", "as", "e", ":", "\n", "                ", "log", "(", "'Unknown exception!'", ",", "e", ")", "\n", "self", ".", "pipe", ".", "close", "(", ")", "\n", "break", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.__init__": [[63, 109], ["zip", "enumerate", "SubprocVecEnv.EnvVecs._set_observation_space", "SubprocVecEnv.EnvVecs._set_action_space", "range", "zip", "SubprocVecEnv.EnvWorker", "EnvWorker.start", "SubprocVecEnv.EnvVecs.processes.append", "work_remote.close", "args.append", "range", "len", "args.append", "log", "range", "list", "list", "multiprocessing.Pipe", "range"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs._set_observation_space", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs._set_action_space", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log"], ["    ", "def", "__init__", "(", "self", ",", "env_class", ",", "n_envs", ",", "env_args", ",", "arg_seed_pos", "=", "-", "1", ",", "\n", "seed", "=", "0", ",", "is_args_list", "=", "False", ",", "stagger", "=", "False", ",", "\n", "auto_reset", "=", "False", ")", ":", "\n", "        ", "self", ".", "waiting", "=", "False", "\n", "self", ".", "closed", "=", "False", "\n", "\n", "if", "not", "is_args_list", ":", "\n", "            ", "args", "=", "[", "]", "\n", "for", "_", "in", "range", "(", "n_envs", ")", ":", "\n", "                ", "args", ".", "append", "(", "list", "(", "env_args", ")", ")", "\n", "", "if", "arg_seed_pos", "!=", "-", "1", ":", "\n", "                ", "for", "i", "in", "range", "(", "n_envs", ")", ":", "\n", "                    ", "args", "[", "i", "]", "[", "arg_seed_pos", "]", "=", "seed", "+", "i", "\n", "", "", "env_args", "=", "args", "\n", "", "else", ":", "\n", "            ", "assert", "(", "len", "(", "env_args", ")", "==", "n_envs", ")", "\n", "args", "=", "[", "]", "\n", "for", "a", "in", "env_args", ":", "\n", "                ", "args", ".", "append", "(", "list", "(", "a", ")", ")", "\n", "", "if", "arg_seed_pos", "!=", "-", "1", ":", "\n", "                ", "log", "(", "'set seed pos when use args list, '", "\n", "'will change seed in args list.'", ",", "level", "=", "'WARN'", ")", "\n", "for", "i", "in", "range", "(", "n_envs", ")", ":", "\n", "                    ", "args", "[", "i", "]", "[", "arg_seed_pos", "]", "=", "seed", "+", "i", "\n", "", "", "env_args", "=", "args", "\n", "\n", "", "self", ".", "remotes", ",", "self", ".", "work_remotes", "=", "zip", "(", "\n", "*", "[", "multiprocessing", ".", "Pipe", "(", "duplex", "=", "True", ")", "for", "_", "in", "range", "(", "n_envs", ")", "]", ")", "\n", "self", ".", "processes", "=", "[", "]", "\n", "for", "num", ",", "[", "args", ",", "work_remote", ",", "remote", "]", "in", "enumerate", "(", "zip", "(", "\n", "env_args", ",", "\n", "self", ".", "work_remotes", ",", "\n", "self", ".", "remotes", ")", ")", ":", "\n", "# args = (env_class, work_remote, remote)", "\n", "# daemon=True: if the main process crashes, ", "\n", "#              we should not cause things to hang", "\n", "            ", "process", "=", "EnvWorker", "(", "env_class", ",", "args", ",", "work_remote", ",", "remote", ",", "num", ")", "\n", "process", ".", "start", "(", ")", "\n", "self", ".", "processes", ".", "append", "(", "process", ")", "\n", "work_remote", ".", "close", "(", ")", "\n", "", "self", ".", "is_reset", "=", "False", "\n", "self", ".", "need_stagger", "=", "stagger", "\n", "self", ".", "auto_reset", "=", "auto_reset", "\n", "\n", "self", ".", "_set_observation_space", "(", ")", "\n", "self", ".", "_set_action_space", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs._set_observation_space": [[110, 113], ["SubprocVecEnv.EnvVecs.remotes[].send", "SubprocVecEnv.EnvVecs.remotes[].recv"], "methods", ["None"], ["", "def", "_set_observation_space", "(", "self", ")", ":", "\n", "        ", "self", ".", "remotes", "[", "0", "]", ".", "send", "(", "(", "'observation_space'", ",", "None", ")", ")", "\n", "self", ".", "observation_space", "=", "self", ".", "remotes", "[", "0", "]", ".", "recv", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs._set_action_space": [[114, 117], ["SubprocVecEnv.EnvVecs.remotes[].send", "SubprocVecEnv.EnvVecs.remotes[].recv"], "methods", ["None"], ["", "def", "_set_action_space", "(", "self", ")", ":", "\n", "        ", "self", ".", "remotes", "[", "0", "]", ".", "send", "(", "(", "'action_space'", ",", "None", ")", ")", "\n", "self", ".", "action_space", "=", "self", ".", "remotes", "[", "0", "]", ".", "recv", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step_async": [[118, 122], ["zip", "remote.send"], "methods", ["None"], ["", "def", "step_async", "(", "self", ",", "actions", ")", ":", "\n", "        ", "for", "remote", ",", "action", "in", "zip", "(", "self", ".", "remotes", ",", "actions", ")", ":", "\n", "            ", "remote", ".", "send", "(", "(", "'step'", ",", "action", ")", ")", "\n", "", "self", ".", "waiting", "=", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step_wait": [[123, 136], ["zip", "list", "list", "remote.recv", "enumerate", "numpy.stack", "numpy.stack", "remote.send", "remote.recv"], "methods", ["None"], ["", "def", "step_wait", "(", "self", ")", ":", "\n", "        ", "results", "=", "[", "remote", ".", "recv", "(", ")", "for", "remote", "in", "self", ".", "remotes", "]", "\n", "self", ".", "waiting", "=", "False", "\n", "obs", ",", "rews", ",", "ists", ",", "infos", "=", "zip", "(", "*", "results", ")", "\n", "obs", "=", "list", "(", "obs", ")", "\n", "infos", "=", "list", "(", "infos", ")", "\n", "# very ugly auto reset implementation", "\n", "if", "self", ".", "auto_reset", ":", "\n", "            ", "for", "num", ",", "remote", "in", "enumerate", "(", "self", ".", "remotes", ")", ":", "\n", "                ", "if", "ists", "[", "num", "]", ":", "\n", "                    ", "remote", ".", "send", "(", "(", "'reset'", ",", "None", ")", ")", "\n", "obs", "[", "num", "]", ",", "_", "=", "remote", ".", "recv", "(", ")", "\n", "", "", "", "return", "obs", ",", "np", ".", "stack", "(", "rews", ")", ",", "np", ".", "stack", "(", "ists", ")", ",", "infos", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step": [[137, 141], ["SubprocVecEnv.EnvVecs.step_async", "SubprocVecEnv.EnvVecs.step_wait"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step_async", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step_wait"], ["", "def", "step", "(", "self", ",", "actions", ")", ":", "\n", "        ", "assert", "(", "self", ".", "is_reset", ")", "\n", "self", ".", "step_async", "(", "actions", ")", "\n", "return", "self", ".", "step_wait", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close": [[142, 153], ["remote.send", "process.join", "remote.recv"], "methods", ["None"], ["", "def", "close", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "closed", ":", "\n", "            ", "return", "\n", "", "if", "self", ".", "waiting", ":", "\n", "            ", "for", "remote", "in", "self", ".", "remotes", ":", "\n", "                ", "remote", ".", "recv", "(", ")", "\n", "", "", "for", "remote", "in", "self", ".", "remotes", ":", "\n", "            ", "remote", ".", "send", "(", "(", "'close'", ",", "None", ")", ")", "\n", "", "for", "process", "in", "self", ".", "processes", ":", "\n", "            ", "process", ".", "join", "(", ")", "\n", "", "self", ".", "closed", "=", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.reset": [[154, 163], ["zip", "remote.send", "remote.recv", "SubprocVecEnv.EnvVecs.stagger"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.stagger"], ["", "def", "reset", "(", "self", ",", "**", "kwargs", ")", ":", "\n", "        ", "for", "remote", "in", "self", ".", "remotes", ":", "\n", "            ", "remote", ".", "send", "(", "(", "'reset'", ",", "None", ")", ")", "\n", "", "results", "=", "[", "remote", ".", "recv", "(", ")", "for", "remote", "in", "self", ".", "remotes", "]", "\n", "if", "self", ".", "need_stagger", ":", "\n", "            ", "results", "=", "self", ".", "stagger", "(", "**", "kwargs", ",", "prev_results", "=", "results", ")", "\n", "", "obs", ",", "infos", "=", "zip", "(", "*", "results", ")", "\n", "self", ".", "is_reset", "=", "True", "\n", "return", "obs", ",", "infos", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.replay_count": [[164, 171], ["remote.send", "remote.recv", "numpy.array"], "methods", ["None"], ["", "def", "replay_count", "(", "self", ",", "setnum", "=", "None", ")", ":", "\n", "        ", "for", "remote", "in", "self", ".", "remotes", ":", "\n", "            ", "remote", ".", "send", "(", "(", "'replay_count'", ",", "setnum", ")", ")", "\n", "", "results", "=", "[", "remote", ".", "recv", "(", ")", "for", "remote", "in", "self", ".", "remotes", "]", "\n", "if", "setnum", "is", "not", "None", ":", "\n", "            ", "assert", "(", "np", ".", "array", "(", "results", ")", "==", "results", "[", "0", "]", ")", ".", "all", "(", ")", "\n", "", "return", "results", "[", "0", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.stagger": [[172, 199], ["len", "SubprocVecEnv.EnvVecs.get_default_action", "enumerate", "zip", "range", "remote.send", "remote.recv"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.get_default_action"], ["", "def", "stagger", "(", "self", ",", "maximum_length", ",", "prev_results", ")", ":", "\n", "        ", "\"\"\"stagger environments action steps, make every environment in different\n            stage.\n        \"\"\"", "\n", "total", "=", "len", "(", "self", ".", "remotes", ")", "\n", "default_actions", "=", "self", ".", "get_default_action", "(", ")", "\n", "\"\"\"\n        deltas = [0] * len(self.remotes)\n        for i in range(len(self.remotes)):\n            deltas[i] = maximum_length * i // total\n        for step in range(max(deltas)):\n            step_idx = []\n            for idx in range(len(self.remotes)):\n                if step < deltas[idx]:\n                    step_idx.append(idx)\n            for idx in step_idx:\n                self.remotes[idx].send(('step', default_actions[idx]))\n            for idx in step_idx:\n                prev_results[idx] = self.remotes[idx].recv\n        \"\"\"", "\n", "for", "num", ",", "(", "default_action", ",", "remote", ")", "in", "enumerate", "(", "zip", "(", "default_actions", ",", "\n", "self", ".", "remotes", ")", ")", ":", "\n", "            ", "delta", "=", "maximum_length", "*", "num", "//", "total", "\n", "for", "_", "in", "range", "(", "delta", ")", ":", "\n", "                ", "remote", ".", "send", "(", "(", "'step'", ",", "default_action", ")", ")", "\n", "prev_results", "[", "num", "]", "=", "remote", ".", "recv", "(", ")", "\n", "", "", "return", "prev_results", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.get_default_action": [[200, 204], ["remote.send", "remote.recv"], "methods", ["None"], ["", "def", "get_default_action", "(", "self", ")", ":", "\n", "        ", "for", "remote", "in", "self", ".", "remotes", ":", "\n", "            ", "remote", ".", "send", "(", "(", "'get_default_action'", ",", "None", ")", ")", "\n", "", "return", "[", "remote", ".", "recv", "(", ")", "for", "remote", "in", "self", ".", "remotes", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.getCityFlowEnvVec": [[206, 225], ["range", "SubprocVecEnv.EnvVecs", "isinstance", "env_args.append", "os.makedirs"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "", "def", "getCityFlowEnvVec", "(", "number", ",", "logpath", ",", "workpath", ",", "config", ",", "seed", "=", "0", ",", "log", "=", "''", ",", "\n", "**", "kwargs", ")", ":", "\n", "    ", "if", "not", "isinstance", "(", "config", ",", "list", ")", ":", "\n", "        ", "config", "=", "[", "config", "]", "*", "number", "\n", "", "env_args", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "number", ")", ":", "\n", "        ", "env_args", ".", "append", "(", "[", "logpath", "+", "'/%s/'", "%", "i", ",", "\n", "workpath", ",", "\n", "config", "[", "i", "]", ",", "\n", "log", ",", "\n", "seed", "+", "i", ",", "\n", "False", "]", ")", "\n", "os", ".", "makedirs", "(", "env_args", "[", "-", "1", "]", "[", "0", "]", ",", "exist_ok", "=", "True", ")", "\n", "\n", "", "return", "EnvVecs", "(", "CityFlowEnv", ",", "\n", "number", ",", "\n", "env_args", ",", "\n", "is_args_list", "=", "True", ",", "\n", "**", "kwargs", ")", "\n", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorages.__init__": [[11, 16], ["range", "storage.RolloutStorages.rollouts.append", "storage.RolloutStorage"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["def", "__init__", "(", "self", ",", "threads", ",", "*", "argv", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "rollouts", "=", "[", "]", "\n", "self", ".", "threads", "=", "threads", "\n", "for", "_", "in", "range", "(", "threads", ")", ":", "\n", "            ", "self", ".", "rollouts", ".", "append", "(", "RolloutStorage", "(", "*", "argv", ",", "**", "kwargs", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorages.call_rollout_functions": [[17, 51], ["zip", "enumerate", "enumerate", "res.append", "len", "len", "i.append", "i.append", "getattr"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "", "def", "call_rollout_functions", "(", "self", ",", "name", ")", ":", "\n", "        ", "def", "func", "(", "*", "argv", ",", "**", "kwargs", ")", ":", "\n", "            ", "res", "=", "[", "]", "\n", "splitv", "=", "[", "[", "]", "for", "_", "in", "self", ".", "rollouts", "]", "\n", "kwsplits", "=", "[", "{", "}", "for", "_", "in", "self", ".", "rollouts", "]", "\n", "for", "arg", "in", "argv", ":", "\n", "                ", "alen", "=", "None", "\n", "try", ":", "\n", "                    ", "alen", "=", "len", "(", "arg", ")", "\n", "", "except", "Exception", ":", "\n", "                    ", "pass", "\n", "", "assert", "alen", "is", "None", "or", "alen", "==", "self", ".", "threads", "\n", "for", "num", ",", "i", "in", "enumerate", "(", "splitv", ")", ":", "\n", "                    ", "if", "alen", "is", "None", ":", "\n", "                        ", "i", ".", "append", "(", "arg", ")", "\n", "", "else", ":", "\n", "                        ", "i", ".", "append", "(", "arg", "[", "num", "]", ")", "\n", "", "", "", "for", "key", "in", "kwargs", ":", "\n", "                ", "arg", "=", "kwargs", "[", "key", "]", "\n", "klen", "=", "None", "\n", "try", ":", "\n", "                    ", "klen", "=", "len", "(", "arg", ")", "\n", "", "except", "Exception", ":", "\n", "                    ", "pass", "\n", "", "assert", "klen", "is", "None", "or", "klen", "==", "self", ".", "threads", "\n", "for", "num", ",", "i", "in", "enumerate", "(", "kwsplits", ")", ":", "\n", "                    ", "if", "alen", "is", "None", ":", "\n", "                        ", "i", "[", "key", "]", "=", "arg", "\n", "", "else", ":", "\n", "                        ", "i", "[", "key", "]", "=", "arg", "[", "num", "]", "\n", "", "", "", "for", "rollout", ",", "av", ",", "kw", "in", "zip", "(", "self", ".", "rollouts", ",", "splitv", ",", "kwsplits", ")", ":", "\n", "                ", "res", ".", "append", "(", "getattr", "(", "rollout", ",", "name", ")", "(", "*", "av", ",", "**", "kw", ")", ")", "\n", "", "return", "res", "\n", "", "return", "func", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorages.cuda": [[52, 55], ["storage.RolloutStorages.call_rollout_functions"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorages.call_rollout_functions"], ["", "def", "cuda", "(", "self", ")", ":", "\n", "        ", "self", ".", "call_rollout_functions", "(", "'cuda'", ")", "\n", "return", "self", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorages.collect_training_data": [[56, 71], ["zip", "storage.RolloutStorages.call_rollout_functions", "len", "isinstance", "isinstance", "res.append", "isinstance", "sum", "res.append", "ValueError", "map", "numpy.concatenate", "str", "str", "type"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorages.call_rollout_functions", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "collect_training_data", "(", "self", ",", "next_v", ")", ":", "\n", "        ", "ret", "=", "self", ".", "call_rollout_functions", "(", "'collect_training_data'", ")", "(", "next_v", ")", "\n", "ret", "=", "[", "x", "for", "x", "in", "ret", "if", "x", "is", "not", "None", "]", "\n", "ret", "=", "zip", "(", "*", "ret", ")", "\n", "res", "=", "[", "]", "\n", "for", "a", "in", "ret", ":", "\n", "            ", "if", "isinstance", "(", "a", "[", "0", "]", ",", "list", ")", "or", "isinstance", "(", "a", "[", "0", "]", ",", "tuple", ")", ":", "\n", "                ", "res", ".", "append", "(", "sum", "(", "map", "(", "list", ",", "a", ")", ",", "[", "]", ")", ")", "\n", "", "elif", "isinstance", "(", "a", "[", "0", "]", ",", "np", ".", "ndarray", ")", ":", "\n", "                ", "res", ".", "append", "(", "np", ".", "concatenate", "(", "a", ")", ")", "\n", "", "else", ":", "# tensor", "\n", "                ", "raise", "ValueError", "(", "'error type'", "+", "str", "(", "a", ")", "+", "str", "(", "type", "(", "a", ")", ")", ")", "\n", "", "", "if", "len", "(", "res", ")", "==", "0", ":", "\n", "            ", "return", "None", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorages.__getattr__": [[72, 74], ["storage.RolloutStorages.call_rollout_functions"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorages.call_rollout_functions"], ["", "def", "__getattr__", "(", "self", ",", "name", ")", ":", "\n", "        ", "return", "self", ".", "call_rollout_functions", "(", "name", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.__init__": [[78, 98], ["numpy.zeros", "numpy.zeros", "numpy.zeros", "numpy.zeros", "numpy.zeros", "numpy.zeros"], "methods", ["None"], ["def", "__init__", "(", "self", ",", "num_steps", ",", "agent_number", ",", "obs_shape", ",", "action_space", ",", "gamma", ",", "\n", "recurrent_hidden_state_size", "=", "None", ")", ":", "\n", "\n", "        ", "assert", "recurrent_hidden_state_size", "is", "None", "# not supported now", "\n", "self", ".", "agent_number", "=", "agent_number", "\n", "self", ".", "num_steps", "=", "num_steps", "\n", "self", ".", "GAMMA", "=", "gamma", "\n", "self", ".", "obs", "=", "[", "]", "\n", "self", ".", "actions", "=", "np", ".", "zeros", "(", "(", "num_steps", ",", "agent_number", ",", "1", ")", ",", "dtype", "=", "int", ")", "\n", "self", ".", "rewards", "=", "np", ".", "zeros", "(", "(", "num_steps", ",", "agent_number", ",", "1", ")", ",", "dtype", "=", "float", ")", "\n", "self", ".", "preds", "=", "np", ".", "zeros", "(", "(", "num_steps", "+", "1", ",", "agent_number", ",", "1", ")", ",", "dtype", "=", "float", ")", "\n", "self", ".", "returns", "=", "np", ".", "zeros", "(", "(", "num_steps", "+", "1", ",", "agent_number", ",", "1", ")", ",", "\n", "dtype", "=", "float", ")", "\n", "self", ".", "probs", "=", "np", ".", "zeros", "(", "(", "num_steps", ",", "agent_number", ",", "action_space", "[", "0", "]", "[", "0", "]", ")", ",", "\n", "dtype", "=", "float", ")", "\n", "# ist[step] is 1, means obs[step + 1] is not following obs[step]", "\n", "self", ".", "ist", "=", "np", ".", "zeros", "(", "(", "num_steps", ",", ")", ",", "dtype", "=", "bool", ")", "\n", "# self.is_faket = torch.zeros_like(self.ist).bool()", "\n", "\n", "self", ".", "step", "=", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.cuda": [[99, 110], ["None"], "methods", ["None"], ["", "def", "cuda", "(", "self", ")", ":", "\n", "        ", "\"\"\"\n        self.recurrent_hidden_states = self.recurrent_hidden_states.cuda()\n        self.action_log_probs = self.action_log_probs.cuda()\n        \"\"\"", "\n", "# self.actions = self.actions.cuda()", "\n", "# self.rewards = self.rewards.cuda()", "\n", "# self.preds = self.preds.cuda()", "\n", "# self.ist = self.ist.cuda()", "\n", "# self.is_faket = self.is_faket.cuda()", "\n", "return", "self", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.full": [[111, 113], ["None"], "methods", ["None"], ["", "def", "full", "(", "self", ")", ":", "\n", "        ", "return", "self", ".", "step", "==", "self", ".", "num_steps", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.reset": [[114, 122], ["storage.RolloutStorage.obs.clear", "storage.RolloutStorage.obs.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "reset", "(", "self", ",", "init_state", ")", ":", "\n", "        ", "self", ".", "obs", ".", "clear", "(", ")", "\n", "self", ".", "actions", "[", ":", "]", "=", "0", "\n", "self", ".", "rewards", "[", ":", "]", "=", "0", "\n", "self", ".", "ist", "[", ":", "]", "=", "0", "\n", "# self.is_faket[:] = 0", "\n", "self", ".", "obs", ".", "append", "(", "init_state", ")", "\n", "self", ".", "step", "=", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.insert": [[123, 136], ["storage.RolloutStorage.obs.append", "numpy.array().copy", "numpy.array().copy", "numpy.array().copy", "numpy.array().copy", "numpy.array().copy", "numpy.array", "numpy.array", "numpy.array", "numpy.array", "numpy.array"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "insert", "(", "self", ",", "obs", ",", "actions", ",", "rewards", ",", "ist", ",", "preds", ",", "probs", ",", "is_faket", "=", "None", ")", ":", "\n", "#       recurrent_hidden_states, action_log_probs):", "\n", "# preds: value prediction ", "\n", "        ", "assert", "is_faket", "is", "None", "\n", "self", ".", "obs", ".", "append", "(", "obs", ")", "\n", "self", ".", "actions", "[", "self", ".", "step", "]", "=", "np", ".", "array", "(", "actions", ")", ".", "copy", "(", ")", "\n", "self", ".", "rewards", "[", "self", ".", "step", "]", "=", "np", ".", "array", "(", "rewards", ")", ".", "copy", "(", ")", "\n", "self", ".", "preds", "[", "self", ".", "step", "]", "=", "np", ".", "array", "(", "preds", ")", ".", "copy", "(", ")", "\n", "self", ".", "ist", "[", "self", ".", "step", "]", "=", "np", ".", "array", "(", "ist", ")", ".", "copy", "(", ")", "\n", "self", ".", "probs", "[", "self", ".", "step", "]", "=", "np", ".", "array", "(", "probs", ")", ".", "copy", "(", ")", "\n", "# self.is_faket[self.step + 1].copy_(torch.tensor(is_faket))", "\n", "\n", "self", ".", "step", "=", "(", "self", ".", "step", "+", "1", ")", "# % self.num_steps", "\n", "# pdb.set_trace()", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.collect_training_data": [[138, 150], ["storage.RolloutStorage.compute_returns", "storage.RolloutStorage.full"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.compute_returns", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.full"], ["", "def", "collect_training_data", "(", "self", ",", "next_v", ")", ":", "\n", "        ", "\"\"\"return training data. If data is not fully collected, return None.\n            else, return corresponding data with input agent and reset\n        \"\"\"", "\n", "if", "not", "self", ".", "full", "(", ")", ":", "\n", "            ", "return", "None", "\n", "", "self", ".", "compute_returns", "(", "next_v", ")", "\n", "ret_obs", "=", "self", ".", "obs", "[", ":", "-", "1", "]", "\n", "next_s", "=", "self", ".", "obs", "[", "1", ":", "]", "\n", "self", ".", "obs", "=", "self", ".", "obs", "[", "-", "1", ":", "]", "\n", "self", ".", "step", "=", "0", "\n", "return", "(", "ret_obs", ",", "self", ".", "actions", ",", "self", ".", "returns", "[", ":", "-", "1", "]", ",", "self", ".", "probs", ",", "next_s", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.after_update": [[151, 155], ["None"], "methods", ["None"], ["", "def", "after_update", "(", "self", ")", ":", "\n", "        ", "self", ".", "obs", "=", "[", "self", ".", "obs", "[", "-", "1", "]", "]", "\n", "# self.is_faket[0].copy_(self.is_faket[-1])", "\n", "self", ".", "step", "=", "0", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.RolloutStorage.compute_returns": [[156, 165], ["reversed", "range"], "methods", ["None"], ["", "def", "compute_returns", "(", "self", ",", "\n", "next_value", ",", "\n", "use_gae", "=", "False", ",", "\n", "gae_lambda", "=", "1", ",", "\n", "stop_time_limit", "=", "True", ")", ":", "\n", "        ", "self", ".", "returns", "[", "self", ".", "step", "]", "=", "next_value", "\n", "for", "step", "in", "reversed", "(", "range", "(", "self", ".", "step", ")", ")", ":", "\n", "            ", "self", ".", "returns", "[", "step", "]", "=", "self", ".", "returns", "[", "step", "+", "1", "]", "*", "self", ".", "GAMMA", "*", "(", "1", "-", "self", ".", "ist", "[", "step", "]", ")", "+", "self", ".", "rewards", "[", "step", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.CityFlowBuffer.__init__": [[168, 177], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "maxlen", ",", "observation", ",", "action", ")", ":", "\n", "        ", "''' use ndarray\n        self.state = np.zeros((maxlen, threads, observation), dtype=float)\n        self.action = np.zeros((maxlen, threads, action), dtype=float)\n        self.reward = np.zeros((maxlen, threads, 1), dtype=float)\n        self.next_s = np.zeros((maxlen, threads, observation), dtype=float)\n        self.ist = np.zeros((maxlen, threads, 1), dtype=int)\n        '''", "\n", "self", ".", "data", "=", "[", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.CityFlowBuffer.__len__": [[178, 180], ["len"], "methods", ["None"], ["", "def", "__len__", "(", "self", ")", ":", "\n", "        ", "return", "len", "(", "self", ".", "data", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.CityFlowBuffer.append": [[181, 183], ["storage.CityFlowBuffer.data.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "append", "(", "self", ",", "data", ")", ":", "\n", "        ", "self", ".", "data", ".", "append", "(", "data", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.CityFlowBuffer.__setitem__": [[184, 186], ["None"], "methods", ["None"], ["", "def", "__setitem__", "(", "self", ",", "index", ",", "data", ")", ":", "\n", "        ", "self", ".", "data", "[", "index", "]", "=", "data", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.CityFlowBuffer.__getitem__": [[187, 194], ["type", "res.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "__getitem__", "(", "self", ",", "index", ")", ":", "\n", "        ", "if", "type", "(", "index", ")", "==", "np", ".", "ndarray", ":", "\n", "            ", "res", "=", "[", "]", "\n", "for", "num", "in", "index", ":", "\n", "                ", "res", ".", "append", "(", "self", ".", "data", "[", "num", "]", ")", "\n", "", "return", "res", "\n", "", "return", "self", ".", "data", "[", "index", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.__init__": [[197, 211], ["numpy.random.RandomState", "collections.deque", "collections.deque", "collections.deque", "collections.deque"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "n_steps", ",", "maxlen", ",", "batch_size", ",", "seed", ",", "buffer_instance", ")", ":", "\n", "        ", "self", ".", "buffer", "=", "buffer_instance", "\n", "self", ".", "maxlen", "=", "maxlen", "\n", "self", ".", "n_steps", "=", "n_steps", "\n", "self", ".", "batch_size", "=", "batch_size", "\n", "self", ".", "random", "=", "np", ".", "random", ".", "RandomState", "(", "seed", ")", "\n", "\n", "self", ".", "position", "=", "0", "\n", "self", ".", "full", "=", "False", "\n", "self", ".", "_reset", "=", "False", "\n", "self", ".", "_state_deque", "=", "deque", "(", "maxlen", "=", "n_steps", "+", "1", ")", "\n", "self", ".", "_action_deque", "=", "deque", "(", "maxlen", "=", "n_steps", ")", "\n", "self", ".", "_reward_deque", "=", "deque", "(", "maxlen", "=", "n_steps", ")", "\n", "self", ".", "_ist_deque", "=", "deque", "(", "maxlen", "=", "n_steps", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.__len__": [[212, 214], ["len"], "methods", ["None"], ["", "def", "__len__", "(", "self", ")", ":", "\n", "        ", "return", "len", "(", "self", ".", "buffer", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.cuda": [[215, 217], ["None"], "methods", ["None"], ["", "def", "cuda", "(", "self", ")", ":", "\n", "        ", "return", "self", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.reset": [[218, 225], ["storage.ReplayBuffer._state_deque.clear", "storage.ReplayBuffer._action_deque.clear", "storage.ReplayBuffer._reward_deque.clear", "storage.ReplayBuffer._ist_deque.clear", "storage.ReplayBuffer._state_deque.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "reset", "(", "self", ",", "state", ")", ":", "\n", "        ", "self", ".", "_reset", "=", "True", "\n", "self", ".", "_state_deque", ".", "clear", "(", ")", "\n", "self", ".", "_action_deque", ".", "clear", "(", ")", "\n", "self", ".", "_reward_deque", ".", "clear", "(", ")", "\n", "self", ".", "_ist_deque", ".", "clear", "(", ")", "\n", "self", ".", "_state_deque", ".", "append", "(", "state", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append": [[226, 254], ["storage.ReplayBuffer._state_deque.append", "storage.ReplayBuffer._action_deque.append", "storage.ReplayBuffer._reward_deque.append", "storage.ReplayBuffer._ist_deque.append", "len", "numpy.zeros", "numpy.zeros_like", "enumerate", "numpy.moveaxis", "enumerate", "zip", "zip", "storage.ReplayBuffer._buffer_append", "data[].append", "data[].append", "data[].append", "data[].append", "data[].append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer._buffer_append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "append", "(", "self", ",", "action", ",", "reward", ",", "next_s", ",", "ist", ")", ":", "\n", "        ", "assert", "(", "self", ".", "_reset", ")", "\n", "self", ".", "_state_deque", ".", "append", "(", "next_s", ")", "\n", "self", ".", "_action_deque", ".", "append", "(", "action", ")", "\n", "self", ".", "_reward_deque", ".", "append", "(", "reward", ")", "\n", "self", ".", "_ist_deque", ".", "append", "(", "ist", ")", "\n", "if", "len", "(", "self", ".", "_state_deque", ")", "==", "self", ".", "n_steps", "+", "1", ":", "\n", "            ", "tot_reward", "=", "np", ".", "zeros", "(", "(", "self", ".", "n_steps", ",", "*", "self", ".", "_reward_deque", "[", "0", "]", ".", "shape", ")", ",", "\n", "dtype", "=", "float", ")", "\n", "tot_ist", "=", "np", ".", "zeros_like", "(", "self", ".", "_ist_deque", "[", "0", "]", ",", "dtype", "=", "int", ")", "\n", "for", "num", ",", "(", "reward", ",", "ist", ")", "in", "enumerate", "(", "zip", "(", "self", ".", "_reward_deque", ",", "\n", "self", ".", "_ist_deque", ")", ")", ":", "\n", "                ", "tot_reward", "[", "num", "]", "=", "reward", "\n", "tot_ist", "+=", "ist", "\n", "", "tot_reward", "=", "np", ".", "moveaxis", "(", "tot_reward", ",", "0", ",", "-", "1", ")", "\n", "tot_ist", "-=", "self", ".", "_ist_deque", "[", "-", "1", "]", "# last state is terminal is ok", "\n", "data", "=", "[", "[", "]", ",", "[", "]", ",", "[", "]", ",", "[", "]", ",", "[", "]", "]", "\n", "now_state_unpack", "=", "self", ".", "_state_deque", "[", "0", "]", "\n", "next_state_unpack", "=", "self", ".", "_state_deque", "[", "-", "1", "]", "\n", "for", "num", ",", "can_in", "in", "enumerate", "(", "tot_ist", ")", ":", "\n", "                ", "if", "can_in", "==", "0", ":", "\n", "                    ", "data", "[", "0", "]", ".", "append", "(", "now_state_unpack", "[", "num", "]", ")", "\n", "data", "[", "1", "]", ".", "append", "(", "self", ".", "_action_deque", "[", "0", "]", "[", "num", "]", ")", "\n", "data", "[", "2", "]", ".", "append", "(", "tot_reward", "[", "num", "]", ")", "\n", "data", "[", "3", "]", ".", "append", "(", "next_state_unpack", "[", "num", "]", ")", "\n", "data", "[", "4", "]", ".", "append", "(", "self", ".", "_ist_deque", "[", "-", "1", "]", "[", "num", "]", ")", "\n", "", "", "for", "one_data", "in", "zip", "(", "*", "data", ")", ":", "\n", "                ", "self", ".", "_buffer_append", "(", "*", "one_data", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer._buffer_append": [[255, 263], ["len", "storage.ReplayBuffer.buffer.append", "len"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "", "", "def", "_buffer_append", "(", "self", ",", "state", ",", "action", ",", "reward", ",", "next_s", ",", "ist", ")", ":", "\n", "        ", "if", "len", "(", "self", ".", "buffer", ")", "<", "self", ".", "maxlen", ":", "\n", "            ", "self", ".", "buffer", ".", "append", "(", "[", "state", ",", "action", ",", "reward", ",", "next_s", ",", "ist", "]", ")", "\n", "if", "len", "(", "self", ".", "buffer", ")", "==", "self", ".", "maxlen", ":", "\n", "                ", "self", ".", "full", "=", "True", "\n", "", "", "else", ":", "\n", "            ", "self", ".", "buffer", "[", "self", ".", "position", "]", "=", "[", "state", ",", "action", ",", "reward", ",", "next_s", ",", "ist", "]", "\n", "self", ".", "position", "=", "(", "self", ".", "position", "+", "1", ")", "%", "self", ".", "maxlen", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.sample": [[264, 269], ["storage.ReplayBuffer.random.choice"], "methods", ["None"], ["", "", "def", "sample", "(", "self", ")", ":", "\n", "        ", "choice", "=", "self", ".", "random", ".", "choice", "(", "self", ".", "maxlen", ",", "\n", "self", ".", "batch_size", ",", "\n", "replace", "=", "False", ")", "\n", "return", "self", ".", "buffer", "[", "choice", "]", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.__init__": [[65, 69], ["super().__init__", "numpy.random.RandomState"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "seed", ",", "indices", ",", "*", "argv", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "random", "=", "np", ".", "random", ".", "RandomState", "(", "seed", ")", "\n", "self", ".", "indices", "=", "indices", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.init_communicate": [[70, 72], ["None"], "methods", ["None"], ["", "def", "init_communicate", "(", "self", ",", "*", "argv", ",", "**", "kwargs", ")", ":", "\n", "        ", "pass", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.cuda": [[73, 75], ["NotImplementedError"], "methods", ["None"], ["", "def", "cuda", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.forward_model_select": [[76, 78], ["NotImplementedError"], "methods", ["None"], ["", "def", "forward_model_select", "(", "self", ",", "**", "kwargs", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.forward": [[79, 81], ["NotImplementedError"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "state", ",", "model_name", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.update_best": [[82, 84], ["NotImplementedError"], "methods", ["None"], ["", "def", "update_best", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.calculate_reward": [[85, 87], ["NotImplementedError"], "methods", ["None"], ["", "def", "calculate_reward", "(", "self", ",", "reward", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.get_action": [[88, 90], ["NotImplementedError"], "methods", ["None"], ["", "def", "get_action", "(", "self", ",", "state_q", ",", "eps", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.log_model_structure": [[91, 93], ["NotImplementedError"], "methods", ["None"], ["", "def", "log_model_structure", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.calculate_loss": [[94, 96], ["NotImplementedError"], "methods", ["None"], ["", "def", "calculate_loss", "(", "self", ",", "samples", ",", "frame", ",", "txsw_name", "=", "''", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.optimizer_step": [[97, 99], ["NotImplementedError"], "methods", ["None"], ["", "def", "optimizer_step", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.__init__": [[6, 12], ["DQNAgent.DQNAgent.__init__"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "NM_lane_embedding_size", ",", "road_relation", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "hidden_size", "=", "kwargs", "[", "'dqn_hidden_size'", "]", "\n", "self", ".", "lane_embedding_size", "=", "NM_lane_embedding_size", "\n", "self", ".", "road_relation", "=", "road_relation", "\n", "super", "(", ")", ".", "__init__", "(", "lane_embedding_size", "=", "self", ".", "lane_embedding_size", ",", "\n", "**", "kwargs", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.embedding_instance": [[13, 22], ["NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.model_update.inner.replace_lane_embedding", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.model_old.inner.replace_lane_embedding", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.BEST_MODEL.inner.replace_lane_embedding", "torch.optim.Adam", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.parameters"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding", "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding", "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding"], ["", "def", "embedding_instance", "(", "self", ",", "instance", "=", "None", ")", ":", "\n", "        ", "if", "instance", "is", "not", "None", ":", "\n", "            ", "self", ".", "model_update", ".", "inner", ".", "replace_lane_embedding", "(", "instance", "[", "0", "]", ")", "\n", "self", ".", "model_old", ".", "inner", ".", "replace_lane_embedding", "(", "instance", "[", "1", "]", ")", "\n", "self", ".", "BEST_MODEL", ".", "inner", ".", "replace_lane_embedding", "(", "instance", "[", "2", "]", ")", "\n", "self", ".", "opt", "=", "torch", ".", "optim", ".", "Adam", "(", "self", ".", "parameters", "(", ")", ",", "self", ".", "LR", ")", "\n", "", "return", "[", "self", ".", "model_update", ".", "inner", ".", "lane_embedding", ",", "\n", "self", ".", "model_old", ".", "inner", ".", "lane_embedding", ",", "\n", "self", ".", "BEST_MODEL", ".", "inner", ".", "lane_embedding", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.forward": [[23, 27], ["isinstance"], "methods", ["None"], ["", "def", "forward", "(", "self", ")", ":", "\n", "        ", "if", "isinstance", "(", "self", ".", "selected_model", ",", "torch", ".", "nn", ".", "ModuleList", ")", ":", "\n", "            ", "return", "[", "self", ".", "state2tensor", ",", "self", ".", "roadcomm_d", ",", "self", ".", "f_d", "]", "\n", "", "return", "[", "self", ".", "state2tensor", ",", "self", ".", "roadcomm_s", ",", "self", ".", "f_s", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.state2tensor": [[28, 33], ["res.append", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.model_update.inner.state2tensor"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.state2tensor"], ["", "def", "state2tensor", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "state", "in", "states", ":", "\n", "            ", "res", ".", "append", "(", "self", ".", "model_update", ".", "inner", ".", "state2tensor", "(", "state", ")", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.arrange_rcomm": [[34, 55], ["cuda", "range", "len", "len", "torch.zeros_like", "len", "[].copy", "[].copy.append", "torch.stack", "torch.stack.append", "torch.stack.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "arrange_rcomm", "(", "self", ",", "states", ",", "rcomm", ",", "state_key", "=", "'rcomm'", ")", ":", "\n", "        ", "assert", "len", "(", "states", ")", "==", "len", "(", "rcomm", ")", "\n", "default_rcomm", "=", "cuda", "(", "torch", ".", "zeros_like", "(", "rcomm", "[", "0", "]", "[", ":", ",", "0", "]", ")", ")", "\n", "if", "state_key", "in", "states", "[", "0", "]", ":", "\n", "            ", "return", "states", ",", "rcomm", "\n", "", "for", "i", "in", "range", "(", "len", "(", "states", ")", ")", ":", "\n", "            ", "onerc", "=", "[", "]", "\n", "rlin", "=", "self", ".", "road_relation", "[", "i", "]", "[", "'RoadLinksIn'", "]", "\n", "rlfrom", "=", "self", ".", "road_relation", "[", "i", "]", "[", "'RoadsIn'", "]", ".", "copy", "(", ")", "\n", "rlfrom", ".", "append", "(", "[", "-", "1", ",", "-", "1", "]", ")", "\n", "RLIN", "=", "[", "rlfrom", "[", "x", "]", "for", "x", "in", "rlin", "]", "\n", "\n", "# print(rlfrom, rlin)", "\n", "for", "ininter", ",", "inroad", "in", "RLIN", ":", "\n", "                ", "if", "ininter", ">", "-", "1", "and", "inroad", ">", "-", "1", ":", "\n", "                    ", "onerc", ".", "append", "(", "rcomm", "[", "ininter", "]", "[", ":", ",", "inroad", "]", ")", "\n", "", "else", ":", "\n", "                    ", "onerc", ".", "append", "(", "default_rcomm", ")", "\n", "", "", "onerc", "=", "torch", ".", "stack", "(", "onerc", ",", "dim", "=", "1", ")", "\n", "states", "[", "i", "]", "[", "state_key", "]", "=", "onerc", "\n", "", "return", "states", ",", "rcomm", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.roadcomm_s": [[56, 65], ["res.append", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.selected_model.inner.roadcomm"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "roadcomm_s", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "res", ".", "append", "(", "[", "\n", "states", "[", "i", "]", ",", "\n", "self", ".", "selected_model", ".", "inner", ".", "roadcomm", "(", "states", "[", "i", "]", ",", "\n", "self", ".", "road_relation", "[", "i", "]", ")", "\n", "]", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.f_s": [[66, 73], ["zip", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.arrange_rcomm", "res.append", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.selected_model.forward"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.arrange_rcomm", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward"], ["", "def", "f_s", "(", "self", ",", "states", ")", ":", "\n", "        ", "states", ",", "rcomm", "=", "zip", "(", "*", "states", ")", "\n", "states", ",", "rcomm", "=", "self", ".", "arrange_rcomm", "(", "states", ",", "rcomm", ")", "\n", "res", "=", "[", "]", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "res", ".", "append", "(", "self", ".", "selected_model", ".", "forward", "(", "states", "[", "i", "]", ")", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.roadcomm_d": [[74, 85], ["res.append", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.selected_model[].inner.roadcomm", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.selected_model[].inner.roadcomm"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "roadcomm_d", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "res", ".", "append", "(", "[", "\n", "states", "[", "i", "]", ",", "\n", "self", ".", "selected_model", "[", "0", "]", ".", "inner", ".", "roadcomm", "(", "states", "[", "i", "]", ",", "\n", "self", ".", "road_relation", "[", "i", "]", ")", ",", "\n", "self", ".", "selected_model", "[", "1", "]", ".", "inner", ".", "roadcomm", "(", "states", "[", "i", "]", ",", "\n", "self", ".", "road_relation", "[", "i", "]", ")", ",", "\n", "]", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.f_d": [[86, 99], ["zip", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.arrange_rcomm", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.arrange_rcomm", "enumerate", "res.append", "res[].append", "torch.stack", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.selected_model[].forward", "NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.selected_model[].forward"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.arrange_rcomm", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNaiveCommuAgent.NewModelNaiveCommuAgent.arrange_rcomm", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward"], ["", "def", "f_d", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "states", ",", "rcomm_0", ",", "rcomm_1", "=", "zip", "(", "*", "states", ")", "\n", "states", ",", "rcomm_0", "=", "self", ".", "arrange_rcomm", "(", "states", ",", "rcomm_0", ",", "'rcomm_0'", ")", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "states", "[", "i", "]", "[", "'rcomm'", "]", "=", "states", "[", "i", "]", "[", "'rcomm_0'", "]", "\n", "res", ".", "append", "(", "[", "self", ".", "selected_model", "[", "0", "]", ".", "forward", "(", "states", "[", "i", "]", ")", "]", ")", "\n", "", "states", ",", "rcomm_1", "=", "self", ".", "arrange_rcomm", "(", "states", ",", "rcomm_1", ",", "'rcomm_1'", ")", "\n", "for", "num", ",", "i", "in", "enumerate", "(", "self", ".", "indices", ")", ":", "\n", "            ", "states", "[", "i", "]", "[", "'rcomm'", "]", "=", "states", "[", "i", "]", "[", "'rcomm_1'", "]", "\n", "res", "[", "num", "]", ".", "append", "(", "self", ".", "selected_model", "[", "1", "]", ".", "forward", "(", "states", "[", "i", "]", ")", ")", "\n", "res", "[", "num", "]", "=", "torch", ".", "stack", "(", "res", "[", "num", "]", ",", "dim", "=", "1", ")", "\n", "", "return", "res", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.__init__": [[6, 26], ["DQNAgent.DQNAgent.__init__", "torch.nn.BCELoss", "torch.nn.MSELoss", "torch.optim.Adam", "NewModelAgent.NewModelAgent.parameters"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "NM_lane_embedding_size", ",", "NM_phase_loss_weight", ",", "\n", "NM_volume_loss_weight", ",", "NM_phase_loss_with_replay", ",", "\n", "out_road_embeddings", ",", "road_relation", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "hidden_size", "=", "kwargs", "[", "'dqn_hidden_size'", "]", "\n", "self", ".", "lane_embedding_size", "=", "NM_lane_embedding_size", "\n", "self", ".", "phase_loss_weight", "=", "NM_phase_loss_weight", "\n", "self", ".", "volume_loss_weight", "=", "NM_volume_loss_weight", "\n", "self", ".", "road_relation", "=", "road_relation", "\n", "self", ".", "phase_loss_with_replay", "=", "NM_phase_loss_with_replay", "\n", "self", ".", "phase_loss", "=", "[", "]", "\n", "self", ".", "volume_loss", "=", "[", "]", "\n", "self", ".", "emb_loss", "=", "[", "]", "\n", "super", "(", ")", ".", "__init__", "(", "lane_embedding_size", "=", "self", ".", "lane_embedding_size", ",", "\n", "**", "kwargs", ")", "\n", "self", ".", "phaseid2lanes", "=", "self", ".", "observation", "[", "'phaseid2lanes'", "]", "\n", "self", ".", "phase_loss_func", "=", "torch", ".", "nn", ".", "BCELoss", "(", ")", "\n", "self", ".", "volume_loss_func", "=", "torch", ".", "nn", ".", "MSELoss", "(", ")", "\n", "\n", "self", ".", "out_road_embedding", "=", "out_road_embeddings", "[", "0", "]", "\n", "self", ".", "opt", "=", "torch", ".", "optim", ".", "Adam", "(", "self", ".", "parameters", "(", ")", ",", "self", ".", "LR", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.named_modules": [[27, 39], ["super().named_modules", "NewModelAgent.NewModelAgent.out_road_embedding.named_modules"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules"], ["", "def", "named_modules", "(", "self", ",", "memo", "=", "None", ",", "prefix", "=", "''", ")", ":", "\n", "        ", "update", "=", "super", "(", ")", ".", "named_modules", "(", "memo", "=", "memo", ",", "prefix", "=", "prefix", ")", "\n", "for", "i", "in", "update", ":", "\n", "            ", "yield", "i", "\n", "", "try", ":", "\n", "            ", "emb", "=", "self", ".", "out_road_embedding", ".", "named_modules", "(", "\n", "memo", "=", "memo", ",", "\n", "prefix", "=", "'.out_road_embedding'", ")", "\n", "for", "i", "in", "emb", ":", "\n", "                ", "yield", "i", "\n", "", "", "except", ":", "\n", "            ", "pass", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.embedding_instance": [[40, 49], ["NewModelAgent.NewModelAgent.model_update.inner.replace_lane_embedding", "NewModelAgent.NewModelAgent.model_old.inner.replace_lane_embedding", "NewModelAgent.NewModelAgent.BEST_MODEL.inner.replace_lane_embedding", "torch.optim.Adam", "NewModelAgent.NewModelAgent.parameters"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding", "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding", "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding"], ["", "", "def", "embedding_instance", "(", "self", ",", "instance", "=", "None", ")", ":", "\n", "        ", "if", "instance", "is", "not", "None", ":", "\n", "            ", "self", ".", "model_update", ".", "inner", ".", "replace_lane_embedding", "(", "instance", "[", "0", "]", ")", "\n", "self", ".", "model_old", ".", "inner", ".", "replace_lane_embedding", "(", "instance", "[", "1", "]", ")", "\n", "self", ".", "BEST_MODEL", ".", "inner", ".", "replace_lane_embedding", "(", "instance", "[", "2", "]", ")", "\n", "self", ".", "opt", "=", "torch", ".", "optim", ".", "Adam", "(", "self", ".", "parameters", "(", ")", ",", "self", ".", "LR", ")", "\n", "", "return", "[", "self", ".", "model_update", ".", "inner", ".", "lane_embedding", ",", "\n", "self", ".", "model_old", ".", "inner", ".", "lane_embedding", ",", "\n", "self", ".", "BEST_MODEL", ".", "inner", ".", "lane_embedding", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.forward": [[50, 54], ["isinstance"], "methods", ["None"], ["", "def", "forward", "(", "self", ")", ":", "\n", "        ", "if", "isinstance", "(", "self", ".", "selected_model", ",", "torch", ".", "nn", ".", "ModuleList", ")", ":", "\n", "            ", "return", "[", "self", ".", "state2tensor", ",", "self", ".", "phase_p_d", ",", "self", ".", "f_d", "]", "\n", "", "return", "[", "self", ".", "state2tensor", ",", "self", ".", "phase_p_s", ",", "self", ".", "f_s", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.state2tensor": [[55, 60], ["res.append", "NewModelAgent.NewModelAgent.model_update.inner.state2tensor"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.state2tensor"], ["", "def", "state2tensor", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "state", "in", "states", ":", "\n", "            ", "res", ".", "append", "(", "self", ".", "model_update", ".", "inner", ".", "state2tensor", "(", "state", ")", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.arrange_volume_prediction": [[61, 83], ["enumerate", "zip", "cuda", "cuda().float", "zip", "torch.zeros_like", "cuda", "emb.forward", "torch.zeros_like", "cuda", "torch.tensor().long", "torch.tensor", "len"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "def", "arrange_volume_prediction", "(", "self", ",", "states", ",", "v_p", ",", "key", "=", "'predict'", ")", ":", "\n", "        ", "\"\"\"get predict for roadin from calculated roadout or embedding\n        \"\"\"", "\n", "if", "key", "in", "states", "[", "0", "]", ":", "\n", "            ", "return", "\n", "", "for", "num", ",", "[", "state", ",", "rel", "]", "in", "enumerate", "(", "zip", "(", "states", ",", "self", ".", "road_relation", ")", ")", ":", "\n", "            ", "res", "=", "cuda", "(", "torch", ".", "zeros_like", "(", "state", "[", "'TSflow'", "]", ")", ")", "\n", "mask", "=", "cuda", "(", "torch", ".", "zeros_like", "(", "state", "[", "'TSflow'", "]", ")", ")", ".", "float", "(", ")", "\n", "for", "ri", ",", "ri2rl", "in", "zip", "(", "rel", "[", "'RoadsIn'", "]", ",", "rel", "[", "'RoadIn2RoadLink'", "]", ")", ":", "\n", "                ", "from_i", ",", "from_r", "=", "ri", "\n", "if", "from_i", "<", "0", ":", "\n", "# virtual intersections", "\n", "                    ", "vid", "=", "-", "1", "-", "from_i", "\n", "emb", "=", "self", ".", "out_road_embedding", "\n", "emb_res", "=", "emb", ".", "forward", "(", "cuda", "(", "torch", ".", "tensor", "(", "[", "vid", "]", "\n", "*", "len", "(", "state", "[", "'Envtime'", "]", ")", ")", ".", "long", "(", ")", ")", ",", "state", "[", "'Envtime'", "]", ")", "\n", "", "else", ":", "\n", "                    ", "emb_res", "=", "v_p", "[", "from_i", "]", "[", ":", ",", "from_r", "]", "\n", "", "res", "[", ":", ",", "ri2rl", "]", "=", "emb_res", "\n", "mask", "[", ":", ",", "ri2rl", "]", "=", "from_i", "<", "0", "\n", "", "state", "[", "key", "]", "=", "res", "\n", "", "return", "states", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.gather_phase_loss": [[84, 92], ["res.max", "NewModelAgent.NewModelAgent.phaseid2lanes[].unsqueeze", "NewModelAgent.NewModelAgent.phase_loss.append", "NewModelAgent.NewModelAgent.phase_loss_func"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "gather_phase_loss", "(", "self", ",", "res", ",", "p_p", ")", ":", "\n", "        ", "if", "not", "self", ".", "phase_loss_weight", ":", "\n", "            ", "return", "\n", "", "if", "not", "p_p", ".", "requires_grad", ":", "# no grad no loss", "\n", "            ", "return", "\n", "", "_", ",", "maxid", "=", "res", ".", "max", "(", "dim", "=", "-", "1", ")", "\n", "laneid", "=", "self", ".", "phaseid2lanes", "[", "maxid", "]", ".", "unsqueeze", "(", "-", "1", ")", "# [B, L, 1]", "\n", "self", ".", "phase_loss", ".", "append", "(", "self", ".", "phase_loss_func", "(", "p_p", ",", "laneid", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.gather_volume_loss": [[93, 117], ["torch.tensor", "torch.tensor", "ri2rl.reshape.reshape.reshape", "NewModelAgent.NewModelAgent.volume_loss.append", "real.reshape", "real.reshape", "NewModelAgent.NewModelAgent.volume_loss_func", "len", "NewModelAgent.NewModelAgent.emb_loss.append", "calc_predict.sum", "emb_predict.sum", "emb_real.reshape", "NewModelAgent.NewModelAgent.volume_loss_func"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "gather_volume_loss", "(", "self", ",", "state", ",", "road_relation", ",", "predict_key", "=", "'predict'", ")", ":", "\n", "        ", "ri2rl", "=", "torch", ".", "tensor", "(", "road_relation", "[", "'RoadIn2RoadLink'", "]", ")", "\n", "real_in", "=", "torch", ".", "tensor", "(", "[", "x", "[", "0", "]", ">=", "0", "for", "x", "in", "road_relation", "[", "'RoadsIn'", "]", "]", ")", "\n", "ri2rl", "[", "~", "real_in", ",", ":", "]", "=", "-", "1", "\n", "if", "not", "self", ".", "volume_loss_weight", ":", "\n", "            ", "return", "\n", "", "NILVN", "=", "'NextInLaneVehicleNumber'", "\n", "if", "NILVN", "not", "in", "state", "or", "predict_key", "not", "in", "state", ":", "\n", "            ", "return", "\n", "", "ri2rl", "=", "ri2rl", ".", "reshape", "(", "-", "1", ")", "\n", "mask", "=", "ri2rl", ">=", "0", "\n", "predict", "=", "state", "[", "predict_key", "]", "\n", "real", "=", "state", "[", "NILVN", "]", "\n", "calc_predict", "=", "predict", "[", ":", ",", "ri2rl", "[", "mask", "]", "]", "\n", "calc_real", "=", "real", ".", "reshape", "(", "real", ".", "shape", "[", "0", "]", ",", "-", "1", ")", "[", ":", ",", "mask", "]", "\n", "emb_predict", "=", "predict", "[", ":", ",", "ri2rl", "[", "~", "mask", "]", "]", "\n", "emb_real", "=", "real", ".", "reshape", "(", "real", ".", "shape", "[", "0", "]", ",", "-", "1", ")", "[", ":", ",", "~", "mask", "]", "\n", "assert", "calc_predict", ".", "requires_grad", "or", "calc_predict", ".", "sum", "(", ")", "==", "0", "\n", "assert", "emb_predict", ".", "requires_grad", "or", "emb_predict", ".", "sum", "(", ")", "==", "0", "\n", "# print('calc', calc_predict.mean(), calc_real.mean())", "\n", "self", ".", "volume_loss", ".", "append", "(", "self", ".", "volume_loss_func", "(", "calc_predict", ",", "calc_real", ")", ")", "\n", "# print('emb', emb_predict.mean().item(), emb_real.mean())", "\n", "if", "(", "len", "(", "emb_real", ".", "reshape", "(", "-", "1", ")", ")", "!=", "0", ")", ":", "\n", "            ", "self", ".", "emb_loss", ".", "append", "(", "self", ".", "volume_loss_func", "(", "emb_predict", ",", "emb_real", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.phase_p_s": [[118, 126], ["NewModelAgent.NewModelAgent.selected_model.inner.phase_predict", "res.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "", "def", "phase_p_s", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "l_emb", ",", "p_p", "=", "self", ".", "selected_model", ".", "inner", ".", "phase_predict", "(", "\n", "states", "[", "i", "]", ",", "\n", "self", ".", "road_relation", "[", "i", "]", ")", "\n", "res", ".", "append", "(", "[", "states", "[", "i", "]", ",", "l_emb", ",", "p_p", "]", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.f_s": [[127, 157], ["zip", "NewModelAgent.NewModelAgent.arrange_volume_prediction", "v_p.append", "NewModelAgent.NewModelAgent.arrange_volume_prediction", "res.append", "NewModelAgent.NewModelAgent.gather_phase_loss", "NewModelAgent.NewModelAgent.gather_volume_loss", "NewModelAgent.NewModelAgent.selected_model.inner.volume_predict", "NewModelAgent.NewModelAgent.phaseid2lanes[].unsqueeze", "v_p_realp.append", "NewModelAgent.NewModelAgent.selected_model.forward", "torch.nn.functional.one_hot", "NewModelAgent.NewModelAgent.gather_phase_loss", "NewModelAgent.NewModelAgent.selected_model.inner.volume_predict"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.arrange_volume_prediction", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.arrange_volume_prediction", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.gather_phase_loss", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.gather_volume_loss", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.gather_phase_loss"], ["", "def", "f_s", "(", "self", ",", "states", ")", ":", "\n", "        ", "states", ",", "l_emb", ",", "p_p", "=", "zip", "(", "*", "states", ")", "\n", "res", "=", "[", "]", "\n", "v_p", "=", "[", "]", "\n", "v_p_realp", "=", "[", "]", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "v_p", ".", "append", "(", "self", ".", "selected_model", ".", "inner", ".", "volume_predict", "(", "\n", "l_emb", "[", "i", "]", ",", "p_p", "[", "i", "]", ",", "self", ".", "road_relation", "[", "i", "]", ")", ")", "\n", "if", "'NextPhase'", "in", "states", "[", "i", "]", ":", "\n", "                ", "realp", "=", "self", ".", "phaseid2lanes", "[", "\n", "states", "[", "i", "]", "[", "'NextPhase'", "]", "]", ".", "unsqueeze", "(", "-", "1", ")", "\n", "v_p_realp", ".", "append", "(", "self", ".", "selected_model", ".", "inner", ".", "volume_predict", "(", "\n", "l_emb", "[", "i", "]", ",", "realp", ",", "self", ".", "road_relation", "[", "i", "]", ")", ")", "\n", "", "", "states", "=", "self", ".", "arrange_volume_prediction", "(", "states", ",", "v_p", ")", "\n", "if", "'NextPhase'", "in", "states", "[", "i", "]", ":", "\n", "            ", "states", "=", "self", ".", "arrange_volume_prediction", "(", "states", ",", "\n", "v_p_realp", ",", "\n", "'predict_realp'", ")", "\n", "", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "res", ".", "append", "(", "self", ".", "selected_model", ".", "forward", "(", "states", "[", "i", "]", ")", ")", "\n", "self", ".", "gather_phase_loss", "(", "res", "[", "-", "1", "]", ",", "p_p", "[", "i", "]", ")", "\n", "if", "'NextPhase'", "in", "states", "[", "i", "]", "and", "self", ".", "phase_loss_with_replay", ":", "\n", "                ", "phase_to_prob", "=", "torch", ".", "nn", ".", "functional", ".", "one_hot", "(", "\n", "states", "[", "i", "]", "[", "'NextPhase'", "]", ",", "\n", "res", "[", "-", "1", "]", ".", "shape", "[", "1", "]", ")", "\n", "self", ".", "gather_phase_loss", "(", "phase_to_prob", ",", "p_p", "[", "i", "]", ")", "\n", "", "self", ".", "gather_volume_loss", "(", "states", "[", "i", "]", ",", "\n", "self", ".", "road_relation", "[", "i", "]", ",", "\n", "'predict_realp'", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.phase_p_d": [[158, 167], ["NewModelAgent.NewModelAgent.selected_model[].inner.phase_predict", "NewModelAgent.NewModelAgent.selected_model[].inner.phase_predict", "res.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "phase_p_d", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "l_emb_0", ",", "p_p_0", "=", "self", ".", "selected_model", "[", "0", "]", ".", "inner", ".", "phase_predict", "(", "\n", "states", "[", "i", "]", ",", "self", ".", "road_relation", "[", "i", "]", ")", "\n", "l_emb_1", ",", "p_p_1", "=", "self", ".", "selected_model", "[", "1", "]", ".", "inner", ".", "phase_predict", "(", "\n", "states", "[", "i", "]", ",", "self", ".", "road_relation", "[", "i", "]", ")", "\n", "res", ".", "append", "(", "[", "states", "[", "i", "]", ",", "l_emb_0", ",", "p_p_0", ",", "l_emb_1", ",", "p_p_1", "]", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.f_d": [[168, 195], ["zip", "NewModelAgent.NewModelAgent.arrange_volume_prediction", "NewModelAgent.NewModelAgent.arrange_volume_prediction", "enumerate", "v_p_0.append", "NewModelAgent.NewModelAgent.selected_model[].forward", "res.append", "v_p_1.append", "NewModelAgent.NewModelAgent.selected_model[].forward", "res[].append", "torch.stack", "NewModelAgent.NewModelAgent.gather_phase_loss", "NewModelAgent.NewModelAgent.selected_model[].inner.volume_predict", "NewModelAgent.NewModelAgent.selected_model[].inner.volume_predict"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.arrange_volume_prediction", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.arrange_volume_prediction", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.gather_phase_loss"], ["", "def", "f_d", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "states", ",", "l_emb_0", ",", "p_p_0", ",", "l_emb_1", ",", "p_p_1", "=", "zip", "(", "*", "states", ")", "\n", "assert", "'NextInLaneVehicleNumber'", "not", "in", "states", "[", "0", "]", "\n", "# d for next_s, no next information to calc loss", "\n", "v_p_0", "=", "[", "]", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "v_p_0", ".", "append", "(", "self", ".", "selected_model", "[", "0", "]", ".", "inner", ".", "volume_predict", "(", "\n", "l_emb_0", "[", "i", "]", ",", "p_p_0", "[", "i", "]", ",", "self", ".", "road_relation", "[", "i", "]", ")", ")", "\n", "", "states", "=", "self", ".", "arrange_volume_prediction", "(", "states", ",", "v_p_0", ",", "'predict_0'", ")", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "states", "[", "i", "]", "[", "'predict'", "]", "=", "states", "[", "i", "]", "[", "'predict_0'", "]", "\n", "forward_res", "=", "self", ".", "selected_model", "[", "0", "]", ".", "forward", "(", "states", "[", "i", "]", ")", "\n", "res", ".", "append", "(", "[", "forward_res", "]", ")", "\n", "\n", "", "v_p_1", "=", "[", "]", "\n", "for", "i", "in", "self", ".", "indices", ":", "\n", "            ", "v_p_1", ".", "append", "(", "self", ".", "selected_model", "[", "1", "]", ".", "inner", ".", "volume_predict", "(", "\n", "l_emb_1", "[", "i", "]", ",", "p_p_1", "[", "i", "]", ",", "self", ".", "road_relation", "[", "i", "]", ")", ")", "\n", "", "states", "=", "self", ".", "arrange_volume_prediction", "(", "states", ",", "v_p_1", ",", "'predict_1'", ")", "\n", "for", "num", ",", "i", "in", "enumerate", "(", "self", ".", "indices", ")", ":", "\n", "            ", "states", "[", "i", "]", "[", "'predict'", "]", "=", "states", "[", "i", "]", "[", "'predict_1'", "]", "\n", "forward_res", "=", "self", ".", "selected_model", "[", "1", "]", ".", "forward", "(", "states", "[", "i", "]", ")", "\n", "res", "[", "num", "]", ".", "append", "(", "forward_res", ")", "\n", "res", "[", "num", "]", "=", "torch", ".", "stack", "(", "res", "[", "num", "]", ",", "dim", "=", "1", ")", "\n", "self", ".", "gather_phase_loss", "(", "forward_res", ",", "p_p_1", "[", "i", "]", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelAgent.NewModelAgent.calculate_loss": [[196, 226], ["super().calculate_loss", "log", "len", "torch.stack().mean", "len", "torch.stack().mean", "len", "torch.stack().mean", "NewModelAgent.NewModelAgent.TXSW.add_scalar", "NewModelAgent.NewModelAgent.TXSW.add_scalar", "NewModelAgent.NewModelAgent.TXSW.add_scalar", "torch.stack", "torch.stack", "torch.stack", "torch.stack().mean.item", "torch.stack().mean.item", "torch.stack().mean.item"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.calculate_loss", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_scalar", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_scalar", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_scalar"], ["", "def", "calculate_loss", "(", "self", ",", "samples", ",", "frame", ",", "txsw_name", ",", "**", "kwargs", ")", ":", "\n", "        ", "L", "=", "super", "(", ")", ".", "calculate_loss", "(", "samples", ",", "frame", ",", "txsw_name", ",", "**", "kwargs", ")", "\n", "L_phase", "=", "-", "1", "# use MSE, so never be negative", "\n", "L_volume", "=", "-", "1", "\n", "L_emb", "=", "-", "1", "\n", "if", "len", "(", "self", ".", "phase_loss", ")", ">", "0", ":", "\n", "            ", "L_phase", "=", "torch", ".", "stack", "(", "self", ".", "phase_loss", ")", ".", "mean", "(", ")", "\n", "L", "+=", "L_phase", "\n", "self", ".", "phase_loss", "=", "[", "]", "\n", "", "if", "len", "(", "self", ".", "emb_loss", ")", ">", "0", ":", "\n", "            ", "self", ".", "volume_loss", "+=", "self", ".", "emb_loss", "\n", "L_emb", "=", "torch", ".", "stack", "(", "self", ".", "emb_loss", ")", ".", "mean", "(", ")", "\n", "# print(self.out_road_embedding.embedding.weight.sum(1))", "\n", "self", ".", "emb_loss", "=", "[", "]", "\n", "", "if", "len", "(", "self", ".", "volume_loss", ")", ">", "0", ":", "\n", "            ", "L_volume", "=", "torch", ".", "stack", "(", "self", ".", "volume_loss", ")", ".", "mean", "(", ")", "\n", "L", "+=", "L_volume", "\n", "self", ".", "volume_loss", "=", "[", "]", "\n", "", "if", "txsw_name", "!=", "''", ":", "\n", "            ", "if", "L_phase", "!=", "-", "1", ":", "\n", "                ", "self", ".", "TXSW", ".", "add_scalar", "(", "txsw_name", "+", "'_p'", ",", "L_phase", ".", "item", "(", ")", ",", "frame", ")", "\n", "", "if", "L_volume", "!=", "-", "1", ":", "\n", "                ", "self", ".", "TXSW", ".", "add_scalar", "(", "txsw_name", "+", "'_v'", ",", "L_volume", ".", "item", "(", ")", ",", "frame", ")", "\n", "", "if", "L_emb", "!=", "-", "1", ":", "\n", "                ", "self", ".", "TXSW", ".", "add_scalar", "(", "txsw_name", "+", "'_v_out'", ",", "L_emb", ".", "item", "(", ")", ",", "frame", ")", "\n", "", "", "L_phase", "=", "'NaN'", "if", "L_phase", "==", "-", "1", "else", "(", "'%.5f'", "%", "L_phase", ")", "\n", "L_volume", "=", "'NaN'", "if", "L_volume", "==", "-", "1", "else", "(", "'%.5f'", "%", "L_volume", ")", "\n", "log", "(", "'phase loss: %9s, volume loss: %9s'", "%", "(", "L_phase", ",", "L_volume", ")", ",", "\n", "level", "=", "'TRACE'", ")", "\n", "return", "L", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.__init__": [[21, 74], ["AgentBase.AgentBase.__init__", "DQNAgent.DQNAgent.cuda"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["    ", "def", "__init__", "(", "self", ",", "wrapperModel", ",", "\n", "observation", ",", "action", ",", "innerModel", ",", "TXSW", ",", "# wrapperModel param", "\n", "gamma", ",", "dqn_net_update_freq", ",", "learning_rate", ",", "double_dqn", ",", "\n", "seed", ",", "n_steps", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", "seed", ",", "**", "kwargs", ")", "\n", "self", ".", "TXSW", "=", "TXSW", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "action", "=", "action", "\n", "model_args", "=", "{", "\n", "'observation'", ":", "observation", ",", "\n", "'action'", ":", "action", ",", "\n", "'innerModel'", ":", "innerModel", ",", "\n", "'TXSW'", ":", "TXSW", "\n", "}", "\n", "self", ".", "model_old", "=", "cuda", "(", "wrapperModel", "(", "\n", "**", "model_args", ",", "\n", "seed", "=", "self", ".", "randint", "(", ")", ",", "**", "kwargs", ")", ")", "\n", "self", ".", "model_update", "=", "cuda", "(", "wrapperModel", "(", "\n", "**", "model_args", ",", "\n", "seed", "=", "self", ".", "randint", "(", ")", ",", "**", "kwargs", ")", ")", "\n", "self", ".", "BEST_MODEL", "=", "cuda", "(", "wrapperModel", "(", "\n", "**", "model_args", ",", "\n", "seed", "=", "self", ".", "randint", "(", ")", ",", "**", "kwargs", ")", ")", "\n", "self", ".", "model_old", ".", "eval", "(", ")", "# a.k.a target net", "\n", "self", ".", "model_update", ".", "train", "(", ")", "\n", "self", ".", "BEST_MODEL", ".", "eval", "(", ")", "\n", "self", ".", "GAMMA", "=", "gamma", "\n", "self", ".", "UPDATE", "=", "dqn_net_update_freq", "\n", "self", ".", "LR", "=", "learning_rate", "\n", "self", ".", "DOUBLE", "=", "double_dqn", "\n", "self", ".", "N_STEPS", "=", "n_steps", "\n", "\n", "self", ".", "update_count", "=", "0", "\n", "self", ".", "opt", "=", "torch", ".", "optim", ".", "Adam", "(", "self", ".", "parameters", "(", ")", ",", "self", ".", "LR", ")", "\n", "\n", "self", ".", "loss", "=", "torch", ".", "nn", ".", "MSELoss", "(", ")", "\n", "\n", "# add state dict of optimizer to state_dict", "\n", "def", "add_opt_state_dict_hook", "(", "self", ",", "state_dict", ",", "prefix", ",", "local_metadata", ")", ":", "\n", "            ", "opt_state_dict", "=", "self", ".", "opt", ".", "state_dict", "(", ")", "\n", "state_dict", "[", "prefix", "+", "'opt'", "]", "=", "opt_state_dict", "\n", "# for k, v in opt_state_dict.items():", "\n", "#     state_dict[prefix + k] = v", "\n", "", "self", ".", "_register_state_dict_hook", "(", "add_opt_state_dict_hook", ")", "\n", "\n", "# remove selected_model data", "\n", "def", "remove_selected_hook", "(", "self", ",", "state_dict", ",", "prefix", ",", "local_metadata", ")", ":", "\n", "            ", "select", "=", "prefix", "+", "'selected_model'", "\n", "keys", "=", "list", "(", "state_dict", ".", "keys", "(", ")", ")", "\n", "for", "k", "in", "keys", ":", "\n", "                ", "if", "k", ".", "find", "(", "select", ")", "==", "0", ":", "\n", "                    ", "del", "state_dict", "[", "k", "]", "\n", "", "", "", "self", ".", "_register_state_dict_hook", "(", "remove_selected_hook", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent._load_from_state_dict": [[77, 89], ["super()._load_from_state_dict", "DQNAgent.DQNAgent.opt.load_state_dict", "missing_keys.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare._load_from_state_dict", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["def", "_load_from_state_dict", "(", "self", ",", "state_dict", ",", "prefix", ",", "local_metadata", ",", "strict", ",", "\n", "missing_keys", ",", "unexpected_keys", ",", "error_msgs", ")", ":", "\n", "        ", "opt_key", "=", "prefix", "+", "'opt'", "\n", "if", "opt_key", "in", "state_dict", ":", "\n", "            ", "self", ".", "opt", ".", "load_state_dict", "(", "state_dict", "[", "opt_key", "]", ")", "\n", "del", "state_dict", "[", "opt_key", "]", "\n", "", "elif", "strict", ":", "\n", "            ", "missing_keys", ".", "append", "(", "opt_key", ")", "\n", "", "self", ".", "selected_model", "=", "None", "\n", "super", "(", ")", ".", "_load_from_state_dict", "(", "state_dict", ",", "prefix", ",", "local_metadata", ",", "\n", "strict", ",", "missing_keys", ",", "unexpected_keys", ",", "\n", "error_msgs", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.named_modules": [[90, 93], ["DQNAgent.DQNAgent.model_update.named_modules"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules"], ["", "def", "named_modules", "(", "self", ",", "memo", "=", "None", ",", "prefix", "=", "''", ")", ":", "\n", "# only self.model_update will be trained", "\n", "        ", "return", "self", ".", "model_update", ".", "named_modules", "(", "memo", ",", "prefix", "+", "'.model_update'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.randint": [[94, 96], ["DQNAgent.DQNAgent.random.randint"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint"], ["", "def", "randint", "(", "self", ",", "k", "=", "2", "**", "31", ")", ":", "\n", "        ", "return", "self", ".", "random", ".", "randint", "(", "k", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.cuda": [[97, 102], ["DQNAgent.DQNAgent.cuda"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "def", "cuda", "(", "self", ")", ":", "\n", "        ", "self", ".", "model_update", "=", "cuda", "(", "self", ".", "model_update", ")", "\n", "self", ".", "model_old", "=", "cuda", "(", "self", ".", "model_old", ")", "\n", "self", ".", "BEST_MODEL", "=", "cuda", "(", "self", ".", "BEST_MODEL", ")", "\n", "return", "self", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.forward_model_select": [[103, 146], ["torch.nn.ModuleList.eval", "model_name.lower", "DQNAgent.DQNAgent.model_update.train", "DQNAgent.DQNAgent.model_old.eval", "ValueError", "torch.nn.ModuleList.train", "torch.nn.ModuleList.eval", "model_name.lower", "model_name.lower", "ValueError", "torch.nn.ModuleList", "torch.nn.ModuleList.append", "torch.nn.ModuleList.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "forward_model_select", "(", "self", ",", "**", "kwargs", ")", ":", "\n", "        ", "if", "'model_name'", "in", "kwargs", ":", "\n", "            ", "model_name", "=", "kwargs", "[", "'model_name'", "]", "\n", "if", "model_name", ".", "lower", "(", ")", "==", "'update'", ":", "\n", "                ", "model", "=", "self", ".", "model_update", "\n", "", "elif", "model_name", ".", "lower", "(", ")", "==", "'old'", ":", "\n", "                ", "model", "=", "self", ".", "model_old", "\n", "", "elif", "model_name", ".", "lower", "(", ")", "==", "'best'", ":", "\n", "                ", "model", "=", "self", ".", "BEST_MODEL", "\n", "", "", "elif", "'update_policy'", "in", "kwargs", ":", "\n", "            ", "datasource", "=", "kwargs", "[", "'update_policy'", "]", "\n", "self", ".", "model_update", ".", "train", "(", ")", "\n", "self", ".", "model_old", ".", "eval", "(", ")", "\n", "if", "datasource", "==", "'state'", ":", "\n", "                ", "model", "=", "self", ".", "model_update", "\n", "", "elif", "datasource", "==", "'next_s'", ":", "\n", "                ", "if", "self", ".", "DOUBLE", ":", "\n", "                    ", "model", "=", "torch", ".", "nn", ".", "ModuleList", "(", ")", "\n", "model", ".", "append", "(", "self", ".", "model_old", ")", "\n", "model", ".", "append", "(", "self", ".", "model_update", ")", "\n", "", "else", ":", "\n", "                    ", "model", "=", "self", ".", "model_old", "\n", "", "", "else", ":", "\n", "                ", "raise", "ValueError", "(", "\"can't determine which model to select\"", ")", "\n", "", "", "else", ":", "\n", "            ", "raise", "ValueError", "(", "\"can't determine which model to select\"", ")", "\n", "\n", "", "if", "'evaluate'", "in", "kwargs", "or", "'get'", "in", "kwargs", ":", "\n", "            ", "model", ".", "eval", "(", ")", "\n", "\n", "", "if", "'is_train'", "in", "kwargs", ":", "\n", "            ", "if", "kwargs", "[", "'is_train'", "]", ":", "\n", "                ", "model", ".", "train", "(", ")", "\n", "", "else", ":", "\n", "                ", "model", ".", "eval", "(", ")", "\n", "\n", "# print(kwargs, ", "\n", "#       (model == self.model_update) * 'update', ", "\n", "#       (model == self.model_old) * 'old', ", "\n", "#       (model == self.BEST_MODEL) * 'best',", "\n", "#       isinstance(model, list) * 'update old'", "\n", "# )", "\n", "", "", "self", ".", "selected_model", "=", "model", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.forward": [[147, 151], ["isinstance"], "methods", ["None"], ["", "def", "forward", "(", "self", ")", ":", "\n", "        ", "if", "isinstance", "(", "self", ".", "selected_model", ",", "torch", ".", "nn", ".", "ModuleList", ")", ":", "\n", "            ", "return", "[", "self", ".", "forward_double", "]", "\n", "", "return", "[", "self", ".", "forward_single", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.forward_double": [[155, 163], ["res.append", "torch.stack", "DQNAgent.DQNAgent.model_old.forward", "DQNAgent.DQNAgent.model_update.forward"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward"], ["def", "forward_double", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "idx", "in", "self", ".", "indices", ":", "\n", "            ", "res", ".", "append", "(", "torch", ".", "stack", "(", "[", "self", ".", "model_old", ".", "forward", "(", "states", "[", "idx", "]", ")", ",", "\n", "self", ".", "model_update", ".", "forward", "(", "states", "[", "idx", "]", ")", "]", ",", "\n", "dim", "=", "1", ")", ")", "\n", "# res: [BATCH, 2, ACTION]", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.forward_single": [[164, 169], ["res.append", "DQNAgent.DQNAgent.selected_model.forward"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward"], ["", "def", "forward_single", "(", "self", ",", "states", ")", ":", "\n", "        ", "res", "=", "[", "]", "\n", "for", "idx", "in", "self", ".", "indices", ":", "\n", "            ", "res", ".", "append", "(", "self", ".", "selected_model", ".", "forward", "(", "states", "[", "idx", "]", ")", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.update_best": [[170, 172], ["DQNAgent.DQNAgent.BEST_MODEL.load_state_dict", "DQNAgent.DQNAgent.model_update.state_dict"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.state_dict"], ["", "def", "update_best", "(", "self", ")", ":", "\n", "        ", "self", ".", "BEST_MODEL", ".", "load_state_dict", "(", "self", ".", "model_update", ".", "state_dict", "(", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.calculate_reward": [[173, 177], ["np.arange"], "methods", ["None"], ["", "def", "calculate_reward", "(", "self", ",", "reward", ")", ":", "\n", "        ", "gamma", "=", "self", ".", "GAMMA", "**", "np", ".", "arange", "(", "reward", ".", "shape", "[", "-", "1", "]", ")", "\n", "reward", "=", "(", "reward", "*", "gamma", ")", ".", "sum", "(", "-", "1", ")", "\n", "return", "reward", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.get_action": [[178, 187], ["DQNAgent.DQNAgent.random.randint", "torch.argmax().detach().cpu().numpy", "np.expand_dims", "DQNAgent.DQNAgent.random.rand", "torch.argmax().detach().cpu", "torch.argmax().detach", "torch.argmax"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint"], ["", "def", "get_action", "(", "self", ",", "state_action", ",", "eps", ")", ":", "\n", "        ", "rand_actions", "=", "self", ".", "random", ".", "randint", "(", "self", ".", "action", ",", "\n", "size", "=", "state_action", ".", "shape", "[", ":", "-", "1", "]", ")", "\n", "q", "=", "state_action", "\n", "q", "=", "torch", ".", "argmax", "(", "q", ",", "dim", "=", "-", "1", ")", ".", "detach", "(", ")", ".", "cpu", "(", ")", ".", "numpy", "(", ")", "# [Batch]", "\n", "randidx", "=", "self", ".", "random", ".", "rand", "(", "*", "state_action", ".", "shape", "[", ":", "-", "1", "]", ")", "<", "eps", "\n", "q", "[", "randidx", "]", "=", "rand_actions", "[", "randidx", "]", "\n", "q", "=", "np", ".", "expand_dims", "(", "q", ",", "axis", "=", "-", "1", ")", "# [Batch, 1]", "\n", "return", "q", "# return: [Batch, ActionNumForOneInter=1]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.log_model_structure": [[188, 190], ["log"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log"], ["", "def", "log_model_structure", "(", "self", ")", ":", "\n", "        ", "log", "(", "'model structure:\\n'", ",", "self", ".", "model_old", ",", "'\\n-------'", ",", "level", "=", "'ALL'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.calculate_loss": [[191, 231], ["DQNAgent.DQNAgent.model_old.eval", "DQNAgent.DQNAgent.model_update.train", "np.array", "np.array", "DQNAgent.DQNAgent.calculate_reward", "np.array", "DQNAgent.DQNAgent.opt.zero_grad", "DQNAgent.DQNAgent.cuda"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.calculate_reward", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "def", "calculate_loss", "(", "self", ",", "samples", ",", "frame", ",", "txsw_name", "=", "''", ")", ":", "\n", "        ", "self", ".", "model_old", ".", "eval", "(", ")", "\n", "self", ".", "model_update", ".", "train", "(", ")", "\n", "# each of 5 is a list contains BATCHNUM items.", "\n", "state_q", ",", "action", ",", "reward", ",", "next_s_q", ",", "ist", "=", "samples", "\n", "if", "self", ".", "DOUBLE", ":", "\n", "# next_s_q: [BATCH, 2, ACTION]", "\n", "            ", "next_s_q_old", "=", "next_s_q", "[", ":", ",", "0", "]", "\n", "next_s_q_update", "=", "next_s_q", "[", ":", ",", "1", "]", "\n", "\n", "", "action", "=", "np", ".", "array", "(", "action", ")", "\n", "reward", "=", "np", ".", "array", "(", "reward", ")", "\n", "reward", "=", "self", ".", "calculate_reward", "(", "reward", ")", "\n", "ist", "=", "np", ".", "array", "(", "ist", ")", "\n", "self", ".", "opt", ".", "zero_grad", "(", ")", "\n", "action", "=", "cuda", "(", "torch", ".", "tensor", "(", "action", ")", ".", "long", "(", ")", ")", "\n", "reward", "=", "cuda", "(", "torch", ".", "tensor", "(", "reward", ")", ".", "float", "(", ")", ")", "\n", "\n", "# combine one intersection's actions", "\n", "# action = action.mul(cuda(torch.tensor([1, 8]))).sum(-1)", "\n", "action", ".", "squeeze_", "(", "-", "1", ")", "# when every intersetion has only one action", "\n", "ist", "=", "1", "-", "np", ".", "array", "(", "ist", ")", "\n", "\n", "if", "self", ".", "DOUBLE", ":", "\n", "            ", "next_a", "=", "next_s_q_update", ".", "max", "(", "dim", "=", "-", "1", ")", "[", "1", "]", "\n", "next_q", "=", "next_s_q_old", ".", "gather", "(", "1", ",", "next_a", ".", "unsqueeze", "(", "-", "1", ")", ")", ".", "squeeze", "(", "1", ")", "\n", "", "else", ":", "\n", "            ", "next_q", "=", "next_s_q", ".", "max", "(", "dim", "=", "-", "1", ")", "[", "0", "]", "\n", "", "reward_b", "=", "(", "reward", "\n", "+", "(", "self", ".", "GAMMA", "**", "self", ".", "N_STEPS", ")", "\n", "*", "next_q", "\n", "*", "cuda", "(", "torch", ".", "tensor", "(", "1", "-", "ist", ")", ".", "float", "(", ")", ")", ")", "\n", "q", "=", "state_q", ".", "gather", "(", "1", ",", "action", ".", "unsqueeze", "(", "-", "1", ")", ")", ".", "squeeze", "(", "1", ")", "\n", "L", "=", "self", ".", "loss", "(", "q", ",", "reward_b", ")", "\n", "# L.backward()", "\n", "# self.opt.step()", "\n", "if", "txsw_name", "!=", "''", ":", "\n", "            ", "self", ".", "TXSW", ".", "add_scalar", "(", "txsw_name", ",", "L", ".", "item", "(", ")", ",", "frame", ")", "\n", "# return L.item()", "\n", "", "return", "L", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.optimizer_step": [[232, 238], ["DQNAgent.DQNAgent.opt.step", "DQNAgent.DQNAgent.opt.zero_grad", "DQNAgent.DQNAgent.model_old.load_state_dict", "DQNAgent.DQNAgent.model_update.state_dict"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.state_dict"], ["", "def", "optimizer_step", "(", "self", ")", ":", "\n", "        ", "self", ".", "opt", ".", "step", "(", ")", "\n", "self", ".", "opt", ".", "zero_grad", "(", ")", "\n", "self", ".", "update_count", "+=", "1", "\n", "if", "self", ".", "update_count", "%", "self", ".", "UPDATE", "==", "0", ":", "\n", "            ", "self", ".", "model_old", ".", "load_state_dict", "(", "self", ".", "model_update", ".", "state_dict", "(", ")", ")", "\n", "", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNoCommuAgent.NewModelNoCommuAgent.__init__": [[6, 11], ["DQNAgent.DQNAgent.__init__"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "NM_lane_embedding_size", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "hidden_size", "=", "kwargs", "[", "'dqn_hidden_size'", "]", "\n", "self", ".", "lane_embedding_size", "=", "NM_lane_embedding_size", "\n", "super", "(", ")", ".", "__init__", "(", "lane_embedding_size", "=", "self", ".", "lane_embedding_size", ",", "\n", "**", "kwargs", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNoCommuAgent.NewModelNoCommuAgent.embedding_instance": [[12, 21], ["NewModelNoCommuAgent.NewModelNoCommuAgent.model_update.inner.replace_lane_embedding", "NewModelNoCommuAgent.NewModelNoCommuAgent.model_old.inner.replace_lane_embedding", "NewModelNoCommuAgent.NewModelNoCommuAgent.BEST_MODEL.inner.replace_lane_embedding", "torch.optim.Adam", "NewModelNoCommuAgent.NewModelNoCommuAgent.parameters"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding", "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding", "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding"], ["", "def", "embedding_instance", "(", "self", ",", "instance", "=", "None", ")", ":", "\n", "        ", "if", "instance", "is", "not", "None", ":", "\n", "            ", "self", ".", "model_update", ".", "inner", ".", "replace_lane_embedding", "(", "instance", "[", "0", "]", ")", "\n", "self", ".", "model_old", ".", "inner", ".", "replace_lane_embedding", "(", "instance", "[", "1", "]", ")", "\n", "self", ".", "BEST_MODEL", ".", "inner", ".", "replace_lane_embedding", "(", "instance", "[", "2", "]", ")", "\n", "self", ".", "opt", "=", "torch", ".", "optim", ".", "Adam", "(", "self", ".", "parameters", "(", ")", ",", "self", ".", "LR", ")", "\n", "", "return", "[", "self", ".", "model_update", ".", "inner", ".", "lane_embedding", ",", "\n", "self", ".", "model_old", ".", "inner", ".", "lane_embedding", ",", "\n", "self", ".", "BEST_MODEL", ".", "inner", ".", "lane_embedding", "]", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.models.__init__.parseclass": [[8, 22], ["vars", "issubclass", "[].append", "globals", "globals", "wrapperModels", "wrapperModels.WrapperModelBase", "innerModels", "innerModels.InnerModelBase"], "function", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["innerModels", "=", "os", ".", "listdir", "(", "innermodel_folder", ")", "\n", "\n", "output_models", "=", "[", "]", "\n", "\n", "for", "innerModel", "in", "innerModels", ":", "\n", "    ", "if", "innerModel", "[", "-", "3", ":", "]", "==", "'.py'", "and", "innerModel", "!=", "'__init__.py'", ":", "\n", "        ", "innerModel", "=", "innerModel", "[", ":", "-", "3", "]", "\n", "im", "=", "importlib", ".", "import_module", "(", "__package__", "+", "'.'", "+", "innerModel", ")", "\n", "\n", "globals", "(", ")", "[", "innerModel", "]", "=", "vars", "(", "im", ")", "[", "innerModel", "]", "\n", "output_models", ".", "append", "(", "innerModel", ")", "\n", "\n", "", "", "__all__", "=", "output_models", "\n", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.InnerModelBase.InnerModelBase.__init__": [[11, 13], ["torch.Module.__init__"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.InnerModelBase.InnerModelBase.default_wrapper": [[17, 28], ["None"], "methods", ["None"], ["@", "staticmethod", "\n", "def", "default_wrapper", "(", "dqn_split_model", ",", "dueling_dqn", ",", "\n", "**", "kwargs", ")", ":", "\n", "        ", "if", "dqn_split_model", ":", "\n", "            ", "if", "dueling_dqn", ":", "\n", "                ", "return", "'DuelingSplitModel'", "\n", "", "else", ":", "\n", "                ", "return", "'DQNSplitMix'", "\n", "", "", "elif", "dueling_dqn", ":", "\n", "            ", "return", "'DQNDuelingModel'", "\n", "", "return", "'DQNBasicModel'", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.DQNNaiveFC.DQNNaiveFC.__init__": [[5, 28], ["InnerModelBase.InnerModelBase.__init__", "len", "torch.nn.Embedding", "nn.Sequential", "nn.Sequential", "nn.Linear", "nn.ReLU", "nn.Linear", "nn.ReLU"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "observation", ",", "dqn_hidden_size", ",", "\n", "use_predict", "=", "False", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", "DQNNaiveFC", ",", "self", ")", ".", "__init__", "(", ")", "\n", "\n", "self", ".", "use_predict", "=", "use_predict", "\n", "\n", "# cityflow specific", "\n", "self", ".", "observation", "=", "observation", "[", "'TSflow'", "]", "[", "0", "]", "\n", "self", ".", "phase_obs", "=", "len", "(", "observation", "[", "'TSphase'", "]", ")", "\n", "self", ".", "green_obs", "=", "observation", "[", "'TSgreen'", "]", "[", "0", "]", "\n", "\n", "self", ".", "phase_emb", "=", "torch", ".", "nn", ".", "Embedding", "(", "self", ".", "phase_obs", ",", "self", ".", "phase_obs", ")", "\n", "self", ".", "inputlen", "=", "self", ".", "observation", "+", "self", ".", "phase_obs", "+", "self", ".", "green_obs", "\n", "if", "use_predict", ":", "\n", "            ", "self", ".", "inputlen", "+=", "self", ".", "observation", "\n", "\n", "", "self", ".", "fc1", "=", "nn", ".", "Sequential", "(", "\n", "nn", ".", "Linear", "(", "self", ".", "inputlen", ",", "dqn_hidden_size", "*", "8", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", ")", "\n", "self", ".", "fc2", "=", "nn", ".", "Sequential", "(", "\n", "nn", ".", "Linear", "(", "dqn_hidden_size", "*", "8", ",", "dqn_hidden_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", ",", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.DQNNaiveFC.DQNNaiveFC.forward": [[30, 42], ["cuda().float", "cuda().long", "cuda().float", "DQNNaiveFC.DQNNaiveFC.phase_emb", "DQNNaiveFC.DQNNaiveFC.fc1", "DQNNaiveFC.DQNNaiveFC.fc2", "cuda().float", "cat.append", "torch.cat", "cuda", "cuda", "cuda", "torch.tensor", "torch.tensor", "torch.tensor", "cuda", "torch.tensor"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "def", "forward", "(", "self", ",", "state", ")", ":", "\n", "        ", "flow", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSflow'", "]", ")", ")", ".", "float", "(", ")", "\n", "phase", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSphase'", "]", ")", ")", ".", "long", "(", ")", "\n", "green", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSgreen'", "]", ")", ")", ".", "float", "(", ")", "\n", "phase", "=", "self", ".", "phase_emb", "(", "phase", ")", "\n", "cat", "=", "[", "flow", ",", "phase", ",", "green", "]", "\n", "if", "self", ".", "use_predict", ":", "\n", "            ", "flow", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'predict'", "]", ")", ")", ".", "float", "(", ")", "\n", "cat", ".", "append", "(", "flow", ")", "\n", "", "x", "=", "self", ".", "fc1", "(", "torch", ".", "cat", "(", "cat", ",", "dim", "=", "-", "1", ")", ")", "\n", "x", "=", "self", ".", "fc2", "(", "x", ")", "\n", "return", "x", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNoCommu.LaneEmbedding.__init__": [[5, 18], ["nn.Module.__init__", "isinstance", "nn.Sequential", "nn.Linear", "nn.ReLU"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "observation", ",", "lane_embedding_size", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "layers", "=", "[", "]", "\n", "if", "isinstance", "(", "lane_embedding_size", ",", "int", ")", ":", "\n", "            ", "lane_embedding_size", "=", "[", "lane_embedding_size", "]", "\n", "", "self", ".", "lane_embedding_size", "=", "lane_embedding_size", "\n", "self", ".", "input", "=", "2", "\n", "last_input", "=", "self", ".", "input", "\n", "for", "hidden", "in", "lane_embedding_size", ":", "\n", "            ", "self", ".", "layers", "+=", "[", "nn", ".", "Linear", "(", "last_input", ",", "hidden", ")", ",", "nn", ".", "ReLU", "(", ")", "]", "\n", "last_input", "=", "hidden", "\n", "", "self", ".", "layers", "=", "nn", ".", "Sequential", "(", "*", "self", ".", "layers", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNoCommu.LaneEmbedding.forward": [[19, 21], ["NewModelNoCommu.LaneEmbedding.layers"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "states", ")", ":", "\n", "        ", "return", "self", ".", "layers", "(", "states", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNoCommu.NewModelNoCommu.__init__": [[24, 51], ["InnerModelBase.InnerModelBase.__init__", "nn.Sequential", "range", "NewModelNoCommu.NewModelNoCommu.not_phases.append", "NewModelNoCommu.LaneEmbedding", "nn.Linear", "nn.ReLU", "one.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["    ", "def", "__init__", "(", "self", ",", "dqn_hidden_size", ",", "lane_embedding_size", ",", "observation", ",", "\n", "lane_embedding_instance", "=", "None", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "hidden", "=", "dqn_hidden_size", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "phases", "=", "observation", "[", "'TSphase'", "]", "\n", "self", ".", "lane_number", "=", "observation", "[", "'TSflow'", "]", "[", "0", "]", "\n", "self", ".", "not_phases", "=", "[", "]", "\n", "for", "phase", "in", "self", ".", "phases", ":", "\n", "            ", "one", "=", "[", "]", "\n", "for", "num", "in", "range", "(", "self", ".", "lane_number", ")", ":", "\n", "                ", "if", "num", "not", "in", "phase", ":", "\n", "                    ", "one", ".", "append", "(", "num", ")", "\n", "", "", "self", ".", "not_phases", ".", "append", "(", "one", ")", "\n", "", "self", ".", "weights", "=", "[", "5", ",", "1", "]", "\n", "\n", "self", ".", "shared_lane", "=", "lane_embedding_instance", "is", "not", "None", "\n", "\n", "if", "lane_embedding_instance", "is", "not", "None", ":", "\n", "            ", "self", ".", "lane_embedding", "=", "lane_embedding_instance", "\n", "", "else", ":", "\n", "            ", "self", ".", "lane_embedding", "=", "LaneEmbedding", "(", "observation", ",", "\n", "lane_embedding_size", ")", "\n", "\n", "", "self", ".", "fc", "=", "nn", ".", "Sequential", "(", "\n", "nn", ".", "Linear", "(", "lane_embedding_size", "*", "2", ",", "dqn_hidden_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNoCommu.NewModelNoCommu.default_wrapper": [[53, 59], ["None"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "default_wrapper", "(", "dueling_dqn", ",", "**", "kwargs", ")", ":", "\n", "        ", "if", "dueling_dqn", ":", "\n", "            ", "return", "'DuelingSplitModel'", "\n", "", "else", ":", "\n", "            ", "return", "'DQNSplitModel'", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNoCommu.NewModelNoCommu.named_modules": [[63, 69], ["super().named_modules", "n.find"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules"], ["def", "named_modules", "(", "self", ",", "memo", "=", "None", ",", "prefix", "=", "''", ")", ":", "\n", "        ", "for", "n", ",", "p", "in", "super", "(", ")", ".", "named_modules", "(", "memo", ",", "prefix", ")", ":", "\n", "            ", "if", "self", ".", "shared_lane", ":", "\n", "                ", "if", "n", ".", "find", "(", "prefix", "+", "'.lane_embedding'", ")", "==", "0", ":", "\n", "                    ", "continue", "\n", "", "", "yield", "n", ",", "p", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNoCommu.NewModelNoCommu.replace_lane_embedding": [[70, 73], ["None"], "methods", ["None"], ["", "", "def", "replace_lane_embedding", "(", "self", ",", "lane_embedding", ")", ":", "\n", "        ", "self", ".", "lane_embedding", "=", "lane_embedding", "\n", "self", ".", "shared_lane", "=", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNoCommu.NewModelNoCommu.forward": [[74, 90], ["cuda().float", "cuda().float", "torch.stack", "NewModelNoCommu.NewModelNoCommu.lane_embedding", "zip", "torch.stack", "NewModelNoCommu.NewModelNoCommu.fc", "NewModelNoCommu.NewModelNoCommu.append", "cuda", "cuda", "torch.cat", "torch.tensor", "torch.tensor", "x[].mean", "x[].mean"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "def", "forward", "(", "self", ",", "state", ")", ":", "\n", "        ", "flow", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSflow'", "]", ")", ")", ".", "float", "(", ")", "\n", "green", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSgreen'", "]", ")", ")", ".", "float", "(", ")", "\n", "\n", "x", "=", "torch", ".", "stack", "(", "(", "flow", ",", "green", ")", ",", "dim", "=", "-", "1", ")", "\n", "x", "=", "self", ".", "lane_embedding", "(", "x", ")", "# [BATCH, LANE, HIDDEN]", "\n", "\n", "res", "=", "[", "]", "\n", "for", "phase", ",", "not_phase", "in", "zip", "(", "self", ".", "phases", ",", "self", ".", "not_phases", ")", ":", "\n", "            ", "res", ".", "append", "(", "torch", ".", "cat", "(", "(", "\n", "x", "[", ":", ",", "phase", "]", ".", "mean", "(", "dim", "=", "1", ")", "*", "self", ".", "weights", "[", "0", "]", ",", "\n", "x", "[", ":", ",", "not_phase", "]", ".", "mean", "(", "dim", "=", "1", ")", "*", "self", ".", "weights", "[", "1", "]", ")", ",", "dim", "=", "-", "1", ")", ")", "\n", "", "res", "=", "torch", ".", "stack", "(", "res", ",", "dim", "=", "1", ")", "# [BATCH, PHASE, HIDDEN]", "\n", "res", "=", "self", ".", "fc", "(", "res", ")", "\n", "\n", "return", "res", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.PhasePredict.__init__": [[9, 28], ["nn.Module.__init__", "nn.Embedding", "nn.Linear", "nn.MultiheadAttention", "nn.Sequential", "nn.Linear", "nn.Linear", "nn.Sigmoid"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "observation", ",", "NM_road_predict_hidden", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "hidden", "=", "NM_road_predict_hidden", "\n", "self", ".", "direction_type", "=", "3", "\n", "\n", "self", ".", "direction_hidden", "=", "2", "\n", "self", ".", "emb_direction", "=", "nn", ".", "Embedding", "(", "self", ".", "direction_type", ",", "\n", "self", ".", "direction_hidden", ")", "\n", "\n", "self", ".", "emb_fc", "=", "nn", ".", "Linear", "(", "2", "+", "self", ".", "direction_hidden", ",", "self", ".", "hidden", ")", "\n", "\n", "self", ".", "attention", "=", "nn", ".", "MultiheadAttention", "(", "self", ".", "hidden", ",", "1", ")", "\n", "self", ".", "phase_predict", "=", "nn", ".", "Sequential", "(", "\n", "nn", ".", "Linear", "(", "self", ".", "hidden", ",", "1", ")", ",", "\n", "nn", ".", "Sigmoid", "(", ")", "\n", ")", "\n", "\n", "self", ".", "vol_predict_fc", "=", "nn", ".", "Linear", "(", "self", ".", "hidden", ",", "self", ".", "direction_type", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.PhasePredict.forward": [[29, 45], ["NewModel.PhasePredict.emb_direction", "direction.unsqueeze().repeat.unsqueeze().repeat.unsqueeze().repeat", "torch.stack", "NewModel.PhasePredict.emb_fc", "x.transpose.transpose.transpose", "NewModel.PhasePredict.attention", "x.transpose.transpose.transpose", "NewModel.PhasePredict.phase_predict", "torch.cat", "direction.unsqueeze().repeat.unsqueeze().repeat.unsqueeze"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "states", ",", "road_relation", ")", ":", "\n", "        ", "lanewidths", "=", "road_relation", "[", "'LaneCount'", "]", "# [L]", "\n", "flow", "=", "states", "[", "'TSflow'", "]", "\n", "# wait = states['TSwait']", "\n", "green", "=", "states", "[", "'TSgreen'", "]", "\n", "direction", "=", "road_relation", "[", "'RoadLinkDirection'", "]", "\n", "direction", "=", "self", ".", "emb_direction", "(", "direction", ")", "\n", "direction", "=", "direction", ".", "unsqueeze", "(", "0", ")", ".", "repeat", "(", "flow", ".", "shape", "[", "0", "]", ",", "1", ",", "1", ")", "\n", "x", "=", "torch", ".", "stack", "(", "(", "flow", ",", "green", ")", ",", "dim", "=", "-", "1", ")", "\n", "x", "=", "self", ".", "emb_fc", "(", "torch", ".", "cat", "(", "(", "x", ",", "direction", ")", ",", "dim", "=", "-", "1", ")", ")", "# [B, L, H]", "\n", "q", "=", "k", "=", "v", "=", "x", ".", "transpose", "(", "0", ",", "1", ")", "# [L, B, H]", "\n", "x", ",", "x_w", "=", "self", ".", "attention", "(", "q", ",", "k", ",", "v", ")", "\n", "x", "=", "x", ".", "transpose", "(", "0", ",", "1", ")", "# [B, L, H]", "\n", "phase_predict", "=", "self", ".", "phase_predict", "(", "x", ")", "# [B, L, 1]", "\n", "\n", "return", "x", ",", "phase_predict", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.VolumePredict.__init__": [[53, 62], ["nn.Module.__init__", "nn.Linear"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "observation", ",", "NM_road_predict_hidden", ",", "\n", "NM_scale_by_lane_number", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "hidden", "=", "NM_road_predict_hidden", "\n", "self", ".", "lane_scale", "=", "NM_scale_by_lane_number", "\n", "self", ".", "direction_type", "=", "3", "\n", "\n", "self", ".", "vol_predict_fc", "=", "nn", ".", "Linear", "(", "self", ".", "hidden", ",", "self", ".", "direction_type", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.VolumePredict.forward": [[63, 80], ["zip", "torch.stack", "NewModel.VolumePredict.vol_predict_fc", "NewModel.VolumePredict.append", "len", "selected.sum"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "forward", "(", "self", ",", "lane_embedding", ",", "phase", ",", "road_relation", ")", ":", "\n", "        ", "\"\"\"calculate predicts for roadout\n        \"\"\"", "\n", "road2rl", "=", "road_relation", "[", "'RoadOut2RoadLink'", "]", "\n", "roadwidths", "=", "road_relation", "[", "'RoadOutLanes'", "]", "# [R, self.direction_type]", "\n", "lane_embedding", "=", "lane_embedding", "*", "phase", "# [B, L, H]", "\n", "res", "=", "[", "]", "\n", "for", "rls", ",", "rwidth", "in", "zip", "(", "road2rl", ",", "roadwidths", ")", ":", "\n", "            ", "assert", "len", "(", "rwidth", ")", "==", "self", ".", "direction_type", "\n", "selected", "=", "lane_embedding", "[", ":", ",", "rls", "]", "\n", "if", "self", ".", "lane_scale", ":", "\n", "                ", "selected", "=", "selected", "/", "(", "rwidth", "\n", "+", "1e-6", ")", ".", "unsqueeze", "(", "0", ")", ".", "unsqueeze", "(", "-", "1", ")", "\n", "", "res", ".", "append", "(", "selected", ".", "sum", "(", "dim", "=", "1", ")", ")", "\n", "", "res", "=", "torch", ".", "stack", "(", "res", ",", "dim", "=", "1", ")", "# [B, R, H]", "\n", "res", "=", "self", ".", "vol_predict_fc", "(", "res", ")", "# [B, R, 3]", "\n", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.LaneEmbedding.__init__": [[83, 96], ["nn.Module.__init__", "isinstance", "nn.Sequential", "nn.Linear", "nn.ReLU"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "observation", ",", "lane_embedding_size", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "layers", "=", "[", "]", "\n", "if", "isinstance", "(", "lane_embedding_size", ",", "int", ")", ":", "\n", "            ", "lane_embedding_size", "=", "[", "lane_embedding_size", "]", "\n", "", "self", ".", "lane_embedding_size", "=", "lane_embedding_size", "\n", "self", ".", "input", "=", "3", "# flow, green, predict, predict_valid_mask", "\n", "last_input", "=", "self", ".", "input", "\n", "for", "hidden", "in", "lane_embedding_size", ":", "\n", "            ", "self", ".", "layers", "+=", "[", "nn", ".", "Linear", "(", "last_input", ",", "hidden", ")", ",", "nn", ".", "ReLU", "(", ")", "]", "\n", "last_input", "=", "hidden", "\n", "", "self", ".", "layers", "=", "nn", ".", "Sequential", "(", "*", "self", ".", "layers", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.LaneEmbedding.forward": [[97, 99], ["NewModel.LaneEmbedding.layers"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "states", ")", ":", "\n", "        ", "return", "self", ".", "layers", "(", "states", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.NewModel.__init__": [[102, 133], ["InnerModelBase.InnerModelBase.__init__", "NewModel.PhasePredict", "NewModel.VolumePredict", "nn.Sequential", "range", "NewModel.NewModel.not_phases.append", "NewModel.LaneEmbedding", "nn.Linear", "nn.ReLU", "one.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["    ", "def", "__init__", "(", "self", ",", "dqn_hidden_size", ",", "lane_embedding_size", ",", "observation", ",", "\n", "lane_embedding_instance", "=", "None", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "hidden", "=", "dqn_hidden_size", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "phases", "=", "observation", "[", "'TSphase'", "]", "\n", "self", ".", "lane_number", "=", "observation", "[", "'TSflow'", "]", "[", "0", "]", "\n", "self", ".", "not_phases", "=", "[", "]", "\n", "for", "phase", "in", "self", ".", "phases", ":", "\n", "            ", "one", "=", "[", "]", "\n", "for", "num", "in", "range", "(", "self", ".", "lane_number", ")", ":", "\n", "                ", "if", "num", "not", "in", "phase", ":", "\n", "                    ", "one", ".", "append", "(", "num", ")", "\n", "", "", "self", ".", "not_phases", ".", "append", "(", "one", ")", "\n", "", "self", ".", "weights", "=", "[", "5", ",", "1", "]", "\n", "\n", "self", ".", "shared_lane", "=", "lane_embedding_instance", "is", "not", "None", "\n", "\n", "self", ".", "phase_predict", "=", "PhasePredict", "(", "observation", ",", "**", "kwargs", ")", "\n", "self", ".", "volume_predict", "=", "VolumePredict", "(", "observation", ",", "**", "kwargs", ")", "\n", "\n", "if", "lane_embedding_instance", "is", "not", "None", ":", "\n", "            ", "self", ".", "lane_embedding", "=", "lane_embedding_instance", "\n", "", "else", ":", "\n", "            ", "self", ".", "lane_embedding", "=", "LaneEmbedding", "(", "observation", ",", "\n", "lane_embedding_size", ")", "\n", "\n", "", "self", ".", "fc", "=", "nn", ".", "Sequential", "(", "\n", "nn", ".", "Linear", "(", "lane_embedding_size", "*", "2", "+", "1", ",", "\n", "dqn_hidden_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.NewModel.default_wrapper": [[135, 141], ["None"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "default_wrapper", "(", "dueling_dqn", ",", "**", "kwargs", ")", ":", "\n", "        ", "if", "dueling_dqn", ":", "\n", "            ", "return", "'DuelingSplitModel'", "\n", "", "else", ":", "\n", "            ", "return", "'DQNSplitModel'", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.NewModel.named_modules": [[145, 151], ["super().named_modules", "n.find"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules"], ["def", "named_modules", "(", "self", ",", "memo", "=", "None", ",", "prefix", "=", "''", ")", ":", "\n", "        ", "for", "n", ",", "p", "in", "super", "(", ")", ".", "named_modules", "(", "memo", ",", "prefix", ")", ":", "\n", "            ", "if", "self", ".", "shared_lane", ":", "\n", "                ", "if", "n", ".", "find", "(", "prefix", "+", "'.lane_embedding'", ")", "==", "0", ":", "\n", "                    ", "continue", "\n", "", "", "yield", "n", ",", "p", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.NewModel.replace_lane_embedding": [[152, 155], ["None"], "methods", ["None"], ["", "", "def", "replace_lane_embedding", "(", "self", ",", "lane_embedding", ")", ":", "\n", "        ", "self", ".", "lane_embedding", "=", "lane_embedding", "\n", "self", ".", "shared_lane", "=", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.NewModel.state2tensor": [[156, 170], ["cuda().float", "cuda().float", "cuda().long", "cuda().float", "cuda().float", "cuda().long", "cuda", "cuda", "cuda", "cuda", "torch.tensor", "torch.tensor", "torch.tensor", "torch.tensor", "cuda", "cuda", "torch.tensor", "torch.tensor"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "@", "staticmethod", "\n", "def", "state2tensor", "(", "state", ")", ":", "\n", "        ", "res", "=", "{", "}", "\n", "res", "[", "'TSflow'", "]", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSflow'", "]", ")", ")", ".", "float", "(", ")", "\n", "res", "[", "'TSgreen'", "]", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSgreen'", "]", ")", ")", ".", "float", "(", ")", "\n", "res", "[", "'TSphase'", "]", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSphase'", "]", ")", ")", ".", "long", "(", ")", "\n", "res", "[", "'Envtime'", "]", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'Envtime'", "]", ")", ")", ".", "float", "(", ")", "\n", "NILVN", "=", "'NextInLaneVehicleNumber'", "\n", "if", "NILVN", "in", "state", ":", "\n", "            ", "res", "[", "NILVN", "]", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "NILVN", "]", ")", ")", ".", "float", "(", ")", "\n", "", "NP", "=", "'NextPhase'", "\n", "if", "NP", "in", "state", ":", "\n", "            ", "res", "[", "NP", "]", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "NP", "]", ")", ")", ".", "long", "(", ")", "\n", "", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModel.NewModel.forward": [[171, 193], ["nn.functional.one_hot", "phase_s.float().unsqueeze.float().unsqueeze.float().unsqueeze", "torch.stack", "NewModel.NewModel.lane_embedding", "enumerate", "torch.stack", "NewModel.NewModel.fc", "zip", "NewModel.NewModel.append", "len", "phase_s.float().unsqueeze.float().unsqueeze.float", "torch.cat", "x[].mean", "x[].mean"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "forward", "(", "self", ",", "state", ")", ":", "\n", "        ", "flow", "=", "state", "[", "'TSflow'", "]", "\n", "green", "=", "state", "[", "'TSgreen'", "]", "\n", "phase", "=", "state", "[", "'TSphase'", "]", "\n", "predict", "=", "state", "[", "'predict'", "]", "\n", "phase_s", "=", "nn", ".", "functional", ".", "one_hot", "(", "phase", ",", "num_classes", "=", "len", "(", "self", ".", "phases", ")", ")", "\n", "phase_s", "=", "phase_s", ".", "float", "(", ")", ".", "unsqueeze", "(", "-", "1", ")", "# [BATCH, PHASE, 1]", "\n", "\n", "x", "=", "torch", ".", "stack", "(", "(", "flow", ",", "green", ",", "predict", ")", ",", "dim", "=", "-", "1", ")", "\n", "x", "=", "self", ".", "lane_embedding", "(", "x", ")", "# [BATCH, LANE, HIDDEN]", "\n", "\n", "res", "=", "[", "]", "\n", "for", "i", ",", "[", "phase", ",", "not_phase", "]", "in", "enumerate", "(", "zip", "(", "self", ".", "phases", ",", "\n", "self", ".", "not_phases", ")", ")", ":", "\n", "            ", "res", ".", "append", "(", "torch", ".", "cat", "(", "(", "\n", "x", "[", ":", ",", "phase", "]", ".", "mean", "(", "dim", "=", "1", ")", "*", "self", ".", "weights", "[", "0", "]", ",", "\n", "x", "[", ":", ",", "not_phase", "]", ".", "mean", "(", "dim", "=", "1", ")", "*", "self", ".", "weights", "[", "1", "]", ",", "\n", "phase_s", "[", ":", ",", "i", "]", ")", ",", "dim", "=", "-", "1", ")", ")", "\n", "", "res", "=", "torch", ".", "stack", "(", "res", ",", "dim", "=", "1", ")", "# [BATCH, PHASE, HIDDEN]", "\n", "res", "=", "self", ".", "fc", "(", "res", ")", "\n", "\n", "return", "res", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.RoadCommunication.__init__": [[9, 18], ["nn.Module.__init__", "nn.Linear", "nn.MultiheadAttention"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "observation", ",", "NM_road_predict_hidden", ",", "\n", "NM_scale_by_lane_number", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "hidden", "=", "NM_road_predict_hidden", "\n", "self", ".", "lane_scale", "=", "NM_scale_by_lane_number", "\n", "\n", "self", ".", "fc", "=", "nn", ".", "Linear", "(", "2", ",", "self", ".", "hidden", ")", "\n", "self", ".", "attention", "=", "nn", ".", "MultiheadAttention", "(", "self", ".", "hidden", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.RoadCommunication.forward": [[19, 67], ["NewModelNaiveCommu.RoadCommunication.fc", "NewModelNaiveCommu.RoadCommunication.mean().transpose", "zip", "torch.stack", "torch.stack", "v.mean", "torch.stack.append", "lanewidths.unsqueeze().unsqueeze", "NewModelNaiveCommu.RoadCommunication.mean", "NewModelNaiveCommu.RoadCommunication.transpose", "sum", "v.mean.squeeze", "lanewidths.unsqueeze"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "forward", "(", "self", ",", "states", ",", "road_relation", ")", ":", "\n", "        ", "road2rl", "=", "road_relation", "[", "'RoadOut2RoadLink'", "]", "\n", "roadwidths", "=", "road_relation", "[", "'RoadOutLanes'", "]", "# [R]", "\n", "lanewidths", "=", "road_relation", "[", "'LaneCount'", "]", "# [L]", "\n", "flow", "=", "states", "[", "'TSflow'", "]", "\n", "green", "=", "states", "[", "'TSgreen'", "]", "\n", "x", "=", "self", ".", "fc", "(", "torch", ".", "stack", "(", "(", "flow", ",", "green", ")", ",", "dim", "=", "-", "1", ")", ")", "# [B, L, H]", "\n", "if", "self", ".", "lane_scale", ":", "\n", "            ", "x", "=", "x", "*", "lanewidths", ".", "unsqueeze", "(", "-", "1", ")", ".", "unsqueeze", "(", "0", ")", "\n", "", "q", "=", "x", ".", "mean", "(", "dim", "=", "-", "2", ",", "keepdim", "=", "True", ")", ".", "transpose", "(", "0", ",", "1", ")", "# [1, B, H]", "\n", "res", "=", "[", "]", "\n", "for", "rls", ",", "rwidth", "in", "zip", "(", "road2rl", ",", "roadwidths", ")", ":", "\n", "            ", "\"\"\"same as below, but may calculate quicker in CPU?\n            k = []\n            for num, rlid in enumerate(rls):\n                if not rlid:\n                    k.append(x[:, num])\n                    print(k[-1].shape)\n            k = v = torch.stack(k, dim = 0) # [X, B, H]\n            att1, att_w1 = self.attention(q, k, v)\n            \"\"\"", "\n", "\n", "k", "=", "v", "=", "x", ".", "transpose", "(", "0", ",", "1", ")", "[", "rls", "]", "# [L, B, H]", "\n", "# att, att_w = self.attention(q, k, v)", "\n", "att", "=", "v", ".", "mean", "(", "0", ",", "keepdim", "=", "True", ")", "\n", "\n", "if", "self", ".", "lane_scale", ":", "\n", "                ", "srw", "=", "sum", "(", "rwidth", ")", "\n", "if", "srw", "==", "0", ":", "\n", "                    ", "srw", "=", "999", "\n", "", "att", "=", "att", "/", "srw", "\n", "", "res", ".", "append", "(", "att", ".", "squeeze", "(", "0", ")", ")", "\n", "# if flow.shape[0] > 1: pdb.set_trace()", "\n", "", "res", "=", "torch", ".", "stack", "(", "res", ",", "dim", "=", "1", ")", "# [B, R, H]", "\n", "\n", "\"\"\"not work on old version of pytorch, not tested on new version\n        R = len(self.road2rl)\n        k = v = x.transpose(0, 1).repeat_interleave(R, dim = 1) # [L, B*R, H]\n        q = x.mean(dim = -2, keepdim = True).transpose(0, 1)\n        q = q.repeat_interleave(R, dim = 1) # [1, B*R, H]\n        mask = self.road2rl.repeat(flow.shape[0], 1)\n        att, att_w = self.attention(q, k, v, attn_mask = mask)\n        res = att.reshape(-1, R, self.hidden)\n        if res.shape[0] > 1:\n            pdb.set_trace()\n        \"\"\"", "\n", "\n", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.LaneEmbedding.__init__": [[70, 83], ["nn.Module.__init__", "isinstance", "nn.Sequential", "nn.Linear", "nn.ReLU"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "observation", ",", "lane_embedding_size", ",", "rcomm_hidden", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "layers", "=", "[", "]", "\n", "if", "isinstance", "(", "lane_embedding_size", ",", "int", ")", ":", "\n", "            ", "lane_embedding_size", "=", "[", "lane_embedding_size", "]", "\n", "", "self", ".", "lane_embedding_size", "=", "lane_embedding_size", "\n", "self", ".", "input", "=", "2", "+", "rcomm_hidden", "\n", "last_input", "=", "self", ".", "input", "\n", "for", "hidden", "in", "lane_embedding_size", ":", "\n", "            ", "self", ".", "layers", "+=", "[", "nn", ".", "Linear", "(", "last_input", ",", "hidden", ")", ",", "nn", ".", "ReLU", "(", ")", "]", "\n", "last_input", "=", "hidden", "\n", "", "self", ".", "layers", "=", "nn", ".", "Sequential", "(", "*", "self", ".", "layers", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.LaneEmbedding.forward": [[84, 86], ["NewModelNaiveCommu.LaneEmbedding.layers"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "states", ")", ":", "\n", "        ", "return", "self", ".", "layers", "(", "states", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.__init__": [[89, 120], ["InnerModelBase.InnerModelBase.__init__", "NewModelNaiveCommu.RoadCommunication", "nn.Sequential", "range", "NewModelNaiveCommu.NewModelNaiveCommu.not_phases.append", "NewModelNaiveCommu.LaneEmbedding", "nn.Linear", "nn.ReLU", "one.append"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["    ", "def", "__init__", "(", "self", ",", "dqn_hidden_size", ",", "lane_embedding_size", ",", "observation", ",", "\n", "lane_embedding_instance", "=", "None", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "hidden", "=", "dqn_hidden_size", "\n", "self", ".", "observation", "=", "observation", "\n", "self", ".", "phases", "=", "observation", "[", "'TSphase'", "]", "\n", "self", ".", "lane_number", "=", "observation", "[", "'TSflow'", "]", "[", "0", "]", "\n", "self", ".", "not_phases", "=", "[", "]", "\n", "for", "phase", "in", "self", ".", "phases", ":", "\n", "            ", "one", "=", "[", "]", "\n", "for", "num", "in", "range", "(", "self", ".", "lane_number", ")", ":", "\n", "                ", "if", "num", "not", "in", "phase", ":", "\n", "                    ", "one", ".", "append", "(", "num", ")", "\n", "", "", "self", ".", "not_phases", ".", "append", "(", "one", ")", "\n", "", "self", ".", "weights", "=", "[", "5", ",", "1", "]", "\n", "\n", "self", ".", "shared_lane", "=", "lane_embedding_instance", "is", "not", "None", "\n", "\n", "self", ".", "roadcomm", "=", "RoadCommunication", "(", "observation", ",", "**", "kwargs", ")", "\n", "self", ".", "rcomm_hidden", "=", "self", ".", "roadcomm", ".", "hidden", "\n", "\n", "if", "lane_embedding_instance", "is", "not", "None", ":", "\n", "            ", "self", ".", "lane_embedding", "=", "lane_embedding_instance", "\n", "", "else", ":", "\n", "            ", "self", ".", "lane_embedding", "=", "LaneEmbedding", "(", "observation", ",", "\n", "lane_embedding_size", ",", "\n", "self", ".", "rcomm_hidden", ")", "\n", "\n", "", "self", ".", "fc", "=", "nn", ".", "Sequential", "(", "\n", "nn", ".", "Linear", "(", "lane_embedding_size", "*", "2", ",", "dqn_hidden_size", ")", ",", "\n", "nn", ".", "ReLU", "(", ")", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.default_wrapper": [[122, 128], ["None"], "methods", ["None"], ["", "@", "staticmethod", "\n", "def", "default_wrapper", "(", "dueling_dqn", ",", "**", "kwargs", ")", ":", "\n", "        ", "if", "dueling_dqn", ":", "\n", "            ", "return", "'DuelingSplitModel'", "\n", "", "else", ":", "\n", "            ", "return", "'DQNSplitModel'", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.named_modules": [[132, 138], ["super().named_modules", "n.find"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules"], ["def", "named_modules", "(", "self", ",", "memo", "=", "None", ",", "prefix", "=", "''", ")", ":", "\n", "        ", "for", "n", ",", "p", "in", "super", "(", ")", ".", "named_modules", "(", "memo", ",", "prefix", ")", ":", "\n", "            ", "if", "self", ".", "shared_lane", ":", "\n", "                ", "if", "n", ".", "find", "(", "prefix", "+", "'.lane_embedding'", ")", "==", "0", ":", "\n", "                    ", "continue", "\n", "", "", "yield", "n", ",", "p", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.replace_lane_embedding": [[139, 142], ["None"], "methods", ["None"], ["", "", "def", "replace_lane_embedding", "(", "self", ",", "lane_embedding", ")", ":", "\n", "        ", "self", ".", "lane_embedding", "=", "lane_embedding", "\n", "self", ".", "shared_lane", "=", "True", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.state2tensor": [[143, 149], ["cuda().float", "cuda().float", "cuda", "cuda", "torch.tensor", "torch.tensor"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "@", "staticmethod", "\n", "def", "state2tensor", "(", "state", ")", ":", "\n", "        ", "res", "=", "{", "}", "\n", "res", "[", "'TSflow'", "]", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSflow'", "]", ")", ")", ".", "float", "(", ")", "\n", "res", "[", "'TSgreen'", "]", "=", "cuda", "(", "torch", ".", "tensor", "(", "state", "[", "'TSgreen'", "]", ")", ")", ".", "float", "(", ")", "\n", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.forward": [[150, 168], ["torch.stack", "torch.cat", "NewModelNaiveCommu.NewModelNaiveCommu.lane_embedding", "zip", "torch.stack", "NewModelNaiveCommu.NewModelNaiveCommu.fc", "NewModelNaiveCommu.NewModelNaiveCommu.append", "torch.cat", "x[].mean", "x[].mean"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "forward", "(", "self", ",", "state", ")", ":", "\n", "        ", "flow", "=", "state", "[", "'TSflow'", "]", "\n", "green", "=", "state", "[", "'TSgreen'", "]", "\n", "rcomm", "=", "state", "[", "'rcomm'", "]", "\n", "\n", "x", "=", "torch", ".", "stack", "(", "(", "flow", ",", "green", ")", ",", "dim", "=", "-", "1", ")", "\n", "x", "=", "torch", ".", "cat", "(", "(", "x", ",", "rcomm", ")", ",", "dim", "=", "-", "1", ")", "\n", "x", "=", "self", ".", "lane_embedding", "(", "x", ")", "# [BATCH, LANE, HIDDEN]", "\n", "\n", "res", "=", "[", "]", "\n", "for", "phase", ",", "not_phase", "in", "zip", "(", "self", ".", "phases", ",", "self", ".", "not_phases", ")", ":", "\n", "            ", "res", ".", "append", "(", "torch", ".", "cat", "(", "(", "\n", "x", "[", ":", ",", "phase", "]", ".", "mean", "(", "dim", "=", "1", ")", "*", "self", ".", "weights", "[", "0", "]", ",", "\n", "x", "[", ":", ",", "not_phase", "]", ".", "mean", "(", "dim", "=", "1", ")", "*", "self", ".", "weights", "[", "1", "]", ")", ",", "dim", "=", "-", "1", ")", ")", "\n", "", "res", "=", "torch", ".", "stack", "(", "res", ",", "dim", "=", "1", ")", "# [BATCH, PHASE, HIDDEN]", "\n", "res", "=", "self", ".", "fc", "(", "res", ")", "\n", "\n", "return", "res", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DQNSplitModel.DQNSplitModel.__init__": [[10, 14], ["DQNBasicModel.DQNBasicModel.__init__", "nn.Linear"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", "**", "kwargs", ")", "\n", "\n", "self", ".", "fc", "=", "nn", ".", "Linear", "(", "self", ".", "hidden", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DQNSplitModel.DQNSplitModel.forward": [[15, 20], ["DQNSplitModel.DQNSplitModel.inner", "DQNSplitModel.DQNSplitModel.fc", "x.squeeze.squeeze.squeeze"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "state", ")", ":", "\n", "        ", "x", "=", "self", ".", "inner", "(", "state", ")", "\n", "x", "=", "self", ".", "fc", "(", "x", ")", "\n", "x", "=", "x", ".", "squeeze", "(", "-", "1", ")", "\n", "return", "x", "# .reshape(*x.shape[:-2], -1)", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DQNBasicModel.DQNBasicModel.__init__": [[8, 29], ["WrapperModelBase.WrapperModelBase.__init__", "np.random.RandomState", "DQNBasicModel.DQNBasicModel.random.randint", "innerModel", "nn.Linear"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint"], ["    ", "def", "__init__", "(", "self", ",", "innerModel", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "\n", "self", ".", "actions", "=", "kwargs", "[", "'action'", "]", "\n", "# assert(len(self.action) == 1)", "\n", "self", ".", "action", "=", "1", "\n", "for", "i", "in", "self", ".", "actions", ":", "\n", "            ", "self", ".", "action", "*=", "i", "\n", "\n", "", "self", ".", "random", "=", "np", ".", "random", ".", "RandomState", "(", "kwargs", "[", "'seed'", "]", ")", "\n", "kwargs", "[", "'seed'", "]", "=", "self", ".", "random", ".", "randint", "(", "2", "**", "31", ")", "\n", "\n", "self", ".", "hidden", "=", "kwargs", "[", "'dqn_hidden_size'", "]", "\n", "self", ".", "TXSW", "=", "None", "\n", "if", "'TXSW'", "in", "kwargs", ":", "\n", "            ", "self", ".", "TXSW", "=", "kwargs", "[", "'TXSW'", "]", "\n", "\n", "", "self", ".", "inner", "=", "innerModel", "(", "**", "kwargs", ")", "\n", "\n", "# self.fc = nn.Linear(self.hidden, self.action.sum())", "\n", "self", ".", "fc", "=", "nn", ".", "Linear", "(", "self", ".", "hidden", ",", "self", ".", "action", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DQNBasicModel.DQNBasicModel.forward": [[30, 34], ["DQNBasicModel.DQNBasicModel.inner", "DQNBasicModel.DQNBasicModel.fc"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "state", ")", ":", "\n", "        ", "x", "=", "self", ".", "inner", "(", "state", ")", "\n", "x", "=", "self", ".", "fc", "(", "x", ")", "\n", "return", "x", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DuelingSplitModel.DuelingSplitModel.__init__": [[6, 11], ["DQNSplitModel.DQNSplitModel.__init__", "nn.Linear", "sum"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", "**", "kwargs", ")", "\n", "\n", "self", ".", "V_obs", "=", "self", ".", "hidden", "*", "sum", "(", "self", ".", "actions", ")", "# split embedding, so add", "\n", "self", ".", "V", "=", "nn", ".", "Linear", "(", "self", ".", "V_obs", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DuelingSplitModel.DuelingSplitModel.forward": [[12, 21], ["DuelingSplitModel.DuelingSplitModel.inner", "DuelingSplitModel.DuelingSplitModel.V", "DuelingSplitModel.DuelingSplitModel.fc", "x.squeeze.squeeze.squeeze", "torch.mean().unsqueeze", "x.squeeze.squeeze.reshape", "torch.mean", "len"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "state", ")", ":", "\n", "        ", "x", "=", "self", ".", "inner", "(", "state", ")", "\n", "V", "=", "self", ".", "V", "(", "x", ".", "reshape", "(", "*", "x", ".", "shape", "[", ":", "-", "2", "]", ",", "-", "1", ")", ")", "\n", "x", "=", "self", ".", "fc", "(", "x", ")", "\n", "x", "=", "x", ".", "squeeze", "(", "-", "1", ")", "\n", "mean", "=", "torch", ".", "mean", "(", "x", ",", "dim", "=", "-", "1", ")", ".", "unsqueeze", "(", "-", "1", ")", "\n", "# print(x, mean, V)", "\n", "# print(x.shape, mean.shape, V.shape)", "\n", "return", "x", "+", "(", "V", "-", "mean", ")", ".", "repeat", "(", "*", "(", "[", "1", "]", "*", "(", "len", "(", "x", ".", "shape", ")", "-", "1", ")", ")", ",", "x", ".", "shape", "[", "-", "1", "]", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DQNDuelingCommu.DQNDuelingCommu.__init__": [[6, 11], ["DQNDuelingModel.DQNDuelingModel.__init__", "nn.Linear", "nn.Linear"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "*", "argv", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", "*", "argv", ",", "**", "kwargs", ")", "\n", "\n", "self", ".", "fc", "=", "nn", ".", "Linear", "(", "self", ".", "hidden", "*", "2", ",", "self", ".", "action", ")", "\n", "self", ".", "V", "=", "nn", ".", "Linear", "(", "self", ".", "hidden", "*", "2", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DQNDuelingCommu.DQNDuelingCommu.forward": [[12, 18], ["DQNDuelingCommu.DQNDuelingCommu.fc", "torch.mean().unsqueeze", "DQNDuelingCommu.DQNDuelingCommu.V", "torch.mean", "len"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "x", ")", ":", "\n", "        ", "a", "=", "self", ".", "fc", "(", "x", ")", "\n", "mean", "=", "torch", ".", "mean", "(", "a", ",", "dim", "=", "-", "1", ")", ".", "unsqueeze", "(", "-", "1", ")", "\n", "v", "=", "self", ".", "V", "(", "x", ")", "\n", "# print(a.shape, mean.shape, v.shape)", "\n", "return", "a", "+", "(", "v", "-", "mean", ")", ".", "repeat", "(", "*", "(", "[", "1", "]", "*", "(", "len", "(", "a", ".", "shape", ")", "-", "1", ")", ")", ",", "a", ".", "shape", "[", "-", "1", "]", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.WrapperModelBase.WrapperModelBase.__init__": [[11, 13], ["torch.Module.__init__"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DQNDuelingModel.DQNDuelingModel.__init__": [[6, 10], ["DQNBasicModel.DQNBasicModel.__init__", "nn.Linear"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", "**", "kwargs", ")", "\n", "\n", "self", ".", "V", "=", "nn", ".", "Linear", "(", "self", ".", "hidden", ",", "1", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.wrapperModels.DQNDuelingModel.DQNDuelingModel.forward": [[11, 18], ["DQNDuelingModel.DQNDuelingModel.inner", "DQNDuelingModel.DQNDuelingModel.fc", "torch.mean().unsqueeze", "DQNDuelingModel.DQNDuelingModel.V", "torch.mean", "len"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "state", ")", ":", "\n", "        ", "x", "=", "self", ".", "inner", "(", "state", ")", "\n", "a", "=", "self", ".", "fc", "(", "x", ")", "\n", "mean", "=", "torch", ".", "mean", "(", "a", ",", "dim", "=", "-", "1", ")", ".", "unsqueeze", "(", "-", "1", ")", "\n", "v", "=", "self", ".", "V", "(", "x", ")", "\n", "# print(a.shape, mean.shape, v.shape)", "\n", "return", "a", "+", "(", "v", "-", "mean", ")", ".", "repeat", "(", "*", "(", "[", "1", "]", "*", "(", "len", "(", "a", ".", "shape", ")", "-", "1", ")", ")", ",", "a", ".", "shape", "[", "-", "1", "]", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.determinedAgents.SOTLAgent.SOTLAgent.__init__": [[5, 16], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "work_folder", ",", "cityflow_config", ",", "observation", ",", "action", ",", "\n", "sotl_green_threshold", ",", "sotl_red_threshold", ",", "\n", "sotl_min_switch", ",", "sotl_max_switch", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "observation_space", "=", "observation", "\n", "self", ".", "action_space", "=", "action", "\n", "self", ".", "phases", "=", "observation", "[", "'TSphase'", "]", "\n", "\n", "self", ".", "greent", "=", "sotl_green_threshold", "\n", "self", ".", "redt", "=", "sotl_red_threshold", "\n", "self", ".", "mins", "=", "sotl_min_switch", "\n", "self", ".", "maxs", "=", "sotl_max_switch", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.determinedAgents.SOTLAgent.SOTLAgent.get_action": [[17, 41], ["int", "len", "log", "vnum.append", "len", "len", "len", "len"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "def", "get_action", "(", "self", ",", "state", ")", ":", "\n", "        ", "if", "len", "(", "state", "[", "'TSphase'", "]", ")", ">", "1", ":", "\n", "            ", "log", "(", "\"Not support batch size > 1\"", ",", "level", "=", "'ERROR'", ")", "\n", "raise", "ValueError", "\n", "", "now_phase", "=", "int", "(", "state", "[", "'TSphase'", "]", "[", "0", "]", ")", "\n", "time", "=", "state", "[", "'TStime'", "]", "[", "0", "]", "\n", "state", "=", "state", "[", "'TSflow'", "]", "[", "0", "]", "\n", "vnum", "=", "[", "]", "\n", "if", "time", "<", "self", ".", "mins", ":", "\n", "            ", "return", "[", "[", "now_phase", "]", "]", "\n", "", "elif", "time", ">", "self", ".", "maxs", ":", "\n", "            ", "return", "[", "[", "(", "now_phase", "+", "1", ")", "%", "len", "(", "self", ".", "phases", ")", "]", "]", "\n", "", "for", "p", "in", "self", ".", "phases", ":", "\n", "            ", "tot", "=", "0", "\n", "for", "i", "in", "p", ":", "\n", "                ", "tot", "+=", "state", "[", "i", "]", "\n", "", "if", "len", "(", "p", ")", ">", "0", ":", "\n", "                ", "tot", "/=", "len", "(", "p", ")", "\n", "", "vnum", ".", "append", "(", "tot", ")", "\n", "\n", "", "next_phase", "=", "(", "now_phase", "+", "1", ")", "%", "len", "(", "self", ".", "phases", ")", "\n", "if", "vnum", "[", "now_phase", "]", "<=", "self", ".", "greent", "and", "vnum", "[", "next_phase", "]", ">", "self", ".", "redt", ":", "\n", "            ", "return", "[", "[", "next_phase", "]", "]", "\n", "", "return", "[", "[", "now_phase", "]", "]", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.determinedAgents.FixedTimeAgent.FixedTimeAgent.__init__": [[5, 12], ["int", "len"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "fixed_time", ",", "cityflow_config", ",", "observation", ",", "**", "kwargs", ")", ":", "\n", "        ", "min_action_time", "=", "cityflow_config", "[", "'MIN_ACTION_TIME'", "]", "\n", "self", ".", "fixed_time", "=", "fixed_time", "\n", "self", ".", "min_action_time", "=", "min_action_time", "\n", "self", ".", "round", "=", "int", "(", "fixed_time", "/", "min_action_time", ")", "\n", "self", ".", "count", "=", "0", "\n", "self", ".", "available", "=", "len", "(", "observation", "[", "'TSphase'", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.determinedAgents.FixedTimeAgent.FixedTimeAgent.get_action": [[13, 20], ["int"], "methods", ["None"], ["", "def", "get_action", "(", "self", ",", "state", ")", ":", "\n", "        ", "self", ".", "count", "+=", "1", "\n", "now_phase", "=", "int", "(", "state", "[", "'TSphase'", "]", ")", "\n", "if", "self", ".", "count", "==", "self", ".", "round", ":", "\n", "            ", "self", ".", "count", "=", "0", "\n", "return", "[", "[", "(", "now_phase", "+", "1", ")", "%", "self", ".", "available", "]", "]", "\n", "", "return", "[", "[", "now_phase", "]", "]", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.determinedAgents.DeterminedAgentBase.DeterminedAgentBase.__init__": [[10, 12], ["None"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "**", "kwargs", ")", ":", "\n", "        ", "pass", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.determinedAgents.RandomAgent.RandomAgent.__init__": [[5, 8], ["np.random.RandomState"], "methods", ["None"], ["    ", "def", "__init__", "(", "self", ",", "action", ",", "seed", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "phase_num", "=", "action", "[", "0", "]", "\n", "self", ".", "random", "=", "np", ".", "random", ".", "RandomState", "(", "seed", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.determinedAgents.RandomAgent.RandomAgent.get_action": [[9, 11], ["RandomAgent.RandomAgent.random.randint"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint"], ["", "def", "get_action", "(", "self", ",", "state", ")", ":", "\n", "        ", "return", "[", "[", "self", ".", "random", ".", "randint", "(", "self", ".", "phase_num", ")", "]", "for", "_", "in", "state", "[", "'TSflow'", "]", "]", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare.__init__": [[10, 44], ["MAL.MAL.__init__", "MALShare.MALShare.random.randint", "AgentClass", "MALShare.MALShare.agent.init_communicate", "len", "len", "MALShare.MALShare.agents.append", "list", "range", "len"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint", "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.init_communicate", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["    ", "def", "__init__", "(", "self", ",", "AgentClass", ",", "observation", ",", "action", ",", "**", "kwargs", ")", ":", "\n", "# remove observation and action, so MAL.__init__ won't create any agent", "\n", "        ", "super", "(", ")", ".", "__init__", "(", "AgentClass", "=", "AgentClass", ",", "\n", "observation", "=", "[", "]", ",", "\n", "action", "=", "[", "]", ",", "\n", "**", "kwargs", ")", "\n", "# new init, only generate one agent instance. ", "\n", "self", ".", "observation_space", "=", "observation", "\n", "self", ".", "action_space", "=", "action", "\n", "assert", "len", "(", "observation", ")", "==", "len", "(", "action", ")", "\n", "\"\"\"\n        for obs in observation:\n            if observation[0] != obs and False:\n                log('observations not all same! cannot use MALShare', \n                    level = 'ERROR')\n                raise ValueError\n        for act in action:\n            if action[0] != act:\n                log('actions not all same! cannot use MALShare', \n                    level = 'ERROR')\n                raise ValueError\n        \"\"\"", "\n", "kwargs", "[", "'observation'", "]", "=", "observation", "[", "0", "]", "\n", "kwargs", "[", "'action'", "]", "=", "action", "[", "0", "]", "\n", "kwargs", "[", "'seed'", "]", "=", "self", ".", "random", ".", "randint", "(", "2", "**", "31", ")", "\n", "self", ".", "agent", "=", "AgentClass", "(", "indices", "=", "list", "(", "range", "(", "len", "(", "action", ")", ")", ")", ",", "**", "kwargs", ")", "\n", "# for inherit functions", "\n", "for", "_", "in", "action", ":", "\n", "            ", "self", ".", "agents", ".", "append", "(", "self", ".", "agent", ")", "\n", "", "self", ".", "agent", ".", "init_communicate", "(", "\n", "agents", "=", "self", ".", "agents", ",", "\n", "all_observation", "=", "observation", ",", "\n", "all_action", "=", "action", ",", "\n", "**", "kwargs", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare._load_from_state_dict": [[46, 51], ["super()._load_from_state_dict"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare._load_from_state_dict"], ["", "def", "_load_from_state_dict", "(", "self", ",", "state_dict", ",", "prefix", ",", "local_metadata", ",", "strict", ",", "\n", "missing_keys", ",", "unexpected_keys", ",", "error_msgs", ")", ":", "\n", "        ", "super", "(", ")", ".", "_load_from_state_dict", "(", "state_dict", ",", "prefix", ",", "local_metadata", ",", "\n", "strict", ",", "missing_keys", ",", "unexpected_keys", ",", "\n", "error_msgs", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare.named_modules": [[52, 55], ["MALShare.MALShare.agent.named_modules"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules"], ["", "def", "named_modules", "(", "self", ",", "memo", "=", "None", ",", "prefix", "=", "''", ")", ":", "\n", "# self.agents is fake, only self.agent.parameters() is valid", "\n", "        ", "return", "self", ".", "agent", ".", "named_modules", "(", "memo", ",", "prefix", "+", "'.agent'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare.forward": [[56, 64], ["MALShare.MALShare.agent.forward", "agent.forward_model_select", "func_step"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.forward_model_select"], ["", "def", "forward", "(", "self", ",", "state", ",", "**", "kwargs", ")", ":", "\n", "        ", "for", "agent", "in", "self", ".", "agents", ":", "\n", "            ", "agent", ".", "forward_model_select", "(", "**", "kwargs", ")", "\n", "", "data", "=", "state", "\n", "funcs", "=", "self", ".", "agent", ".", "forward", "(", ")", "\n", "for", "func_step", "in", "funcs", ":", "\n", "            ", "data", "=", "func_step", "(", "data", ")", "\n", "", "return", "data", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare._loss_backward": [[65, 67], ["losses.backward"], "methods", ["None"], ["", "def", "_loss_backward", "(", "self", ",", "losses", ")", ":", "\n", "        ", "losses", ".", "backward", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare.update_policy": [[68, 81], ["MALShare.MALShare.get_action_in_update_policy", "torch.stack", "torch.stack", "MALShare.MALShare.agent.calculate_loss", "MALShare.MALShare._loss_backward", "MALShare.MALShare.agent.optimizer_step", "zip", "sample_one.extend"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.get_action_in_update_policy", "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.calculate_loss", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase._loss_backward", "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.optimizer_step"], ["", "def", "update_policy", "(", "self", ",", "samples_raw", ",", "frame", ")", ":", "\n", "        ", "samples", "=", "self", ".", "get_action_in_update_policy", "(", "samples_raw", ")", "\n", "# gather all sample as one and feed", "\n", "sample", "=", "[", "[", "]", "for", "_", "in", "samples", "[", "0", "]", "]", "\n", "for", "s", "in", "samples", ":", "\n", "            ", "for", "sample_one", ",", "s_one", "in", "zip", "(", "sample", ",", "s", ")", ":", "\n", "                ", "sample_one", ".", "extend", "(", "s_one", ")", "\n", "", "", "sample", "[", "0", "]", "=", "torch", ".", "stack", "(", "sample", "[", "0", "]", ")", "\n", "sample", "[", "3", "]", "=", "torch", ".", "stack", "(", "sample", "[", "3", "]", ")", "\n", "# update only agent", "\n", "L", "=", "self", ".", "agent", ".", "calculate_loss", "(", "sample", ",", "frame", ",", "'loss'", ")", "\n", "self", ".", "_loss_backward", "(", "L", ")", "\n", "self", ".", "agent", ".", "optimizer_step", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare.action": [[82, 93], ["MALShare.MALShare.unpack_states_in_action", "MALShare.MALShare.agent.get_action", "list", "torch.no_grad", "MALShare.MALShare.forward", "torch.stack", "zip"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.unpack_states_in_action", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.get_action", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward"], ["", "def", "action", "(", "self", ",", "states", ",", "eps", "=", "0", ",", "model_name", "=", "'update'", ",", "**", "kwargs", ")", ":", "\n", "# states: [Batch, Intersection, {data dict}]", "\n", "# return: [Batch, InterAgent, ActionsInOneInter]", "\n", "        ", "states", "=", "self", ".", "unpack_states_in_action", "(", "states", ")", "\n", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "            ", "state_action", "=", "self", ".", "forward", "(", "states", ",", "model_name", "=", "model_name", ",", "\n", "**", "kwargs", ")", "\n", "", "res", "=", "self", ".", "agent", ".", "get_action", "(", "torch", ".", "stack", "(", "state_action", ")", ",", "eps", ")", "\n", "# now res shape: [Agents, Batch, ActionNumForOneInter=1]", "\n", "res", "=", "list", "(", "zip", "(", "*", "res", ")", ")", "\n", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare.update_best": [[94, 97], ["MALShare.MALShare.agent.update_best"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.update_best"], ["", "def", "update_best", "(", "self", ")", ":", "\n", "# only one model", "\n", "        ", "self", ".", "agent", ".", "update_best", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MALShare.MALShare.log_model_structure": [[98, 102], ["log", "MALShare.MALShare.agent.log_model_structure"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.log_model_structure"], ["", "def", "log_model_structure", "(", "self", ")", ":", "\n", "        ", "log", "(", "'IQLShare, every model use same model structure and have same '", "\n", "'weight.'", ",", "level", "=", "'ALL'", ")", "# different log", "\n", "self", ".", "agent", ".", "log_model_structure", "(", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.__init__": [[8, 20], ["np.random.RandomState", "enumerate", "len", "len", "zip", "IndependentDetermined.IndependentDetermined.random.randint", "IndependentDetermined.IndependentDetermined.agents.append", "AgentClass"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["    ", "def", "__init__", "(", "self", ",", "AgentClass", ",", "observation", ",", "action", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "observation_space", "=", "observation", "\n", "self", ".", "action_space", "=", "action", "\n", "assert", "len", "(", "observation", ")", "==", "len", "(", "action", ")", "\n", "self", ".", "agents", "=", "[", "]", "\n", "self", ".", "random", "=", "np", ".", "random", ".", "RandomState", "(", "kwargs", "[", "'seed'", "]", ")", "\n", "for", "num", ",", "[", "obs", ",", "act", "]", "in", "enumerate", "(", "zip", "(", "observation", ",", "action", ")", ")", ":", "\n", "            ", "kwargs", "[", "'observation'", "]", "=", "obs", "\n", "kwargs", "[", "'action'", "]", "=", "act", "\n", "kwargs", "[", "'seed'", "]", "=", "self", ".", "random", ".", "randint", "(", "2", "**", "31", ")", "\n", "kwargs", "[", "'index'", "]", "=", "num", "\n", "self", ".", "agents", ".", "append", "(", "AgentClass", "(", "**", "kwargs", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.unpack_states_in_action": [[21, 25], ["list", "zip", "flatten_data"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.flatten_data"], ["", "", "def", "unpack_states_in_action", "(", "self", ",", "states", ")", ":", "\n", "        ", "states", "=", "list", "(", "zip", "(", "*", "states", ")", ")", "\n", "# output: [Agents, { every value: [Batch, (...data shape)] }]", "\n", "return", "[", "flatten_data", "(", "'dict'", ",", "x", ")", "for", "x", "in", "states", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.get_action": [[26, 37], ["IndependentDetermined.IndependentDetermined.unpack_states_in_action", "zip", "list", "list.append", "zip", "agent.get_action"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.unpack_states_in_action", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.get_action"], ["", "def", "get_action", "(", "self", ",", "states", ")", ":", "\n", "# states: [Batch, Intersection, {data dict}]", "\n", "# return: [Batch, InterAgent, ActionsInOneInter]", "\n", "        ", "res", "=", "[", "]", "\n", "states", "=", "self", ".", "unpack_states_in_action", "(", "states", ")", "\n", "# pdb.set_trace()", "\n", "for", "agent", ",", "state", "in", "zip", "(", "self", ".", "agents", ",", "states", ")", ":", "\n", "            ", "res", ".", "append", "(", "agent", ".", "get_action", "(", "state", ")", ")", "\n", "# res shape: [Agents, Batch, ActionNumForOneInter=1]", "\n", "", "res", "=", "list", "(", "zip", "(", "*", "res", ")", ")", "\n", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.cuda": [[38, 40], ["NotImplementedError"], "methods", ["None"], ["", "def", "cuda", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", "'function not supported'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.state_dict": [[41, 43], ["NotImplementedError"], "methods", ["None"], ["", "def", "state_dict", "(", "self", ",", "model_file", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", "'function not supported'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.update_policy": [[44, 46], ["NotImplementedError"], "methods", ["None"], ["", "def", "update_policy", "(", "self", ",", "samples", ",", "frame", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", "'function not supported'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.evaluate_action": [[47, 49], ["NotImplementedError"], "methods", ["None"], ["", "def", "evaluate_action", "(", "self", ",", "states", ",", "model_name", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", "'function not supported'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.update_best": [[50, 52], ["NotImplementedError"], "methods", ["None"], ["", "def", "update_best", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", "'function not supported'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.save_model": [[53, 55], ["NotImplementedError"], "methods", ["None"], ["", "def", "save_model", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", "'function not supported'", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelNaiveCommuMultiAgent.NewModelMultiAgent_MAL.__init__": [[11, 50], ["MAL.MAL.__init__", "torch.nn.ModuleList", "enumerate", "len", "len", "zip", "NewModelNaiveCommuMultiAgent.NewModelMultiAgent_MAL.random.randint", "AgentClass", "NewModelNaiveCommuMultiAgent.NewModelMultiAgent_MAL.agents.append", "AgentClass.init_communicate", "AgentClass.embedding_instance", "AgentClass.embedding_instance"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.init_communicate", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNoCommuAgent.NewModelNoCommuAgent.embedding_instance", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNoCommuAgent.NewModelNoCommuAgent.embedding_instance"], ["    ", "def", "__init__", "(", "self", ",", "AgentClass", ",", "observation", ",", "action", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "share_embedding", "=", "True", "\n", "init_params", "=", "{", "\n", "'AgentClass'", ":", "AgentClass", ",", "\n", "'observation'", ":", "observation", ",", "\n", "'action'", ":", "action", "\n", "}", "\n", "\n", "# if share embedding, clear obs and action to cancel normal init, ", "\n", "# otherwise, do normal init", "\n", "if", "self", ".", "share_embedding", ":", "\n", "            ", "init_params", "[", "'observation'", "]", "=", "[", "]", "\n", "init_params", "[", "'action'", "]", "=", "[", "]", "\n", "", "super", "(", ")", ".", "__init__", "(", "**", "init_params", ",", "**", "kwargs", ")", "\n", "\n", "if", "self", ".", "share_embedding", ":", "\n", "# share embedding, rewrite init", "\n", "            ", "self", ".", "observation_space", "=", "observation", "\n", "self", ".", "action_space", "=", "action", "\n", "assert", "len", "(", "observation", ")", "==", "len", "(", "action", ")", "\n", "self", ".", "agents", "=", "torch", ".", "nn", ".", "ModuleList", "(", ")", "\n", "self", ".", "embedding_instance", "=", "None", "\n", "for", "num", ",", "[", "obs", ",", "act", "]", "in", "enumerate", "(", "zip", "(", "observation", ",", "action", ")", ")", ":", "\n", "                ", "kwargs", "[", "'observation'", "]", "=", "obs", "\n", "kwargs", "[", "'action'", "]", "=", "act", "\n", "kwargs", "[", "'seed'", "]", "=", "self", ".", "random", ".", "randint", "(", "2", "**", "31", ")", "\n", "kwargs", "[", "'indices'", "]", "=", "[", "num", "]", "\n", "agent", "=", "AgentClass", "(", "**", "kwargs", ")", "\n", "self", ".", "agents", ".", "append", "(", "agent", ")", "\n", "if", "num", "==", "0", ":", "\n", "                    ", "self", ".", "embedding_instance", "=", "agent", ".", "embedding_instance", "(", ")", "\n", "", "else", ":", "\n", "                    ", "agent", ".", "embedding_instance", "(", "self", ".", "embedding_instance", ")", "\n", "", "", "for", "agent", "in", "self", ".", "agents", ":", "\n", "                ", "agent", ".", "init_communicate", "(", "\n", "agents", "=", "self", ".", "agents", ",", "\n", "all_observation", "=", "self", ".", "observation_space", ",", "\n", "all_action", "=", "self", ".", "action_space", ",", "\n", "**", "kwargs", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelNaiveCommuMultiAgent.NewModelMultiAgent_MALShare.__init__": [[54, 65], ["NewModelNaiveCommuMultiAgent.NewModelMultiAgent_MALShare.init_road_relation", "MALShare.MALShare.__init__", "len", "len"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.init_road_relation", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "AgentClass", ",", "observation", ",", "action", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "direction_names", "=", "[", "\n", "'turn_left'", ",", "\n", "'go_straight'", ",", "\n", "'turn_right'", "\n", "]", "\n", "self", ".", "init_road_relation", "(", "observation", ")", "\n", "f_obs", "=", "[", "observation", "[", "0", "]", "]", "*", "len", "(", "observation", ")", "\n", "f_act", "=", "[", "action", "[", "0", "]", "]", "*", "len", "(", "action", ")", "\n", "super", "(", ")", ".", "__init__", "(", "AgentClass", ",", "f_obs", ",", "f_act", ",", "\n", "road_relation", "=", "self", ".", "road_relation", ",", "**", "kwargs", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelNaiveCommuMultiAgent.NewModelMultiAgent_MALShare.init_road_relation": [[66, 97], ["enumerate", "enumerate", "NewModelNaiveCommuMultiAgent.NewModelMultiAgent_MALShare.road_relation.append", "NewModelNaiveCommuMultiAgent.NewModelMultiAgent_MALShare.direction_names.index", "zip", "zip", "range", "range", "cuda", "cuda", "cuda().float", "cuda", "torch.tensor", "torch.tensor", "torch.tensor", "cuda", "torch.tensor"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "def", "init_road_relation", "(", "self", ",", "observation", ")", ":", "\n", "        ", "self", ".", "road_relation", "=", "[", "]", "\n", "for", "obs", "in", "observation", ":", "\n", "            ", "assert", "self", ".", "direction_names", "==", "obs", "[", "'DirectionNames'", "]", "\n", "roadto", "=", "obs", "[", "'RoadsOut'", "]", "\n", "roadin", "=", "obs", "[", "'RoadsIn'", "]", "\n", "rloutbelong", "=", "obs", "[", "'RoadLinksOut'", "]", "\n", "rlinbelong", "=", "obs", "[", "'RoadLinksIn'", "]", "\n", "lanecount", "=", "obs", "[", "'LaneCount'", "]", "\n", "roadoutlanes", "=", "obs", "[", "'RoadOutLanes'", "]", "\n", "lanedirection", "=", "[", "self", ".", "direction_names", ".", "index", "(", "x", ")", "\n", "for", "x", "in", "obs", "[", "'RoadLinkDirection'", "]", "]", "\n", "ro2rl", "=", "[", "[", "-", "1", "]", "*", "3", "for", "_", "in", "range", "(", "4", ")", "]", "\n", "for", "num", ",", "[", "i", ",", "j", "]", "in", "enumerate", "(", "zip", "(", "rloutbelong", ",", "lanedirection", ")", ")", ":", "\n", "                ", "if", "i", "!=", "-", "1", ":", "\n", "                    ", "ro2rl", "[", "i", "]", "[", "j", "]", "=", "num", "\n", "", "", "ri2rl", "=", "[", "[", "-", "1", "]", "*", "3", "for", "_", "in", "range", "(", "4", ")", "]", "\n", "for", "num", ",", "[", "i", ",", "j", "]", "in", "enumerate", "(", "zip", "(", "rlinbelong", ",", "lanedirection", ")", ")", ":", "\n", "                ", "if", "i", "!=", "-", "1", ":", "\n", "                    ", "ri2rl", "[", "i", "]", "[", "j", "]", "=", "num", "\n", "# print(roadto, rloutbelong, road2rl)", "\n", "", "", "self", ".", "road_relation", ".", "append", "(", "{", "\n", "'RoadsOut'", ":", "roadto", ",", "\n", "'RoadsIn'", ":", "roadin", ",", "\n", "'RoadLinksOut'", ":", "rloutbelong", ",", "\n", "'RoadLinksIn'", ":", "rlinbelong", ",", "\n", "'RoadOut2RoadLink'", ":", "ro2rl", ",", "\n", "'RoadIn2RoadLink'", ":", "cuda", "(", "torch", ".", "tensor", "(", "ri2rl", ")", ")", ",", "\n", "'LaneCount'", ":", "cuda", "(", "torch", ".", "tensor", "(", "lanecount", ")", ")", ",", "\n", "'RoadOutLanes'", ":", "cuda", "(", "torch", ".", "tensor", "(", "roadoutlanes", ")", ")", ".", "float", "(", ")", ",", "\n", "'RoadLinkDirection'", ":", "cuda", "(", "torch", ".", "tensor", "(", "lanedirection", ")", ")", ",", "\n", "}", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelNoCommuMultiAgent.NewModelNoCommuMultiAgent.__init__": [[10, 49], ["MAL.MAL.__init__", "torch.nn.ModuleList", "enumerate", "len", "len", "zip", "NewModelNoCommuMultiAgent.NewModelNoCommuMultiAgent.random.randint", "AgentClass", "NewModelNoCommuMultiAgent.NewModelNoCommuMultiAgent.agents.append", "AgentClass.init_communicate", "AgentClass.embedding_instance", "AgentClass.embedding_instance"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.init_communicate", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNoCommuAgent.NewModelNoCommuAgent.embedding_instance", "home.repos.pwc.inspect_result.zyr17_unilight.agents.NewModelNoCommuAgent.NewModelNoCommuAgent.embedding_instance"], ["    ", "def", "__init__", "(", "self", ",", "AgentClass", ",", "observation", ",", "action", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "share_embedding", "=", "True", "\n", "init_params", "=", "{", "\n", "'AgentClass'", ":", "AgentClass", ",", "\n", "'observation'", ":", "observation", ",", "\n", "'action'", ":", "action", "\n", "}", "\n", "\n", "# if share embedding, clear obs and action to cancel normal init, ", "\n", "# otherwise, do normal init", "\n", "if", "self", ".", "share_embedding", ":", "\n", "            ", "init_params", "[", "'observation'", "]", "=", "[", "]", "\n", "init_params", "[", "'action'", "]", "=", "[", "]", "\n", "", "super", "(", ")", ".", "__init__", "(", "**", "init_params", ",", "**", "kwargs", ")", "\n", "\n", "if", "self", ".", "share_embedding", ":", "\n", "# share embedding, rewrite init", "\n", "            ", "self", ".", "observation_space", "=", "observation", "\n", "self", ".", "action_space", "=", "action", "\n", "assert", "len", "(", "observation", ")", "==", "len", "(", "action", ")", "\n", "self", ".", "agents", "=", "torch", ".", "nn", ".", "ModuleList", "(", ")", "\n", "self", ".", "embedding_instance", "=", "None", "\n", "for", "num", ",", "[", "obs", ",", "act", "]", "in", "enumerate", "(", "zip", "(", "observation", ",", "action", ")", ")", ":", "\n", "                ", "kwargs", "[", "'observation'", "]", "=", "obs", "\n", "kwargs", "[", "'action'", "]", "=", "act", "\n", "kwargs", "[", "'seed'", "]", "=", "self", ".", "random", ".", "randint", "(", "2", "**", "31", ")", "\n", "kwargs", "[", "'indices'", "]", "=", "[", "num", "]", "\n", "agent", "=", "AgentClass", "(", "**", "kwargs", ")", "\n", "self", ".", "agents", ".", "append", "(", "agent", ")", "\n", "if", "num", "==", "0", ":", "\n", "                    ", "self", ".", "embedding_instance", "=", "agent", ".", "embedding_instance", "(", ")", "\n", "", "else", ":", "\n", "                    ", "agent", ".", "embedding_instance", "(", "self", ".", "embedding_instance", ")", "\n", "", "", "for", "agent", "in", "self", ".", "agents", ":", "\n", "                ", "agent", ".", "init_communicate", "(", "\n", "agents", "=", "self", ".", "agents", ",", "\n", "all_observation", "=", "self", ".", "observation_space", ",", "\n", "all_action", "=", "self", ".", "action_space", ",", "\n", "**", "kwargs", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.__init__": [[11, 29], ["MultiAgentBase.MultiAgentBase.__init__", "torch.nn.ModuleList", "enumerate", "len", "len", "zip", "MAL.MAL.random.randint", "MAL.MAL.agents.append", "agent.init_communicate", "AgentClass"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.agents.AgentBase.AgentBase.init_communicate"], ["def", "__init__", "(", "self", ",", "AgentClass", ",", "observation", ",", "action", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", "**", "kwargs", ")", "\n", "self", ".", "observation_space", "=", "observation", "\n", "self", ".", "action_space", "=", "action", "\n", "assert", "len", "(", "observation", ")", "==", "len", "(", "action", ")", "\n", "self", ".", "agents", "=", "torch", ".", "nn", ".", "ModuleList", "(", ")", "\n", "for", "num", ",", "[", "obs", ",", "act", "]", "in", "enumerate", "(", "zip", "(", "observation", ",", "action", ")", ")", ":", "\n", "            ", "kwargs", "[", "'observation'", "]", "=", "obs", "\n", "kwargs", "[", "'action'", "]", "=", "act", "\n", "kwargs", "[", "'seed'", "]", "=", "self", ".", "random", ".", "randint", "(", "2", "**", "31", ")", "\n", "kwargs", "[", "'indices'", "]", "=", "[", "num", "]", "\n", "self", ".", "agents", ".", "append", "(", "AgentClass", "(", "**", "kwargs", ")", ")", "\n", "", "for", "agent", "in", "self", ".", "agents", ":", "\n", "            ", "agent", ".", "init_communicate", "(", "\n", "agents", "=", "self", ".", "agents", ",", "\n", "all_observation", "=", "self", ".", "observation_space", ",", "\n", "all_action", "=", "self", ".", "action_space", ",", "\n", "**", "kwargs", "\n", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.cuda": [[31, 35], ["MAL.MAL.cuda"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "", "def", "cuda", "(", "self", ")", ":", "\n", "        ", "for", "agent", "in", "self", ".", "agents", ":", "\n", "            ", "cuda", "(", "agent", ")", "\n", "", "return", "self", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.forward": [[36, 48], ["zip", "agent.forward_model_select", "agent.forward", "f"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.forward_model_select", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward"], ["", "def", "forward", "(", "self", ",", "state", ",", "**", "kwargs", ")", ":", "\n", "        ", "for", "agent", "in", "self", ".", "agents", ":", "\n", "            ", "agent", ".", "forward_model_select", "(", "**", "kwargs", ")", "\n", "", "data", "=", "state", "\n", "funcs", "=", "[", "agent", ".", "forward", "(", ")", "for", "agent", "in", "self", ".", "agents", "]", "\n", "funcs", "=", "zip", "(", "*", "funcs", ")", "\n", "for", "func_step", "in", "funcs", ":", "\n", "            ", "next_data", "=", "[", "]", "\n", "for", "f", "in", "func_step", ":", "\n", "                ", "next_data", "+=", "f", "(", "data", ")", "\n", "", "data", "=", "next_data", "\n", "", "return", "data", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.get_action_in_update_policy": [[49, 68], ["list", "list", "list", "range", "MAL.MAL.forward", "MAL.MAL.forward", "list", "zip", "list", "len", "flatten_data", "flatten_data", "zip", "zip", "len"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.flatten_data", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.flatten_data"], ["", "def", "get_action_in_update_policy", "(", "self", ",", "samples_raw", ")", ":", "\n", "# samples_raw: [BATCH, SAMPLETYPE=5, AGENT, ...data]", "\n", "        ", "samples", "=", "[", "x", "[", ":", "-", "1", "]", "+", "[", "[", "x", "[", "-", "1", "]", "]", "*", "len", "(", "self", ".", "agents", ")", "]", "for", "x", "in", "samples_raw", "]", "\n", "samples", "=", "list", "(", "zip", "(", "*", "samples", ")", ")", "# [S_TYPE, BATCH, AGENT, samples...data]", "\n", "state", ",", "action", ",", "reward", ",", "next_s", ",", "ist", "=", "[", "list", "(", "zip", "(", "*", "x", ")", ")", "for", "x", "in", "samples", "]", "\n", "# every data: [AGENT, BATCH, ...data]", "\n", "state", "=", "list", "(", "state", ")", "\n", "next_s", "=", "list", "(", "next_s", ")", "\n", "for", "num", "in", "range", "(", "len", "(", "self", ".", "agents", ")", ")", ":", "\n", "# flatten inside every agent", "\n", "            ", "state", "[", "num", "]", "=", "flatten_data", "(", "'dict'", ",", "state", "[", "num", "]", ")", "\n", "next_s", "[", "num", "]", "=", "flatten_data", "(", "'dict'", ",", "next_s", "[", "num", "]", ")", "\n", "", "state", "=", "self", ".", "forward", "(", "state", ",", "update_policy", "=", "'state'", ")", "\n", "next_s", "=", "self", ".", "forward", "(", "next_s", ",", "update_policy", "=", "'next_s'", ")", "\n", "# state: [AGENT, array(BATCH, ACTION)]", "\n", "\n", "samples", "=", "list", "(", "zip", "(", "state", ",", "action", ",", "reward", ",", "next_s", ",", "ist", ")", ")", "\n", "# samples: [AGENT, S_TYPE, BATCH, ...data]", "\n", "return", "samples", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL._loss_backward": [[69, 72], ["losses.sum", "losses.sum.backward"], "methods", ["None"], ["", "def", "_loss_backward", "(", "self", ",", "losses", ")", ":", "\n", "        ", "final_loss", "=", "losses", ".", "sum", "(", ")", "\n", "final_loss", ".", "backward", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.update_policy": [[73, 83], ["MAL.MAL.get_action_in_update_policy", "enumerate", "torch.stack", "MAL.MAL._loss_backward", "zip", "torch.stack.append", "agent.optimizer_step", "agent.calculate_loss"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.get_action_in_update_policy", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase._loss_backward", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.optimizer_step", "home.repos.pwc.inspect_result.zyr17_unilight.agents.DQNAgent.DQNAgent.calculate_loss"], ["", "def", "update_policy", "(", "self", ",", "samples_raw", ",", "frame", ")", ":", "\n", "        ", "samples", "=", "self", ".", "get_action_in_update_policy", "(", "samples_raw", ")", "\n", "losses", "=", "[", "]", "\n", "for", "num", ",", "[", "agent", ",", "sample", "]", "in", "enumerate", "(", "zip", "(", "self", ".", "agents", ",", "samples", ")", ")", ":", "\n", "            ", "losses", ".", "append", "(", "agent", ".", "calculate_loss", "(", "sample", ",", "frame", ",", "\n", "'loss_%04d'", "%", "num", ")", ")", "\n", "", "losses", "=", "torch", ".", "stack", "(", "losses", ")", "\n", "self", ".", "_loss_backward", "(", "losses", ")", "\n", "for", "agent", "in", "self", ".", "agents", ":", "\n", "            ", "agent", ".", "optimizer_step", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.unpack_states_in_action": [[84, 90], ["list", "zip", "flatten_data"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.flatten_data"], ["", "", "def", "unpack_states_in_action", "(", "self", ",", "states_raw", ")", ":", "\n", "# pdb.set_trace()", "\n", "        ", "states", "=", "states_raw", "\n", "states", "=", "list", "(", "zip", "(", "*", "states", ")", ")", "\n", "# output: [Agents, { every value: [Batch, (...data shape)] }]", "\n", "return", "[", "flatten_data", "(", "'dict'", ",", "x", ")", "for", "x", "in", "states", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.action": [[91, 104], ["MAL.MAL.unpack_states_in_action", "zip", "list", "torch.no_grad", "MAL.MAL.forward", "list.append", "zip", "agent.get_action"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.unpack_states_in_action", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.get_action"], ["", "def", "action", "(", "self", ",", "states", ",", "eps", "=", "0", ",", "model_name", "=", "'update'", ",", "**", "kwargs", ")", ":", "\n", "# states: [Batch, Intersection, {data dict}]", "\n", "# return: [Batch, InterAgent, ActionsInOneInter]", "\n", "        ", "res", "=", "[", "]", "\n", "states", "=", "self", ".", "unpack_states_in_action", "(", "states", ")", "\n", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "            ", "state_action", "=", "self", ".", "forward", "(", "states", ",", "model_name", "=", "model_name", ",", "\n", "**", "kwargs", ")", "\n", "", "for", "agent", ",", "s_a", "in", "zip", "(", "self", ".", "agents", ",", "state_action", ")", ":", "\n", "            ", "res", ".", "append", "(", "agent", ".", "get_action", "(", "s_a", ",", "eps", ")", ")", "\n", "# now res shape: [Agents, Batch, ActionNumForOneInter=1]", "\n", "", "res", "=", "list", "(", "zip", "(", "*", "res", ")", ")", "\n", "return", "res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.update_best": [[105, 108], ["agent.update_best"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.update_best"], ["", "def", "update_best", "(", "self", ")", ":", "\n", "        ", "for", "agent", "in", "self", ".", "agents", ":", "\n", "            ", "agent", ".", "update_best", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.log_model_structure": [[109, 113], ["log", "MAL.MAL.agents[].log_model_structure"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.log_model_structure"], ["", "", "def", "log_model_structure", "(", "self", ")", ":", "\n", "        ", "log", "(", "'IQL, every model use same model structure and have different '", "\n", "'weight.'", ",", "level", "=", "'ALL'", ")", "\n", "self", ".", "agents", "[", "0", "]", ".", "log_model_structure", "(", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.__init__": [[7, 10], ["super().__init__"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "output_number", ",", "*", "argv", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "output_number", "=", "output_number", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward": [[11, 14], ["torch.zeros().float().to", "torch.zeros().float", "torch.zeros", "len"], "methods", ["None"], ["", "def", "forward", "(", "self", ",", "ids", ",", "*", "argv", ",", "**", "kwargs", ")", ":", "\n", "        ", "return", "torch", ".", "zeros", "(", "(", "len", "(", "ids", ")", ",", "\n", "self", ".", "output_number", ")", ")", ".", "float", "(", ")", ".", "to", "(", "ids", ".", "device", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.__init__": [[17, 51], ["NewModelMultiAgent.NewModelMultiAgent.init_road_relation", "MALShare.MALShare.__init__", "torch.nn.ModuleList", "len", "len", "torch.zeros", "enumerate", "cuda", "NewModelMultiAgent.NewModelMultiAgent.out_road_embeddings.append", "cuda.float", "NewModelMultiAgent.AllZero", "len", "len"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.init_road_relation", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["    ", "def", "__init__", "(", "self", ",", "AgentClass", ",", "observation", ",", "action", ",", "\n", "virtual_intersection_out_lines", ",", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "direction_names", "=", "[", "\n", "'turn_left'", ",", "\n", "'go_straight'", ",", "\n", "'turn_right'", "\n", "]", "\n", "self", ".", "N_STEPS", "=", "kwargs", "[", "'n_steps'", "]", "\n", "self", ".", "init_road_relation", "(", "observation", ")", "\n", "f_obs", "=", "[", "observation", "[", "0", "]", "]", "*", "len", "(", "observation", ")", "\n", "f_act", "=", "[", "action", "[", "0", "]", "]", "*", "len", "(", "action", ")", "\n", "for", "obs", "in", "observation", ":", "\n", "            ", "phase", "=", "obs", "[", "'TSphase'", "]", "\n", "phaseid2lanes", "=", "torch", ".", "zeros", "(", "(", "len", "(", "phase", ")", ",", "obs", "[", "'TSflow'", "]", "[", "0", "]", ")", ")", "\n", "for", "num", ",", "p", "in", "enumerate", "(", "phase", ")", ":", "\n", "                ", "for", "i", "in", "p", ":", "\n", "                    ", "phaseid2lanes", "[", "num", "]", "[", "i", "]", "=", "1", "\n", "", "", "phaseid2lanes", "=", "cuda", "(", "phaseid2lanes", ".", "float", "(", ")", ")", "\n", "obs", "[", "'phaseid2lanes'", "]", "=", "phaseid2lanes", "\n", "\n", "", "self", ".", "out_road_embeddings", "=", "[", "]", "\n", "v_out_lines", "=", "virtual_intersection_out_lines", "\n", "for", "_", "in", "v_out_lines", ":", "\n", "            ", "self", ".", "out_road_embeddings", ".", "append", "(", "AllZero", "(", "\n", "output_number", "=", "len", "(", "self", ".", "direction_names", ")", "\n", ")", ")", "\n", "", "super", "(", ")", ".", "__init__", "(", "AgentClass", ",", "\n", "f_obs", ",", "\n", "f_act", ",", "\n", "road_relation", "=", "self", ".", "road_relation", ",", "\n", "out_road_embeddings", "=", "self", ".", "out_road_embeddings", ",", "\n", "**", "kwargs", ")", "\n", "self", ".", "out_road_embeddings", "=", "torch", ".", "nn", ".", "ModuleList", "(", "self", ".", "out_road_embeddings", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules": [[52, 60], ["super().named_modules", "NewModelMultiAgent.NewModelMultiAgent.out_road_embeddings.named_modules"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.named_modules"], ["", "def", "named_modules", "(", "self", ",", "memo", "=", "None", ",", "prefix", "=", "''", ")", ":", "\n", "        ", "names", "=", "super", "(", ")", ".", "named_modules", "(", "memo", "=", "memo", ",", "prefix", "=", "prefix", ")", "\n", "for", "i", "in", "names", ":", "\n", "            ", "yield", "i", "\n", "", "emb", "=", "self", ".", "out_road_embeddings", ".", "named_modules", "(", "\n", "memo", "=", "memo", ",", "prefix", "=", "prefix", "+", "'.out_road_embeddings'", ")", "\n", "for", "i", "in", "emb", ":", "\n", "            ", "yield", "emb", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.init_road_relation": [[61, 92], ["enumerate", "enumerate", "NewModelMultiAgent.NewModelMultiAgent.road_relation.append", "NewModelMultiAgent.NewModelMultiAgent.direction_names.index", "zip", "zip", "range", "range", "cuda", "cuda", "cuda().float", "cuda", "torch.tensor", "torch.tensor", "torch.tensor", "cuda", "torch.tensor"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda"], ["", "", "def", "init_road_relation", "(", "self", ",", "observation", ")", ":", "\n", "        ", "self", ".", "road_relation", "=", "[", "]", "\n", "for", "obs", "in", "observation", ":", "\n", "            ", "assert", "self", ".", "direction_names", "==", "obs", "[", "'DirectionNames'", "]", "\n", "roadto", "=", "obs", "[", "'RoadsOut'", "]", "\n", "roadin", "=", "obs", "[", "'RoadsIn'", "]", "\n", "rloutbelong", "=", "obs", "[", "'RoadLinksOut'", "]", "\n", "rlinbelong", "=", "obs", "[", "'RoadLinksIn'", "]", "\n", "lanecount", "=", "obs", "[", "'LaneCount'", "]", "\n", "roadoutlanes", "=", "obs", "[", "'RoadOutLanes'", "]", "\n", "lanedirection", "=", "[", "self", ".", "direction_names", ".", "index", "(", "x", ")", "\n", "for", "x", "in", "obs", "[", "'RoadLinkDirection'", "]", "]", "\n", "ro2rl", "=", "[", "[", "-", "1", "]", "*", "3", "for", "_", "in", "range", "(", "4", ")", "]", "\n", "for", "num", ",", "[", "i", ",", "j", "]", "in", "enumerate", "(", "zip", "(", "rloutbelong", ",", "lanedirection", ")", ")", ":", "\n", "                ", "if", "i", "!=", "-", "1", ":", "\n", "                    ", "ro2rl", "[", "i", "]", "[", "j", "]", "=", "num", "\n", "", "", "ri2rl", "=", "[", "[", "-", "1", "]", "*", "3", "for", "_", "in", "range", "(", "4", ")", "]", "\n", "for", "num", ",", "[", "i", ",", "j", "]", "in", "enumerate", "(", "zip", "(", "rlinbelong", ",", "lanedirection", ")", ")", ":", "\n", "                ", "if", "i", "!=", "-", "1", ":", "\n", "                    ", "ri2rl", "[", "i", "]", "[", "j", "]", "=", "num", "\n", "# print(roadto, rloutbelong, road2rl)", "\n", "", "", "self", ".", "road_relation", ".", "append", "(", "{", "\n", "'RoadsOut'", ":", "roadto", ",", "\n", "'RoadsIn'", ":", "roadin", ",", "\n", "'RoadLinksOut'", ":", "rloutbelong", ",", "\n", "'RoadLinksIn'", ":", "rlinbelong", ",", "\n", "'RoadOut2RoadLink'", ":", "ro2rl", ",", "\n", "'RoadIn2RoadLink'", ":", "cuda", "(", "torch", ".", "tensor", "(", "ri2rl", ")", ")", ",", "\n", "'LaneCount'", ":", "cuda", "(", "torch", ".", "tensor", "(", "lanecount", ")", ")", ",", "\n", "'RoadOutLanes'", ":", "cuda", "(", "torch", ".", "tensor", "(", "roadoutlanes", ")", ")", ".", "float", "(", ")", ",", "\n", "'RoadLinkDirection'", ":", "cuda", "(", "torch", ".", "tensor", "(", "lanedirection", ")", ")", ",", "\n", "}", ")", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.NewModelMultiAgent.get_action_in_update_policy": [[99, 123], ["list", "list", "list", "range", "NewModelMultiAgent.NewModelMultiAgent.forward", "NewModelMultiAgent.NewModelMultiAgent.forward", "list", "zip", "list", "len", "flatten_data", "flatten_data", "zip", "zip", "len"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.NewModelMultiAgent.AllZero.forward", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.flatten_data", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.flatten_data"], ["def", "get_action_in_update_policy", "(", "self", ",", "samples_raw", ")", ":", "\n", "# samples_raw: [BATCH, SAMPLETYPE=5, AGENT, ...data]", "\n", "        ", "samples", "=", "[", "x", "[", ":", "-", "1", "]", "+", "[", "[", "x", "[", "-", "1", "]", "]", "*", "len", "(", "self", ".", "agents", ")", "]", "for", "x", "in", "samples_raw", "]", "\n", "samples", "=", "list", "(", "zip", "(", "*", "samples", ")", ")", "# [S_TYPE, BATCH, AGENT, samples...data]", "\n", "state", ",", "action", ",", "reward", ",", "next_s", ",", "ist", "=", "[", "list", "(", "zip", "(", "*", "x", ")", ")", "for", "x", "in", "samples", "]", "\n", "# every data: [AGENT, BATCH, ...data]", "\n", "state", "=", "list", "(", "state", ")", "\n", "next_s", "=", "list", "(", "next_s", ")", "\n", "for", "num", "in", "range", "(", "len", "(", "self", ".", "agents", ")", ")", ":", "\n", "# flatten inside every agent", "\n", "            ", "state", "[", "num", "]", "=", "flatten_data", "(", "'dict'", ",", "state", "[", "num", "]", ")", "\n", "next_s", "[", "num", "]", "=", "flatten_data", "(", "'dict'", ",", "next_s", "[", "num", "]", ")", "\n", "state", "[", "num", "]", "[", "'NextInLaneVehicleNumber'", "]", "=", "next_s", "[", "num", "]", "[", "'InLaneVehicleNumber'", "]", "[", ":", ",", "-", "self", ".", "N_STEPS", "]", "\n", "state", "[", "num", "]", "[", "'NextPhase'", "]", "=", "next_s", "[", "num", "]", "[", "'TSprevphases'", "]", "[", ":", ",", "-", "self", ".", "N_STEPS", "]", "\n", "# pdb.set_trace()", "\n", "", "state", "=", "self", ".", "forward", "(", "state", ",", "update_policy", "=", "'state'", ")", "\n", "next_s", "=", "self", ".", "forward", "(", "next_s", ",", "update_policy", "=", "'next_s'", ")", "\n", "# state: [AGENT, array(BATCH, ACTION)]", "\n", "\n", "samples", "=", "list", "(", "zip", "(", "state", ",", "action", ",", "reward", ",", "next_s", ",", "ist", ")", ")", "\n", "# samples: [AGENT, S_TYPE, BATCH, ...data]", "\n", "return", "samples", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.__init__": [[15, 18], ["super().__init__", "numpy.random.RandomState"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__"], ["    ", "def", "__init__", "(", "self", ",", "seed", ",", "**", "kwargs", ")", ":", "\n", "        ", "super", "(", ")", ".", "__init__", "(", ")", "\n", "self", ".", "random", "=", "np", ".", "random", ".", "RandomState", "(", "seed", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda": [[19, 21], ["NotImplementedError"], "methods", ["None"], ["", "def", "cuda", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase._loss_backward": [[26, 28], ["NotImplementedError"], "methods", ["None"], ["def", "_loss_backward", "(", "self", ",", "losses", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.update_policy": [[33, 35], ["NotImplementedError"], "methods", ["None"], ["def", "update_policy", "(", "self", ",", "samples", ",", "frame", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.get_action": [[36, 38], ["NotImplementedError"], "methods", ["None"], ["", "def", "get_action", "(", "self", ",", "states", ",", "eps", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.evaluate_action": [[39, 41], ["NotImplementedError"], "methods", ["None"], ["", "def", "evaluate_action", "(", "self", ",", "states", ",", "model_name", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.update_best": [[42, 44], ["NotImplementedError"], "methods", ["None"], ["", "def", "update_best", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.save_model": [[45, 47], ["NotImplementedError"], "methods", ["None"], ["", "def", "save_model", "(", "self", ")", ":", "\n", "        ", "raise", "NotImplementedError", "(", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DeterminedMain.DeterminedMain.__init__": [[7, 64], ["set_seed", "env.lower.lower.lower", "MultiAgent", "DeterminedMain.DeterminedMain._init_TXSW", "log", "getCityFlowEnvVec", "NotImplementedError", "globals", "NotImplementedError", "multi_agent.lower", "ValueError", "globals"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.set_seed", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.MainFuncBase.MainFuncBase._init_TXSW", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.getCityFlowEnvVec"], ["    ", "def", "__init__", "(", "self", ",", "env", ",", "agent", ",", "multi_agent", ",", "evaluate_round", ",", "render_steps", ",", "\n", "threads", ",", "seed", ",", "test_round", ",", "\n", "# Specific args", "\n", "log_folder", ",", "simulate_time", ",", "cityflow_log", ",", "\n", "**", "kwargs", ")", ":", "\n", "\n", "        ", "work_folder", "=", "kwargs", "[", "'work_folder'", "]", "\n", "cityflow_config", "=", "kwargs", "[", "'cityflow_config'", "]", "\n", "self", ".", "dc", "=", "[", "0", "]", "*", "3", "\n", "self", ".", "SEED", "=", "seed", "\n", "set_seed", "(", "seed", ")", "\n", "\n", "env", "=", "env", ".", "lower", "(", ")", "\n", "if", "env", "==", "'cityflow'", ":", "\n", "            ", "self", ".", "env", "=", "getCityFlowEnvVec", "(", "threads", ",", "log_folder", ",", "work_folder", ",", "\n", "cityflow_config", ",", "seed", "+", "1", ",", "\n", "cityflow_log", ")", "\n", "", "else", ":", "\n", "            ", "raise", "NotImplementedError", "(", "'envs except cityflow is '", "\n", "'not implemented'", ")", "\n", "", "if", "agent", "in", "globals", "(", ")", ":", "\n", "            ", "Agent", "=", "globals", "(", ")", "[", "agent", "]", "\n", "", "else", ":", "\n", "            ", "raise", "NotImplementedError", "(", "'unknown agent '", "+", "agent", ")", "\n", "\n", "", "if", "multi_agent", ".", "lower", "(", ")", "!=", "'independentdetermined'", ":", "\n", "            ", "raise", "ValueError", "(", "'DeterminedMain only supports '", "\n", "'IndependentDetermined as multi-agent'", ")", "\n", "\n", "", "MultiAgent", "=", "IndependentDetermined", "\n", "\n", "self", ".", "agent", "=", "MultiAgent", "(", "AgentClass", "=", "Agent", ",", "\n", "observation", "=", "self", ".", "env", ".", "observation_space", "[", "\n", "'intersections'", "]", ",", "\n", "action", "=", "self", ".", "env", ".", "action_space", ",", "\n", "env", "=", "self", ".", "env", ",", "\n", "seed", "=", "self", ".", "SEED", ",", "\n", "**", "kwargs", ")", "\n", "\n", "self", ".", "RENDER", "=", "render_steps", "\n", "self", ".", "_init_TXSW", "(", "**", "kwargs", ")", "\n", "\n", "assert", "threads", "==", "1", ",", "'only support one thread in determined!'", "\n", "\n", "self", ".", "THREADS", "=", "threads", "\n", "\n", "self", ".", "SIMULATE_TIME", "=", "simulate_time", "\n", "self", ".", "TOTAL_EPOCH", "=", "evaluate_round", "\n", "if", "test_round", ">", "0", ":", "\n", "            ", "self", ".", "TOTAL_EPOCH", "=", "test_round", "\n", "\n", "", "self", ".", "PREVIOUS_REWARD", "=", "[", "]", "\n", "self", ".", "PREVIOUS_DC", "=", "[", "]", "\n", "self", ".", "PREVIOUS_RESULT", "=", "[", "]", "\n", "self", ".", "epoch", "=", "0", "\n", "\n", "log", "(", "'DeterminedMain init over'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DeterminedMain.DeterminedMain.sampling": [[65, 91], ["time.time", "DeterminedMain.DeterminedMain.env.reset", "DeterminedMain.DeterminedMain.agent.get_action", "np.zeros", "range", "log", "np.stack().mean", "DeterminedMain.DeterminedMain.PREVIOUS_REWARD.append", "DeterminedMain.DeterminedMain.PREVIOUS_RESULT.append", "log", "DeterminedMain.DeterminedMain.TXSW.add_scalar", "DeterminedMain.DeterminedMain.TXSW.add_scalar", "DeterminedMain.DeterminedMain.env.step", "reward.sum", "DeterminedMain.DeterminedMain.agent.get_action", "np.zeros.mean", "ist.all", "ist.any", "np.stack", "np.zeros.mean"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.reset", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.get_action", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_scalar", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_scalar", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.get_action"], ["", "def", "sampling", "(", "self", ",", "epoch", ")", ":", "\n", "        ", "start_time", "=", "time", ".", "time", "(", ")", "\n", "state", ",", "info", "=", "self", ".", "env", ".", "reset", "(", ")", "\n", "action", "=", "self", ".", "agent", ".", "get_action", "(", "state", ")", "\n", "tot_reward", "=", "np", ".", "zeros", "(", "self", ".", "THREADS", ",", "dtype", "=", "float", ")", "\n", "for", "ite", "in", "range", "(", "self", ".", "SIMULATE_TIME", ")", ":", "\n", "            ", "self", ".", "FRAME", "+=", "1", "\n", "next_s", ",", "reward", ",", "ist", ",", "infos", "=", "self", ".", "env", ".", "step", "(", "action", ")", "\n", "tot_reward", "+=", "reward", ".", "sum", "(", "axis", "=", "1", ")", "\n", "next_action", "=", "self", ".", "agent", ".", "get_action", "(", "next_s", ")", "\n", "\n", "assert", "(", "ist", ".", "all", "(", ")", "==", "ist", ".", "any", "(", ")", ")", "\n", "\n", "action", "=", "next_action", "\n", "state", "=", "next_s", "\n", "\n", "", "log", "(", "infos", ",", "level", "=", "'TRACE'", ")", "\n", "result", "=", "np", ".", "stack", "(", "[", "x", "[", "'average_time'", "]", "for", "x", "in", "infos", "]", ")", ".", "mean", "(", ")", "\n", "# dc_res = infos['dcroad_delay'].mean()", "\n", "self", ".", "PREVIOUS_REWARD", ".", "append", "(", "tot_reward", ")", "\n", "self", ".", "PREVIOUS_RESULT", ".", "append", "(", "result", ")", "\n", "# self.PREVIOUS_DC.append(dc_res)", "\n", "log", "(", "'epoch %4d: reward=%.6f, result=%.6f'", "\n", "%", "(", "epoch", ",", "tot_reward", ".", "mean", "(", ")", ",", "result", ")", ")", "\n", "self", ".", "TXSW", ".", "add_scalar", "(", "'reward'", ",", "tot_reward", ".", "mean", "(", ")", ",", "self", ".", "FRAME", ")", "\n", "self", ".", "TXSW", ".", "add_scalar", "(", "'time'", ",", "result", ",", "self", ".", "FRAME", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DeterminedMain.DeterminedMain.main": [[92, 105], ["np.array", "np.array", "log", "log", "DeterminedMain.DeterminedMain.sampling", "np.array.mean", "np.array.std", "np.array.mean", "np.array.std"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.sampling"], ["", "def", "main", "(", "self", ")", ":", "\n", "        ", "self", ".", "FRAME", "=", "0", "\n", "while", "self", ".", "epoch", "<", "self", ".", "TOTAL_EPOCH", ":", "\n", "            ", "self", ".", "sampling", "(", "self", ".", "epoch", ")", "\n", "self", ".", "epoch", "+=", "1", "\n", "", "final_result", "=", "np", ".", "array", "(", "self", ".", "PREVIOUS_RESULT", ")", "\n", "reward", "=", "np", ".", "array", "(", "self", ".", "PREVIOUS_REWARD", ")", "\n", "# dc_result = self.PREVIOUS_DC", "\n", "# dc_mean = sum(dc_result) / len(dc_result)", "\n", "# log('dc_mean and var:', dc_mean, max(dc_mean - min(dc_result), ", "\n", "#                                      max(dc_result) - dc_mean))", "\n", "log", "(", "'reward:'", ",", "reward", ".", "mean", "(", ")", ",", "reward", ".", "std", "(", ")", ")", "\n", "log", "(", "'result:'", ",", "final_result", ".", "mean", "(", ")", ",", "final_result", ".", "std", "(", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DeterminedMain.DeterminedMain.__del__": [[106, 108], ["DeterminedMain.DeterminedMain.TXSW.close"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close"], ["", "def", "__del__", "(", "self", ")", ":", "\n", "        ", "self", ".", "TXSW", ".", "close", "(", ")", "\n", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.MainFuncBase.MainFuncBase._init_TXSW": [[17, 27], ["WanDB_TXSW", "Fake_TXSW", "TXSW"], "methods", ["None"], ["    ", "def", "_init_TXSW", "(", "self", ",", "enable_wandb", ",", "tensorboardx_comment", ",", "**", "kwargs", ")", ":", "\n", "        ", "if", "enable_wandb", ":", "\n", "            ", "if", "tensorboardx_comment", "==", "''", ":", "\n", "                ", "tensorboardx_comment", "=", "None", "\n", "", "self", ".", "TXSW", "=", "WanDB_TXSW", "(", "tensorboardx_comment", "=", "tensorboardx_comment", ",", "\n", "**", "kwargs", ")", "\n", "", "elif", "tensorboardx_comment", "==", "''", ":", "\n", "            ", "self", ".", "TXSW", "=", "Fake_TXSW", "(", ")", "\n", "", "else", ":", "\n", "            ", "self", ".", "TXSW", "=", "TXSW", "(", "comment", "=", "'_'", "+", "tensorboardx_comment", ")", "\n", "", "", "", ""]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__init__": [[10, 165], ["np.random.RandomState", "set_seed", "cuda", "env.lower.lower.lower", "log", "DQNMain.DQNMain._init_TXSW", "cuda", "DQNMain.DQNMain.agent.log_model_structure", "cuda", "log", "DQNMain.DQNMain.get_env", "env_args.copy.copy.copy", "DQNMain.DQNMain.get_env", "NotImplementedError", "globals", "NotImplementedError", "agent.lower", "globals", "NotImplementedError", "globals", "NotImplementedError", "MultiAgent", "torch.load", "DQNMain.DQNMain.agent.load_state_dict", "DQNMain.DQNMain.env.replay_count", "rl.storage.ReplayBuffer", "log", "log", "os.path.join", "log", "os.makedirs", "globals", "NotImplementedError", "dir", "inner_model.default_wrapper", "globals", "globals", "DQNMain.DQNMain.randint", "rl.storage.CityFlowBuffer", "globals", "globals", "globals", "DQNMain.DQNMain.randint"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.set_seed", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.MainFuncBase.MainFuncBase._init_TXSW", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.log_model_structure", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.cuda", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.get_env", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.get_env", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.replay_count", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.innerModels.NewModelNaiveCommu.NewModelNaiveCommu.default_wrapper", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint"], ["    ", "def", "__init__", "(", "self", ",", "env", ",", "agent", ",", "multi_agent", ",", "model", ",", "dueling_dqn", ",", "\n", "dqn_initial_eps", ",", "dqn_final_eps", ",", "dqn_explore_len_frac", ",", "\n", "n_frames", ",", "dqn_replay_size", ",", "dqn_batch_size", ",", "render_steps", ",", "\n", "model_save_path", ",", "n_steps", ",", "\n", "threads", ",", "seed", ",", "no_cuda", ",", "evaluate_round", ",", "evaluate_interval", ",", "\n", "development", ",", "save_interval", ",", "\n", "# Specific args", "\n", "log_folder", ",", "work_folder", ",", "simulate_time", ",", "cityflow_config", ",", "\n", "cityflow_log", ",", "preload_model_file", ",", "test_round", ",", "\n", "dqn_split_model", ",", "clean_logs", ",", "\n", "train_cityflow_config", ",", "wrapper_model", ",", "\n", "**", "kwargs", ")", ":", "\n", "        ", "self", ".", "SEED", "=", "seed", "\n", "self", ".", "randomstate", "=", "np", ".", "random", ".", "RandomState", "(", "seed", ")", "\n", "set_seed", "(", "seed", ")", "\n", "cuda", "(", "None", ",", "not", "no_cuda", ")", "\n", "self", ".", "DEV", "=", "development", "\n", "\n", "self", ".", "envs", "=", "[", "]", "\n", "env", "=", "env", ".", "lower", "(", ")", "\n", "if", "env", "==", "'cityflow'", ":", "\n", "            ", "env_args", "=", "{", "\n", "'number'", ":", "threads", ",", "\n", "'logpath'", ":", "log_folder", ",", "\n", "'workpath'", ":", "work_folder", ",", "\n", "'config'", ":", "train_cityflow_config", ",", "\n", "'log'", ":", "cityflow_log", "\n", "}", "\n", "env_args", "[", "'logpath'", "]", "=", "log_folder", "+", "'/train_env/'", "\n", "self", ".", "train_env_args", "=", "env_args", "\n", "self", ".", "env", "=", "self", ".", "get_env", "(", "self", ".", "train_env_args", ")", "\n", "# one thread, new folder for test", "\n", "env_args", "=", "env_args", ".", "copy", "(", ")", "\n", "env_args", "[", "'number'", "]", "=", "1", "\n", "env_args", "[", "'logpath'", "]", "=", "log_folder", "+", "'/test_env/'", "\n", "env_args", "[", "'config'", "]", "=", "cityflow_config", "\n", "self", ".", "test_env_args", "=", "env_args", "\n", "self", ".", "test_env", "=", "self", ".", "get_env", "(", "self", ".", "test_env_args", ")", "\n", "", "else", ":", "\n", "            ", "raise", "NotImplementedError", "(", "'envs except cityflow is '", "\n", "'not implemented'", ")", "\n", "", "log", "(", "self", ".", "env", ".", "observation_space", ",", "self", ".", "env", ".", "action_space", ",", "level", "=", "'TRACE'", ")", "\n", "self", ".", "_init_TXSW", "(", "**", "kwargs", ")", "\n", "\n", "if", "model", "==", "'basic'", ":", "\n", "            ", "model", "=", "'DQNNaiveFC'", "\n", "", "if", "model", "in", "globals", "(", ")", ":", "\n", "            ", "try", ":", "\n", "                ", "inner_model", "=", "globals", "(", ")", "[", "model", "]", "\n", "", "except", "Exception", "as", "e", ":", "\n", "                ", "raise", "e", "\n", "", "", "else", ":", "\n", "            ", "raise", "NotImplementedError", "(", "'unknown model '", "+", "model", ")", "\n", "", "if", "wrapper_model", "!=", "''", ":", "\n", "            ", "if", "wrapper_model", "in", "globals", "(", ")", ":", "\n", "                ", "wrapperModel", "=", "globals", "(", ")", "[", "wrapper_model", "]", "\n", "", "else", ":", "\n", "                ", "raise", "NotImplementedError", "(", "'unknown wrapper model'", ")", "\n", "", "", "elif", "'default_wrapper'", "in", "dir", "(", "inner_model", ")", ":", "\n", "            ", "wrapper_model", "=", "inner_model", ".", "default_wrapper", "(", "\n", "dqn_split_model", "=", "dqn_split_model", ",", "\n", "dueling_dqn", "=", "dueling_dqn", "\n", ")", "\n", "wrapperModel", "=", "globals", "(", ")", "[", "wrapper_model", "]", "\n", "", "model_args", "=", "{", "\n", "'observation'", ":", "self", ".", "env", ".", "observation_space", "[", "'intersections'", "]", ",", "\n", "'adj_mat'", ":", "self", ".", "env", ".", "observation_space", "[", "'adj_mat'", "]", ",", "\n", "'virtual_intersection_out_lines'", ":", "self", ".", "env", ".", "observation_space", "[", "\n", "'virtual_intersection_out_lines'", "\n", "]", ",", "\n", "'action'", ":", "self", ".", "env", ".", "action_space", ",", "\n", "'innerModel'", ":", "inner_model", ",", "\n", "'TXSW'", ":", "self", ".", "TXSW", "\n", "}", "\n", "if", "agent", ".", "lower", "(", ")", "==", "'dqn'", ":", "\n", "            ", "agent", "=", "'DQNAgent'", "\n", "", "if", "agent", "in", "globals", "(", ")", ":", "\n", "            ", "Agent", "=", "globals", "(", ")", "[", "agent", "]", "\n", "", "else", ":", "\n", "            ", "raise", "NotImplementedError", "(", "'unknown agent '", "+", "agent", ")", "\n", "", "if", "multi_agent", "in", "globals", "(", ")", ":", "\n", "            ", "MultiAgent", "=", "globals", "(", ")", "[", "multi_agent", "]", "\n", "", "else", ":", "\n", "            ", "raise", "NotImplementedError", "(", "'unknown multi-agent '", "+", "multi_agent", ")", "\n", "", "self", ".", "agent", "=", "cuda", "(", "MultiAgent", "(", "n_steps", "=", "n_steps", ",", "\n", "AgentClass", "=", "Agent", ",", "\n", "wrapperModel", "=", "wrapperModel", ",", "\n", "dueling_dqn", "=", "dueling_dqn", ",", "\n", "seed", "=", "self", ".", "randint", "(", ")", ",", "\n", "**", "model_args", ",", "\n", "**", "kwargs", ")", ")", "\n", "\n", "self", ".", "agent", ".", "log_model_structure", "(", ")", "\n", "\n", "self", ".", "THREADS", "=", "threads", "\n", "self", ".", "N_STEPS", "=", "n_steps", "\n", "\n", "self", ".", "test_round", "=", "test_round", "\n", "self", ".", "epoch", "=", "0", "\n", "if", "preload_model_file", "!=", "''", ":", "\n", "            ", "self", ".", "model_file", "=", "torch", ".", "load", "(", "preload_model_file", ",", "\n", "map_location", "=", "'cpu'", ")", "\n", "self", ".", "agent", ".", "load_state_dict", "(", "self", ".", "model_file", "[", "'state_dict'", "]", ")", "\n", "self", ".", "epoch", "=", "self", ".", "model_file", "[", "'epoch'", "]", "\n", "self", ".", "env", ".", "replay_count", "(", "self", ".", "model_file", "[", "'replay_count'", "]", ")", "\n", "self", ".", "SIMULATE_TIME", "=", "simulate_time", "\n", "self", ".", "FRAME", "=", "self", ".", "epoch", "*", "self", ".", "SIMULATE_TIME", "\n", "\n", "", "if", "test_round", ">", "0", ":", "\n", "            ", "return", "\n", "\n", "", "self", ".", "replay", "=", "cuda", "(", "ReplayBuffer", "(", "\n", "n_steps", ",", "\n", "dqn_replay_size", ",", "\n", "dqn_batch_size", ",", "\n", "self", ".", "randint", "(", ")", ",", "\n", "CityFlowBuffer", "(", "\n", "dqn_replay_size", ",", "\n", "self", ".", "env", ".", "observation_space", "[", "'intersections'", "]", ",", "\n", "self", ".", "env", ".", "action_space", "\n", ")", "\n", ")", ")", "\n", "\n", "self", ".", "EPS", "=", "[", "dqn_initial_eps", ",", "dqn_final_eps", ",", "dqn_explore_len_frac", "]", "\n", "self", ".", "EPS", "[", "2", "]", "=", "(", "self", ".", "EPS", "[", "0", "]", "-", "self", ".", "EPS", "[", "1", "]", ")", "/", "(", "n_frames", "*", "self", ".", "EPS", "[", "2", "]", ")", "\n", "self", ".", "N_FRAMES", "=", "n_frames", "\n", "self", ".", "RENDER", "=", "render_steps", "\n", "\n", "self", ".", "SIMULATE_TIME", "=", "simulate_time", "\n", "self", ".", "TOTAL_EPOCH", "=", "n_frames", "//", "(", "simulate_time", "*", "threads", ")", "\n", "if", "n_frames", "%", "(", "simulate_time", "*", "threads", ")", "!=", "0", ":", "\n", "            ", "self", ".", "n_frames", "=", "self", ".", "TOTAL_EPOCH", "*", "simulate_time", "*", "threads", "\n", "log", "(", "'n_frames can\\'t be divided with simulate_time and threads! '", "\n", "'change n_frames to %s.'", "%", "self", ".", "n_frames", ",", "level", "=", "'WARN'", ")", "\n", "", "self", ".", "FRAME", "=", "self", ".", "epoch", "*", "self", ".", "SIMULATE_TIME", "*", "threads", "\n", "\n", "self", ".", "PREVIOUS_REWARD", "=", "[", "]", "\n", "self", ".", "BEST_RESULT", "=", "None", "\n", "self", ".", "REWARD_AVG", "=", "10", "\n", "\n", "assert", "save_interval", "==", "0", ",", "'not support save_interval now'", "\n", "self", ".", "EVAL_ROUND", "=", "evaluate_round", "\n", "self", ".", "EVAL_INTERVAL", "=", "evaluate_interval", "\n", "if", "self", ".", "EVAL_INTERVAL", "%", "threads", "!=", "0", ":", "\n", "            ", "self", ".", "EVAL_INTERVAL", "=", "(", "self", ".", "EVAL_INTERVAL", "//", "threads", "+", "1", ")", "*", "threads", "\n", "log", "(", "'evaluate_interval can\\'t be divided with threads! change '", "\n", "'interval to %s.'", "%", "self", ".", "EVAL_INTERVAL", ",", "level", "=", "'WARN'", ")", "\n", "", "self", ".", "model_folder", "=", "os", ".", "path", ".", "join", "(", "log_folder", ",", "model_save_path", ")", "+", "'/'", "\n", "if", "model_save_path", "==", "''", ":", "\n", "            ", "self", ".", "model_folder", "=", "''", "\n", "log", "(", "'model save path not set! will not save model'", ",", "level", "=", "'WARN'", ")", "\n", "", "else", ":", "\n", "            ", "os", ".", "makedirs", "(", "self", ".", "model_folder", ")", "\n", "\n", "", "log", "(", "'DQNMain init over'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.get_env": [[166, 171], ["args.copy.copy.copy", "DQNMain.DQNMain.envs.append", "str", "getCityFlowEnvVec", "len", "DQNMain.DQNMain.randint"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.getCityFlowEnvVec", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint"], ["", "def", "get_env", "(", "self", ",", "args", ")", ":", "\n", "        ", "args", "=", "args", ".", "copy", "(", ")", "\n", "args", "[", "'logpath'", "]", "+=", "str", "(", "len", "(", "self", ".", "envs", ")", ")", "+", "'/'", "\n", "self", ".", "envs", ".", "append", "(", "getCityFlowEnvVec", "(", "**", "args", ",", "seed", "=", "self", ".", "randint", "(", ")", ")", ")", "\n", "return", "self", ".", "envs", "[", "-", "1", "]", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint": [[172, 174], ["DQNMain.DQNMain.randomstate.randint"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.randint"], ["", "def", "randint", "(", "self", ",", "k", "=", "2", "**", "31", ")", ":", "\n", "        ", "return", "self", ".", "randomstate", ".", "randint", "(", "k", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.eps": [[175, 177], ["max"], "methods", ["None"], ["", "def", "eps", "(", "self", ")", ":", "\n", "        ", "return", "max", "(", "self", ".", "EPS", "[", "0", "]", "-", "self", ".", "FRAME", "*", "self", ".", "EPS", "[", "2", "]", ",", "self", ".", "EPS", "[", "1", "]", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.save": [[178, 188], ["torch.save", "DQNMain.DQNMain.env.replay_count", "DQNMain.DQNMain.agent.state_dict"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.save", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.replay_count", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.IndependentDetermined.IndependentDetermined.state_dict"], ["", "def", "save", "(", "self", ",", "savepath", ",", "result", "=", "None", ",", "reward", "=", "None", ",", "eval", "=", "None", ")", ":", "\n", "        ", "save_data", "=", "{", "\n", "'epoch'", ":", "self", ".", "epoch", ",", "\n", "'test_result'", ":", "result", ",", "\n", "'test_reward'", ":", "reward", ",", "\n", "'eval_result'", ":", "eval", ",", "\n", "'replay_count'", ":", "self", ".", "env", ".", "replay_count", "(", ")", ",", "\n", "'state_dict'", ":", "self", ".", "agent", ".", "state_dict", "(", ")", "\n", "}", "\n", "torch", ".", "save", "(", "save_data", ",", "savepath", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.sampling": [[189, 202], ["DQNMain.DQNMain.real_sampling", "log", "DQNMain.DQNMain.get_env", "log", "print"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.real_sampling", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.get_env", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log"], ["", "def", "sampling", "(", "self", ")", ":", "\n", "        ", "while", "True", ":", "\n", "            ", "try", ":", "\n", "                ", "return", "self", ".", "real_sampling", "(", ")", "\n", "", "except", "Exception", "as", "e", ":", "\n", "# raise e", "\n", "                ", "if", "self", ".", "DEV", ":", "\n", "                    ", "print", "(", "e", ")", "\n", "raise", "e", "\n", "", "log", "(", "'got error while training! message logged , generate new '", "\n", "'env and re-run.'", ",", "level", "=", "'WARN'", ")", "\n", "self", ".", "env", "=", "self", ".", "get_env", "(", "self", ".", "train_env_args", ")", "\n", "log", "(", "e", ",", "level", "=", "'TRACE'", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.real_sampling": [[203, 264], ["time.time", "DQNMain.DQNMain.env.reset", "DQNMain.DQNMain.replay.reset", "DQNMain.DQNMain.agent.action", "np.zeros", "range", "np.stack().mean", "DQNMain.DQNMain.PREVIOUS_REWARD.append", "log", "DQNMain.DQNMain.TXSW.add_scalar", "DQNMain.DQNMain.TXSW.add_scalar", "DQNMain.DQNMain.env.step", "np.sum", "DQNMain.DQNMain.agent.action", "DQNMain.DQNMain.replay.append", "np.zeros.mean", "DQNMain.DQNMain.save", "DQNMain.DQNMain.eps", "ist.all", "ist.any", "log", "range", "log", "DQNMain.DQNMain.evaluate", "log", "np.stack", "DQNMain.DQNMain.eps", "DQNMain.DQNMain.replay.sample", "DQNMain.DQNMain.agent.update_policy", "DQNMain.DQNMain.agent.update_best", "log", "DQNMain.DQNMain.eps", "np.zeros.mean", "DQNMain.DQNMain.save", "time.time"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.reset", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.reset", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.action", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_scalar", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_scalar", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.action", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.save", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.eps", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.evaluate", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.eps", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.sample", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.update_policy", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MultiAgentBase.MultiAgentBase.update_best", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.eps", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.save"], ["", "", "", "def", "real_sampling", "(", "self", ")", ":", "\n", "        ", "start_time", "=", "time", ".", "time", "(", ")", "\n", "replay_full_before", "=", "self", ".", "replay", ".", "full", "\n", "state", ",", "infos", "=", "self", ".", "env", ".", "reset", "(", ")", "\n", "self", ".", "replay", ".", "reset", "(", "state", ")", "\n", "action", "=", "self", ".", "agent", ".", "action", "(", "state", ",", "eps", "=", "self", ".", "eps", "(", ")", ",", "get", "=", "True", ")", "\n", "tot_reward", "=", "np", ".", "zeros", "(", "self", ".", "THREADS", ",", "dtype", "=", "float", ")", "\n", "eval_res", "=", "None", "\n", "for", "ite", "in", "range", "(", "self", ".", "SIMULATE_TIME", ")", ":", "\n", "            ", "self", ".", "FRAME", "+=", "self", ".", "THREADS", "\n", "next_s", ",", "reward", ",", "ist", ",", "infos", "=", "self", ".", "env", ".", "step", "(", "action", ")", "\n", "tot_reward", "+=", "np", ".", "sum", "(", "reward", ",", "axis", "=", "-", "1", ")", "\n", "next_action", "=", "self", ".", "agent", ".", "action", "(", "next_s", ",", "eps", "=", "self", ".", "eps", "(", ")", ",", "\n", "get", "=", "True", ")", "\n", "\n", "assert", "(", "ist", ".", "all", "(", ")", "==", "ist", ".", "any", "(", ")", ")", "\n", "# assert(ist.all() == (ite == self.SIMULATE_TIME - 1))", "\n", "# if ite == self.SIMULATE_TIME - 1:", "\n", "#     assert(ist.all())", "\n", "\n", "self", ".", "replay", ".", "append", "(", "action", ",", "reward", ",", "next_s", ",", "ist", ")", "\n", "if", "self", ".", "replay", ".", "full", "and", "not", "replay_full_before", ":", "\n", "                ", "log", "(", "'replay full, start training'", ")", "\n", "replay_full_before", "=", "True", "\n", "", "if", "self", ".", "replay", ".", "full", ":", "\n", "                ", "for", "_", "in", "range", "(", "self", ".", "THREADS", ")", ":", "\n", "                    ", "samples", "=", "self", ".", "replay", ".", "sample", "(", ")", "\n", "self", ".", "agent", ".", "update_policy", "(", "samples", ",", "self", ".", "FRAME", ")", "\n", "\n", "", "", "action", "=", "next_action", "\n", "state", "=", "next_s", "\n", "\n", "if", "self", ".", "FRAME", "%", "self", ".", "EVAL_INTERVAL", "==", "0", "and", "self", ".", "replay", ".", "full", ":", "\n", "                ", "log", "(", "'epoch %4d, frame %7d: start evaluate'", "\n", "%", "(", "self", ".", "epoch", ",", "self", ".", "FRAME", ")", ")", "\n", "eval_res", "=", "self", ".", "evaluate", "(", "'update'", ")", "\n", "log", "(", "'evaluate result:'", ",", "eval_res", ")", "\n", "if", "not", "self", ".", "BEST_RESULT", "or", "eval_res", "<", "self", ".", "BEST_RESULT", ":", "\n", "                    ", "self", ".", "BEST_RESULT", "=", "eval_res", "\n", "self", ".", "agent", ".", "update_best", "(", ")", "\n", "if", "self", ".", "model_folder", "!=", "''", ":", "\n", "                        ", "self", ".", "save", "(", "self", ".", "model_folder", "+", "'best.pt'", ",", "\n", "eval", "=", "eval_res", ")", "\n", "", "log", "(", "'best result updated:'", ",", "eval_res", ")", "\n", "\n", "", "", "", "result", "=", "np", ".", "stack", "(", "[", "x", "[", "'average_time'", "]", "for", "x", "in", "infos", "]", ")", ".", "mean", "(", ")", "\n", "self", ".", "PREVIOUS_REWARD", ".", "append", "(", "result", ")", "\n", "log", "(", "'epoch %4d, frame %7d: time=%.3f, eps=%.2f, reward=%.6f, '", "\n", "'result=%.6f'", "%", "(", "\n", "self", ".", "epoch", ",", "\n", "self", ".", "FRAME", ",", "\n", "time", ".", "time", "(", ")", "-", "start_time", ",", "\n", "self", ".", "eps", "(", ")", ",", "\n", "tot_reward", ".", "mean", "(", ")", ",", "\n", "result", ")", ")", "\n", "self", ".", "TXSW", ".", "add_scalar", "(", "'reward'", ",", "tot_reward", ".", "mean", "(", ")", ",", "self", ".", "FRAME", ")", "\n", "self", ".", "TXSW", ".", "add_scalar", "(", "'result'", ",", "result", ",", "self", ".", "FRAME", ")", "\n", "\n", "if", "self", ".", "model_folder", "!=", "''", ":", "\n", "            ", "self", ".", "save", "(", "self", ".", "model_folder", "+", "'%04d.pt'", "%", "self", ".", "epoch", ",", "\n", "result", ",", "tot_reward", ",", "eval_res", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.evaluate": [[265, 279], ["DQNMain.DQNMain.real_evaluate", "log", "log", "DQNMain.DQNMain.get_env", "print"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.real_evaluate", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.get_env"], ["", "", "def", "evaluate", "(", "self", ",", "model", ")", ":", "\n", "        ", "while", "True", ":", "\n", "            ", "try", ":", "\n", "                ", "return", "self", ".", "real_evaluate", "(", "model", ")", "\n", "", "except", "Exception", "as", "e", ":", "\n", "# print(e)", "\n", "# raise e", "\n", "                ", "if", "self", ".", "DEV", ":", "\n", "                    ", "print", "(", "e", ")", "\n", "raise", "e", "\n", "", "log", "(", "'got error while evaluating! message logged, generate new '", "\n", "'env and re-run.'", ",", "level", "=", "'WARN'", ")", "\n", "log", "(", "e", ",", "level", "=", "'TRACE'", ")", "\n", "self", ".", "test_env", "=", "self", ".", "get_env", "(", "self", ".", "test_env_args", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.real_evaluate": [[280, 298], ["torch.no_grad", "DQNMain.DQNMain.test_env.reset", "DQNMain.DQNMain.agent.action", "np.zeros", "range", "log", "np.stack().mean", "DQNMain.DQNMain.TXSW.add_scalar", "DQNMain.DQNMain.test_env.step", "reward.sum", "DQNMain.DQNMain.agent.action", "np.stack"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.reset", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.action", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.utils.utils.WanDB_TXSW.add_scalar", "home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.step", "home.repos.pwc.inspect_result.zyr17_unilight.multiAgent.MAL.MAL.action"], ["", "", "", "def", "real_evaluate", "(", "self", ",", "model_name", ")", ":", "\n", "        ", "with", "torch", ".", "no_grad", "(", ")", ":", "\n", "            ", "state", ",", "infos", "=", "self", ".", "test_env", ".", "reset", "(", ")", "\n", "action", "=", "self", ".", "agent", ".", "action", "(", "state", ",", "model_name", "=", "model_name", ",", "\n", "evaluate", "=", "True", ")", "\n", "tot_reward", "=", "np", ".", "zeros", "(", "self", ".", "THREADS", ",", "dtype", "=", "float", ")", "\n", "for", "ite", "in", "range", "(", "self", ".", "SIMULATE_TIME", ")", ":", "\n", "                ", "next_s", ",", "reward", ",", "ist", ",", "infos", "=", "self", ".", "test_env", ".", "step", "(", "action", ")", "\n", "tot_reward", "+=", "reward", ".", "sum", "(", "axis", "=", "1", ")", "\n", "next_action", "=", "self", ".", "agent", ".", "action", "(", "next_s", ",", "\n", "model_name", "=", "model_name", ",", "\n", "evaluate", "=", "True", ")", "\n", "action", "=", "next_action", "\n", "state", "=", "next_s", "\n", "", "log", "(", "infos", ",", "level", "=", "'TRACE'", ")", "\n", "eval_res", "=", "np", ".", "stack", "(", "[", "x", "[", "'average_time'", "]", "for", "x", "in", "infos", "]", ")", ".", "mean", "(", ")", "\n", "self", ".", "TXSW", ".", "add_scalar", "(", "'evaluate'", ",", "eval_res", ",", "self", ".", "FRAME", ")", "\n", "return", "eval_res", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.main": [[299, 329], ["log", "range", "np.array", "log", "log", "range", "np.array", "log", "log", "log", "log", "log", "DQNMain.DQNMain.sampling", "DQNMain.DQNMain.evaluate", "log", "np.array.mean", "np.array.std", "time.time", "DQNMain.DQNMain.evaluate", "log", "np.array.append", "np.array.mean", "np.array.std", "np.array.mean", "np.array.max", "np.array.min", "np.array.std", "time.time"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.sampling", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.evaluate", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.evaluate", "home.repos.pwc.inspect_result.zyr17_unilight.envs.CityFlowEnv.CityFlowEnv.log", "home.repos.pwc.inspect_result.zyr17_unilight.rl.storage.ReplayBuffer.append"], ["", "", "def", "main", "(", "self", ")", ":", "\n", "        ", "if", "self", ".", "test_round", "!=", "0", ":", "\n", "# test mode", "\n", "            ", "log", "(", "'test mode, will test %d times'", "%", "self", ".", "test_round", ")", "\n", "res", "=", "[", "]", "\n", "for", "i", "in", "range", "(", "self", ".", "test_round", ")", ":", "\n", "                ", "start_time", "=", "time", ".", "time", "(", ")", "\n", "one", "=", "self", ".", "evaluate", "(", "'BEST'", ")", "\n", "log", "(", "'test round %4d: time=%.3f result=%.3f'", "\n", "%", "(", "i", ",", "time", ".", "time", "(", ")", "-", "start_time", ",", "one", ")", ")", "\n", "res", ".", "append", "(", "one", ")", "\n", "", "res", "=", "np", ".", "array", "(", "res", ")", "\n", "log", "(", "'result mean: %.3f'", "%", "res", ".", "mean", "(", ")", ")", "\n", "log", "(", "'result max: %.3f'", "%", "res", ".", "max", "(", ")", ")", "\n", "log", "(", "'result min: %.3f'", "%", "res", ".", "min", "(", ")", ")", "\n", "log", "(", "'result std: %.3f'", "%", "res", ".", "std", "(", ")", ")", "\n", "log", "(", "'result:'", ",", "res", ".", "mean", "(", ")", ",", "res", ".", "std", "(", ")", ")", "\n", "return", "\n", "\n", "", "while", "self", ".", "epoch", "<", "self", ".", "TOTAL_EPOCH", ":", "\n", "            ", "self", ".", "sampling", "(", ")", "\n", "self", ".", "epoch", "+=", "1", "\n", "", "final_result", "=", "[", "]", "\n", "log", "(", "'use best model to evaluate %d times'", "%", "self", ".", "EVAL_ROUND", ")", "\n", "for", "num", "in", "range", "(", "self", ".", "EVAL_ROUND", ")", ":", "\n", "            ", "eval", "=", "self", ".", "evaluate", "(", "'BEST'", ")", "\n", "log", "(", "'evaluate round'", ",", "num", ",", "'result:'", ",", "eval", ")", "\n", "final_result", "+=", "[", "eval", "]", "\n", "", "final_result", "=", "np", ".", "array", "(", "final_result", ")", "\n", "log", "(", "'result:'", ",", "final_result", ".", "mean", "(", ")", ",", "final_result", ".", "std", "(", ")", ")", "\n", "\n"]], "home.repos.pwc.inspect_result.zyr17_unilight.mainfunc.DQNMain.DQNMain.__del__": [[330, 332], ["DQNMain.DQNMain.TXSW.close"], "methods", ["home.repos.pwc.inspect_result.zyr17_unilight.envs.SubprocVecEnv.EnvVecs.close"], ["", "def", "__del__", "(", "self", ")", ":", "\n", "        ", "self", ".", "TXSW", ".", "close", "(", ")", "\n", "", "", ""]]}